version: '1.0'
description: >
  Сценарий хаос-тестирования для симуляции отказов узлов в Kubernetes кластере.
  Цель: проверить устойчивость и автоматическое восстановление сервисов при сбоях.

scope:
  namespace: production
  label_selector: app=teslaai-backend

experiments:
  - name: node-kill
    type: pod-delete
    parameters:
      podsAffectedPerc: 20       # Убить 20% подов с заданным лейблом
      gracePeriod: 30            # Время ожидания перед убийством пода, в секундах
      sequence:
        mode: parallel           # Параллельное удаление
    probes:
      - name: backend-health-check
        type: http
        url: http://teslaai-backend.health/readiness
        method: GET
        timeout: 5
        interval: 10
        retries: 3

  - name: node-cpu-stress
    type: stress
    parameters:
      cpuWorkers: 2              # Количество CPU воркеров для нагрузки
      load: 80                   # Процент загрузки CPU
      duration: 120              # Длительность нагрузки в секундах
    probes:
      - name: system-load-check
        type: exec
        command: ["uptime"]
        timeout: 5
        interval: 15
        retries: 2

rollback:
  strategy: auto
  maxRetry: 3
  interval: 60

notifications:
  slack:
    webhook_url: ${SLACK_WEBHOOK_URL}
    channel: '#devops-alerts'
    notifyOnStart: true
    notifyOnSuccess: true
    notifyOnFailure: true
