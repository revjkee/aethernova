<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KeyVault –ü–∞–Ω–µ–ª—å ‚Äî TeslaAI Genesis</title>
  <link rel="stylesheet" href="/static/css/main.css" />
  <link rel="icon" href="/static/icons/lock.svg" />
</head>
<body>
  <header class="header">
    <div class="logo">üîê TeslaAI KeyVault</div>
    <nav class="nav">
      <a href="/secrets.html">–°–µ–∫—Ä–µ—Ç—ã</a>
      <a href="/audit.html">–ê—É–¥–∏—Ç</a>
      <a href="/logout" onclick="logout(); return false;">–í—ã—Ö–æ–¥</a>
    </nav>
  </header>

  <main class="dashboard">
    <section class="status-card">
      <h2>–°—Ç–∞—Ç—É—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h2>
      <div id="vault-status" class="status-box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </section>

    <section class="recent-actions">
      <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–æ–≤</h2>
      <table class="actions-table" id="actions-table">
        <thead>
          <tr>
            <th>–ê–≥–µ–Ω—Ç</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–í—Ä–µ–º—è</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </section>

    <section class="secure-controls">
      <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
      <button onclick="sealVault()">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</button>
      <button onclick="backupVault()">üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </section>
  </main>

  <footer class="footer">
    <small>&copy; 2025 TeslaAI Genesis ‚Äî Zero Trust Infrastructure</small>
  </footer>

  <script src="/static/js/utils.js"></script>
  <script src="/static/js/auth.js"></script>
  <script>
    if (!isAuthenticated()) logout();

    async function fetchStatus() {
      try {
        const res = await fetch('/api/status', attachAuthHeader());
        const data = await res.json();
        document.getElementById('vault-status').textContent = data.status;
      } catch (e) {
        document.getElementById('vault-status').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    }

    async function fetchActions() {
      try {
        const res = await fetch('/api/audit/recent', attachAuthHeader());
        const data = await res.json();
        const tbody = document.querySelector('#actions-table tbody');
        tbody.innerHTML = '';
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.agent}</td>
            <td>${row.action}</td>
            <td>${new Date(row.timestamp).toLocaleString()}</td>
            <td>${row.ip}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        document.querySelector('#actions-table tbody').innerHTML =
          '<tr><td colspan="4">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      }
    }

    async function sealVault() {
      const confirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ?");
      if (!confirmed) return;
      try {
        const res = await fetch('/api/vault/seal', { method: 'POST', ...attachAuthHeader() });
        if (res.ok) showAlert("–•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ", "success");
        else showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ", "error");
      } catch (e) {
        showAlert("–°–±–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
      }
    }

    async function backupVault() {
      try {
        const res = await fetch('/api/vault/backup', { method: 'POST', ...attachAuthHeader() });
        if (res.ok) showAlert("–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞", "success");
        else showAlert("–û—à–∏–±–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", "error");
      } catch (e) {
        showAlert("–°–±–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
      }
    }

    window.addEventListener('load', () => {
      fetchStatus();
      fetchActions();
    });
  </script>
</body>
</html>
