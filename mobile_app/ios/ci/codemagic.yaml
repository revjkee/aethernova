workflows:
  teslaai-ios-production:
    name: TeslaAI iOS Production Build
    environment:
      vars:
        XCODE_VERSION: latest
        BUNDLE_ID: "com.teslaai.genesis"
        APP_ID: "1234567890" # Apple Developer ID
        EXPORT_OPTIONS: ios/CI/ExportOptions.plist
      ios_signing:
        distribution_type: app_store
        bundle_identifier: $BUNDLE_ID
        team_id: $APP_STORE_TEAM_ID
        provisioning_profiles:
          - $BUNDLE_ID
        certificate_url: $CERTIFICATE_URL
        certificate_password: $CERTIFICATE_PASSWORD
        app_store_connect_issuer_id: $ASC_ISSUER_ID
        app_store_connect_key_id: $ASC_KEY_ID
        app_store_connect_private_key: $ASC_PRIVATE_KEY
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
    scripts:
      - name: Set up build number
        script: |
          BUILD_NUMBER=$(($(date +%s) / 60))
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $CM_ENV
      - name: Install dependencies
        script: |
          brew install swiftlint || true
          pod install --repo-update
      - name: Lint code
        script: swiftlint --strict
      - name: Build and archive
        script: |
          xcodebuild clean archive \
            -workspace TeslaAI.xcworkspace \
            -scheme TeslaAI \
            -configuration Release \
            -archivePath $CM_BUILD_DIR/TeslaAI.xcarchive \
            -allowProvisioningUpdates
      - name: Export IPA
        script: |
          xcodebuild -exportArchive \
            -archivePath $CM_BUILD_DIR/TeslaAI.xcarchive \
            -exportPath $CM_BUILD_DIR/Exported \
            -exportOptionsPlist $EXPORT_OPTIONS
      - name: Run Unit Tests
        script: |
          xcodebuild test \
            -workspace TeslaAI.xcworkspace \
            -scheme TeslaAI \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0'
      - name: Upload IPA
        script: |
          curl -F "file=@$CM_BUILD_DIR/Exported/TeslaAI.ipa" \
               -F "token=$UPLOAD_TOKEN" \
               https://secure-deployment-endpoint.ai/upload
    artifacts:
      - Exported/*.ipa
      - $CM_BUILD_DIR/**/*.dSYM
      - $CM_BUILD_DIR/Logs/**/*.log
    publishing:
      email:
        recipients:
          - "release@teslaai.io"
        notify:
          success: true
          failure: true
