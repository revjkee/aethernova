version: '3.9'

services:
  ubuntu_forge_env:
    image: ubuntu:20.04
    container_name: ubuntu_forge_env
    privileged: true
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
      - DAC_READ_SEARCH
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    networks:
      - forge_net
    environment:
      - LANG=en_US.UTF-8
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - ./volumes/rootfs:/mnt/host
      - ./logs:/var/log/forgemind
      - ./scripts:/opt/scripts:ro
    entrypoint: ["/bin/bash", "-c", "/opt/scripts/init_env.sh && tail -f /dev/null"]
    restart: unless-stopped
    ulimits:
      core: -1
      nofile:
        soft: 65535
        hard: 65535

networks:
  forge_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.99.99.0/24
          gateway: 10.99.99.1

configs:
  kernel_modules:
    file: ./configs/kernel_modules.conf

secrets:
  gpg_forge_key:
    file: ./secrets/forgemind_gpg.key

healthcheck:
  test: ["CMD-SHELL", "ping -c 1 8.8.8.8 || exit 1"]
  interval: 10s
  timeout: 5s
  retries: 5
