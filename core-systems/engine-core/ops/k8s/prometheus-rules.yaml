apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: engine-core-slo-rules
  namespace: monitoring
  labels:
    release: prometheus
    role: alert-rules
    team: sre
    app: engine-core
    environment: production
    alerts.kubernetes.io/group: slo
spec:
  groups:
    - name: engine-core-slo
      interval: 30s
      rules:

        ### AVAILABILITY: Fast burn rate violation (99.9% over 28d)
        - alert: EngineCoreSLOFastBurn
          expr: |
            (
              sum(rate(http_requests_total{app="engine-core",status=~"5.."}[5m]))
              /
              sum(rate(http_requests_total{app="engine-core"}[5m]))
            ) > (1 - 0.999) * 14.4
          for: 2m
          labels:
            severity: critical
            slo: availability
            slo_target: "99.9%"
            window: fast
            team: sre
            service: engine-core
            alerts.kubernetes.io/summary: "Availability SLO Fast Burn"
          annotations:
            summary: "Engine Core: Fast burn rate of 99.9% availability SLO"
            description: "5xx error rate exceeds fast-burn threshold over 5m. Immediate action required."

        ### AVAILABILITY: Slow burn rate (1h window)
        - alert: EngineCoreSLOSlowBurn
          expr: |
            (
              sum(rate(http_requests_total{app="engine-core",status=~"5.."}[1h]))
              /
              sum(rate(http_requests_total{app="engine-core"}[1h]))
            ) > (1 - 0.999)
          for: 10m
          labels:
            severity: warning
            slo: availability
            slo_target: "99.9%"
            window: slow
            team: sre
            service: engine-core
          annotations:
            summary: "SLO slow burn: error budget consumption exceeding over 1h"
            description: "Sustained error budget burn indicates ongoing degradation. Investigate service behavior."

        ### LATENCY: High p95 latency (>500ms)
        - alert: EngineCoreHighLatencyP95
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app="engine-core"}[5m])) by (le)) > 0.5
          for: 5m
          labels:
            severity: warning
            slo: latency
            slo_target: "95% < 500ms"
            team: sre
            service: engine-core
          annotations:
            summary: "Engine Core p95 latency above 500ms"
            description: "95th percentile latency >500ms over last 5m. Possible slowness or overload."

        ### STABILITY: Container crashloop detection
        - alert: EngineCoreCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total{container="engine-core"}[5m]) > 3
          for: 1m
          labels:
            severity: critical
            slo: stability
            cause: crashloop
            team: sre
            service: engine-core
          annotations:
            summary: "Engine Core container crash-looping"
            description: "Container restarted more than 3 times in 5 minutes. Check logs, memory/cpu OOM or readiness issues."

        ### BUDGET: SLO error budget burn tracker (28d/1d)
        - alert: EngineCoreErrorBudgetExhausted
          expr: |
            (
              sum(increase(http_requests_total{app="engine-core",status=~"5.."}[1d]))
              /
              sum(increase(http_requests_total{app="engine-core"}[1d]))
            ) > ((1 - 0.999) * 28)
          for: 10m
          labels:
            severity: critical
            slo: error_budget
            slo_target: "99.9% (28d)"
            team: sre
            service: engine-core
          annotations:
            summary: "Engine Core SLO error budget exhausted"
            description: "Daily error rate projects full consumption of 28-day budget. Take defensive action now."
