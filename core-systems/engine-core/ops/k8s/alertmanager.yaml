apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    alertmanager: config
data:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'team']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h
      receiver: default
      routes:
        - match:
            severity: critical
            team: backend
          receiver: opsgenie
        - match_re:
            severity: (warning|info)
          receiver: slack
        - match:
            alertname: EngineCoreDown
          receiver: webhook-ai

    receivers:
      - name: default
        slack_configs:
          - channel: "#alerts"
            send_resolved: true

      - name: opsgenie
        opsgenie_configs:
          - api_key: "REPLACE_WITH_YOUR_OPSGENIE_KEY"
            priority: P1
            send_resolved: true

      - name: slack
        slack_configs:
          - channel: "#alerts-info"
            title: "{{ .CommonAnnotations.summary }}"
            text: "{{ .CommonAnnotations.description }}"
            send_resolved: true

      - name: webhook-ai
        webhook_configs:
          - url: "http://alert-router.default.svc.cluster.local:8000/api/v1/incident"
            send_resolved: true
