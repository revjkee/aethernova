# DataFabric Core — storage configuration
# Все значения могут переопределяться переменными окружения ${VAR:-default}.
# Профиль окружения определяется APP_ENV (production|staging|development|test).

storage:
  # Активный провайдер: s3|gcs|azure|local
  provider: ${ST_PROVIDER:-s3}

  # Общие безопасные дефолты для любых провайдеров
  defaults:
    # Пространство имён и префиксы путей, изолирующие окружения/тенантов
    namespace: ${ST_NAMESPACE:-datafabric}
    environment: ${APP_ENV:-production}
    base_prefix: ${ST_BASE_PREFIX:-data/${APP_ENV}}
    # Версионирование и защита от удалений
    versioning: ${ST_VERSIONING_ENABLED:-true}
    object_lock:
      enabled: ${ST_OBJECT_LOCK_ENABLED:-false}          # требует включения на уровне бакета
      mode: ${ST_OBJECT_LOCK_MODE:-GOVERNANCE}           # GOVERNANCE|COMPLIANCE
      default_retention_days: ${ST_OBJECT_LOCK_RETENTION_DAYS:-0}
    legal_hold:
      enabled: ${ST_LEGAL_HOLD_ENABLED:-false}
    # Шифрование по умолчанию (server-side)
    encryption:
      sse_mode: ${ST_SSE_MODE:-kms}                      # none|s3|kms|customer
      kms_key_id: ${ST_KMS_KEY_ID:-}                     # ARN/ID ключа (SSE-KMS / CMEK)
      customer_key_b64: ${ST_SSE_C_KEY_B64:-}            # для SSE-C (base64)
      bucket_key_enabled: ${ST_BUCKET_KEY_ENABLED:-true} # S3 Bucket Keys reduce KMS cost
    # Классы хранения и выбор по умолчанию
    storage_class: ${ST_CLASS_DEFAULT:-STANDARD}         # напр., STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING
    # Политики жизненного цикла (удаление старых версий/молодых multipart, переход в холод)
    lifecycle:
      enabled: ${ST_LIFECYCLE_ENABLED:-true}
      rules:
        - id: expire-multipart
          abort_multipart_days: ${ST_LC_ABORT_MULTIPART_DAYS:-7}
        - id: noncurrent-expiration
          noncurrent_versions:
            newer_noncurrent_versions: ${ST_LC_NEWER_NONCURRENT_KEEP:-5}
            noncurrent_days: ${ST_LC_NONCURRENT_DAYS:-30}
        - id: transition-to-ia
          transitions:
            - days: ${ST_LC_TO_IA_DAYS:-30}
              storage_class: ${ST_LC_TO_IA_CLASS:-STANDARD_IA}
            - days: ${ST_LC_TO_GLACIER_DAYS:-90}
              storage_class: ${ST_LC_TO_GLACIER_CLASS:-GLACIER_IR}
        - id: expire-old
          expiration_days: ${ST_LC_EXPIRE_DAYS:-365}
    # Настройки сетевого уровня/прокси
    network:
      http_proxy: ${HTTP_PROXY:-}
      https_proxy: ${HTTPS_PROXY:-}
      no_proxy: ${NO_PROXY:-}
      tls_verify: ${ST_TLS_VERIFY:-true}
      ca_bundle_path: ${ST_CA_BUNDLE_PATH:-}
    # Проверки целостности
    integrity:
      etag_check: ${ST_ETAG_CHECK_ENABLED:-true}
      checksum_algorithm: ${ST_CHECKSUM_ALGO:-crc32c}    # md5|sha256|crc32c (зависит от SDK/формата)
      reverify_on_retry: ${ST_REVERIFY_ON_RETRY:-true}
    # Лимиты и квоты
    quotas:
      enabled: ${ST_QUOTAS_ENABLED:-false}
      # Квоты можно навешивать на тенанта/пространство имён/проект
      per_namespace:
        bytes_soft: ${ST_QUOTA_NS_BYTES_SOFT:-0}
        bytes_hard: ${ST_QUOTA_NS_BYTES_HARD:-0}
        objects_soft: ${ST_QUOTA_NS_OBJS_SOFT:-0}
        objects_hard: ${ST_QUOTA_NS_OBJS_HARD:-0}
    # Наблюдаемость
    telemetry:
      include_user_agent: ${ST_TEL_INCLUDE_UA:-true}
      user_agent_suffix: ${ST_TEL_UA_SUFFIX:-DataFabricCore/${APP_VERSION:-0.0.0}}
      emit_metrics: ${ST_METRICS_ENABLED:-true}
      emit_traces: ${ST_TRACES_ENABLED:-true}

  # Производительность/устойчивость: upload/download/списки/ретраи
  io:
    timeouts_ms:
      connect: ${ST_TIMEOUT_CONNECT_MS:-1000}
      read: ${ST_TIMEOUT_READ_MS:-15000}
      write: ${ST_TIMEOUT_WRITE_MS:-20000}
      idle: ${ST_TIMEOUT_IDLE_MS:-30000}
    retries:
      attempts: ${ST_RETRY_ATTEMPTS:-5}
      initial_backoff_ms: ${ST_RETRY_BACKOFF_MS:-100}
      max_backoff_ms: ${ST_RETRY_BACKOFF_MAX_MS:-5000}
      jitter: ${ST_RETRY_JITTER:-true}
      retry_on_http:
        - 429
        - 500
        - 502
        - 503
        - 504
    multipart_upload:
      enabled: ${ST_MP_ENABLED:-true}
      threshold_mb: ${ST_MP_THRESHOLD_MB:-16}
      part_size_mb: ${ST_MP_PART_MB:-16}
      max_concurrency: ${ST_MP_CONCURRENCY:-8}
      # при возобновлении — проверять ETag/части
      resume_enabled: ${ST_MP_RESUME:-true}
    download:
      range_prefetch: ${ST_GET_RANGE_PREFETCH:-true}
      range_chunk_mb: ${ST_GET_RANGE_CHUNK_MB:-8}
      max_concurrency: ${ST_GET_CONCURRENCY:-8}
    listing:
      page_size: ${ST_LIST_PAGE_SIZE:-1000}
      max_keys: ${ST_LIST_MAX_KEYS:-10000}
      delimiter: ${ST_LIST_DELIMITER:-/}

  # Настройки кэша (локальный и распределённый)
  cache:
    enabled: ${ST_CACHE_ENABLED:-true}
    local:
      dir: ${ST_CACHE_DIR:-/var/cache/datafabric/objects}
      max_bytes: ${ST_CACHE_MAX_BYTES:-2147483648} # 2 GiB
      ttl_sec: ${ST_CACHE_TTL_SEC:-3600}
      eviction: ${ST_CACHE_POLICY:-lru}
    remote:
      enabled: ${ST_REMOTE_CACHE_ENABLED:-false}
      redis_url: ${ST_REMOTE_CACHE_REDIS_URL:-}
      ttl_sec: ${ST_REMOTE_CACHE_TTL_SEC:-600}
    consistency:
      revalidate_on_write: ${ST_CACHE_REVALIDATE_WRITE:-true}
      etag_coalesce_window_ms: ${ST_CACHE_ETAG_WINDOW_MS:-200}

  # Много‑региональные сценарии/репликация/DR
  replication:
    enabled: ${ST_REPL_ENABLED:-false}
    # source → destination (CRR/SRR). Настраивается и в провайдере (например, S3 Replication Rules)
    mode: ${ST_REPL_MODE:-async}        # async|sync (sync зависит от провайдера)
    source_region: ${ST_SRC_REGION:-eu-central-1}
    destination_region: ${ST_DST_REGION:-eu-west-1}
    # фильтрация по префиксу/тегам
    include_prefixes: ${ST_REPL_INCLUDE_PREFIXES:-}
    exclude_prefixes: ${ST_REPL_EXCLUDE_PREFIXES:-}
    kms_key_id_dst: ${ST_REPL_KMS_DST_KEY_ID:-}

  # Привязка бакетов (логическая): разные типы данных — разные политики
  buckets:
    raw:
      name: ${ST_BUCKET_RAW:-df-${APP_ENV}-raw}
      prefix: ${ST_BUCKET_RAW_PREFIX:-${storage.defaults.base_prefix}/raw}
      storage_class: ${ST_BUCKET_RAW_CLASS:-INTELLIGENT_TIERING}
      lifecycle:
        enabled: ${ST_BUCKET_RAW_LC_ENABLED:-true}
        rules:
          - id: keep-versions-90d
            noncurrent_versions:
              noncurrent_days: ${ST_RAW_NONCURR_DAYS:-90}
              newer_noncurrent_versions: ${ST_RAW_NONCURR_KEEP:-5}
          - id: expire-raw-365d
            expiration_days: ${ST_RAW_EXPIRE_DAYS:-365}
    curated:
      name: ${ST_BUCKET_CURATED:-df-${APP_ENV}-curated}
      prefix: ${ST_BUCKET_CURATED_PREFIX:-${storage.defaults.base_prefix}/curated}
      storage_class: ${ST_BUCKET_CURATED_CLASS:-STANDARD}
      lifecycle:
        enabled: ${ST_BUCKET_CURATED_LC_ENABLED:-true}
        rules:
          - id: transition-glacier-180d
            transitions:
              - days: ${ST_CURATED_TO_GLACIER_DAYS:-180}
                storage_class: ${ST_CURATED_TO_GLACIER_CLASS:-GLACIER_IR}
    analytics:
      name: ${ST_BUCKET_ANALYTICS:-df-${APP_ENV}-analytics}
      prefix: ${ST_BUCKET_ANALYTICS_PREFIX:-${storage.defaults.base_prefix}/analytics}
      storage_class: ${ST_BUCKET_ANALYTICS_CLASS:-STANDARD_IA}
      lifecycle:
        enabled: ${ST_BUCKET_ANALYTICS_LC_ENABLED:-true}
        rules:
          - id: expire-analytics-730d
            expiration_days: ${ST_ANALYTICS_EXPIRE_DAYS:-730}
    audit:
      name: ${ST_BUCKET_AUDIT:-df-${APP_ENV}-audit}
      prefix: ${ST_BUCKET_AUDIT_PREFIX:-${storage.defaults.base_prefix}/audit}
      storage_class: ${ST_BUCKET_AUDIT_CLASS:-STANDARD}
      object_lock:
        enabled: ${ST_AUDIT_OBJECT_LOCK_ENABLED:-true}
        mode: ${ST_AUDIT_OBJECT_LOCK_MODE:-COMPLIANCE}
        default_retention_days: ${ST_AUDIT_RETENTION_DAYS:-3650}

  # Профильные настройки по провайдерам
  s3:
    endpoint: ${S3_ENDPOINT:-https://s3.${AWS_REGION:-eu-central-1}.amazonaws.com}
    region: ${S3_REGION:-${AWS_REGION:-eu-central-1}}
    path_style: ${S3_PATH_STYLE:-false}
    accelerate: ${S3_ACCELERATE_ENABLED:-false}
    dualstack: ${S3_DUALSTACK_ENABLED:-true}
    # Креденшелы: prefer IRSA/EC2 metadata; fallback — статические ключи
    credentials:
      mode: ${S3_CRED_MODE:-auto}         # auto|static|assume_role
      access_key_id: ${AWS_ACCESS_KEY_ID:-}
      secret_access_key: ${AWS_SECRET_ACCESS_KEY:-}
      session_token: ${AWS_SESSION_TOKEN:-}
      assume_role_arn: ${AWS_ASSUME_ROLE_ARN:-}
      external_id: ${AWS_EXTERNAL_ID:-}
      role_session_name: ${AWS_ROLE_SESSION_NAME:-datafabric}
      duration_seconds: ${AWS_ROLE_DURATION_SECONDS:-3600}
    # S3‑специфичные оптимизации
    list_v2: ${S3_LIST_V2:-true}
    s3_select:
      enabled: ${S3_SELECT_ENABLED:-false}
      max_bytes_scanned_mb: ${S3_SELECT_MAX_MB:-512}
    requester_pays: ${S3_REQUESTER_PAYS:-false}

  gcs:
    endpoint: ${GCS_ENDPOINT:-https://storage.googleapis.com}
    project_id: ${GCP_PROJECT_ID:-}
    location: ${GCS_LOCATION:-EU}
    json_key_path: ${GOOGLE_APPLICATION_CREDENTIALS:-}
    uniform_bucket_level_access: ${GCS_UBLA:-true}
    requester_pays: ${GCS_REQUESTER_PAYS:-false}
    # CMEK
    kms_key_id: ${GCS_KMS_KEY_ID:-}

  azure:
    endpoint: ${AZURE_BLOB_ENDPOINT:-}
    account_name: ${AZURE_STORAGE_ACCOUNT:-}
    account_key: ${AZURE_STORAGE_KEY:-}
    sas_token: ${AZURE_STORAGE_SAS:-}
    container_tiering: ${AZURE_TIER:-Hot} # Hot|Cool|Archive
    kms_key_id: ${AZURE_KMS_KEY_ID:-}     # CMK (Azure Key Vault)
    # OAuth via MSI/Workload Identity
    aad:
      enabled: ${AZURE_AAD_ENABLED:-true}
      tenant_id: ${AZURE_TENANT_ID:-}
      client_id: ${AZURE_CLIENT_ID:-}
      client_secret: ${AZURE_CLIENT_SECRET:-}

  local:
    root_dir: ${LOCAL_STORAGE_DIR:-/var/lib/datafabric/storage}
    create_dirs: ${LOCAL_CREATE_DIRS:-true}
    fsync_on_write: ${LOCAL_FSYNC_ON_WRITE:-false}

  # Интеграции на уровне API: pre‑signed URLs, политики доступа
  api:
    presigned_urls:
      enabled: ${ST_PRESIGNED_ENABLED:-true}
      expire_sec: ${ST_PRESIGNED_EXPIRE_SEC:-900}
      enforce_content_type: ${ST_PRESIGNED_ENFORCE_CT:-true}
      allowed_methods: ${ST_PRESIGNED_METHODS:-GET,PUT}
    access_policies:
      # high‑level политики для SDK/сервиса (могут транслироваться в IAM/ABAC)
      allow_public_read_prefixes: ${ST_PUBLIC_PREFIXES:-}
      deny_delete_in_prefixes: ${ST_DENY_DELETE_PREFIXES:-${storage.buckets.audit.prefix}}

  # Форматы данных и таблицы (аналитические пайплайны)
  formats:
    parquet:
      enabled: ${ST_PARQUET_ENABLED:-true}
      row_group_size_mb: ${ST_PARQUET_ROW_GROUP_MB:-128}
      page_size_kb: ${ST_PARQUET_PAGE_KB:-64}
      compression: ${ST_PARQUET_COMPRESSION:-zstd}    # zstd|snappy|gzip|none
      dictionary_encoding: ${ST_PARQUET_DICT_ENC:-true}
      bloom_filter: ${ST_PARQUET_BLOOM:-false}
      timestamp_type: ${ST_PARQUET_TS_TYPE:-int64_micros}
    csv:
      delimiter: ${ST_CSV_DELIM:-","}
      quotechar: ${ST_CSV_QUOTE:-"\""}
      header: ${ST_CSV_HEADER:-true}
      encoding: ${ST_CSV_ENCODING:-utf-8}
    json:
      lines: ${ST_JSON_LINES:-true}

  # Каталог наборов данных (логическая схема/партиционирование)
  datasets:
    registry_path: ${ST_DATASET_REGISTRY_PREFIX:-${storage.buckets.curated.prefix}/_registry}
    default_partitioning:
      scheme: ${ST_PARTITION_SCHEME:-time}
      time_granularity: ${ST_PARTITION_GRANULARITY:-day}  # hour|day|month
      hive_style: ${ST_PARTITION_HIVE:-true}
    naming:
      sanitize: ${ST_DATASET_SANITIZE:-true}
      max_name_len: ${ST_DATASET_NAME_MAX:-128}

  # Операционные политики: очистка, фоновые задачи, аудит
  ops:
    background_tasks:
      concurrency: ${ST_BG_CONCURRENCY:-2}
      schedule:
        orphan_multipart_cleanup_cron: ${ST_CRON_ABORT_MULTIPART:-"0 * * * *"}
        stale_cache_eviction_cron: ${ST_CRON_CACHE_EVICT:-"*/15 * * * *"}
        lifecycle_dry_run_cron: ${ST_CRON_LC_DRY_RUN:-"0 1 * * *"}
    audit:
      enabled: ${ST_AUDIT_LOG_ENABLED:-true}
      redact_keys:
        - x-amz-security-token
        - authorization
        - cookie
      emit_object_events: ${ST_AUDIT_OBJECT_EVENTS:-true} # put/get/delete/copy

  # Ограничения уровня приложения
  limits:
    max_upload_gb: ${ST_LIMIT_MAX_UPLOAD_GB:-100}
    max_download_gb: ${ST_LIMIT_MAX_DOWNLOAD_GB:-200}
    max_objects_per_request: ${ST_LIMIT_MAX_OBJS_REQ:-1000}
    max_presigned_batch: ${ST_LIMIT_MAX_PRESIGNED_BATCH:-256}
