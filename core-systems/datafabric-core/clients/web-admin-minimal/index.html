<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>DataFabric Admin (minimal)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <!-- Безопасность -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https: http:; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; object-src 'none'; upgrade-insecure-requests">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0b0f14; --panel:#121722; --muted:#94a3b8; --text:#e6edf3; --border:#202938; --accent:#4f46e5; --accent-2:#06b6d4;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f8fb; --panel:#ffffff; --text:#0b1220; --muted:#475569; --border:#e5e7eb; --shadow: 0 10px 30px rgba(0,0,0,.08);}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
      background:var(--bg); color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(8px);
      background: color-mix(in srgb, var(--bg) 85%, transparent);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    .brand{display:flex; gap:10px; align-items:center; font-weight:700}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--accent-2); box-shadow:0 0 12px var(--accent-2)}
    nav{display:flex; gap:10px; flex-wrap:wrap}
    nav button{
      background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer
    }
    nav button[aria-current="page"]{background:var(--panel); border-color:var(--accent-2)}
    main{padding:24px 0}
    .grid{display:grid; gap:16px}
    @media (min-width:960px){ .grid-cols-3{grid-template-columns:1.2fr 1fr 1fr} .grid-cols-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card > header{position:relative; top:auto; backdrop-filter:none; border-bottom:1px solid var(--border); padding:12px 16px; background:transparent}
    .card header h3{margin:0; font-size:14px; letter-spacing:.2px; color:var(--muted)}
    .card .content{padding:16px}
    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .toolbar input,.toolbar select{
      background:color-mix(in srgb, var(--panel) 85%, #0000); border:1px solid var(--border); color:var(--text);
      padding:8px 10px; border-radius:10px; outline: none; min-width:160px;
    }
    .btn{
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow)
    }
    .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none}
    .btn.danger{background:linear-gradient(135deg, var(--err), #ef476f)}
    .status-dot{display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .kpi{display:flex; gap:12px; align-items:center}
    .kpi .num{font-size:22px; font-weight:700}
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:auto}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap}
    .table th{position:sticky; top:0; background:var(--panel); z-index:1; cursor:pointer; user-select:none}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .toast{position:fixed; inset:auto 16px 16px auto; min-width:260px; padding:12px 14px; border-radius:12px; color:#fff; background:#111; box-shadow:var(--shadow); z-index:1000}
    dialog{border:1px solid var(--border); border-radius:14px; background:var(--panel); color:var(--text); padding:0; max-width:520px; width:calc(100% - 32px)}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .dialog-body{padding:16px}
    .dialog-actions{display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--border)}
    /* Логин */
    .login{max-width:420px; margin:56px auto}
    .login h1{margin:0 0 12px 0}
    .login p{margin:0 0 16px 0; color:var(--muted)}
    .login input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text)}
    .footer{padding:24px 0; color:var(--muted); text-align:center; font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; justify-content:space-between; align-items:center; gap:16px">
    <div class="brand" aria-label="DataFabric Admin">
      <span class="dot" aria-hidden="true"></span>
      <span>DataFabric Admin</span>
      <span class="muted" id="envTag"></span>
    </div>
    <nav aria-label="Основная навигация">
      <button data-view="dashboard" aria-current="page">Обзор</button>
      <button data-view="jobs">Задания</button>
      <button data-view="audit">Аудит</button>
      <button data-view="settings">Настройки</button>
      <button id="logoutBtn" class="btn ghost" title="Выйти">Выйти</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Экран логина -->
  <section id="loginView" class="login">
    <h1>Вход</h1>
    <p>Введите токен доступа администратора. Токен хранится в sessionStorage и не покидает браузер.</p>
    <form id="loginForm" autocomplete="off">
      <label for="token" class="muted">Bearer токен</label>
      <input id="token" name="token" type="password" inputmode="latin" required minlength="20" aria-required="true" aria-label="Токен доступа">
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" type="submit">Войти</button>
        <button class="btn ghost" type="button" id="setApiBtn">Задать API</button>
        <span class="muted" id="apiBaseLabel"></span>
      </div>
    </form>
  </section>

  <!-- Приложение -->
  <section id="appView" class="grid grid-cols-3 hidden" aria-live="polite">
    <!-- DASHBOARD -->
    <div id="dashboardView" class="grid grid-cols-3" role="region" aria-label="Обзор системы">
      <article class="card">
        <header><h3>Состояние потоков</h3></header>
        <div class="content">
          <div class="kpi"><span class="status-dot" id="streamStatusDot"></span><span id="streamStatusTxt">-</span></div>
          <div class="muted" id="streamLagTxt">lag: -</div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn" id="pauseAllBtn">Пауза</button>
            <button class="btn" id="resumeAllBtn">Резюмировать</button>
          </div>
        </div>
      </article>
      <article class="card">
        <header><h3>Метрики</h3></header>
        <div class="content">
          <div class="kpi"><span class="num" id="kpiRps">0</span><span class="muted">evt/s</span></div>
          <div class="kpi"><span class="num" id="kpiErr">0</span><span class="muted">ошибок/мин</span></div>
          <div class="kpi"><span class="num" id="kpiLatency">0</span><span class="muted">p95, мс</span></div>
        </div>
      </article>
      <article class="card">
        <header><h3>DLP</h3></header>
        <div class="content">
          <div class="kpi"><span class="num" id="kpiDlp">0</span><span class="muted">инцидентов/ч</span></div>
          <div class="muted" id="dlpLast">последнее: -</div>
        </div>
      </article>

      <article class="card" style="grid-column:1 / -1">
        <header><h3>Недавние события аудита</h3></header>
        <div class="content">
          <div class="toolbar" style="margin-bottom:8px">
            <input id="auditSearch" placeholder="Поиск по действию/актеру/ресурсу" aria-label="Поиск по журналу аудита">
            <select id="auditFilter">
              <option value="">Все категории</option>
              <option>SECURITY</option><option>ACCESS</option><option>DATA</option><option>CONFIG</option><option>PROCESS</option><option>SYSTEM</option>
            </select>
          </div>
          <div style="overflow:auto; max-height:300px">
            <table class="table" id="auditTable" aria-label="Таблица аудита">
              <thead><tr><th data-sort="ts">Время</th><th data-sort="category">Категория</th><th data-sort="action">Действие</th><th data-sort="actor">Актор</th><th data-sort="resource">Ресурс</th><th>Результат</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="toolbar" style="justify-content:space-between; margin-top:8px">
            <div class="muted" id="auditPageInfo">Стр. 1</div>
            <div class="toolbar">
              <button class="btn ghost" id="auditPrev">Назад</button>
              <button class="btn ghost" id="auditNext">Вперед</button>
            </div>
          </div>
        </div>
      </article>
    </div>

    <!-- JOBS -->
    <div id="jobsView" class="hidden" role="region" aria-label="Управление заданиями" style="grid-column:1 / -1">
      <article class="card">
        <header><h3>Задания</h3></header>
        <div class="content">
          <div class="toolbar" style="margin-bottom:8px">
            <input id="jobSearch" placeholder="Фильтр по имени/статусу" aria-label="Поиск по заданиям">
            <button class="btn" id="createJobBtn">Создать</button>
          </div>
          <div style="overflow:auto">
            <table class="table" id="jobsTable" aria-label="Таблица заданий">
              <thead>
                <tr><th data-sort="name">Имя</th><th data-sort="status">Статус</th><th data-sort="updated_at">Обновлено</th><th>Действия</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </article>
    </div>

    <!-- SETTINGS -->
    <div id="settingsView" class="hidden" role="region" aria-label="Настройки" style="grid-column:1 / -1">
      <article class="card">
        <header><h3>Параметры</h3></header>
        <div class="content">
          <div class="toolbar">
            <label class="muted">API Base</label>
            <input id="apiBaseInput" placeholder="https://host/api" style="min-width:280px">
            <button class="btn" id="saveApiBtn">Сохранить</button>
          </div>
          <p class="muted" style="margin-top:8px">Изменение применяется мгновенно. Токен не отправляется на сторонние ресурсы.</p>
        </div>
      </article>
    </div>
  </section>

  <div class="footer">© DataFabric, безопасная панель администрирования</div>
</main>

<!-- Диалоги -->
<dialog id="confirmDlg" aria-label="Подтверждение">
  <div class="dialog-body">
    <h3 id="confirmTitle" style="margin:0 0 6px 0">Подтвердите действие</h3>
    <p id="confirmText" class="muted">Вы уверены?</p>
  </div>
  <div class="dialog-actions">
    <button class="btn ghost" id="confirmCancel">Отмена</button>
    <button class="btn danger" id="confirmOk">Подтвердить</button>
  </div>
</dialog>

<div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

<script type="module">
/* ================== Конфиг =================== */
const CONFIG = {
  API_BASE: sessionStorage.getItem('API_BASE') || (location.origin + '/api'),
  TOKEN_KEY: 'DF_ADMIN_TOKEN',
  REQUEST_TIMEOUT_MS: 10000,
  RETRIES: 2
};
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
$('#apiBaseLabel').textContent = CONFIG.API_BASE;
$('#apiBaseInput').value = CONFIG.API_BASE;
$('#envTag').textContent = (new URL(CONFIG.API_BASE)).hostname;

/* ================== Безопасные утилиты =================== */
const San = {
  text(s){ return String(s ?? '').replace(/[<>&"']/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[m])); },
};
function toast(msg, type='info'){
  const t = $('#toast'); t.textContent = msg;
  t.style.background = type==='error' ? 'linear-gradient(135deg,#ef4444,#ef476f)' :
                       type==='warn' ? 'linear-gradient(135deg,#f59e0b,#f97316)' :
                                       'linear-gradient(135deg,#4f46e5,#06b6d4)';
  t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3000);
}
function confirmDialog(title,text){ return new Promise(res=>{
  const dlg = $('#confirmDlg'); $('#confirmTitle').textContent = title; $('#confirmText').textContent = text;
  dlg.showModal(); const ok = $('#confirmOk'), cancel = $('#confirmCancel');
  const done = v=>{ dlg.close(); ok.onclick = cancel.onclick = null; res(v); };
  ok.onclick=()=>done(true); cancel.onclick=()=>done(false);
});}

/* ================== API клиент =================== */
class ApiClient{
  constructor(base){ this.base = base; this.ctrl = null; }
  token(){ return sessionStorage.getItem(CONFIG.TOKEN_KEY) || ''; }
  setBase(url){ this.base = url; sessionStorage.setItem('API_BASE', url); }
  async req(path, {method='GET', body, headers={}, retries=CONFIG.RETRIES, timeout=CONFIG.REQUEST_TIMEOUT_MS}={}){
    if(this.ctrl) this.ctrl.abort(); // отмена пред. запроса той же сессии
    this.ctrl = new AbortController();
    const url = this.base.replace(/\/$/,'') + path;
    const opts = {
      method,
      headers: {'Content-Type':'application/json','Authorization':'Bearer ' + this.token(), ...headers},
      signal: this.ctrl.signal
    };
    if(body !== undefined) opts.body = typeof body==='string'? body : JSON.stringify(body);
    for(let attempt=0;;attempt++){
      try{
        const t = setTimeout(()=>this.ctrl.abort(), timeout);
        const r = await fetch(url, opts);
        clearTimeout(t);
        if(r.status===401){ throw new Error('UNAUTHORIZED'); }
        if(!r.ok){ const txt = await r.text(); throw new Error(`HTTP ${r.status}: ${txt.slice(0,256)}`); }
        const ct = r.headers.get('content-type')||'';
        return ct.includes('application/json') ? r.json() : r.text();
      }catch(e){
        if(attempt>=retries) throw e;
        await new Promise(s=>setTimeout(s, 300*(attempt+1)));
      }
    }
  }
  // Эндпоинты
  me(){ return this.req('/auth/me'); }
  metrics(){ return this.req('/metrics'); }
  jobs(){ return this.req('/jobs'); }
  pauseAll(){ return this.req('/jobs/pause-all',{method:'POST'}); }
  resumeAll(){ return this.req('/jobs/resume-all',{method:'POST'}); }
  audit({q='',cat='',page=1,limit=20}={}){ const p = new URLSearchParams({q,cat,page,limit}); return this.req('/audit?'+p.toString()); }
}
const api = new ApiClient(CONFIG.API_BASE);

/* ================== Аутентификация =================== */
function isAuthed(){ return !!sessionStorage.getItem(CONFIG.TOKEN_KEY); }
function showApp(v){ $('#loginView').classList.toggle('hidden', v); $('#appView').classList.toggle('hidden', !v); }
async function postLogin(){
  try{ await api.me(); showApp(true); toast('Вход выполнен'); loadDashboard(); switchView('dashboard'); }
  catch(e){ toast('Ошибка входа: ' + (e.message||e), 'error'); sessionStorage.removeItem(CONFIG.TOKEN_KEY); showApp(false); }
}

/* ================== Навигация =================== */
function switchView(name){
  for(const btn of $$('nav button[data-view]')) btn.setAttribute('aria-current', btn.dataset.view===name?'page':'false');
  for(const v of ['dashboard','jobs','audit','settings']){
    $('#' + v + 'View').classList.toggle('hidden', v!==name);
  }
  if(name==='jobs') loadJobs();
  if(name==='audit') loadAudit(1);
}

/* ================== Табличные утилиты =================== */
function makeRow(cells){ const tr = document.createElement('tr'); tr.innerHTML = cells.map(c=>`<td>${San.text(c)}</td>`).join(''); return tr; }
function bindSort(tableId, onSort){
  const thead = document.querySelector(`#${tableId} thead`);
  thead.addEventListener('click', e=>{
    const th = e.target.closest('th'); if(!th||!th.dataset.sort) return;
    const key = th.dataset.sort; const dir = th.dataset.dir==='asc'?'desc':'asc'; th.dataset.dir=dir;
    for(const t of thead.querySelectorAll('th')) if(t!==th) delete t.dataset.dir;
    onSort(key, dir);
  });
}

/* ================== ДАННЫЕ: Dashboard =================== */
let sse=null;
async function loadDashboard(){
  try{
    const m = await api.metrics();
    $('#kpiRps').textContent = (m.rps??0).toFixed?.(1) ?? String(m.rps||0);
    $('#kpiErr').textContent = m.errors_per_min ?? 0;
    $('#kpiLatency').textContent = m.latency_p95_ms ?? 0;
    $('#kpiDlp').textContent = m.dlp_incidents_per_hour ?? 0;
    $('#dlpLast').textContent = m.dlp_last ?? '-';
    setStreamStatus(m.stream_status||'unknown', m.stream_lag_s||null);
  }catch(e){ toast('Метрики недоступны: '+e.message, 'warn'); }
  startSSE();
}
function setStreamStatus(status, lag){
  const dot = $('#streamStatusDot'); const txt = $('#streamStatusTxt'); const lagTxt = $('#streamLagTxt');
  dot.style.background = status==='running' ? 'var(--ok)' : status==='paused' ? 'var(--warn)' : 'var(--err)';
  txt.textContent = status.toUpperCase?.() || String(status);
  lagTxt.textContent = 'lag: ' + (lag==null?'-': (lag+'s'));
}
function startSSE(){
  try{ sse?.close(); }catch{} sse=null;
  try{
    sse = new EventSource(api.base.replace(/\/$/,'') + '/observability/stream', {withCredentials:false});
    sse.onmessage = (e)=>{
      try{
        const d = JSON.parse(e.data);
        if(d.type==='metrics'){
          $('#kpiRps').textContent = (d.rps??0).toFixed?.(1) ?? String(d.rps||0);
          $('#kpiErr').textContent = d.errors_per_min ?? 0;
          $('#kpiLatency').textContent = d.latency_p95_ms ?? 0;
        }
        if(d.type==='stream'){ setStreamStatus(d.status, d.lag_s); }
        if(d.type==='audit'){ prependAuditRow(d.event); }
      }catch{}
    };
    sse.onerror = ()=>{/* молча, авто‑reconnect браузера */};
  }catch{ /* SSE не поддерживается */ }
}

/* ================== ДАННЫЕ: Audit =================== */
let auditState = {page:1, q:'', cat:''};
async function loadAudit(page=1){
  auditState.page = page;
  const q = $('#auditSearch').value.trim(); const cat = $('#auditFilter').value;
  try{
    const data = await api.audit({q,cat,page,limit:20});
    const tb = $('#auditTable tbody'); tb.innerHTML='';
    for(const r of (data.items||[])){
      tb.appendChild(makeRow([
        r.ts, r.category, r.action, (r.actor?.id||'-'), (r.resource?.id||'-'), r.result
      ]));
    }
    $('#auditPageInfo').textContent = `Стр. ${data.page||page} из ${data.pages||'?'}`;
  }catch(e){ toast('Ошибка загрузки аудита: '+e.message,'error'); }
}
function prependAuditRow(r){
  const tb = $('#auditTable tbody');
  tb.insertBefore(makeRow([r.ts, r.category, r.action, (r.actor?.id||'-'), (r.resource?.id||'-'), r.result]), tb.firstChild);
  // ограничим до 200 строк
  while(tb.rows.length>200) tb.deleteRow(tb.rows.length-1);
}

/* ================== ДАННЫЕ: Jobs =================== */
let jobsCache = [];
async function loadJobs(){
  try{
    const data = await api.jobs();
    jobsCache = data.items||[];
    renderJobs(jobsCache);
  }catch(e){ toast('Ошибка загрузки заданий: '+e.message, 'error'); }
}
function renderJobs(items){
  const q = $('#jobSearch').value.trim().toLowerCase();
  const filtered = items.filter(x => (x.name||'').toLowerCase().includes(q) || (x.status||'').toLowerCase().includes(q));
  const tb = $('#jobsTable tbody'); tb.innerHTML='';
  for(const j of filtered){
    const tr = document.createElement('tr');
    const statusColor = j.status==='running'?'ok':j.status==='paused'?'warn':'err';
    tr.innerHTML = `
      <td>${San.text(j.name)}</td>
      <td><span class="status-dot" style="background:var(--${statusColor})"></span>${San.text(j.status||'-')}</td>
      <td>${San.text(j.updated_at||'-')}</td>
      <td>
        <button class="btn ghost" data-act="pause" data-name="${San.text(j.name)}">Пауза</button>
        <button class="btn ghost" data-act="resume" data-name="${San.text(j.name)}">Старт</button>
      </td>`;
    tb.appendChild(tr);
  }
}
bindSort('auditTable', (key,dir)=>{
  const rows = Array.from($('#auditTable tbody').rows);
  rows.sort((a,b)=> {
    const av=a.cells[[ 'ts','category','action','actor','resource','result' ].indexOf(key)].textContent;
    const bv=b.cells[[ 'ts','category','action','actor','resource','result' ].indexOf(key)].textContent;
    return dir==='asc'? av.localeCompare(bv): bv.localeCompare(av);
  });
  const tb=$('#auditTable tbody'); tb.innerHTML=''; rows.forEach(r=>tb.appendChild(r));
});

/* ================== События UI =================== */
// логин
$('#loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const token = $('#token').value.trim();
  if(token.length<20){ toast('Некорректный токен', 'warn'); return; }
  sessionStorage.setItem(CONFIG.TOKEN_KEY, token);
  await postLogin();
});
$('#setApiBtn').onclick = ()=>{
  $('#settingsView').classList.remove('hidden'); $('#appView').classList.remove('hidden'); $('#loginView').classList.add('hidden');
};

// навигация
for(const b of $$('nav button[data-view]')) b.addEventListener('click', ()=>switchView(b.dataset.view));
$('#logoutBtn').onclick = ()=>{ sessionStorage.removeItem(CONFIG.TOKEN_KEY); location.reload(); };

// dashboard controls
$('#pauseAllBtn').onclick = async ()=>{
  if(!await confirmDialog('Пауза потоков','Остановить все задания?')) return;
  try{ await api.pauseAll(); toast('Все задания поставлены на паузу'); loadJobs(); }
  catch(e){ toast('Ошибка: '+e.message,'error'); }
};
$('#resumeAllBtn').onclick = async ()=>{
  try{ await api.resumeAll(); toast('Задания возобновлены'); loadJobs(); }
  catch(e){ toast('Ошибка: '+e.message,'error'); }
};

// audit controls
$('#auditPrev').onclick = ()=> loadAudit(Math.max(1, auditState.page-1));
$('#auditNext').onclick = ()=> loadAudit(auditState.page+1);
$('#auditSearch').addEventListener('input', debounce(()=>loadAudit(1), 300));
$('#auditFilter').addEventListener('change', ()=>loadAudit(1));

// jobs controls
$('#jobSearch').addEventListener('input', debounce(()=>renderJobs(jobsCache), 200));
$('#jobsTable').addEventListener('click', async e=>{
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const name = btn.dataset.name; const act = btn.dataset.act;
  if(act==='pause' && !(await confirmDialog('Пауза задания',`Остановить ${name}?`))) return;
  try{
    await api.req(`/jobs/${encodeURIComponent(name)}/${act}`, {method:'POST'});
    toast(`Задание ${name}: ${act==='pause'?'пауза':'запущено'}`);
    await loadJobs();
  }catch(err){ toast('Ошибка: '+err.message,'error'); }
});

// settings
$('#saveApiBtn').onclick = ()=>{
  const val = $('#apiBaseInput').value.trim();
  try{ new URL(val); api.setBase(val); $('#apiBaseLabel').textContent = val; toast('API обновлён'); }
  catch{ toast('Некорректный URL','warn'); }
};

/* ================== Хелперы =================== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ================== Инициализация =================== */
(function init(){
  // первичная видимость
  const authed = isAuthed();
  showApp(authed);
  if(authed) postLogin();
})();
</script>
</body>
</html>
