apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: datafabric-core
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: datafabric
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Приоритет HPA над VPA (если используется): отключите VPA "recommender" для данной группы
    autoscaling.alpha.kubernetes.io/conditions: ""
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: datafabric-core
  minReplicas: 3
  maxReplicas: 50

  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0
      selectPolicy: Max
      policies:
        - type: Pods
          value: 10           # не более +10 подов за 60с
          periodSeconds: 60
        - type: Percent
          value: 100          # или не более +100% за 60с
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300  # сглаживание «дрожания» нагрузки (5 минут)
      selectPolicy: Max
      policies:
        - type: Percent
          value: 30           # не более −30% за 60с
          periodSeconds: 60

  metrics:
    # 1) CPU как основной универсальный сигнал (целевое среднее по реплике)
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60   # целевая загрузка CPU ~60%

    # 2) Память: удерживаем среднее значение на под (AverageValue, а не Utilization)
    - type: Resource
      resource:
        name: memory
        target:
          type: AverageValue
          averageValue: "600Mi"

    # 3) Скорость запросов на под (через Prometheus Adapter как pods‑метрика)
    #    Требуется настроенный metrics‑adapter, экспонирующий метрику уровня pod.
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "20"     # целевые 20 RPS на под

    # 4) (опционально) Внешняя метрика бэклога очереди для worker‑ролей
    # - type: External
    #   external:
    #     metric:
    #       name: queue_backlog
    #       selector:
    #         matchLabels:
    #           service: datafabric-core
    #     target:
    #       type: AverageValue
    #       averageValue: "100"
