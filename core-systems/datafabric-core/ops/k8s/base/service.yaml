apiVersion: v1
kind: Service
metadata:
  name: datafabric-core
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/instance: datafabric-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: datafabric-core
    app.kubernetes.io/version: "0.0.0" # переопределяется в overlay через kustomize
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Prometheus scrape (перекрывайте в overlay при необходимости)
    prometheus.io/scrape: "true"
    prometheus.io/path: "/metrics"
    prometheus.io/port: "8080"
spec:
  type: ClusterIP
  # Dual-stack по возможности кластера; безопасно для single-stack (игнорируется)
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  publishNotReadyAddresses: false
  ports:
    - name: http
      port: 80             # внутри кластера
      targetPort: 8080     # порт контейнера
      protocol: TCP
      appProtocol: http    # сигнализирует L7 протокол сетевым плагинам/ingress
    # Раскомментируйте, если метрики отдаются на отдельном порту
    # - name: metrics
    #   port: 9090
    #   targetPort: 9090
    #   protocol: TCP
    #   appProtocol: http
  selector:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/instance: datafabric-core
