# datafabric-core / k8s / base / pdb.yaml
# Версия API актуальна для Kubernetes 1.25+.
# Правило: для stateful‑сервисов (одинарные StatefulSet) используем minAvailable: 1,
#          для масштабируемого приложения — долю доступности.

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: postgres
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
      app.kubernetes.io/component: db

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: redis-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: redis
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: redis
      app.kubernetes.io/component: cache

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: kafka-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: kafka
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kafka
      app.kubernetes.io/component: broker

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: minio-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: minio
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: minio
      app.kubernetes.io/component: object-store

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: app-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: datafabric
spec:
  # Гарантируем, что не менее 60% подов приложения остаётся доступно
  # во время добровольных эвикшенов/обновлений.
  minAvailable: "60%"
  selector:
    matchLabels:
      app.kubernetes.io/name: datafabric-core
      app.kubernetes.io/component: api

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: prometheus-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: prometheus
      app.kubernetes.io/component: monitoring

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: grafana-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: grafana
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
      app.kubernetes.io/component: monitoring

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: jaeger-pdb
  labels:
    app.kubernetes.io/name: datafabric-core
    app.kubernetes.io/component: jaeger
    app.kubernetes.io/part-of: datafabric
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: jaeger
      app.kubernetes.io/component: tracing
