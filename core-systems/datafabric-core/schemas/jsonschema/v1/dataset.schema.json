{
  "$id": "https://schemas.aethernova.io/datafabric-core/v1/dataset.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "DataFabric Core Dataset Specification",
  "description": "Единый контракт описания датасета для каталога, CI-валидации и генерации политик хранения/доступа.",
  "type": "object",
  "unevaluatedProperties": false,

  "properties": {
    "schema": {
      "type": "object",
      "description": "Метаданные схемы документа.",
      "required": ["version", "format", "owner", "updated_at"],
      "properties": {
        "version": { "type": "integer", "minimum": 1 },
        "format":  { "type": "string", "const": "aethernova.dataset/1.0" },
        "owner":   { "type": "string", "minLength": 1 },
        "updated_at": { "type": "string", "format": "date-time" }
      },
      "unevaluatedProperties": false
    },

    "identity": {
      "type": "object",
      "description": "Устойчивые идентификаторы датасета.",
      "required": ["id", "name", "namespace", "owner"],
      "properties": {
        "id":        { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
        "name":      { "type": "string", "minLength": 3, "maxLength": 128 },
        "namespace": { "type": "string", "pattern": "^[a-z0-9._:-]{3,64}$" },
        "owner":     { "type": "string", "minLength": 1 },
        "tenant":    { "type": "string" },
        "domain":    { "type": "string" },
        "labels":    { "type": "object", "additionalProperties": { "type": "string" } }
      },
      "unevaluatedProperties": false
    },

    "classification": {
      "description": "Класс защищенности данных.",
      "$ref": "#/$defs/classification"
    },
    "pii":        { "type": "boolean", "description": "Содержит ли PII." },
    "pii_level":  { "$ref": "#/$defs/pii_level" },

    "retention_ref": {
      "type": "string",
      "description": "URI-ссылка на правило retention для данного класса/среды.",
      "format": "uri-reference"
    },

    "export_policy": {
      "type": "object",
      "description": "Политика экспорта/публикации для датасета.",
      "properties": {
        "allow_public": { "type": "boolean", "default": false },
        "dlp_required": { "type": "boolean", "default": true },
        "approvals": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true,
          "default": ["DPO", "Security"]
        }
      },
      "unevaluatedProperties": false
    },

    "versioning": {
      "type": "object",
      "description": "Версионирование датасета и схем.",
      "required": ["dataset_version"],
      "properties": {
        "dataset_version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+(-[0-9A-Za-z.-]+)?$" },
        "schema_version":  { "type": "string" },
        "revision":        { "type": "string", "description": "Git SHA/CSN" }
      },
      "unevaluatedProperties": false
    },

    "schema_refs": {
      "type": "array",
      "description": "Ссылки на формальные схемы данных.",
      "items": {
        "type": "object",
        "required": ["type", "uri"],
        "properties": {
          "type": { "enum": ["jsonschema", "avro", "protobuf"] },
          "uri":  { "type": "string", "format": "uri" },
          "message": { "type": "string", "description": "Для protobuf: fully-qualified message" }
        },
        "unevaluatedProperties": false
      },
      "minItems": 1
    },

    "storage": {
      "type": "object",
      "description": "Физические таргеты хранения.",
      "required": ["targets"],
      "properties": {
        "targets": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/storage_target" }
        }
      },
      "unevaluatedProperties": false
    },

    "partitioning": {
      "type": "object",
      "description": "Правила партиционирования данных.",
      "properties": {
        "columns": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "type"],
            "properties": {
              "name": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$" },
              "type": { "enum": ["date", "datetime", "string", "int", "bucket"] },
              "granularity": { "enum": ["hour", "day", "month", "year"] },
              "buckets": { "type": "integer", "minimum": 2 }
            },
            "unevaluatedProperties": false
          },
          "uniqueItems": true
        }
      },
      "unevaluatedProperties": false
    },

    "quality": {
      "type": "object",
      "description": "SLO/проверки качества.",
      "properties": {
        "checks_ref": { "type": "string", "format": "uri-reference" },
        "slo": {
          "type": "object",
          "properties": {
            "freshness_max_sec": { "type": "integer", "minimum": 0 },
            "max_error_ratio":   { "type": "number", "minimum": 0, "maximum": 1 },
            "p95_latency_ms":    { "type": "integer", "minimum": 0 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },

    "lineage": {
      "type": "object",
      "description": "Минимальные метаданные происхождения.",
      "properties": {
        "parents": {
          "type": "array",
          "items": { "type": "string", "format": "uri-reference" },
          "uniqueItems": true
        },
        "policy_ref": { "type": "string", "format": "uri-reference" }
      },
      "unevaluatedProperties": false
    },

    "audit": {
      "type": "object",
      "description": "Параметры аудита/иммутабельности.",
      "properties": {
        "immutable": { "type": "boolean", "default": false },
        "object_lock": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "mode": { "enum": ["GOVERNANCE", "COMPLIANCE"] },
            "days": { "type": "integer", "minimum": 1 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },

    "access": {
      "type": "object",
      "description": "Доступ и ограничения.",
      "properties": {
        "roles_read":  { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "roles_write": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "ip_allowlist": { "type": "array", "items": { "type": "string", "format": "ipv4" }, "uniqueItems": true }
      },
      "unevaluatedProperties": false
    },

    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "uniqueItems": true
    },

    "annotations": {
      "type": "object",
      "description": "Нефункциональные пометки (free-form).",
      "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
    },

    "created_at": { "type": "string", "format": "date-time" },
    "updated_at": { "type": "string", "format": "date-time" }
  },

  "required": [
    "schema",
    "identity",
    "classification",
    "pii",
    "schema_refs",
    "storage",
    "versioning"
  ],

  "allOf": [
    {
      "if": { "properties": { "pii": { "const": true } } },
      "then": { "required": ["pii_level"], "properties": { "pii_level": { "not": { "const": "none" } } } }
    },
    {
      "if": { "properties": { "classification": { "const": "restricted" } } },
      "then": { "properties": { "audit": { "properties": { "immutable": { "const": true } } } } }
    },
    {
      "if": { "properties": { "export_policy": { "properties": { "allow_public": { "const": true } } } } },
      "then": {
        "properties": {
          "export_policy": {
            "required": ["dlp_required", "approvals"],
            "properties": { "dlp_required": { "const": true } }
          }
        }
      }
    },
    {
      "if": { "properties": { "storage": { "properties": { "targets": { "contains": { "properties": { "type": { "const": "kafka" } }, "required": ["type"] } } } } } },
      "then": { "properties": { "storage": { "properties": { "targets": { "items": { "allOf": [ { "if": { "properties": { "type": { "const": "kafka" } } }, "then": { "required": ["topic", "partitions", "replication_factor"] } } ] } } } } } }
    },
    {
      "if": { "properties": { "storage": { "properties": { "targets": { "contains": { "properties": { "type": { "const": "s3" } }, "required": ["type"] } } } } } },
      "then": { "properties": { "storage": { "properties": { "targets": { "items": { "allOf": [ { "if": { "properties": { "type": { "const": "s3" } } }, "then": { "required": ["bucket", "region", "format"] } } ] } } } } } }
    }
  ],

  "$defs": {
    "classification": {
      "type": "string",
      "enum": ["public", "internal", "confidential", "restricted"]
    },
    "pii_level": {
      "type": "string",
      "enum": ["none", "weak", "strong"]
    },

    "region": {
      "type": "string",
      "description": "Облачный регион AWS-подобного формата.",
      "pattern": "^[a-z]{2}-[a-z]+-\\d$"
    },

    "duration": {
      "type": "string",
      "description": "ISO 8601 duration (PnDTnHnMnS / PnD / PnM / PnY).",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$"
    },

    "compression": {
      "type": "string",
      "enum": ["none", "gzip", "zstd", "snappy", "lz4"]
    },

    "format": {
      "type": "string",
      "enum": ["json", "parquet", "avro", "protobuf", "binary"]
    },

    "kms_arn": {
      "type": "string",
      "pattern": "^arn:aws:kms:[a-z0-9-]+:\\d{12}:key\\/.+$"
    },

    "storage_target": {
      "type": "object",
      "oneOf": [
        { "$ref": "#/$defs/storage_s3" },
        { "$ref": "#/$defs/storage_postgres" },
        { "$ref": "#/$defs/storage_kafka" },
        { "$ref": "#/$defs/storage_elastic" },
        { "$ref": "#/$defs/storage_filesystem" }
      ]
    },

    "storage_s3": {
      "type": "object",
      "title": "S3/объектное хранилище",
      "required": ["type", "bucket", "region", "format"],
      "properties": {
        "type":   { "const": "s3" },
        "bucket": { "type": "string", "minLength": 3 },
        "prefix": { "type": "string", "default": "" },
        "region": { "$ref": "#/$defs/region" },
        "format": { "$ref": "#/$defs/format" },
        "compression": { "$ref": "#/$defs/compression", "default": "none" },
        "kms_key_arn": { "$ref": "#/$defs/kms_arn" },
        "object_lock": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "mode": { "enum": ["GOVERNANCE", "COMPLIANCE"] },
            "days": { "type": "integer", "minimum": 1 }
          },
          "unevaluatedProperties": false
        },
        "lifecycle": {
          "type": "object",
          "description": "Подсказки генератору S3 Lifecycle (синхронизируется с retention).",
          "properties": {
            "transition_after": { "$ref": "#/$defs/duration" },
            "transition_to": { "enum": ["STANDARD_IA", "GLACIER_IR", "DEEP_ARCHIVE"] },
            "expire_after": { "$ref": "#/$defs/duration" }
          },
          "unevaluatedProperties": false
        },
        "crr_enabled": { "type": "boolean", "default": false }
      },
      "unevaluatedProperties": false
    },

    "storage_postgres": {
      "type": "object",
      "title": "PostgreSQL",
      "required": ["type", "database", "schema", "table"],
      "properties": {
        "type":    { "const": "postgres" },
        "database":{ "type": "string" },
        "schema":  { "type": "string" },
        "table":   { "type": "string" },
        "primary_key": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "indexes": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "retention_sql": { "type": "string", "description": "WHERE-условие для purge джоб." }
      },
      "unevaluatedProperties": false
    },

    "storage_kafka": {
      "type": "object",
      "title": "Apache Kafka/MSK",
      "required": ["type", "topic", "partitions", "replication_factor"],
      "properties": {
        "type": { "const": "kafka" },
        "topic": { "type": "string", "pattern": "^[a-zA-Z0-9._-]{3,255}$" },
        "partitions": { "type": "integer", "minimum": 1 },
        "replication_factor": { "type": "integer", "minimum": 1 },
        "key_format":   { "enum": ["string", "json", "avro", "protobuf", "bytes"], "default": "string" },
        "value_format": { "enum": ["json", "avro", "protobuf", "bytes"], "default": "json" },
        "cleanup_policy": { "enum": ["delete", "compact", "compact,delete"], "default": "delete" },
        "retention_ms": { "type": "integer", "minimum": 0 },
        "min_insync_replicas": { "type": "integer", "minimum": 1 },
        "schema_registry": { "type": "string", "format": "uri" }
      },
      "unevaluatedProperties": false
    },

    "storage_elastic": {
      "type": "object",
      "title": "Elasticsearch/OpenSearch",
      "required": ["type", "index"],
      "properties": {
        "type":  { "const": "elastic" },
        "index": { "type": "string" },
        "ilm_policy": { "type": "string" }
      },
      "unevaluatedProperties": false
    },

    "storage_filesystem": {
      "type": "object",
      "title": "Файловая система/локальный путь",
      "required": ["type", "path", "format"],
      "properties": {
        "type":   { "const": "filesystem" },
        "path":   { "type": "string" },
        "format": { "$ref": "#/$defs/format" },
        "compression": { "$ref": "#/$defs/compression", "default": "none" }
      },
      "unevaluatedProperties": false
    }
  }
}
