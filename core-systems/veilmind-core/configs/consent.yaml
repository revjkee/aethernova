# veilmind-core/configs/consent.yaml
# Контракт управления согласием и конфиденциальностью для veilmind-core.
# Версионируется и применим к веб/мобайл/API. Все идентификаторы стабильны.

schema_version: 1

policy:
  id: consent-policy
  version: 2025-08-21-1
  name: "VeilMind Privacy & Consent Policy"
  description: "Единая политика управления согласием, правовыми основаниями и хранением."
  owner: "DPO <privacy@CHANGE_ME.org>"
  last_reviewed_at: "2025-08-21T00:00:00Z"
  next_review_due_days: 180
  locales:
    default: en
    supported: [en, ru, sv]

# Механизм миграции между версиями политики
migrations:
  - from: 2025-05-01-1
    to:   2025-08-21-1
    changes:
      added_purposes: [ads_personalization]
      updated_retention:
        - purpose: analytics
          old_days: 395
          new_days: 365
      deprecated_purposes: [legacy_abtest]

# Категории персональных данных (DCAT)
data_categories:
  account_identifiers:
    name: "Аккаунт и идентификаторы"
    examples: ["user_id", "email (хешированная)"]
    pii: true
    retention_days_default: 365
  device_identifiers:
    name: "Устройство и телеметрия"
    examples: ["device_id", "ip", "user_agent", "ulid"]
    pii: true
    retention_days_default: 180
  usage_metrics:
    name: "Аналитика использования"
    examples: ["page_views", "feature_clicks"]
    pii: false
    retention_days_default: 365
  diagnostics:
    name: "Диагностика и ошибки"
    examples: ["stack_traces", "latency", "error_codes"]
    pii: false
    retention_days_default: 90
  payments:
    name: "Платежные данные (ограниченно)"
    examples: ["transaction_id (токенизированный)"]
    pii: true
    retention_days_default: 365

# Карта процессоров/вендоров
processors:
  first_party:
    name: "VeilMind Core"
    location: "EU"
    dpa_signed: true
  analytics_fp:
    name: "First-Party Analytics"
    location: "EU"
    dpa_signed: true
  s3_storage:
    name: "S3 Object Storage"
    location: "EU"
    dpa_signed: true
  email_provider:
    name: "Email Service"
    location: "EU/US"
    dpa_signed: true
  ads_network:
    name: "Ads Network"
    location: "US"
    dpa_signed: true

# Цели обработки (Purposes) и правовые основания
purposes:
  essential_services:
    name: "Функционирование сервиса"
    description: "Аутентификация, сеансы, обеспечение безопасности (Zero Trust), биллинг."
    legal_basis:
      gdpr: "contract"         # contract | consent | legitimate_interest | legal_obligation | vital_interest
      ccpa: "necessary"
    processors: [first_party, s3_storage]
    data_categories: [account_identifiers, device_identifiers, diagnostics]
    consent_required: false
    retention_override_days: 365
    default_enabled: true
    enforce:
      sdk_flags: ["FF_ZERO_TRUST_STRICT", "FF_API_READONLY:false"]
      api_gates: ["session_required", "csrf_protection", "rate_limit"]
      cookie_categories: ["strictly_necessary"]
  security_fraud:
    name: "Безопасность и предотвращение мошенничества"
    description: "Риск‑скоринг, детекция аномалий, журнал безопасности."
    legal_basis:
      gdpr: "legitimate_interest"
      ccpa: "security"
    processors: [first_party]
    data_categories: [account_identifiers, device_identifiers, diagnostics, usage_metrics]
    consent_required: false
    retention_override_days: 365
    default_enabled: true
    enforce:
      api_gates: ["risk_score_required", "pep_cache_allowed"]
      cookie_categories: ["strictly_necessary"]
  analytics:
    name: "Аналитика"
    description: "Агрегированные метрики использования и UX."
    legal_basis:
      gdpr: "consent"
      ccpa: "sale_share_optout"   # предлагается опт-аут
    processors: [analytics_fp]
    data_categories: [usage_metrics, device_identifiers]
    consent_required: true
    retention_override_days: 365
    default_enabled: false
    enforce:
      sdk_flags: ["ANALYTICS_COLLECT:false"]
      cookie_categories: ["performance"]
  email_comm:
    name: "Коммуникации по email"
    description: "Транзакционные письма и рассылки при наличии согласия."
    legal_basis:
      gdpr: "consent"
      ccpa: "notice_optout"
    processors: [email_provider]
    data_categories: [account_identifiers]
    consent_required: true
    retention_override_days: 365
    default_enabled: false
    enforce:
      sdk_flags: ["EMAIL_MKT:false"]
      cookie_categories: []
  ads_personalization:
    name: "Персонализированная реклама"
    description: "Профайлинг для персонализации объявлений."
    legal_basis:
      gdpr: "consent"
      ccpa: "sale_share_optout"
    processors: [ads_network]
    data_categories: [usage_metrics, device_identifiers]
    consent_required: true
    retention_override_days: 180
    default_enabled: false
    enforce:
      sdk_flags: ["ADS_PERSONALIZED:false"]
      cookie_categories: ["targeting"]

# Гео‑политики и переопределения по регионам
regional_policies:
  EEA:
    locale_default: "en"
    require_prior_consent_for: [analytics, email_comm, ads_personalization]
    show_reject_all_button: true
    consent_expiry_days: 180
  UK:
    inherit: EEA
  US:
    locale_default: "en"
    ccpa:
      do_not_sell_share_link: "/privacy/donotsell"
      respect_gpc_signal: true
    consent_expiry_days: 365
    require_prior_consent_for: [ads_personalization]
  BR:
    locale_default: "en"
    lgpd:
      controller: "CHANGE_ME Controller Ltd."
    consent_expiry_days: 365
    require_prior_consent_for: [analytics, ads_personalization]

# Возрастные ограничения (COPPA/kid‑safe)
age_gates:
  enabled: true
  min_age: 16
  underage_behavior:
    allow_essential_only: true
    block_purposes: [analytics, email_comm, ads_personalization]

# Cookie‑категории для CMP/баннера
cookie_categories:
  strictly_necessary:
    description: "Сессии, безопасность, настройки конфигурации."
    examples: ["sessionid", "csrf"]
  performance:
    description: "Измерение производительности и агрегированная аналитика."
    examples: ["perf_beacon"]
  targeting:
    description: "Реклама и профайлинг."
    examples: ["ad_id"]

# Интеграция с TCF v2.2 / US Privacy (включается при необходимости)
cmp:
  enabled: false
  tcf_v2:
    enabled: false
    vendor_list_url: "https://vendorlist.consensu.org/v2/vendor-list.json"
    gvl_version_min: 2
  us_privacy:
    enabled: true
    respect_usp_string: true

# Механика получения, хранения и доказуемости согласия
consent_recording:
  storage:
    engine: "postgres"                          # postgres | dynamodb | bigquery
    table: "user_consent_events"
    region: "eu-north-1"
  hashing:
    user_id_hash_salt_env: "CONSENT_USER_SALT"  # env var; соль не хранить в БД
    algo: "sha256"
    pepper_kms_key_id: "CHANGE_ME_KMS_KEY"
  encryption_at_rest: true
  encryption_in_transit: true
  redact_fields: ["ip", "user_agent"]           # сохранять только хеш/обрезанные данные
  retention_days: 1095                          # 3 года для доказуемости
  append_only: true                              # неизменяемый журнал
  event_schema:
    - ts
    - user_hash
    - region
    - purpose_id
    - action            # grant|deny|withdraw|update|expire|migrate
    - version           # версия политики на момент согласия
    - surface           # web|mobile|api
    - proof:
        type: "jws"     # jws|log_chain
        jti: true       # уникальный идентификатор события

# Принудительное применение (enforcement) на уровне серверов и клиента
enforcement:
  server:
    reject_if_no_consent_for:
      - purpose: analytics
        paths: ["/analytics/*"]
      - purpose: ads_personalization
        paths: ["/ads/*"]
    headers:
      send_gpc_header_downstream: true
    risk_scoring_exempt_paths: ["/healthz/*", "/metrics"]
  client:
    default_banner_variant: "modal-bottom"
    dark_patterns_forbidden: true
    show_reject_all: true
    show_accept_all: true
    show_manage_link: true
    texts:
      en:
        title: "Your privacy choices"
        accept_all: "Accept all"
        reject_all: "Reject all"
        manage: "Manage settings"
      ru:
        title: "Ваш выбор конфиденциальности"
        accept_all: "Принять все"
        reject_all: "Отклонить все"
        manage: "Настройки"
      sv:
        title: "Dina integritetsval"
        accept_all: "Acceptera alla"
        reject_all: "Avvisa alla"
        manage: "Hantera"

# API‑контракт для SDK/Frontend
api_contract:
  get_status_endpoint: "/v1/privacy/consent/status"
  set_preferences_endpoint: "/v1/privacy/consent/set"
  withdraw_all_endpoint: "/v1/privacy/consent/withdraw"
  dsar_endpoints:
    access: "/v1/privacy/dsar/access"
    delete: "/v1/privacy/dsar/delete"
    portability: "/v1/privacy/dsar/portability"
  auth_required: true
  rate_limit: "20r/m"
  idempotency_keys: true
  audit_log_enabled: true

# Политики истечения согласий
expiry:
  default_days: 365
  by_purpose:
    analytics: 180
    ads_personalization: 180
  on_policy_update:
    require_reconsent_for_changed_purposes: true
    grace_days: 30

# Контроль качества конфигурации
validation:
  require_all_purposes_localized: true
  require_processors_dpa_signed: true
  deny_unknown_purpose_ids: true
  deny_unknown_processors: true

# Карта фичей приложения к целям (для автоматического enforcement)
feature_map:
  features:
    - id: "feature.analytics_dashboard"
      require_purposes: [analytics]
    - id: "feature.newsletter_signup"
      require_purposes: [email_comm]
    - id: "feature.ads_feed"
      require_purposes: [ads_personalization]
    - id: "feature.core_login"
      require_purposes: [essential_services]

# Примеры дефолтных пользовательских предпочтений (по регионам)
defaults:
  global:
    essential_services: true
    security_fraud: true
    analytics: false
    email_comm: false
    ads_personalization: false
  by_region:
    EEA:
      analytics: false
      ads_personalization: false
    US:
      analytics: true       # доизменяется CMP/US Privacy при opt-out
      ads_personalization: false
    BR:
      analytics: false
      ads_personalization: false

# Тестовые сценарии для автоматической валидации конфигурации (smoke)
self_tests:
  - name: "EEA prior consent for analytics enforced"
    region: "EEA"
    route: "/analytics/collect"
    purpose: "analytics"
    expect_block_if_no_consent: true
  - name: "Core login allowed without consent"
    region: "EEA"
    route: "/auth/login"
    purpose: "essential_services"
    expect_block_if_no_consent: false
  - name: "US GPC respected for ads"
    region: "US"
    route: "/ads/serve"
    purpose: "ads_personalization"
    gpc_signal: true
    expect_block_if_no_consent: true
