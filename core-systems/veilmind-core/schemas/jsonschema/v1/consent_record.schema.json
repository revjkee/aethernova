{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.dev/veilmind-core/schemas/jsonschema/v1/consent_record.schema.json",
  "title": "VeilMind Consent Record",
  "description": "Industrial-grade consent record schema for privacy compliance, audit and enforcement.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "version",
    "created_at",
    "updated_at",
    "status",
    "data_subject",
    "parties",
    "purposes",
    "scope",
    "legal_basis",
    "evidence",
    "mechanism"
  ],
  "properties": {
    "id": { "allOf": [ { "$ref": "#/$defs/uuid" } ], "description": "Unique consent record ID." },
    "version": { "$ref": "#/$defs/semver", "description": "Semantic version of the consent record format/document." },
    "created_at": { "$ref": "#/$defs/timestamp", "readOnly": true },
    "updated_at": { "$ref": "#/$defs/timestamp", "readOnly": true },
    "status": {
      "type": "string",
      "enum": ["active", "withdrawn", "expired", "refused", "pending", "superseded"],
      "description": "Current lifecycle state of the consent."
    },
    "effective_at": { "$ref": "#/$defs/timestamp" },
    "expires_at": { "$ref": "#/$defs/timestamp" },
    "retention_policy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "retention_period": { "$ref": "#/$defs/duration", "description": "How long data may be kept." },
        "delete_after_expiry": { "type": "boolean", "default": true },
        "policy_ref": { "$ref": "#/$defs/uri", "description": "URI to retention policy document." }
      }
    },

    "jurisdictions": {
      "type": "array",
      "description": "Applicable jurisdictions (ISO 3166-1 alpha-2).",
      "items": { "$ref": "#/$defs/country_code" },
      "minItems": 1,
      "uniqueItems": true
    },
    "languages": {
      "type": "array",
      "description": "Languages of disclosure/consent UI (BCP-47).",
      "items": { "$ref": "#/$defs/language_tag" },
      "minItems": 1,
      "uniqueItems": true
    },

    "mechanism": {
      "type": "string",
      "enum": ["opt_in", "opt_out", "soft_opt_in", "implied", "granular", "contractual"],
      "description": "Mechanism by which consent (or lawful basis notice) was captured."
    },

    "legal_basis": {
      "type": "string",
      "enum": [
        "consent",
        "contract",
        "legal_obligation",
        "vital_interests",
        "public_task",
        "legitimate_interests"
      ],
      "description": "Primary lawful basis (GDPR-like taxonomy)."
    },

    "data_subject": {
      "$ref": "#/$defs/data_subject"
    },

    "parties": {
      "type": "object",
      "additionalProperties": false,
      "required": ["controllers"],
      "properties": {
        "controllers": {
          "type": "array",
          "items": { "$ref": "#/$defs/party" },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Data controller(s) or joint controllers."
        },
        "processors": {
          "type": "array",
          "items": { "$ref": "#/$defs/party" },
          "uniqueItems": true
        },
        "subprocessors": {
          "type": "array",
          "items": { "$ref": "#/$defs/party" },
          "uniqueItems": true
        }
      }
    },

    "scope": {
      "$ref": "#/$defs/scope"
    },

    "purposes": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/purpose" },
      "description": "Granular purposes consented to (or refused)."
    },

    "evidence": {
      "$ref": "#/$defs/evidence"
    },

    "revocation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "revoked_at": { "$ref": "#/$defs/timestamp" },
        "method": { "type": "string", "enum": ["ui", "api", "email", "verbal", "paper"] },
        "reason": { "type": "string", "maxLength": 2048 }
      }
    },

    "refusal": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "refused_at": { "$ref": "#/$defs/timestamp" },
        "reason": { "type": "string", "maxLength": 2048 }
      }
    },

    "policy_references": {
      "type": "array",
      "items": { "$ref": "#/$defs/uri" },
      "uniqueItems": true
    },

    "history": {
      "type": "array",
      "description": "Immutable history of changes to this record.",
      "items": { "$ref": "#/$defs/history_event" }
    },

    "extensions": {
      "type": "object",
      "description": "Vendor- or product-specific extension fields.",
      "additionalProperties": { "$ref": "#/$defs/json_value" }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "status": { "const": "withdrawn" } }, "required": ["status"] },
      "then": { "required": ["revocation"] }
    },
    {
      "if": { "properties": { "status": { "const": "refused" } }, "required": ["status"] },
      "then": { "required": ["refusal"] }
    },
    {
      "if": {
        "properties": {
          "data_subject": {
            "type": "object",
            "properties": { "age": { "type": "integer", "maximum": 15 } },
            "required": ["age"]
          }
        },
        "required": ["data_subject"]
      },
      "then": {
        "properties": {
          "data_subject": {
            "required": ["guardian"]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "scope": {
            "properties": {
              "data_categories": {
                "type": "array",
                "contains": { "enum": ["health", "biometric", "genetic", "ethnic_origin", "religious_beliefs", "political_opinions", "trade_union", "sexual_orientation"] }
              }
            },
            "required": ["data_categories"]
          }
        },
        "required": ["scope"]
      },
      "then": {
        "properties": {
          "scope": { "properties": { "explicit": { "const": true } } },
          "legal_basis": { "const": "consent" }
        },
        "required": ["scope", "legal_basis"]
      }
    }
  ],

  "examples": [
    {
      "id": "8c9e8f2a-44b6-4d7c-9f8e-7a0b3e2f3c10",
      "version": "1.0.0",
      "created_at": "2025-08-21T09:30:00Z",
      "updated_at": "2025-08-21T09:30:00Z",
      "status": "active",
      "effective_at": "2025-08-21T09:30:00Z",
      "expires_at": "2027-08-21T09:30:00Z",
      "jurisdictions": ["SE", "EU"],
      "languages": ["en", "sv-SE"],
      "mechanism": "granular",
      "legal_basis": "consent",
      "data_subject": {
        "id": "b0d8d5f8-3f3c-4f8e-9a4c-0a9a6e2d0a11",
        "tenant_id": "acme-eu",
        "roles": ["customer"],
        "email": "user@example.com",
        "age": 28,
        "attributes": { "loyalty_tier": "gold" }
      },
      "parties": {
        "controllers": [
          { "name": "Acme AB", "role": "controller", "country": "SE", "contact_email": "privacy@acme.example", "dpo_email": "dpo@acme.example" }
        ],
        "processors": [
          { "name": "Aethernova Cloud", "role": "processor", "country": "SE" }
        ]
      },
      "scope": {
        "data_categories": ["identifiers", "contact", "behavioral", "cookies"],
        "processing_activities": ["personalization", "analytics"],
        "storage_locations": ["SE", "DE"],
        "explicit": false
      },
      "purposes": [
        { "id": "analytics", "name": "Analytics", "description": "Measure usage", "required": false, "granted": true, "granularity": "category", "effective_at": "2025-08-21T09:30:00Z" },
        { "id": "ads", "name": "Advertising", "required": false, "granted": false, "granularity": "category" }
      ],
      "evidence": {
        "recorded_at": "2025-08-21T09:30:00Z",
        "source": "web_form",
        "ip": "203.0.113.34",
        "user_agent": "Mozilla/5.0",
        "ui_version": "3.2.1",
        "ui_screenshot_sha256": "5f70bf18a08660b1a5d8e6a5e3f3a4a10f0f2b58a6c4c1c4e0d7e7d6b3b2a1c0",
        "disclosure_ref": "https://acme.example/privacy/2025-07",
        "record_hash_sha256": "b7f783baed8297f0db917462184ff4f08e69c2d5e5f6f8f5f3f5e7b3a3b2c1d0",
        "jws": "eyJhbGciOiJIUzI1NiJ9.eyJpZCI6IjhjOWU4ZjJhLTQ0YjYtNGQ3Yy05ZjhlLTdhMGIzZTJmM2MxMCJ9.dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
      }
    }
  ],

  "$defs": {
    "json_value": {
      "description": "Arbitrary JSON value.",
      "anyOf": [
        { "type": "null" },
        { "type": "boolean" },
        { "type": "number" },
        { "type": "string" },
        { "type": "array", "items": { "$ref": "#/$defs/json_value" } },
        { "type": "object", "additionalProperties": { "$ref": "#/$defs/json_value" } }
      ]
    },
    "uuid": { "type": "string", "format": "uuid" },
    "timestamp": { "type": "string", "format": "date-time" },
    "duration": { "type": "string", "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$", "description": "ISO 8601 duration" },
    "email": { "type": "string", "format": "email", "maxLength": 320 },
    "uri": { "type": "string", "format": "uri" },
    "country_code": { "type": "string", "pattern": "^[A-Z]{2}$" },
    "language_tag": {
      "type": "string",
      "pattern": "^[A-Za-z]{2,3}(?:-[A-Za-z0-9]{2,8})*$",
      "description": "BCP-47 language tag (simplified pattern)"
    },
    "semver": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(?:-[0-9A-Za-z.-]+)?(?:\\+[0-9A-Za-z.-]+)?$"
    },

    "party": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "role"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 256 },
        "role": { "type": "string", "enum": ["controller", "joint_controller", "processor", "subprocessor"] },
        "id": { "type": "string", "maxLength": 128 },
        "country": { "$ref": "#/$defs/country_code" },
        "contact_email": { "$ref": "#/$defs/email" },
        "contact_url": { "$ref": "#/$defs/uri" },
        "dpo_email": { "$ref": "#/$defs/email" },
        "dpo_url": { "$ref": "#/$defs/uri" },
        "address": { "type": "string", "maxLength": 1024 },
        "labels": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 128 } }
      }
    },

    "data_subject": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "$ref": "#/$defs/uuid" },
        "tenant_id": { "type": "string", "maxLength": 128 },
        "email": { "$ref": "#/$defs/email" },
        "phone": { "type": "string", "maxLength": 64 },
        "age": { "type": "integer", "minimum": 0, "maximum": 150 },
        "country": { "$ref": "#/$defs/country_code" },
        "language": { "$ref": "#/$defs/language_tag" },
        "roles": { "type": "array", "items": { "type": "string", "maxLength": 64 }, "uniqueItems": true },
        "attributes": { "type": "object", "additionalProperties": { "$ref": "#/$defs/json_value" } },
        "guardian": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name"],
          "properties": {
            "name": { "type": "string", "maxLength": 256 },
            "relation": { "type": "string", "maxLength": 128 },
            "email": { "$ref": "#/$defs/email" }
          }
        }
      }
    },

    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["data_categories", "processing_activities"],
      "properties": {
        "data_categories": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": {
            "type": "string",
            "enum": [
              "identifiers",
              "contact",
              "financial",
              "location",
              "behavioral",
              "health",
              "biometric",
              "genetic",
              "ethnic_origin",
              "religious_beliefs",
              "political_opinions",
              "trade_union",
              "sexual_orientation",
              "cookies",
              "device_ids"
            ]
          }
        },
        "processing_activities": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "maxLength": 128
          },
          "uniqueItems": true
        },
        "storage_locations": {
          "type": "array",
          "items": { "$ref": "#/$defs/country_code" },
          "uniqueItems": true
        },
        "explicit": {
          "type": "boolean",
          "default": false,
          "description": "Explicit consent required for special categories."
        }
      }
    },

    "purpose": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "granted"],
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 128 },
        "name": { "type": "string", "minLength": 1, "maxLength": 256 },
        "description": { "type": "string", "maxLength": 2048 },
        "required": { "type": "boolean", "default": false },
        "granted": { "type": "boolean", "description": "Whether consent was granted for this purpose." },
        "granularity": { "type": "string", "enum": ["category", "processing", "vendor", "feature"] },
        "effective_at": { "$ref": "#/$defs/timestamp" },
        "expires_at": { "$ref": "#/$defs/timestamp" },
        "withdrawn_at": { "$ref": "#/$defs/timestamp" },
        "legal_references": { "type": "array", "items": { "$ref": "#/$defs/uri" }, "uniqueItems": true },
        "labels": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 128 } }
      }
    },

    "evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["recorded_at", "source"],
      "properties": {
        "recorded_at": { "$ref": "#/$defs/timestamp" },
        "source": { "type": "string", "enum": ["web_form", "sdk", "api", "paper", "voice", "import"] },
        "operator": { "type": "string", "maxLength": 128, "description": "Human/operator identifier if applicable." },
        "ip": {
          "type": "string",
          "oneOf": [
            { "format": "ipv4" },
            { "format": "ipv6" }
          ]
        },
        "user_agent": { "type": "string", "maxLength": 1024 },
        "ui_version": { "$ref": "#/$defs/semver" },
        "ui_screenshot_sha256": { "$ref": "#/$defs/sha256" },
        "disclosure_ref": { "$ref": "#/$defs/uri", "description": "Public disclosure/policy text URI." },
        "record_hash_sha256": { "$ref": "#/$defs/sha256", "description": "Hash of canonicalized consent payload." },
        "jws": { "$ref": "#/$defs/jws" },
        "attachments": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "uri"],
            "properties": {
              "type": { "type": "string", "maxLength": 64 },
              "uri": { "$ref": "#/$defs/uri" },
              "sha256": { "$ref": "#/$defs/sha256" }
            }
          },
          "uniqueItems": true
        }
      }
    },

    "history_event": {
      "type": "object",
      "additionalProperties": false,
      "required": ["at", "action"],
      "properties": {
        "at": { "$ref": "#/$defs/timestamp" },
        "actor": { "type": "string", "maxLength": 128 },
        "action": { "type": "string", "enum": ["create", "update", "withdraw", "expire", "refuse", "supersede"] },
        "changes": { "type": "object", "additionalProperties": { "$ref": "#/$defs/json_value" } }
      }
    },

    "sha256": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Lowercase hex-encoded SHA-256 hash."
    },
    "jws": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+$",
      "description": "Detached or compact JWS (base64url segments)."
    }
  }
}
