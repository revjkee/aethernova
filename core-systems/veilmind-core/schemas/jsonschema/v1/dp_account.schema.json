{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.veilmind.example.com/jsonschema/v1/dp_account.schema.json",
  "title": "VeilMind DP Account",
  "description": "Схема учетной записи субъекта данных (Data Protection Account) для систем согласий, DSAR и Zero Trust.",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "required": ["account_id", "status", "created_at", "updated_at"],
  "properties": {
    "schema_version": {
      "description": "Версия схемы данных учетной записи.",
      "type": "string",
      "pattern": "^v\\d+\\.\\d+\\.\\d+$",
      "default": "v1.0.0"
    },
    "account_id": {
      "description": "Глобальный идентификатор учетной записи (ULID или UUIDv4).",
      "oneOf": [
        { "$ref": "#/$defs/ULID" },
        { "$ref": "#/$defs/UUIDv4" }
      ]
    },
    "tenant_id": {
      "description": "Идентификатор арендатора/организации (если применяется мультиарендность).",
      "oneOf": [
        { "$ref": "#/$defs/ULID" },
        { "$ref": "#/$defs/UUIDv4" }
      ]
    },
    "status": {
      "description": "Статус учетной записи.",
      "type": "string",
      "enum": ["active", "pending_verification", "disabled", "banned", "deleted"]
    },
    "created_at": { "$ref": "#/$defs/RFC3339DateTime" },
    "updated_at": { "$ref": "#/$defs/RFC3339DateTime" },
    "soft_deleted_at": {
      "description": "Мягкое удаление (если задано).",
      "oneOf": [{ "$ref": "#/$defs/RFC3339DateTime" }, { "type": "null" }]
    },

    "profile": {
      "description": "Публичный профиль (PII минимизирована).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "first_name": { "$ref": "#/$defs/NonEmptyString" },
        "last_name": { "$ref": "#/$defs/NonEmptyString" },
        "locale": { "$ref": "#/$defs/Locale" },
        "timezone": { "$ref": "#/$defs/Timezone" },
        "country": { "$ref": "#/$defs/CountryCode" },
        "birthdate": { "$ref": "#/$defs/ISODate" }
      }
    },

    "contacts": {
      "description": "Контактные данные (в виде оригинала или безопасного хэша).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "email": { "$ref": "#/$defs/Email" },
        "email_sha256": { "$ref": "#/$defs/SHA256Hex" },
        "phone_e164": { "$ref": "#/$defs/PhoneE164" },
        "phone_sha256": { "$ref": "#/$defs/SHA256Hex" }
      },
      "anyOf": [
        { "required": ["email"] },
        { "required": ["email_sha256"] },
        { "required": ["phone_e164"] },
        { "required": ["phone_sha256"] }
      ]
    },

    "identities": {
      "description": "Связанные внешние/федеративные идентичности.",
      "type": "array",
      "maxItems": 50,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["provider", "subject"],
        "properties": {
          "provider": {
            "type": "string",
            "enum": ["password", "oidc", "saml", "github", "google", "apple", "microsoft", "custom"]
          },
          "subject": { "$ref": "#/$defs/NonEmptyString" },
          "last_login_at": { "$ref": "#/$defs/RFC3339DateTime" },
          "attributes": { "$ref": "#/$defs/StringMap" }
        }
      }
    },

    "security": {
      "description": "Параметры безопасности (без хранения секретов/хэшей паролей).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mfa_enabled": { "type": "boolean", "default": false },
        "mfa_methods": {
          "type": "array",
          "items": { "type": "string", "enum": ["totp", "webauthn", "sms", "email", "push"] },
          "uniqueItems": true,
          "maxItems": 5
        },
        "password_last_changed_at": { "$ref": "#/$defs/RFC3339DateTime" },
        "recovery_methods_set": { "type": "boolean", "default": false },
        "risk_last_score": { "$ref": "#/$defs/Score0to100" },
        "risk_last_decision": { "$ref": "#/$defs/DecisionEnum" },
        "risk_last_evaluated_at": { "$ref": "#/$defs/RFC3339DateTime" }
      }
    },

    "consents": {
      "description": "Согласия по целям обработки (ключ — идентификатор цели, совпадает с конфигом consent.yaml).",
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "required": ["granted", "version", "ts"],
        "properties": {
          "granted": { "type": "boolean" },
          "version": { "type": "string", "minLength": 1 },
          "region": { "$ref": "#/$defs/RegionCode" },
          "ts": { "$ref": "#/$defs/RFC3339DateTime" },
          "source": { "type": "string", "enum": ["web", "mobile", "api", "import"] },
          "proof_jws": { "type": "string", "minLength": 16 },
          "metadata": { "$ref": "#/$defs/StringMap" }
        }
      }
    },

    "dsar": {
      "description": "История запросов субъекта данных (DSAR).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "requests": {
          "type": "array",
          "maxItems": 500,
          "items": { "$ref": "#/$defs/DSARRequest" }
        }
      }
    },

    "retention": {
      "description": "Политика хранения данных конкретной учетной записи.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "policy_id": { "$ref": "#/$defs/NonEmptyString" },
        "ttl_days": { "type": "integer", "minimum": 1, "maximum": 3650 },
        "delete_at": { "$ref": "#/$defs/RFC3339DateTime" },
        "legal_hold": { "type": "boolean", "default": false }
      }
    },

    "regional": {
      "description": "Региональные атрибуты для применимости норм.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "region": { "$ref": "#/$defs/RegionCode" },
        "locale": { "$ref": "#/$defs/Locale" },
        "gpc_last_seen": { "type": "boolean", "default": false }
      }
    },

    "audit": {
      "description": "Аудитные метки (без PII).",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "created_by": { "$ref": "#/$defs/NonEmptyString" },
        "updated_by": { "$ref": "#/$defs/NonEmptyString" },
        "tags": {
          "type": "array",
          "items": { "$ref": "#/$defs/Tag" },
          "uniqueItems": true,
          "maxItems": 50
        }
      }
    },

    "metadata": {
      "description": "Расширяемые атрибуты без PII для внутренних нужд.",
      "type": "object",
      "additionalProperties": { "type": "string", "maxLength": 2048 }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "status": { "const": "deleted" } } },
      "then": { "required": ["soft_deleted_at"] }
    }
  ],

  "$defs": {
    "NonEmptyString": { "type": "string", "minLength": 1, "maxLength": 1024 },
    "Tag": { "type": "string", "pattern": "^[a-z0-9_.:-]{1,64}$" },

    "RFC3339DateTime": {
      "description": "Отметка времени в формате RFC3339 (UTC или с оффсетом).",
      "type": "string",
      "format": "date-time",
      "examples": ["2025-08-21T12:00:00Z"]
    },
    "ISODate": {
      "description": "Календарная дата YYYY-MM-DD.",
      "type": "string",
      "format": "date"
    },
    "Locale": {
      "description": "Локаль BCP47 (упрощенная проверка).",
      "type": "string",
      "pattern": "^[a-z]{2}(-[A-Z]{2})?$",
      "examples": ["en", "ru-RU", "sv-SE"]
    },
    "Timezone": {
      "description": "Часовой пояс IANA.",
      "type": "string",
      "pattern": "^[A-Za-z_]+\\/[A-Za-z_]+(?:\\/[A-Za-z_]+)?$",
      "examples": ["UTC", "Europe/Stockholm"]
    },
    "CountryCode": {
      "description": "Код страны ISO 3166-1 alpha-2.",
      "type": "string",
      "pattern": "^[A-Z]{2}$",
      "examples": ["SE", "GB", "US", "DE"]
    },
    "RegionCode": {
      "description": "Код региона для политик (EEA, UK, US, BR и др.).",
      "type": "string",
      "pattern": "^[A-Z]{2,3}$",
      "examples": ["EEA", "UK", "US", "BR"]
    },
    "Email": {
      "description": "Адрес электронной почты.",
      "type": "string",
      "format": "email",
      "maxLength": 320
    },
    "PhoneE164": {
      "description": "Телефон в формате E.164.",
      "type": "string",
      "pattern": "^\\+[1-9]\\d{1,14}$",
      "examples": ["+46701234567"]
    },
    "SHA256Hex": {
      "description": "Шестнадцатеричное представление SHA-256 (64 символа).",
      "type": "string",
      "pattern": "^[A-Fa-f0-9]{64}$"
    },
    "UUIDv4": {
      "description": "Строка UUID (регистр не важен).",
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "ULID": {
      "description": "ULID в алфавите Crockford (26 символов, верхний регистр).",
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
    },
    "Score0to100": {
      "description": "Числовая оценка 0..100.",
      "type": "number",
      "minimum": 0,
      "maximum": 100
    },
    "DecisionEnum": {
      "description": "Решение Zero Trust.",
      "type": "string",
      "enum": ["ALLOW", "MFA", "LIMITED", "DENY", "QUARANTINE"]
    },
    "StringMap": {
      "description": "Строковая карта без PII.",
      "type": "object",
      "additionalProperties": { "type": "string", "maxLength": 2048 }
    },

    "DSARRequest": {
      "description": "Запрос субъекта данных.",
      "type": "object",
      "additionalProperties": false,
      "required": ["request_id", "type", "status", "requested_at"],
      "properties": {
        "request_id": { "$ref": "#/$defs/NonEmptyString" },
        "type": {
          "type": "string",
          "enum": ["access", "delete", "portability", "rectification", "restriction", "objection"]
        },
        "status": {
          "type": "string",
          "enum": ["received", "in_progress", "completed", "rejected", "expired"]
        },
        "requested_at": { "$ref": "#/$defs/RFC3339DateTime" },
        "due_at": { "$ref": "#/$defs/RFC3339DateTime" },
        "closed_at": { "$ref": "#/$defs/RFC3339DateTime" },
        "actor_reference": {
          "description": "Ссылка на актера/учетку инициатора запроса.",
          "oneOf": [{ "$ref": "#/$defs/ULID" }, { "$ref": "#/$defs/UUIDv4" }]
        },
        "notes": { "$ref": "#/$defs/NonEmptyString" }
      }
    }
  },

  "examples": [
    {
      "schema_version": "v1.0.0",
      "account_id": "01J2ZK5R3TS6Q4H2P8XWY9ABCD",
      "tenant_id": "4a5d27f2-7a1c-4d1a-9f3f-3a2bc6d1c9a7",
      "status": "active",
      "created_at": "2025-08-21T10:00:00Z",
      "updated_at": "2025-08-21T10:05:00Z",
      "profile": {
        "first_name": "Alex",
        "last_name": "K.",
        "locale": "sv-SE",
        "timezone": "Europe/Stockholm",
        "country": "SE"
      },
      "contacts": {
        "email": "user@example.com",
        "phone_e164": "+46701234567"
      },
      "identities": [
        {
          "provider": "oidc",
          "subject": "d3c5b8...",
          "last_login_at": "2025-08-21T10:04:00Z",
          "attributes": { "idp": "keycloak" }
        }
      ],
      "security": {
        "mfa_enabled": true,
        "mfa_methods": ["webauthn", "totp"],
        "password_last_changed_at": "2025-07-01T12:00:00Z",
        "recovery_methods_set": true,
        "risk_last_score": 18.5,
        "risk_last_decision": "ALLOW",
        "risk_last_evaluated_at": "2025-08-21T10:04:30Z"
      },
      "consents": {
        "analytics": {
          "granted": true,
          "version": "2025-08-21-1",
          "region": "EEA",
          "ts": "2025-08-21T10:01:00Z",
          "source": "web",
          "proof_jws": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
      },
      "dsar": {
        "requests": [
          {
            "request_id": "req-01J2ZK6X...",
            "type": "access",
            "status": "completed",
            "requested_at": "2025-06-01T08:00:00Z",
            "closed_at": "2025-06-10T10:00:00Z"
          }
        ]
      },
      "retention": {
        "policy_id": "consent-policy-2025-08-21-1",
        "ttl_days": 365,
        "delete_at": "2026-08-21T00:00:00Z",
        "legal_hold": false
      },
      "regional": {
        "region": "EEA",
        "locale": "sv-SE",
        "gpc_last_seen": false
      },
      "audit": {
        "created_by": "system",
        "updated_by": "system",
        "tags": ["zero_trust", "consent_ok"]
      },
      "metadata": {
        "segment": "beta",
        "plan": "pro"
      }
    }
  ]
}
