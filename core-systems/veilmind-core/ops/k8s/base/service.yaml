# veilmind-core/ops/k8s/base/service.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: veilmind-core
  labels:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: veilmind
    app.kubernetes.io/version: "0.1.0"
    security.aethernova/zero-trust: "true"
  annotations:
    # Если используется классический Prometheus без ServiceMonitor — метрики собираются отдельным сервисом ниже.
    # Здесь аннотаций scrape нет, чтобы не мешать политике сетевого разделения.
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  selector:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: api
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  publishNotReadyAddresses: false
  ports:
    - name: http
      port: 8080            # Внутрикластерный порт сервиса
      targetPort: 8080      # Контейнерный порт приложения (APP_HTTP_PORT)
      protocol: TCP
      appProtocol: http
---
apiVersion: v1
kind: Service
metadata:
  name: veilmind-core-metrics
  labels:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: veilmind
    app.kubernetes.io/version: "0.1.0"
  annotations:
    # Поддержка классического Prometheus:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  selector:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: api
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  ports:
    - name: http-metrics
      port: 9090            # Внутрикластерный порт для экспорта метрик
      targetPort: 9090      # Контейнерный порт метрик (PROMETHEUS_PORT)
      protocol: TCP
      appProtocol: http
---
apiVersion: v1
kind: Service
metadata:
  name: veilmind-core-headless
  labels:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: discovery
    app.kubernetes.io/part-of: veilmind
    app.kubernetes.io/version: "0.1.0"
spec:
  clusterIP: None            # Headless для stateful/mesh и прямого под‑дискавери
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  selector:
    app.kubernetes.io/name: veilmind-core
    app.kubernetes.io/instance: veilmind-core
    app.kubernetes.io/component: api
  publishNotReadyAddresses: false
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
      appProtocol: http
    - name: http-metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
      appProtocol: http
