{
  "$id": "https://schemas.ledger-core.example.com/jsonschema/v1/policy.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Ledger Core Access Policy",
  "description": "Формальная модель политики доступа для ledger-core. Версия контракта: v1.",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "required": ["kind", "apiVersion", "metadata", "spec"],
  "properties": {
    "kind": {
      "const": "Policy",
      "description": "Тип ресурса."
    },
    "apiVersion": {
      "type": "string",
      "description": "Версия API ресурса (семантическая).",
      "pattern": "^v1(\\.[0-9]+){0,2}$"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "version", "createdAt"],
      "properties": {
        "id": {
          "description": "Уникальный ID политики (UUIDv4).",
          "type": "string",
          "format": "uuid"
        },
        "tenantId": {
          "description": "Идентификатор арендатора (UUID или короткий slug).",
          "type": "string",
          "oneOf": [
            { "format": "uuid" },
            { "pattern": "^[a-z0-9][a-z0-9-]{1,62}[a-z0-9]$" }
          ]
        },
        "name": {
          "description": "Человекочитаемое имя.",
          "type": "string",
          "minLength": 3,
          "maxLength": 200
        },
        "description": {
          "description": "Описание политики.",
          "type": "string",
          "maxLength": 2000
        },
        "labels": {
          "description": "Немодифицирующие метки.",
          "type": "object",
          "propertyNames": { "pattern": "^[a-z0-9_.-]{1,63}$" },
          "additionalProperties": {
            "type": "string",
            "maxLength": 256
          }
        },
        "version": {
          "description": "Версия политики (semver).",
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:[-+][0-9A-Za-z.-]+)?$"
        },
        "priority": {
          "description": "Приоритет применения (меньше — важнее).",
          "type": "integer",
          "minimum": 0,
          "maximum": 100000
        },
        "enabled": {
          "description": "Флаг включения политики.",
          "type": "boolean",
          "default": true
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "spec": {
      "type": "object",
      "additionalProperties": false,
      "required": ["statements"],
      "properties": {
        "scope": {
          "description": "Область применения политики.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "projects": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 200 },
              "uniqueItems": true
            },
            "environments": {
              "type": "array",
              "items": { "enum": ["dev", "staging", "prod"] },
              "uniqueItems": true
            }
          }
        },
        "defaults": {
          "description": "Значения по умолчанию для утверждений.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "effect": { "$ref": "#/$defs/Effect" },
            "audit": { "$ref": "#/$defs/Audit" }
          }
        },
        "statements": {
          "description": "Список утверждений доступа.",
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Statement" }
        }
      }
    }
  },

  "$defs": {
    "Effect": {
      "type": "string",
      "enum": ["Allow", "Deny"],
      "description": "Результирующее действие утверждения."
    },

    "Audit": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "log": { "type": "boolean", "default": true },
        "reason": { "type": "string", "maxLength": 512 },
        "fields": {
          "description": "Доп. поля аудита (без секретов).",
          "type": "object",
          "propertyNames": { "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{0,63}$" },
          "additionalProperties": { "type": "string", "maxLength": 256 }
        }
      }
    },

    "Action": {
      "type": "string",
      "description": "Действие в форме namespace:verb[.subverb], допускаются маски.",
      "pattern": "^[a-z][a-z0-9-]{1,63}:[a-z][a-z0-9_.-]{0,127}(\\*)?$",
      "examples": [
        "ledger:tx.create",
        "ledger:tx.update",
        "ledger:report.generate",
        "ledger:*"
      ]
    },

    "Resource": {
      "type": "string",
      "description": "Ресурс в ARN‑подобной форме или URI с масками.",
      "pattern": "^(arn:[a-z-]{2,}:[a-z0-9-]{1,}:.*|[a-z][a-z0-9+.-]*://.*|[a-z][a-z0-9-]{1,}/[A-Za-z0-9._/*-]+|\\*)$",
      "examples": [
        "arn:ledger:core:eu-central-1:tenant/123:account/456",
        "ledger/accounts/*",
        "*"
      ]
    },

    "Principal": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "users": {
          "type": "array",
          "items": { "type": "string", "oneOf": [{ "format": "uuid" }, { "pattern": "^[a-z0-9._-]{3,128}$" }] },
          "uniqueItems": true
        },
        "roles": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Z0-9_]{2,64}$" },
          "uniqueItems": true
        },
        "serviceAccounts": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z0-9._-]{3,128}$" },
          "uniqueItems": true
        },
        "attributes": {
          "description": "ABAC‑атрибуты субъекта (строки/числа/булевы).",
          "type": "object",
          "propertyNames": { "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{0,63}$" },
          "additionalProperties": {
            "oneOf": [
              { "type": "string", "maxLength": 256 },
              { "type": "number" },
              { "type": "boolean" }
            ]
          }
        }
      }
    },

    "Statement": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sid", "effect", "actions", "resources"],
      "properties": {
        "sid": {
          "description": "Идентификатор утверждения (уникален в пределах политики).",
          "type": "string",
          "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$"
        },
        "description": { "type": "string", "maxLength": 1000 },
        "effect": { "$ref": "#/$defs/Effect" },
        "actions": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Action" },
          "uniqueItems": true
        },
        "notActions": {
          "description": "Исключающие действия (имеют приоритет над actions).",
          "type": "array",
          "items": { "$ref": "#/$defs/Action" },
          "uniqueItems": true
        },
        "resources": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Resource" },
          "uniqueItems": true
        },
        "notResources": {
          "description": "Исключающие ресурсы (имеют приоритет над resources).",
          "type": "array",
          "items": { "$ref": "#/$defs/Resource" },
          "uniqueItems": true
        },
        "principals": {
          "description": "Субъекты, к которым применимо утверждение. Пусто = любой.",
          "type": "array",
          "items": { "$ref": "#/$defs/Principal" }
        },
        "conditions": {
          "description": "Набор условий (все должны выполняться, если массив).",
          "type": "array",
          "minItems": 0,
          "items": { "$ref": "#/$defs/Condition" }
        },
        "audit": { "$ref": "#/$defs/Audit" }
      }
    },

    "CIDR": {
      "type": "string",
      "pattern": "^((25[0-5]|2[0-4]\\d|[01]?\\d?\\d)(\\.(?!$)|$)){4}/([0-9]|[12]\\d|3[0-2])$",
      "examples": ["10.0.0.0/8", "192.168.1.0/24"]
    },

    "ISO8601Duration": {
      "type": "string",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$",
      "examples": ["PT1M", "PT15M", "P1D"]
    },

    "TimeWindow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tz", "start", "end"],
      "properties": {
        "tz": { "type": "string", "pattern": "^[A-Za-z_]+/[A-Za-z_]+$" },
        "start": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
        "end": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
        "days": {
          "type": "array",
          "items": { "enum": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"] },
          "uniqueItems": true
        }
      }
    },

    "NumericComparator": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "eq": { "type": "number" },
        "ne": { "type": "number" },
        "gt": { "type": "number" },
        "gte": { "type": "number" },
        "lt": { "type": "number" },
        "lte": { "type": "number" }
      },
      "minProperties": 1,
      "maxProperties": 1
    },

    "StringComparator": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "equals": { "type": "string", "maxLength": 256 },
        "notEquals": { "type": "string", "maxLength": 256 },
        "like": { "type": "string", "maxLength": 256, "description": "Подстановки * и ? поддерживаются рантаймом." },
        "in": {
          "type": "array",
          "items": { "type": "string", "maxLength": 256 },
          "uniqueItems": true,
          "minItems": 1
        },
        "notIn": {
          "type": "array",
          "items": { "type": "string", "maxLength": 256 },
          "uniqueItems": true,
          "minItems": 1
        }
      },
      "minProperties": 1,
      "maxProperties": 1
    },

    "BooleanComparator": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "is": { "type": "boolean" }
      },
      "required": ["is"]
    },

    "RateLimit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["limit", "per"],
      "properties": {
        "limit": { "type": "integer", "minimum": 1, "maximum": 1000000 },
        "per": { "$ref": "#/$defs/ISO8601Duration" },
        "scope": { "type": "string", "enum": ["ip", "user", "token", "tenant"], "default": "user" },
        "burst": { "type": "integer", "minimum": 0, "maximum": 1000000 }
      }
    },

    "Quota": {
      "type": "object",
      "additionalProperties": false,
      "required": ["metric", "limit", "window"],
      "properties": {
        "metric": { "type": "string", "pattern": "^[a-z][a-z0-9_.-]{1,63}$", "examples": ["requests", "exports", "payments"] },
        "limit": { "type": "integer", "minimum": 1, "maximum": 1000000000 },
        "window": { "$ref": "#/$defs/ISO8601Duration" },
        "subject": { "type": "string", "enum": ["user", "tenant", "project"], "default": "tenant" }
      }
    },

    "Condition": {
      "type": "object",
      "additionalProperties": false,
      "description": "Условие применения утверждения. Все условия массива в Statement должны быть истинны.",
      "properties": {
        "anyOf": {
          "description": "Хоть одно из под‑условий истинно.",
          "type": "array",
          "items": { "$ref": "#/$defs/Condition" },
          "minItems": 1
        },
        "allOf": {
          "description": "Все под‑условия истинны.",
          "type": "array",
          "items": { "$ref": "#/$defs/Condition" },
          "minItems": 1
        },
        "not": {
          "description": "Инверсия под‑условия.",
          "oneOf": [{ "$ref": "#/$defs/Condition" }]
        },

        "time": {
          "description": "Ограничение по времени.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "between": { "$ref": "#/$defs/TimeWindow" },
            "before": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
            "after": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" }
          },
          "minProperties": 1
        },

        "ip": {
          "description": "Ограничение по IP/CIDR.",
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "inCIDR": {
              "type": "array",
              "items": { "$ref": "#/$defs/CIDR" },
              "minItems": 1,
              "uniqueItems": true
            }
          },
          "required": ["inCIDR"]
        },

        "mfa": {
          "description": "Требование MFA.",
          "type": "object",
          "additionalProperties": false,
          "properties": { "required": { "type": "boolean", "const": true } },
          "required": ["required"]
        },

        "risk": {
          "description": "Ограничение по риск‑оценке аутентификации.",
          "type": "object",
          "additionalProperties": false,
          "properties": { "scoreLt": { "type": "number", "minimum": 0, "maximum": 1 } },
          "required": ["scoreLt"]
        },

        "string": {
          "description": "Сравнение строкового атрибута контекста.",
          "type": "object",
          "additionalProperties": false,
          "required": ["attr", "op"],
          "properties": {
            "attr": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_.]{0,127}$" },
            "op": { "$ref": "#/$defs/StringComparator" }
          }
        },

        "number": {
          "description": "Сравнение числового атрибута контекста.",
          "type": "object",
          "additionalProperties": false,
          "required": ["attr", "op"],
          "properties": {
            "attr": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_.]{0,127}$" },
            "op": { "$ref": "#/$defs/NumericComparator" }
          }
        },

        "boolean": {
          "description": "Сравнение булева атрибута контекста.",
          "type": "object",
          "additionalProperties": false,
          "required": ["attr", "op"],
          "properties": {
            "attr": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_.]{0,127}$" },
            "op": { "$ref": "#/$defs/BooleanComparator" }
          }
        },

        "rateLimit": { "$ref": "#/$defs/RateLimit" },
        "quota": { "$ref": "#/$defs/Quota" }
      },
      "oneOf": [
        { "required": ["anyOf"] },
        { "required": ["allOf"] },
        { "required": ["not"] },
        { "required": ["time"] },
        { "required": ["ip"] },
        { "required": ["mfa"] },
        { "required": ["risk"] },
        { "required": ["string"] },
        { "required": ["number"] },
        { "required": ["boolean"] },
        { "required": ["rateLimit"] },
        { "required": ["quota"] }
      ]
    }
  },

  "examples": [
    {
      "kind": "Policy",
      "apiVersion": "v1",
      "metadata": {
        "id": "6e5e5c56-5f7d-4b8a-9f6d-d4b3a7b1b111",
        "tenantId": "a5f9f4f1-8b2c-4f6a-bf3b-2b8c0d0a1111",
        "name": "staging-api-readonly",
        "description": "Чтение отчетов и транзакций на стейджинге.",
        "version": "1.2.0",
        "priority": 100,
        "enabled": true,
        "createdAt": "2025-08-01T10:00:00Z",
        "updatedAt": "2025-08-01T10:00:00Z"
      },
      "spec": {
        "scope": { "environments": ["staging"] },
        "defaults": { "effect": "Allow", "audit": { "log": true } },
        "statements": [
          {
            "sid": "AllowReportsRead",
            "description": "Разрешаем чтение отчетов",
            "effect": "Allow",
            "actions": ["ledger:report.get", "ledger:report.list"],
            "resources": ["ledger/reports/*"],
            "principals": [
              { "roles": ["ANALYST"] }
            ],
            "conditions": [
              { "time": { "between": { "tz": "Europe/Stockholm", "start": "08:00", "end": "20:00", "days": ["Mon","Tue","Wed","Thu","Fri"] } } },
              { "ip": { "inCIDR": ["10.0.0.0/8", "192.168.0.0/16"] } },
              { "mfa": { "required": true } }
            ]
          },
          {
            "sid": "DenyWrites",
            "effect": "Deny",
            "actions": ["ledger:tx.create", "ledger:tx.update", "ledger:tx.delete", "ledger:*write*"],
            "resources": ["*"]
          },
          {
            "sid": "RateLimits",
            "effect": "Allow",
            "actions": ["ledger:report.generate"],
            "resources": ["ledger/reports/*"],
            "conditions": [
              { "rateLimit": { "limit": 30, "per": "PT1M", "scope": "user", "burst": 60 } },
              { "quota": { "metric": "exports", "limit": 500, "window": "P1D", "subject": "tenant" } }
            ]
          }
        ]
      }
    }
  ]
}
