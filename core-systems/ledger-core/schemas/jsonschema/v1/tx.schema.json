{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ledger.example.com/schemas/jsonschema/v1/tx.schema.json",
  "title": "Ledger Transaction (v1)",
  "description": "Схема записи транзакции леджера. Денежные суммы представлены строками в десятичном формате (без экспоненты) для избежания ошибок округления. Все временные метки — ISO-8601 в UTC.",
  "type": "object",
  "unevaluatedProperties": false,
  "$comment": "Версия схемы фиксируется полем schemaVersion. Для обратной совместимости новые поля добавляйте через metadata.*",
  "required": [
    "schemaVersion",
    "id",
    "type",
    "status",
    "occurredAt",
    "recordedAt",
    "currency",
    "amount",
    "amountNet",
    "payer",
    "payee"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "description": "Семантическая версия контракта данных.",
      "pattern": "^1\\.\\d+\\.\\d+$",
      "examples": ["1.0.0"]
    },
    "id": {
      "type": "string",
      "description": "Уникальный ID транзакции (UUIDv4).",
      "format": "uuid",
      "examples": ["6f1b7b9e-2de8-4d3b-8b6f-8a4a6c0d2e16"]
    },
    "externalId": {
      "type": "string",
      "description": "Внешний ID из платёжного провайдера/ERP.",
      "maxLength": 128
    },
    "type": {
      "type": "string",
      "description": "Тип операции.",
      "enum": ["charge", "refund", "transfer", "payout", "fee", "adjustment"],
      "examples": ["charge"]
    },
    "status": {
      "type": "string",
      "description": "Статус жизненного цикла транзакции.",
      "enum": ["pending", "authorized", "posted", "reversed", "failed", "cancelled"],
      "examples": ["posted"]
    },
    "occurredAt": {
      "type": "string",
      "description": "Время совершения операции (UTC).",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(?:\\.\\d{3})?Z$",
      "examples": ["2025-08-15T09:12:33.123Z"]
    },
    "recordedAt": {
      "type": "string",
      "description": "Время записи операции в леджер (UTC).",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(?:\\.\\d{3})?Z$"
    },
    "currency": {
      "type": "string",
      "description": "Базовая валюта операции (ISO-4217, три заглавные буквы).",
      "pattern": "^[A-Z]{3}$",
      "examples": ["EUR"]
    },
    "amount": {
      "$ref": "#/$defs/moneyString",
      "description": "Сумма брутто в базовой валюте."
    },
    "amountNet": {
      "$ref": "#/$defs/moneyString",
      "description": "Сумма нетто (после удержаний) в базовой валюте."
    },
    "fees": {
      "type": "array",
      "description": "Детализация удержаний (комиссии, налоги).",
      "items": { "$ref": "#/$defs/chargeComponent" },
      "maxItems": 50,
      "default": []
    },
    "taxes": {
      "type": "array",
      "description": "Налоги по позиции.",
      "items": { "$ref": "#/$defs/chargeComponent" },
      "maxItems": 50,
      "default": []
    },
    "exchange": {
      "type": "object",
      "description": "Информация о конверсии валют.",
      "required": ["baseCurrency", "quoteCurrency", "rate"],
      "properties": {
        "baseCurrency": { "type": "string", "pattern": "^[A-Z]{3}$" },
        "quoteCurrency": { "type": "string", "pattern": "^[A-Z]{3}$" },
        "rate": {
          "type": "string",
          "description": "Кросс‑курс как десятичная строка (например, '1.098765').",
          "pattern": "^[0-9]+(\\.[0-9]{1,12})?$"
        },
        "asOf": {
          "type": "string",
          "description": "Момент фиксации курса (UTC).",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(?:\\.\\d{3})?Z$"
        }
      },
      "unevaluatedProperties": false
    },
    "payer": { "$ref": "#/$defs/party" },
    "payee": { "$ref": "#/$defs/party" },
    "method": {
      "type": "string",
      "description": "Способ платежа.",
      "enum": ["card", "bank_transfer", "wallet", "cash", "crypto", "internal"],
      "examples": ["bank_transfer"]
    },
    "instrument": {
      "type": "object",
      "description": "Параметры платёжного инструмента.",
      "properties": {
        "card": {
          "type": "object",
          "properties": {
            "brand": { "type": "string", "enum": ["visa", "mastercard", "amex", "mir", "jcb", "discover", "unionpay"] },
            "panMasked": { "type": "string", "pattern": "^[0-9*]{12,19}$" },
            "expiry": { "type": "string", "pattern": "^(0[1-9]|1[0-2])/[0-9]{2}$" }
          },
          "unevaluatedProperties": false
        },
        "bank": {
          "type": "object",
          "properties": {
            "iban": { "type": "string", "pattern": "^[A-Z]{2}[0-9A-Z]{13,32}$" },
            "bic": { "type": "string", "pattern": "^[A-Z0-9]{8}([A-Z0-9]{3})?$" },
            "accountNumber": { "type": "string", "maxLength": 34 }
          },
          "unevaluatedProperties": false
        },
        "wallet": {
          "type": "object",
          "properties": {
            "provider": { "type": "string", "maxLength": 64 },
            "accountId": { "type": "string", "maxLength": 128 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "related": {
      "type": "object",
      "description": "Связи с другими транзакциями (например, рефанд).",
      "properties": {
        "originalTxId": { "type": "string", "format": "uuid" },
        "batchId": { "type": "string", "maxLength": 128 },
        "orderId": { "type": "string", "maxLength": 128 }
      },
      "unevaluatedProperties": false
    },
    "memo": {
      "type": "string",
      "description": "Короткое текстовое поле назначения платежа.",
      "maxLength": 2048
    },
    "metadata": {
      "type": "object",
      "description": "Расширяемые нефинансовые атрибуты. Не храните здесь персональные данные без DLP.",
      "propertyNames": { "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{0,63}$" },
      "additionalProperties": {
        "oneOf": [
          { "type": "string", "maxLength": 4096 },
          { "type": "number" },
          { "type": "integer" },
          { "type": "boolean" },
          { "type": "null" },
          {
            "type": "array",
            "items": { "type": "string", "maxItems": 50, "maxLength": 512 }
          }
        ]
      },
      "maxProperties": 64,
      "default": {}
    }
  },

  "allOf": [
    {
      "$comment": "Инвариант: сумма брутто = нетто + сумма всех fee + сумма всех налогов.",
      "if": { "properties": { "fees": { "minItems": 0 } } },
      "then": {
        "properties": {
          "amount": { "$ref": "#/$defs/moneyString" },
          "amountNet": { "$ref": "#/$defs/moneyString" }
        }
      }
    },
    {
      "$comment": "Если type=refund, то amount и amountNet должны быть отрицательными.",
      "if": { "properties": { "type": { "const": "refund" } } },
      "then": {
        "properties": {
          "amount": { "$ref": "#/$defs/moneyNegative" },
          "amountNet": { "$ref": "#/$defs/moneyNegative" }
        },
        "required": ["related"],
        "properties": {
          "related": {
            "required": ["originalTxId"]
          }
        }
      }
    },
    {
      "$comment": "Если type=charge|transfer|payout|fee|adjustment — суммы неотрицательные.",
      "if": {
        "properties": {
          "type": { "enum": ["charge", "transfer", "payout", "fee", "adjustment"] }
        }
      },
      "then": {
        "properties": {
          "amount": { "$ref": "#/$defs/moneyNonNegative" },
          "amountNet": { "$ref": "#/$defs/moneyNonNegative" }
        }
      }
    },
    {
      "$comment": "Если указан exchange и quoteCurrency != currency, то rate обязателен (это уже enforced) — дополнительно зафиксируем формат.",
      "if": { "required": ["exchange"] },
      "then": {
        "properties": {
          "exchange": {
            "required": ["rate", "baseCurrency", "quoteCurrency"]
          }
        }
      }
    },
    {
      "$comment": "Статусы failed/cancelled запрещают наличие posted сумм нетто > 0.",
      "if": { "properties": { "status": { "enum": ["failed", "cancelled"] } } },
      "then": {
        "properties": {
          "amountNet": { "$ref": "#/$defs/moneyZero" }
        }
      }
    }
  ],

  "$defs": {
    "moneyString": {
      "type": "string",
      "description": "Десятичная строка, до 18 знаков до точки и до 12 знаков после. Знак допускается.",
      "pattern": "^-?(?:0|[1-9][0-9]{0,17})(?:\\.[0-9]{1,12})?$",
      "examples": ["0", "12.34", "-0.010000", "123456789012345678.000001"]
    },
    "moneyNonNegative": {
      "allOf": [
        { "$ref": "#/$defs/moneyString" },
        { "pattern": "^(?:0|[1-9][0-9]{0,17})(?:\\.[0-9]{1,12})?$" }
      ]
    },
    "moneyNegative": {
      "allOf": [
        { "$ref": "#/$defs/moneyString" },
        { "pattern": "^-((?:0|[1-9][0-9]{0,17})(?:\\.[0-9]{1,12})?)$" }
      ]
    },
    "moneyZero": {
      "type": "string",
      "pattern": "^0(?:\\.0+)?$",
      "examples": ["0", "0.0", "0.000000"]
    },
    "chargeComponent": {
      "type": "object",
      "required": ["code", "amount"],
      "properties": {
        "code": {
          "type": "string",
          "description": "Код удержания/налога (например, FEE_PROC, TAX_VAT_21).",
          "pattern": "^[A-Z0-9_]{2,32}$"
        },
        "amount": {
          "$ref": "#/$defs/moneyNonNegative",
          "description": "Величина удержания/налога в базовой валюте."
        },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "description": "Валюта компонента; если не указана, считается равной currency транзакции."
        }
      },
      "unevaluatedProperties": false
    },
    "party": {
      "type": "object",
      "description": "Сторона транзакции.",
      "required": ["id", "type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Внутренний ID контрагента/счёта.",
          "maxLength": 128
        },
        "type": {
          "type": "string",
          "enum": ["customer", "merchant", "internal_account", "provider", "bank"],
          "description": "Тип стороны."
        },
        "name": { "type": "string", "maxLength": 256 },
        "accountRef": {
          "type": "object",
          "description": "Реквизиты счёта стороны.",
          "properties": {
            "iban": { "type": "string", "pattern": "^[A-Z]{2}[0-9A-Z]{13,32}$" },
            "bic": { "type": "string", "pattern": "^[A-Z0-9]{8}([A-Z0-9]{3})?$" },
            "accountNumber": { "type": "string", "maxLength": 34 },
            "currency": { "type": "string", "pattern": "^[A-Z]{3}$" }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    }
  },

  "examples": [
    {
      "schemaVersion": "1.0.0",
      "id": "8f6f4b9f-7b1c-4a30-b6a4-0d0f3c0e1abc",
      "externalId": "PAY-2025-000123",
      "type": "charge",
      "status": "posted",
      "occurredAt": "2025-08-15T09:12:33.123Z",
      "recordedAt": "2025-08-15T09:12:34.001Z",
      "currency": "EUR",
      "amount": "100.00",
      "fees": [
        { "code": "FEE_PROC", "amount": "1.50" }
      ],
      "taxes": [
        { "code": "TAX_VAT_21", "amount": "0.00" }
      ],
      "amountNet": "98.50",
      "payer": {
        "id": "cust_001",
        "type": "customer",
        "name": "Alice"
      },
      "payee": {
        "id": "mrc_007",
        "type": "merchant",
        "name": "ACME Store",
        "accountRef": { "iban": "DE44500105175407324931", "currency": "EUR" }
      },
      "method": "bank_transfer",
      "instrument": {
        "bank": { "iban": "DE44500105175407324931", "bic": "COBADEFFXXX" }
      },
      "metadata": {
        "order_number": "ORD-7788",
        "channel": "web"
      }
    },
    {
      "schemaVersion": "1.0.0",
      "id": "b70e0f73-5a2d-4770-9c5d-9f84f9b7cdef",
      "type": "refund",
      "status": "posted",
      "occurredAt": "2025-08-15T10:00:00Z",
      "recordedAt": "2025-08-15T10:00:01Z",
      "currency": "EUR",
      "amount": "-10.00",
      "amountNet": "-10.00",
      "payer": { "id": "mrc_007", "type": "merchant" },
      "payee": { "id": "cust_001", "type": "customer" },
      "related": { "originalTxId": "8f6f4b9f-7b1c-4a30-b6a4-0d0f3c0e1abc" }
    }
  ]
}
