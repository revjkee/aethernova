{{- /*
  File: templates/pdb.yaml
  Purpose: PodDisruptionBudget(s) for ledger-core web & worker
  Notes:
    - Создаёт PDB только если включено и реплик достаточно.
    - Поддерживает раздельные настройки для web/worker.
    - Совместим с Kubernetes >=1.25 (policy/v1).
*/ -}}

{{- define "ledger-core.pdb.apiVersion" -}}
{{- /* По умолчанию policy/v1; при необходимости можно добавить ветвление по .Capabilities */ -}}
policy/v1
{{- end -}}

{{- $fullname := include "ledger-core.fullname" . -}}
{{- $labels := include "ledger-core.labels" . | nindent 0 -}}

{{/* -------------------- WEB PDB -------------------- */}}
{{- if and .Values.web.enabled .Values.web.pdb.enabled (gt (int .Values.web.replicaCount) 1) -}}
apiVersion: {{ include "ledger-core.pdb.apiVersion" . }}
kind: PodDisruptionBudget
metadata:
  name: {{ printf "%s-web" $fullname }}
  labels:
    {{- include "ledger-core.labels" . | nindent 4 }}
    app.kubernetes.io/component: web
  {{- with .Values.web.pdb.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- /* Взаимоисключающие поля: используем то, что задано в values */}}
  {{- if .Values.web.pdb.minAvailable }}
  minAvailable: {{ tpl (toString .Values.web.pdb.minAvailable) . }}
  {{- else if .Values.web.pdb.maxUnavailable }}
  maxUnavailable: {{ tpl (toString .Values.web.pdb.maxUnavailable) . }}
  {{- else }}
  # Безопасный дефолт: хотя бы 1 под всегда доступен
  minAvailable: 1
  {{- end }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "ledger-core.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: web
{{- end }}

{{/* ------------------ WORKER PDB ------------------- */}}
{{- if and .Values.worker.enabled .Values.worker.pdb.enabled (gt (int .Values.worker.replicaCount) 1) -}}
---
apiVersion: {{ include "ledger-core.pdb.apiVersion" . }}
kind: PodDisruptionBudget
metadata:
  name: {{ printf "%s-worker" $fullname }}
  labels:
    {{- include "ledger-core.labels" . | nindent 4 }}
    app.kubernetes.io/component: worker
  {{- with .Values.worker.pdb.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.worker.pdb.minAvailable }}
  minAvailable: {{ tpl (toString .Values.worker.pdb.minAvailable) . }}
  {{- else if .Values.worker.pdb.maxUnavailable }}
  maxUnavailable: {{ tpl (toString .Values.worker.pdb.maxUnavailable) . }}
  {{- else }}
  # Для рабочих очередей допускаем 1 недоступный под при эвакуации
  maxUnavailable: 1
  {{- end }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "ledger-core.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: worker
{{- end }}
