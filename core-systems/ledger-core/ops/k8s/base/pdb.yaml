# ops/k8s/base/pdb.yaml
# PodDisruptionBudget for ledger-core
# Requires Kubernetes policy/v1 (v1.25+)
# Labels follow Kubernetes recommended app labels:
#   app.kubernetes.io/name:       ledger-core
#   app.kubernetes.io/instance:   default
#   app.kubernetes.io/component:  api | worker | stateful
#   app.kubernetes.io/part-of:    ledger
#   app.kubernetes.io/version:    vX.Y.Z

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ledger-core-stateless-pdb
  labels:
    app.kubernetes.io/name: ledger-core
    app.kubernetes.io/instance: default
    app.kubernetes.io/part-of: ledger
    app.kubernetes.io/component: stateless
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Tune in overlays if needed (e.g., prod reduces to 10%)
    ledger.io/pdb.profile: stateless
spec:
  # For stateless Deployments (api/worker). Controls voluntary disruptions
  # such as node drain, cluster upgrades, or eviction API.
  maxUnavailable: "25%"
  selector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values: ["ledger-core"]
      - key: app.kubernetes.io/component
        operator: In
        values: ["api", "worker"]
      - key: app.kubernetes.io/instance
        operator: In
        values: ["default"]

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ledger-core-stateful-pdb
  labels:
    app.kubernetes.io/name: ledger-core
    app.kubernetes.io/instance: default
    app.kubernetes.io/part-of: ledger
    app.kubernetes.io/component: stateful
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Stateful profile ensures at least one replica stays up.
    ledger.io/pdb.profile: stateful
spec:
  # For StatefulSets or components with local state / leader election
  # Choose minAvailable=1 (or higher if quorum requirements apply).
  minAvailable: 1
  selector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values: ["ledger-core"]
      - key: app.kubernetes.io/component
        operator: In
        values: ["stateful"]
      - key: app.kubernetes.io/instance
        operator: In
        values: ["default"]

# Notes:
# - Use either maxUnavailable (stateless) OR minAvailable (stateful) per PDB.
# - Ensure your Deployments/StatefulSets carry matching labels.
# - For small replicas (<=3), prefer integer values (e.g., maxUnavailable: 1).
# - For production overlays, tighten budgets (e.g., 10% for stateless) via kustomize patches.
