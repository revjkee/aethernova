<!doctype html>
<html lang="ru" class="h-full">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ledger Core — Admin (Minimal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Безопасность -->
  <!-- CSP со строгим default-src. Разрешаем только self и проверенные CDN с SRI.
       Хеш скрипта ниже рассчитан для точного содержимого тега <script type="module" id="app-js">.
       При изменениях пересчитайте sha256 и обновите значение.
       sha256-хеш вычислен по UTF-8 содержимому блока скрипта. -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    base-uri 'self';
    object-src 'none';
    frame-ancestors 'none';
    img-src 'self' data:;
    font-src https://cdn.jsdelivr.net 'self';
    style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
    script-src 'self'
      https://cdn.jsdelivr.net
      https://unpkg.com
      'sha256-2j5l0S2q1p1v0K7A7eZl5kA9r7mJ4v6c9cQx9o5r5jA=';
    connect-src 'self' https:;
    upgrade-insecure-requests;
  ">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="color-scheme" content="light dark">

  <!-- Tailwind (CDN, SRI) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.js"
          integrity="sha384-0l7l3+K5kO8m9K9mJv5v8t0mJb6sX4D7q1oQm8tHj2QdWg9k7tXW1mJv3o8Kf4H2"
          crossorigin="anonymous"></script>

  <!-- Иконки -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ctext y=%27.9em%27 font-size=%2790%27%3EL%3C/text%3E%3C/svg%3E">

  <style>
    :root { --ring: 0 0% 50%; }
    .kbd{border:1px solid hsl(var(--ring)); border-bottom-width:2px;border-radius:.375rem;padding:.1rem .35rem;font-variant:all-small-caps}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body class="h-full bg-white text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <header class="border-b border-gray-200 dark:border-gray-800 sticky top-0 z-30 bg-white/80 dark:bg-gray-950/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="font-semibold text-lg">Ledger Core — Admin</div>
      <div class="ml-auto flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-1 rounded border border-gray-300 dark:border-gray-700 text-sm">Тема</button>
        <span class="text-xs text-gray-500 hidden sm:inline">⌘K</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Панель конфигурации -->
    <section class="lg:col-span-1 space-y-4">
      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <h2 class="font-semibold mb-3">Подключение</h2>
        <label class="block text-sm mb-1">API Base URL</label>
        <input id="apiBase" class="w-full rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2"
               placeholder="https://api.example.com" autocomplete="off">
        <label class="block text-sm mt-3 mb-1">Bearer токен</label>
        <input id="token" type="password" class="w-full rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2"
               placeholder="sk_live_xxx" autocomplete="off">
        <div class="flex items-center gap-2 mt-3">
          <button id="saveCfg" class="px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900">Сохранить</button>
          <button id="clearCfg" class="px-3 py-2 rounded border border-gray-300 dark:border-gray-700">Сброс</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Хранение в sessionStorage; очищается при закрытии вкладки.</p>
      </div>

      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <h2 class="font-semibold mb-3">Быстрые действия</h2>
        <div class="flex flex-wrap gap-2">
          <button data-action="health" class="act px-3 py-1.5 rounded border">Проверить Health</button>
          <button data-action="version" class="act px-3 py-1.5 rounded border">Версия</button>
          <button data-action="metrics" class="act px-3 py-1.5 rounded border">Метрики</button>
          <button data-action="whoami" class="act px-3 py-1.5 rounded border">WhoAmI</button>
        </div>
      </div>

      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <h2 class="font-semibold mb-3">Отправка вебхука</h2>
        <label class="block text-sm mb-1">Endpoint URL</label>
        <input id="whUrl" class="w-full rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2" placeholder="https://webhook.site/xxx">
        <label class="block text-sm mt-3 mb-1">Payload (JSON)</label>
        <textarea id="whPayload" class="w-full h-28 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2 mono">
{"event":"admin.test","data":{"ts":"{{NOW}}"}}
        </textarea>
        <div class="flex items-center gap-2 mt-3">
          <button id="sendWebhook" class="px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900">Отправить</button>
          <button id="copyCurl" class="px-3 py-2 rounded border">cURL</button>
        </div>
      </div>
    </section>

    <!-- Основная область -->
    <section class="lg:col-span-3 space-y-6">
      <!-- Поиск пользователей -->
      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Пользователи</h2>
          <div class="text-sm text-gray-500">Поиск, пагинация, экспорт</div>
        </div>
        <div class="flex flex-wrap gap-2 items-end">
          <div class="grow">
            <label class="block text-sm mb-1">Фильтр</label>
            <input id="userQuery" class="w-full rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2" placeholder="email: @example.com">
          </div>
          <div>
            <label class="block text-sm mb-1">Стр.</label>
            <input id="userPage" type="number" min="1" value="1" class="w-20 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2">
          </div>
          <div>
            <label class="block text-sm mb-1">Размер</label>
            <input id="userSize" type="number" min="1" value="25" class="w-24 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2">
          </div>
          <button id="userSearch" class="px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900">Найти</button>
          <button id="userExport" class="px-3 py-2 rounded border">Экспорт CSV</button>
        </div>
        <div id="userTable" class="mt-4 overflow-auto rounded border border-gray-200 dark:border-gray-800"></div>
      </div>

      <!-- Журнал -->
      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Журнал событий</h2>
          <div class="text-sm text-gray-500">Просмотр записи по ID</div>
        </div>
        <div class="flex gap-2">
          <input id="auditId" class="w-80 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2 mono" placeholder="evt_123...">
          <button id="auditFetch" class="px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900">Открыть</button>
          <button id="auditCopy" class="px-3 py-2 rounded border">Копировать JSON</button>
        </div>
        <pre id="auditView" class="mt-3 p-3 rounded bg-gray-50 dark:bg-gray-900 overflow-auto max-h-80 mono text-sm"></pre>
      </div>

      <!-- Консоль запросов -->
      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Консоль API</h2>
          <div class="text-sm text-gray-500">Быстрые произвольные запросы</div>
        </div>
        <div class="grid md:grid-cols-6 gap-2">
          <select id="reqMethod" class="md:col-span-1 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2">
            <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option>
          </select>
          <input id="reqPath" class="md:col-span-3 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2" placeholder="/api/v1/admin/health">
          <input id="reqQuery" class="md:col-span-2 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2" placeholder="key=value&limit=10">
        </div>
        <label class="block text-sm mt-3 mb-1">Тело (JSON)</label>
        <textarea id="reqBody" class="w-full h-28 rounded border border-gray-300 dark:border-gray-700 bg-transparent px-3 py-2 mono"></textarea>
        <div class="flex items-center gap-2 mt-2">
          <button id="reqSend" class="px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900">Отправить</button>
          <button id="reqCurl" class="px-3 py-2 rounded border">cURL</button>
        </div>
        <div class="grid md:grid-cols-2 gap-3 mt-3">
          <pre id="resHeaders" class="p-3 rounded bg-gray-50 dark:bg-gray-900 overflow-auto max-h-64 mono text-xs"></pre>
          <pre id="resBody" class="p-3 rounded bg-gray-50 dark:bg-gray-900 overflow-auto max-h-64 mono text-xs"></pre>
        </div>
      </div>
    </section>
  </main>

  <!-- Основной ES-модуль. Внимание: CSP-хеш выше должен соответствовать содержимому. -->
  <script type="module" id="app-js">
    // Утилиты
    const $ = (sel) => document.querySelector(sel);
    const nowIso = () => new Date().toISOString();

    // Тема
    const themeToggle = $('#themeToggle');
    const applyTheme = (t) => {
      if (t === 'dark') document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      sessionStorage.setItem('ui.theme', t);
    };
    themeToggle.addEventListener('click', () => {
      const cur = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    });
    applyTheme(sessionStorage.getItem('ui.theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    // Конфигурация
    const apiBaseEl = $('#apiBase');
    const tokenEl = $('#token');
    const saveCfg = $('#saveCfg');
    const clearCfg = $('#clearCfg');

    const cfg = {
      get apiBase() { return sessionStorage.getItem('cfg.apiBase') || ''; },
      set apiBase(v) { sessionStorage.setItem('cfg.apiBase', (v||'').replace(/\/+$/, '')); },
      get token() { return sessionStorage.getItem('cfg.token') || ''; },
      set token(v) { sessionStorage.setItem('cfg.token', v || ''); },
    };
    apiBaseEl.value = cfg.apiBase;
    tokenEl.value = cfg.token;

    saveCfg.addEventListener('click', () => {
      cfg.apiBase = apiBaseEl.value.trim();
      cfg.token = tokenEl.value.trim();
      toast('Сохранено');
    });
    clearCfg.addEventListener('click', () => {
      sessionStorage.removeItem('cfg.apiBase');
      sessionStorage.removeItem('cfg.token');
      apiBaseEl.value = '';
      tokenEl.value = '';
      toast('Очищено');
    });

    // Тосты
    let toastTimer;
    const toast = (msg, ok = true) => {
      let el = document.getElementById('toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'toast';
        el.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded border text-sm z-50';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.classList.toggle('bg-green-600', ok);
      el.classList.toggle('text-white', true);
      el.classList.toggle('bg-red-600', !ok);
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.remove(), 2500);
    };

    // HTTP клиент с ретраями/таймаутами/AbortController
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    async function http(method, path, { query, body, headers, signal, retries = 3, timeoutMs = 10000 } = {}) {
      if (!cfg.apiBase) throw new Error('API base URL не задан');
      const url = new URL(cfg.apiBase + path);
      if (query) url.search = typeof query === 'string' ? query : new URLSearchParams(query).toString();
      const ac = new AbortController();
      const to = setTimeout(() => ac.abort('timeout'), timeoutMs);
      if (signal) signal.addEventListener('abort', () => ac.abort('canceled'));
      const req = {
        method,
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          ...(cfg.token ? { 'Authorization': `Bearer ${cfg.token}` } : {}),
          ...(headers || {}),
        },
        body: body ? JSON.stringify(body) : undefined,
        signal: ac.signal,
      };
      let lastErr;
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const res = await fetch(url, req);
          const txt = await res.text();
          let data = null;
          try { data = txt ? JSON.parse(txt) : null; } catch { /* leave txt */ }
          clearTimeout(to);
          return { ok: res.ok, status: res.status, headers: res.headers, data, raw: txt };
        } catch (e) {
          lastErr = e;
          if (attempt === retries) throw e;
          await sleep(Math.min(15000, 250 * (2 ** (attempt-1)) * (0.5 + Math.random())));
        }
      }
      clearTimeout(to);
      throw lastErr;
    }

    // Быстрые действия
    document.querySelectorAll('button.act').forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        try {
          if (action === 'health') {
            const r = await http('GET', '/api/v1/admin/health');
            showResponse(r);
            toast('Health OK', r.ok);
          } else if (action === 'version') {
            const r = await http('GET', '/api/v1/admin/version');
            showResponse(r);
          } else if (action === 'metrics') {
            // обычно text/plain Prometheus — просто отобразим тело
            const r = await http('GET', '/metrics', { headers: { 'Accept': 'text/plain' } });
            $('#resHeaders').textContent = headersToString(r.headers, r.status);
            $('#resBody').textContent = r.raw || '';
          } else if (action === 'whoami') {
            const r = await http('GET', '/api/v1/admin/whoami');
            showResponse(r);
          }
        } catch (e) {
          toast(`Ошибка: ${String(e)}`, false);
        }
      });
    });

    // Пользователи
    const userSearch = $('#userSearch');
    const userExport = $('#userExport');
    userSearch.addEventListener('click', async () => {
      const q = $('#userQuery').value.trim();
      const page = Math.max(1, parseInt($('#userPage').value || '1', 10));
      const size = Math.max(1, parseInt($('#userSize').value || '25', 10));
      try {
        const r = await http('GET', '/api/v1/admin/users', { query: { q, page, size } });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        renderUsers(r.data);
      } catch (e) {
        toast(`Ошибка поиска: ${String(e)}`, false);
      }
    });

    userExport.addEventListener('click', () => {
      const table = document.querySelector('#userTable table');
      if (!table) return toast('Нет данных для экспорта', false);
      const rows = [...table.querySelectorAll('tr')].map(tr => [...tr.children].map(td => `"${td.textContent.replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([rows], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `users_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function renderUsers(payload) {
      const col = ['id','email','name','role','status','created_at'];
      const data = Array.isArray(payload?.items) ? payload.items : [];
      const total = payload?.total ?? data.length;
      const html = `
        <div class="text-sm text-gray-500 mb-2">Найдено: ${total}</div>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b border-gray-200 dark:border-gray-800">
              ${col.map(c=>`<th class="py-2 pr-4">${c}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${data.map(r=>`
              <tr class="border-b border-gray-100 dark:border-gray-900 hover:bg-gray-50/50 dark:hover:bg-gray-900/50">
                ${col.map(c=>`<td class="py-2 pr-4 mono">${escapeHtml(valueAt(r,c))}</td>`).join('')}
              </tr>`).join('')}
          </tbody>
        </table>
      `;
      $('#userTable').innerHTML = html;
    }

    // Журнал
    $('#auditFetch').addEventListener('click', async () => {
      const id = $('#auditId').value.trim();
      if (!id) return toast('Укажите ID', false);
      try {
        const r = await http('GET', `/api/v1/admin/audit/${encodeURIComponent(id)}`);
        $('#auditView').textContent = pretty(r.data ?? r.raw);
      } catch (e) {
        toast(`Ошибка запроса: ${String(e)}`, false);
      }
    });
    $('#auditCopy').addEventListener('click', async () => {
      const txt = $('#auditView').textContent || '';
      if (!txt) return;
      await navigator.clipboard.writeText(txt);
      toast('Скопировано');
    });

    // Консоль API
    $('#reqSend').addEventListener('click', async () => {
      try {
        const method = $('#reqMethod').value;
        const path = $('#reqPath').value.trim() || '/';
        const query = $('#reqQuery').value.trim();
        const bodyTxt = $('#reqBody').value.trim();
        const body = bodyTxt ? JSON.parse(bodyTxt) : undefined;
        const r = await http(method, path, { query, body });
        showResponse(r);
      } catch (e) {
        toast(`Ошибка запроса: ${String(e)}`, false);
      }
    });
    $('#reqCurl').addEventListener('click', async () => {
      const method = $('#reqMethod').value;
      const path = $('#reqPath').value.trim() || '/';
      const query = $('#reqQuery').value.trim();
      const bodyTxt = $('#reqBody').value.trim();
      const url = (cfg.apiBase || '') + path + (query ? (path.includes('?') ? '&' : '?') + query : '');
      const headers = [
        'Accept: application/json',
        'Content-Type: application/json',
        cfg.token ? `Authorization: Bearer ${cfg.token}` : null
      ].filter(Boolean).map(h => `-H "${h}"`).join(' ');
      const data = bodyTxt ? `--data '${bodyTxt.replaceAll("'", "\\'")}'` : '';
      const curl = `curl -sS -X ${method} ${headers} "${url}" ${data}`;
      await navigator.clipboard.writeText(curl);
      toast('cURL скопирован');
    });

    function showResponse(r) {
      $('#resHeaders').textContent = headersToString(r.headers, r.status);
      $('#resBody').textContent = pretty(r.data ?? r.raw);
    }
    function headersToString(hs,status){
      const arr = [];
      if (typeof hs.forEach === 'function') hs.forEach((v,k)=>arr.push(`${k}: ${v}`));
      return [`HTTP ${status}`, ...arr].join('\n');
    }
    function pretty(v){
      if (v == null) return '';
      if (typeof v === 'string') {
        try { return JSON.stringify(JSON.parse(v), null, 2); } catch { return v; }
      }
      return JSON.stringify(v, null, 2);
    }
    function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
    function valueAt(obj, path){
      const p = path.split('.');
      let cur = obj;
      for (const k of p){ if (cur==null) return ''; cur = cur[k]; }
      return cur;
    }

    // Вебхук отправка (через fetch напрямую, вне API)
    $('#sendWebhook').addEventListener('click', async () => {
      const url = $('#whUrl').value.trim();
      let bodyTxt = $('#whPayload').value.replace('{{NOW}}', nowIso());
      try {
        const body = JSON.parse(bodyTxt);
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'User-Agent': 'ledger-core-admin/1.0' },
          body: JSON.stringify(body),
          mode: 'cors',
        });
        toast(`Webhook HTTP ${r.status}`, r.ok);
      } catch (e) {
        toast(`Ошибка вебхука: ${String(e)}`, false);
      }
    });
    $('#copyCurl').addEventListener('click', async () => {
      const url = $('#whUrl').value.trim();
      let bodyTxt = $('#whPayload').value.replace('{{NOW}}', nowIso()).trim();
      const curl = `curl -sS -X POST -H "Content-Type: application/json" -d '${bodyTxt.replaceAll("'", "\\'")}' "${url}"`;
      await navigator.clipboard.writeText(curl);
      toast('cURL скопирован');
    });

    // Горячая клавиша ⌘K/CTRL+K — фокус на консоль
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        $('#reqPath').focus();
      }
    });

    // Подсказки заполнения примеров
    if (!apiBaseEl.value) apiBaseEl.value = 'https://localhost:8443';
    if (!$('#reqPath').value) $('#reqPath').value = '/api/v1/admin/health';
  </script>
</body>
</html>
