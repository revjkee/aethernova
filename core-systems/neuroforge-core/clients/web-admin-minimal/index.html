<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NeuroForge Admin Minimal</title>

  <!-- Security: Content-Security-Policy.
       В проде меняйте nonce на случайный на каждый запрос и уберите 'unsafe-inline' для стилей при выносе CSS.
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'nonce-neuroforge' 'strict-dynamic';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data:;
          font-src 'self';
          connect-src 'self' https:;
          object-src 'none';
          base-uri 'none';
          form-action 'self';
          frame-ancestors 'none';
          upgrade-insecure-requests;
        ">

  <!-- App configuration hint for JS -->
  <meta name="nf-api-base" content="/api">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0e12">

  <style>
    /* ====== Minimal reset & tokens ====== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;line-height:1.5;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    img,svg{display:block;max-width:100%}
    button,input,select,textarea{font:inherit}
    :root{
      --nf-bg: #0b0e12;
      --nf-bg-soft:#10141b;
      --nf-surface:#121826;
      --nf-border:#233047;
      --nf-text:#e8eefc;
      --nf-text-muted:#9fb1d1;
      --nf-accent:#4f8cff;
      --nf-accent-2:#22c55e;
      --nf-warn:#f59e0b;
      --nf-danger:#ef4444;
      --nf-shadow: 0 2px 8px rgba(0,0,0,.25), 0 8px 24px rgba(0,0,0,.2);
      --nf-radius:16px;
      --nf-radius-sm:12px;
      --nf-radius-xs:8px;
      --nf-gap:16px;
      --nf-gap-lg:24px;
      --nf-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color-scheme: dark;
    }
    html[data-theme="light"]{
      --nf-bg:#f6f7fb; --nf-bg-soft:#f0f2f7; --nf-surface:#ffffff; --nf-border:#dfe7f3;
      --nf-text:#0d1220; --nf-text-muted:#5a6b86; --nf-shadow: 0 2px 8px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.05);
      color-scheme: light;
    }
    body{background:var(--nf-bg); color:var(--nf-text); font-family:var(--nf-font)}
    a{color:inherit;text-decoration:none}
    .container{display:grid; grid-template-columns: 260px 1fr; gap:0; min-height:100vh}
    @media (max-width: 980px){ .container{grid-template-columns:1fr} }

    /* ====== Sidebar ====== */
    .sidebar{
      position:sticky; top:0; height:100dvh; background:linear-gradient(180deg, var(--nf-surface), var(--nf-bg-soft));
      border-right:1px solid var(--nf-border); padding:20px 14px; display:flex; flex-direction:column; gap:16px
    }
    .brand{display:flex; align-items:center; gap:10px; padding:10px 8px; border-radius:var(--nf-radius-sm); user-select:none}
    .brand__logo{width:28px;height:28px; border-radius:8px; background:linear-gradient(135deg,var(--nf-accent),#7aa7ff)}
    .brand__title{font-weight:700; letter-spacing:.3px}
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .nav__link{padding:10px 12px; border-radius:12px; color:var(--nf-text-muted); display:flex; align-items:center; gap:10px; border:1px solid transparent}
    .nav__link[data-active="true"]{background:var(--nf-bg-soft); color:var(--nf-text); border-color:var(--nf-border)}
    .nav__link:hover{background:var(--nf-bg-soft); color:var(--nf-text)}
    .sidebar__footer{margin-top:auto; font-size:12px; color:var(--nf-text-muted)}

    /* ====== Header ====== */
    .header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, var(--nf-surface), transparent);
      display:flex; align-items:center; justify-content:space-between; padding:12px 18px; border-bottom:1px solid var(--nf-border)}
    .search{display:flex; align-items:center; gap:10px; background:var(--nf-bg-soft); border:1px solid var(--nf-border);
      padding:8px 12px; border-radius:12px; min-width:260px}
    .search input{background:transparent; border:none; outline:none; width:100%; color:var(--nf-text)}
    .toolbar{display:flex; align-items:center; gap:10px}
    .btn{border:1px solid var(--nf-border); background:var(--nf-surface); color:var(--nf-text);
      border-radius:10px; padding:8px 12px; cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn--primary{background:linear-gradient(135deg,var(--nf-accent),#7aa7ff); border-color:transparent; color:white}
    .btn--ghost{background:transparent}
    .avatar{width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,var(--nf-accent-2),#19a857); border:1px solid var(--nf-border)}

    /* ====== Main ====== */
    .main{padding:18px; display:grid; gap:18px}
    .grid{display:grid; gap:18px}
    .grid--metrics{grid-template-columns: repeat(4, minmax(0,1fr))}
    @media (max-width:1200px){ .grid--metrics{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width:640px){ .grid--metrics{grid-template-columns: 1fr} }
    .card{background:var(--nf-surface); border:1px solid var(--nf-border); border-radius:var(--nf-radius); box-shadow:var(--nf-shadow)}
    .card__body{padding:16px}
    .metric{display:flex; flex-direction:column; gap:8px}
    .metric__label{color:var(--nf-text-muted); font-size:12px}
    .metric__value{font-size:22px; font-weight:700}
    .metric__delta{font-size:12px}
    .delta--up{color:var(--nf-accent-2)}
    .delta--down{color:var(--nf-danger)}

    /* ====== Table ====== */
    .table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .table thead th{font-size:12px; color:var(--nf-text-muted); font-weight:600; text-align:left; padding:8px 12px}
    .table tbody tr{background:var(--nf-surface); border:1px solid var(--nf-border)}
    .table tbody td{padding:12px; border-top:1px solid var(--nf-border)}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid var(--nf-border); font-size:12px}
    .pill--ok{border-color:rgba(34,197,94,.35); color:var(--nf-accent-2)}
    .pill--warn{border-color:rgba(245,158,11,.45); color:var(--nf-warn)}
    .table__controls{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
    .input{border:1px solid var(--nf-border); background:var(--nf-bg-soft); color:var(--nf-text); border-radius:10px; padding:8px 10px}
    .select{border:1px solid var(--nf-border); background:var(--nf-bg-soft); color:var(--nf-text); border-radius:10px; padding:8px 10px}
    .sort{cursor:pointer; user-select:none}
    .pagination{display:flex; gap:6px}
    .pagination button{min-width:34px}

    /* ====== Sections visibility ====== */
    .view{display:none}
    .view[aria-hidden="false"]{display:block}

    /* ====== Toasts ====== */
    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:20}
    .toast{background:var(--nf-surface); border:1px solid var(--nf-border); border-left:4px solid var(--nf-accent);
      border-radius:12px; padding:10px 12px; box-shadow:var(--nf-shadow); min-width:240px}
    .toast--ok{border-left-color:var(--nf-accent-2)}
    .toast--warn{border-left-color:var(--nf-warn)}
    .toast--err{border-left-color:var(--nf-danger)}

    /* ====== Modal (login) ====== */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); z-index:30}
    .modal[aria-hidden="false"]{display:grid}
    .modal__panel{background:var(--nf-surface); border:1px solid var(--nf-border); border-radius:16px; width:min(420px, 92vw)}
    .modal__header{padding:14px 16px; border-bottom:1px solid var(--nf-border); font-weight:700}
    .modal__body{padding:16px; display:grid; gap:12px}
    .modal__footer{padding:14px 16px; border-top:1px solid var(--nf-border); display:flex; justify-content:flex-end; gap:8px}

    /* ====== Chart ====== */
    .chart{width:100%; height:220px}
    .chart svg{width:100%; height:100%}
    .muted{color:var(--nf-text-muted)}
    .hide-mobile{display:inline}
    @media(max-width:640px){ .hide-mobile{display:none} }

    /* ====== Reduce motion ====== */
    @media (prefers-reduced-motion: reduce) {
      *{scroll-behavior:auto; transition:none !important; animation:none !important}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Sidebar">
      <div class="brand" aria-label="Brand">
        <div class="brand__logo" aria-hidden="true"></div>
        <div class="brand__title">NeuroForge Admin</div>
      </div>
      <nav class="nav" id="nav">
        <a class="nav__link" href="#/dashboard" data-route="dashboard"><span>Панель</span></a>
        <a class="nav__link" href="#/users" data-route="users"><span>Пользователи</span></a>
        <a class="nav__link" href="#/settings" data-route="settings"><span>Настройки</span></a>
        <a class="nav__link" href="#/logs" data-route="logs"><span>Логи</span></a>
      </nav>
      <div class="sidebar__footer">v1.0 • безопасный минимал</div>
    </aside>

    <!-- Content -->
    <div>
      <header class="header" role="banner">
        <div class="search" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M10 4a6 6 0 1 1 0 12a6 6 0 0 1 0-12m8.32 12.9l3.39 3.39l-1.41 1.41l-3.39-3.39A8.96 8.96 0 0 1 10 20a9 9 0 1 1 9-9c0 2.17-.77 4.16-2.07 5.7Z"/></svg>
          <input id="globalSearch" placeholder="Поиск по админке" aria-label="Поиск">
        </div>
        <div class="toolbar">
          <button class="btn btn--ghost" id="themeToggle" aria-label="Переключить тему">Тема</button>
          <button class="btn btn--primary" id="loginBtn" aria-label="Войти">Войти</button>
          <div class="avatar" aria-hidden="true"></div>
        </div>
      </header>

      <main class="main" id="main" role="main">
        <!-- Dashboard -->
        <section id="view-dashboard" class="view" aria-hidden="true">
          <div class="grid grid--metrics" role="region" aria-label="Метрики">
            <div class="card"><div class="card__body metric">
              <div class="metric__label">Активные пользователи</div>
              <div class="metric__value" id="m-active">—</div>
              <div class="metric__delta delta--up" id="m-active-delta">—</div>
            </div></div>
            <div class="card"><div class="card__body metric">
              <div class="metric__label">Запросы в минуту</div>
              <div class="metric__value" id="m-rpm">—</div>
              <div class="metric__delta delta--up" id="m-rpm-delta">—</div>
            </div></div>
            <div class="card"><div class="card__body metric">
              <div class="metric__label">Ошибки 5xx</div>
              <div class="metric__value" id="m-err">—</div>
              <div class="metric__delta delta--down" id="m-err-delta">—</div>
            </div></div>
            <div class="card"><div class="card__body metric">
              <div class="metric__label">Средняя задержка</div>
              <div class="metric__value" id="m-lat">—</div>
              <div class="metric__delta" id="m-lat-delta">—</div>
            </div></div>
          </div>

          <div class="card">
            <div class="card__body">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <div><strong>Нагрузка</strong> <span class="muted hide-mobile">последние 24 ч</span></div>
                <div class="muted" id="chartSummary">—</div>
              </div>
              <div class="chart" id="chart" aria-label="График нагрузки"></div>
            </div>
          </div>
        </section>

        <!-- Users -->
        <section id="view-users" class="view" aria-hidden="true">
          <div class="card">
            <div class="card__body">
              <div class="table__controls">
                <input id="usersFilter" class="input" placeholder="Фильтр по имени или email" aria-label="Фильтр">
                <div style="display:flex; gap:8px; align-items:center">
                  <label class="muted">Строк на страницу</label>
                  <select id="pageSize" class="select" aria-label="Строк на страницу">
                    <option>5</option><option selected>10</option><option>20</option>
                  </select>
                </div>
              </div>
              <table class="table" aria-describedby="usersHelp">
                <thead>
                  <tr>
                    <th class="sort" data-key="name" aria-sort="none" tabindex="0">Имя</th>
                    <th class="sort" data-key="email" aria-sort="none" tabindex="0">Email</th>
                    <th class="sort" data-key="role" aria-sort="none" tabindex="0">Роль</th>
                    <th class="sort" data-key="status" aria-sort="none" tabindex="0">Статус</th>
                  </tr>
                </thead>
                <tbody id="usersBody"></tbody>
              </table>
              <div id="usersHelp" class="muted" style="margin-top:8px">Нажмите на заголовок для сортировки. PgUp/PgDn — пагинация.</div>
              <div class="table__controls" style="margin-top:12px">
                <div class="muted" id="usersCount">—</div>
                <div class="pagination">
                  <button class="btn" id="prevPage" aria-label="Назад">‹</button>
                  <button class="btn" id="nextPage" aria-label="Вперед">›</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="view-settings" class="view" aria-hidden="true">
          <div class="card">
            <div class="card__body" style="display:grid; gap:12px">
              <h3>Настройки</h3>
              <label>API endpoint
                <input id="apiBase" class="input" placeholder="/api" value="/api">
              </label>
              <label><input type="checkbox" id="telemetry" checked> Отправлять телеметрию производительности</label>
              <div style="display:flex; gap:8px">
                <button class="btn btn--primary" id="saveSettings">Сохранить</button>
                <button class="btn" id="resetSettings">Сбросить</button>
              </div>
              <div class="muted">Изменения сохраняются в localStorage для текущего домена.</div>
            </div>
          </div>
        </section>

        <!-- Logs -->
        <section id="view-logs" class="view" aria-hidden="true">
          <div class="card"><div class="card__body">
            <h3>Логи клиента</h3>
            <pre id="logBox" style="white-space:pre-wrap; max-height:360px; overflow:auto; background:var(--nf-bg-soft); padding:12px; border:1px solid var(--nf-border); border-radius:12px"></pre>
            <div style="margin-top:10px; display:flex; gap:8px">
              <button class="btn" id="copyLogs">Копировать</button>
              <button class="btn" id="clearLogs">Очистить</button>
            </div>
          </div></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Login modal -->
  <div class="modal" id="loginModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal__panel">
      <div class="modal__header">Вход</div>
      <div class="modal__body">
        <label>Email
          <input id="authEmail" class="input" placeholder="you@example.com" autocomplete="username">
        </label>
        <label>Пароль
          <input id="authPass" class="input" type="password" placeholder="••••••••" autocomplete="current-password">
        </label>
        <div class="muted">Демо-режим: данные не отправляются на сервер.</div>
      </div>
      <div class="modal__footer">
        <button class="btn" id="cancelLogin">Отмена</button>
        <button class="btn btn--primary" id="submitLogin">Войти</button>
      </div>
    </div>
  </div>

  <script nonce="neuroforge">
  (function(){
    "use strict";

    // ====== Utilities ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (v,min,max)=>Math.min(Math.max(v,min),max);
    const debounce = (fn, ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };
    const fmtNum = (n)=>Intl.NumberFormat('ru-RU').format(n);
    const nfNow = ()=>performance.now();
    const randomId = (p='id')=> p+'_'+Math.random().toString(36).slice(2,9);

    // Avoid XSS: use textContent, not innerHTML, sanitize attributes we must set
    const setText = (el, txt='') => { if(el) el.textContent = String(txt); };
    const safeAttr = (el, name, value) => { if(!/^[a-zA-Z0-9:_-]+$/.test(name)) return; el.setAttribute(name, String(value).replace(/[<>]/g,'')); };

    // ====== Log buffer ======
    const Log = (() => {
      let buf = [];
      const push = (level, msg, extra={}) => {
        const line = `${new Date().toISOString()} [${level}] ${msg}${Object.keys(extra).length ? ' '+JSON.stringify(extra) : ''}`;
        buf.push(line); if (buf.length>500) buf.shift();
        const box = $('#logBox'); if (box) { box.textContent = buf.join('\n'); box.scrollTop = box.scrollHeight; }
      };
      return {
        info:(m,e)=>push('INFO',m,e),
        warn:(m,e)=>push('WARN',m,e),
        err:(m,e)=>push('ERR',m,e),
        get:()=>buf.slice(),
        clear:()=>{buf=[]; setText($('#logBox'),'');}
      };
    })();

    // ====== Toasts ======
    const Toasts = (() => {
      const root = $('#toasts');
      const show = (msg, type='ok', ttl=3500) => {
        const div = document.createElement('div');
        div.className = `toast toast--${type}`;
        div.role = 'status';
        div.textContent = msg;
        root.appendChild(div);
        setTimeout(()=>{ div.remove(); }, ttl);
      };
      return { show };
    })();

    // ====== Theme ======
    const Theme = (() => {
      const apply = (mode) => {
        const m = mode==='dark' || mode==='light' ? mode : (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
        document.documentElement.setAttribute('data-theme', m);
        localStorage.setItem('nf_theme', m);
        Log.info('theme.set', {mode:m});
      };
      const toggle = () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'auto';
        apply(cur==='dark' ? 'light' : 'dark');
      };
      const init = () => apply(localStorage.getItem('nf_theme') || 'auto');
      return { init, toggle };
    })();

    // ====== Config ======
    const Config = (() => {
      const defaults = {
        apiBase: $('meta[name="nf-api-base"]')?.content || '/api',
        telemetry: true
      };
      const load = () => {
        try { return {...defaults, ...JSON.parse(localStorage.getItem('nf_cfg')||'{}')}; }
        catch { return {...defaults}; }
      };
      const save = (cfg) => { localStorage.setItem('nf_cfg', JSON.stringify(cfg)); };
      return { load, save };
    })();

    // ====== Trace context (W3C) ======
    const Trace = (() => {
      const hex = (len)=>crypto.getRandomValues(new Uint8Array(len/2)).reduce((s,b)=>s+b.toString(16).padStart(2,'0'),'');
      const start = (name) => {
        const traceId = hex(32), spanId = hex(16); const start = nfNow();
        return { name, traceId, spanId, start,
          header: `00-${traceId}-${spanId}-01`
        };
      };
      const end = (span) => ({...span, durMs: nfNow()-span.start});
      return { start, end };
    })();

    // ====== Fetch wrapper with retries and tracing ======
    const Http = (() => {
      const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
      const nfFetch = async (path, opts={}) => {
        const cfg = Config.load();
        const url = (path.startsWith('http')? path : cfg.apiBase.replace(/\/$/,'') + '/' + path.replace(/^\//,''));
        const span = Trace.start('http.fetch');
        const headers = new Headers(opts.headers || {});
        headers.set('x-client', 'neuroforge-admin');
        headers.set('traceparent', span.header);
        const token = sessionStorage.getItem('nf_token');
        if (token) headers.set('authorization', `Bearer ${token}`);
        const base = { method: 'GET', credentials: 'same-origin', cache: 'no-store', ...opts, headers };

        let attempt = 0, max = 3;
        while (true) {
          try {
            const res = await fetch(url, base);
            if (!res.ok && res.status >= 500 && attempt < max-1) throw new Error('server '+res.status);
            const ended = Trace.end(span);
            Log.info('http.ok', {url, status: res.status, durMs: Math.round(ended.durMs)});
            return res;
          } catch (e) {
            attempt++;
            Log.warn('http.retry', {url, attempt, err: String(e)});
            if (attempt >= max) { Log.err('http.fail', {url}); throw e; }
            await sleep(200 * attempt + Math.random()*200);
          }
        }
      };
      return { nfFetch };
    })();

    // ====== Router ======
    const Router = (() => {
      const routes = ['dashboard','users','settings','logs'];
      const setActiveLink = (name) => $$('#nav .nav__link').forEach(a => a.dataset.active = String(a.dataset.route===name));
      const show = (name) => {
        routes.forEach(r=>{
          const el = $('#view-'+r);
          if (el) el.setAttribute('aria-hidden', String(r!==name));
        });
        setActiveLink(name);
        localStorage.setItem('nf_route', name);
      };
      const current = () => location.hash.replace(/^#\//,'') || 'dashboard';
      const navigate = (name) => { if(!routes.includes(name)) name='dashboard'; location.hash = '#/'+name; };
      const init = () => {
        window.addEventListener('hashchange', ()=> show(current()));
        show(current());
      };
      return { init, navigate };
    })();

    // ====== Demo data & table ======
    const Users = (() => {
      let all = Array.from({length: 57}).map((_,i)=>({
        id: i+1,
        name: `User ${i+1}`,
        email: `user${i+1}@example.com`,
        role: i%7===0 ? 'admin' : (i%2 ? 'user' : 'editor'),
        status: i%9===0 ? 'warn' : 'ok'
      }));
      let state = { page: 0, size: 10, sortKey: 'name', sortDir: 'asc', filter: '' };

      const apply = () => {
        const f = state.filter.trim().toLowerCase();
        let view = all.filter(u => !f || u.name.toLowerCase().includes(f) || u.email.toLowerCase().includes(f));
        view.sort((a,b)=>{
          const k = state.sortKey; const va = String(a[k]).toLowerCase(); const vb = String(b[k]).toLowerCase();
          const cmp = va<vb?-1:va>vb?1:0; return state.sortDir==='asc'?cmp:-cmp;
        });
        const total = view.length;
        const start = state.page*state.size;
        const pageView = view.slice(start, start+state.size);

        // Render
        const body = $('#usersBody'); body.innerHTML='';
        for (const u of pageView){
          const tr = document.createElement('tr');
          const td = (t)=>{ const el=document.createElement('td'); el.textContent=t; return el; };
          tr.appendChild(td(u.name));
          tr.appendChild(td(u.email));
          tr.appendChild(td(u.role));
          const st = document.createElement('td');
          const pill = document.createElement('span');
          pill.className = 'pill '+(u.status==='ok'?'pill--ok':'pill--warn');
          pill.textContent = u.status==='ok'?'Активен':'Требует внимания';
          st.appendChild(pill);
          tr.appendChild(st);
          body.appendChild(tr);
        }
        setText($('#usersCount'), `Показано ${pageView.length} из ${total}`);
        safeAttr($('#prevPage'), 'disabled', String(state.page===0));
        safeAttr($('#nextPage'), 'disabled', String(start+state.size>=total));
      };

      const init = () => {
        $('#usersFilter').addEventListener('input', debounce(e=>{ state.filter = e.target.value; state.page=0; apply(); }, 200));
        $('#pageSize').addEventListener('change', e=>{ state.size = parseInt(e.target.value,10); state.page=0; apply(); });
        $('#prevPage').addEventListener('click', ()=>{ state.page = Math.max(0, state.page-1); apply(); });
        $('#nextPage').addEventListener('click', ()=>{ state.page = state.page+1; apply(); });
        $$('#view-users th.sort').forEach(th=>{
          th.addEventListener('click', ()=>{ const k = th.dataset.key; state.sortDir = (state.sortKey===k && state.sortDir==='asc')?'desc':'asc'; state.sortKey=k; apply(); });
          th.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); th.click(); }});
        });
        document.addEventListener('keydown', (ev)=>{
          if (location.hash==='#/users'){
            if (ev.key==='PageDown'){ $('#nextPage').click(); }
            if (ev.key==='PageUp'){ $('#prevPage').click(); }
          }
        });
        apply();
      };

      return { init };
    })();

    // ====== Dashboard metrics + SVG chart ======
    const Dashboard = (() => {
      const renderMetrics = (m) => {
        setText($('#m-active'), fmtNum(m.active));
        setText($('#m-active-delta'), `+${fmtNum(m.activeDelta)} за 24ч`);
        setText($('#m-rpm'), fmtNum(m.rpm));
        setText($('#m-rpm-delta'), `+${fmtNum(m.rpmDelta)} за час`);
        setText($('#m-err'), fmtNum(m.err));
        setText($('#m-err-delta'), `-${fmtNum(m.errDelta)} инцидентов`);
        setText($('#m-lat'), `${m.lat.toFixed(1)} ms`);
        setText($('#m-lat-delta'), `${m.latDelta>0?'+':''}${m.latDelta.toFixed(1)} ms`);
      };

      const renderChart = (points) => {
        const root = $('#chart'); root.innerHTML='';
        const w = root.clientWidth || 600, h = root.clientHeight || 220, pad = 24;
        const xs = points.map((_,i)=>i), ys = points;
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const x = i => pad + (w-2*pad) * (i/(xs.length-1));
        const y = v => h-pad - (h-2*pad) * ((v-minY)/(maxY-minY || 1));
        const d = xs.map((i,idx)=> (idx===0?'M':'L') + x(i).toFixed(1) + ' ' + y(ys[i]).toFixed(1)).join(' ');
        const area = d + ` L ${x(xs.length-1).toFixed(1)} ${h-pad} L ${x(0).toFixed(1)} ${h-pad} Z`;

        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS, 'svg'); safeAttr(svg,'viewBox',`0 0 ${w} ${h}`);
        const grad = document.createElementNS(svgNS,'linearGradient'); safeAttr(grad,'id','g1'); safeAttr(grad,'x1','0'); safeAttr(grad,'x2','0'); safeAttr(grad,'y1','0'); safeAttr(grad,'y2','1');
        const s1 = document.createElementNS(svgNS,'stop'); safeAttr(s1,'offset','0%'); safeAttr(s1,'stop-color','rgba(79,140,255,.35)');
        const s2 = document.createElementNS(svgNS,'stop'); safeAttr(s2,'offset','100%'); safeAttr(s2,'stop-color','rgba(79,140,255,0)');
        grad.appendChild(s1); grad.appendChild(s2);
        const defs = document.createElementNS(svgNS,'defs'); defs.appendChild(grad); svg.appendChild(defs);

        const path = document.createElementNS(svgNS,'path'); safeAttr(path,'d',d); safeAttr(path,'fill','none'); safeAttr(path,'stroke','rgba(79,140,255,1)'); safeAttr(path,'stroke-width','2.5');
        const fill = document.createElementNS(svgNS,'path'); safeAttr(fill,'d',area); safeAttr(fill,'fill','url(#g1)');

        svg.appendChild(fill); svg.appendChild(path); root.appendChild(svg);
        setText($('#chartSummary'), `min ${Math.round(minY)} • max ${Math.round(maxY)} • pts ${points.length}`);
      };

      const init = () => {
        // Demo metrics
        const m = { active: 18234, activeDelta: 356, rpm: 12490, rpmDelta: 640, err: 7, errDelta: 2, lat: 112.4, latDelta: -6.3 };
        renderMetrics(m);
        const pts = Array.from({length: 48}).map(()=> 80 + Math.random()*60 + Math.random()*40);
        renderChart(pts);
        window.addEventListener('resize', debounce(()=>renderChart(pts), 150));
      };

      return { init };
    })();

    // ====== Settings ======
    const Settings = (() => {
      const init = () => {
        const cfg = Config.load();
        $('#apiBase').value = cfg.apiBase;
        $('#telemetry').checked = !!cfg.telemetry;
        $('#saveSettings').addEventListener('click', ()=>{
          const next = { apiBase: $('#apiBase').value || '/api', telemetry: $('#telemetry').checked };
          Config.save(next);
          Toasts.show('Настройки сохранены','ok');
        });
        $('#resetSettings').addEventListener('click', ()=>{
          localStorage.removeItem('nf_cfg');
          $('#apiBase').value = '/api'; $('#telemetry').checked = true;
          Toasts.show('Сброс выполнен','warn');
        });
      };
      return { init };
    })();

    // ====== Auth (demo modal) ======
    const Auth = (() => {
      const modal = $('#loginModal');
      const open = ()=>{ modal.setAttribute('aria-hidden','false'); $('#authEmail').focus(); };
      const close = ()=>{ modal.setAttribute('aria-hidden','true'); };
      const login = ()=>{
        const email = $('#authEmail').value.trim();
        const pass = $('#authPass').value;
        if (!/^\S+@\S+\.\S+$/.test(email)) { Toasts.show('Неверный email','err'); return; }
        if (pass.length < 6) { Toasts.show('Пароль слишком короткий','err'); return; }
        const token = btoa(JSON.stringify({sub: email, iat: Date.now()/1000|0}));
        sessionStorage.setItem('nf_token', token);
        Toasts.show('Вход выполнен','ok'); close();
        Log.info('auth.ok',{sub:email});
      };
      const init = ()=>{
        $('#loginBtn').addEventListener('click', open);
        $('#cancelLogin').addEventListener('click', close);
        $('#submitLogin').addEventListener('click', login);
        modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
      };
      return { init, open };
    })();

    // ====== Global Search (demo) ======
    const GlobalSearch = (() => {
      const init = ()=>{
        $('#globalSearch').addEventListener('input', debounce(e=>{
          Log.info('search.query',{q:e.target.value});
        }, 200));
      };
      return { init };
    })();

    // ====== Hotkeys ======
    const Hotkeys = (() => {
      const init = ()=>{
        document.addEventListener('keydown', (e)=>{
          if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
          if (e.key==='k' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); $('#globalSearch').focus(); }
          if (e.key==='g' && !e.shiftKey){ // simple go-to
            const next = { 'd':'dashboard', 'u':'users', 's':'settings', 'l':'logs' }[String(e.code||e.key).toLowerCase().replace('key','')];
            if (next) Router.navigate(next);
          }
        });
      };
      return { init };
    })();

    // ====== Entry ======
    (function boot(){
      Theme.init();
      Router.init();
      Dashboard.init();
      Users.init();
      Settings.init();
      Auth.init();
      GlobalSearch.init();
      Hotkeys.init();

      // Restore last route
      const saved = localStorage.getItem('nf_route'); if (saved) Router.navigate(saved);

      // Header buttons
      $('#themeToggle').addEventListener('click', Theme.toggle);

      // Demo: schedule a toast
      setTimeout(()=>Toasts.show('Добро пожаловать в NeuroForge Admin','ok'), 300);

      Log.info('boot.ok', {route: location.hash || '#/dashboard', ua: navigator.userAgent});
    })();

    // ====== Logs controls ======
    $('#copyLogs').addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(Log.get().join('\n')); Toasts.show('Скопировано','ok'); }
      catch { Toasts.show('Не удалось скопировать','err'); }
    });
    $('#clearLogs').addEventListener('click', ()=>{ Log.clear(); Toasts.show('Очищено','warn'); });

  })();
  </script>
</body>
</html>
