{{- /*
PodDisruptionBudget for neuroforge-core
- Renders only when:
  * .Values.pdb.enabled == true
  * effective replicas > 1 (from .Values.replicaCount or autoscaling.minReplicas) OR .Values.pdb.force == true
- Validates mutually exclusive minAvailable/maxUnavailable.
- Auto-detects API version (policy/v1 preferred, falls back to v1beta1 if present).
*/ -}}
{{- $replicas := default 1 .Values.replicaCount -}}
{{- if .Values.autoscaling.enabled }}
  {{- $replicas = default 1 .Values.autoscaling.minReplicas }}
{{- end }}
{{- if and .Values.pdb.enabled (or (gt (int $replicas) 1) .Values.pdb.force) }}

{{- if and .Values.pdb.minAvailable .Values.pdb.maxUnavailable }}
  {{- fail "values error: set only one of pdb.minAvailable or pdb.maxUnavailable" }}
{{- end }}

{{- $useV1 := .Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" -}}
apiVersion: {{- if $useV1 -}}policy/v1{{- else if .Capabilities.APIVersions.Has "policy/v1beta1/PodDisruptionBudget" -}}policy/v1beta1{{- else -}}policy/v1{{- end }}
kind: PodDisruptionBudget
metadata:
  name: {{ include "neuroforge-core.fullname" . }}
  labels:
    {{- include "neuroforge-core.labels" . | nindent 4 }}
  {{- with .Values.pdb.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  selector:
    matchLabels:
      {{- /* Base selector for this release */}}
      {{- include "neuroforge-core.selectorLabels" . | nindent 6 }}
      {{- /* Optional extra labels to narrow selection, e.g. component=api */}}
      {{- with .Values.pdb.extraSelectorLabels }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
  {{- if .Values.pdb.minAvailable }}
  minAvailable: {{ .Values.pdb.minAvailable | quote }}
  {{- else }}
  maxUnavailable: {{ default "50%" .Values.pdb.maxUnavailable | quote }}
  {{- end }}
  {{- /* Optional field (only for policy/v1 clusters that support it) */}}
  {{- if and $useV1 .Values.pdb.unhealthyPodEvictionPolicy }}
  unhealthyPodEvictionPolicy: {{ .Values.pdb.unhealthyPodEvictionPolicy | quote }}
  {{- end }}
{{- end }}
