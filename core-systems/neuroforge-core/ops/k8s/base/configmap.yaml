apiVersion: v1
kind: ConfigMap
metadata:
  name: neuroforge-core-config
  # namespace не задаём в base-слое, чтобы оверлеи могли переопределить
  labels:
    app.kubernetes.io/name: neuroforge-core
    app.kubernetes.io/instance: neuroforge-core
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: neuroforge-core
    app.kubernetes.io/managed-by: kustomize
  annotations:
    description: Base configuration for neuroforge-core application (non-secret).
    config.neuroforge.io/schema-version: "1"
    # При использовании reloader можно включить автоперезапуск:
    # reloader.stakater.com/auto: "true"
# immutable=true хорошо для статичных конфигов; в base оставляем false, чтобы оверлеи могли обновлять
immutable: false
data:
  app.yaml: |
    server:
      host: 0.0.0.0
      port: 8080
      request_timeout_s: 30
      read_timeout_s: 15
      write_timeout_s: 15
      graceful_shutdown_s: 20
      health:
        liveness_path: /healthz
        readiness_path: /readyz
    security:
      cors:
        enabled: true
        allow_origins: ["*"]
        allow_headers: ["*"]
        allow_methods: ["GET","POST","PUT","DELETE","OPTIONS"]
      csrf_protection: false
      trusted_proxies: ["10.0.0.0/8","192.168.0.0/16"]
    observability:
      metrics:
        enabled: true
        path: /metrics
      tracing:
        enabled: true
        exporter: otlp
        otlp_endpoint: http://otel-collector.observability:4317
      logging:
        level: INFO
        json: true
        sample_rate: 1.0
    integrations:
      opa:
        url: http://opa.default:8181
        package: neuroforge.authz
        rule: allow
        timeout_s: 2.0
      datafabric:
        base_url: http://datafabric.default:8080
        timeout_s: 10.0
    retention:
      enabled: true
      scan_interval_s: 300
      default_retain_days: 365
  logging.yaml: |
    version: 1
    disable_existing_loggers: false
    formatters:
      json:
        format: '%(asctime)s %(levelname)s %(name)s %(message)s'
    handlers:
      stdout:
        class: logging.StreamHandler
        formatter: json
        stream: ext://sys.stdout
    root:
      level: INFO
      handlers: [stdout]
    loggers:
      neuroforge:
        level: INFO
        handlers: [stdout]
        propagate: false
  features.yaml: |
    flags:
      ENABLE_EXPERIMENTAL_API: false
      ENABLE_PROMETHEUS: true
      ENABLE_TRACING: true
      STRICT_SCHEMA_VALIDATION: true
  limits.ini: |
    [http]
    max_connections=10240
    backlog=2048
    keepalive=75
    [app]
    max_workers=4
    worker_class=uvicorn.workers.UvicornWorker
    [timeouts]
    graceful_shutdown=20
  config.schema.json: |
    {
      "$schema": "https://json-schema.org/draft/2020-12/schema",
      "title": "neuroforge-core app.yaml schema",
      "type": "object",
      "properties": {
        "server": {
          "type": "object",
          "properties": {
            "port": { "type": "integer", "minimum": 1, "maximum": 65535 }
          },
          "required": ["port"]
        }
      }
    }
