apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: neuroforge-prometheus-rules
  labels:
    app.kubernetes.io/name: neuroforge
    app.kubernetes.io/instance: neuroforge
    app.kubernetes.io/part-of: neuroforge-core
    app.kubernetes.io/component: observability
    prometheus: k8s
spec:
  groups:

  # ============================== SLO RECORDINGS ===============================
  - name: neuroforge.slo.recordings
    interval: 30s
    rules:
      # Суммарный трафик и ошибки (поддержка разных имён метрик приложения)
      - record: job:neuroforge:http_requests:rate5m
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*"}[5m])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*"}[5m])
          )
      - record: job:neuroforge:http_errors:rate5m
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", code=~"5.."}[5m])
          )
          or
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", status=~"5.."}[5m])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*", status=~"5.."}[5m])
          )
      - record: job:neuroforge:http_error_ratio:5m
        expr: |
          (job:neuroforge:http_errors:rate5m)
          /
          (job:neuroforge:http_requests:rate5m > 0)

      # Латентность p95/p99 (гистограммы приложения; поддержка двух распространённых имён)
      - record: job:neuroforge:http_request_duration_seconds_bucket:sum_rate5m
        expr: |
          sum by (job, le) (
            rate(http_request_duration_seconds_bucket{job=~"neuroforge.*"}[5m])
          )
          or
          sum by (job, le) (
            rate(http_server_requests_seconds_bucket{job=~"neuroforge.*"}[5m])
          )
      - record: job:neuroforge:http_latency_p95:5m
        expr: histogram_quantile(0.95, job:neuroforge:http_request_duration_seconds_bucket:sum_rate5m)
      - record: job:neuroforge:http_latency_p99:5m
        expr: histogram_quantile(0.99, job:neuroforge:http_request_duration_seconds_bucket:sum_rate5m)

      # Ошибочные ответы в более длинных окнах для burn-rate SLO
      - record: job:neuroforge:http_requests:rate30m
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*"}[30m])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*"}[30m])
          )
      - record: job:neuroforge:http_errors:rate30m
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", code=~"5.."}[30m])
          )
          or
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", status=~"5.."}[30m])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*", status=~"5.."}[30m])
          )
      - record: job:neuroforge:http_error_ratio:30m
        expr: |
          (job:neuroforge:http_errors:rate30m)
          /
          (job:neuroforge:http_requests:rate30m > 0)

      - record: job:neuroforge:http_requests:rate1h
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*"}[1h])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*"}[1h])
          )
      - record: job:neuroforge:http_errors:rate1h
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", code=~"5.."}[1h])
          )
          or
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", status=~"5.."}[1h])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*", status=~"5.."}[1h])
          )
      - record: job:neuroforge:http_error_ratio:1h
        expr: |
          (job:neuroforge:http_errors:rate1h)
          /
          (job:neuroforge:http_requests:rate1h > 0)

      - record: job:neuroforge:http_requests:rate6h
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*"}[6h])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*"}[6h])
          )
      - record: job:neuroforge:http_errors:rate6h
        expr: |
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", code=~"5.."}[6h])
          )
          or
          sum by (job) (
            rate(http_requests_total{job=~"neuroforge.*", status=~"5.."}[6h])
          )
          or
          sum by (job) (
            rate(http_server_requests_seconds_count{job=~"neuroforge.*", status=~"5.."}[6h])
          )
      - record: job:neuroforge:http_error_ratio:6h
        expr: |
          (job:neuroforge:http_errors:rate6h)
          /
          (job:neuroforge:http_requests:rate6h > 0)

  # ================================ SLO ALERTS ================================
  - name: neuroforge.slo.alerts
    interval: 30s
    rules:
      # Доступность 99.9% — fast burn (1h/5m), порог 14.4× бюджета
      - alert: NeuroforgeSLOAvailabilityFastBurn
        expr: |
          (job:neuroforge:http_error_ratio:5m  / 0.001 > 14.4)
          and
          (job:neuroforge:http_error_ratio:1h  / 0.001 > 14.4)
        labels:
          severity: critical
          slo: availability
          target: "99.9"
          service: neuroforge
          team: core-platform
        annotations:
          summary: "SLO доступности (99.9%) — швидкое сгорание бюджета"
          description: "Доля 5xx превышает бюджет ошибки для сервиса neuroforge в окнах 5m/1h."
          impact: "Потеря доступности API. Клиенты получают ошибки 5xx."
          runbook_url: "https://your.runbooks/neuroforge/slo-availability"
          dashboard_url: "https://your.grafana/d/neuroforge/slo"

      # Доступность 99.9% — slow burn (6h/30m), порог 6× бюджета
      - alert: NeuroforgeSLOAvailabilitySlowBurn
        expr: |
          (job:neuroforge:http_error_ratio:30m / 0.001 > 6)
          and
          (job:neuroforge:http_error_ratio:6h  / 0.001 > 6)
        for: 15m
        labels:
          severity: warning
          slo: availability
          target: "99.9"
          service: neuroforge
          team: core-platform
        annotations:
          summary: "SLO доступности (99.9%) — медленное сгорание бюджета"
          description: "Ошибка 5xx стабильно повышена в окнах 30m/6h для сервиса neuroforge."
          impact: "Деградация доступности API."
          runbook_url: "https://your.runbooks/neuroforge/slo-availability"
          dashboard_url: "https://your.grafana/d/neuroforge/slo"

      # Латентность p95 > 300ms в окнах 5m/30m
      - alert: NeuroforgeSLOLatencyHighP95
        expr: |
          (job:neuroforge:http_latency_p95:5m > 0.3)
          and
          (avg_over_time(job:neuroforge:http_latency_p95:5m[30m]) > 0.3)
        for: 10m
        labels:
          severity: warning
          slo: latency
          target: "p95<=300ms"
          service: neuroforge
          team: core-platform
        annotations:
          summary: "SLO латентности — p95 > 300ms"
          description: "p95 длительности HTTP-запросов превышает целевой порог 300ms."
          impact: "Замедление API для значительной части запросов."
          runbook_url: "https://your.runbooks/neuroforge/slo-latency"
          dashboard_url: "https://your.grafana/d/neuroforge/latency"

      # Отсутствие метрик приложения (нет экспорта / падение endpoints)
      - alert: NeuroforgeAppMetricsMissing
        expr: |
          absent(job:neuroforge:http_requests:rate5m)
        for: 10m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Метрики приложения neuroforge недоступны"
          description: "Prometheus не видит ключевые метрики HTTP сервиса neuroforge (возможны проблемы ServiceMonitor/Endpoints)."
          runbook_url: "https://your.runbooks/neuroforge/metrics-missing"

  # ============================== WORKLOAD HEALTH ==============================
  - name: neuroforge.workload.alerts
    interval: 30s
    rules:
      # CrashLoop / частые рестарты
      - alert: NeuroforgePodCrashLooping
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace=~".*"}[5m]) > 3
        for: 10m
        labels:
          severity: critical
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Частые рестарты контейнера"
          description: "Контейнеры перезапускаются >3 раза за 5 минут. Возможен CrashLoopBackOff."
          runbook_url: "https://your.runbooks/kubernetes/pod-crashloop"

      # OOMKilled
      - alert: NeuroforgePodOOMKilled
        expr: |
          max_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
        for: 5m
        labels:
          severity: critical
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Контейнер завершён по OOMKilled"
          description: "Последнее завершение контейнера по причине OOMKilled за последние 10 минут."
          runbook_url: "https://your.runbooks/kubernetes/oom"

      # Недоступные реплики деплоймента
      - alert: NeuroforgeDeploymentUnavailable
        expr: |
          kube_deployment_status_replicas_unavailable{deployment=~".*neuroforge.*"} > 0
        for: 15m
        labels:
          severity: critical
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Деплоймент имеет недоступные реплики"
          description: "kube_deployment_status_replicas_unavailable > 0 длительное время."
          runbook_url: "https://your.runbooks/kubernetes/deployment-unavailable"

      # CPU throttling существенный
      - alert: NeuroforgeCPUThrottlingHigh
        expr: |
          rate(container_cpu_cfs_throttled_seconds_total{container!=""}[5m])
          /
          rate(container_cpu_cfs_periods_total{container!=""}[5m]) > 0.25
        for: 10m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Высокое CPU throttling"
          description: "Более 25% периодов CFS были throttled за 5 минут."
          runbook_url: "https://your.runbooks/kubernetes/cpu-throttling"

      # Память близка к лимиту (если лимит задан)
      - alert: NeuroforgeMemoryLimitApproaching
        expr: |
          (container_memory_working_set_bytes{container!=""}
           /
           container_spec_memory_limit_bytes{container!=""} ) > 0.9
        for: 10m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Использование памяти > 90% лимита"
          description: "Рабочее множество памяти контейнера превышает 90% установленного лимита."
          runbook_url: "https://your.runbooks/kubernetes/memory"

      # CPU > 80% от requests (если requests заданы)
      - alert: NeuroforgeCPUUsageOverRequests
        expr: |
          sum by (namespace, pod) (rate(container_cpu_usage_seconds_total{container!=""}[5m]))
          /
          sum by (namespace, pod) (kube_pod_container_resource_requests{resource="cpu",unit="core"}) > 0.8
        for: 10m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "CPU > 80% от request"
          description: "Суммарное использование CPU по поду превышает 80% от заявленных requests."
          runbook_url: "https://your.runbooks/kubernetes/cpu-requests"

  # ================================ STORAGE ===================================
  - name: neuroforge.storage.alerts
    interval: 1m
    rules:
      # Заполнение PVC
      - alert: NeuroforgePVCFillingUp
        expr: |
          (kubelet_volume_stats_used_bytes
           /
           kubelet_volume_stats_capacity_bytes) > 0.85
        for: 15m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "PVC заполнен более чем на 85%"
          description: "Использование тома превышает 85% от доступной ёмкости."
          runbook_url: "https://your.runbooks/kubernetes/pvc-usage"

      - alert: NeuroforgePVCAlmostFull
        expr: |
          (kubelet_volume_stats_used_bytes
           /
           kubelet_volume_stats_capacity_bytes) > 0.95
        for: 5m
        labels:
          severity: critical
          service: neuroforge
          team: core-platform
        annotations:
          summary: "PVC почти заполнен (>95%)"
          description: "Необходима немедленная реакция: увеличение тома/очистка данных."
          runbook_url: "https://your.runbooks/kubernetes/pvc-usage"

      # Проблемный статус PVC
      - alert: NeuroforgePVCAbnormal
        expr: |
          kube_persistentvolumeclaim_status_phase{phase=~"Pending|Lost|Failed"} == 1
        for: 10m
        labels:
          severity: critical
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Аномальный статус PVC"
          description: "PVC находится в состоянии Pending/Lost/Failed."
          runbook_url: "https://your.runbooks/kubernetes/pvc-state"

  # ================================ SCALING ===================================
  - name: neuroforge.scaling.alerts
    interval: 30s
    rules:
      - alert: NeuroforgeHPAUnableToScale
        expr: |
          max_over_time(kube_horizontalpodautoscaler_status_condition{condition="AbleToScale",status="false"}[10m]) == 1
        for: 10m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "HPA не может масштабироваться"
          description: "kube_horizontalpodautoscaler сообщает AbleToScale=false более 10 минут."
          runbook_url: "https://your.runbooks/kubernetes/hpa"

  # ============================== CERTIFICATES =================================
  - name: neuroforge.certificates.alerts
    interval: 1h
    rules:
      - alert: NeuroforgeCertificateExpiringSoon
        expr: |
          (certmanager_certificate_expiration_timestamp_seconds - time()) < 7*24*3600
        for: 0m
        labels:
          severity: warning
          service: neuroforge
          team: core-platform
        annotations:
          summary: "Сертификат скоро истекает (<7 дней)"
          description: "cert-manager сообщает об истечении срока действия сертификата в ближайшие 7 дней."
          runbook_url: "https://your.runbooks/platform/certificates"
