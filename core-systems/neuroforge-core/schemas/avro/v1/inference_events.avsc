{
  "type": "record",
  "name": "InferenceEvent",
  "namespace": "neuroforge.inference.v1",
  "doc": "Единая запись события инференса: запрос/ответ/ошибка/агрегаты. Без хранения PII: входы и ответы — только как отпечатки или ссылки.",
  "fields": [
    {
      "name": "schema_version",
      "type": "string",
      "doc": "Версия схемы события (семантическая).",
      "default": "1.0.0"
    },
    {
      "name": "event_id",
      "type": { "type": "string", "logicalType": "uuid" },
      "doc": "Глобальный идентификатор события (UUID v4)."
    },
    {
      "name": "event_time",
      "type": { "type": "long", "logicalType": "timestamp-millis" },
      "doc": "Время возникновения события в UTC."
    },
    {
      "name": "event_type",
      "type": {
        "type": "enum",
        "name": "EventType",
        "doc": "Тип события инференса.",
        "symbols": [ "REQUEST", "RESPONSE", "ERROR", "BATCH_SUMMARY", "MODEL_LOAD", "MODEL_UNLOAD", "HEALTH", "WARMUP" ]
      },
      "doc": "Классификация события."
    },

    {
      "name": "deployment",
      "type": {
        "type": "record",
        "name": "DeploymentInfo",
        "doc": "Контекст деплоймента/инстанса, исполнившего событие.",
        "fields": [
          { "name": "service_name",  "type": "string", "doc": "Логическое имя сервиса (напр., neuroforge-core)." },
          { "name": "environment",   "type": "string", "doc": "Окружение: prod/staging/dev/…", "default": "prod" },
          { "name": "region",        "type": "string", "doc": "Регион/локализация (например, eu-north-1).", "default": "" },
          { "name": "zone",          "type": "string", "doc": "Зона/availability zone.", "default": "" },
          { "name": "instance_id",   "type": "string", "doc": "ID инстанса/Pod/VM.", "default": "" },
          { "name": "pod_name",      "type": "string", "doc": "Если k8s — имя Pod.", "default": "" },
          { "name": "node_name",     "type": "string", "doc": "Имя узла/ноды.", "default": "" },
          { "name": "container_id",  "type": "string", "doc": "ID контейнера (усечённый).", "default": "" },
          { "name": "labels",        "type": { "type": "map", "values": "string" }, "doc": "Доп. метки деплоймента.", "default": {} }
        ]
      }
    },

    {
      "name": "model",
      "type": {
        "type": "record",
        "name": "ModelInfo",
        "doc": "Идентификация модели и окружения выполнения.",
        "fields": [
          { "name": "model_name",   "type": "string", "doc": "Имя/семейство модели (логическое)." },
          { "name": "model_version","type": "string", "doc": "Версия модели (семвёр/commit/sha).", "default": "" },
          { "name": "model_uri",    "type": [ "null", "string" ], "doc": "URI артефакта модели (s3://…/model.bin, mlflow://…)", "default": null },
          {
            "name": "task",
            "type": {
              "type": "enum",
              "name": "TaskType",
              "symbols": [ "CLASSIFICATION", "REGRESSION", "GENERATION", "EMBEDDING", "DETECTION", "SEGMENTATION", "RERANK", "OTHER" ]
            },
            "doc": "Тип задачи."
          },
          {
            "name": "framework",
            "type": {
              "type": "enum",
              "name": "Framework",
              "symbols": [ "PYTORCH", "TENSORFLOW", "XGBOOST", "SKLEARN", "LIGHTGBM", "CUSTOM", "UNKNOWN" ]
            },
            "doc": "Фреймворк выполнения."
          },
          { "name": "signature", "type": "string", "doc": "Сигнатура/схема входов/выходов (json/schema id).", "default": "" },
          { "name": "image",     "type": "string", "doc": "Контейнерный образ среды выполнения.", "default": "" },
          { "name": "labels",    "type": { "type": "map", "values": "string" }, "doc": "Метки/тэги модели.", "default": {} },
          { "name": "params",    "type": { "type": "map", "values": "string" }, "doc": "Ключевые параметры инференса (температура, top_k и пр.) без PII.", "default": {} }
        ]
      }
    },

    {
      "name": "client",
      "type": [
        "null",
        {
          "type": "record",
          "name": "ClientInfo",
          "doc": "Нефрагментная информация о клиенте без PII.",
          "fields": [
            { "name": "sdk_name",         "type": "string", "default": "", "doc": "Имя клиентского SDK." },
            { "name": "sdk_version",      "type": "string", "default": "", "doc": "Версия SDK." },
            { "name": "user_agent_hash",  "type": "string", "default": "", "doc": "Хэш User-Agent (SHA256 hex)." },
            { "name": "client_ip_hash",   "type": "string", "default": "", "doc": "Хэш IP (SHA256/Trunc). Не хранит исходный IP." },
            { "name": "geo_country",      "type": "string", "default": "", "doc": "Код страны (ISO 3166-1 alpha-2), если доступен." },
            { "name": "asn",              "type": "int",    "default": 0,  "doc": "Autonomous System Number, если доступен." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "security",
      "type": [
        "null",
        {
          "type": "record",
          "name": "SecurityContext",
          "doc": "Контекст аутентификации/авторизации.",
          "fields": [
            {
              "name": "auth_type",
              "type": {
                "type": "enum",
                "name": "AuthType",
                "symbols": [ "ANON", "API_KEY", "OIDC", "SERVICE", "BASIC", "MTLS" ]
              },
              "doc": "Тип аутентификации."
            },
            { "name": "principal",     "type": "string", "default": "", "doc": "Идентификатор субъекта (tenant/user/service), без PII." },
            { "name": "principal_type","type": "string", "default": "", "doc": "Тип субъекта (user/service/tenant)." },
            { "name": "scopes",        "type": { "type": "array", "items": "string" }, "default": [], "doc": "Выданные скоупы/роли." },
            { "name": "api_key_id",    "type": [ "null", "string" ], "default": null, "doc": "ID ключа API (усечённый), если применимо." },
            { "name": "mfa",           "type": [ "null", "boolean" ], "default": null, "doc": "Признак MFA." }
          ]
        }
      ],
      "default": null
    },

    { "name": "pii_redacted", "type": "boolean", "default": true, "doc": "Гарантируется, что полезные данные очищены от PII." },

    { "name": "labels", "type": { "type": "map", "values": "string" }, "default": {}, "doc": "Свободные метки (ключ-значение) для маршрутизации/аналитики." },

    {
      "name": "trace",
      "type": [
        "null",
        {
          "type": "record",
          "name": "TraceContext",
          "doc": "Контекст трассировки (W3C).",
          "fields": [
            { "name": "trace_id",        "type": "string", "doc": "Trace ID (16 байт/32 hex)." },
            { "name": "span_id",         "type": "string", "default": "", "doc": "Span ID (8 байт/16 hex)." },
            { "name": "parent_span_id",  "type": [ "null", "string" ], "default": null, "doc": "Родительский span ID." },
            { "name": "correlation_id",  "type": [ "null", "string" ], "default": null, "doc": "Внешняя корреляция/Request-ID." },
            { "name": "sampling_rate",   "type": [ "null", "float" ],  "default": null, "doc": "Доля сэмплирования (0..1)." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "request",
      "type": [
        "null",
        {
          "type": "record",
          "name": "RequestInfo",
          "doc": "Метаданные запроса инференса (без содержимого).",
          "fields": [
            { "name": "route",               "type": "string", "default": "", "doc": "Логическое имя метода/эндпойнта." },
            { "name": "content_type",        "type": "string", "default": "application/octet-stream", "doc": "MIME тип входа." },
            { "name": "content_length_bytes","type": "long",   "default": 0,  "doc": "Размер входа в байтах (после редактирования/токенизации)." },
            { "name": "batch_size",          "type": "int",    "default": 1,  "doc": "Размер батча запроса." },
            { "name": "timeout_ms",          "type": [ "null", "int" ], "default": null, "doc": "Таймаут инференса, если задан." },
            { "name": "input_fingerprint",   "type": "string", "default": "", "doc": "SHA256 входа (hex), вместо хранения самого входа." },
            { "name": "input_schema_ref",    "type": [ "null", "string" ], "default": null, "doc": "Ссылка на схему входа (URI/id)." },
            { "name": "parameters",          "type": { "type": "map", "values": "string" }, "default": {}, "doc": "Параметры инференса (температура, top_p и пр.)." },
            { "name": "prompt_tokens",       "type": [ "null", "int" ], "default": null, "doc": "LLM: число токенов промпта." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "response",
      "type": [
        "null",
        {
          "type": "record",
          "name": "ResponseInfo",
          "doc": "Метаданные результата инференса (без PII/сырых ответов).",
          "fields": [
            { "name": "status_code",        "type": "int", "default": 0,  "doc": "HTTP/gRPC статус (нормирован)." },
            { "name": "success",            "type": "boolean", "default": true, "doc": "Итог успеха операции." },
            { "name": "latency_ms",         "type": "int", "default": 0,  "doc": "end-to-end задержка (мс)." },
            { "name": "queue_time_ms",      "type": [ "null", "int" ], "default": null, "doc": "Ожидание в очереди (мс)." },
            { "name": "model_time_ms",      "type": [ "null", "int" ], "default": null, "doc": "Время выполнения модели (мс)." },
            { "name": "batch_size",         "type": "int", "default": 1, "doc": "Размер батча для ответа." },
            { "name": "output_size_bytes",  "type": "long", "default": 0, "doc": "Размер ответа (байты)." },
            { "name": "output_fingerprint", "type": "string", "default": "", "doc": "SHA256 ответа (hex)." },
            { "name": "output_ref",         "type": [ "null", "string" ], "default": null, "doc": "Ссылка на сохранённый результат (s3://…)." },
            {
              "name": "predictions",
              "type": [ "null", {
                "type": "array",
                "items": {
                  "type": "record",
                  "name": "Prediction",
                  "doc": "Универсальная запись предсказания.",
                  "fields": [
                    { "name": "label",    "type": "string", "default": "", "doc": "Класс/метка/токен." },
                    { "name": "score",    "type": "double", "default": 0.0, "doc": "Счёт/вероятность/логит." },
                    { "name": "rank",     "type": "int",    "default": 0,   "doc": "Позиция результата (top-K)." },
                    { "name": "class_id", "type": [ "null", "int" ], "default": null, "doc": "ID класса (если есть)." },
                    { "name": "metadata", "type": { "type": "map", "values": "string" }, "default": {}, "doc": "Доп. поля (bbox и т. п.) в сериализованном виде." }
                  ]
                }
              }],
              "default": null
            },
            { "name": "completion_tokens",  "type": [ "null", "int" ], "default": null, "doc": "LLM: токены ответа." },
            { "name": "total_tokens",       "type": [ "null", "int" ], "default": null, "doc": "LLM: общее число токенов." },
            { "name": "cached",             "type": "boolean", "default": false, "doc": "Ответ из кэша." },
            { "name": "cache_key",          "type": [ "null", "string" ], "default": null, "doc": "Ключ кэша (усечённый/хэш)." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "error",
      "type": [
        "null",
        {
          "type": "record",
          "name": "ErrorInfo",
          "doc": "Ошибка инференса/валидации.",
          "fields": [
            { "name": "code",       "type": "string", "default": "", "doc": "Код ошибки (машиночитаемый)." },
            { "name": "message",    "type": "string", "default": "", "doc": "Краткое описание." },
            { "name": "retriable",  "type": "boolean", "default": false, "doc": "Можно ли повторить запрос." },
            { "name": "phase",      "type": "string", "default": "", "doc": "Фаза (ingest/queue/model/io)."},
            { "name": "stacktrace", "type": [ "null", "string" ], "default": null, "doc": "Стек (усечён/санитизирован)." },
            { "name": "details",    "type": { "type": "map", "values": "string" }, "default": {}, "doc": "Ключевые детали." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "batch",
      "type": [
        "null",
        {
          "type": "record",
          "name": "BatchSummary",
          "doc": "Агрегированная статистика батча.",
          "fields": [
            { "name": "batch_id",         "type": "string", "default": "", "doc": "Идентификатор батча." },
            { "name": "batch_size",       "type": "int",    "default": 0,  "doc": "Объём." },
            { "name": "succeeded",        "type": "int",    "default": 0,  "doc": "Успешных." },
            { "name": "failed",           "type": "int",    "default": 0,  "doc": "Неуспешных." },
            { "name": "latency_p50_ms",   "type": "int",    "default": 0,  "doc": "p50 задержки." },
            { "name": "latency_p95_ms",   "type": "int",    "default": 0,  "doc": "p95 задержки." },
            { "name": "latency_p99_ms",   "type": "int",    "default": 0,  "doc": "p99 задержки." },
            { "name": "window_start",     "type": [ "null", { "type": "long", "logicalType": "timestamp-millis" } ], "default": null, "doc": "Начало окна." },
            { "name": "window_end",       "type": [ "null", { "type": "long", "logicalType": "timestamp-millis" } ], "default": null, "doc": "Конец окна." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "metrics",
      "type": [
        "null",
        {
          "type": "array",
          "items": {
            "type": "record",
            "name": "Metric",
            "doc": "Свободные числовые метрики события.",
            "fields": [
              { "name": "name",   "type": "string", "doc": "Имя метрики (Prometheus-совместимое)." },
              { "name": "value",  "type": "double", "doc": "Значение." },
              { "name": "labels", "type": { "type": "map", "values": "string" }, "default": {}, "doc": "Метки метрики." },
              { "name": "time",   "type": [ "null", { "type": "long", "logicalType": "timestamp-millis" } ], "default": null, "doc": "Момент измерения, если отличается от event_time." }
            ]
          }
        }
      ],
      "default": null
    },

    {
      "name": "cost",
      "type": [
        "null",
        {
          "type": "record",
          "name": "CostInfo",
          "doc": "Затраты выполнения (LLM/общее). Денежные значения — в микро-единицах для избежания дробной ошибки.",
          "fields": [
            { "name": "currency",        "type": "string", "default": "USD", "doc": "Валюта." },
            { "name": "amount_micros",   "type": "long",   "default": 0,     "doc": "Стоимость в микро-единицах валюты." },
            { "name": "compute_ms",      "type": "long",   "default": 0,     "doc": "Суммарное compute-время (мс)." },
            { "name": "gpu_ms",          "type": "long",   "default": 0,     "doc": "GPU-миллисекунды." }
          ]
        }
      ],
      "default": null
    },

    {
      "name": "extensions",
      "type": { "type": "map", "values": "bytes" },
      "doc": "Расширения (байтовые payload’ы по ключу). Значения — base64 в JSON.",
      "default": {}
    }
  ]
}
