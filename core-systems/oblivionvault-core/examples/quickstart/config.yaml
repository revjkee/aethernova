# OblivionVault Quickstart Configuration (industrial)
# Schema: 1.0  | Encoding: UTF-8  | All timestamps: UTC (RFC3339)
# Внимание: не храните секреты в этом файле. Используйте переменные окружения.

schema_version: "1.0"
application: "oblivionvault-core"
description: "Production-grade quickstart config with secure defaults and env profiles"

defaults: &defaults
  time:
    timezone: "UTC"                 # Все операции во времени выполняются в UTC
    rfc3339_timespec: "milliseconds"
    coarse_now_cache_ms: 250

  env:                               # Имена переменных окружения для интеграции
    OPENSSL_PATH: "${OPENSSL_PATH:openssl}"
    KMS_BACKEND: "${OBLIVIONVAULT_KMS_BACKEND:openssl-rsa}"
    KMS_KEY_ID: "${OBLIVIONVAULT_KMS_KEY_ID:ovault-default}"
    KMS_PUB_PEM: "${OBLIVIONVAULT_KMS_PUB_PEM:keys/ovault-default.pub.pem}"
    KMS_PRIV_PEM: "${OBLIVIONVAULT_KMS_PRIV_PEM:keys/ovault-default.priv.pem}"
    EVIDENCE_ENC_PASS_ENV: "${OV_EVIDENCE_ENC_PASS:OV_EVIDENCE_ENC_PASS}"  # имя env с паролем
    LOG_LEVEL: "${OV_LOG_LEVEL:INFO}"

  paths:
    base_dir: "./"                   # Корень проекта
    output_dir: "./.out"             # Для пакетов/логов
    tmp_dir: "./.tmp"
    key_dir: "./keys"
    create_missing: true
    umask: "077"                     # Закрытые права по умолчанию (эквивалент 0o077)

  security:
    run_as_user: "ovault"            # Оставьте пустым если не используете смену пользователя
    run_as_group: "ovault"
    fs_permissions:
      output_dir_mode: "0700"
      tmp_dir_mode: "0700"
    openssl_path: "${OPENSSL_PATH:openssl}"
    allow_core_dumps: false

  logging:
    level: "${OV_LOG_LEVEL:INFO}"    # DEBUG/INFO/WARN/ERROR
    json: false
    console: true
    file:
      enabled: true
      path: "./.out/ovault.log"
      max_bytes: 10485760            # 10 MiB
      backups: 5

  observability:
    metrics:
      enabled: false
      bind: "127.0.0.1:9108"
    tracing:
      enabled: false
      otlp_endpoint: "http://127.0.0.1:4318"

  kms:
    backend: "${OBLIVIONVAULT_KMS_BACKEND:openssl-rsa}"
    key_id: "${OBLIVIONVAULT_KMS_KEY_ID:ovault-default}"
    pub_pem: "${OBLIVIONVAULT_KMS_PUB_PEM:keys/ovault-default.pub.pem}"
    priv_pem: "${OBLIVIONVAULT_KMS_PRIV_PEM:keys/ovault-default.priv.pem}"  # для unwrap/decrypt
    wrap_algo: "RSA-OAEP-SHA256"
    openssl_path: "${OPENSSL_PATH:openssl}"
    rotation:
      enabled: true
      interval: "90d"                # период ротации логического ключа
      rewrap_on_rotate: true         # переворачивание конвертов под новый ключ
    signing:
      enabled: false                 # опционально (подписи в kms_adapter по необходимости)

  envelope:
    cipher: "AES-256-CTR+HMAC-SHA256"
    hkdf_info: "OblivionVault-Envelope-v1"
    aad_defaults:
      component: "quickstart"
      schema: "1.0"
    ttl: "0s"                        # 0s = без срока истечения на уровне конверта

  evidence:
    package_name_prefix: "ovault"
    compression: "xz"                # xz|gz|bz2|none
    include_hidden: false
    follow_symlinks: false
    exclude:
      - "**/.git/**"
      - "**/.env"
      - "**/.venv/**"
      - "**/__pycache__/**"
      - "**/*.log"
      - "**/*.tmp"
      - "**/*.swp"
    hashing_workers: 4
    chain_of_custody:
      initial:
        - action: "COLLECTION_PLANNED"
          note: "Quickstart default"
    policies:
      retention: "365d"
      classification: "restricted"   # public/internal/restricted/secret
      export_allowed: false
    signing:
      enabled: false
      private_key: "keys/ovault-manifest-signing.priv.pem"
      certificate: "keys/ovault-manifest-signing.cert.pem"
    encryption:
      enabled: false
      pass_env: "OV_EVIDENCE_ENC_PASS"
      cipher: "aes-256-cbc"          # OpenSSL enc cipher
    sidecar_sha256: true

  cli_presets:
    # Готовые пресеты для oblivionvault-admin
    envelope_encrypt:
      input: "-"                     # stdin
      output: "-"                    # stdout
      key_id: "${OBLIVIONVAULT_KMS_KEY_ID:ovault-default}"
      aad:
        - "component=quickstart"
        - "purpose=demo"
    envelope_decrypt:
      input: "-"
      output: "-"
    evidence_pack:
      output: "./.out/evidence.tar.xz"
      name: "quickstart"
      compression: "xz"
      include_hidden: false
      follow_symlinks: false

profiles:
  # Профили окружений: наследуются от defaults и переопределяют только отличия
  dev:
    <<: *defaults
    logging:
      level: "DEBUG"
      json: false
    evidence:
      exclude:
        - "**/.git/**"
        - "**/.env"
        - "**/.venv/**"
        - "**/__pycache__/**"
        - "**/*.log"
        - "**/*.tmp"
        - "**/*.swp"
      signing:
        enabled: false
      encryption:
        enabled: false
      hashing_workers: 2
    kms:
      rotation:
        enabled: true
        interval: "180d"             # реже в dev
        rewrap_on_rotate: false

  staging:
    <<: *defaults
    logging:
      level: "INFO"
      json: true
    evidence:
      signing:
        enabled: true
      encryption:
        enabled: true
        pass_env: "OV_EVIDENCE_ENC_PASS"
        cipher: "aes-256-cbc"
      sidecar_sha256: true
    kms:
      rotation:
        enabled: true
        interval: "90d"
        rewrap_on_rotate: true

  prod:
    <<: *defaults
    logging:
      level: "INFO"
      json: true
      console: false
      file:
        enabled: true
        path: "./.out/ovault.prod.log"
        max_bytes: 20971520          # 20 MiB
        backups: 10
    security:
      fs_permissions:
        output_dir_mode: "0700"
        tmp_dir_mode: "0700"
      allow_core_dumps: false
    evidence:
      signing:
        enabled: true
      encryption:
        enabled: true
        pass_env: "OV_EVIDENCE_ENC_PASS"
        cipher: "aes-256-cbc"
      sidecar_sha256: true
      policies:
        retention: "1825d"           # 5 лет
        classification: "restricted"
        export_allowed: false
    kms:
      rotation:
        enabled: true
        interval: "60d"
        rewrap_on_rotate: true

# Подсказка по применению (комментарий):
#   DEV:     oblivionvault-admin info system
#   KMS gen: oblivionvault-admin kms gen-keypair --outdir ./keys --key-id ovault-default --bits 4096
#   Pack:    oblivionvault-admin evidence pack -i ./README.md -o ./.out/evidence.tar.xz -n quickstart
#   Verify:  oblivionvault-admin evidence verify ./.out/evidence.tar.xz
#   EnvEnc:  oblivionvault-admin envelope encrypt -i - -o - --aad component=quickstart
