# oblivionvault-core/configs/evidence.yaml
schemaVersion: "1.0.0"
metadata:
  project: "oblivionvault-core"
  environment: "staging"   # prod/staging/dev
  owner: "Platform-Security & SRE"
  lastReviewedBy: "compliance@oblivionvault.example"
  reviewCadence: "quarterly"
  frameworks:
    - name: "SOC 2"
      scope: ["Security","Availability","Confidentiality"]
    - name: "ISO 27001"
      scope: ["A.5","A.8","A.12","A.14","A.16","A.18"]
    - name: "NIST CSF"
      scope: ["ID","PR","DE","RS","RC"]
    - name: "PCI-DSS"
      scope: ["Req 1","Req 10","Req 11"] # при необходимости
  dataClassification:
    - name: "PUBLIC"
    - name: "INTERNAL"
    - name: "CONFIDENTIAL"
    - name: "RESTRICTED"
  integrity:
    hashing:
      defaultAlgo: "sha3-512"
      perArtifactOverrides:
        - pattern: "*.sbom.json"
          algo: "sha256"
    signing:
      gpg:
        enable: true
        keyringRef: "awskms:alias/ovc-compliance-sign"   # или путь к GPG
        signingMode: "detached"
      cosign:
        enable: true
        keyRef: "awskms:///alias/ovc-cosign"
      inToto:
        enable: true
        layoutRef: "supplychain/in-toto.layout.json"
    notarization:
      enable: true
      provider: "rekor"   # transparency log
      endpoint: "https://rekor.sigstore.dev"
  storagePolicy:
    primary:
      type: "s3"
      bucket: "ovc-evidence-prod"          # для prod поменять
      prefix: "staging/"
      kmsKey: "arn:aws:kms:eu-north-1:111111111111:key/xxxxxxxx"
      objectLock:
        mode: "COMPLIANCE"
        retentionDays: 365
    secondary:
      type: "s3"
      bucket: "ovc-evidence-dr"
      prefix: "staging/"
      replication: true
  retentionDefaults:
    standardDays: 365
    criticalDays: 1095
    vulnerabilityReportDays: 365
  deliverySLA:
    standardMinutes: 60      # в течение часа после события
    criticalMinutes: 15
  access:
    readers:
      - "role/compliance-readonly"
      - "role/auditor-external"
    writers:
      - "role/ovc-evidence-writer"
    approvers:
      - "role/CISO"
      - "role/Head-of-SRE"
  runbooksBaseURL: "https://runbooks.example.com/oblivionvault-core"
  dashboards:
    grafanaBaseURL: "https://grafana.example.com"
    ids:
      - "ovc-sre-main"
      - "ovc-security-main"

collectors:
  # Конфигурация агентов/пайплайнов, которые реально вытягивают артефакты
  - id: "collector-cloudtrail"
    type: "aws-cloudtrail"
    schedule: "rate(5 minutes)"
    delivery:
      target: "primary"
    transform:
      format: "jsonl"
      redact:
        enabled: true
        fields: ["requestParameters.credentials","responseElements.SecretString"]
  - id: "collector-k8s-audit"
    type: "k8s-audit"
    schedule: "rate(5 minutes)"
    delivery:
      target: "primary"
    transform:
      format: "jsonl"
  - id: "collector-ci"
    type: "github-actions"
    schedule: "cron(*/15 * * * *)"
    delivery:
      target: "primary"
  - id: "collector-scan"
    type: "vuln-scanners"
    schedule: "cron(0 */6 * * *)"
    delivery:
      target: "primary"

evidence:
  # ------------------- SECURITY -------------------
  - id: "SEC-001-CloudTrail-All-Regions"
    name: "CloudTrail: полный журнал API"
    category: "Security"
    controls:
      - "SOC2-CC7.2"
      - "ISO27001-A.12.4"
      - "NIST-DE.AE-3"
    source:
      collectorRef: "collector-cloudtrail"
      query:
        filter: 'eventSource !~ "health.amazonaws.com"'
      regions: ["eu-north-1","eu-west-1","us-east-1"]
    storage:
      uri: "s3://ovc-evidence-prod/staging/security/cloudtrail/{YYYY}/{MM}/{DD}/cloudtrail.jsonl"
      classification: "INTERNAL"
      retentionDays: 365
      worm: true
    integrity:
      sign: true
      notarize: true
    sla:
      deliverWithinMinutes: 60
    approvers: ["role/CISO","role/SecOps-Lead"]
    runbook: "security/cloudtrail"

  - id: "SEC-002-K8s-Audit-Logs"
    name: "K8s audit: все события API EKS"
    category: "Security"
    controls: ["ISO27001-A.12.4","SOC2-CC7.2"]
    source:
      collectorRef: "collector-k8s-audit"
      cluster: "oblivionvault-core-staging"
    storage:
      uri: "s3://ovc-evidence-prod/staging/security/k8s-audit/{YYYY}/{MM}/{DD}/audit.jsonl"
      retentionDays: 365
      worm: true
    integrity:
      sign: true
      notarize: true
    sla:
      deliverWithinMinutes: 15
    approvers: ["role/SecOps-Lead"]
    runbook: "security/k8s-audit"

  - id: "SEC-003-Access-Reviews-Quarterly"
    name: "Квартальный доступ: AWS/IAM/K8s/Git"
    category: "Security"
    controls: ["SOC2-CC6.1","ISO27001-A.9.2"]
    source:
      type: "manual-attestation"
      inputs:
        - "aws-iam-user-list.csv"
        - "rbac-k8s-dump.yaml"
        - "github-org-members.csv"
    schedule: "cron(0 8 1 JAN,APR,JUL,OCT *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/security/access-reviews/{YYYY-Q}/package.zip"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
      notarize: true
    approvers: ["role/CISO","role/HR-Compliance"]
    runbook: "security/access-review"

  - id: "SEC-004-Secrets-Rotation-Report"
    name: "Ротация секретов/KMS/DB/Redis"
    category: "Security"
    controls: ["ISO27001-A.10.1","SOC2-CC6.6"]
    source:
      type: "script"
      command: "ovc-tools rotation-report --env=staging --output=json"
    schedule: "cron(0 3 * * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/security/rotation/{YYYY}/{MM}/report.json"
      retentionDays: 365
    integrity:
      sign: true
    approvers: ["role/SecOps-Lead"]
    runbook: "security/secrets-rotation"

  # ------------------- RELIABILITY / SRE -------------------
  - id: "SRE-001-SLO-ErrorBudget"
    name: "SLO: error budget burn (multi-window)"
    category: "Reliability"
    controls: ["SOC2-CC7.3","ISO27001-A.12.1"]
    source:
      type: "prometheus"
      query:
        expr: ':ovc:error_budget_burn:long'
      endpoint: "https://prometheus.internal:9090"
    schedule: "cron(*/5 * * * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/reliability/slo/error-budget/{YYYY}/{MM}/{DD}/burn.json"
      retentionDays: 365
    integrity:
      sign: true
    sla:
      deliverWithinMinutes: 15
    runbook: "sre/slo-error-budget"

  - id: "SRE-002-Backup-Drills-Report"
    name: "Отчеты бэкапов и DR-дриллов (RPO/RTO)"
    category: "Reliability"
    controls: ["SOC2-CC7.1","ISO27001-A.12.3","ISO27001-A.17.1"]
    source:
      type: "aggregate"
      inputs:
        - "rds-snapshots.json"
        - "redis-backup-state.json"
        - "restore-job-logs.jsonl"
      generator: "ovc-tools backup-verify --env=staging --report json"
    schedule: "cron(0 4 * * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/reliability/backup-dr/{YYYY}/{MM}/report.json"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
      notarize: true
    approvers: ["role/Head-of-SRE"]
    runbook: "sre/backup-dr"

  - id: "SRE-003-Incident-Postmortems"
    name: "Постмортемы инцидентов (SEV1-3)"
    category: "Reliability"
    controls: ["SOC2-CC7.4","ISO27001-A.16.1"]
    source:
      type: "manual-attestation"
      inputs: ["postmortem.md","timeline.csv","prom-snap.json","grafana-pngs.zip"]
    trigger: "on-incident-closure"
    storage:
      uri: "s3://ovc-evidence-prod/staging/reliability/incidents/{INCIDENT_ID}/package.zip"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
      notarize: true
    approvers: ["role/Head-of-SRE","role/CISO"]
    runbook: "sre/postmortem"

  # ------------------- CHANGE / SDLC / SUPPLY CHAIN -------------------
  - id: "CHG-001-CI-CD-Provenance"
    name: "Provenance артефактов (SLSA/in-toto)"
    category: "Change"
    controls: ["ISO27001-A.14.2","SOC2-CC8.1"]
    source:
      type: "ci-cd"
      system: "github-actions"
      artifacts:
        - "*.container.image.digest"
        - "*.sbom.json"
        - "attestations/*.intoto.jsonl"
    schedule: "on-each-release"
    storage:
      uri: "s3://ovc-evidence-prod/staging/change/provenance/{RELEASE_TAG}/"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
      notarize: true
    approvers: ["role/Release-Manager","role/CISO"]
    runbook: "supply-chain/provenance"

  - id: "CHG-002-Code-Review-Trace"
    name: "Трейс обзоров кода и политик веток"
    category: "Change"
    controls: ["SOC2-CC8.1","ISO27001-A.14.2.8"]
    source:
      type: "vcs"
      provider: "github"
      queries:
        - "protected-branches.json"
        - "merge-checks.json"
        - "reviews-export.jsonl"
    schedule: "cron(0 2 * * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/change/code-review/{YYYY}/{MM}/{DD}/bundle.zip"
      retentionDays: 365
    integrity:
      sign: true
    approvers: ["role/Head-of-Engineering"]
    runbook: "sdlc/code-review"

  - id: "CHG-003-Vulnerability-Reports"
    name: "Единый отчет уязвимостей (SCA/SAST/DAST/IaC)"
    category: "Change"
    controls: ["ISO27001-A.12.6","SOC2-CC7.1"]
    source:
      collectorRef: "collector-scan"
      scanners:
        - "trivy-sca.json"
        - "semgrep-sast.sarif"
        - "zap-dast.json"
        - "tfsec-iac.json"
    storage:
      uri: "s3://ovc-evidence-prod/staging/change/vuln/{YYYY}/{MM}/{DD}/report.zip"
      retentionDays: 365
    integrity:
      sign: true
    sla:
      deliverWithinMinutes: 60
    approvers: ["role/AppSec-Lead"]
    runbook: "appsec/vulnerability-management"

  # ------------------- DATA / PRIVACY -------------------
  - id: "DATA-001-DLP-Scan"
    name: "DLP‑скан: утечки PII в репозиториях/логах"
    category: "Data"
    controls: ["ISO27001-A.18.1","SOC2-Confidentiality"]
    source:
      type: "dlp"
      tools: ["gitleaks","custom-dlp"]
      scope:
        - "github://org/oblivionvault/*"
        - "s3://ovc-logs/*"
    schedule: "cron(0 */12 * * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/data/dlp/{YYYY}/{MM}/{DD}/results.json"
      retentionDays: 365
    integrity:
      sign: true
    approvers: ["role/Data-Protection-Officer"]
    runbook: "privacy/dlp"

  - id: "DATA-002-Records-of-Processing"
    name: "Реестр операций обработки (RoPA)"
    category: "Data"
    controls: ["ISO27001-A.18.1","GDPR-Article30"]
    source:
      type: "manual-attestation"
      inputs: ["ropa.xlsx","dpa-register.csv"]
    schedule: "cron(0 9 1 * *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/data/ropa/{YYYY}/{MM}/bundle.zip"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
    approvers: ["role/DPO","role/CISO"]
    runbook: "privacy/ropa"

  # ------------------- VENDOR / RISK -------------------
  - id: "VRM-001-Vendor-Risk-Assessments"
    name: "Оценки рисков поставщиков и статусы DPA"
    category: "Vendor"
    controls: ["ISO27001-A.15","SOC2-CC3.1"]
    source:
      type: "manual-attestation"
      inputs: ["vendor-risk.xlsx","dpa-status.csv","soc2-reports/*"]
    schedule: "cron(0 10 1 JAN,APR,JUL,OCT *)"
    storage:
      uri: "s3://ovc-evidence-prod/staging/vendor/risk/{YYYY-Q}/package.zip"
      retentionDays: 1095
      worm: true
    integrity:
      sign: true
      notarize: true
    approvers: ["role/Procurement-Lead","role/CISO"]
    runbook: "vendor/risk-management"

validators:
  # Автоматические проверки полноты и целостности
  - id: "VAL-001-hash-and-signature"
    type: "integrity"
    policy:
      requireSignature: true
      requireHashAlgo: "sha3-512"
      requireNotarizationFor:
        - categories: ["Security","Reliability","Vendor"]
  - id: "VAL-002-sla"
    type: "timeliness"
    policy:
      failIfDeliveryExceedsMinutes:
        standard: 60
        critical: 15
  - id: "VAL-003-retention-vs-classification"
    type: "retention"
    policy:
      minRetentionDays:
        CONFIDENTIAL: 365
        RESTRICTED: 1095

approvals:
  # Сквозной маршрут согласования пакетов доказательств
  workflows:
    - id: "WF-SEC-CRITICAL"
      match:
        categories: ["Security","Reliability"]
        worm: true
      steps:
        - role: "SecOps-Lead"
        - role: "Head-of-SRE"
        - role: "CISO"
    - id: "WF-STANDARD"
      match:
        categories: ["Change","Data","Vendor"]
      steps:
        - role: "Area-Owner"
        - role: "Compliance-Manager"

auditTrail:
  # Параметры фиксации действий над реестром
  sink:
    type: "cloudtrail+kinesis"
    stream: "ovc-evidence-audittrail"
  fields:
    - "actor"
    - "action"
    - "artifact"
    - "timestamp"
    - "hash"
    - "signature"
    - "notes"
