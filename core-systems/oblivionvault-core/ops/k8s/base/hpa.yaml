apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: oblivionvault-core
  namespace: oblivionvault
  labels:
    app.kubernetes.io/name: oblivionvault-core
    app.kubernetes.io/part-of: oblivionvault
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: gitops
spec:
  # Целевой объект для масштабирования
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: oblivionvault-core

  # Диапазон реплик. Подберите minReplicas >= 3 для устойчивости к сбоям зоны.
  minReplicas: 3
  maxReplicas: 30

  # Метрики: CPU (в %) и память (среднее значение на pod).
  # HPA увеличит реплики, если ЛЮБАЯ из метрик превышает целевое значение.
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70  # целевая загрузка CPU на pod, %
    - type: Resource
      resource:
        name: memory
        target:
          type: AverageValue
          averageValue: "800Mi"   # целевая средняя память на pod

  # Поведение масштабирования: быстро вверх, аккуратно вниз.
  behavior:
    scaleUp:
      # При быстрых всплесках не задерживаем повышение.
      stabilizationWindowSeconds: 0
      selectPolicy: Max
      policies:
        # Разрешаем удвоение парка за минуту, но не более чем +4 pod.
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 4
          periodSeconds: 60
    scaleDown:
      # Стабилизация для предотвращения флаппинга при спадании нагрузки.
      stabilizationWindowSeconds: 300
      selectPolicy: Min
      policies:
        # Срезаем не более 50% парка за минуту и не более 2 pod.
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
