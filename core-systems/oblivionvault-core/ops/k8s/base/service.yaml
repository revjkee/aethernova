apiVersion: v1
kind: Service
metadata:
  name: oblivionvault-core
  # namespace задаётся в оверлеях (kustomize overlays)
  labels:
    app.kubernetes.io/name: oblivionvault-core
    app.kubernetes.io/instance: oblivionvault-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: neurocity
    app.kubernetes.io/version: v0.1.0
    app.kubernetes.io/managed-by: kustomize
    observability.neurocity.io/metrics: "true"
  annotations:
    # Наблюдаемость / Prometheus (может быть переопределено ServiceMonitor‑ом)
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
    # Топологически‑осознанная маршрутизация (с v1.24+)
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: ClusterIP
  # Предпочтительно dual‑stack, работает и в single‑stack кластерах
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  # Порты сервиса
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
      appProtocol: http
    - name: grpc
      port: 9000
      targetPort: 9000
      protocol: TCP
      appProtocol: grpc
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
      appProtocol: http
  # Строгий селектор — должен совпадать с метками Pod/Deployment
  selector:
    app.kubernetes.io/name: oblivionvault-core
    app.kubernetes.io/component: api
