{{- /*
Industrial-grade ServiceMonitor for Prometheus Operator.
Renders only if:
- Values.serviceMonitor.enabled = true
- CRD monitoring.coreos.com/v1/ServiceMonitor is present
*/ -}}
{{- if and .Values.serviceMonitor.enabled (.Capabilities.APIVersions.Has "monitoring.coreos.com/v1/ServiceMonitor") -}}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{- $fn := (include "oblivionvault-core.fullname" .) | default (printf "%s-%s" .Release.Name "oblivionvault-core") -}}{{ $fn }}
  namespace: {{ .Values.serviceMonitor.namespace | default .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/part-of: "oblivionvault-core"
    app.kubernetes.io/component: "monitoring"
    {{- with .Values.commonLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with .Values.serviceMonitor.additionalLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with .Values.serviceMonitor.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- with .Values.serviceMonitor.jobLabel }}
  jobLabel: {{ . | quote }}
  {{- end }}

  # Namespace selection for target Services
  namespaceSelector:
    {{- if .Values.serviceMonitor.namespaceSelector.any }}
    any: true
    {{- else if .Values.serviceMonitor.namespaceSelector.matchNames }}
    matchNames:
      {{- toYaml .Values.serviceMonitor.namespaceSelector.matchNames | nindent 6 }}
    {{- else }}
    matchNames:
      - {{ .Release.Namespace | quote }}
    {{- end }}

  # Selector for target Services (ServiceMonitor -> Service)
  selector:
    {{- if .Values.serviceMonitor.selector }}
    {{- toYaml .Values.serviceMonitor.selector | nindent 4 }}
    {{- else }}
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name | quote }}
      app.kubernetes.io/part-of: "oblivionvault-core"
    {{- end }}

  # Target labels to propagate to scraped metrics
  {{- with .Values.serviceMonitor.targetLabels }}
  targetLabels:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  # Global sample/label limits
  {{- with .Values.serviceMonitor.sampleLimit }}
  sampleLimit: {{ . }}
  {{- end }}
  {{- with .Values.serviceMonitor.labelLimit }}
  labelLimit: {{ . }}
  {{- end }}
  {{- with .Values.serviceMonitor.labelNameLengthLimit }}
  labelNameLengthLimit: {{ . }}
  {{- end }}
  {{- with .Values.serviceMonitor.labelValueLengthLimit }}
  labelValueLengthLimit: {{ . }}
  {{- end }}

  endpoints:
    {{- $global := .Values.serviceMonitor -}}
    {{- range $i, $ep := $global.endpoints }}
    - {{- /* Port selection: prefer named port, fallback to numeric targetPort */ -}}
      {{- if $ep.portName }}
      port: {{ $ep.portName | quote }}
      {{- else if $ep.targetPort }}
      targetPort: {{ $ep.targetPort }}
      {{- end }}
      {{- with $ep.scheme }}scheme: {{ . | quote }}{{- end }}
      {{- with $ep.path }}path: {{ . | quote }}{{- end }}
      interval: {{ default $global.interval $ep.interval | quote }}
      scrapeTimeout: {{ default $global.scrapeTimeout $ep.scrapeTimeout | quote }}
      {{- with $ep.params }}
      params:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      honorLabels: {{ default $global.honorLabels $ep.honorLabels | default false }}
      {{- with $ep.honorTimestamps }}honorTimestamps: {{ . }}{{- end }}
      {{- with $ep.followRedirects }}followRedirects: {{ . }}{{- end }}
      {{- with $ep.enableHttp2 }}enableHttp2: {{ . }}{{- end }}
      {{- with $ep.proxyUrl }}proxyUrl: {{ . | quote }}{{- end }}

      {{- /* Authentication options */ -}}
      {{- with $ep.bearerTokenFile }}
      bearerTokenFile: {{ . | quote }}
      {{- end }}
      {{- with $ep.bearerTokenSecret }}
      bearerTokenSecret:
        name: {{ .name | quote }}
        key: {{ .key | quote }}
      {{- end }}
      {{- with $ep.basicAuth }}
      basicAuth:
        username:
          name: {{ .username.name | quote }}
          key: {{ .username.key | quote }}
        password:
          name: {{ .password.name | quote }}
          key: {{ .password.key | quote }}
      {{- end }}
      {{- with $ep.authorization }}
      authorization:
        {{- if .type }}type: {{ .type | quote }}{{- end }}
        {{- if .credentials }}
        credentials:
          name: {{ .credentials.name | quote }}
          key: {{ .credentials.key | quote }}
        {{- end }}
        {{- if .credentialsFile }}credentialsFile: {{ .credentialsFile | quote }}{{- end }}
      {{- end }}
      {{- with $ep.oauth2 }}
      oauth2:
        clientId:
          name: {{ .clientId.name | quote }}
          key: {{ .clientId.key | quote }}
        clientSecret:
          name: {{ .clientSecret.name | quote }}
          key: {{ .clientSecret.key | quote }}
        {{- with .scopes }}
        scopes:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .tokenUrl }}tokenUrl: {{ . | quote }}{{- end }}
        {{- with .endpointParams }}
        endpointParams:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      {{- /* TLS */ -}}
      {{- with $ep.tlsConfig }}
      tlsConfig:
        {{- with .serverName }}serverName: {{ . | quote }}{{- end }}
        {{- with .insecureSkipVerify }}insecureSkipVerify: {{ . }}{{- end }}
        {{- with .caFile }}caFile: {{ . | quote }}{{- end }}
        {{- with .certFile }}certFile: {{ . | quote }}{{- end }}
        {{- with .keyFile }}keyFile: {{ . | quote }}{{- end }}
        {{- with .ca }}
        ca:
          secret:
            name: {{ .secret.name | quote }}
            key: {{ .secret.key | quote }}
        {{- end }}
        {{- with .cert }}
        cert:
          secret:
            name: {{ .secret.name | quote }}
            key: {{ .secret.key | quote }}
        {{- end }}
        {{- with .keySecret }}
        keySecret:
          name: {{ .name | quote }}
          key: {{ .key | quote }}
        {{- end }}
      {{- end }}

      {{- with $ep.relabelings }}
      relabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $ep.metricRelabelings }}
      metricRelabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- end }}
{{- end }}
