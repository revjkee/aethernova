{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.dev/schemas/oblivionvault-core/dsar_request.schema.json",
  "title": "OblivionVault Core — DSAR Request (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "requestId",
    "createdAt",
    "controller",
    "dataSubject",
    "request",
    "verification",
    "processing"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "1.0.0",
      "description": "Версия контракта схемы."
    },
    "requestId": {
      "type": "string",
      "format": "uuid",
      "description": "Уникальный идентификатор запроса."
    },
    "createdAt": {
      "type": "string",
      "format": "date-time",
      "description": "Момент регистрации DSAR (UTC)."
    },
    "source": {
      "type": "object",
      "description": "Технические данные подачи запроса.",
      "additionalProperties": false,
      "properties": {
        "submissionChannel": {
          "type": "string",
          "enum": ["webform", "email", "postal", "phone", "in-person", "api", "agent-portal"]
        },
        "ipAddress": { "type": "string" },
        "userAgent": { "type": "string" }
      }
    },
    "environment": {
      "type": "string",
      "enum": ["prod", "staging", "dev"],
      "default": "prod"
    },
    "jurisdiction": {
      "type": "object",
      "description": "Юрисдикция и правовой режим обработки DSAR.",
      "additionalProperties": false,
      "required": ["framework"],
      "properties": {
        "framework": {
          "type": "string",
          "enum": ["GDPR", "CCPA", "CPRA", "LGPD", "PDPA-SG", "PIPEDA", "Other"]
        },
        "country": { "$ref": "#/$defs/countryCode" },
        "region": { "type": "string" },
        "otherName": { "type": "string" }
      }
    },
    "controller": {
      "type": "object",
      "description": "Данные контролера (оператора) персональных данных.",
      "additionalProperties": false,
      "required": ["orgName", "contact"],
      "properties": {
        "orgName": { "type": "string", "minLength": 2, "maxLength": 200 },
        "contact": {
          "type": "object",
          "additionalProperties": false,
          "required": ["email"],
          "properties": {
            "email": { "$ref": "#/$defs/email" },
            "phone": { "$ref": "#/$defs/phone" },
            "url": { "type": "string", "format": "uri" }
          }
        },
        "dpo": {
          "type": "object",
          "description": "Контакты DPO/ответственного по защите данных.",
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string" },
            "email": { "$ref": "#/$defs/email" }
          }
        }
      }
    },
    "dataSubject": {
      "type": "object",
      "description": "Идентификационные данные субъекта данных.",
      "additionalProperties": false,
      "required": ["subjectType", "name"],
      "properties": {
        "subjectType": { "type": "string", "enum": ["individual"] },
        "name": { "$ref": "#/$defs/personName" },
        "dateOfBirth": { "type": "string", "format": "date" },
        "emails": {
          "type": "array",
          "items": { "$ref": "#/$defs/email" },
          "minItems": 0,
          "uniqueItems": true
        },
        "phones": {
          "type": "array",
          "items": { "$ref": "#/$defs/phone" },
          "minItems": 0,
          "uniqueItems": true
        },
        "countryOfResidence": { "$ref": "#/$defs/countryCode" },
        "address": { "$ref": "#/$defs/address" },
        "identityNumbers": {
          "type": "array",
          "description": "Идентификаторы (паспорт/нац.ID/ИНН и т.п.). Рекомендуется хранить hash.",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["passport", "national-id", "driver-license", "tax-id", "other"]
              },
              "value": {
                "type": "string",
                "minLength": 4,
                "maxLength": 64
              },
              "valueHash": {
                "type": "string",
                "pattern": "^[A-Fa-f0-9]{64,128}$",
                "description": "Напр. SHA-256/512 или Argon2 хеш в hex."
              },
              "hashAlgo": { "type": "string", "enum": ["sha256", "sha512", "argon2id"] },
              "issuerCountry": { "$ref": "#/$defs/countryCode" }
            },
            "oneOf": [
              { "required": ["valueHash", "hashAlgo"] },
              { "required": ["value"] }
            ]
          }
        }
      },
      "allOf": [
        {
          "description": "Хотя бы один контактный идентификатор (email/phone/identityNumbers).",
          "anyOf": [
            { "required": ["emails"] },
            { "required": ["phones"] },
            { "required": ["identityNumbers"] }
          ]
        }
      ]
    },
    "agent": {
      "type": "object",
      "description": "Доверенный представитель (если запрос подается не самим субъектом).",
      "additionalProperties": false,
      "properties": {
        "isRepresentative": { "type": "boolean", "default": false },
        "identity": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "name": { "$ref": "#/$defs/personName" },
            "email": { "$ref": "#/$defs/email" },
            "phone": { "$ref": "#/$defs/phone" }
          }
        },
        "authorizationType": {
          "type": "string",
          "enum": ["power-of-attorney", "parental", "legal-guardian", "company-representative", "other"]
        },
        "authorizationDocs": {
          "type": "array",
          "items": { "$ref": "#/$defs/attachmentRef" },
          "minItems": 0
        },
        "subjectConsent": {
          "type": "boolean",
          "description": "Подтверждение согласия субъекта на представление его интересов."
        }
      }
    },
    "request": {
      "type": "object",
      "description": "Сведения о требовании DSAR.",
      "additionalProperties": false,
      "required": ["requestType", "scope", "preferences"],
      "properties": {
        "requestType": {
          "type": "string",
          "enum": [
            "access",
            "erasure",
            "rectification",
            "restriction",
            "objection",
            "portability",
            "consent-withdrawal",
            "processing-info"
          ]
        },
        "scope": {
          "type": "object",
          "additionalProperties": false,
          "required": [],
          "properties": {
            "dataCategories": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": [
                  "identifiers",
                  "contact",
                  "employment",
                  "education",
                  "finance",
                  "location",
                  "online-identifiers",
                  "biometrics",
                  "health",
                  "communications",
                  "usage-telemetry",
                  "support-tickets",
                  "marketing-consents",
                  "other"
                ]
              },
              "minItems": 1,
              "uniqueItems": true
            },
            "timeRange": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "from": { "type": "string", "format": "date-time" },
                "to": { "type": "string", "format": "date-time" }
              }
            },
            "dataSources": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["first-party", "third-party", "processors", "backups", "archives"]
              },
              "uniqueItems": true
            },
            "systems": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 120 },
              "uniqueItems": true
            },
            "regions": {
              "type": "array",
              "items": { "$ref": "#/$defs/countryCode" },
              "uniqueItems": true
            },
            "includeBackups": { "type": "boolean", "default": false }
          }
        },
        "preferences": {
          "type": "object",
          "additionalProperties": false,
          "required": ["responseFormat", "deliveryChannel", "language"],
          "properties": {
            "responseFormat": { "type": "string", "enum": ["json", "csv", "pdf", "xml", "html-zip"] },
            "deliveryChannel": { "type": "string", "enum": ["secure-portal", "email", "postal"] },
            "language": { "$ref": "#/$defs/languageTag" }
          }
        },
        "rectificationDetails": {
          "type": "string",
          "minLength": 5,
          "maxLength": 5000,
          "description": "Требуемые исправления и корректные значения."
        },
        "erasureLegalBasis": {
          "type": "string",
          "enum": [
            "consent-withdrawn",
            "no-longer-necessary",
            "unlawful-processing",
            "legal-obligation",
            "child-consent"
          ]
        },
        "dataExportFormat": { "type": "string", "enum": ["json", "csv", "parquet", "zip"] }
      },
      "allOf": [
        {
          "if": { "properties": { "requestType": { "const": "rectification" } } },
          "then": { "required": ["rectificationDetails"] }
        },
        {
          "if": { "properties": { "requestType": { "const": "erasure" } } },
          "then": { "required": ["erasureLegalBasis"] }
        },
        {
          "if": {
            "properties": { "requestType": { "enum": ["access", "portability"] } }
          },
          "then": { "required": ["dataExportFormat"] }
        }
      ]
    },
    "verification": {
      "type": "object",
      "description": "Процесс и статус верификации личности.",
      "additionalProperties": false,
      "required": ["method", "status"],
      "properties": {
        "method": {
          "type": "string",
          "enum": [
            "email-otp",
            "sms-otp",
            "knowledge-based",
            "document",
            "in-person",
            "bankid",
            "eidas",
            "other"
          ]
        },
        "status": { "type": "string", "enum": ["pending", "verified", "failed"] },
        "verifiedAt": { "type": "string", "format": "date-time" },
        "attempts": { "type": "integer", "minimum": 0, "maximum": 10 },
        "notes": { "type": "string", "maxLength": 2000 }
      },
      "allOf": [
        {
          "if": { "properties": { "status": { "const": "verified" } } },
          "then": { "required": ["verifiedAt"] }
        }
      ]
    },
    "attachments": {
      "type": "array",
      "description": "Ссылки на приложенные файлы (метаданные, не содержимое).",
      "items": { "$ref": "#/$defs/attachmentRef" },
      "minItems": 0
    },
    "processing": {
      "type": "object",
      "description": "Ход обработки запроса и SLA.",
      "additionalProperties": false,
      "required": ["status", "dueDate"],
      "properties": {
        "status": {
          "type": "string",
          "enum": [
            "received",
            "in-review",
            "info-requested",
            "verified",
            "fulfilled",
            "partially-fulfilled",
            "rejected",
            "closed"
          ]
        },
        "dueDate": { "type": "string", "format": "date-time" },
        "extended": { "type": "boolean", "default": false },
        "extensionReason": { "type": "string", "maxLength": 2000 },
        "extensionNotifiedAt": { "type": "string", "format": "date-time" },
        "rejectionReasons": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "identity-not-verified",
              "manifestly-unfounded",
              "excessive",
              "legal-exemption",
              "data-not-found",
              "duplicate-request",
              "other"
            ]
          },
          "uniqueItems": true
        },
        "slaMinutes": { "type": "integer", "minimum": 1, "maximum": 43200 }
      },
      "allOf": [
        {
          "if": { "properties": { "extended": { "const": true } } },
          "then": { "required": ["extensionReason", "extensionNotifiedAt"] }
        },
        {
          "if": { "properties": { "status": { "const": "rejected" } } },
          "then": { "minProperties": 3, "required": ["rejectionReasons"] }
        }
      ]
    },
    "audit": {
      "type": "object",
      "description": "Аудит-трейл действий по DSAR.",
      "additionalProperties": false,
      "properties": {
        "events": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["timestamp", "actor", "action"],
            "properties": {
              "timestamp": { "type": "string", "format": "date-time" },
              "actor": { "type": "string", "minLength": 1, "maxLength": 120 },
              "action": {
                "type": "string",
                "enum": [
                  "created",
                  "verified",
                  "comment-added",
                  "evidence-attached",
                  "export-started",
                  "export-complete",
                  "erasure-initiated",
                  "erasure-complete",
                  "response-sent",
                  "closed"
                ]
              },
              "note": { "type": "string", "maxLength": 2000 },
              "statusSnapshot": { "$ref": "#/properties/processing/properties/status" }
            }
          }
        }
      }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": {
          "agent": {
            "properties": { "isRepresentative": { "const": true } },
            "required": ["isRepresentative"]
          }
        }
      },
      "then": {
        "properties": {
          "agent": {
            "required": ["identity", "authorizationType", "authorizationDocs", "subjectConsent"]
          }
        }
      }
    }
  ],

  "$defs": {
    "email": { "type": "string", "format": "email", "maxLength": 320 },
    "phone": {
      "type": "string",
      "pattern": "^\\+?[1-9]\\d{1,14}$",
      "description": "E.164 формат."
    },
    "countryCode": {
      "type": "string",
      "pattern": "^[A-Z]{2}$",
      "description": "ISO 3166-1 alpha-2."
    },
    "languageTag": {
      "type": "string",
      "pattern": "^[A-Za-z]{2,3}(-[A-Za-z0-9]{2,8})*$",
      "description": "BCP 47, напр. en, sv-SE, ru."
    },
    "address": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "line1": { "type": "string", "minLength": 1, "maxLength": 200 },
        "line2": { "type": "string", "maxLength": 200 },
        "city": { "type": "string", "minLength": 1, "maxLength": 120 },
        "state": { "type": "string", "maxLength": 120 },
        "postalCode": { "type": "string", "maxLength": 20 },
        "country": { "$ref": "#/$defs/countryCode" }
      }
    },
    "personName": {
      "type": "object",
      "additionalProperties": false,
      "required": ["givenName", "familyName"],
      "properties": {
        "givenName": { "type": "string", "minLength": 1, "maxLength": 120 },
        "middleName": { "type": "string", "maxLength": 120 },
        "familyName": { "type": "string", "minLength": 1, "maxLength": 120 }
      }
    },
    "attachmentRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "mimeType", "sizeBytes", "uri"],
      "properties": {
        "id": { "type": "string", "format": "uuid" },
        "name": { "type": "string", "minLength": 1, "maxLength": 200 },
        "mimeType": {
          "type": "string",
          "enum": [
            "application/pdf",
            "image/jpeg",
            "image/png",
            "image/heic",
            "application/zip"
          ]
        },
        "sizeBytes": { "type": "integer", "minimum": 1, "maximum": 52428800 },
        "uri": { "type": "string", "format": "uri" },
        "hash": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64,128}$",
          "description": "Хеш содержимого (sha256/sha512/др.) в hex."
        }
      }
    }
  },

  "examples": [
    {
      "schemaVersion": "1.0.0",
      "requestId": "4f1d5a9f-3a4b-49c3-9481-0a7e1e4f3a01",
      "createdAt": "2025-08-25T09:30:00Z",
      "environment": "prod",
      "jurisdiction": { "framework": "GDPR", "country": "SE", "region": "EU" },
      "controller": {
        "orgName": "OblivionVault AB",
        "contact": { "email": "privacy@oblivionvault.example", "url": "https://oblivionvault.example/privacy" },
        "dpo": { "name": "Data Protection Officer", "email": "dpo@oblivionvault.example" }
      },
      "dataSubject": {
        "subjectType": "individual",
        "name": { "givenName": "Anna", "familyName": "Svensson" },
        "dateOfBirth": "1994-02-11",
        "emails": ["anna.svensson@example.com"],
        "phones": ["+46701234567"],
        "countryOfResidence": "SE",
        "address": {
          "line1": "Examplegatan 1",
          "city": "Stockholm",
          "postalCode": "11122",
          "country": "SE"
        }
      },
      "agent": { "isRepresentative": false },
      "request": {
        "requestType": "access",
        "scope": {
          "dataCategories": ["identifiers", "usage-telemetry", "support-tickets"],
          "timeRange": { "from": "2024-01-01T00:00:00Z", "to": "2025-08-01T00:00:00Z" },
          "dataSources": ["first-party", "processors"],
          "systems": ["crm-core", "support-desk"],
          "regions": ["SE", "DE"],
          "includeBackups": false
        },
        "preferences": { "responseFormat": "json", "deliveryChannel": "secure-portal", "language": "sv-SE" },
        "dataExportFormat": "json"
      },
      "verification": { "method": "bankid", "status": "verified", "verifiedAt": "2025-08-25T09:32:00Z", "attempts": 1 },
      "attachments": [],
      "processing": { "status": "in-review", "dueDate": "2025-09-24T09:30:00Z", "slaMinutes": 43200 },
      "audit": {
        "events": [
          { "timestamp": "2025-08-25T09:30:01Z", "actor": "portal", "action": "created" },
          { "timestamp": "2025-08-25T09:32:05Z", "actor": "verifier", "action": "verified", "statusSnapshot": "in-review" }
        ]
      }
    }
  ]
}
