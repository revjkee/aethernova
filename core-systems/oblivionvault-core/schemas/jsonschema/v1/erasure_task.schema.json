{
  "$id": "https://schemas.oblivionvault.io/jsonschema/v1/erasure_task.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ErasureTask",
  "description": "Задание на безопасное удаление данных (erasure) с правовыми основаниями, параметрами метода и аудитом.",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "required": [
    "apiVersion",
    "kind",
    "id",
    "created_at",
    "requested_by",
    "subject",
    "legal_basis",
    "method",
    "targets",
    "verification",
    "approvals",
    "audit"
  ],
  "properties": {
    "apiVersion": {
      "const": "oblivionvault.io/v1",
      "description": "Версия API."
    },
    "kind": {
      "const": "ErasureTask",
      "description": "Тип объекта."
    },
    "id": {
      "description": "Идентификатор задания (UUID v4 или ULID).",
      "oneOf": [
        { "type": "string", "format": "uuid" },
        { "type": "string", "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$" }
      ]
    },
    "version": {
      "description": "Версия схемы задания в формате semver.",
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-\\.]+)?(?:\\+[0-9A-Za-z-\\.]+)?$",
      "default": "1.0.0"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "Время создания задания (UTC)."
    },
    "requested_by": {
      "$ref": "#/$defs/requester"
    },
    "subject": {
      "description": "Субъект данных, к которому относится удаление.",
      "oneOf": [
        { "$ref": "#/$defs/subjectById" },
        { "$ref": "#/$defs/subjectByIdentifiers" }
      ]
    },
    "legal_basis": {
      "description": "Правовое или договорное основание для удаления.",
      "type": "string",
      "enum": [
        "gdpr_art17",
        "ccpa_request",
        "contract_end",
        "retention_expired",
        "data_minimization",
        "regulator_request",
        "security_incident_remediation",
        "manual_admin"
      ]
    },
    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "legal_hold_override": {
          "type": "boolean",
          "description": "Разрешить удаление при действующем legal hold.",
          "default": false
        },
        "worm_compliance_required": {
          "type": "boolean",
          "description": "Требовать совместимость с режимом WORM/immutability.",
          "default": true
        }
      }
    },
    "method": {
      "$ref": "#/$defs/erasureMethod"
    },
    "targets": {
      "description": "Целевые хранилища и селекторы объектов/записей.",
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/target" }
    },
    "schedule": {
      "$ref": "#/$defs/schedule"
    },
    "verification": {
      "$ref": "#/$defs/verification"
    },
    "approvals": {
      "$ref": "#/$defs/approvals"
    },
    "audit": {
      "$ref": "#/$defs/audit"
    },
    "priority": {
      "type": "string",
      "enum": ["low", "normal", "high", "p1"],
      "default": "normal"
    },
    "dry_run": {
      "type": "boolean",
      "description": "Если true — выполняется моделирование без фактического удаления.",
      "default": false
    },
    "concurrency_limit": {
      "type": "integer",
      "minimum": 1,
      "maximum": 1000,
      "default": 25,
      "description": "Лимит параллельных операций удаления."
    },
    "timeouts": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "run_timeout_seconds": {
          "type": "integer",
          "minimum": 60,
          "maximum": 604800,
          "default": 14400
        },
        "verification_timeout_seconds": {
          "type": "integer",
          "minimum": 30,
          "maximum": 604800,
          "default": 3600
        }
      }
    },
    "notes": {
      "type": "string",
      "maxLength": 4000
    }
  },

  "allOf": [
    {
      "if": {
        "properties": { "constraints": { "properties": { "legal_hold_override": { "const": true } }, "required": ["legal_hold_override"] } }
      },
      "then": {
        "properties": {
          "approvals": {
            "properties": {
              "required_approvals": { "minimum": 2 }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": { "method": { "properties": { "type": { "const": "crypto-erase" } }, "required": ["type"] } }
      },
      "then": {
        "properties": {
          "method": {
            "required": ["keyset_ref"]
          }
        }
      }
    },
    {
      "if": {
        "properties": { "method": { "properties": { "type": { "const": "overwrite" } }, "required": ["type"] } }
      },
      "then": {
        "properties": {
          "method": {
            "required": ["n_passes"]
          }
        }
      }
    },
    {
      "if": {
        "properties": { "method": { "properties": { "type": { "const": "tombstone-delete" } }, "required": ["type"] } }
      },
      "then": {
        "properties": {
          "method": {
            "required": ["retention_check"]
          }
        }
      }
    }
  ],

  "$defs": {
    "requester": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id"],
      "properties": {
        "type": { "type": "string", "enum": ["user", "service"] },
        "id": { "type": "string", "minLength": 1, "maxLength": 256 },
        "email": { "type": "string", "format": "email" },
        "reason": { "type": "string", "maxLength": 2000 }
      }
    },

    "subjectById": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "subject_id"],
      "properties": {
        "mode": { "const": "by_id" },
        "subject_id": { "type": "string", "minLength": 1, "maxLength": 256 }
      }
    },

    "subjectByIdentifiers": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "identifiers"],
      "properties": {
        "mode": { "const": "by_identifiers" },
        "identifiers": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "email": { "type": "string", "format": "email" },
            "phone": { "type": "string", "pattern": "^\\+?[0-9]{7,15}$" },
            "national_id": { "type": "string", "maxLength": 64 }
          },
          "minProperties": 1
        }
      }
    },

    "erasureMethod": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["crypto-erase", "overwrite", "tombstone-delete", "remote-purge"]
        },
        "keyset_ref": {
          "type": "string",
          "description": "Ссылка на keyset из configs/keys.yaml для crypto-erase.",
          "minLength": 1
        },
        "n_passes": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Количество проходов перезаписи для overwrite."
        },
        "pattern": {
          "type": "string",
          "enum": ["zero", "ones", "random", "dod_5220.22-m"],
          "default": "random"
        },
        "verify_pass": {
          "type": "boolean",
          "default": true
        },
        "retention_check": {
          "type": "boolean",
          "default": true,
          "description": "Проверка истечения срока хранения перед tombstone-delete."
        },
        "vendor_endpoint": {
          "type": "string",
          "format": "uri",
          "description": "Внешний API удаленного провайдера для remote-purge."
        }
      }
    },

    "resourceSelector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "s3",
            "azure_blob",
            "gcs",
            "minio",
            "filesystem",
            "postgres",
            "clickhouse",
            "elasticsearch",
            "kafka",
            "redis",
            "k8s_pvc"
          ]
        },
        "uri": {
          "type": "string",
          "format": "uri",
          "description": "URI ресурса (без секретов)."
        },
        "bucket": { "type": "string" },
        "container": { "type": "string" },
        "path_globs": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "db": { "type": "string" },
        "schema": { "type": "string" },
        "table": { "type": "string" },
        "where_sql": { "type": "string", "maxLength": 4000 },
        "topic": { "type": "string" },
        "keyspace": { "type": "string" },
        "labels": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    },

    "target": {
      "type": "object",
      "additionalProperties": false,
      "required": ["selector", "policy"],
      "properties": {
        "selector": { "$ref": "#/$defs/resourceSelector" },
        "policy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "safe_delete": {
              "type": "boolean",
              "description": "Use safe-delete/soft-delete перед окончательной очисткой.",
              "default": true
            },
            "worm_required": { "type": "boolean", "default": false },
            "batch_size": { "type": "integer", "minimum": 1, "maximum": 10000, "default": 1000 },
            "rate_limit_per_second": { "type": "integer", "minimum": 1, "maximum": 100000, "default": 5000 }
          }
        }
      }
    },

    "schedule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": { "type": "string", "enum": ["immediate", "window"], "default": "immediate" },
        "window_start": { "type": "string", "format": "date-time" },
        "window_end": { "type": "string", "format": "date-time" },
        "timezone": { "type": "string", "default": "UTC" }
      },
      "allOf": [
        {
          "if": { "properties": { "mode": { "const": "window" } }, "required": ["mode"] },
          "then": { "required": ["window_start", "window_end"] }
        }
      ]
    },

    "verification": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "type": "string", "enum": ["none", "sample", "full"], "default": "sample" },
        "sample_rate_percent": { "type": "number", "minimum": 0, "maximum": 100, "default": 5 },
        "expected_evidence": {
          "type": "array",
          "items": { "type": "string", "enum": ["object_missing", "checksum_mismatch", "key_rotated", "overwrite_report", "vendor_receipt"] },
          "minItems": 1
        },
        "store_artifacts": { "type": "boolean", "default": true }
      }
    },

    "approvals": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required_approvals", "approvers"],
      "properties": {
        "required_approvals": { "type": "integer", "minimum": 1, "maximum": 10, "default": 2 },
        "approvers": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/approver" }
        },
        "m_out_of_n": {
          "type": "string",
          "pattern": "^[1-9]\\d*/[1-9]\\d*$",
          "description": "Необязательный m/n режим подтверждений."
        }
      }
    },

    "approver": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 256 },
        "email": { "type": "string", "format": "email" },
        "role": { "type": "string", "enum": ["legal", "security", "dpo", "sre", "product", "admin"] }
      }
    },

    "audit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["correlation_id", "otlp_endpoint"],
      "properties": {
        "correlation_id": { "type": "string", "minLength": 8, "maxLength": 128 },
        "otlp_endpoint": { "type": "string", "minLength": 1 },
        "reason": { "type": "string", "maxLength": 2000 },
        "labels": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    }
  },

  "examples": [
    {
      "apiVersion": "oblivionvault.io/v1",
      "kind": "ErasureTask",
      "id": "a3f1c1c7-8c3a-4c7d-9b4f-2f2a5a1b5c11",
      "version": "1.0.0",
      "created_at": "2025-08-25T09:00:00Z",
      "requested_by": { "type": "user", "id": "alice", "email": "alice@oblivionvault.io", "reason": "GDPR Art.17 request" },
      "subject": { "mode": "by_identifiers", "identifiers": { "email": "user@example.com" } },
      "legal_basis": "gdpr_art17",
      "constraints": { "legal_hold_override": false, "worm_compliance_required": true },
      "method": { "type": "crypto-erase", "keyset_ref": "data-envelope" },
      "targets": [
        {
          "selector": { "type": "s3", "bucket": "ov-prod-data", "path_globs": ["users/**"] },
          "policy": { "safe_delete": true, "batch_size": 2000, "rate_limit_per_second": 3000 }
        },
        {
          "selector": { "type": "postgres", "db": "users", "schema": "public", "table": "profiles", "where_sql": "email = 'user@example.com'" },
          "policy": { "safe_delete": true }
        }
      ],
      "schedule": { "mode": "window", "window_start": "2025-08-26T00:00:00Z", "window_end": "2025-08-26T04:00:00Z", "timezone": "UTC" },
      "verification": { "mode": "sample", "sample_rate_percent": 10, "expected_evidence": ["object_missing", "key_rotated"], "store_artifacts": true },
      "approvals": { "required_approvals": 2, "approvers": [ { "id": "ciso", "email": "ciso@oblivionvault.io", "role": "security" }, { "id": "dpo", "email": "dpo@oblivionvault.io", "role": "dpo" } ], "m_out_of_n": "2/3" },
      "audit": { "correlation_id": "gdpr-req-2025-00123", "otlp_endpoint": "otel-gateway.observability.svc.cluster.local:4317", "reason": "User erasure under GDPR Art.17" },
      "priority": "high",
      "dry_run": false,
      "concurrency_limit": 50,
      "timeouts": { "run_timeout_seconds": 21600, "verification_timeout_seconds": 3600 },
      "notes": "Удалить все персональные данные пользователя по email."
    }
  ]
}
