<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>OblivionVault — Web Admin (Minimal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Безопасность: реальные заголовки CSP выставляйте на сервере.
       Следующая meta — мягкий вариант, не ломает inline-скрипт.
       Рекомендуется заменить на заголовок Content-Security-Policy. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; connect-src 'self' https: http:; script-src 'self' 'unsafe-inline'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
  <meta name="referrer" content="no-referrer">
  <meta name="color-scheme" content="light dark">
  <meta name="csrf-token" content="">
  <style>
    :root {
      --bg: #0b0f14;
      --bg-soft: #121821;
      --panel: #0f1622;
      --text: #e6edf3;
      --muted: #a0a8b0;
      --primary: #2ea043;
      --primary-weak: #1d6e2e;
      --danger: #d14141;
      --border: #233044;
      --focus: #4aa3ff;
      --warn: #b08900;
      --code: #0a0e14;
      --shadow: rgba(0,0,0,0.35);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8fa;
        --bg-soft: #ffffff;
        --panel: #ffffff;
        --text: #0b0f14;
        --muted: #4b5563;
        --primary: #2f6fed;
        --primary-weak: #234db1;
        --danger: #b3261e;
        --border: #d0d7de;
        --focus: #1f6feb;
        --warn: #b05e00;
        --code: #f3f6fa;
        --shadow: rgba(0,0,0,0.1);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      position: sticky; top: 0;
      background: var(--bg-soft);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .wrap { max-width: 1160px; margin: 0 auto; padding: 12px 16px; }
    .brand {
      display: flex; align-items: center; gap: 12px;
      font-weight: 700; font-size: 16px;
    }
    .brand small { color: var(--muted); font-weight: 500; }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: 300px 1fr;
      padding: 16px;
      max-width: 1160px; margin: 0 auto;
    }
    aside, main {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow);
      padding: 16px;
    }
    h2 { margin: 0 0 8px; font-size: 16px; }
    fieldset { border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin: 0 0 12px; }
    legend { padding: 0 6px; color: var(--muted); }
    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    input[type="text"], input[type="url"], input[type="number"], input[type="search"], textarea, select {
      width: 100%;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      outline: none;
    }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(74,163,255,0.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--bg);
      color: var(--text);
      cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: var(--primary); border-color: var(--primary-weak); color: #fff; }
    .btn.warn { background: var(--warn); border-color: var(--warn); color: #fff; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: #fff; }
    .btn.ghost { background: transparent; }
    .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(74,163,255,0.35); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .table {
      width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px;
    }
    .table th, .table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left; vertical-align: top;
      white-space: nowrap;
    }
    .table th:first-child, .table td:first-child { white-space: normal; }
    .pill { display: inline-block; padding: 2px 6px; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-size: 12px; }
    .status { display: flex; gap: 8px; align-items: center; }
    .status .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
    .status.ok .dot { background: var(--primary); }
    .toast {
      position: fixed; right: 16px; bottom: 16px; background: var(--panel); border: 1px solid var(--border);
      box-shadow: 0 10px 30px var(--shadow); padding: 10px 12px; border-radius: 8px; z-index: 50; max-width: 420px;
    }
    code.inline { background: var(--code); padding: 2px 4px; border-radius: 4px; border: 1px solid var(--border); }
    .danger-zone { border: 1px dashed var(--danger); border-radius: 10px; padding: 12px; margin-top: 8px; }
    footer { max-width: 1160px; margin: 16px auto; color: var(--muted); font-size: 12px; padding: 0 16px; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px,1px,1px,1px); white-space: nowrap; }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand" aria-label="Заголовок приложения">
      <div aria-hidden="true" style="width:10px;height:10px;border-radius:50%;background:var(--primary)"></div>
      OblivionVault Admin <small>minimal</small>
    </div>
  </div>
</header>

<div class="grid" role="main">
  <aside aria-label="Панель настроек">
    <h2>Подключение</h2>
    <fieldset>
      <legend>API</legend>
      <label for="baseUrl">Base URL</label>
      <input id="baseUrl" type="url" placeholder="https://vault.example.com" autocomplete="off" spellcheck="false" inputmode="url">
      <div class="row">
        <div>
          <label for="authMode">Аутентификация</label>
          <select id="authMode" aria-label="Режим аутентификации">
            <option value="bearer">Bearer Token</option>
            <option value="cookie">Cookies (SameSite)</option>
          </select>
        </div>
        <div>
          <label for="timeoutSec">Таймаут, сек</label>
          <input id="timeoutSec" type="number" min="1" max="120" value="20">
        </div>
      </div>
      <label for="token">Bearer Token</label>
      <input id="token" type="text" placeholder="не храните прод ключи в браузере" autocomplete="off" spellcheck="false">
      <label for="csrf">CSRF Header (опц.)</label>
      <input id="csrf" type="text" placeholder="X-CSRF-Token: ..." autocomplete="off" spellcheck="false">
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnSaveCfg">Сохранить</button>
        <button class="btn ghost" id="btnPing">Проверить подключение</button>
        <span id="connStatus" class="status" role="status" aria-live="polite"><span class="dot"></span><span class="muted">offline</span></span>
      </div>
    </fieldset>

    <h2>Фильтры</h2>
    <fieldset>
      <legend>Поиск</legend>
      <label for="namespace">Namespace</label>
      <input id="namespace" type="text" placeholder="например: prod" autocomplete="off">
      <div class="toolbar">
        <input id="q" type="search" placeholder="поиск по имени" style="flex:1">
        <button class="btn" id="btnReload">Обновить</button>
      </div>
      <div class="toolbar" style="margin-top:6px">
        <label class="muted" for="limit" style="margin:0">Limit</label>
        <input id="limit" type="number" value="50" min="1" max="500" style="width:90px">
        <label class="muted" for="offset" style="margin:0">Offset</label>
        <input id="offset" type="number" value="0" min="0" style="width:90px">
      </div>
    </fieldset>

    <h2>Операции</h2>
    <fieldset>
      <legend>Создать/обновить</legend>
      <label for="iNamespace">Namespace</label>
      <input id="iNamespace" type="text" placeholder="prod" autocomplete="off">
      <label for="iName">Name</label>
      <input id="iName" type="text" placeholder="db.password" autocomplete="off">
      <div class="row">
        <div>
          <label for="iContentType">Content-Type</label>
          <input id="iContentType" type="text" value="application/octet-stream">
        </div>
        <div>
          <label for="iCompression">Compression</label>
          <select id="iCompression">
            <option value="gzip" selected>gzip</option>
            <option value="none">none</option>
          </select>
        </div>
      </div>
      <label for="iMetadata">Metadata (JSON)</label>
      <textarea id="iMetadata" placeholder='{"owner":"security","purpose":"db creds"}'></textarea>
      <label for="iData">Данные секрета (текст)</label>
      <textarea id="iData" placeholder="секрет в текстовом виде"></textarea>
      <div class="toolbar" style="margin-top:8px">
        <input id="iFile" type="file" aria-label="Загрузить файл вместо текста">
        <button class="btn primary" id="btnPut">Сохранить версию</button>
        <button class="btn" id="btnClearForm">Очистить</button>
      </div>
    </fieldset>

    <fieldset class="danger-zone" aria-labelledby="dangerTitle">
      <legend id="dangerTitle">Опасная зона</legend>
      <div class="row">
        <div>
          <label for="dNamespace">Namespace</label>
          <input id="dNamespace" type="text" placeholder="prod">
        </div>
        <div>
          <label for="dName">Name</label>
          <input id="dName" type="text" placeholder="db.password">
        </div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn warn" id="btnRotate">Ротация ключа</button>
        <button class="btn danger" id="btnSoftDelete">Soft delete</button>
        <button class="btn danger" id="btnHardDelete">Hard purge</button>
      </div>
    </fieldset>
  </aside>

  <main aria-label="Список и детали">
    <h2>Секреты</h2>
    <div class="toolbar">
      <span class="muted">Щелкните по строке для чтения текущей версии.</span>
      <div style="flex:1"></div>
      <button class="btn" id="btnExportList">Экспорт списка</button>
    </div>
    <table class="table" id="tbl">
      <thead>
      <tr>
        <th style="width:40%">Namespace / Name</th>
        <th>Deleted</th>
        <th>Current v</th>
        <th>Updated</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody id="tbody" aria-live="polite"></tbody>
    </table>

    <h2 style="margin-top:16px">Детали</h2>
    <fieldset>
      <legend>Чтение</legend>
      <div class="row">
        <div>
          <label for="rNamespace">Namespace</label>
          <input id="rNamespace" type="text" placeholder="prod">
        </div>
        <div>
          <label for="rName">Name</label>
          <input id="rName" type="text" placeholder="db.password">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="rVersion">Version (опц.)</label>
          <input id="rVersion" type="number" min="1" placeholder="текущая по умолчанию">
        </div>
        <div>
          <label for="rIncludeDeleted">Include deleted</label>
          <select id="rIncludeDeleted">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnRead">Прочитать</button>
        <button class="btn" id="btnDownload">Скачать</button>
        <span class="muted" id="readMeta"></span>
      </div>
      <label for="rData">Данные (read-only)</label>
      <textarea id="rData" readonly placeholder="здесь появятся данные секрета"></textarea>
    </fieldset>
  </main>
</div>

<footer>
  Версия клиента: 1.0.0 • Данный файл работает без внешних библиотек. Эндпоинты настраиваются ниже в конфиге.
</footer>

<!-- Важно: этот файл не навязывает конкретный REST.
     Ниже определены безопасные дефолты; адаптируйте paths.* под ваш backend. -->
<script type="module">
  /** @typedef {{namespace:string,name:string,is_deleted:boolean, current_version:number|null, updated_at?:string}} ItemRow */

  const $ = (sel, root=document) => /** @type {HTMLElement} */(root.querySelector(sel));
  const esc = (s) => String(s ?? "");

  const Store = {
    load() {
      try {
        return JSON.parse(localStorage.getItem("ov_admin_cfg") || "{}");
      } catch { return {}; }
    },
    save(cfg) {
      localStorage.setItem("ov_admin_cfg", JSON.stringify(cfg));
    }
  };

  /** Centralized configuration (adjust to your backend) */
  const Config = {
    api: {
      baseUrl: "",                 // e.g. https://vault.example.com
      authMode: "bearer",          // bearer|cookie
      token: "",
      csrfHeaderValue: "",         // optional, e.g. X-CSRF-Token
      timeoutSec: 20,
      paths: {
        ping: "/api/health", // GET
        list: "/api/v1/secrets", // GET ?namespace=&limit=&offset=&q=
        put:  "/api/v1/secrets", // POST
        get:  (ns, name) => `/api/v1/secrets/${encodeURIComponent(ns)}/${encodeURIComponent(name)}`, // GET ?version=&include_deleted=
        rotate: (ns, name) => `/api/v1/secrets/${encodeURIComponent(ns)}/${encodeURIComponent(name)}/rotate`, // POST ?version=
        del: (ns, name) => `/api/v1/secrets/${encodeURIComponent(ns)}/${encodeURIComponent(name)}`, // DELETE ?soft=true|false
      }
    }
  };

  /** Robust fetch wrapper with timeouts and error normalization */
  class ApiClient {
    /** @param {{baseUrl:string, authMode:string, token:string, csrfHeaderValue:string, timeoutSec:number, paths:any}} cfg */
    constructor(cfg) {
      this.cfg = cfg;
    }
    url(path) {
      const base = this.cfg.baseUrl.replace(/\/+$/,"");
      return base + path;
    }
    /** @param {RequestInfo} input @param {RequestInit & {expectJson?:boolean}} init */
    async request(input, init = {}) {
      const ctl = new AbortController();
      const t = setTimeout(() => ctl.abort(), Math.max(1, this.cfg.timeoutSec) * 1000);
      const headers = new Headers(init.headers || {});
      headers.set("Accept", "application/json");
      if (this.cfg.authMode === "bearer" && this.cfg.token) {
        headers.set("Authorization", `Bearer ${this.cfg.token}`);
      }
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      const csrf = this.cfg.csrfHeaderValue || (csrfMeta && csrfMeta.getAttribute("content")) || "";
      if (csrf) headers.set("X-CSRF-Token", csrf);

      try {
        const resp = await fetch(input, {
          ...init,
          headers,
          credentials: this.cfg.authMode === "cookie" ? "include" : "omit",
          signal: ctl.signal
        });
        const ct = resp.headers.get("content-type") || "";
        const isJson = ct.includes("application/json");
        if (!resp.ok) {
          let detail = "";
          if (isJson) {
            try { const j = await resp.json(); detail = j.message || j.error || JSON.stringify(j); } catch {}
          } else {
            try { detail = await resp.text(); } catch {}
          }
          throw new Error(`HTTP ${resp.status}: ${detail || resp.statusText}`);
        }
        if (init.expectJson === false) {
          return resp;
        }
        return isJson ? await resp.json() : await resp.text();
      } catch (e) {
        if (e.name === "AbortError") throw new Error("Запрос прерван по таймауту");
        throw e;
      } finally {
        clearTimeout(t);
      }
    }

    async ping() {
      return this.request(this.url(this.cfg.paths.ping), { method: "GET" });
    }

    /** @param {{namespace?:string, limit?:number, offset?:number, q?:string}} params */
    async list(params) {
      const url = new URL(this.url(this.cfg.paths.list), window.location.origin);
      if (params.namespace) url.searchParams.set("namespace", params.namespace);
      if (params.limit) url.searchParams.set("limit", String(params.limit));
      if (typeof params.offset === "number") url.searchParams.set("offset", String(params.offset));
      if (params.q) url.searchParams.set("q", params.q);
      return this.request(url.toString(), { method: "GET" });
    }

    /** @param {{namespace:string,name:string, data_base64:string, content_type:string, metadata:any, compression:string}} payload */
    async put(payload) {
      return this.request(this.url(this.cfg.paths.put), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }

    async get(ns, name, { version, include_deleted }) {
      const url = new URL(this.url(this.cfg.paths.get(ns, name)), window.location.origin);
      if (version) url.searchParams.set("version", String(version));
      if (include_deleted) url.searchParams.set("include_deleted", "true");
      return this.request(url.toString(), { method: "GET" });
    }

    async rotate(ns, name, { version } = {}) {
      const url = new URL(this.url(this.cfg.paths.rotate(ns, name)), window.location.origin);
      if (version) url.searchParams.set("version", String(version));
      return this.request(url.toString(), { method: "POST" });
    }

    async remove(ns, name, { soft = true } = {}) {
      const url = new URL(this.url(this.cfg.paths.del(ns, name)), window.location.origin);
      url.searchParams.set("soft", soft ? "true" : "false");
      return this.request(url.toString(), { method: "DELETE" });
    }
  }

  /** Utilities */
  const Toast = (() => {
    let el;
    function show(msg, type="info") {
      if (!el) { el = document.createElement("div"); el.className = "toast"; document.body.appendChild(el); }
      el.textContent = msg;
      el.style.borderColor = type === "error" ? "var(--danger)" : type === "warn" ? "var(--warn)" : "var(--border)";
      clearTimeout(el._t);
      el._t = setTimeout(() => { el.remove(); el=null; }, 3500);
    }
    return { show };
  })();

  function toBase64(uint8) {
    let binary = "";
    const chunk = 0x8000;
    for (let i=0; i<uint8.length; i+=chunk) {
      binary += String.fromCharCode.apply(null, uint8.subarray(i, i+chunk));
    }
    return btoa(binary);
  }

  async function fileToBase64(file) {
    const buf = new Uint8Array(await file.arrayBuffer());
    return toBase64(buf);
  }

  function downloadBytes(bytes, fileName, contentType = "application/octet-stream") {
    const blob = new Blob([bytes], { type: contentType });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function parseJsonSafe(text) {
    if (!text) return {};
    try { return JSON.parse(text); } catch { throw new Error("Некорректный JSON в Metadata"); }
  }

  function hexShort(s) { return s ? String(s).slice(0, 8) : ""; }

  /** State */
  const state = {
    items: /** @type {ItemRow[]} */([]),
    cfg: /** @type {any} */(null),
    api: /** @type {ApiClient} */(null),
  };

  /** Initialize UI with stored config */
  function initConfig() {
    const saved = Store.load();
    state.cfg = structuredClone(Config.api);
    Object.assign(state.cfg, saved || {});
    $("#baseUrl").value = state.cfg.baseUrl || "";
    $("#authMode").value = state.cfg.authMode || "bearer";
    $("#token").value = state.cfg.token || "";
    $("#csrf").value = state.cfg.csrfHeaderValue || "";
    $("#timeoutSec").value = String(state.cfg.timeoutSec || 20);
    state.api = new ApiClient(state.cfg);
  }

  function saveConfigFromUI() {
    state.cfg.baseUrl = $("#baseUrl").value.trim();
    state.cfg.authMode = $("#authMode").value;
    state.cfg.token = $("#token").value.trim();
    state.cfg.csrfHeaderValue = $("#csrf").value.trim();
    state.cfg.timeoutSec = Math.max(1, Number($("#timeoutSec").value) || 20);
    Store.save(state.cfg);
    state.api = new ApiClient(state.cfg);
  }

  /** Render list */
  function renderTable(items) {
    const tb = $("#tbody");
    tb.innerHTML = "";
    for (const it of items) {
      const tr = document.createElement("tr");
      const nsn = document.createElement("td");
      const a = document.createElement("button");
      a.className = "btn ghost";
      a.type = "button";
      a.textContent = `${it.namespace} / ${it.name}`;
      a.addEventListener("click", () => {
        $("#rNamespace").value = it.namespace;
        $("#rName").value = it.name;
        $("#rVersion").value = "";
        $("#rIncludeDeleted").value = "false";
        $("#btnRead").click();
      });
      nsn.appendChild(a);
      const tdDel = document.createElement("td");
      tdDel.textContent = it.is_deleted ? "true" : "false";
      const tdVer = document.createElement("td");
      tdVer.textContent = it.current_version == null ? "-" : String(it.current_version);
      const tdUpd = document.createElement("td");
      tdUpd.textContent = esc(it.updated_at || "");
      const tdAct = document.createElement("td");
      const btnCopyPath = document.createElement("button");
      btnCopyPath.className = "btn";
      btnCopyPath.textContent = "Копировать путь";
      btnCopyPath.addEventListener("click", async () => {
        const s = `${it.namespace}/${it.name}@${it.current_version ?? "current"}`;
        await navigator.clipboard.writeText(s);
        Toast.show("Путь скопирован");
      });
      tdAct.appendChild(btnCopyPath);

      tr.append(nsn, tdDel, tdVer, tdUpd, tdAct);
      tb.appendChild(tr);
    }
  }

  /** Load list */
  async function loadList() {
    const ns = $("#namespace").value.trim();
    const q = $("#q").value.trim();
    const limit = Math.max(1, Number($("#limit").value) || 50);
    const offset = Math.max(0, Number($("#offset").value) || 0);
    try {
      const data = await state.api.list({ namespace: ns || undefined, limit, offset, q: q || undefined });
      // Ожидаемый ответ: { items: [{namespace,name,is_deleted,current_version,updated_at?}], total?: number }
      const items = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
      state.items = items;
      renderTable(items);
    } catch (e) {
      Toast.show(`Ошибка загрузки списка: ${e.message}`, "error");
    }
  }

  /** Put secret */
  async function putSecret() {
    const ns = $("#iNamespace").value.trim();
    const name = $("#iName").value.trim();
    const contentType = $("#iContentType").value.trim() || "application/octet-stream";
    const compression = $("#iCompression").value;
    const meta = parseJsonSafe($("#iMetadata").value.trim());
    const file = $("#iFile").files[0];
    let dataB64 = "";
    try {
      if (!ns || !name) throw new Error("Укажите namespace и name");
      if (file) {
        dataB64 = await fileToBase64(file);
      } else {
        const text = $("#iData").value;
        dataB64 = btoa(unescape(encodeURIComponent(text)));
      }
      const payload = {
        namespace: ns, name,
        data_base64: dataB64,
        content_type: contentType,
        compression,
        metadata: meta
      };
      await state.api.put(payload);
      Toast.show("Версия сохранена");
      $("#namespace").value = ns;
      await loadList();
    } catch (e) {
      Toast.show(`Ошибка сохранения: ${e.message}`, "error");
    }
  }

  /** Read */
  async function readSecret() {
    const ns = $("#rNamespace").value.trim();
    const name = $("#rName").value.trim();
    const version = Number($("#rVersion").value) || undefined;
    const include_deleted = $("#rIncludeDeleted").value === "true";
    if (!ns || !name) { Toast.show("Укажите namespace и name", "warn"); return; }
    try {
      const res = await state.api.get(ns, name, { version, include_deleted });
      // Ожидаемый ответ: { data_base64, content_type, metadata, created_at, compression, size_plain, size_compressed, sha256, ref:{namespace,name,version}}
      const b64 = res?.data_base64 || "";
      const text = decodeURIComponent(escape(atob(b64)));
      $("#rData").value = text;
      $("#readMeta").textContent = `v=${res?.ref?.version ?? "-"} type=${res?.content_type ?? "-"} size=${res?.size_plain ?? "-"} sha256=${hexShort(res?.sha256)}`;
    } catch (e) {
      Toast.show(`Ошибка чтения: ${e.message}`, "error");
    }
  }

  /** Download secret bytes */
  async function downloadSecret() {
    const ns = $("#rNamespace").value.trim();
    const name = $("#rName").value.trim();
    const version = Number($("#rVersion").value) || undefined;
    const include_deleted = $("#rIncludeDeleted").value === "true";
    if (!ns || !name) { Toast.show("Укажите namespace и name", "warn"); return; }
    try {
      const res = await state.api.get(ns, name, { version, include_deleted });
      const b64 = res?.data_base64 || "";
      const raw = atob(b64);
      const buf = new Uint8Array(raw.length);
      for (let i=0; i<raw.length; i++) buf[i] = raw.charCodeAt(i);
      const v = res?.ref?.version ?? "current";
      const fname = `${ns}_${name}_v${v}.bin`.replace(/[^\w.\-]+/g, "_");
      downloadBytes(buf, fname, res?.content_type || "application/octet-stream");
    } catch (e) {
      Toast.show(`Ошибка скачивания: ${e.message}`, "error");
    }
  }

  /** Rotate / Delete */
  async function rotateKey() {
    const ns = $("#dNamespace").value.trim();
    const name = $("#dName").value.trim();
    if (!ns || !name) { Toast.show("Укажите namespace и name", "warn"); return; }
    try {
      await state.api.rotate(ns, name, {});
      Toast.show("Ключ перевёрнут (rewrap) для текущей версии");
    } catch (e) {
      Toast.show(`Ошибка ротации: ${e.message}`, "error");
    }
  }

  async function deleteItem(soft=true) {
    const ns = $("#dNamespace").value.trim();
    const name = $("#dName").value.trim();
    if (!ns || !name) { Toast.show("Укажите namespace и name", "warn"); return; }
    try {
      await state.api.remove(ns, name, { soft });
      Toast.show(soft ? "Soft delete выполнен" : "Hard purge выполнен");
      if ($("#namespace").value.trim() === ns) await loadList();
    } catch (e) {
      Toast.show(`Ошибка удаления: ${e.message}`, "error");
    }
  }

  /** Ping */
  async function ping() {
    const el = $("#connStatus");
    try {
      await state.api.ping();
      el.classList.add("ok");
      el.querySelector(".muted").textContent = "online";
    } catch {
      el.classList.remove("ok");
      el.querySelector(".muted").textContent = "offline";
    }
  }

  /** Wire events */
  function wire() {
    $("#btnSaveCfg").addEventListener("click", () => { saveConfigFromUI(); Toast.show("Настройки сохранены"); });
    $("#btnPing").addEventListener("click", ping);
    $("#btnReload").addEventListener("click", loadList);
    $("#btnPut").addEventListener("click", putSecret);
    $("#btnClearForm").addEventListener("click", () => {
      $("#iNamespace").value = ""; $("#iName").value=""; $("#iData").value=""; $("#iMetadata").value="";
      $("#iFile").value = ""; $("#iContentType").value="application/octet-stream"; $("#iCompression").value="gzip";
    });
    $("#btnRead").addEventListener("click", readSecret);
    $("#btnDownload").addEventListener("click", downloadSecret);
    $("#btnRotate").addEventListener("click", rotateKey);
    $("#btnSoftDelete").addEventListener("click", () => deleteItem(true));
    $("#btnHardDelete").addEventListener("click", () => deleteItem(false));

    // Instant apply on controls change for better UX
    $("#authMode").addEventListener("change", () => { saveConfigFromUI(); });
    $("#baseUrl").addEventListener("change", () => { saveConfigFromUI(); });
    $("#token").addEventListener("change", () => { saveConfigFromUI(); });
    $("#csrf").addEventListener("change", () => { saveConfigFromUI(); });
    $("#timeoutSec").addEventListener("change", () => { saveConfigFromUI(); });

    // Enter in search
    $("#q").addEventListener("keydown", (e) => { if (e.key === "Enter") $("#btnReload").click(); });
  }

  /** Bootstrap */
  initConfig();
  wire();
  ping().then(loadList);

</script>
</body>
</html>
