#######################################################################
# Aethernova Chain Core — RPC configuration (industrial-grade)
# File: configs/rpc.toml
# Profiles:
#  - btc2_finality  : максимальная финализация, строгая безопасность, низкий TPS
#  - parallel_exec  : параллельное исполнение, высокий TPS, агрессивные лимиты
#  - zk_priv_tx     : приватные транзакции, ZK/Privacy сервисы
#
# Как пользоваться:
#   1) Скопируйте нужный профиль в отдельный файл или укажите через
#      переменную окружения: AE_RPC_PROFILE=btc2_finality
#   2) Параметры можно переопределять через ENV:
#      AE_RPC__RPC__HTTP__PORT=8545  (двойное подчеркивание = ".")
#######################################################################

###########################
# Default (base) settings #
###########################
[default.meta]
name      = "aethernova-chain-core"
component = "rpc"
version   = "1.0.0"
profile   = "base"
env       = "production"

[default.paths]
data_dir   = "/var/lib/aethernova"
logs_dir   = "/var/log/aethernova"
secrets_dir= "/etc/aethernova/secrets"
pid_file   = "/run/aethernova/rpc.pid"

[default.rpc.http]
enabled         = true
bind_addr       = "0.0.0.0"
port            = 8545
# Доступные модули (пример): web3, eth, net, debug, trace, txpool, admin, health
modules         = ["web3","net","eth","txpool","health"]
# CORS & Host security
allowed_origins = ["https://dashboard.aethernova.local"]
allowed_hosts   = ["rpc.aethernova.local"]
# Таймауты и лимиты
read_timeout_ms  = 15000
write_timeout_ms = 15000
idle_timeout_ms  = 60000
max_header_bytes = 1048576   # 1 MiB

[default.rpc.ws]
enabled         = false
bind_addr       = "0.0.0.0"
port            = 8546
subprotocols    = ["jsonrpc"]
read_timeout_ms  = 15000
write_timeout_ms = 15000
idle_timeout_ms  = 60000
max_msg_bytes    = 5242880    # 5 MiB
permessage_deflate = true

[default.rpc.grpc]
enabled         = false
bind_addr       = "127.0.0.1"
port            = 50051
max_recv_mb     = 64
max_send_mb     = 64

[default.security.tls]
enabled          = true
# Используйте полные пути к ключам/сертификатам
cert_file        = "/etc/aethernova/tls/rpc.crt"
key_file         = "/etc/aethernova/tls/rpc.key"
client_auth      = "require"     # none|request|require
client_ca_file   = "/etc/aethernova/tls/ca.crt"
min_tls_version  = "1.2"
cipher_suites    = ["TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384","TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"]

[default.security.auth]
# Выберите один механизм: "none", "basic", "jwt", "mtls"
mechanism        = "jwt"
basic_user       = ""
basic_password   = ""
jwt_issuer       = "aethernova"
jwt_audience     = "rpc"
jwt_clock_skew_s = 60
# JWKs или статический публичный ключ
jwks_url         = "https://auth.aethernova.local/.well-known/jwks.json"
public_key_file  = ""

[default.security.acl]
# Список разрешённых методов по ролям
[[default.security.acl.roles]]
name    = "reader"
methods = ["web3_*","net_*","eth_blockNumber","eth_get*","health_*"]

[[default.security.acl.roles]]
name    = "trader"
methods = ["eth_sendRawTransaction","eth_estimateGas","eth_gasPrice","eth_get*","txpool_*"]

[[default.security.acl.roles]]
name    = "admin"
methods = ["*"]

[default.security.ddos]
# Простая защита от DoS/Bruteforce
enabled            = true
ip_rate_per_sec    = 20
ip_burst           = 40
global_rate_per_sec= 2000
global_burst       = 4000
ban_threshold      = 500          # число нарушений до бана
ban_ttl_s          = 900          # 15 минут
token_bucket_leak_s= 1

[default.security.limits]
# Ограничители нагрузки на уровень процесса
max_concurrent_requests = 2048
queue_capacity          = 8192
request_body_max_mb     = 16
response_body_max_mb    = 64

[default.observability.logging]
level        = "info"      # trace|debug|info|warn|error
format       = "json"      # json|text
file_rotate  = true
max_size_mb  = 200
max_backups  = 10
max_age_days = 14
compress     = true
redact_keys  = ["authorization","cookie","set-cookie","x-api-key"]

[default.observability.metrics]
enabled        = true
bind_addr      = "127.0.0.1"
port           = 9102
path           = "/metrics"
labels         = { service = "rpc", chain = "aethernova" }

[default.observability.tracing]
enabled        = true
exporter       = "otlp"     # otlp|jaeger|zipkin
endpoint       = "http://127.0.0.1:4317"
sample_ratio   = 0.05
propagation    = ["tracecontext","baggage"]

[default.p2p]
# Параметры p2p для некоторых RPC методов (admin/net)
network_id     = 13371
chain_id       = 13371
listen_addr    = "0.0.0.0:30303"
max_peers      = 80
min_peers      = 8
nat            = "any"    # any|none|extip
# статические пиры
static_peers   = []
# доверенные пиры
trusted_peers  = []
# запрет на контакты
blocked_peers  = []

[default.consensus]
# Общие опции, специфичные детали настраиваются профилями
engine           = "pos-finality" # пример
finality_target_s= 10
vote_timeout_ms  = 1500
sync_mode        = "snap"         # full|fast|snap

[default.execution]
# Общие опции исполнителя
parallelism               = 4
max_gas_per_block         = 30000000
intrinsic_gas_cost        = 21000
txpool_soft_limit         = 102400   # кол-во транзакций
txpool_hard_limit         = 204800
txpool_price_limit_wei    = 0
txpool_pricelimit_policy  = "none"   # none|percentile|ewma
evm_tracer_enabled        = false
precompile_cache_entries  = 16384

[default.database]
engine              = "rocksdb"  # rocksdb|pebbledb|lmdb
path                = "/var/lib/aethernova/chaindata"
block_cache_mb      = 8192
write_buffer_mb     = 256
max_open_files      = 4096
compaction_style    = "level"
compression         = "zstd"
verify_on_open      = true

[default.snapshots]
enabled             = true
interval_blocks     = 50000
target_dir          = "/var/lib/aethernova/snapshots"
prune_after_apply   = true

[default.gc]
enabled             = true
interval_s          = 60
target_mem_mb       = 16384

#################################
# Profile: btc2_finality        #
#################################
[profiles.btc2_finality.meta]
extends  = "default"
profile  = "btc2_finality"
env      = "production"

[profiles.btc2_finality.rpc.http]
modules           = ["web3","net","eth","health"]
read_timeout_ms   = 20000
write_timeout_ms  = 20000
idle_timeout_ms   = 90000

[profiles.btc2_finality.security.auth]
mechanism         = "mtls" # mTLS для строгой аутентификации

[profiles.btc2_finality.security.ddos]
ip_rate_per_sec     = 10
ip_burst            = 20
global_rate_per_sec = 800
global_burst        = 1600
ban_threshold       = 200
ban_ttl_s           = 1800

[profiles.btc2_finality.security.limits]
max_concurrent_requests = 1024
queue_capacity          = 4096
request_body_max_mb     = 8
response_body_max_mb    = 32

[profiles.btc2_finality.consensus]
finality_target_s     = 5    # агрессивная финализация
vote_timeout_ms       = 1000

[profiles.btc2_finality.execution]
parallelism              = 2
max_gas_per_block        = 15000000
txpool_soft_limit        = 40960
txpool_hard_limit        = 81920
evm_tracer_enabled       = false

[profiles.btc2_finality.database]
block_cache_mb           = 4096
write_buffer_mb          = 128

#################################
# Profile: parallel_exec        #
#################################
[profiles.parallel_exec.meta]
extends  = "default"
profile  = "parallel_exec"
env      = "production"

[profiles.parallel_exec.rpc.http]
modules             = ["web3","net","eth","txpool","debug","trace","health"]
read_timeout_ms     = 10000
write_timeout_ms    = 10000
idle_timeout_ms     = 60000
allowed_origins     = ["https://ops.aethernova.local","https://dashboard.aethernova.local"]

[profiles.parallel_exec.security.auth]
mechanism           = "jwt"
jwks_url            = "https://auth.aethernova.local/.well-known/jwks.json"

[profiles.parallel_exec.security.ddos]
ip_rate_per_sec       = 50
ip_burst              = 100
global_rate_per_sec   = 5000
global_burst          = 10000
ban_threshold         = 1200
ban_ttl_s             = 900

[profiles.parallel_exec.security.limits]
max_concurrent_requests = 8192
queue_capacity          = 65536
request_body_max_mb     = 32
response_body_max_mb    = 128

[profiles.parallel_exec.execution]
parallelism               = 32
max_gas_per_block         = 60000000
txpool_soft_limit         = 262144
txpool_hard_limit         = 524288
txpool_pricelimit_policy  = "percentile" # динамический порог входа
evm_tracer_enabled        = true
precompile_cache_entries  = 65536

[profiles.parallel_exec.database]
block_cache_mb            = 16384
write_buffer_mb           = 1024
max_open_files            = 8192
compression               = "zstd"

#################################
# Profile: zk_priv_tx           #
#################################
[profiles.zk_priv_tx.meta]
extends  = "default"
profile  = "zk_priv_tx"
env      = "production"

[profiles.zk_priv_tx.rpc.http]
modules              = ["web3","net","eth","txpool","health","privacy","zk"]
read_timeout_ms      = 20000
write_timeout_ms     = 20000
idle_timeout_ms      = 90000
allowed_origins      = ["https://wallet.aethernova.local"]

[profiles.zk_priv_tx.security.auth]
mechanism            = "jwt"
jwks_url             = "https://auth.aethernova.local/.well-known/jwks.json"
# Дополнительная привязка к ролям
# reader/trader/admin — определены в default.security.acl

[profiles.zk_priv_tx.security.ddos]
ip_rate_per_sec        = 15
ip_burst               = 30
global_rate_per_sec    = 1500
global_burst           = 3000
ban_threshold          = 400
ban_ttl_s              = 1800

[profiles.zk_priv_tx.security.limits]
max_concurrent_requests = 2048
queue_capacity          = 16384
request_body_max_mb     = 64      # ZK-пруфы крупные
response_body_max_mb    = 256

# Настройки приватности/ZK подсистем
[profiles.zk_priv_tx.privacy]
enable_stealth_addresses   = true
enable_commitment_index    = true
note_db_path               = "/var/lib/aethernova/privacy-notes"
nullifier_cache_entries    = 1048576
witness_cache_entries      = 131072

[profiles.zk_priv_tx.zk]
# Генерация/верификация пруфов
prover_endpoint            = "http://127.0.0.1:7870"
verifier_threads           = 8
proof_timeout_ms           = 60000
circuit_dir                = "/opt/aethernova/zk/circuits"
srs_dir                    = "/opt/aethernova/zk/srs"
# Буферизация пруфов
proof_queue_capacity       = 8192
proof_batch_size           = 32

[profiles.zk_priv_tx.execution]
parallelism                = 8
max_gas_per_block          = 25000000
txpool_soft_limit          = 131072
txpool_hard_limit          = 262144
evm_tracer_enabled         = false

[profiles.zk_priv_tx.database]
block_cache_mb             = 8192
write_buffer_mb            = 256

##########################
# Effective profile gate #
##########################
# Укажите активный профиль, если парсер поддерживает прямое чтение.
# Иначе используйте ENV AE_RPC_PROFILE или CLI флаг.
[active]
profile = "btc2_finality"
