# aethernova-chain-core/ops/terraform/modules/k8s-observability/prometheus-stack/values/dev.yaml

############################################
# Глобальные дефолты для dev
############################################
fullnameOverride: prometheus-stack-dev

############################################
# Alertmanager — безопасная "тихая" маршрутизация по умолчанию
# (в dev ничего не отправляем наружу)
############################################
alertmanager:
  enabled: true
  service:
    type: ClusterIP
  alertmanagerSpec:
    replicas: 1
    # Храним внутренние данные AM в памяти (по умолчанию у оператора — emptyDir)
    # Персистентность для dev не включаем.
    retention: 120h  # дефолт AM — 120h; можно уменьшить при необходимости
  # Конфигурация совместима со спеком Alertmanager
  # route/receivers/inhibit_rules — по официальной схеме
  # В dev все алерты отправляются в "dev-null"
  config:
    global: {}
    route:
      receiver: dev-null
      group_by: ["alertname", "cluster", "service"]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
    receivers:
      - name: dev-null
    inhibit_rules: []  # при необходимости добавьте правила подавления

############################################
# Prometheus — компактное хранение и безопасные пределы для dev
############################################
prometheus:
  enabled: true
  service:
    type: ClusterIP
    port: 9090
  prometheusSpec:
    replicas: 1
    # Удержание метрик для dev — 24 часа.
    # Поле retention соответствует --storage.tsdb.retention.time
    retention: 24h
    # В dev не включаем remoteWrite и долговременное хранилище
    storageSpec:
      emptyDir: {}  # эпемерное хранилище; для prod подмените на PVC
    # По умолчанию оператор подтянет ServiceMonitor/PodMonitor согласно селекторам чарта
    ruleNamespaceSelector: {}
    podMonitorNamespaceSelector: {}
    serviceMonitorNamespaceSelector: {}
    # Ресурсы — скромные значения для небольших кластеров dev
    resources:
      requests:
        cpu: "250m"
        memory: "512Mi"
      limits:
        cpu: "1"
        memory: "2Gi"

############################################
# Grafana — включено; sidecar для дашбордов/алертов
############################################
grafana:
  enabled: true

  # Рекомендовано хранить креды в существующем секрете (не в values)
  # Секрет должен содержать ключи admin-user и admin-password
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: false  # в dev не публикуем наружу

  persistence:
    enabled: false  # dev: без постоянного тома; для prod включите и задайте size/class

  # Автозагрузка дашбордов и алертов через sidecar по меткам в ConfigMap/Secret
  sidecar:
    dashboards:
      enabled: true
      # Метка, по которой sidecar подберёт дашборды
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL  # dev: искать во всех неймспейсах
      provider:
        allowUiUpdates: true
        foldersFromFilesStructure: true
    alerts:
      enabled: true
      label: grafana_alert
      labelValue: "1"
      searchNamespace: ALL

  # Базовые ресурсы для dev
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

############################################
# kube-state-metrics и node-exporter — включены (dev/cluster базовый набор)
############################################
kubeStateMetrics:
  enabled: true

nodeExporter:
  enabled: true

############################################
# Оператор Prometheus — включён; вебхуки допусков по умолчанию
############################################
prometheusOperator:
  enabled: true
  admissionWebhooks:
    enabled: true  # отключение может приводить к ошибкам шаблонов/секретов
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

############################################
# Правила по умолчанию — включены (можно сузить при необходимости)
############################################
defaultRules:
  create: true
  # В dev можно точечно отключать шумные группы правил, если потребуется
  rules:
    kubeApiserverSlos: true
    kubernetesResources: true
    kubernetesSystem: true
    node: true
    prometheus: true
    prometheusOperator: true
