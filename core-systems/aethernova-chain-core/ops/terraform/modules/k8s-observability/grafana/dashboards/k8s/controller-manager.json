{
  "uid": "k8s-controller-manager",
  "title": "K8s / Controller Manager",
  "schemaVersion": 39,
  "version": 1,
  "editable": true,
  "style": "dark",
  "timezone": "",
  "tags": ["kubernetes", "controller-manager", "workqueue"],
  "refresh": "30s",
  "time": { "from": "now-24h", "to": "now" },
  "timepicker": { "refresh_intervals": ["10s","30s","1m","5m","15m"] },
  "graphTooltip": 1,
  "links": [],
  "panels": [
    {
      "type": "stat",
      "title": "Controller-Manager up (instances)",
      "id": 1,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum(up{job=~\"$job\",instance=~\"$instance\"})" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "decimals": 0,
          "thresholds": { "mode": "absolute", "steps": [ { "color": "red" }, { "color": "green", "value": 1 } ] }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false }, "colorMode": "value" }
    },
    {
      "type": "stat",
      "title": "Leader present",
      "id": 2,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum(max by (instance) ($leader_gauge_metric{job=~\"$job\",instance=~\"$instance\"}))" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "red" }, { "color": "green", "value": 1 } ] }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false }, "colorMode": "value" }
    },
    {
      "type": "table",
      "title": "Current leader (by instance)",
      "id": 3,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 0 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "topk(1, $leader_gauge_metric{job=~\"$job\",instance=~\"$instance\"})" }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "mode": "columns" } },
        { "id": "organize", "options": { "renameByName": { "Value": "leader" } } }
      ],
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 0 }, "overrides": [] },
      "options": { "showHeader": true }
    },
    {
      "type": "timeseries",
      "title": "Workqueue depth by controller",
      "id": 10,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (name) ($depth_metric{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"})", "legendFormat": "{{name}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10, "showPoints": "never", "spanNulls": true }
        },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull","max","min","mean"] }, "tooltip": { "mode": "multi", "sort": "desc" } }
    },
    {
      "type": "timeseries",
      "title": "Workqueue adds (rate by controller)",
      "id": 11,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (name) (rate($adds_total_metric{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval]))", "legendFormat": "{{name}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 8, "showPoints": "never", "spanNulls": true }
        },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" }, "tooltip": { "mode": "multi", "sort": "desc" } }
    },
    {
      "type": "timeseries",
      "title": "Workqueue retries (rate by controller)",
      "id": 12,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (name) (rate($retries_total_metric{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval]))", "legendFormat": "{{name}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 8, "showPoints": "never", "spanNulls": true }
        },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" }, "tooltip": { "mode": "multi", "sort": "desc" } }
    },
    {
      "type": "timeseries",
      "title": "Queue latency (P50/P90/P99)",
      "id": 13,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "histogram_quantile(0.50, sum by (le,name) (rate($queue_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p50 {{name}}" },
        { "refId": "B", "editorMode": "code", "expr": "histogram_quantile(0.90, sum by (le,name) (rate($queue_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p90 {{name}}" },
        { "refId": "C", "editorMode": "code", "expr": "histogram_quantile(0.99, sum by (le,name) (rate($queue_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p99 {{name}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 3 }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull","max","mean"] } }
    },
    {
      "type": "timeseries",
      "title": "Work duration (P50/P90/P99)",
      "id": 14,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "histogram_quantile(0.50, sum by (le,name) (rate($work_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p50 {{name}}" },
        { "refId": "B", "editorMode": "code", "expr": "histogram_quantile(0.90, sum by (le,name) (rate($work_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p90 {{name}}" },
        { "refId": "C", "editorMode": "code", "expr": "histogram_quantile(0.99, sum by (le,name) (rate($work_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[$__rate_interval])))", "legendFormat": "p99 {{name}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 3 }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull","max","mean"] } }
    },
    {
      "type": "table",
      "title": "Top controllers by queue depth (current)",
      "id": 15,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "topk(10, max by (name) ($depth_metric{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}))" }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "mode": "columns" } },
        { "id": "organize", "options": { "renameByName": { "Value": "depth" } } }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "options": { "showHeader": true }
    },
    {
      "type": "timeseries",
      "title": "REST client requests (rate by code,verb)",
      "id": 20,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 28 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (code,verb) (rate($rest_client_requests_total{job=~\"$job\",instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "{{verb}} {{code}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull","max"] }, "tooltip": { "mode": "multi", "sort": "desc" } }
    },
    {
      "type": "timeseries",
      "title": "REST client latency (P99)",
      "id": 21,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 28 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "histogram_quantile(0.99, sum by (le) (rate($rest_client_latency_bucket{job=~\"$job\",instance=~\"$instance\"}[$__rate_interval])))", "legendFormat": "p99" }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 3 }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Process CPU (cores)",
      "id": 30,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 36 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (instance) (rate($process_cpu_seconds_total{job=~\"$job\",instance=~\"$instance\"}[5m]))", "legendFormat": "{{instance}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "cores", "decimals": 2 }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Process RSS (bytes)",
      "id": 31,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 36 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (instance) ($process_resident_memory_bytes{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "{{instance}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Go goroutines / GC p99 (s)",
      "id": 32,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 6, "w": 8, "x": 16, "y": 36 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "sum by (instance) (go_goroutines{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "{{instance}} goroutines" },
        { "refId": "B", "editorMode": "code", "expr": "histogram_quantile(0.99, sum by (le,instance) (rate(go_gc_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\"}[$__rate_interval])))", "legendFormat": "{{instance}} gc p99" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull","max"] } }
    },
    {
      "type": "stat",
      "title": "Pod restarts (last 1h)",
      "id": 40,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 42 },
      "targets": [
        {
          "refId": "A",
          "editorMode": "code",
          "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\",pod=~\"$pod\",container=~\"$container_regex\"}[1h]))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 0 }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false }, "colorMode": "value" }
    },
    {
      "type": "table",
      "title": "Slowest controllers by queue p99 (last 15m)",
      "id": 41,
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "gridPos": { "h": 8, "w": 18, "x": 6, "y": 42 },
      "targets": [
        {
          "refId": "A",
          "editorMode": "code",
          "expr": "topk(10, histogram_quantile(0.99, sum by (le,name) (rate($queue_duration_hist_bucket{job=~\"$job\",instance=~\"$instance\",name=~\"$controller\"}[15m]))))"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "mode": "columns" } },
        { "id": "organize", "options": { "renameByName": { "Value": "p99_seconds" } } }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 3 }, "overrides": [] },
      "options": { "showHeader": true }
    }
  ],
  "templating": {
    "list": [
      { "type": "datasource", "name": "DS_PROM", "label": "Prometheus", "query": "prometheus", "hide": 0 },
      {
        "type": "query",
        "name": "job",
        "label": "job (controller-manager)",
        "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
        "query": "label_values(up, job)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "hide": 0
      },
      {
        "type": "query",
        "name": "instance",
        "label": "instance",
        "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
        "query": "label_values(up{job=~\"$job\"}, instance)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "hide": 0
      },
      { "type": "textbox", "name": "controller", "label": "controller regex (workqueue name)", "value": ".*", "hide": 0 },
      { "type": "textbox", "name": "namespace", "label": "namespace (kube-system)", "value": "kube-system", "hide": 0 },
      { "type": "textbox", "name": "pod", "label": "pod regex", "value": ".*controller.*", "hide": 0 },
      { "type": "textbox", "name": "container_regex", "label": "container regex", "value": ".*controller.*", "hide": 0 },

      { "type": "textbox", "name": "leader_gauge_metric", "label": "leader gauge metric", "value": "leader_election_master_status", "hide": 0 },

      { "type": "textbox", "name": "adds_total_metric", "label": "workqueue adds _total", "value": "workqueue_adds_total", "hide": 0 },
      { "type": "textbox", "name": "retries_total_metric", "label": "workqueue retries _total", "value": "workqueue_retries_total", "hide": 0 },
      { "type": "textbox", "name": "depth_metric", "label": "workqueue depth", "value": "workqueue_depth", "hide": 0 },
      { "type": "textbox", "name": "queue_duration_hist_bucket", "label": "queue duration _bucket", "value": "workqueue_queue_duration_seconds_bucket", "hide": 0 },
      { "type": "textbox", "name": "work_duration_hist_bucket", "label": "work duration _bucket", "value": "workqueue_work_duration_seconds_bucket", "hide": 0 },

      { "type": "textbox", "name": "rest_client_requests_total", "label": "rest client requests _total", "value": "rest_client_requests_total", "hide": 0 },
      { "type": "textbox", "name": "rest_client_latency_bucket", "label": "rest client latency _bucket", "value": "rest_client_request_duration_seconds_bucket", "hide": 0 },

      { "type": "textbox", "name": "process_cpu_seconds_total", "label": "process cpu seconds", "value": "process_cpu_seconds_total", "hide": 0 },
      { "type": "textbox", "name": "process_resident_memory_bytes", "label": "process rss bytes", "value": "process_resident_memory_bytes", "hide": 0 }
    ]
  },
  "annotations": { "list": [] }
}
