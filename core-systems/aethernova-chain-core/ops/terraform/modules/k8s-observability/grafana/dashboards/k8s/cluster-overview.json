{
  "id": null,
  "uid": "k8s-cluster-overview-aethernova",
  "title": "Kubernetes Cluster Overview (Aethernova)",
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "editable": true,
  "style": "dark",
  "tags": ["kubernetes", "cluster", "overview", "prometheus", "aethernova"],
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": { "refresh_intervals": ["10s","30s","1m","5m","15m"], "time_options": ["1h","6h","12h","24h","7d","30d"] },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "type": "dashboard",
        "name": "Annotations & Alerts",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)"
      }
    ]
  },
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_PROMETHEUS",
        "label": "Prometheus",
        "query": "prometheus",
        "hide": 0
      },
      {
        "type": "query",
        "name": "job_ksm",
        "label": "job (kube-state-metrics)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(kube_pod_status_phase, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "job_node",
        "label": "job (node_exporter)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(node_cpu_seconds_total, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "job_apiserver",
        "label": "job (kube-apiserver)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(apiserver_request_total, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "job_scheduler",
        "label": "job (kube-scheduler)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(scheduler_e2e_scheduling_duration_seconds_bucket, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "job_controller",
        "label": "job (kube-controller-manager)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(workqueue_depth, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "job_etcd",
        "label": "job (etcd)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 1,
        "query": "label_values(etcd_server_has_leader, job)",
        "includeAll": false
      },
      {
        "type": "query",
        "name": "namespace",
        "label": "Namespace (filter)",
        "datasource": "$DS_PROMETHEUS",
        "refresh": 2,
        "query": "label_values(kube_namespace_labels, namespace)",
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "regex": ""
      }
    ]
  },
  "panels": [
    {
      "type": "row",
      "title": "Cluster State",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }
    },
    {
      "type": "stat",
      "title": "Nodes Ready",
      "description": "Количество узлов в состоянии Ready.",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(kube_node_status_condition{condition=\"Ready\",status=\"true\",job=\"$job_ksm\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none", "thresholds": { "mode": "absolute", "steps": [ { "color": "red", "value": null }, { "color": "green", "value": 1 } ] } } },
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Nodes NotReady",
      "description": "Количество узлов не Ready.",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(kube_node_status_condition{condition=\"Ready\",status=\"false\",job=\"$job_ksm\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none", "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null }, { "color": "red", "value": 1 } ] } } },
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Pods Running",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(kube_pod_status_phase{phase=\"Running\",job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Pods Pending",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(kube_pod_status_phase{phase=\"Pending\",job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Pods Failed",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(kube_pod_status_phase{phase=\"Failed\",job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Namespaces",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "count(count by (namespace) (kube_namespace_labels{job=\"$job_ksm\",namespace=~\"$namespace\"}))" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 1 }
    },
    {
      "type": "stat",
      "title": "Deployments",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "count(kube_deployment_spec_replicas{job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 5 }
    },
    {
      "type": "stat",
      "title": "DaemonSets",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "count(kube_daemonset_status_desired_number_scheduled{job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 5 }
    },
    {
      "type": "stat",
      "title": "StatefulSets",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "count(kube_statefulset_replicas{job=\"$job_ksm\",namespace=~\"$namespace\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none" } },
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 5 }
    },

    {
      "type": "row",
      "title": "Capacity & Requests",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 9 }
    },
    {
      "type": "gauge",
      "title": "CPU Requests / Allocatable (%)",
      "datasource": "$DS_PROMETHEUS",
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [
        {
          "expr": "100 * sum by () ( sum by (namespace,pod) ( max by (namespace,pod,container) (kube_pod_container_resource_requests{resource=\"cpu\",unit=\"core\",job=\"$job_ksm\",namespace=~\"$namespace\"}) * on(namespace,pod) group_left() max by (namespace,pod) (kube_pod_status_phase{phase=~\"Pending|Running\",job=\"$job_ksm\"} == 1) ) ) / sum(kube_node_status_allocatable{resource=\"cpu\",unit=\"core\",job=\"$job_ksm\"})"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 200 } },
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 10 }
    },
    {
      "type": "gauge",
      "title": "CPU Limits / Allocatable (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "expr": "100 * sum by () ( sum by (namespace,pod) ( max by (namespace,pod,container) (kube_pod_container_resource_limits{resource=\"cpu\",unit=\"core\",job=\"$job_ksm\",namespace=~\"$namespace\"}) * on(namespace,pod) group_left() max by (namespace,pod) (kube_pod_status_phase{phase=~\"Pending|Running\",job=\"$job_ksm\"} == 1) ) ) / sum(kube_node_status_allocatable{resource=\"cpu\",unit=\"core\",job=\"$job_ksm\"})"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 200 } },
      "gridPos": { "h": 6, "w": 6, "x": 6, "y": 10 }
    },
    {
      "type": "gauge",
      "title": "Memory Requests / Allocatable (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "expr": "100 * sum by () ( sum by (namespace,pod) ( max by (namespace,pod,container) (kube_pod_container_resource_requests{resource=\"memory\",unit=\"byte\",job=\"$job_ksm\",namespace=~\"$namespace\"}) * on(namespace,pod) group_left() max by (namespace,pod) (kube_pod_status_phase{phase=~\"Pending|Running\",job=\"$job_ksm\"} == 1) ) ) / sum(kube_node_status_allocatable{resource=\"memory\",unit=\"byte\",job=\"$job_ksm\"})"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 200 } },
      "gridPos": { "h": 6, "w": 6, "x": 12, "y": 10 }
    },
    {
      "type": "gauge",
      "title": "Memory Limits / Allocatable (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "expr": "100 * sum by () ( sum by (namespace,pod) ( max by (namespace,pod,container) (kube_pod_container_resource_limits{resource=\"memory\",unit=\"byte\",job=\"$job_ksm\",namespace=~\"$namespace\"}) * on(namespace,pod) group_left() max by (namespace,pod) (kube_pod_status_phase{phase=~\"Pending|Running\",job=\"$job_ksm\"} == 1) ) ) / sum(kube_node_status_allocatable{resource=\"memory\",unit=\"byte\",job=\"$job_ksm\"})"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 200 } },
      "gridPos": { "h": 6, "w": 6, "x": 18, "y": 10 }
    },

    {
      "type": "row",
      "title": "Control Plane Health",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 16 }
    },
    {
      "type": "timeSeries",
      "title": "API Server p99 latency (non-LIST/WATCH)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(apiserver_request_duration_seconds_bucket{job=\"$job_apiserver\",verb!~\"LIST|WATCH\"}[5m])) by (le))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } },
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 17 }
    },
    {
      "type": "timeSeries",
      "title": "API Server 5xx rate (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "100 * sum(rate(apiserver_request_total{job=\"$job_apiserver\",code=~\"5..\"}[5m])) / sum(rate(apiserver_request_total{job=\"$job_apiserver\"}[5m]))" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 17 }
    },
    {
      "type": "stat",
      "title": "etcd: has leader",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "min(etcd_server_has_leader{job=\"$job_etcd\"})" }
      ],
      "fieldConfig": { "defaults": { "unit": "none", "thresholds": { "mode": "absolute", "steps": [ { "color": "red", "value": 0 }, { "color": "green", "value": 1 } ] } } },
      "gridPos": { "h": 6, "w": 4, "x": 16, "y": 17 }
    },
    {
      "type": "timeSeries",
      "title": "etcd leader changes / 1h",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(increase(etcd_server_leader_changes_seen_total{job=\"$job_etcd\"}[1h]))" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 23 }
    },
    {
      "type": "timeSeries",
      "title": "Scheduler p99 e2e scheduling latency",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "histogram_quantile(0.99, sum(rate(scheduler_e2e_scheduling_duration_seconds_bucket{job=\"$job_scheduler\"}[5m])) by (le))" }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } },
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 23 }
    },
    {
      "type": "timeSeries",
      "title": "Controller Manager workqueue depth (top 5)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "topk(5, sum by (name) (workqueue_depth{job=\"$job_controller\"}))" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "gridPos": { "h": 6, "w": 8, "x": 16, "y": 23 }
    },

    {
      "type": "row",
      "title": "Infra Utilization (node_exporter)",
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 29 }
    },
    {
      "type": "timeSeries",
      "title": "Cluster CPU utilization (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "100 * sum(rate(node_cpu_seconds_total{job=\"$job_node\",mode!=\"idle\"}[5m])) / sum(rate(node_cpu_seconds_total{job=\"$job_node\"}[5m]))" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 30 }
    },
    {
      "type": "timeSeries",
      "title": "Cluster Memory utilization (%)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "100 * (1 - sum(node_memory_MemAvailable_bytes{job=\"$job_node\"}) / sum(node_memory_MemTotal_bytes{job=\"$job_node\"}))" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 30 }
    },
    {
      "type": "timeSeries",
      "title": "Filesystem usage (%) (root mounts)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        {
          "expr": "100 * (1 - sum(node_filesystem_avail_bytes{job=\"$job_node\",fstype!~\"tmpfs|overlay\"}) / sum(node_filesystem_size_bytes{job=\"$job_node\",fstype!~\"tmpfs|overlay\"}))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 36 }
    },
    {
      "type": "timeSeries",
      "title": "Network rate (receive / transmit, bytes/s)",
      "datasource": "$DS_PROMETHEUS",
      "targets": [
        { "expr": "sum(rate(node_network_receive_bytes_total{job=\"$job_node\",device!~\"lo\"}[5m]))", "legendFormat": "rx" },
        { "expr": "sum(rate(node_network_transmit_bytes_total{job=\"$job_node\",device!~\"lo\"}[5m]))", "legendFormat": "tx" }
      ],
      "fieldConfig": { "defaults": { "unit": "Bps" } },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 36 }
    }
  ]
}
