{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "iteration": 1,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "timeseries",
      "title": "RPC QPS (total)",
      "description": "Total request rate across HTTP + gRPC + OTel RPC",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job) (\n  rate(grpc_server_handled_total{job=~\"$job\"}[$__rate_interval])\n) + sum by (job) (\n  rate(http_requests_total{job=~\"$job\"}[$__rate_interval])\n) + sum by (job) (\n  rate(rpc_server_duration_seconds_count{job=~\"$job\"}[$__rate_interval])\n)",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "req/s",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] }
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom", "calcs": [ "last", "max", "mean" ] },
        "tooltip": { "mode": "multi", "sort": "none" }
      }
    },
    {
      "type": "timeseries",
      "title": "HTTP 5xx (rps)",
      "description": "Rate of server errors (5xx) per job",
      "gridPos": { "h": 8, "w": 6, "x": 12, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job) (rate(http_requests_total{job=~\"$job\", code=~\"5..\"}[$__rate_interval])) + sum by (job) (rate(http_requests_total{job=~\"$job\", status=~\"5..\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "req/s" },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "HTTP 4xx (rps)",
      "description": "Rate of client errors (4xx) per job",
      "gridPos": { "h": 8, "w": 6, "x": 18, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job) (rate(http_requests_total{job=~\"$job\", code=~\"4..\"}[$__rate_interval])) + sum by (job) (rate(http_requests_total{job=~\"$job\", status=~\"4..\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "gRPC non-OK (rps) by code",
      "description": "Rate of handled RPCs with grpc_code != OK (server-side)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job, grpc_code) (rate(grpc_server_handled_total{job=~\"$job\", grpc_code!=\"OK\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "req/s" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right", "calcs": [ "last" ] },
        "tooltip": { "mode": "multi" }
      }
    },
    {
      "type": "timeseries",
      "title": "Timeouts (HTTP 504 + gRPC DEADLINE_EXCEEDED)",
      "description": "Server timeouts across protocols",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job) (\n  rate(http_requests_total{job=~\"$job\", code=\"504\"}[$__rate_interval])\n+ rate(http_requests_total{job=~\"$job\", status=\"504\"}[$__rate_interval])\n+ rate(grpc_server_handled_total{job=~\"$job\", grpc_code=\"DEADLINE_EXCEEDED\"}[$__rate_interval])\n)",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Error Rate (%)",
      "description": "((HTTP 4xx+5xx + gRPC non-OK) / total requests) × 100",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * (\n  (\n    sum by (job) (rate(http_requests_total{job=~\"$job\", code=~\"4..|5..\"}[$__rate_interval]))\n    + sum by (job) (rate(http_requests_total{job=~\"$job\", status=~\"4..|5..\"}[$__rate_interval]))\n    + sum by (job) (rate(grpc_server_handled_total{job=~\"$job\", grpc_code!=\"OK\"}[$__rate_interval]))\n  )\n/ (\n    sum by (job) (rate(http_requests_total{job=~\"$job\"}[$__rate_interval]))\n  + sum by (job) (rate(grpc_server_handled_total{job=~\"$job\"}[$__rate_interval]))\n  + sum by (job) (rate(rpc_server_duration_seconds_count{job=~\"$job\"}[$__rate_interval]))\n))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "Burn Rate (relative to SLO)",
      "description": "((errors/total) / (1 - $slo)) — dimension: job",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
      "targets": [
        {
          "refId": "A",
          "expr": "(\n  (\n    sum by (job) (rate(http_requests_total{job=~\"$job\", code=~\"4..|5..\"}[$__rate_interval]))\n    + sum by (job) (rate(http_requests_total{job=~\"$job\", status=~\"4..|5..\"}[$__rate_interval]))\n    + sum by (job) (rate(grpc_server_handled_total{job=~\"$job\", grpc_code!=\"OK\"}[$__rate_interval]))\n  )\n/ (\n    sum by (job) (rate(http_requests_total{job=~\"$job\"}[$__rate_interval]))\n  + sum by (job) (rate(grpc_server_handled_total{job=~\"$job\"}[$__rate_interval]))\n  + sum by (job) (rate(rpc_server_duration_seconds_count{job=~\"$job\"}[$__rate_interval]))\n)) / (1 - $slo)",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ratio",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green" },
              { "color": "orange", "value": 1 },
              { "color": "red", "value": 2 }
            ]
          }
        },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom" } }
    },
    {
      "type": "table",
      "title": "Top endpoints by HTTP 5xx (rps)",
      "description": "Top 10 paths/handlers producing 5xx",
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 24 },
      "transformations": [],
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (job, handler) (rate(http_requests_total{job=~\"$job\", code=~\"5..\"}[$__rate_interval])))",
          "datasource": { "type": "prometheus", "uid": "${ds}" },
          "format": "table"
        },
        {
          "refId": "B",
          "expr": "topk(10, sum by (job, path) (rate(http_requests_total{job=~\"$job\", status=~\"5..\"}[$__rate_interval])))",
          "datasource": { "type": "prometheus", "uid": "${ds}" },
          "format": "table"
        }
      ],
      "options": {
        "showHeader": true,
        "footer": { "show": false }
      },
      "fieldConfig": {
        "defaults": { "unit": "req/s", "custom": { "align": "auto" } },
        "overrides": []
      }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": [ "rpc", "http", "grpc", "errors", "qps", "slo" ],
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "ds",
        "label": "Prometheus",
        "query": "prometheus",
        "current": {},
        "hide": 0
      },
      {
        "type": "query",
        "name": "job",
        "label": "job",
        "datasource": { "type": "prometheus", "uid": "${ds}" },
        "refresh": 1,
        "query": "label_values({__name__=~\"grpc_server_handled_total|http_requests_total|rpc_server_duration_seconds_count\"}, job)",
        "definition": "label_values({__name__=~\"grpc_server_handled_total|http_requests_total|rpc_server_duration_seconds_count\"}, job)",
        "includeAll": true,
        "multi": true,
        "sort": 1
      },
      {
        "type": "custom",
        "name": "slo",
        "label": "SLO",
        "query": "0.99,0.999",
        "current": { "text": "0.99", "value": "0.99" }
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {
    "refresh_intervals": [ "5s", "10s", "30s", "1m", "2m", "5m" ]
  },
  "timezone": "",
  "title": "RPC — QPS & Errors",
  "uid": "rpc-qps-errors",
  "version": 1,
  "weekStart": ""
}
