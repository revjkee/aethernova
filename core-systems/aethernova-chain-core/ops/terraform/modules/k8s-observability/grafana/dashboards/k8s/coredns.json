{
  "uid": "k8s-coredns",
  "title": "K8s / CoreDNS — QPS, Errors, Latency",
  "tags": ["kubernetes", "dns", "coredns", "observability"],
  "schemaVersion": 39,
  "version": 1,
  "editable": true,
  "refresh": "30s",
  "timezone": "",
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": { "refresh_intervals": ["10s", "30s", "1m", "5m", "10m"] },
  "fiscalYearStartMonth": 0,
  "liveNow": false,
  "panels": [
    {
      "type": "row",
      "title": "Overview",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "collapsed": false,
      "panels": []
    },
    {
      "type": "stat",
      "title": "QPS (total)",
      "description": "Суммарный запрос/с за 5 минутное окно.",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "sum(rate(coredns_dns_requests_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) or on() vector(0)"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "values": false, "fields": "" },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "noValue": "0"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "req/s",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "green" }, { "color": "yellow", "value": 100 }, { "color": "red", "value": 500 }]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Error QPS",
      "description": "Скорость ответов с RCODE != NOERROR.",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "sum(rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\", rcode!=\"NOERROR\"}[$__rate_interval])) or on() vector(0)"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "noValue": "0"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "req/s",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "green" }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 5 }]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Error rate",
      "description": "Доля ошибок в процентах за окно $__rate_interval.",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "100 * ( sum(rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\", rcode!=\"NOERROR\"}[$__rate_interval])) ) / clamp_max(sum(rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])), 1e308)"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "noValue": "0"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "green" }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 5 }]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Cache hit ratio",
      "description": "Доля попаданий кэша CoreDNS (если включён плагин cache).",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "100 * ( sum(rate(coredns_cache_hits_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) ) / clamp_max( sum(rate(coredns_cache_hits_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) + sum(rate(coredns_cache_misses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) , 1e308 )"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "noValue": "N/A"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "red" }, { "color": "yellow", "value": 50 }, { "color": "green", "value": 80 }]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "NXDOMAIN QPS",
      "description": "Скорость ответов NXDOMAIN.",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 5 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "sum(rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\", rcode=\"NXDOMAIN\"}[$__rate_interval])) or on() vector(0)"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none", "justifyMode": "auto", "noValue": "0" },
      "fieldConfig": { "defaults": { "unit": "req/s", "decimals": 2 }, "overrides": [] }
    },
    {
      "type": "stat",
      "title": "SERVFAIL QPS",
      "description": "Скорость ответов SERVFAIL.",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 5 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "expr": "sum(rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\", rcode=\"SERVFAIL\"}[$__rate_interval])) or on() vector(0)"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none", "justifyMode": "auto", "noValue": "0" },
      "fieldConfig": { "defaults": { "unit": "req/s", "decimals": 2 }, "overrides": [] }
    },
    {
      "type": "timeseries",
      "title": "Latency (p50/p95/p99)",
      "description": "Гистограммные квантили по времени ответа DNS.",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 5 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "P50",
          "expr": "histogram_quantile(0.50, sum(rate(coredns_dns_request_duration_seconds_bucket{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) by (le))",
          "legendFormat": "p50"
        },
        {
          "refId": "P95",
          "expr": "histogram_quantile(0.95, sum(rate(coredns_dns_request_duration_seconds_bucket{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) by (le))",
          "legendFormat": "p95"
        },
        {
          "refId": "P99",
          "expr": "histogram_quantile(0.99, sum(rate(coredns_dns_request_duration_seconds_bucket{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) by (le))",
          "legendFormat": "p99"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 3 }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" }, "tooltip": { "mode": "multi" } }
    },
    {
      "type": "timeseries",
      "title": "QPS by RCODE",
      "description": "Запросы/с по коду ответа DNS.",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 9 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (rcode) (rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval]))",
          "legendFormat": "{{rcode}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s", "decimals": 2 }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right" }, "tooltip": { "mode": "multi" } }
    },
    {
      "type": "timeseries",
      "title": "QPS by QTYPE",
      "description": "Запросы/с по типу DNS записи (A, AAAA, SRV, PTR, ...).",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 13 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (type) (rate(coredns_dns_requests_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval]))",
          "legendFormat": "{{type}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s", "decimals": 2 }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right" }, "tooltip": { "mode": "multi" } }
    },
    {
      "type": "row",
      "title": "Per pod",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 21 },
      "collapsed": false,
      "panels": []
    },
    {
      "type": "table",
      "title": "Pods — QPS / Error% / p95 latency",
      "description": "Срез по pod: суммарный QPS, доля ошибок и p95 задержки.",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 22 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
      "targets": [
        {
          "refId": "QPS",
          "instant": true,
          "expr": "sum by (pod) (rate(coredns_dns_requests_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval]))"
        },
        {
          "refId": "ERRS",
          "instant": true,
          "expr": "100 * sum by (pod) (rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\", rcode!=\"NOERROR\"}[$__rate_interval])) / sum by (pod) (rate(coredns_dns_responses_total{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval]))"
        },
        {
          "refId": "P95",
          "instant": true,
          "expr": "label_replace( histogram_quantile(0.95, sum by (pod, le) (rate(coredns_dns_request_duration_seconds_bucket{namespace=~\"$namespace\", job=~\"$job\", pod=~\"$pod\"}[$__rate_interval])) ), \"pod\", \"$1\", \"pod\", \"(.*)\")"
        }
      ],
      "options": { "showHeader": true },
      "transformations": [
        { "id": "seriesToColumns", "options": { "byField": "pod" } },
        { "id": "organize", "options": {
            "renameByName": { "Value #QPS": "qps", "Value #ERRS": "error_percent", "Value #P95": "latency_p95_s" },
            "indexByName": {}
        } }
      ],
      "fieldConfig": {
        "defaults": { "custom": { "align": "center" } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "qps" }, "properties": [ { "id": "unit", "value": "req/s" }, { "id": "decimals", "value": 2 } ] },
          { "matcher": { "id": "byName", "options": "error_percent" }, "properties": [
            { "id": "unit", "value": "percent" },
            { "id": "thresholds", "value": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 5 } ] } }
          ] },
          { "matcher": { "id": "byName", "options": "latency_p95_s" }, "properties": [ { "id": "unit", "value": "s" }, { "id": "decimals", "value": 3 } ] }
        ]
      }
    }
  ],
  "templating": {
    "list": [
      {
        "name": "DS_PROMETHEUS_UID",
        "type": "datasource",
        "query": "prometheus",
        "current": { "selected": true },
        "label": "Datasource",
        "options": []
      },
      {
        "name": "namespace",
        "type": "query",
        "label": "namespace",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
        "includeAll": true,
        "multi": true,
        "refresh": 1,
        "query": "label_values(coredns_dns_requests_total, namespace)",
        "current": { "selected": true, "value": [".*"], "text": "All" }
      },
      {
        "name": "job",
        "type": "query",
        "label": "job",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
        "includeAll": true,
        "multi": true,
        "refresh": 1,
        "query": "label_values(coredns_dns_requests_total{namespace=~\"$namespace\"}, job)",
        "current": { "selected": true, "value": [".*"], "text": "All" }
      },
      {
        "name": "pod",
        "type": "query",
        "label": "pod",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS_UID}" },
        "includeAll": true,
        "multi": true,
        "refresh": 1,
        "query": "label_values(coredns_dns_requests_total{namespace=~\"$namespace\", job=~\"$job\"}, pod)",
        "current": { "selected": true, "value": [".*"], "text": "All" }
      }
    ]
  },
  "annotations": {
    "list": [
      { "type": "dashboard", "name": "Annotations & Alerts", "hide": true, "builtIn": 1, "iconColor": "rgba(255, 255, 255, 0.6)" }
    ]
  }
}
