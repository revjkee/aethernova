{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "iteration": 1725960000000,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "table",
      "title": "Top K Slow Traces",
      "id": 1,
      "datasource": {
        "type": "tempo",
        "uid": "${ds_tempo}"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": {
            "type": "tempo",
            "uid": "${ds_tempo}"
          },
          "queryType": "traceql",
          "query": "{ resource.service.name =~ \"$service\" && name =~ \"$operation\" && duration >= ${min_duration} }",
          "limit": "${limit}",
          "spanLimit": 3,
          "tableFormat": "traces"
        }
      ],
      "options": {
        "showHeader": true,
        "footer": {
          "enablePagination": true,
          "countRows": true,
          "fields": "",
          "reducer": ["count"]
        },
        "sortBy": [
          {
            "displayName": "Duration",
            "desc": true
          }
        ],
        "cellHeight": "sm",
        "enablePagination": true,
        "pageSize": 20,
        "dataLinks": [
          {
            "title": "Open trace in dashboard",
            "url": "/d/${__dashboard.uid}?var-traceId=${__data.fields.traceID}",
            "targetBlank": false
          }
        ]
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "inspect": false
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Start time" },
            "properties": [ { "id": "custom.width", "value": 180 } ]
          },
          {
            "matcher": { "id": "byName", "options": "Duration" },
            "properties": [
              { "id": "custom.width", "value": 120 },
              { "id": "unit", "value": "ms" }
            ]
          }
        ]
      },
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 0 },
      "transformations": []
    },
    {
      "type": "table",
      "title": "Top Operations by Duration (avg, max, p95)",
      "id": 2,
      "datasource": {
        "type": "tempo",
        "uid": "${ds_tempo}"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": {
            "type": "tempo",
            "uid": "${ds_tempo}"
          },
          "queryType": "traceql",
          "query": "{ resource.service.name =~ \"$service\" && name =~ \"$operation\" && duration >= ${min_duration} }",
          "limit": "1000",
          "spanLimit": 3,
          "tableFormat": "spans"
        }
      ],
      "transformations": [
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "Service": { "operation": "groupby" },
              "Name": { "operation": "groupby" },
              "Duration": {
                "operation": "aggregate",
                "aggregations": ["mean", "max", "p95", "count"]
              }
            }
          }
        },
        {
          "id": "sortBy",
          "options": {
            "fields": {},
            "sort": [
              { "field": "Duration (p95)", "desc": true },
              { "field": "Duration (max)", "desc": true }
            ]
          }
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [
          { "displayName": "Duration (p95)", "desc": true }
        ],
        "footer": { "enablePagination": true, "countRows": true },
        "cellHeight": "sm",
        "pageSize": 20
      },
      "fieldConfig": {
        "defaults": {
          "custom": { "align": "auto", "displayMode": "auto" }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Duration (mean)" },
            "properties": [
              { "id": "unit", "value": "ms" },
              { "id": "decimals", "value": 2 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Duration (max)" },
            "properties": [
              { "id": "unit", "value": "ms" },
              { "id": "decimals", "value": 2 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Duration (p95)" },
            "properties": [
              { "id": "unit", "value": "ms" },
              { "id": "decimals", "value": 2 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Duration (count)" },
            "properties": [
              { "id": "unit", "value": "short" },
              { "id": "decimals", "value": 0 }
            ]
          }
        ]
      },
      "gridPos": { "h": 11, "w": 24, "x": 0, "y": 12 },
      "optionsOld": {}
    },
    {
      "type": "traces",
      "title": "Trace Details",
      "id": 3,
      "datasource": {
        "type": "tempo",
        "uid": "${ds_tempo}"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": {
            "type": "tempo",
            "uid": "${ds_tempo}"
          },
          "queryType": "traceql",
          "query": "${traceId}"
        }
      ],
      "options": {
        "spanBar": { "type": "ServiceGraph" },
        "spanFilters": {
          "serviceName": "$service",
          "spanName": "$operation",
          "minDuration": "$min_duration"
        }
      },
      "gridPos": { "h": 15, "w": 24, "x": 0, "y": 23 }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["tempo", "traceql", "topk", "observability"],
  "templating": {
    "list": [
      {
        "name": "ds_tempo",
        "type": "datasource",
        "label": "Tempo datasource",
        "query": "tempo",
        "current": { "selected": true, "text": "", "value": "" }
      },
      {
        "name": "service",
        "type": "custom",
        "label": "Service (regex)",
        "query": ".*",
        "current": { "selected": true, "text": ".*", "value": ".*" }
      },
      {
        "name": "operation",
        "type": "custom",
        "label": "Operation (regex)",
        "query": ".*",
        "current": { "selected": true, "text": ".*", "value": ".*" }
      },
      {
        "name": "min_duration",
        "type": "custom",
        "label": "Min duration",
        "query": "10ms,50ms,100ms,250ms,500ms,1s,2s,5s",
        "current": { "selected": true, "text": "100ms", "value": "100ms" }
      },
      {
        "name": "limit",
        "type": "custom",
        "label": "Limit (traces)",
        "query": "10,20,50,100,200",
        "current": { "selected": true, "text": "50", "value": "50" }
      },
      {
        "name": "traceId",
        "type": "textbox",
        "label": "Trace ID",
        "query": "",
        "current": { "selected": true, "text": "", "value": "" }
      }
    ]
  },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "2m", "5m", "10m"]
  },
  "timezone": "",
  "title": "Tracing: TopK Traces & Operations (Tempo/TraceQL)",
  "uid": "tracing-topk",
  "version": 1,
  "weekStart": ""
}
