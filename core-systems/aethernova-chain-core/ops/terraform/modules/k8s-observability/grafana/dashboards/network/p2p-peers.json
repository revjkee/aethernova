{
  "uid": "p2p-peers",
  "title": "P2P Peers â€” Count & Geography",
  "schemaVersion": 39,
  "version": 1,
  "editable": true,
  "timezone": "",
  "time": { "from": "now-6h", "to": "now" },
  "refresh": "10s",
  "tags": ["p2p", "network", "prometheus", "observability"],
  "panels": [
    {
      "type": "stat",
      "title": "Total peers",
      "id": 1,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "sum($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector})",
          "legendFormat": "peers",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "orange", "value": 100 }, { "color": "red", "value": 500 } ] }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 0 }
    },
    {
      "type": "timeseries",
      "title": "Peers over time",
      "id": 2,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "sum by ($label_direction) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector})",
          "legendFormat": "{{${label_direction}}}",
          "refId": "A"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "gridPos": { "h": 9, "w": 18, "x": 6, "y": 0 }
    },
    {
      "type": "table",
      "title": "Peers by country",
      "id": 3,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "sum by ($label_country) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector})",
          "legendFormat": "{{${label_country}}}",
          "refId": "A",
          "format": "table",
          "instant": true
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [{ "displayName": "Value", "desc": true }]
      },
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 5 }
    },
    {
      "type": "piechart",
      "title": "Peers by ASN",
      "id": 4,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "topk(15, sum by ($label_asn) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector}))",
          "legendFormat": "{{${label_asn}}}",
          "refId": "A"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "right" } },
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 5 }
    },
    {
      "type": "barchart",
      "title": "Peers by client",
      "id": 5,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "topk(15, sum by ($label_client) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector}))",
          "legendFormat": "{{${label_client}}}",
          "refId": "A"
        }
      ],
      "options": { "orientation": "horizontal", "legend": { "displayMode": "hidden" } },
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 5 }
    },
    {
      "type": "geomap",
      "title": "Peers map (lat/lon)",
      "id": 6,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "sum by ($label_latitude, $label_longitude) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector})",
          "legendFormat": "lat={{${label_latitude}}}, lon={{${label_longitude}}}",
          "refId": "A"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "options": {
        "basemap": { "type": "default" },
        "view": { "id": "world" },
        "layers": [
          {
            "type": "heatmap",
            "opacity": 0.6,
            "config": { "location": { "mode": "coords", "latField": "${label_latitude}", "lonField": "${label_longitude}" } }
          }
        ]
      },
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 13 }
    },
    {
      "type": "table",
      "title": "Top countries",
      "id": 7,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "topk(20, sum by ($label_country) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector}))",
          "legendFormat": "{{${label_country}}}",
          "refId": "A",
          "format": "table",
          "instant": true
        }
      ],
      "options": { "showHeader": true, "sortBy": [{ "displayName": "Value", "desc": true }] },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 25 }
    },
    {
      "type": "table",
      "title": "Top ASNs",
      "id": 8,
      "datasource": { "type": "prometheus", "uid": "$datasource" },
      "targets": [
        {
          "expr": "topk(20, sum by ($label_asn) ($peer_metric{job=~\"$job\",instance=~\"$instance\"$extra_selector}))",
          "legendFormat": "{{${label_asn}}}",
          "refId": "A",
          "format": "table",
          "instant": true
        }
      ],
      "options": { "showHeader": true, "sortBy": [{ "displayName": "Value", "desc": true }] },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 25 }
    }
  ],
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "datasource",
        "label": "Datasource",
        "query": "prometheus",
        "current": { "selected": true, "text": "Prometheus", "value": "Prometheus" }
      },
      {
        "type": "textbox",
        "name": "peer_metric",
        "label": "Metric name (per-peer gauge = 1)",
        "query": "p2p_peers",
        "current": { "text": "p2p_peers", "value": "p2p_peers" }
      },
      {
        "type": "query",
        "name": "job",
        "label": "job",
        "datasource": { "type": "prometheus", "uid": "$datasource" },
        "query": "label_values($peer_metric, job)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": ".*", "value": ".*" }
      },
      {
        "type": "query",
        "name": "instance",
        "label": "instance",
        "datasource": { "type": "prometheus", "uid": "$datasource" },
        "query": "label_values($peer_metric{job=~\"$job\"}, instance)",
        "refresh": 2,
        "multi": true,
        "includeAll": true,
        "current": { "selected": true, "text": ".*", "value": ".*" }
      },
      {
        "type": "textbox",
        "name": "label_country",
        "label": "country label",
        "query": "country",
        "current": { "text": "country", "value": "country" }
      },
      {
        "type": "textbox",
        "name": "label_asn",
        "label": "asn label",
        "query": "asn",
        "current": { "text": "asn", "value": "asn" }
      },
      {
        "type": "textbox",
        "name": "label_client",
        "label": "client label",
        "query": "client",
        "current": { "text": "client", "value": "client" }
      },
      {
        "type": "textbox",
        "name": "label_direction",
        "label": "direction label",
        "query": "direction",
        "current": { "text": "direction", "value": "direction" }
      },
      {
        "type": "textbox",
        "name": "label_latitude",
        "label": "latitude label",
        "query": "latitude",
        "current": { "text": "latitude", "value": "latitude" }
      },
      {
        "type": "textbox",
        "name": "label_longitude",
        "label": "longitude label",
        "query": "longitude",
        "current": { "text": "longitude", "value": "longitude" }
      },
      {
        "type": "textbox",
        "name": "extra_selector",
        "label": "extra label selectors (prefix with comma), e.g. ,network=\"mainnet\"",
        "query": "",
        "current": { "text": "", "value": "" }
      }
    ]
  },
  "links": [],
  "annotations": { "list": [{ "builtIn": 1, "name": "Annotations & Alerts", "type": "dashboard", "enable": true }] }
}
