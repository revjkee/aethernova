{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": false,
        "iconColor": "rgba(255, 96, 96, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "gnetId": null,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "stat",
      "title": "Total Queue Depth",
      "id": 1,
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "orange", "value": 100 }, { "color": "red", "value": 1000 } ] }
        },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "orientation": "horizontal", "colorMode": "value", "graphMode": "none", "justifyMode": "auto", "textMode": "auto" },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum(zk_queue_depth{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}) or sum(zk_jobs_queued{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}) or vector(0))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Active Workers",
      "id": 2,
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "none", "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "red", "value": 1 } ] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none", "justifyMode": "auto" },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum(zk_task_inflight{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}) or sum(zk_workers_active{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}) or vector(0))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Throughput (proofs/sec)",
      "id": 3,
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area", "justifyMode": "auto" },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum(rate(zk_proof_generated_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}[5m])) or vector(0))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Error Rate (events/sec)",
      "id": 4,
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "orange", "value": 0.01 }, { "color": "red", "value": 0.1 } ] } }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value" },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum(rate(zk_job_errors_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m])) or vector(0))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Job Duration Quantiles (s)",
      "id": 5,
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "right" }, "tooltip": { "mode": "multi" } },
      "targets": [
        {
          "refId": "P50",
          "expr": "histogram_quantile(0.5, sum by (le) (rate(zk_prover_job_duration_seconds_bucket{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m])))"
        },
        {
          "refId": "P90",
          "expr": "histogram_quantile(0.9, sum by (le) (rate(zk_prover_job_duration_seconds_bucket{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m])))"
        },
        {
          "refId": "P99",
          "expr": "histogram_quantile(0.99, sum by (le) (rate(zk_prover_job_duration_seconds_bucket{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m])))"
        }
      ]
    },
    {
      "type": "heatmap",
      "title": "Job Duration Histogram",
      "id": 6,
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": {}, "overrides": [] },
      "options": { "tooltip": { "mode": "single" }, "legend": { "show": true } },
      "targets": [
        {
          "refId": "A",
          "format": "heatmap",
          "expr": "sum by (le) (rate(zk_prover_job_duration_seconds_bucket{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m]))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Queue Depth by Queue",
      "id": 7,
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "none" }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "right" }, "tooltip": { "mode": "multi" } },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum by (queue) (zk_queue_depth{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}) or sum by (queue) (zk_jobs_queued{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}) or vector(0))"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Inflight Tasks per Pod",
      "id": 8,
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "none" }, "overrides": [] },
      "options": { "legend": { "displayMode": "list", "placement": "right" } },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum by (pod) (zk_task_inflight{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",pod=~\"${pod:regex}\"}) or vector(0))"
        }
      ]
    },
    {
      "type": "bargauge",
      "title": "Top Pods by P95 Job Duration",
      "id": 9,
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 19 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "options": { "displayMode": "lcd", "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal" },
      "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, histogram_quantile(0.95, sum by (le, pod) (rate(zk_prover_job_duration_seconds_bucket{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}[5m]))))"
        }
      ]
    },
    {
      "type": "stat",
      "title": "ETA to Drain (QueueDepth / Throughput) [min]",
      "id": 10,
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 19 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "m" }, "overrides": [] },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "targets": [
        {
          "refId": "A",
          "expr": "((sum(zk_queue_depth{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}) or vector(0)) / clamp_min(sum(rate(zk_proof_generated_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}[5m])) , 0.001)) / 60"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "CPU Usage by Pod (cores)",
      "id": 11,
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 26 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "cores" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",pod=~\"${pod:regex}\",image!=\"\",container!=\"POD\"}[5m]))"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "right" } }
    },
    {
      "type": "timeseries",
      "title": "Memory Working Set by Pod",
      "id": 12,
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 26 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "bytes" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (pod) (container_memory_working_set_bytes{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",pod=~\"${pod:regex}\",image!=\"\",container!=\"POD\"})"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "right" } }
    },
    {
      "type": "timeseries",
      "title": "GPU Utilization by Pod (%)",
      "id": 13,
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 33 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "percent" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "avg by (pod) (nvidia_gpu_duty_cycle{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",pod=~\"${pod:regex}\"}) or avg by (pod) (DCGM_FI_DEV_GPU_UTIL{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",pod=~\"${pod:regex}\"})"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "right" } }
    },
    {
      "type": "table",
      "title": "Errors by Code (last 1h)",
      "id": 14,
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 33 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": {}, "overrides": [] },
      "transformations": [
        { "id": "organize", "options": { "excludeByName": { "Time": true } } }
      ],
      "targets": [
        {
          "refId": "A",
          "expr": "(sum by (error) (increase(zk_job_errors_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}[1h])) or vector(0))"
        }
      ],
      "options": {
        "showHeader": true,
        "footer": { "enablePagination": true, "fields": "", "reducer": ["sum"] }
      }
    },
    {
      "type": "timeseries",
      "title": "Per-Queue Throughput (proofs/sec)",
      "id": 15,
      "gridPos": { "h": 7, "w": 24, "x": 0, "y": 40 },
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "fieldConfig": { "defaults": { "unit": "ops" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (queue) (rate(zk_proof_generated_total{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\",queue=~\"${queue:regex}\"}[5m]))"
        }
      ],
      "options": { "legend": { "displayMode": "list", "placement": "right" }, "tooltip": { "mode": "multi" } }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["zk", "prover", "observability", "queues", "latency"],
  "templating": {
    "list": [
      {
        "name": "DS_PROMETHEUS",
        "type": "datasource",
        "query": "prometheus",
        "hide": 0,
        "label": "Prometheus",
        "current": null
      },
      {
        "name": "cluster",
        "label": "Cluster",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(kube_pod_info, cluster)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "sort": 1
      },
      {
        "name": "namespace",
        "label": "Namespace",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(kube_pod_info{cluster=~\"${cluster:regex}\"}, namespace)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "sort": 1
      },
      {
        "name": "queue",
        "label": "Queue",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(zk_queue_depth{cluster=~\"${cluster:regex}\",namespace=~\"${namespace:regex}\"}, queue)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "sort": 1
      },
      {
        "name": "pod",
        "label": "Pod",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
        "query": "label_values(kube_pod_info{cluster=~\"${cluster:regex}\", namespace=~\"${namespace:regex}\"}, pod)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "sort": 1
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {
    "refresh_intervals": ["10s", "30s", "1m", "5m", "15m", "30m", "1h"],
    "time_options": ["1h", "6h", "12h", "24h", "2d", "7d", "14d", "30d"]
  },
  "timezone": "",
  "title": "ZK Overview",
  "uid": "zk-overview",
  "version": 1,
  "weekStart": ""
}
