{
  "id": null,
  "uid": "slo-apdex-critical-routes",
  "title": "SLO — Apdex (Critical Routes)",
  "tags": ["slo", "apdex", "kubernetes", "prometheus", "production"],
  "schemaVersion": 39,
  "version": 1,
  "timezone": "browser",
  "refresh": "30s",
  "editable": true,
  "time": { "from": "now-6h", "to": "now" },

  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "label": "Prometheus",
        "refresh": 1
      },
      {
        "name": "job",
        "type": "query",
        "label": "job",
        "datasource": "${datasource}",
        "query": "label_values(http_server_requests_seconds_bucket, job)",
        "refresh": 2
      },
      {
        "name": "service",
        "type": "query",
        "label": "service",
        "datasource": "${datasource}",
        "includeAll": true,
        "multi": true,
        "query": "label_values(http_server_requests_seconds_bucket{job=\"$job\"}, service)",
        "refresh": 2
      },
      {
        "name": "namespace",
        "type": "query",
        "label": "namespace",
        "datasource": "${datasource}",
        "includeAll": true,
        "multi": true,
        "query": "label_values(http_server_requests_seconds_bucket{job=\"$job\"}, namespace)",
        "refresh": 2
      },
      {
        "name": "method",
        "type": "query",
        "label": "method",
        "datasource": "${datasource}",
        "includeAll": true,
        "multi": true,
        "query": "label_values(http_server_requests_seconds_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\"}, method)",
        "refresh": 2
      },
      {
        "name": "uri",
        "type": "query",
        "label": "uri (route pattern)",
        "datasource": "${datasource}",
        "includeAll": true,
        "multi": true,
        "query": "label_values(http_server_requests_seconds_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\"}, uri)",
        "refresh": 2
      },
      {
        "name": "critical_routes",
        "type": "custom",
        "label": "critical routes (regexp)",
        "query": "/api/v1/orders.*|/api/v1/payments.*|/auth/.*",
        "current": { "text": "/api/v1/orders.*|/api/v1/payments.*|/auth/.*", "value": "/api/v1/orders.*|/api/v1/payments.*|/auth/.*" }
      },
      {
        "name": "success_status_re",
        "type": "custom",
        "label": "success status regex",
        "query": "2..|3..",
        "current": { "text": "2..|3..", "value": "2..|3.." }
      },
      {
        "name": "apdex_T",
        "type": "custom",
        "label": "Apdex T (seconds; must match histogram buckets)",
        "query": "0.25,0.5,0.75,1,1.5,2",
        "current": { "text": "0.5", "value": "0.5" }
      },
      {
        "name": "apdex_4T",
        "type": "custom",
        "label": "Apdex 4T (seconds; 4x T)",
        "query": "1,2,3,4,6,8",
        "current": { "text": "2", "value": "2" }
      },
      {
        "name": "hist_base",
        "type": "custom",
        "label": "histogram metric base",
        "query": "http_server_requests_seconds,http_request_duration_seconds",
        "current": { "text": "http_server_requests_seconds", "value": "http_server_requests_seconds" }
      }
    ]
  },

  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Global Apdex (critical routes)",
      "datasource": "${datasource}",
      "fieldConfig": {
        "defaults": { "unit": "percentunit", "thresholds": { "mode": "absolute", "steps": [ { "color": "red", "value": null }, { "color": "orange", "value": 0.85 }, { "color": "green", "value": 0.95 } ] } },
        "overrides": []
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal", "colorMode": "value", "graphMode": "none", "justifyMode": "auto" },
      "targets": [
        {
          "refId": "S",
          "expr": "sum(rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_T\"}[$__rate_interval]))"
        },
        {
          "refId": "U4",
          "expr": "sum(rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_4T\"}[$__rate_interval]))"
        },
        {
          "refId": "C",
          "expr": "sum(rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\"}[$__rate_interval]))"
        }
      ],
      "transformations": [
        { "id": "merge", "options": {} },
        {
          "id": "organize",
          "options": { "renameByName": { "S": "satisfied", "U4": "under_4T_cum", "C": "total" } }
        },
        {
          "id": "calculateField",
          "options": { "mode": "reduceRow", "reduce": { "reducer": "lastNotNull" } }
        }
      ],
      "pluginVersion": "10.0.0",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "links": [],
      "optionsOverrides": {},
      "targetsOverrides": [],
      "optionsEditor": {},
      "transformations2": []
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Apdex over time by URI",
      "datasource": "${datasource}",
      "fieldConfig": { "defaults": { "unit": "percentunit" }, "overrides": [] },
      "options": { "legend": { "showLegend": true }, "tooltip": { "mode": "multi" } },
      "targets": [
        {
          "refId": "S",
          "expr": "sum by (uri) (rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_T\"}[$__rate_interval]))"
        },
        {
          "refId": "U4",
          "expr": "sum by (uri) (rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_4T\"}[$__rate_interval]))"
        },
        {
          "refId": "C",
          "expr": "sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\"}[$__rate_interval]))"
        }
      ],
      "transformations": [
        { "id": "merge", "options": {} },
        {
          "id": "organize",
          "options": { "renameByName": { "S": "satisfied", "U4": "under_4T_cum", "C": "total" } }
        },
        {
          "id": "calculateField",
          "options": {
            "mode": "binary",
            "binary": {
              "left": "under_4T_cum",
              "operator": "-",
              "right": "satisfied",
              "replaceFields": true,
              "alias": "tolerated"
            }
          }
        },
        {
          "id": "calculateField",
          "options": {
            "mode": "expression",
            "expression": "(satisfied + tolerated / 2) / total",
            "alias": "apdex"
          }
        },
        { "id": "filterFieldsByName", "options": { "include": ["apdex", "uri"] } }
      ],
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 4 }
    },
    {
      "id": 3,
      "type": "table",
      "title": "Apdex table (last, RPS, errors%) — by URI",
      "datasource": "${datasource}",
      "options": { "showHeader": true },
      "targets": [
        {
          "refId": "S",
          "expr": "sum by (uri) (rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_T\"}[$__rate_interval]))"
        },
        {
          "refId": "U4",
          "expr": "sum by (uri) (rate(${hist_base}_bucket{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"$success_status_re\",le=\"$apdex_4T\"}[$__rate_interval]))"
        },
        {
          "refId": "C",
          "expr": "sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\"}[$__rate_interval]))"
        },
        {
          "refId": "RPS",
          "expr": "sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\"}[$__rate_interval]))"
        },
        {
          "refId": "ERR",
          "expr": "100 * sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"5..\"}[$__rate_interval])) / sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\"}[$__rate_interval]))"
        }
      ],
      "transformations": [
        { "id": "merge", "options": {} },
        { "id": "organize", "options": { "renameByName": { "S": "satisfied", "U4": "under_4T_cum", "C": "total", "RPS": "rps", "ERR": "error_pct" } } },
        { "id": "calculateField", "options": { "mode": "binary", "binary": { "left": "under_4T_cum", "operator": "-", "right": "satisfied", "replaceFields": true, "alias": "tolerated" } } },
        { "id": "calculateField", "options": { "mode": "expression", "expression": "(satisfied + tolerated / 2) / total", "alias": "apdex" } },
        { "id": "filterFieldsByName", "options": { "include": ["uri", "apdex", "rps", "error_pct"] } }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "apdex" }, "properties": [ { "id": "unit", "value": "percentunit" } ] },
          { "matcher": { "id": "byName", "options": "error_pct" }, "properties": [ { "id": "unit", "value": "percent" } ] }
        ]
      },
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 12 }
    },
    {
      "id": 4,
      "type": "timeseries",
      "title": "Error rate (5xx) over time — critical routes",
      "datasource": "${datasource}",
      "fieldConfig": { "defaults": { "unit": "req/s" } },
      "options": { "legend": { "showLegend": true } },
      "targets": [
        {
          "refId": "E",
          "expr": "sum by (uri) (rate(${hist_base}_count{job=\"$job\",service=~\"$service\",namespace=~\"$namespace\",uri=~\"$critical_routes\",status=~\"5..\"}[$__rate_interval]))"
        }
      ],
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 22 }
    }
  ]
}
