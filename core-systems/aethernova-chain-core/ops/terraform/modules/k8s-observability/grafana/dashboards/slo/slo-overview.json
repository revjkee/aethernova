{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "gnetId": null,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "stat",
      "title": "SLO target (%)",
      "id": 1,
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "targets": [
        { "refId": "A", "expr": "vector($objective)", "exemplar": true, "editorMode": "code" }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "horizontal",
        "textMode": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 3,
          "min": 0,
          "max": 100,
          "thresholds": { "mode": "percentage", "steps": [ { "color": "red" }, { "color": "green", "value": 99 } ] }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "SLI now (%)",
      "id": 2,
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "description": "Текущее значение SLI за окно $window: 100 * numerator / denominator.",
      "targets": [
        {
          "refId": "A",
          "expr": "100 * ( $num_q ) / ( $den_q )",
          "legendFormat": "SLI",
          "exemplar": true,
          "editorMode": "code"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "orientation": "horizontal",
        "textMode": "auto",
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 3,
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [ { "color": "red", "value": null }, { "color": "yellow", "value": "$objective" }, { "color": "green", "value": 100 } ]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Error budget remaining (%)",
      "id": 3,
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "description": "Остаток бюджета ошибок за период $period.",
      "targets": [
        {
          "refId": "A",
          "expr": "100 * (1 - ((increase(($den_raw)[$period]) - increase(($num_raw)[$period])) / increase(($den_raw)[$period])) / (1 - ($objective / 100)))",
          "legendFormat": "budget_left",
          "exemplar": true
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "percentage",
            "steps": [ { "color": "red", "value": null }, { "color": "yellow", "value": 25 }, { "color": "green", "value": 50 } ]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Burn rate (now)",
      "id": 4,
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "description": "Текущая скорость выгорания бюджета: error_rate / error_budget.",
      "targets": [
        {
          "refId": "A",
          "expr": "(1 - ( ($num_q) / ($den_q) )) / (1 - ($objective/100))",
          "legendFormat": "burn_now",
          "exemplar": true
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "fieldConfig": {
        "defaults": {
          "unit": "none",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [ { "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 2 } ]
          }
        },
        "overrides": []
      }
    },
    {
      "type": "timeseries",
      "title": "SLI over time (%)",
      "id": 5,
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "description": "Доля успешных событий во времени.",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": { "mode": "absolute", "steps": [ { "color": "red" }, { "color": "green", "value": 99 } ] }
        },
        "overrides": []
      },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull", "min", "mean", "max"] }, "tooltip": { "mode": "single", "sort": "none" } },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * ( $num_q_timeseries ) / ( $den_q_timeseries )",
          "legendFormat": "SLI",
          "exemplar": true
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Burn rate (short/long)",
      "id": 6,
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 13 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "description": "Скорость выгорания бюджета за $w_short и $w_long.",
      "fieldConfig": { "defaults": { "unit": "none", "decimals": 2 }, "overrides": [] },
      "options": { "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["lastNotNull", "max", "mean"] }, "tooltip": { "mode": "single", "sort": "none" } },
      "targets": [
        {
          "refId": "A",
          "expr": "((increase(($den_raw)[$w_short]) - increase(($num_raw)[$w_short])) / increase(($den_raw)[$w_short])) / (1 - ($objective/100))",
          "legendFormat": "burn_$w_short",
          "exemplar": true
        },
        {
          "refId": "B",
          "expr": "((increase(($den_raw)[$w_long]) - increase(($num_raw)[$w_long])) / increase(($den_raw)[$w_long])) / (1 - ($objective/100))",
          "legendFormat": "burn_$w_long",
          "exemplar": true
        }
      ]
    },
    {
      "type": "table",
      "title": "Worst SLI by $by (over $window)",
      "id": 7,
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 22 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "transformations": [
        { "id": "organize", "options": { "excludeByName": {}, "indexByName": {}, "renameByName": { "Value": "sli_percent" } } }
      ],
      "options": { "showHeader": true, "sortBy": [ { "displayName": "sli_percent", "desc": false } ] },
      "fieldConfig": { "defaults": { "decimals": 2, "unit": "percent" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "topk($topn, (100 * ( sum by ($by) ( $num_rate_group ) ) / ( sum by ($by) ( $den_rate_group ) )))",
          "legendFormat": "{{$by}}",
          "exemplar": true
        }
      ]
    },
    {
      "type": "stat",
      "title": "Traffic (req/s)",
      "id": 8,
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "targets": [
        { "refId": "A", "expr": "$den_q", "legendFormat": "rps", "exemplar": true }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "fieldConfig": { "defaults": { "unit": "reqps", "decimals": 2 }, "overrides": [] }
    },
    {
      "type": "stat",
      "title": "Error rate now (%)",
      "id": 9,
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "targets": [
        { "refId": "A", "expr": "100 * (1 - ( ($num_q) / ($den_q) ))", "legendFormat": "err%", "exemplar": true }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "min": 0,
          "max": 100,
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 5 } ] }
        },
        "overrides": []
      }
    },
    {
      "type": "stat",
      "title": "Budget spent over $period (%)",
      "id": 10,
      "gridPos": { "h": 6, "w": 8, "x": 16, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "$DS_PROM" },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * (((increase(($den_raw)[$period]) - increase(($num_raw)[$period])) / increase(($den_raw)[$period])) / (1 - ($objective/100)))",
          "legendFormat": "budget_spent%",
          "exemplar": true
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false } },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "min": 0,
          "max": 100,
          "thresholds": { "mode": "percentage", "steps": [ { "color": "green" }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 100 } ] }
        },
        "overrides": []
      }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["observability", "sre", "sli", "slo", "error-budget"],
  "templating": {
    "list": [
      {
        "name": "DS_PROM",
        "type": "datasource",
        "label": "Prometheus",
        "query": "prometheus",
        "hide": 0
      },
      {
        "name": "objective",
        "type": "textbox",
        "label": "SLO target (%)",
        "query": "99.9",
        "current": { "text": "99.9", "value": "99.9" }
      },
      {
        "name": "window",
        "type": "custom",
        "label": "SLI window",
        "query": "5m,15m,30m,1h,6h,12h,24h",
        "current": { "selected": true, "text": "30m", "value": "30m" }
      },
      {
        "name": "w_short",
        "type": "custom",
        "label": "Burn (short)",
        "query": "5m,15m,30m,1h",
        "current": { "selected": true, "text": "1h", "value": "1h" }
      },
      {
        "name": "w_long",
        "type": "custom",
        "label": "Burn (long)",
        "query": "6h,12h,24h,3d,7d",
        "current": { "selected": true, "text": "6h", "value": "6h" }
      },
      {
        "name": "period",
        "type": "custom",
        "label": "Budget period",
        "query": "7d,14d,30d,90d",
        "current": { "selected": true, "text": "30d", "value": "30d" }
      },
      {
        "name": "topn",
        "type": "custom",
        "label": "Top N (worst SLI)",
        "query": "5,10,15,20",
        "current": { "selected": true, "text": "10", "value": "10" }
      },
      {
        "name": "by",
        "type": "custom",
        "label": "Group by label",
        "query": "service,job,namespace,instance,route",
        "current": { "selected": true, "text": "service", "value": "service" }
      },
      {
        "name": "num_q",
        "type": "textbox",
        "label": "Numerator (rate/agg)",
        "description": "PromQL: скорость успешных событий за $window. Пример: sum(rate(http_requests_total{code!~\"5..\"}[$window]))",
        "query": "sum(rate(http_requests_total{code!~\"5..\"}[$window]))",
        "current": { "text": "sum(rate(http_requests_total{code!~\"5..\"}[$window]))", "value": "sum(rate(http_requests_total{code!~\"5..\"}[$window]))" }
      },
      {
        "name": "den_q",
        "type": "textbox",
        "label": "Denominator (rate/agg)",
        "description": "PromQL: скорость всех событий за $window. Пример: sum(rate(http_requests_total[$window]))",
        "query": "sum(rate(http_requests_total[$window]))",
        "current": { "text": "sum(rate(http_requests_total[$window]))", "value": "sum(rate(http_requests_total[$window]))" }
      },
      {
        "name": "num_q_timeseries",
        "type": "textbox",
        "label": "Numerator (ts)",
        "description": "PromQL: временной ряд успешных событий (использует $__rate_interval).",
        "query": "sum(rate(http_requests_total{code!~\"5..\"}[$__rate_interval]))",
        "current": { "text": "sum(rate(http_requests_total{code!~\"5..\"}[$__rate_interval]))", "value": "sum(rate(http_requests_total{code!~\"5..\"}[$__rate_interval]))" }
      },
      {
        "name": "den_q_timeseries",
        "type": "textbox",
        "label": "Denominator (ts)",
        "description": "PromQL: временной ряд всех событий (использует $__rate_interval).",
        "query": "sum(rate(http_requests_total[$__rate_interval]))",
        "current": { "text": "sum(rate(http_requests_total[$__rate_interval]))", "value": "sum(rate(http_requests_total[$__rate_interval]))" }
      },
      {
        "name": "num_rate_group",
        "type": "textbox",
        "label": "Numerator (grouped)",
        "description": "PromQL: скорость успешных по группе $by.",
        "query": "rate(http_requests_total{code!~\"5..\"}[$window])",
        "current": { "text": "rate(http_requests_total{code!~\"5..\"}[$window])", "value": "rate(http_requests_total{code!~\"5..\"}[$window])" }
      },
      {
        "name": "den_rate_group",
        "type": "textbox",
        "label": "Denominator (grouped)",
        "description": "PromQL: скорость всех по группе $by.",
        "query": "rate(http_requests_total[$window])",
        "current": { "text": "rate(http_requests_total[$window])", "value": "rate(http_requests_total[$window])" }
      },
      {
        "name": "num_raw",
        "type": "textbox",
        "label": "Numerator (raw counter)",
        "description": "PromQL: сырое счётчик-событие для increase() (без rate/agg).",
        "query": "http_requests_total{code!~\"5..\"}",
        "current": { "text": "http_requests_total{code!~\"5..\"}", "value": "http_requests_total{code!~\"5..\"}" }
      },
      {
        "name": "den_raw",
        "type": "textbox",
        "label": "Denominator (raw counter)",
        "description": "PromQL: сырой счётчик всех событий для increase().",
        "query": "http_requests_total",
        "current": { "text": "http_requests_total", "value": "http_requests_total" }
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": {
    "refresh_intervals": [ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ],
    "time_options": [ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ]
  },
  "timezone": "",
  "title": "SLO / Overview",
  "uid": "slo-overview",
  "version": 1,
  "weekStart": ""
}
