{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "type": "row",
      "title": "Overview",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }
    },
    {
      "type": "stat",
      "title": "Ingress 401+403 (rps)",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", job=~\"$nginx_job\", status=~\"401|403\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none", "justifyMode": "auto" },
      "fieldConfig": { "defaults": { "unit": "req/s" }, "overrides": [] }
    },
    {
      "type": "stat",
      "title": "APIServer 401+403 (rps)",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate(apiserver_request_total{job=~\"$apiserver_job\", code=~\"401|403\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none", "justifyMode": "auto" },
      "fieldConfig": { "defaults": { "unit": "req/s" }, "overrides": [] }
    },
    {
      "type": "stat",
      "title": "Keycloak failed logins (rps)",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate(keycloak_user_events_total{event=\"login\", error!=\"\", job=~\"$keycloak_job\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "fieldConfig": { "defaults": { "unit": "req/s" } }
    },
    {
      "type": "stat",
      "title": "oauth2-proxy 401+403 (events/s)",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
      "datasource": { "type": "loki", "uid": "${loki_ds}" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by () (count_over_time({app=~\"$oauth2_app\", namespace=~\"$namespace\"} |= \"StatusCode=\" | regexp \"StatusCode=(?P<code>\\\\d{3})\" | code=~\"401|403\" [$__interval]))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },

    {
      "type": "row",
      "title": "Ingress — perimeter auth",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 }
    },
    {
      "type": "timeseries",
      "title": "Ingress 401/403 by ingress",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 6 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (ingress, status) (rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", job=~\"$nginx_job\", status=~\"401|403\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" } },
      "options": { "legend": { "displayMode": "table", "placement": "right" }, "tooltip": { "mode": "multi" } }
    },
    {
      "type": "timeseries",
      "title": "Ingress 4xx/5xx (baseline for comparison)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 6 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (status) (rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", job=~\"$nginx_job\", status=~\"4..|5..\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" } },
      "options": { "legend": { "displayMode": "table", "placement": "right" } }
    },
    {
      "type": "table",
      "title": "Top paths causing 401/403 (last $__range)",
      "description": "Top-10 по host+path",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 13 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (host, path, ingress, status) (increase(nginx_ingress_controller_requests{namespace=~\"$namespace\", job=~\"$nginx_job\", status=~\"401|403\"}[$__range])))",
          "format": "table",
          "instant": true,
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req" } },
      "options": { "showHeader": true }
    },

    {
      "type": "row",
      "title": "API Server — RBAC/AuthN/AuthZ",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 21 }
    },
    {
      "type": "timeseries",
      "title": "APIServer 401/403 by verb",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 22 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (verb, code) (rate(apiserver_request_total{job=~\"$apiserver_job\", code=~\"401|403\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" } },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["last","max"] } }
    },
    {
      "type": "timeseries",
      "title": "APIServer error rate (%)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 22 },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * sum(rate(apiserver_request_total{job=~\"$apiserver_job\", code=~\"4..|5..\"}[$__rate_interval])) / sum(rate(apiserver_request_total{job=~\"$apiserver_job\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } }
    },
    {
      "type": "table",
      "title": "Top resources by 403 (authorization denies)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 29 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (resource, verb) (increase(apiserver_request_total{job=~\"$apiserver_job\", code=\"403\"}[$__range])))",
          "format": "table",
          "instant": true,
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ]
    },

    {
      "type": "row",
      "title": "Keycloak — IdP login failures",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 37 }
    },
    {
      "type": "timeseries",
      "title": "Keycloak failed logins by realm/error",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 38 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (realm, error) (rate(keycloak_user_events_total{job=~\"$keycloak_job\", event=\"login\", error!=\"\"}[$__rate_interval]))",
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ],
      "fieldConfig": { "defaults": { "unit": "req/s" } },
      "options": { "legend": { "displayMode": "table", "placement": "right" } }
    },
    {
      "type": "table",
      "title": "Top Keycloak login errors (last $__range)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 38 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (error) (increase(keycloak_user_events_total{job=~\"$keycloak_job\", event=\"login\", error!=\"\"}[$__range])))",
          "format": "table",
          "instant": true,
          "datasource": { "type": "prometheus", "uid": "${ds}" }
        }
      ]
    },

    {
      "type": "row",
      "title": "oauth2-proxy — logs via Loki",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 45 }
    },
    {
      "type": "timeseries",
      "title": "oauth2-proxy 401/403 by code (LogQL)",
      "description": "Парсинг StatusCode из request/auth-логов oauth2-proxy",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 46 },
      "datasource": { "type": "loki", "uid": "${loki_ds}" },
      "targets": [
        {
          "refId": "A",
          "expr": "{app=~\"$oauth2_app\", namespace=~\"$namespace\"} |= \"StatusCode=\" | regexp \"StatusCode=(?P<code>\\\\d{3})\" | code=~\"401|403\" | sum by (code) (count_over_time([$__interval]))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } },
      "options": { "legend": { "displayMode": "table", "placement": "right" } }
    },
    {
      "type": "table",
      "title": "oauth2-proxy top 401/403 URLs (LogQL, last $__range)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 46 },
      "datasource": { "type": "loki", "uid": "${loki_ds}" },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (url) (count_over_time({app=~\"$oauth2_app\", namespace=~\"$namespace\"} |= \"StatusCode=\" | regexp \"StatusCode=(?P<code>\\\\d{3}).*RequestURI (?P<url>[^\\s]+)\" | code=~\"401|403\" [$__range])))",
          "format": "table"
        }
      ]
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "style": "dark",
  "tags": ["security", "auth", "k8s", "keycloak", "ingress", "apiserver", "oauth2-proxy"],
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "ds",
        "label": "Prometheus",
        "query": "prometheus",
        "current": {}
      },
      {
        "type": "datasource",
        "name": "loki_ds",
        "label": "Loki",
        "query": "loki",
        "current": {}
      },
      {
        "type": "query",
        "name": "namespace",
        "label": "Namespace",
        "datasource": { "type": "prometheus", "uid": "${ds}" },
        "refresh": 1,
        "query": "label_values(nginx_ingress_controller_requests, namespace)",
        "includeAll": true,
        "multi": true
      },
      {
        "type": "query",
        "name": "nginx_job",
        "label": "Ingress job",
        "datasource": { "type": "prometheus", "uid": "${ds}" },
        "refresh": 1,
        "query": "label_values(nginx_ingress_controller_requests, job)",
        "includeAll": true,
        "multi": true
      },
      {
        "type": "query",
        "name": "apiserver_job",
        "label": "APIServer job",
        "datasource": { "type": "prometheus", "uid": "${ds}" },
        "refresh": 1,
        "query": "label_values(apiserver_request_total, job)",
        "includeAll": true,
        "multi": true
      },
      {
        "type": "query",
        "name": "keycloak_job",
        "label": "Keycloak job",
        "datasource": { "type": "prometheus", "uid": "${ds}" },
        "refresh": 1,
        "query": "label_values(keycloak_user_events_total, job)",
        "includeAll": true,
        "multi": true
      },
      {
        "type": "textbox",
        "name": "oauth2_app",
        "label": "Loki label app (oauth2-proxy)",
        "query": "oauth2-proxy",
        "current": { "text": "oauth2-proxy", "value": "oauth2-proxy" }
      }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timepicker": { "refresh_intervals": ["10s", "30s", "1m", "2m", "5m"] },
  "timezone": "",
  "title": "Security — Auth Failures (Ingress / APIServer / Keycloak / oauth2-proxy)",
  "uid": "sec-auth-failures",
  "version": 1,
  "weekStart": ""
}
