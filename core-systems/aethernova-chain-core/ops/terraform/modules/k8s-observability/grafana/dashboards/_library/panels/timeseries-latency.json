{
  "type": "timeseries",
  "title": "Latency p50 / p90 / p99",
  "description": "Universal latency quantiles from Prometheus histograms using histogram_quantile over *_bucket metrics. Expects variables: ${metric_base} (without _bucket), optional ${filter} label matcher (e.g. job=\"api\"), and optional ${group_by} labels (comma-separated, e.g. \"service,route\").",
  "id": 1,
  "datasource": {
    "type": "prometheus",
    "uid": "${DS_PROMETHEUS}"
  },
  "gridPos": { "h": 9, "w": 12, "x": 0, "y": 0 },
  "fieldConfig": {
    "defaults": {
      "unit": "s",
      "decimals": 2,
      "min": 0,
      "thresholds": {
        "mode": "absolute",
        "steps": [
          { "color": "green", "value": null },
          { "color": "yellow", "value": 0.3 },
          { "color": "red", "value": 1.2 }
        ]
      },
      "custom": {
        "drawStyle": "line",
        "lineInterpolation": "smooth",
        "lineWidth": 2,
        "showPoints": "auto",
        "spanNulls": true
      }
    },
    "overrides": []
  },
  "options": {
    "legend": {
      "displayMode": "table",
      "placement": "right",
      "calcs": ["lastNotNull"]
    },
    "tooltip": { "mode": "multi", "sort": "desc" },
    "seriesTable": { "fontSize": 12 }
  },
  "targets": [
    {
      "refId": "P50",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "expr": "label_replace(\n  histogram_quantile(0.5,\n    sum by (le, ${group_by}) (\n      rate(${metric_base}_bucket{${filter}}[5m])\n    )\n  ),\n  \"quantile\", \"0.5\", \"__name__\", \".*\"\n)",
      "interval": "",
      "legendFormat": ""
    },
    {
      "refId": "P90",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "expr": "label_replace(\n  histogram_quantile(0.9,\n    sum by (le, ${group_by}) (\n      rate(${metric_base}_bucket{${filter}}[5m])\n    )\n  ),\n  \"quantile\", \"0.9\", \"__name__\", \".*\"\n)",
      "interval": "",
      "legendFormat": ""
    },
    {
      "refId": "P99",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "expr": "label_replace(\n  histogram_quantile(0.99,\n    sum by (le, ${group_by}) (\n      rate(${metric_base}_bucket{${filter}}[5m])\n    )\n  ),\n  \"quantile\", \"0.99\", \"__name__\", \".*\"\n)",
      "interval": "",
      "legendFormat": ""
    }
  ],
  "transformations": [],
  "timeFrom": null,
  "timeShift": null,
  "pluginVersion": "9.x"
}
