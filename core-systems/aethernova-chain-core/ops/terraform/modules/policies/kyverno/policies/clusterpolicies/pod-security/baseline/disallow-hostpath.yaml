apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-hostpath
  labels:
    app.kubernetes.io/name: kyverno
    app.kubernetes.io/part-of: pod-security-standards
    app.kubernetes.io/component: baseline
  annotations:
    policies.kyverno.io/title: Disallow hostPath
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod,Volume
    policies.kyverno.io/description: >-
      HostPath volumes let Pods use host directories and volumes in containers.
      Using host resources can be used to access shared data or escalate privileges
      and should not be allowed. This policy ensures no hostPath volumes are in use.
      (Based on official Kyverno Baseline policy "Disallow hostPath".)
spec:
  # В промышленном режиме используем Enforce для блокировки запроса.
  # Документация по режимам Audit/Enforce: https://kyverno.io/docs/introduction/quick-start/
  validationFailureAction: Enforce
  background: true
  rules:
    - name: disallow-hostpath-in-pods
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: >-
          HostPath volumes are forbidden by Pod Security Standards (Baseline).
          The field spec.volumes[*].hostPath must be unset.
        # Шаблон из официальной политики Kyverno «Disallow hostPath»:
        # https://kyverno.io/policies/pod-security/baseline/disallow-host-path/disallow-host-path/
        pattern:
          spec:
            =(volumes):
              - X(hostPath): "null"
