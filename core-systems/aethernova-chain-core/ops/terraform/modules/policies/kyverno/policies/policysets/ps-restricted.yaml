apiVersion: policy.open-cluster-management.io/v1beta1
kind: PolicySet
metadata:
  # Namespace должен совпадать с namespace, где находятся Policy (OCM),
  # которые заворачивают ваши Kyverno ClusterPolicy/Policy.
  name: ps-restricted
  namespace: policies
  labels:
    app.kubernetes.io/name: ps-restricted
    app.kubernetes.io/part-of: aethernova-chain-core
  annotations:
    policy.open-cluster-management.io/description: >
      Набор строгих политик безопасности: Pod Security Standards (restricted),
      supply-chain защита (подписи/аттестации образов), запрет привилегий и host-доступов,
      сетевые и учётные ограничения. PolicySet агрегирует готовые Policy-объекты,
      их соответствие суммируется в статусе PolicySet.
    # Подтверждение, что PolicySet — группировка Policy и связывается через PlacementBinding:
    # https://open-cluster-management.io/docs/getting-started/integration/policy-controllers/policy/#policyset
spec:
  description: >
    Промышленный набор Kyverno-политик уровня "restricted" + supply-chain.
    Предполагается, что перечисленные ниже Policy (OCM) уже созданы в том же namespace.
  policies:
    # --- Блок Pod Security Standards: restricted (включая baseline) ---
    # Policy-обёртка над Kyverno ClusterPolicy, применяющей PSS restricted:
    # Kyverno podSecurity level: restricted, version: latest.
    # refs: https://kyverno.io/policies/pod-security/subrule/restricted/restricted-latest/
    - kyverno-pss-restricted

    # --- Блок ограничений привилегий и host-доступов ---
    # Запрет privileged=true, hostPID/hostIPC, hostNetwork, hostPorts, hostPath и т.п.
    # Эти Policy обычно разбиты по правилам для лучшей наблюдаемости.
    - kyverno-disallow-privileged
    - kyverno-disallow-host-namespaces
    - kyverno-disallow-host-network-ports
    - kyverno-disallow-hostpath
    - kyverno-require-seccomp
    - kyverno-require-run-as-non-root
    - kyverno-drop-cap-net-raw-and-more
    - kyverno-readonly-rootfs
    - kyverno-disallow-automount-serviceaccount-token

    # --- Блок supply-chain (образы) ---
    # Верификация подписей/аттестаций образов (Cosign) + подмена на digest:
    # refs: https://kyverno.io/policies/other/verify-image/verify-image/
    #       https://release-1-12-0.kyverno.io/docs/writing-policies/verify-images/
    - kyverno-verify-images
    # Запрет :latest и требование указывать тег:
    - kyverno-disallow-latest-tag
    # Требование использовать digest (sha256:...), при необходимости mutateDigest=true в verifyImages:
    - kyverno-require-image-digest

    # --- Дополнительные организационные практики ---
    # Требование стандартных меток/аннотаций для трассируемости и ответственных:
    - kyverno-require-standard-labels
    # Сетевой базис (например, генерация/валидация default-deny NetworkPolicy в namespace):
    - kyverno-namespace-default-deny-networkpolicy
