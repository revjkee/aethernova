apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Включаем каталоги с кластерными политиками Kyverno,
# kustomize рекурсивно подхватит все *.yaml внутри них.
resources:
  - ../../clusterpolicies/pod-security/baseline
  - ../../clusterpolicies/ingress

# Единые метки и аннотации для окружения staging
commonLabels:
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: kyverno-policies
  app.kubernetes.io/environment: staging

commonAnnotations:
  policies.aethernova.io/owner: platform-security
  policies.aethernova.io/environment: staging
  policies.aethernova.io/change-request: "required"
  policies.aethernova.io/trace: "true"

# Опции сборки: сохраняем исходные имена ресурсов
namePrefix: ""
nameSuffix: ""

# Патчи для всех ClusterPolicy:
# 1) Принудительно включаем Enforce валидацию на staging.
# 2) Добавляем технические аннотации для трассировки и аудита.
patches:
  - target:
      group: kyverno.io
      version: v1
      kind: ClusterPolicy
    patch: |-
      - op: add
        path: /spec/validationFailureAction
        value: Enforce
      - op: add
        path: /metadata/annotations/policies.aethernova.io%2Fvalidated-by
        value: kyverno
      - op: add
        path: /metadata/annotations/policies.aethernova.io%2Fstage
        value: staging
      - op: add
        path: /metadata/labels/policies.aethernova.io~1stage
        value: "true"

# Дополнительные безопасные дефолты для Kyverno ClusterPolicy
# (если в базовых политиках забыты критичные поля)
patchesStrategicMerge:
  # Усиливаем аудит фона и включаем полное логирование (если не задано)
  - |-
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: place-holder-to-merge-all-clusterpolicies
    spec:
      background: true
      failurePolicy: Fail

# Замечания по совместимости:
# - ClusterPolicy — ресурс кластерного уровня; namespace здесь не задаётся.
# - patch (json6902) с target.kind=ClusterPolicy без имени применится ко всем объектам этого kind.
# - Если часть политик должна остаться в режиме Audit, вынесите их в отдельный overlay или добавьте labelSelector в target.
