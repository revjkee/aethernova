apiVersion: cli.kyverno.io/v1alpha1
kind: Test
metadata:
  name: disallow-latest-tag
# Путь(и) к проверяемой политике Kyverno. Относительный путь рассчитан на вашу структуру репозитория.
# Убедитесь, что файл политики существует и содержит правило, запрещающее :latest и отсутствие тега.
policies:
  - ../../../../clusterpolicies/images/disallow-latest-tag.yaml

# Набор ресурсов для тестирования. Файлы с манифестами должны лежать рядом в ./resources/
resources:
  - resources/ok-explicit-tag.yaml                   # Pod c образами с явными НЕ-latest тегами -> pass
  - resources/ok-multicontainer-explicit-tags.yaml   # Поддержка нескольких контейнеров -> pass
  - resources/fail-latest-tag.yaml                   # Любой контейнер с :latest -> fail
  - resources/fail-missing-tag.yaml                  # Образ без тега (эквивалент latest) -> fail
  - resources/fail-initcontainer-latest.yaml         # latest в initContainers -> fail
  - resources/fail-ephemeral-latest.yaml             # latest в ephemeralContainers -> fail

# Ожидаемые результаты по каждому кейсу/ресурсу.
results:
  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - ok-explicit-tag
    result: pass

  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - ok-multicontainer-explicit-tags
    result: pass

  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - fail-latest-tag
    result: fail

  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - fail-missing-tag
    result: fail

  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - fail-initcontainer-latest
    result: fail

  - policy: disallow-latest-tag
    rule: require-image-tag
    kind: Pod
    resources:
      - fail-ephemeral-latest
    result: fail
