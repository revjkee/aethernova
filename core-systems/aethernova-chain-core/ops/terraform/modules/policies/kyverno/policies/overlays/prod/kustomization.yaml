apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 1) Подтягиваем базовые Kyverno ClusterPolicy из каталога policies/clusterpolicies
#    (предполагается, что там лежат манифесты без окруженческих настроек).
resources:
  - ../../clusterpolicies

# 2) Единые prod-метаданные для трассируемости изменений и однозначной идентификации окружения.
commonLabels:
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: kyverno-policies
  app.kubernetes.io/managed-by: kustomize
  env: prod

commonAnnotations:
  audit.aethernova.io/purpose: "Kyverno policies overlay (prod)"
  audit.aethernova.io/change-ticket: "TICKET-XXXX"
  audit.aethernova.io/reviewed-by: "security-cab"
  audit.aethernova.io/source: "gitops"

# 3) Прод-усиление Kyverno-политик:
#    - validationFailureAction=Enforce (жёсткая блокировка нарушений)
#    - failurePolicy=Fail (если вебхук недоступен — отказ)
#    - background=true (скан в фоне)
#    Все изменения задаются целевым патчем по kind=ClusterPolicy (группа kyverno.io, v1).
patches:
  - target:
      group: kyverno.io
      version: v1
      kind: ClusterPolicy
    patch: |-
      - op: add
        path: /spec/validationFailureAction
        value: Enforce
      - op: add
        path: /spec/failurePolicy
        value: Fail
      - op: add
        path: /spec/background
        value: true

# Примечания по верификации:
# - validationFailureAction=Enforce блокирует несоответствующие ресурсы (а не только пишет отчёты). 
#   Источник: Kyverno Validate Rules / Policy Reports. 
# - failurePolicy=Fail и допустимые значения описаны в Kyverno CRDs/Policy Settings.
# - Использование overlays и целевых патчей поддержано Kustomize/Argo CD.
# Источники:
#   https://kyverno.io/docs/writing-policies/validate/
#   https://kyverno.io/docs/policy-reports/
#   https://kyverno.io/docs/crds/
#   https://kyverno.io/docs/writing-policies/policy-settings/
#   https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/
#   https://argo-cd.readthedocs.io/en/stable/user-guide/kustomize/
