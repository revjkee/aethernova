apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-latest-tag
  annotations:
    policies.kyverno.io/title: Disallow Latest Tag
    policies.kyverno.io/category: Best Practices, Supply Chain
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Image Tagging
    policies.kyverno.io/description: >-
      The ':latest' tag is mutable and can lead to unexpected errors if the image changes.
      Enforce explicit, immutable image tags and disallow the 'latest' tag for all Pods.
      Based on Kyverno official best-practice policy with production-hardening.
    kyverno.io/kyverno-version: "1.15.0"
    policies.kyverno.io/minversion: "1.6.0"
spec:
  # Блокируем несоответствующие ресурсы (см. docs: Enforce vs Audit).
  validationFailureAction: Enforce
  # Включаем фоновое сканирование для отчётности и видимости состояния.
  background: true

  rules:
    # 1) Требовать явный тег образа (*:*)
    - name: require-image-tag
      match:
        any:
          - resources:
              kinds:
                - Pod
              # Исключаем системные пространства имён, чтобы не ломать системные контроллеры.
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values: ["kube-system", "kube-public", "kube-node-lease"]
      preconditions:
        all:
          - key: "{{ request.operation || 'BACKGROUND' }}"
            operator: NotEquals
            value: "DELETE"
      validate:
        message: "An explicit image tag is required for every container (no implicit ':latest')."
        foreach:
          - list: "request.object.spec.containers"
            pattern:
              image: "*:*"
          - list: "request.object.spec.initContainers"
            pattern:
              image: "*:*"
          - list: "request.object.spec.ephemeralContainers"
            pattern:
              image: "*:*"

    # 2) Запретить использование тега latest
    - name: deny-latest-tag
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaceSelector:
                matchExpressions:
                  - key: kubernetes.io/metadata.name
                    operator: NotIn
                    values: ["kube-system", "kube-public", "kube-node-lease"]
      preconditions:
        all:
          - key: "{{ request.operation || 'BACKGROUND' }}"
            operator: NotEquals
            value: "DELETE"
      validate:
        message: "Using a mutable image tag (e.g., 'latest') is not allowed."
        foreach:
          - list: "request.object.spec.containers"
            pattern:
              image: "!*:latest"
          - list: "request.object.spec.initContainers"
            pattern:
              image: "!*:latest"
          - list: "request.object.spec.ephemeralContainers"
            pattern:
              image: "!*:latest"
