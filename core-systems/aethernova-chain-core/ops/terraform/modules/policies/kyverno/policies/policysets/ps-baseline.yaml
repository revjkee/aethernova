# Path: aethernova-chain-core/ops/terraform/modules/policies/kyverno/policies/policysets/ps-baseline.yaml
# Purpose: RHACM/OCM PolicySet, группирующий Kyverno-политики уровня "baseline" (PSS) + best practices.
# Notes:
# - Требуются заранее созданные Policy/ClusterPolicy объекты Kyverno, имена которых перечислены в spec.policies.
# - apiVersion/kind соответствуют OCM PolicySet (см. docs). Источник: open-cluster-management.io. 
# - Этот файл не включает Placement/PlacementBinding.

apiVersion: policy.open-cluster-management.io/v1beta1
kind: PolicySet
metadata:
  name: ps-baseline
  namespace: policies
  labels:
    app.kubernetes.io/name: kyverno-pss
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: policyset
    policy.aethernova.io/tier: baseline
    policy.aethernova.io/system: kyverno
  annotations:
    policy.open-cluster-management.io/description: >
      Baseline PSS (Kyverno) + базовые best-practices: запрет privileged/hostPath,
      ограничение sysctls/hostPorts/capabilities, требование non-root/ro-rootfs,
      seccomp runtime/default и запрет privilegeEscalation. Источник baseline: Kyverno PSS.
    org.aethernova.change-control: gitops
    org.aethernova.repo: aethernova-chain-core
    org.aethernova.path: ops/terraform/modules/policies/kyverno/policies/policysets
spec:
  description: Baseline Pod Security Standards (PSS) + best practices (Kyverno)
  policies:
    # Политики PSS baseline (может быть "единая" политика профиля или набор суб-правил)
    - kyverno-pss-baseline-profile                # единая политика профиля PSS baseline (если используется)
    - kyverno-pss-disallow-privileged             # запрет privileged
    - kyverno-pss-restrict-sysctls                # ограниченные sysctls
    - kyverno-pss-disallow-host-namespaces        # hostPID/hostIPC/hostNetwork=false
    - kyverno-pss-restrict-host-ports             # ограничение hostPorts
    - kyverno-pss-restrict-volume-types           # запрет небезопасных volumeTypes
    # Best practices (дополняют baseline)
    - kyverno-bp-restrict-capabilities            # drop ALL, запрет NET_ADMIN и пр.
    - kyverno-bp-require-nonroot-user             # runAsNonRoot / runAsUser>=10000 (пример)
    - kyverno-bp-readonly-rootfs                  # readOnlyRootFilesystem=true
    - kyverno-bp-disallow-privilege-escalation    # allowPrivilegeEscalation=false
    - kyverno-bp-require-seccomp-runtime-default  # seccompProfile=runtime/default
    - kyverno-bp-image-registry-allowlist         # allowlist реестров образов
    - kyverno-bp-disallow-hostpath                # запрет hostPath монтирований
