apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-image-registries
  annotations:
    policies.kyverno.io/title: Restrict Image Registries
    policies.kyverno.io/category: Supply Chain, Best Practices
    policies.kyverno.io/severity: high
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kubernetes-version: "1.26"
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Validate that all container images (including initContainers and ephemeralContainers)
      originate only from approved registries to reduce supply-chain risk.
      Violations are blocked (Enforce).
spec:
  # Блокируем немедленно (см. рекомендации Kyverno: Audit -> Enforce для блокировки)
  # https://kyverno.io/policies/  (замечание о validationFailureAction)
  validationFailureAction: Enforce
  background: true
  rules:
    - name: allow-only-approved-registries
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - kyverno
                - gatekeeper-system
      # Ограничиваем операции до CREATE/UPDATE, чтобы избежать лишних отчетов в фоне
      preconditions:
        any:
          - key: "{{ request.operation || 'BACKGROUND' }}"
            operator: AnyIn
            value:
              - CREATE
              - UPDATE
      validate:
        message: >-
          Image registry is not in the approved allowlist.
          Allowed registries: registry.example.com, ghcr.io, eu.gcr.io.
        # Официальный паттерн Kyverno для ограничений по реестрам
        # https://kyverno.io/policies/best-practices/restrict-image-registries/
        pattern:
          spec:
            # =(field) — опциональные секции (ephemeral/init), см. пример в политике Kyverno.
            =(ephemeralContainers):
              - image: "registry.example.com/* | ghcr.io/* | eu.gcr.io/*"
            =(initContainers):
              - image: "registry.example.com/* | ghcr.io/* | eu.gcr.io/*"
            containers:
              - image: "registry.example.com/* | ghcr.io/* | eu.gcr.io/*"
