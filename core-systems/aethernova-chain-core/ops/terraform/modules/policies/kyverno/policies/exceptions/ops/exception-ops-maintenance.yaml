# aethernova-chain-core/ops/terraform/modules/policies/kyverno/policies/exceptions/ops/exception-ops-maintenance.yaml
apiVersion: kyverno.io/v2
kind: PolicyException
metadata:
  name: ops-maintenance-window
  namespace: kyverno
  labels:
    app.kubernetes.io/name: kyverno-policy-exception
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: policies
    app.kubernetes.io/managed-by: gitops
    policy.aethernova.io/tier: baseline
    policy.aethernova.io/owner: platform-ops
  annotations:
    policies.kyverno.io/title: "Ops maintenance exception"
    policies.kyverno.io/category: "Operations"
    policies.kyverno.io/subject: "Pod, Deployment, StatefulSet, DaemonSet, Job, CronJob"
    policies.kyverno.io/description: >
      Временное исключение для проведения регламентных работ в namespace 'ops'.
      Исключение разрешает обход ряда политик безопасности только для ресурсов из 'ops'
      и только в пределах окна обслуживания. После окончания окна исключение должно быть удалено.
    # Метаданные для автоматической очистки (используются типовой политикой Kyverno из policy library)
    # см. "Expiration for PolicyExceptions" — исключение будет удалено по истечении времени.
    # Формат ISO 8601 в UTC.
    policy.aethernova.io/expireAt: "2025-09-12T23:00:00Z"
    policy.aethernova.io/change-ticket: "OPS-12345"
    policy.aethernova.io/approved-by: "platform-security-core"
spec:
  # Ограничиваем область исключения ТОЛЬКО ресурсами из namespace 'ops'
  # (структура match/exclude соответствует правилам Kyverno)
  match:
    any:
      - resources:
          namespaces:
            - ops
          kinds:
            - Pod
            - Deployment
            - StatefulSet
            - DaemonSet
            - Job
            - CronJob

  # Набор исключений: перечисляются политики и имена их правил,
  # для которых разрешён обход. Разрешено использовать wildcard для ruleNames.
  exceptions:
    # 1) Исключение для вашей supply-chain политики подписи образов (пример из предыдущего шага)
    - policyName: supply-chain-verify-image-signatures-cosign
      ruleNames:
        - "*"  # все правила внутри политики

    # 2) Пример: исключение для политики, запрещающей hostNamespaces (если такая политика есть в кластере)
    # Замените имя политики на фактическое, либо удалите блок.
    # - policyName: disallow-host-namespaces
    #   ruleNames:
    #     - "*"

    # 3) Пример: исключение для политики, запрещающей :latest теги (если используется в вашем наборе)
    # - policyName: disallow-latest-tag
    #   ruleNames:
    #     - "*"

  # Дополнительно можно исключить чувствительные неймспейсы из области исключений (защита от ошибок)
  exclude:
    any:
      - resources:
          namespaces:
            - kube-system
            - kyverno
            - gatekeeper-system
            - kube-public
