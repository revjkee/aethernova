apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: pss-baseline-disallow-host-namespaces
  annotations:
    policies.kyverno.io/title: Disallow Host Namespaces
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Host namespaces (Process ID, IPC, and network) allow access to shared information
      and can be used to elevate privileges. Pods must not request host namespaces.
      Fields spec.hostPID, spec.hostIPC, and spec.hostNetwork must be unset or set to false.
      (PSS Baseline + Kyverno sample policy)
    pod-security.kubernetes.io/profile: baseline
spec:
  validationFailureAction: Enforce
  background: true
  failurePolicy: Fail
  rules:
    - name: disallow-host-namespaces
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: >-
          Sharing the host namespaces is disallowed. The fields spec.hostNetwork,
          spec.hostIPC, and spec.hostPID must be unset or set to "false".
        # Equality anchors `=(key)` из Kyverno: если ключ существует, его значение
        # должно совпадать; если ключ отсутствует — правило по нему считается пройденным.
        # Это соответствует требованию "unset or false".
        # Источник паттерна: официальный пример Kyverno.
        # https://raw.githubusercontent.com/kyverno/policies/main/pod-security/baseline/disallow-host-namespaces/disallow-host-namespaces.yaml
        pattern:
          spec:
            =(hostPID): "false"
            =(hostIPC): "false"
            =(hostNetwork): "false"
