apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-default-networkpolicy
  annotations:
    policies.kyverno.io/title: "Namespace Onboarding: Default NetworkPolicies"
    policies.kyverno.io/category: "Best Practices, Network Security"
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Namespace, NetworkPolicy
    policies.kyverno.io/description: >-
      Generate baseline NetworkPolicies for each Namespace:
      1) default-deny-all (Ingress+Egress), 2) allow-dns (53/TCP, 53/UDP).
      Applies to new and existing Namespaces; resources kept in sync.
spec:
  background: true
  # Ретроактивная генерация для уже существующих Namespace.
  generateExisting: true

  rules:
    # 1) Default deny для всех Pod в Namespace (Ingress + Egress)
    - name: generate-default-deny-networkpolicy
      match:
        any:
          - resources:
              kinds:
                - Namespace
      generate:
        kind: NetworkPolicy
        apiVersion: networking.k8s.io/v1
        name: default-deny-all
        namespace: "{{ request.object.metadata.name }}"
        synchronize: true
        data:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: default-deny-all
            labels:
              app.kubernetes.io/managed-by: kyverno
              app.kubernetes.io/part-of: namespace-onboarding
          spec:
            podSelector: {}                # выбирает все Pod в Namespace
            policyTypes:
              - Ingress
              - Egress

    # 2) Разрешить DNS (Egress 53/TCP, 53/UDP) для всех Pod
    - name: generate-allow-dns-networkpolicy
      match:
        any:
          - resources:
              kinds:
                - Namespace
      generate:
        kind: NetworkPolicy
        apiVersion: networking.k8s.io/v1
        name: allow-dns
        namespace: "{{ request.object.metadata.name }}"
        synchronize: true
        data:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: allow-dns
            labels:
              app.kubernetes.io/managed-by: kyverno
              app.kubernetes.io/part-of: namespace-onboarding
          spec:
            podSelector: {}                # применимо ко всем Pod
            policyTypes:
              - Egress
            egress:
              - ports:
                  - protocol: UDP
                    port: 53
                  - protocol: TCP
                    port: 53
