apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: enforce-probes-liveness-readiness
  annotations:
    policies.kyverno.io/title: "Enforce Liveness & Readiness Probes"
    policies.kyverno.io/category: "Best Practices"
    policies.kyverno.io/severity: "high"
    policies.kyverno.io/subject: "Pod"
    policies.kyverno.io/description: >
      Требует наличия одновременно livenessProbe и readinessProbe у всех контейнеров
      (containers, initContainers, ephemeralContainers) в Pod. Основано на официальных
      рекомендациях Kubernetes по конфигурации probes и примерах Kyverno (включая CEL-политику
      Require Pod Probes). 
      Источники: Kubernetes docs (Configure Liveness/Readiness/Startup Probes),
      Kyverno sample "Require Pod Probes" и CEL-версия. 
spec:
  validationFailureAction: Enforce
  background: true
  failurePolicy: Fail
  rules:
    - name: require-probes-in-containers
      match:
        any:
          - resources:
              kinds: ["Pod"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - kyverno
                - kyverno-system
                - gatekeeper-system
      validate:
        message: "Каждый container обязан иметь и livenessProbe, и readinessProbe."
        cel:
          expressions:
            - expression: >
                has(object.spec.containers) ?
                size(object.spec.containers.filter(c, has(c.livenessProbe) && has(c.readinessProbe))) 
                == size(object.spec.containers)
                : true
              message: "Отсутствуют probes в .spec.containers[]. Требуются одновременно livenessProbe и readinessProbe."
    - name: require-probes-in-initcontainers
      match:
        any:
          - resources:
              kinds: ["Pod"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - kyverno
                - kyverno-system
                - gatekeeper-system
      validate:
        message: "Каждый initContainer обязан иметь и livenessProbe, и readinessProbe."
        cel:
          expressions:
            - expression: >
                has(object.spec.initContainers) ?
                size(object.spec.initContainers.filter(c, has(c.livenessProbe) && has(c.readinessProbe)))
                == size(object.spec.initContainers)
                : true
              message: "Отсутствуют probes в .spec.initContainers[]. Требуются одновременно livenessProbe и readinessProbe."
    - name: require-probes-in-ephemeralcontainers
      match:
        any:
          - resources:
              kinds: ["Pod"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - kyverno
                - kyverno-system
                - gatekeeper-system
      validate:
        message: "Каждый ephemeralContainer обязан иметь и livenessProbe, и readinessProbe."
        cel:
          expressions:
            - expression: >
                has(object.spec.ephemeralContainers) ?
                size(object.spec.ephemeralContainers.filter(c, has(c.livenessProbe) && has(c.readinessProbe)))
                == size(object.spec.ephemeralContainers)
                : true
              message: "Отсутствуют probes в .spec.ephemeralContainers[]. Требуются одновременно livenessProbe и readinessProbe."
