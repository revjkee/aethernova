apiVersion: kyverno.io/v2
kind: PolicyException
metadata:
  name: exception-dev-namespaces
  namespace: policy-exceptions   # PolicyException — Namespaced CRD; этот неймспейс — место хранения исключений
  labels:
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: kyverno-exceptions
    app.kubernetes.io/managed-by: gitops
  annotations:
    # Аннотация с целевым окном действия (читает ваша орг. политика очистки/ревью; само Kyverno не удаляет объект по этой дате)
    exception.aethernova.io/expiresAt: "2025-12-31T23:59:59Z"
    policies.kyverno.io/description: >-
      Dev-only exception to allow development workloads to bypass selected supply-chain
      policy(ies) while testing. Scope is limited to dev namespaces and namespaces
      labeled aether/env=dev.
spec:
  background: true
  # Какие политики и правила обходить
  exceptions:
    - policyName: restrict-image-registries   # имя ClusterPolicy
      ruleNames:
        - "*"                                 # исключить все правила указанной политики (подтверждается в доке)
  # На какие ресурсы распространяется исключение
  match:
    any:
      - resources:
          kinds:
            - Pod
            - Deployment
          # Явный список dev-неймспейсов
          namespaces:
            - dev
            - dev-tools
            - playground
            - sandbox
          # Плюс любые неймспейсы с меткой env=dev
          selector:
            matchLabels:
              aether/env: dev
  # Необязочное уточнение через conditions (пример — доп. маркировка релизов)
  # conditions:
  #   any:
  #     - key: "{{ request.object.metadata.labels['aether/release'] || '' }}"
  #       operator: In
  #       value:
  #         - dev
  #         - experimental
