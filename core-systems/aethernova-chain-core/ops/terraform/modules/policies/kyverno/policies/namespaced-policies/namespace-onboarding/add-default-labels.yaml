apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: namespace-onboarding-add-default-labels
  annotations:
    policies.kyverno.io/title: "Namespace Onboarding: Add & Require Default Labels"
    policies.kyverno.io/category: "Best Practices"
    policies.kyverno.io/severity: "medium"
    policies.kyverno.io/subject: "Namespaced resources"
    policies.kyverno.io/description: >
      Добавляет рекомендованные Kubernetes-метки по умолчанию к ресурсам в текущем namespace,
      не перезаписывая существующие значения (add-if-not-present), и валидирует их наличие.
spec:
  background: true
  failurePolicy: Fail
  validationFailureAction: Enforce

  rules:
    # 1) Мутация: добавить метки ТОЛЬКО если они отсутствуют
    - name: add-default-recommended-labels
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
                - Service
                - ConfigMap
                - Secret
                - Ingress
                - ServiceAccount
                - Role
                - RoleBinding
                - NetworkPolicy
                - PersistentVolumeClaim
                - HorizontalPodAutoscaler
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              # Добавляем, только если отсутствует (Kyverno "add if not present" anchor)
              "+(app.kubernetes.io/name)": "{{ request.object.metadata.name }}"
              "+(app.kubernetes.io/instance)": "{{ request.namespace }}"
              "+(app.kubernetes.io/part-of)": "aethernova-chain-core"
              "+(app.kubernetes.io/managed-by)": "kyverno"

    # 2) Валидация: требуем наличие этих меток с непустыми значениями
    - name: require-default-recommended-labels
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
                - Service
                - ConfigMap
                - Secret
                - Ingress
                - ServiceAccount
                - Role
                - RoleBinding
                - NetworkPolicy
                - PersistentVolumeClaim
                - HorizontalPodAutoscaler
      validate:
        message: "Отсутствуют обязательные рекомендованные метки Kubernetes (app.kubernetes.io/*)."
        pattern:
          metadata:
            labels:
              app.kubernetes.io/name: "?*"
              app.kubernetes.io/instance: "?*"
              app.kubernetes.io/part-of: "?*"
              app.kubernetes.io/managed-by: "?*"
