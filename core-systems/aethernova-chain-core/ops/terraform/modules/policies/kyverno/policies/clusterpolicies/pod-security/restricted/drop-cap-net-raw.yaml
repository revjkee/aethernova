apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: pss-restricted-drop-cap-net-raw
  annotations:
    policies.kyverno.io/title: "Drop CAP_NET_RAW (Enforce)"
    policies.kyverno.io/category: "Pod Security Standards (Restricted)"
    policies.kyverno.io/severity: "high"
    policies.kyverno.io/subject: "Pod"
    policies.kyverno.io/description: >
      Запрещает добавление CAP_NET_RAW и обеспечивает явное его
      удаление во всех контейнерах Pod. Основано на лучших практиках Kyverno
      и соответствует целям профиля Restricted PSS.
      См. пример Kyverno по CAP_NET_RAW и PSS. 
    pod-policies.kyverno.io/autogen-controllers: "all"
spec:
  background: true
  failurePolicy: Fail
  validationFailureAction: Enforce
  rules:
    # 1) Мутация: принудительно добавляем drop: ["NET_RAW"] для всех типов контейнеров
    - name: mutate-drop-net-raw-containers
      match:
        any:
          - resources:
              kinds:
                - Pod
      mutate:
        foreach:
          # Обычные контейнеры
          - list: "request.object.spec.containers"
            preconditions:
              all:
                - key: "{{ element }}"
                  operator: NotEquals
                  value: null
            patchStrategicMerge:
              spec:
                containers:
                  - (name): "{{ element.name }}"
                    securityContext:
                      capabilities:
                        drop:
                          - "NET_RAW"
          # initContainers
          - list: "request.object.spec.initContainers"
            preconditions:
              all:
                - key: "{{ element }}"
                  operator: NotEquals
                  value: null
            patchStrategicMerge:
              spec:
                initContainers:
                  - (name): "{{ element.name }}"
                    securityContext:
                      capabilities:
                        drop:
                          - "NET_RAW"
          # ephemeralContainers
          - list: "request.object.spec.ephemeralContainers"
            preconditions:
              all:
                - key: "{{ element }}"
                  operator: NotEquals
                  value: null
            patchStrategicMerge:
              spec:
                ephemeralContainers:
                  - (name): "{{ element.name }}"
                    securityContext:
                      capabilities:
                        drop:
                          - "NET_RAW"

    # 2) Валидация: запрещаем любое добавление NET_RAW через capabilities.add
    - name: forbid-add-net-raw
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Добавление CAP_NET_RAW запрещено политикой безопасности (PSS Restricted)."
        foreach:
          # containers
          - list: "request.object.spec.containers"
            deny:
              conditions:
                any:
                  - key: "{{ contains(element.securityContext.capabilities.add[], 'NET_RAW') }}"
                    operator: Equals
                    value: true
          # initContainers
          - list: "request.object.spec.initContainers"
            deny:
              conditions:
                any:
                  - key: "{{ contains(element.securityContext.capabilities.add[], 'NET_RAW') }}"
                    operator: Equals
                    value: true
          # ephemeralContainers
          - list: "request.object.spec.ephemeralContainers"
            deny:
              conditions:
                any:
                  - key: "{{ contains(element.securityContext.capabilities.add[], 'NET_RAW') }}"
                    operator: Equals
                    value: true
