# aethernova-chain-core/ops/terraform/modules/policies/kyverno/policies/test/cases/disallow-latest-tag/resources.yaml

---
apiVersion: v1
kind: Namespace
metadata:
  name: test-disallow-latest
  labels:
    app.kubernetes.io/name: kyverno-disallow-latest
    app.kubernetes.io/part-of: policy-tests
---
# NEGATIVE: Pod с :latest и imagePullPolicy: IfNotPresent (должен быть отклонён policy)
apiVersion: v1
kind: Pod
metadata:
  name: pod-latest-ifnotpresent
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  containers:
    - name: web
      image: nginx:latest
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 80
---
# NEGATIVE: Pod с :latest и imagePullPolicy не указан (по умолчанию IfNotPresent) — должен быть отклонён
apiVersion: v1
kind: Pod
metadata:
  name: pod-latest-no-policy
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  containers:
    - name: api
      image: busybox:latest
      command: ["sh","-c","sleep 3600"]
---
# NEGATIVE: Deployment c контейнером :latest — должен быть отклонён
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dep-latest
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dep-latest
  template:
    metadata:
      labels:
        app: dep-latest
    spec:
      containers:
        - name: app
          image: alpine:latest
          command: ["sh","-c","sleep 3600"]
---
# NEGATIVE: Deployment с initContainer :latest — должен быть отклонён
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dep-initcontainer-latest
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dep-init-latest
  template:
    metadata:
      labels:
        app: dep-init-latest
    spec:
      initContainers:
        - name: init
          image: busybox:latest
          command: ["sh","-c","echo init && sleep 1"]
      containers:
        - name: app
          image: nginx:1.25.3
          ports:
            - containerPort: 80
---
# NEGATIVE: Pod c ephemeralContainers и образом :latest — должен быть отклонён
apiVersion: v1
kind: Pod
metadata:
  name: pod-ephemeral-latest
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  containers:
    - name: main
      image: nginx:1.25.3
  ephemeralContainers:
    - name: debug
      image: busybox:latest
      command: ["sh"]
      args: ["-c","sleep 10"]
---
# NEGATIVE: Job с :latest — должен быть отклонён
apiVersion: batch/v1
kind: Job
metadata:
  name: job-latest
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: worker
          image: alpine:latest
          command: ["sh","-c","echo job && sleep 1"]
---
# NEGATIVE: CronJob с :latest — должен быть отклонён
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cj-latest
  namespace: test-disallow-latest
  labels:
    test.case: negative
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron
              image: busybox:latest
              command: ["sh","-c","date; exit 0"]
---
# POSITIVE: Pod с фиксированным тегом и imagePullPolicy: IfNotPresent — должен пройти
apiVersion: v1
kind: Pod
metadata:
  name: pod-pinned-tag
  namespace: test-disallow-latest
  labels:
    test.case: positive
spec:
  containers:
    - name: web
      image: nginx:1.25.3
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 80
---
# POSITIVE: Pod с digest — должен пройти
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-digest
  namespace: test-disallow-latest
  labels:
    test.case: positive
spec:
  containers:
    - name: api
      image: nginx@sha256:3f8a433a8bb4f1a3a1d3e2b9c3a2e6d2c1b0f9e8d7c6b5a4a3b2c1d0e0f9a8b7
      ports:
        - containerPort: 80
---
# POSITIVE: Deployment без latest в init/containers — должен пройти
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dep-pinned
  namespace: test-disallow-latest
  labels:
    test.case: positive
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dep-pinned
  template:
    metadata:
      labels:
        app: dep-pinned
    spec:
      initContainers:
        - name: init
          image: busybox:1.36.1
          command: ["sh","-c","echo init && sleep 1"]
      containers:
        - name: app
          image: nginx:1.25.3
          ports:
            - containerPort: 80
---
# POSITIVE: Job с фиксированным тегом — должен пройти
apiVersion: batch/v1
kind: Job
metadata:
  name: job-pinned
  namespace: test-disallow-latest
  labels:
    test.case: positive
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: worker
          image: alpine:3.20.2
          command: ["sh","-c","echo job && sleep 1"]
---
# POSITIVE: CronJob с фиксированным тегом — должен пройти
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cj-pinned
  namespace: test-disallow-latest
  labels:
    test.case: positive
spec:
  schedule: "*/10 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron
              image: busybox:1.36.1
              command: ["sh","-c","date; exit 0"]
---
# NEUTRAL: Ресурс, к которому политика не применяется (для шума/регрессии)
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-irrelevant
  namespace: test-disallow-latest
  labels:
    test.case: neutral
data:
  note: "This resource is intentionally irrelevant to the disallow-latest-tag policy."
