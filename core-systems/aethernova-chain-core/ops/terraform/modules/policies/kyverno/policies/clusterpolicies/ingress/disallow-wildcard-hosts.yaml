# aethernova-chain-core/ops/terraform/modules/policies/kyverno/policies/clusterpolicies/ingress/disallow-wildcard-hosts.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-wildcard-hosts
  annotations:
    policies.kyverno.io/title: Disallow wildcard hosts in Ingress
    policies.kyverno.io/category: Ingress Governance
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Ingress
    policies.kyverno.io/description: >-
      Kubernetes Ingress начиная с v1.18 допускает wildcard-хосты (например, "*.example.com").
      Данная политика запрещает любые wildcard-хосты как в spec.rules[*].host, так и в spec.tls[*].hosts[*].
    kyverno.io/kyverno-version: "1.6.0+"
    policies.kyverno.io/minversion: "1.6.0"
    kyverno.io/kubernetes-version: "1.23"
  labels:
    app.kubernetes.io/name: kyverno-policies
    app.kubernetes.io/component: ingress-policy
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/managed-by: kyverno
spec:
  # Промышленный режим: блокируем несоответствующие ресурсы.
  validationFailureAction: Enforce
  background: true

  rules:
    # 1) Запрет wildcard в spec.rules[*].host
    - name: disallow-wildcard-in-rules-host
      match:
        any:
          - resources:
              kinds:
                - Ingress
      preconditions:
        all:
          - key: "{{ request.operation || 'BACKGROUND' }}"
            operator: AnyIn
            value: ["CREATE", "UPDATE", "BACKGROUND"]
      validate:
        message: "Ingress.spec.rules[*].host не должен содержать wildcard ('*')."
        foreach:
          - list: "request.object.spec.rules"
            deny:
              conditions:
                any:
                  - key: "{{ contains(element.host, '*') }}"
                    operator: Equals
                    value: true

    # 2) Запрет wildcard в spec.tls[*].hosts[*]
    - name: disallow-wildcard-in-tls-hosts
      match:
        any:
          - resources:
              kinds:
                - Ingress
      preconditions:
        all:
          - key: "{{ request.operation || 'BACKGROUND' }}"
            operator: AnyIn
            value: ["CREATE", "UPDATE", "BACKGROUND"]
      validate:
        message: "Ingress.spec.tls[*].hosts[*] не должен содержать wildcard ('*')."
        foreach:
          - list: "request.object.spec.tls[]"
            foreach:
              - list: "element.hosts[]"
                deny:
                  conditions:
                    any:
                      - key: "{{ contains(element, '*') }}"
                        operator: Equals
                        value: true
