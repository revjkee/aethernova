apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: pod-require-readonly-rootfs
  labels:
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: kyverno-policy
    app.kubernetes.io/name: require-readonly-rootfs
    policy.aethernova.io/tier: restricted
    policy.aethernova.io/domain: pod-security
  annotations:
    policies.kyverno.io/title: Require Read-Only Root Filesystem
    policies.kyverno.io/category: Best Practices, Pod Security
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >
      Validate that all containers (including init and ephemeral) define
      securityContext.readOnlyRootFilesystem=true to reduce write surface.
    policies.kyverno.io/severity: high
    policies.kyverno.io/minversion: 1.6.0
spec:
  validationFailureAction: Enforce   # enforce (deny) on admission
  failurePolicy: Fail                # fail closed on webhook errors
  background: true                   # also validate existing resources
  rules:
    - name: validate-readonly-rootfs
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - kyverno
                - kyverno-admission-controller
                - gatekeeper-system
                - cert-manager
                - istio-system
                - linkerd
                - monitoring
                - logging
                - flux-system
                - velero
                - metallb-system
                - karpenter
      validate:
        message: >
          Root filesystem must be read-only for all containers:
          set securityContext.readOnlyRootFilesystem=true
          in containers, initContainers, and ephemeralContainers.
        pattern:
          spec:
            containers:
              - securityContext:
                  readOnlyRootFilesystem: true
            =(initContainers):
              - securityContext:
                  readOnlyRootFilesystem: true
            =(ephemeralContainers):
              - securityContext:
                  readOnlyRootFilesystem: true
