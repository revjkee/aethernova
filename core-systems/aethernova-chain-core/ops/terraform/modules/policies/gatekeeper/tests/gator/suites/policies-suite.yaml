apiVersion: test.gatekeeper.sh/v1alpha1
kind: Suite

tests:
  - name: required-labels-namespace-dev-deny
    # ConstraintTemplate K8sRequiredLabels. Путь относительный к файлу Suite.
    # Рекомендуется хранить шаблон, взятый из gatekeeper-library, локально.
    # Например, скопированный template из library/general/requiredlabels/template.yaml.
    template: ../../../templates/k8srequiredlabels_template.yaml

    # Инстанс Constraint, созданный ранее: constraints/dev/security/required-labels-namespace-dev.yaml
    constraint: ../../constraints/dev/security/required-labels-namespace-dev.yaml

    cases:
      # Ожидаем отсутствие нарушений при корректной разметке Namespace
      - name: valid-namespace-all-labels-correct
        object: ../objects/namespaces/dev/valid-namespace.yaml
        assertions:
          - violations: no

      # Отсутствует одна или более обязательных меток — ожидаем нарушение
      - name: missing-required-labels
        object: ../objects/namespaces/dev/missing-labels.yaml
        assertions:
          - violations: yes

      # Метки присутствуют, но значения не соответствуют regex — ожидаем нарушение
      - name: wrong-regex-values
        object: ../objects/namespaces/dev/wrong-regex.yaml
        assertions:
          - violations: yes

      # Исключенные системные пространства имен — не должны нарушать политику
      - name: excluded-system-namespace
        object: ../objects/namespaces/system/kube-system.yaml
        assertions:
          - violations: no

      # Namespace вне dev (например, staging) — при match на dev не должен нарушать
      - name: non-dev-namespace-should-not-match
        object: ../objects/namespaces/staging/staging-ns.yaml
        assertions:
          - violations: no

  # Отдельный тест с вариантом Constraint в режиме dryrun:
  # Проверяем, что нарушения репортятся, но gator учитывает семантику enforcementAction.
  - name: required-labels-namespace-dev-dryrun
    template: ../../../templates/k8srequiredlabels_template.yaml
    constraint: ../../constraints/dev/security/required-labels-namespace-dev-dryrun.yaml
    cases:
      - name: invalid-namespace-dryrun
        object: ../objects/namespaces/dev/invalid-dryrun.yaml
        assertions:
          # Нарушения должны присутствовать, но статус выхода gator для dryrun
          # не интерпретируется как "reject" (см. док. про Enforcement Actions).
          # Мы утверждаем только наличие нарушений, без проверки текста сообщений.
          - violations: yes
