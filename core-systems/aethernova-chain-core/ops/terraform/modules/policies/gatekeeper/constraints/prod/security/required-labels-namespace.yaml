apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: required-labels-namespace
  labels:
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.aethernova.io/tier: security
    policy.aethernova.io/env: prod
  annotations:
    description: "Требует обязательные метки на всех Namespace с проверкой форматов (prod)."
spec:
  enforcementAction: deny
  match:
    scope: Cluster
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
    # Исключаем системные пространства имен по стандартной метке имени
    labelSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
            - kube-public
            - kube-node-lease
            - gatekeeper-system
            - local-path-storage
            - cert-manager
            - ingress-nginx
  parameters:
    labels:
      # Стандартная метка имени приложения: RFC-1123 subdomain-safe
      - key: app.kubernetes.io/name
        allowedRegex: "^[a-z0-9]([-a-z0-9]{0,61}[a-z0-9])?$"

      # Владелец (ответственный) — логин/идентификатор команды
      - key: owner
        allowedRegex: "^[a-z][a-z0-9_-]{2,32}$"

      # Среда развертывания — фиксированный перечень
      - key: environment
        allowedRegex: "^(prod|staging|dev)$"

      # Центр затрат — формата FIN-123 или DEPT-12345 и т.п.
      - key: cost-center
        allowedRegex: "^[A-Z]{2,10}-\\d{3,8}$"

      # Классификация данных — фиксированный перечень
      - key: data-classification
        allowedRegex: "^(public|internal|confidential|restricted)$"

      # Команда/продукт (slug) — для группировки ресурсов
      - key: app.kubernetes.io/part-of
        allowedRegex: "^[a-z0-9]([-a-z0-9]{0,61}[a-z0-9])?$"

      # Контур безопасности/критичность — фиксированный перечень
      - key: security-tier
        allowedRegex: "^(tier-1|tier-2|tier-3)$"
