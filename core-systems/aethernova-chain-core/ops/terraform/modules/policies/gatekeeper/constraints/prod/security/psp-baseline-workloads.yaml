# aethernova-chain-core/ops/terraform/modules/policies/gatekeeper/constraints/prod/security/psp-baseline-workloads.yaml

# 1) Запрет привилегированных контейнеров
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPPrivilegedContainer
metadata:
  name: pss-baseline-no-privileged
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: запрет privileged=true."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system

---
# 2) Запрет повышения привилегий (allowPrivilegeEscalation)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPAllowPrivilegeEscalationContainer
metadata:
  name: pss-baseline-no-allow-privilege-escalation
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: containers[].securityContext.allowPrivilegeEscalation=false."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system

---
# 3) Запрет hostPID/hostIPC (host namespaces)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPHostNamespace
metadata:
  name: pss-baseline-no-host-namespaces
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: запрет spec.hostPID/hostIPC."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system

---
# 4) HostNetwork/hostPorts: запрет использования hostNetwork и любых hostPort
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPHostNetworkingPorts
metadata:
  name: pss-baseline-no-host-network-ports
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: spec.hostNetwork=false; hostPorts запрещены."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system
  parameters:
    hostNetwork: false
    # Отсутствие min/max означает блок всех hostPort, если hostNetwork=false (см. шаблон).

---
# 5) Capabilities: запрет добавления дополнительных cap и обязательное DROP NET_RAW
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPCapabilities
metadata:
  name: pss-baseline-capabilities
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: нельзя добавлять cap; необходимо drop=NET_RAW."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system
  parameters:
    allowedCapabilities: []              # запрещаем любое добавление cap
    requiredDropCapabilities: ["NET_RAW"]  # явный drop CAP_NET_RAW

---
# 6) HostPath: запрет любых hostPath (пустой список разрешений блокирует все пути)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPHostFilesystem
metadata:
  name: pss-baseline-no-hostpath
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: запрет volumes[].hostPath."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system
  # parameters отсутствуют => по шаблону запрещены все hostPath

---
# 7) ReadOnlyRootFilesystem: требуем readOnlyRootFilesystem=true
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPReadOnlyRootFilesystem
metadata:
  name: pss-baseline-readonly-rootfs
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: containers[].securityContext.readOnlyRootFilesystem=true."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system

---
# 8) Seccomp v2: разрешаем только RuntimeDefault и локальные профили из списка
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPSeccompV2
metadata:
  name: pss-baseline-seccomp
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: seccomp только RuntimeDefault или из разрешённого списка Localhost/*."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system
  parameters:
    allowedProfiles:
      - RuntimeDefault
      - Localhost
    allowedLocalhostFiles:
      - "*"   # при необходимости сузьте до конкретных профилей, например: 'profiles/aethernova-default.json'

---
# 9) ProcMount: запрещаем Unmasked, разрешён только Default
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPProcMount
metadata:
  name: pss-baseline-proc-mount
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.kubernetes.io/category: pss-baseline
  annotations:
    description: "PSS Baseline: containers[].securityContext.procMount=Default."
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - istio-system
  parameters:
    allowedProcMountTypes:
      - Default
