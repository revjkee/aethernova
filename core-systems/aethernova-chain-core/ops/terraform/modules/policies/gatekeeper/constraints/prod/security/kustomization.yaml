# kustomization.yaml — prod/security (Gatekeeper Constraints, cluster-scoped)
# Документы: https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/
#            https://open-policy-agent.github.io/gatekeeper/website/docs/constrainttemplates/

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Встраивает служебные метаданные о сборке (см. managedByLabel/originAnnotations)
# Проверяемо: CloudBees / buildmetadata; учебные материалы по Kustomize.
buildMetadata:
  - managedByLabel
  - originAnnotations

# Единые метки для всех Constraint-ресурсов (управление, трассировка и аудит).
labels:
  - includeTemplates: true
    pairs:
      app.kubernetes.io/managed-by: kustomize
      app.kubernetes.io/part-of: aethernova-chain-core
      policy.aethernova.io/tier: prod
      policy.aethernova.io/domain: security
      gatekeeper.sh/constraint: "true"

# Общие аннотации: версия политики/релиза, владелец, SLA.
commonAnnotations:
  policy.aethernova.io/release: "2025-09-11"
  policy.aethernova.io/owner: "platform-security-core"
  policy.aethernova.io/sla: "enforce"

# Констрейнты перечислены явно (Kustomize не поддерживает glob по умолчанию).
# Каждый файл ниже — объект вида constraints.gatekeeper.sh/* (v1/v1beta1),
# например K8sRequiredLabels, K8sPSP* или кастомные Constraint из ваших Template'ов.
# Имена файлов даны как канонические примеры; оставьте/переименуйте под ваши фактические пути.
resources:
  - disallow-privileged.yaml                # Запрет privileged-контейнеров
  - disallow-host-namespaces.yaml           # Запрет hostPID/hostIPC/hostNetwork
  - restrict-hostpath.yaml                  # Ограничение hostPath-монтов
  - restrict-capabilities.yaml              # Ограничение Linux capabilities
  - enforce-readonly-rootfs.yaml            # ReadOnlyRootFilesystem=true
  - require-requests-limits.yaml            # Обязательные ресурсы/лимиты
  - block-latest-tag.yaml                   # Запрет незакреплённых image tags
  - allowed-registries.yaml                 # Белый список реестров
  - restrict-nodeports.yaml                 # Запрет/ограничение NodePort
  - required-labels.yaml                    # Обязательные метки соответствия
  - image-digest-pinned.yaml                # Требование image by digest (sha256)
  - deny-escalating-plugins.yaml            # Запрет опасных Admission/PSP-плагинов (если применимо)
  - seccomp-profile-required.yaml           # Обязательный seccompProfile
  - selinux-options-restricted.yaml         # Ограничения seLinuxOptions
  - apparmor-profile-required.yaml          # Обязательный AppArmor (в поддерживаемых кластерах)

# Опции генераторов (если когда-либо добавите генераторы) — стабильные имена без хэшей.
generatorOptions:
  disableNameSuffixHash: true

# Примечание:
# 1) Все перечисленные YAML-файлы должны находиться в текущей директории
#    aethernova-chain-core/ops/terraform/modules/policies/gatekeeper/constraints/prod/security/
#    и содержать валидные объекты constraints.gatekeeper.sh (Constraint),
#    инстанцирующие ранее установленные ConstraintTemplate.
# 2) Не задавайте namespace: констрейнты Gatekeeper — cluster-scoped.
