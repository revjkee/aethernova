apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Префикс для удобной идентификации dev-ресурсов (cluster-scoped, но в метаданных это полезно)
namePrefix: dev-

# Единые метки для трассировки и аудита
commonLabels:
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: gatekeeper-constraints
  app.kubernetes.io/managed-by: kustomize
  app.kubernetes.io/version: "v1"
  env: dev

# Единые аннотации для соответствия внутренним требованиям платформы
commonAnnotations:
  ae.aethernova.io/owner: "platform-security"
  ae.aethernova.io/module: "policies/gatekeeper"
  ae.aethernova.io/tier: "baseline"
  ae.aethernova.io/lastReview: "2025-09-12"

# Источники ресурсов:
# 1) локальные YAML-файлы с констрейнтами в текущем каталоге (например, k8srequiredlabels.yaml и т.п.)
# При наличии каталога ../base можно добавить строку '- ../base'
resources:
  - ./

# В dev все констрейнты переводим в режим dryrun, чтобы не блокировать изменения,
# но видеть нарушения в виде Audit events и Gatekeeper Violations.
# Патчи применяются к распространённым видам констрейнтов (если вида нет — патч просто не к чему применить).
patchesJson6902:
  # Требуем обязательные метки
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sRequiredLabels
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Разрешённые реестры образов
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sAllowedRepos
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Уникальные хосты Ingress
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sUniqueIngressHost
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Лимиты контейнеров
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sContainerLimits
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Запрет привилегированных контейнеров
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sPSPPrivilegedContainer
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Запрет wildcard в ролях
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sProhibitRoleWildcard
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

  # Обязательные probes
  - target:
      group: constraints.gatekeeper.sh
      version: v1beta1
      kind: K8sRequiredProbes
    patch: |-
      - op: add
        path: /spec/enforcementAction
        value: dryrun

# Опции генераторов на будущее (если будете добавлять configMapGenerator/secretGenerator)
generatorOptions:
  disableNameSuffixHash: false

# Стабильная сортировка для детерминированных планов/диффов
sortOptions:
  order: fifo
