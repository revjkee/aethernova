# aethernova-chain-core/ops/terraform/modules/policies/gatekeeper/constraints/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ВНИМАНИЕ: namespace не задаём, т.к. Gatekeeper Constraints — кластерные ресурсы.
# Подтверждение: Gatekeeper использует ConstraintTemplates и их инстансы (Constraints) для валидации; это CR'ы кластерного уровня. См. оф. доки. 

resources:
  # Укажите здесь конкретные файлы констрейнтов prod-окружения.
  # Имена приведены как типовые для библиотеки политик; при необходимости скорректируйте под ваши файлы.
  - k8srequiredlabels.yaml
  - k8srequiredannotations.yaml
  - k8sdisallowlatesttag.yaml
  - k8srequireprobes.yaml
  - k8sblockprivilegedcontainers.yaml
  - k8srestricthostnamespaces.yaml
  - k8srestricthostpath.yaml
  - k8srestricthostports.yaml
  - k8sforbidnodeports.yaml
  - k8srestrictseccomp.yaml
  - k8srestrictcapabilities.yaml
  - k8srequiredpdb.yaml

# Единые аннотации для трассируемости
commonAnnotations:
  aethernova.io/owner: "platform-security"
  aethernova.io/purpose: "gatekeeper-constraints-prod"
  aethernova.io/source-repo: "aethernova-chain-core"
  aethernova.io/last-review: "2025-09-11"

# Применяем метки через labelTransformer, чтобы не менять селекторы/Match'и.
# Это безопаснее, чем commonLabels для объектов, где есть селекторы. Для Constraints селекторов обычно нет,
# но данный способ индустриально нейтрален.
transformers:
  - ./_labels.transformer.yaml

# Настройки форматирования и генераторов (по необходимости можно расширить)
generatorOptions:
  disableNameSuffixHash: true

# (Опционально) можем зафиксировать порядок трансформеров при сложных пайплайнах.
# patchesStrategicMerge/patchesJson6902 не используются здесь, но при добавлении помните об их порядке.
# Документация об очередности патчей доступна в обсуждении kubernetes-sigs/kustomize#4557.

---

# Локальный labelTransformer: применяет единые метки ко всем ресурсам,
# не изменяя селекторы (includeSelectors: false).
apiVersion: builtin
kind: LabelTransformer
metadata:
  name: gatekeeper-constraints-prod-labels
labels:
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: gatekeeper-constraints
  app.kubernetes.io/managed-by: kustomize
  env: prod
fieldSpecs:
  - path: metadata/labels
    create: true
    # Важно: селекторы не трогаем
    # includeSelectors=false — поведение по умолчанию у LabelTransformer builtin
