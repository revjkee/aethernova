apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: required-labels-namespace-dev
  labels:
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: policy
    app.kubernetes.io/name: gatekeeper-required-labels
    policy.aethernova.io/tier: security
    policy.aethernova.io/domain: namespaces
    policy.aethernova.io/environment: dev
  annotations:
    policy.aethernova.io/summary: "Namespaces в dev обязаны иметь полный набор меток согласно стандарту Aethernova."
    policy.aethernova.io/owner: "platform-security-core"
    policy.aethernova.io/severity: "high"
    policy.aethernova.io/version: "1.0.0"
    policy.aethernova.io/last-reviewed: "2025-09-12"
spec:
  enforcementAction: deny  # варианты: deny | dryrun | warn (при поддержке версии Gatekeeper)
  match:
    # Целимся только в объекты Namespace
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
    # Исключаем системные и служебные неймспейсы
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
      - cert-manager
      - ingress-nginx
      - istio-system
      - linkerd
      - monitoring
      - logging
      - flux-system
      - velero
      - metallb-system
      - karpenter
  parameters:
    labels:
      # Окружение — фиксировано dev
      - key: environment
        allowedRegex: "^(dev)$"
        message: "Метка 'environment' обязательна и должна быть 'dev' для всех Namespace в dev-кластере."
      # Владелец (команда/ответственный)
      - key: owner
        allowedRegex: "^[a-z0-9]([a-z0-9-_]{1,61}[a-z0-9])?$"
        message: "Метка 'owner' обязательна: используйте слаг команды (допустимы: a-z, 0-9, '-', '_')."
      # Бизнес-единица
      - key: business-unit
        allowedRegex: "^[a-z][a-z0-9-]{1,62}[a-z0-9]$"
        message: "Метка 'business-unit' обязательна: например 'core-platform' или 'payments'."
      # Приложение
      - key: application
        allowedRegex: "^[a-z0-9]([-a-z0-9]{0,62})$"
        message: "Метка 'application' обязательна: короткий слаг приложения (до 63 символов)."
      # Контакт (email распределённой группы)
      - key: contact
        allowedRegex: "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,63}$"
        message: "Метка 'contact' обязательна: укажите рабочий e-mail ответственной группы."
      # Репозиторий (URL без пробелов)
      - key: repo
        allowedRegex: "^(https?|ssh)://[^\\s]+$|^[\\w.-]+/[\\w.-]+$"
        message: "Метка 'repo' обязательна: URL Git или 'org/repo'."
      # Центр затрат
      - key: cost-center
        allowedRegex: "^CC-[A-Z]{2}[0-9]{4}$"
        message: "Метка 'cost-center' обязательна: формат 'CC-XX9999' (пример: CC-PL1234)."
      # Классификация данных
      - key: data-classification
        allowedRegex: "^(public|internal|confidential|restricted)$"
        message: "Метка 'data-classification' обязательна: public|internal|confidential|restricted."
      # Политика бэкапа
      - key: backup-policy
        allowedRegex: "^(none|daily|weekly|monthly)$"
        message: "Метка 'backup-policy' обязательна: none|daily|weekly|monthly."
      # Политика хранения
      - key: retention
        allowedRegex: "^(7d|14d|30d|90d|180d|365d)$"
        message: "Метка 'retention' обязательна: 7d|14d|30d|90d|180d|365d."
      # Уровень безопасности
      - key: security-tier
        allowedRegex: "^(low|medium|high|critical)$"
        message: "Метка 'security-tier' обязательна: low|medium|high|critical."
      # Управляемая системой метка
      - key: managed-by
        allowedRegex: "^(aethernova|platform|terraform|argo|flux)$"
        message: "Метка 'managed-by' обязательна: aethernova|platform|terraform|argo|flux."
      # Соответствие требованиям (пример: pci/non-pci)
      - key: compliance
        allowedRegex: "^(none|pci|sox|hipaa|gdpr)$"
        message: "Метка 'compliance' обязательна: none|pci|sox|hipaa|gdpr."
    # Кастомное сообщение при отсутствии любой из обязательных меток
    message: "Namespace не соответствует стандарту маркировки Aethernova (dev): добавьте обязательные метки и повторите попытку."
