apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Приводим все объекты к системному неймспейсу Gatekeeper
namespace: gatekeeper-system

# Единые метки для трассировки и поиска
commonLabels:
  app.kubernetes.io/name: gatekeeper-config
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: policies
  policy.openpolicyagent.org/engine: gatekeeper

# Аннотации для операционного аудита
commonAnnotations:
  audit.aethernova.io/owner: platform-security-core
  audit.aethernova.io/purpose: "Gatekeeper system config: exceptions/audit/sync"
  audit.aethernova.io/change-control: "terraform-managed"

# Базовые ресурсы конфигурации Gatekeeper:
# 1) Исключения: глобальные исключения по процессам (webhook/audit/sync/mutation-webhook)
# 2) Синхронизация: включение syncOnly (Config) для необходимых GVK
# 3) SyncSet (v3.15+): альтернативный/дополняющий механизм синхронизации
resources:
  - 01-config-exemptions.yaml     # apiVersion: config.gatekeeper.sh/v1alpha1, kind: Config (match/processes + excludedNamespaces)
  - 02-config-sync.yaml           # apiVersion: config.gatekeeper.sh/v1alpha1, kind: Config (spec.sync.syncOnly)
  - 03-syncset-core.yaml          # apiVersion: syncset.gatekeeper.sh/v1alpha1, kind: SyncSet (v3.15+)

# Генерация конфигов не требуется, но оставляем задел на будущее
generatorOptions:
  disableNameSuffixHash: true

# Строгая проверка целостности
# Если один из ресурсов отсутствует — сборка упадет, что предотвращает дрейф конфигурации
# (Поддерживается kubectl kustomize >= 1.21+kustomize/v4)
apiWarnings: true
