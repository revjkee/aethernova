apiVersion: mutations.gatekeeper.sh/v1
kind: Assign
metadata:
  name: add-seccomp-runtime-default-to-containers
  labels:
    app.kubernetes.io/name: gatekeeper-seccomp
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.aethernova.io/category: security
    policy.aethernova.io/hardening: "true"
  annotations:
    policy.aethernova.io/description: >
      Ensure all Pod containers have securityContext.seccompProfile.type=RuntimeDefault
      unless already set. Aligned with Kubernetes recommendation to set seccomp
      via securityContext.seccompProfile.
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - gatekeeper-system
      - kube-public
  # Mutate each container's seccompProfile.type if not present
  location: "spec.containers[name:*].securityContext.seccompProfile.type"
  parameters:
    # Do not override if the field already exists
    pathTests:
      - subPath: "spec.containers[name:*].securityContext.seccompProfile.type"
        condition: MustNotExist
      # Ensure parent paths exist (Pod spec and container securityContext)
      - subPath: "spec.containers[name:*].securityContext"
        condition: MustExist
    assign:
      value: "RuntimeDefault"
---
apiVersion: mutations.gatekeeper.sh/v1
kind: Assign
metadata:
  name: add-seccomp-runtime-default-to-initcontainers
  labels:
    app.kubernetes.io/name: gatekeeper-seccomp
    app.kubernetes.io/part-of: aethernova-chain-core
    policy.aethernova.io/category: security
    policy.aethernova.io/hardening: "true"
  annotations:
    policy.aethernova.io/description: >
      Ensure all Pod initContainers have securityContext.seccompProfile.type=RuntimeDefault
      unless already set.
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - kube-system
      - gatekeeper-system
      - kube-public
  # Mutate each initContainer's seccompProfile.type if not present
  location: "spec.initContainers[name:*].securityContext.seccompProfile.type"
  parameters:
    pathTests:
      - subPath: "spec.initContainers[name:*].securityContext.seccompProfile.type"
        condition: MustNotExist
      - subPath: "spec.initContainers[name:*].securityContext"
        condition: MustExist
    assign:
      value: "RuntimeDefault"
