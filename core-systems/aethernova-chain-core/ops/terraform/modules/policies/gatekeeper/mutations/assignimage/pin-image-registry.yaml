apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: AssignImage
metadata:
  name: pin-image-registry-containers
  annotations:
    mutation.gatekeeper.sh/description: "Pin container images to the approved registry for all Pods (containers)."
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
    # Исключаем системные неймспейсы и сам Gatekeeper
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
  # Все обычные контейнеры Pod
  location: "spec.containers[name:*].image"
  parameters:
    # Укажите ваш утвержденный реестр
    assignDomain: "registry.aethernova.local"
    # Только домен; путь/тег останутся исходными (см. AssignImage: domain/path/tag компоненты).
    # Источник синтаксиса AssignImage: Gatekeeper Mutation docs и пример Deckhouse.
    # refs: https://open-policy-agent.github.io/gatekeeper/website/docs/mutation , Deckhouse AssignImage
---
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: AssignImage
metadata:
  name: pin-image-registry-initcontainers
  annotations:
    mutation.gatekeeper.sh/description: "Pin container images to the approved registry for all Pods (initContainers)."
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
  # initContainers в Pod
  location: "spec.initContainers[name:*].image"
  parameters:
    assignDomain: "registry.aethernova.local"
---
apiVersion: mutations.gatekeeper.sh/v1alpha1
kind: AssignImage
metadata:
  name: pin-image-registry-ephemeralcontainers
  annotations:
    mutation.gatekeeper.sh/description: "Pin container images to the approved registry for all Pods (ephemeralContainers)."
spec:
  applyTo:
    - groups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  match:
    scope: Namespaced
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - gatekeeper-system
  # ephemeralContainers в Pod (debug и т.п.)
  location: "spec.ephemeralContainers[name:*].image"
  parameters:
    assignDomain: "registry.aethernova.local"
