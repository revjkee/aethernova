apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ВАЖНО: не задаём namespace — мутирующие CR Gatekeeper кластерного уровня.
# См. обсуждение поведения Kustomize с cluster-scoped ресурсами. 
# Источник: https://github.com/kubernetes-sigs/kustomize/issues/552

# Единые метки для удобства поиска/аудита и SRE-эксплуатации.
commonLabels:
  app.kubernetes.io/part-of: aethernova-chain-core
  app.kubernetes.io/component: gatekeeper-mutations
  app.kubernetes.io/managed-by: kustomize
  gatekeeper.sh/system: "true"

# Общие аннотации: аудит-след, версия и источник — заполняются вашим CI.
commonAnnotations:
  audit.aethernova.io/owner: "platform-security-core"
  audit.aethernova.io/source: "gitops"
  audit.aethernova.io/reviewed-by: "security-cab"
  audit.aethernova.io/change-ticket: "TICKET-XXXX"
  audit.aethernova.io/purpose: "OPA Gatekeeper mutation policies"
  app.aethernova.io/module: "policies/gatekeeper/mutations"

# Ресурсы разложены по типам мутаций:
# - Assign: изменения вне metadata
# - AssignMetadata: изменения только в metadata
# - ModifySet: операции над неключевыми списками
# - AssignImage: манипуляции с образами контейнеров
# Источники по типам: 
# - https://open-policy-agent.github.io/gatekeeper/website/docs/mutation
# - https://jsonnet-libs.github.io/gatekeeper-libsonnet/3.12/mutations/v1/modifySet/
# - https://github.com/open-policy-agent/gatekeeper/issues/3175 (AssignImage)
resources:
  - ./assign/
  - ./assignmetadata/
  - ./modifyset/
  - ./assignimage/

# Опционально можно добавлять патчи/реплейсменты в будущих ревизиях,
# но в базовой промышленной сборке для CR Gatekeeper это не требуется.
# patches: []
# replacements: []
