apiVersion: mutations.gatekeeper.sh/v1
kind: AssignMetadata
metadata:
  name: add-namespace-owner-label
  labels:
    app.kubernetes.io/name: gatekeeper-assignmetadata
    app.kubernetes.io/part-of: aethernova-chain-core
    app.kubernetes.io/component: policy
    app.kubernetes.io/managed-by: gatekeeper
  annotations:
    description: "Add default owner label to Namespaces if missing"
spec:
  # Явно задаём целевые G/V/K для мутации (Namespace — кластерный ресурс v1).
  applyTo:
    - groups: [""]
      kinds: ["Namespace"]
      versions: ["v1"]

  # Область применения: все объекты kind Namespace.
  match:
    scope: Cluster
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
    # Опциональный опт-аут: если на Namespace установлен этот лейбл, мутация не будет применяться.
    labelSelector:
      matchExpressions:
        - key: "aethernova.io/owner-skip"
          operator: DoesNotExist

  # Важное: ключ со слэшем адресуется через кавычки.
  # Альтернатива: metadata.labels.aethernova.io~1namespace-owner
  location: 'metadata.labels."aethernova.io/namespace-owner"'

  parameters:
    assign:
      # Дефолтное значение владельца; измените при необходимости через новый манифест.
      value: "unassigned"

    # Защита от перезаписи: если лейбл уже есть, мутация не применяется.
    pathTests:
      - subPath: 'metadata.labels."aethernova.io/namespace-owner"'
        condition: MustNotExist
