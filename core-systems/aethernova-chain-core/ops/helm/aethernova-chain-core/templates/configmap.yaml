{{- /*
Aethernova Chain Core â€” ConfigMap (industrial-grade)
- Renders rpc.toml from .Values.config.rpcToml via tpl, or falls back to embedded file configs/rpc.toml.
- Supports arbitrary extra config files via .Values.config.extraFiles (map[name: content]).
- Adds checksum/config annotation to trigger rollout on config changes.
*/ -}}

{{- /* helper: full name fallback if helpers.tpl not present */ -}}
{{- define "aethernova-chain-core.fullname" -}}
{{- if .Chart.Name -}}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- .Release.Name -}}
{{- end -}}
{{- end -}}

{{- /* helper: common labels */ -}}
{{- define "aethernova-chain-core.labels" -}}
app.kubernetes.io/name: {{ include "aethernova-chain-core.fullname" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/managed-by: Helm
app.kubernetes.io/part-of: aethernova-chain-core
app.kubernetes.io/version: {{ .Chart.Version | quote }}
helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
{{- if .Values.commonLabels }}
{{ toYaml .Values.commonLabels | trim }}
{{- end }}
{{- end -}}

{{- /* helper: resolve rpc.toml content */ -}}
{{- define "aethernova-chain-core.config.rpcToml" -}}
{{- if .Values.config.rpcToml -}}
{{- tpl .Values.config.rpcToml . -}}
{{- else if (.Files.Get "configs/rpc.toml") -}}
{{- .Files.Get "configs/rpc.toml" -}}
{{- else -}}
# default rpc.toml (minimal fallback)
[default.meta]
name = "aethernova-chain-core"
component = "rpc"
version = "1.0.0"
profile = "base"
{{- end -}}
{{- end -}}

{{- /* helper: render extra files (map: filename -> content) */ -}}
{{- define "aethernova-chain-core.config.extraFiles" -}}
{{- $ctx := . -}}
{{- if $ctx.Values.config.extraFiles }}
{{- range $fname, $fcontent := $ctx.Values.config.extraFiles }}
{{ $fname }}: |-
{{ tpl $fcontent $ctx | nindent 2 }}
{{- end }}
{{- end }}
{{- end -}}

{{- /* helper: combined content for checksum */ -}}
{{- define "aethernova-chain-core.config.checksumPayload" -}}
{{ include "aethernova-chain-core.config.rpcToml" . }}
{{- if .Values.config.extraFiles }}
{{ toYaml .Values.config.extraFiles }}
{{- end }}
{{- end -}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aethernova-chain-core.fullname" . }}-config
  namespace: {{ .Values.namespace | default .Release.Namespace | quote }}
  labels:
{{ include "aethernova-chain-core.labels" . | nindent 4 }}
  annotations:
    # Triggers rollout on config changes
    checksum/config: {{ include "aethernova-chain-core.config.checksumPayload" . | sha256sum }}
    # Optional: integrate with reloader if used
    # reloader.stakater.com/match: "true"
data:
  rpc.toml: |-
{{ include "aethernova-chain-core.config.rpcToml" . | nindent 4 }}
{{ include "aethernova-chain-core.config.extraFiles" . | nindent 2 }}
