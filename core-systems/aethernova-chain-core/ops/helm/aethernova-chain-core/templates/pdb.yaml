{{- /*
  File: ops/helm/aethernova-chain-core/templates/pdb.yaml
  Purpose: Industrial-grade PodDisruptionBudget template for aethernova-chain-core
*/ -}}
{{- if .Values.pdb.enabled }}

{{- /* Detect available API version for PDB */ -}}
{{- $pdbApiVersion := "policy/v1" -}}
{{- if not (.Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget") -}}
{{- if .Capabilities.APIVersions.Has "policy/v1beta1/PodDisruptionBudget" -}}
{{- $pdbApiVersion = "policy/v1beta1" -}}
{{- end -}}
{{- end -}}

apiVersion: {{ $pdbApiVersion }}
kind: PodDisruptionBudget
metadata:
  name: {{ include "aethernova-chain-core.fullname" . }}-pdb
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "aethernova-chain-core.labels" . | nindent 4 }}
    {{- with .Values.pdb.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.pdb.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- /*
    Exactly one of minAvailable or maxUnavailable must be set.
    Prefer maxUnavailable from values if provided; otherwise fallback to minAvailable.
  */ -}}
  {{- if hasKey .Values.pdb "maxUnavailable" }}
  {{- if .Values.pdb.maxUnavailable }}
  maxUnavailable: {{ .Values.pdb.maxUnavailable }}
  {{- end }}
  {{- else if hasKey .Values.pdb "minAvailable" }}
  {{- if .Values.pdb.minAvailable }}
  minAvailable: {{ .Values.pdb.minAvailable }}
  {{- end }}
  {{- else }}
  # Default safeguard: allow 1 pod to be disrupted if not explicitly configured
  maxUnavailable: 1
  {{- end }}

  selector:
    {{- /* Combine standard selector labels with user-provided matchLabels */ -}}
    matchLabels:
      {{- include "aethernova-chain-core.selectorLabels" . | nindent 6 }}
      {{- with .Values.pdb.matchLabels }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
    {{- with .Values.pdb.matchExpressions }}
    matchExpressions:
      {{- toYaml . | nindent 6 }}
    {{- end }}

  {{- /*
    unhealthyPodEvictionPolicy is available in policy/v1. Only render when using v1 and value is provided.
    Acceptable values (as of Kubernetes >=1.26): IfHealthyBudget, AlwaysAllow
  */ -}}
  {{- if and (eq $pdbApiVersion "policy/v1") .Values.pdb.unhealthyPodEvictionPolicy }}
  unhealthyPodEvictionPolicy: {{ .Values.pdb.unhealthyPodEvictionPolicy }}
  {{- end }}

{{- end }}
