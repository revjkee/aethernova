{{- /*
ServiceAccount для узла Aethernova Chain Core.
Особенности:
- Включение через .Values.serviceAccount.create
- Конфигурируемое имя и аннотации
- Поддержка Workload Identity:
  * GKE: iam.gke.io/gcp-service-account
  * EKS (IRSA): eks.amazonaws.com/role-arn
  * Azure Workload Identity: azure.workload.identity/client-id
- Опциональные imagePullSecrets
- Безопасность: automountServiceAccountToken по умолчанию false (меняется через values)

Зависимости от values (пример):
serviceAccount:
  create: true
  name: ""
  annotations: {}
  automount: false
  imagePullSecrets: []
workloadIdentity:
  gcp:
    enabled: false
    serviceAccount: "aethernova-node@project.iam.gserviceaccount.com"
  aws:
    enabled: false
    roleArn: "arn:aws:iam::123456789012:role/aethernova-node-irsa"
  azure:
    enabled: false
    clientId: "00000000-0000-0000-0000-000000000000"
*/ -}}
{{- if .Values.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ default (printf "%s-sa" .Release.Name) .Values.serviceAccount.name | quote }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ default "aethernova-chain-core" .Chart.Name | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | default .Chart.Version | quote }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/part-of: "aethernova-network"
    helm.sh/chart: {{ printf "%s-%s" .Chart.Name .Chart.Version | quote }}
  annotations:
    {{- /* Пользовательские аннотации */}}
    {{- with .Values.serviceAccount.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- /* GKE Workload Identity */}}
    {{- if .Values.workloadIdentity.gcp.enabled }}
    iam.gke.io/gcp-service-account: {{ required "workloadIdentity.gcp.serviceAccount is required when GCP WI enabled" .Values.workloadIdentity.gcp.serviceAccount | quote }}
    {{- end }}
    {{- /* AWS EKS IRSA */}}
    {{- if .Values.workloadIdentity.aws.enabled }}
    eks.amazonaws.com/role-arn: {{ required "workloadIdentity.aws.roleArn is required when AWS IRSA enabled" .Values.workloadIdentity.aws.roleArn | quote }}
    {{- end }}
    {{- /* Azure Workload Identity */}}
    {{- if .Values.workloadIdentity.azure.enabled }}
    azure.workload.identity/client-id: {{ required "workloadIdentity.azure.clientId is required when Azure WI enabled" .Values.workloadIdentity.azure.clientId | quote }}
    {{- end }}
automountServiceAccountToken: {{- if hasKey .Values.serviceAccount "automount" -}}{{ .Values.serviceAccount.automount | default false }}{{- else -}}false{{- end }}
{{- /* imagePullSecrets (список именных секретов) */}}
{{- with .Values.serviceAccount.imagePullSecrets }}
imagePullSecrets:
  {{- range . }}
  - name: {{ . | quote }}
  {{- end }}
{{- end }}
{{- end }}
