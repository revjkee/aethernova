{{-/*
Service (core/v1) — промышленный шаблон
Зависимости от values:
  .Values.service.enabled                      (bool)
  .Values.service.type                         (ClusterIP|NodePort|LoadBalancer|ExternalName)
  .Values.service.headless                     (bool) -> clusterIP: None
  .Values.service.clusterIP                    (string, optional)
  .Values.service.loadBalancerIP               (string, optional)
  .Values.service.loadBalancerClass            (string, optional)
  .Values.service.loadBalancerSourceRanges     ([string], optional)
  .Values.service.externalTrafficPolicy        (Cluster|Local, for LB/NodePort)
  .Values.service.internalTrafficPolicy        (Cluster|Local, for ClusterIP)
  .Values.service.sessionAffinity              (None|ClientIP)
  .Values.service.sessionAffinityConfig        (map, optional)
  .Values.service.ipFamilyPolicy               (SingleStack|PreferDualStack|RequireDualStack)
  .Values.service.ipFamilies                   ([IPv4|IPv6], length 1 or 2)
  .Values.service.publishNotReadyAddresses     (bool)
  .Values.service.externalName                 (string, for ExternalName)
  .Values.service.annotations                  (map)
  .Values.service.labels                       (map)
  .Values.service.selector                     (map, overrides default selector; optional)
  .Values.service.ports                        (list):
    - name           (string, required, DNS-1123)
      port           (int, required)
      targetPort     (int|string, optional)
      protocol       (TCP|UDP|SCTP, default TCP)
      appProtocol    (string, optional; e.g. http, grpc, istio.io/http)
      nodePort       (int, optional; only NodePort/LB)
*/ -}}
{{- if .Values.service.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "aethernova-chain-core.fullname" . }}
  labels:
    {{- include "aethernova-chain-core.labels" . | nindent 4 }}
    {{- with .Values.service.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if eq (default "ClusterIP" .Values.service.type) "ExternalName" }}
  type: ExternalName
  externalName: {{ required "service.externalName must be set for type ExternalName" .Values.service.externalName | quote }}
  {{- else }}
  type: {{ default "ClusterIP" .Values.service.type }}
  {{- if .Values.service.headless }}
  clusterIP: None
  {{- else if .Values.service.clusterIP }}
  clusterIP: {{ .Values.service.clusterIP | quote }}
  {{- end }}
  {{- with .Values.service.ipFamilyPolicy }}
  ipFamilyPolicy: {{ . }}
  {{- end }}
  {{- with .Values.service.ipFamilies }}
  ipFamilies:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.service.internalTrafficPolicy }}
  internalTrafficPolicy: {{ . }}
  {{- end }}
  publishNotReadyAddresses: {{ default false .Values.service.publishNotReadyAddresses }}
  {{- with .Values.service.sessionAffinity }}
  sessionAffinity: {{ . }}
  {{- end }}
  {{- with .Values.service.sessionAffinityConfig }}
  sessionAffinityConfig:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- if or (eq .Values.service.type "LoadBalancer") (eq .Values.service.type "NodePort") }}
  {{- with .Values.service.externalTrafficPolicy }}
  externalTrafficPolicy: {{ . }}
  {{- end }}
  {{- end }}
  {{- if eq .Values.service.type "LoadBalancer" }}
  {{- with .Values.service.loadBalancerClass }}
  loadBalancerClass: {{ . | quote }}
  {{- end }}
  {{- with .Values.service.loadBalancerIP }}
  loadBalancerIP: {{ . | quote }}
  {{- end }}
  {{- with .Values.service.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}

  {{- /* selector: используем standard labels, с возможностью override из values */}}
  selector:
    {{- if .Values.service.selector }}
    {{- toYaml .Values.service.selector | nindent 4 }}
    {{- else }}
    {{- include "aethernova-chain-core.selectorLabels" . | nindent 4 }}
    {{- end }}

  ports:
    {{- $svcType := default "ClusterIP" .Values.service.type }}
    {{- range $i, $p := required "service.ports must be provided" .Values.service.ports }}
    - name: {{ required "service.ports[].name is required" $p.name | quote }}
      port: {{ required "service.ports[].port is required" $p.port }}
      {{- with $p.targetPort }}
      targetPort: {{ . }}
      {{- end }}
      protocol: {{ default "TCP" $p.protocol }}
      {{- with $p.appProtocol }}
      appProtocol: {{ . | quote }}
      {{- end }}
      {{- if or (eq $svcType "NodePort") (eq $svcType "LoadBalancer") }}
      {{- with $p.nodePort }}
      nodePort: {{ . }}
      {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
