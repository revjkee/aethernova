{{- /*
Secret: chain-core database URL (staging/prod agnostic)
Best practices:
  - Use stringData (Kubernetes сам перекодирует в data/base64)
  - Fail-fast при отсутствии обязательных значений (required)
  - Экранируйте пароль (urlquery)
  - Имя и метки согласованы с chart/release
*/ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "aethernova-chain-core.fullname" . }}-db
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "aethernova-chain-core.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/part-of: aethernova
    app.kubernetes.io/component: database
  annotations:
    # Удобно для триггера rollout в Deployment через checksum/secret
    # (см. templates/deployment.yaml: spec.template.metadata.annotations.checksum/secret)
    checksum/source: {{- /* изменение values для секрета обновит хеш */ -}}
      {{- printf "%s|%s|%s|%s|%s|%s|%s" (default "" .Values.db.url) (default "" .Values.db.scheme) (default "" .Values.db.host) (toString (default "" .Values.db.port)) (default "" .Values.db.name) (default "" .Values.db.user) (default "" .Values.db.params) | sha256sum }}

type: Opaque
stringData:
  # Единая точка входа для приложения: DB_URL
  # Приоритет 1: .Values.db.url (готовая строка соединения)
  # Приоритет 2: конструирование из компонентов (scheme://user:pass@host:port/name?params)
  DB_URL: |
    {{- $url := "" -}}
    {{- if .Values.db.url }}
      {{- /* Разрешаем шаблоны внутри значения, если нужно подставлять release/namespace и т.п. */ -}}
      {{- $url = tpl .Values.db.url . -}}
    {{- else }}
      {{- $scheme := required "db.scheme is required (e.g. postgresql, postgresql+asyncpg, mysql)" .Values.db.scheme -}}
      {{- $host   := required "db.host is required" .Values.db.host -}}
      {{- $port   := required "db.port is required" .Values.db.port -}}
      {{- $name   := required "db.name is required" .Values.db.name -}}
      {{- $user   := required "db.user is required" .Values.db.user -}}
      {{- $rawpw  := required "db.password is required (set via values or external source)" .Values.db.password -}}
      {{- $pw     := urlquery $rawpw -}}
      {{- $params := default "" .Values.db.params -}}
      {{- if $params }}
        {{- $url = printf "%s://%s:%s@%s:%v/%s?%s" $scheme $user $pw $host $port $name $params -}}
      {{- else }}
        {{- $url = printf "%s://%s:%s@%s:%v/%s"    $scheme $user $pw $host $port $name -}}
      {{- end }}
    {{- end }}
    {{- $url -}}

  # Опционально: разложение для удобства отладки (не используйте в приложении)
  DB_HOST: {{ required "db.host or db.url must provide host" (default .Values.db.host ("" )) | quote }}
  DB_NAME: {{ required "db.name or db.url must provide name" (default .Values.db.name ("" )) | quote }}

---
{{- /*
Опциональный Secret с сырыми компонентами (если приложению нужны по отдельности).
Отключается через values: db.exposeComponents=false
*/ -}}
{{- if .Values.db.exposeComponents }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "aethernova-chain-core.fullname" . }}-db-components
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "aethernova-chain-core.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/part-of: aethernova
    app.kubernetes.io/component: database
type: Opaque
stringData:
  DB_SCHEME:  {{ default "postgresql" .Values.db.scheme | quote }}
  DB_HOST:    {{ required "db.host is required when exposeComponents=true" .Values.db.host | quote }}
  DB_PORT:    {{ toString (default 5432 .Values.db.port) | quote }}
  DB_NAME:    {{ required "db.name is required when exposeComponents=true" .Values.db.name | quote }}
  DB_USER:    {{ required "db.user is required when exposeComponents=true" .Values.db.user | quote }}
  DB_PASSWORD: {{ required "db.password is required when exposeComponents=true" .Values.db.password | quote }}
{{- end }}
