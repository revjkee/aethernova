apiVersion: v1
kind: ConfigMap
metadata:
  name: aethernova-chain-core-config
  namespace: aethernova
  labels:
    app.kubernetes.io/name: aethernova-chain-core
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: aethernova-network
    app.kubernetes.io/managed-by: kustomize
  annotations:
    aethernova.io/schema-version: "1.0"
    aethernova.io/config-purpose: "base-configmap-mounted-as-readonly"
immutable: true
data:
  # -------------------------------------------------------------------
  # node.toml — базовая конфигурация узла; профили включаются флагом
  # --profile=<btc2_finality|parallel_exec|zk_priv_tx> в командной строке.
  # В проде меняется через новый ConfigMap + rollout (immutable=true).
  # -------------------------------------------------------------------
  node.toml: |
    schema_version = "1.0"

    [node]
    name       = "aethernova-node"
    chain_id   = "aethernova-devnet"
    mode       = "validator"         # validator|full|light
    worker_threads = 0               # 0 = auto
    strict_config = true
    data_dir   = "/var/lib/aethernova"
    safe_mode  = true

    [consensus]
    engine = "hotstuff"              # hotstuff|tendermint_like
    committee_size = 64
    proposal_timeout_ms  = 2000
    prevote_timeout_ms   = 2000
    precommit_timeout_ms = 2000
    commit_timeout_ms    = 1000
    max_reorg_depth      = 20
    max_block_bytes      = 4000000
    target_block_time_ms = 2000

    [finality]
    enabled = true
    epoch_length = 10000
    checkpoint_interval = 1000
    light_client_confirmations = 2
    participation_policy = "strict"  # strict|lenient

    [txpool]
    max_txs = 500000
    max_txs_per_sender = 5000
    tx_ttl_seconds = 900
    priority_enabled = true

    [txpool.fee]
    market = "eip1559_like"          # eip1559_like|fixed|hybrid
    min_base_fee = 1
    target_block_utilization = 0.5
    base_fee_change_ppm = 1250
    tips_enabled = true

    [mempool]
    precheck_signatures = true
    max_tx_bytes = 1000000
    dedup = true
    ingress_rate_limit = 200

    [storage]
    backend = "rocksdb"              # rocksdb|kv
    compression = "zstd"
    block_cache_mb = 1024
    state_snapshot_interval = 10000
    state_snapshot_retention = 4
    pruning = "default_heuristic"

    [storage.rocksdb]
    max_background_jobs = 8
    target_file_size_base_mb = 64
    write_buffer_size_mb = 128
    bytes_per_sync_mb = 16

    [state]
    model = "account"                # account|account+utxo
    cache_mb = 512

    [state.accounts]
    dust_threshold = 1000

    [state.staking]
    min_stake = "1000000000"
    unbonding_period = 21600

    [state.utxo]
    enabled = false
    index_depth = 100000

    [vm]
    executor = "serial"              # serial|parallel
    max_parallel_workers = 0
    optimistic_rw_sets = true

    [vm.gas]
    cpu_per_ms        = 10000
    io_read_per_kb    = 1000
    io_write_per_kb   = 2000
    storage_byte_cost = 50
    wasm_max_fuel     = 10000000

    [vm.wasm]
    allow_host_sha256   = true
    allow_host_ed25519  = true
    allow_host_keccak   = true
    allow_host_zk_hostf = true

    [vm.evm]
    enabled = true
    block_gas_limit = 30000000

    [p2p]
    listen_multiaddr = ["/ip4/0.0.0.0/tcp/30333", "/ip6/::/tcp/30333"]
    max_peers = 200
    bootstrap = [
      "/dns/bootstrap-1.aethernova/p2p/12D3KooWExample1",
      "/dns/bootstrap-2.aethernova/p2p/12D3KooWExample2"
    ]
    ingress_rate_limit = 2000
    transport_secure = true
    gossip_topics = ["blocks","txs","finality","checkpoints"]

    [p2p.kademlia]
    enabled = true
    query_parallelism = 3
    probe_interval_ms = 30000

    [p2p.gossip]
    window = 128
    duplicate_cache = 2048
    per_peer_rate_limit = 500

    [rpc]
    http_enabled = true
    http_addr    = "0.0.0.0:8545"
    grpc_enabled = true
    grpc_addr    = "0.0.0.0:50051"
    allowlist = [
      "net_version","eth_chainId","eth_blockNumber","eth_getBlockByNumber",
      "eth_getBlockByHash","eth_getTransactionByHash","eth_getTransactionReceipt",
      "eth_call","eth_estimateGas","eth_gasPrice",
      "aeth_getCheckpoint","aeth_getFinalityStatus"
    ]
    denylist = ["admin_*","debug_*","engine_*","txpool_*"]
    max_conns = 10000
    read_timeout_ms  = 10000
    write_timeout_ms = 10000
    cors = []

    [telemetry]
    metrics_enabled = true
    metrics_addr    = "0.0.0.0:9100"
    tracing_enabled = true
    tracing_endpoint = "otel-collector:4317"
    log_level  = "info"
    log_format = "json"
    trace_sampler_ratio = 0.05

    [security]
    allow_unverified_plugins = false
    hsm_enabled = true
    threshold_signing = true
    social_recovery_enabled = true
    update_policy = "signed_auto"

    [profiles.btc2_finality]
    [profiles.btc2_finality.finality]
    enabled = true
    epoch_length = 20000
    checkpoint_interval = 2000
    light_client_confirmations = 3
    participation_policy = "strict"

    [profiles.btc2_finality.state]
    model = "account+utxo"

    [profiles.btc2_finality.txpool.fee]
    market = "eip1559_like"
    min_base_fee = 5
    target_block_utilization = 0.55
    base_fee_change_ppm = 1500

    [profiles.parallel_exec]
    [profiles.parallel_exec.vm]
    executor = "parallel"
    max_parallel_workers = 0
    optimistic_rw_sets = true
    [profiles.parallel_exec.consensus]
    max_block_bytes = 6000000
    commit_timeout_ms = 800
    target_block_time_ms = 1800
    [profiles.parallel_exec.txpool]
    max_txs = 800000
    max_txs_per_sender = 8000

    [profiles.zk_priv_tx]
    [profiles.zk_priv_tx.vm.wasm]
    allow_host_zk_hostf = true
    [profiles.zk_priv_tx.rpc]
    allowlist = [
      "net_version","eth_chainId","eth_blockNumber","eth_getBlockByNumber",
      "eth_getBlockByHash","eth_getTransactionByHash","eth_getTransactionReceipt",
      "eth_call","eth_estimateGas","eth_gasPrice","aeth_getCheckpoint",
      "aeth_getFinalityStatus","aeth_shield","aeth_unshield",
      "aeth_getNullifier","aeth_getCommitment"
    ]
    [profiles.zk_priv_tx.txpool]
    max_txs = 400000
    tx_ttl_seconds = 600
    priority_enabled = true

    [profiles.parallel_exec_zk]
    inherits = ["parallel_exec", "zk_priv_tx"]

    [profiles.default]
    inherits = []

  # -------------------------------------------------------------------
  # chain.toml — параметры эпох/финальности/halving (read-only для prod)
  # -------------------------------------------------------------------
  chain.toml: |
    [chain]
    chain_id = "aethernova-devnet"
    halving_epochs = [210000, 420000, 630000]
    finality_epoch_length = 10000
    finality_checkpoint_interval = 1000

    [supply]
    total_supply = "2100000000000000" # минимальные единицы

  # -------------------------------------------------------------------
  # p2p.toml — опционально: вынесенные P2P-настройки (перекрывают node.toml)
  # -------------------------------------------------------------------
  p2p.toml: |
    [p2p]
    max_peers = 250
    ingress_rate_limit = 2500
    gossip_topics = ["blocks","txs","finality","checkpoints"]

  # -------------------------------------------------------------------
  # rpc.toml — опционально: белые/черные списки и лимиты RPC
  # -------------------------------------------------------------------
  rpc.toml: |
    [rpc]
    http_enabled = true
    grpc_enabled = true
    max_conns = 12000
    read_timeout_ms = 10000
    write_timeout_ms = 10000
    cors = []

  # -------------------------------------------------------------------
  # telemetry.yaml — конфигурация Otel Collector/экспорты
  # -------------------------------------------------------------------
  telemetry.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:

    processors:
      batch:
        send_batch_size: 8192
        timeout: 5s

    exporters:
      prometheus:
        endpoint: "0.0.0.0:9464"
      otlp:
        endpoint: "tempo:4317"
        tls:
          insecure: true
      loki:
        endpoint: "http://loki:3100/loki/api/v1/push"

    extensions:
      health_check: {}

    service:
      extensions: [health_check]
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [prometheus]
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [otlp]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [loki]
