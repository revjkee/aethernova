# aethernova-chain-core/ops/k8s/overlays/staging/kustomization.yaml
# Staging overlay for Aethernova Chain Core
# Verified features: resources, commonLabels/Annotations, images, replicas,
# configMapGenerator, secretGenerator, patches (strategic & JSON6902), buildMetadata.

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Базовые манифесты (должны существовать в ../../base)
resources:
  - ../../base

# Namespace и унифицированные метки/аннотации для всех ресурсов
namespace: aethernova-staging

namePrefix: chain-core-
nameSuffix: -stg

commonLabels:
  app.kubernetes.io/name: chain-core
  app.kubernetes.io/instance: chain-core-staging
  app.kubernetes.io/part-of: aethernova
  app.kubernetes.io/component: blockchain-core
  app.kubernetes.io/managed-by: kustomize
  environment: staging

commonAnnotations:
  deploy.aethernova.io/environment: staging
  deploy.aethernova.io/owner: platform-ops
  deploy.aethernova.io/change-review: "true"

# Управление образами: переопределяем имя/тег без правки base
images:
  - name: registry.aethernova.dev/chain-core
    newName: registry.aethernova.dev/chain-core
    newTag: v0.1.0-staging

# Реплики (Deployment .spec.replicas) — применяется к объекту из base
# Имя должно совпадать с Deployment.metadata.name в базе (без префиксов/суффиксов)
replicas:
  - name: chain-core
    count: 3

# Генераторы конфигов/секретов (хеш в имени оставляем включенным для безопасного rollout)
generatorOptions:
  disableNameSuffixHash: false
  annotations:
    reload.aethernova.io/strategy: rolling
  labels:
    config-owner: chain-core

# Генерируем ConfigMap из TOML конфига Staging
configMapGenerator:
  - name: chain-core-config
    behavior: merge
    files:
      # Кладём staging.toml как ключ "staging.toml" внутри ConfigMap
      - ../../../../configs/env/staging.toml#staging.toml

# Генерируем Secret-ы из файлов overlay (ожидается наличие файлов)
secretGenerator:
  - name: chain-core-secrets
    type: Opaque
    behavior: merge
    files:
      # Переменные окружения c чувствительными значениями (формат KEY=VAL)
      - secrets/.env.staging
      # Публичный JWT ключ как отдельный ключ в секрете
      - secrets/jwt_staging_pub.pem
    options:
      annotations:
        secret.aethernova.io/scope: application

# Патчи: тонкая настройка ресурсов слоя Staging
patches:
  # Стратегический мердж-патч для Deployment: ресурсы/пробы/узлы
  - path: patches/deployment-resources.yaml
    target:
      kind: Deployment
      name: chain-core
  # Патч JSON6902 для Service: выставить аннотации для балансировщика
  - path: patches/service-lb-annotations.json
    target:
      version: v1
      kind: Service
      name: chain-core
  # Стратегический патч для Ingress (домен стейджинга/CORS)
  - path: patches/ingress-staging.yaml
    target:
      kind: Ingress
      name: chain-core

# Добавляет стандартную метку управления ко всем объектам
buildMetadata:
  - managedByLabel

# Ограничиваем типы ресурсов, которые будут билдиться (опционально строгий режим)
# transformers и validators можно добавить при необходимости
