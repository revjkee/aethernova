{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.org/schemas/cybersecurity-core/jsonschema/v1/edr_action.schema.json",
  "title": "EDR Action Event",
  "description": "Промышленная схема события EDR-действия (запрос/исполнение реакции: изоляция хоста, убийство процесса, карантин файла, блокировка IP/хэша и т. п.).",
  "type": "object",
  "unevaluatedProperties": false,
  "additionalProperties": false,
  "$comment": "Версия схемы v1.0.0. Совместима с системами нормализации событий, SIEM/SOAR, data lake/warehouse.",
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Версия логической схемы события."
    },
    "action_id": {
      "allOf": [
        { "$ref": "#/$defs/uuid" }
      ],
      "description": "Уникальный идентификатор действия (RFC 4122 UUID)."
    },
    "tenant": {
      "type": "string",
      "minLength": 1,
      "description": "Идентификатор арендатора/организации."
    },
    "environment": {
      "type": "string",
      "enum": ["production", "staging", "dev", "test"],
      "description": "Среда выполнения."
    },
    "producer": {
      "$ref": "#/$defs/producer"
    },
    "agent": {
      "$ref": "#/$defs/agent"
    },
    "host": {
      "$ref": "#/$defs/host"
    },
    "os": {
      "$ref": "#/$defs/os"
    },
    "platform": {
      "type": "string",
      "enum": ["endpoint", "server", "workstation", "mobile", "container", "vm", "other"],
      "description": "Платформа целевого объекта."
    },
    "action_type": {
      "$ref": "#/$defs/action_type"
    },
    "status": {
      "$ref": "#/$defs/status"
    },
    "severity": {
      "$ref": "#/$defs/severity"
    },
    "confidence": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Уровень уверенности детектора/оператора (0-100)."
    },
    "reason": {
      "type": "string",
      "minLength": 1,
      "description": "Причина инициирования действия (обоснование, правило, аналитика)."
    },
    "rules_triggered": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "maxItems": 64,
      "description": "Список правил/детектов, инициировавших действие."
    },
    "actor": {
      "$ref": "#/$defs/actor"
    },
    "target": {
      "$ref": "#/$defs/target"
    },
    "indicators": {
      "type": "array",
      "items": { "$ref": "#/$defs/indicator" },
      "maxItems": 128,
      "description": "Индикаторы компрометации/контекста, связанные с действием."
    },
    "artifacts": {
      "type": "array",
      "items": { "$ref": "#/$defs/artifact" },
      "maxItems": 64,
      "description": "Ссылки на артефакты (dump, pcaps, отчеты)."
    },
    "correlation": {
      "$ref": "#/$defs/correlation"
    },
    "trace": {
      "$ref": "#/$defs/trace"
    },
    "requested_at": {
      "$ref": "#/$defs/rfc3339_timestamp"
    },
    "started_at": {
      "$ref": "#/$defs/rfc3339_timestamp"
    },
    "completed_at": {
      "$ref": "#/$defs/rfc3339_timestamp"
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Фактическая длительность выполнения действия в миллисекундах."
    },
    "result": {
      "$ref": "#/$defs/result"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 128 },
      "maxItems": 64,
      "description": "Свободные теги классификации."
    },
    "labels": {
      "type": "object",
      "propertyNames": { "pattern": "^[A-Za-z0-9_.:-]{1,64}$" },
      "additionalProperties": { "type": "string", "maxLength": 256 },
      "maxProperties": 64,
      "description": "Короткие метки-ключи (key->value)."
    }
  },
  "required": [
    "schema_version",
    "action_id",
    "action_type",
    "target",
    "status",
    "requested_at"
  ],
  "allOf": [
    {
      "$comment": "Если указан completed_at, то должен быть указан и started_at.",
      "if": { "required": ["completed_at"] },
      "then": { "required": ["started_at"] }
    },
    {
      "$comment": "Условие для block_hash: должен существовать file с hashes.",
      "if": {
        "properties": { "action_type": { "const": "block_hash" } },
        "required": ["action_type"]
      },
      "then": {
        "properties": {
          "target": {
            "allOf": [
              { "required": ["kind"] },
              {
                "if": { "properties": { "kind": { "const": "file" } } },
                "then": {
                  "required": ["file"],
                  "properties": {
                    "file": {
                      "required": ["hashes"],
                      "properties": {
                        "hashes": { "allOf": [ { "minProperties": 1 } ] }
                      }
                    }
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "$comment": "Условие для kill_process: требуется pid или name.",
      "if": {
        "properties": { "action_type": { "const": "kill_process" } },
        "required": ["action_type"]
      },
      "then": {
        "properties": {
          "target": {
            "allOf": [
              { "required": ["kind"] },
              {
                "if": { "properties": { "kind": { "const": "process" } } },
                "then": {
                  "required": ["process"],
                  "properties": {
                    "process": {
                      "anyOf": [
                        { "required": ["pid"] },
                        { "required": ["name"] }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "$comment": "Условие для isolate_host/unisolate_host: требуется device с hostname или asset_id.",
      "if": {
        "properties": { "action_type": { "enum": ["isolate_host", "unisolate_host"] } },
        "required": ["action_type"]
      },
      "then": {
        "properties": {
          "target": {
            "allOf": [
              { "required": ["kind"] },
              {
                "if": { "properties": { "kind": { "const": "device" } } },
                "then": {
                  "required": ["device"],
                  "properties": {
                    "device": {
                      "anyOf": [
                        { "required": ["asset_id"] },
                        { "required": ["hostname"] }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "$comment": "Условие для block_ip: требуется network_connection с remote_ip или indicator ip.",
      "if": {
        "properties": { "action_type": { "const": "block_ip" } },
        "required": ["action_type"]
      },
      "then": {
        "anyOf": [
          {
            "properties": {
              "target": {
                "allOf": [
                  { "required": ["kind"] },
                  {
                    "if": { "properties": { "kind": { "const": "network_connection" } } },
                    "then": {
                      "required": ["network_connection"],
                      "properties": {
                        "network_connection": {
                          "anyOf": [
                            { "required": ["remote_ip"] },
                            { "required": ["local_ip"] }
                          ]
                        }
                      }
                    }
                  }
                ]
              }
            }
          },
          {
            "properties": {
              "indicators": {
                "type": "array",
                "contains": {
                  "properties": { "type": { "const": "ip" } },
                  "required": ["type", "value"]
                }
              }
            }
          }
        ]
      }
    },
    {
      "$comment": "Условие для quarantine_file/delete_file: требуется file.path или file.hashes.",
      "if": {
        "properties": { "action_type": { "enum": ["quarantine_file", "delete_file"] } },
        "required": ["action_type"]
      },
      "then": {
        "properties": {
          "target": {
            "allOf": [
              { "required": ["kind"] },
              {
                "if": { "properties": { "kind": { "const": "file" } } },
                "then": {
                  "required": ["file"],
                  "properties": {
                    "file": {
                      "anyOf": [
                        { "required": ["path"] },
                        { "required": ["hashes"] }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
      }
    }
  ],
  "examples": [
    {
      "schema_version": "1.0.0",
      "action_id": "8d4f2c5a-9b2c-4d2f-9b5b-2d6c7a3b1b1f",
      "tenant": "acme-corp",
      "environment": "production",
      "producer": { "vendor": "Aethernova", "product": "Cybersecurity-Core", "version": "3.2.1" },
      "agent": { "agent_id": "e2e56c13-8c8a-4d70-8c49-3bd6b7c9e4a0", "version": "7.14.0" },
      "host": {
        "asset_id": "SRV-001122",
        "hostname": "acme-wks-031",
        "fqdn": "acme-wks-031.corp.local",
        "ip_addresses": ["10.10.15.23"],
        "mac_addresses": ["00:1C:42:2B:60:5A"]
      },
      "os": { "name": "windows", "version": "10.0.19045", "architecture": "x64" },
      "platform": "endpoint",
      "action_type": "kill_process",
      "status": "succeeded",
      "severity": { "level": "high", "score": 80 },
      "confidence": 92,
      "reason": "Behavioral rule R-214 matched (suspicious ransomware patterns).",
      "rules_triggered": ["R-214", "ML-Ransom-Score>0.9"],
      "actor": { "type": "system", "name": "Auto-Response", "id": "auto-playbook-9" },
      "target": {
        "kind": "process",
        "process": {
          "pid": 4321,
          "name": "evil.exe",
          "path": "C:\\Users\\Public\\evil.exe",
          "command_line": "evil.exe --encrypt C:\\",
          "user": "ACME\\j.doe",
          "start_time": "2025-09-03T07:58:13Z"
        }
      },
      "indicators": [
        { "type": "hash", "value": "2b7e151628aed2a6abf7158809cf4f3c", "algo": "md5" },
        { "type": "file_path", "value": "C:\\Users\\Public\\evil.exe" }
      ],
      "artifacts": [
        { "type": "report", "uri": "https://vault.aethernova/reports/8d4f2c5a", "mime_type": "application/pdf" }
      ],
      "correlation": {
        "alert_id": "5ac2c2d4-6a41-4a78-bc86-2b0c1f8d7a11",
        "incident_id": "c6c9c1c0-3fdd-4e3d-9a39-0b8a54d8ea12",
        "ticket_id": "SOC-2025-0912"
      },
      "trace": { "trace_id": "9e3a6d2f7b1e4a0fb9b2e7e5a42f3c11", "span_id": "ab12cd34ef56ab78" },
      "requested_at": "2025-09-03T07:58:20Z",
      "started_at": "2025-09-03T07:58:20Z",
      "completed_at": "2025-09-03T07:58:21Z",
      "duration_ms": 860,
      "result": { "code": "ok", "message": "Process terminated" },
      "tags": ["auto-response", "containment"],
      "labels": { "playbook": "ransomware_contain_v2" }
    }
  ],
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$",
      "description": "UUID v1-v5."
    },
    "rfc3339_timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Время в формате RFC 3339 (UTC предпочтительно)."
    },
    "ip": {
      "oneOf": [
        { "type": "string", "format": "ipv4" },
        { "type": "string", "format": "ipv6" }
      ],
      "description": "IPv4/IPv6 адрес."
    },
    "mac": {
      "type": "string",
      "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$",
      "description": "MAC-адрес."
    },
    "hashes": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "md5": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{32}$"
        },
        "sha1": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{40}$"
        },
        "sha256": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{64}$"
        },
        "sha512": {
          "type": "string",
          "pattern": "^[A-Fa-f0-9]{128}$"
        }
      },
      "minProperties": 1,
      "description": "Набор криптографических хэшей файла."
    },
    "url": {
      "type": "string",
      "format": "uri"
    },
    "producer": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "vendor": { "type": "string", "minLength": 1 },
        "product": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 }
      },
      "required": ["vendor", "product", "version"],
      "description": "Источник события/поставщик."
    },
    "agent": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "agent_id": { "$ref": "#/$defs/uuid" },
        "version": { "type": "string", "minLength": 1 }
      },
      "required": ["agent_id"],
      "description": "EDR/endpoint агент, выполнивший действие."
    },
    "host": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "asset_id": { "type": "string", "minLength": 1 },
        "hostname": { "type": "string", "minLength": 1 },
        "fqdn": { "type": "string", "minLength": 1 },
        "ip_addresses": {
          "type": "array",
          "items": { "$ref": "#/$defs/ip" },
          "maxItems": 64
        },
        "mac_addresses": {
          "type": "array",
          "items": { "$ref": "#/$defs/mac" },
          "maxItems": 64
        }
      },
      "description": "Инвентарные сведения о целевом хосте."
    },
    "os": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "enum": ["windows", "linux", "macos", "ios", "android", "other"] },
        "version": { "type": "string", "minLength": 1 },
        "architecture": { "type": "string", "enum": ["x64", "x86", "arm64", "arm", "ppc", "other"] }
      },
      "required": ["name"]
    },
    "action_type": {
      "type": "string",
      "enum": [
        "kill_process",
        "quarantine_file",
        "delete_file",
        "block_hash",
        "block_ip",
        "terminate_network_connection",
        "isolate_host",
        "unisolate_host",
        "scan",
        "suspend_user",
        "disable_network",
        "add_to_blocklist",
        "add_to_allowlist",
        "rollback",
        "alert_only",
        "custom"
      ],
      "description": "Тип выполняемого EDR-действия."
    },
    "status": {
      "type": "string",
      "enum": [
        "requested",
        "queued",
        "in_progress",
        "succeeded",
        "failed",
        "partially_succeeded",
        "canceled",
        "expired"
      ],
      "description": "Статус жизненного цикла действия."
    },
    "severity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "level": { "type": "string", "enum": ["informational", "low", "medium", "high", "critical"] },
        "score": { "type": "integer", "minimum": 0, "maximum": 100 }
      },
      "required": ["level"],
      "description": "Уровень важности действия/инцидента."
    },
    "actor": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["system", "user", "playbook", "rule", "api"] },
        "id": { "type": "string" },
        "name": { "type": "string" },
        "email": { "type": "string", "format": "email" }
      },
      "required": ["type"],
      "description": "Кто инициировал действие."
    },
    "process_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pid": { "type": "integer", "minimum": 0 },
        "ppid": { "type": "integer", "minimum": 0 },
        "name": { "type": "string", "minLength": 1 },
        "path": { "type": "string", "minLength": 1 },
        "command_line": { "type": "string" },
        "user": { "type": "string" },
        "start_time": { "$ref": "#/$defs/rfc3339_timestamp" },
        "hashes": { "$ref": "#/$defs/hashes" }
      }
    },
    "file_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "path": { "type": "string", "minLength": 1 },
        "file_name": { "type": "string", "minLength": 1 },
        "size": { "type": "integer", "minimum": 0 },
        "hashes": { "$ref": "#/$defs/hashes" },
        "created": { "$ref": "#/$defs/rfc3339_timestamp" },
        "modified": { "$ref": "#/$defs/rfc3339_timestamp" },
        "owner": { "type": "string" }
      },
      "oneOf": [
        { "required": ["path"] },
        { "required": ["file_name"] }
      ]
    },
    "registry_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hive": { "type": "string", "enum": ["HKLM", "HKCU", "HKCR", "HKU", "HKCC"] },
        "path": { "type": "string", "minLength": 1 },
        "value_name": { "type": "string" },
        "value_data": { "type": ["string", "number", "boolean", "null"] }
      },
      "required": ["hive", "path"]
    },
    "network_connection_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "direction": { "type": "string", "enum": ["inbound", "outbound", "unknown"] },
        "protocol": { "type": "string", "enum": ["tcp", "udp", "icmp", "other"] },
        "local_ip": { "$ref": "#/$defs/ip" },
        "local_port": { "type": "integer", "minimum": 0, "maximum": 65535 },
        "remote_ip": { "$ref": "#/$defs/ip" },
        "remote_port": { "type": "integer", "minimum": 0, "maximum": 65535 },
        "domain": { "type": "string" }
      }
    },
    "user_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "user_id": { "type": "string" },
        "username": { "type": "string" },
        "domain": { "type": "string" },
        "sid": { "type": "string" }
      },
      "anyOf": [
        { "required": ["username"] },
        { "required": ["user_id"] }
      ]
    },
    "device_obj": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "asset_id": { "type": "string" },
        "hostname": { "type": "string" },
        "fqdn": { "type": "string" },
        "ip_addresses": { "type": "array", "items": { "$ref": "#/$defs/ip" }, "maxItems": 64 },
        "mac_addresses": { "type": "array", "items": { "$ref": "#/$defs/mac" }, "maxItems": 64 }
      }
    },
    "target": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "file" },
            "file": { "$ref": "#/$defs/file_obj" }
          },
          "required": ["kind", "file"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "process" },
            "process": { "$ref": "#/$defs/process_obj" }
          },
          "required": ["kind", "process"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "registry" },
            "registry": { "$ref": "#/$defs/registry_obj" }
          },
          "required": ["kind", "registry"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "network_connection" },
            "network_connection": { "$ref": "#/$defs/network_connection_obj" }
          },
          "required": ["kind", "network_connection"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "user" },
            "user": { "$ref": "#/$defs/user_obj" }
          },
          "required": ["kind", "user"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "kind": { "const": "device" },
            "device": { "$ref": "#/$defs/device_obj" }
          },
          "required": ["kind", "device"]
        }
      ],
      "description": "Цель воздействия EDR-действия."
    },
    "indicator": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "hash" },
            "algo": { "type": "string", "enum": ["md5", "sha1", "sha256", "sha512"] },
            "value": { "type": "string" }
          },
          "required": ["type", "algo", "value"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "ip" },
            "value": { "$ref": "#/$defs/ip" }
          },
          "required": ["type", "value"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "domain" },
            "value": { "type": "string", "minLength": 1 }
          },
          "required": ["type", "value"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "url" },
            "value": { "$ref": "#/$defs/url" }
          },
          "required": ["type", "value"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "file_path" },
            "value": { "type": "string", "minLength": 1 }
          },
          "required": ["type", "value"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "registry_path" },
            "value": { "type": "string", "minLength": 1 }
          },
          "required": ["type", "value"]
        }
      ],
      "description": "Индикатор (IoC/IoA)."
    },
    "artifact": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["dump", "pcap", "report", "log", "other"] },
        "uri": { "$ref": "#/$defs/url" },
        "mime_type": { "type": "string" }
      },
      "required": ["type", "uri"]
    },
    "correlation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "alert_id": { "$ref": "#/$defs/uuid" },
        "incident_id": { "$ref": "#/$defs/uuid" },
        "ticket_id": { "type": "string" }
      }
    },
    "trace": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "trace_id": { "type": "string", "pattern": "^[a-f0-9]{32}$" },
        "span_id": { "type": "string", "pattern": "^[a-f0-9]{16}$" }
      },
      "description": "Опциональная трассировка (OTel совместимо)."
    },
    "result": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "code": { "type": "string", "enum": ["ok", "error", "partial"] },
        "message": { "type": "string" },
        "error": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "error_code": { "type": "string" },
            "error_message": { "type": "string" }
          },
          "required": ["error_message"]
        }
      },
      "required": ["code"]
    }
  }
}
