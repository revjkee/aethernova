{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.dev/schemas/jsonschema/v1/asset.schema.json",
  "title": "Cybersecurity Core Asset",
  "description": "Инвентаризационная запись об ИТ-активе для систем безопасности, инвентаря и соответствия требованиям.",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "required": ["schema_version", "asset_id", "type", "name", "environment", "criticality", "timestamps"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Версия схемы данных.",
      "pattern": "^1\\.\\d+(?:\\.\\d+)?$",
      "default": "1.0.0"
    },
    "asset_id": {
      "type": "string",
      "description": "Глобальный UUID актива (RFC 4122).",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "external_ids": {
      "type": "array",
      "description": "Внешние идентификаторы из CMDB/Cloud/MDM.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["system", "id"],
        "properties": {
          "system": { "type": "string", "minLength": 2, "maxLength": 64 },
          "id": { "type": "string", "minLength": 1, "maxLength": 256 },
          "url": { "type": "string", "format": "uri" }
        }
      }
    },
    "type": {
      "type": "string",
      "description": "Тип актива.",
      "enum": ["host", "container", "serverless", "database", "application", "network_device", "user_account"]
    },
    "name": { "type": "string", "minLength": 1, "maxLength": 255 },
    "description": { "type": "string", "maxLength": 4000 },
    "owner": {
      "type": "object",
      "additionalProperties": false,
      "required": ["group"],
      "properties": {
        "group": { "type": "string", "minLength": 1, "maxLength": 128 },
        "team": { "type": "string", "maxLength": 128 },
        "email": { "type": "string", "format": "email" },
        "service": { "type": "string", "maxLength": 128 }
      }
    },
    "environment": {
      "type": "string",
      "enum": ["dev", "qa", "staging", "prod", "test", "sandbox"]
    },
    "criticality": {
      "type": "string",
      "description": "Критичность для бизнеса.",
      "enum": ["low", "medium", "high", "critical"]
    },
    "lifecycle": {
      "type": "string",
      "description": "Жизненный цикл актива.",
      "enum": ["planned", "active", "deprecated", "retired"],
      "default": "active"
    },
    "location": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "provider": { "type": "string", "enum": ["aws", "gcp", "azure", "onprem", "other"] },
        "region": { "type": "string", "maxLength": 64 },
        "zone": { "type": "string", "maxLength": 64 },
        "country": { "type": "string", "pattern": "^[A-Z]{2}$" },
        "city": { "type": "string", "maxLength": 128 },
        "geo": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "lat": { "type": "number", "minimum": -90, "maximum": 90 },
            "lon": { "type": "number", "minimum": -180, "maximum": 180 }
          }
        },
        "rack": { "type": "string", "maxLength": 64 },
        "room": { "type": "string", "maxLength": 64 }
      }
    },
    "network": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hostnames": {
          "type": "array",
          "items": { "type": "string", "format": "hostname" },
          "uniqueItems": true
        },
        "ips": {
          "type": "array",
          "items": {
            "oneOf": [
              { "type": "string", "format": "ipv4" },
              { "type": "string", "format": "ipv6" }
            ]
          },
          "uniqueItems": true
        },
        "interfaces": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name"],
            "properties": {
              "name": { "type": "string", "maxLength": 32 },
              "mac": { "type": "string", "pattern": "^[0-9A-Fa-f]{2}(:[0-9A-Fa-f]{2}){5}$" },
              "ipv4": { "type": "string", "format": "ipv4" },
              "ipv6": { "type": "string", "format": "ipv6" }
            }
          }
        },
        "ingress_endpoints": {
          "type": "array",
          "items": { "type": "string", "format": "uri" },
          "description": "Публичные точки входа (URI)."
        },
        "egress_destinations": {
          "type": "array",
          "items": { "type": "string", "maxLength": 256 },
          "description": "Назначения исходящего трафика (CIDR/домены/сервисы)."
        },
        "segmentation": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "vpc": { "type": "string", "maxLength": 128 },
            "subnet": { "type": "string", "maxLength": 128 },
            "security_groups": {
              "type": "array",
              "items": { "type": "string", "maxLength": 128 },
              "uniqueItems": true
            }
          }
        }
      }
    },
    "software": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "os": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "type": "string", "enum": ["windows", "linux", "darwin", "bsd", "android", "unknown"] },
            "name": { "type": "string", "maxLength": 128 },
            "version": { "type": "string", "maxLength": 64 },
            "kernel": { "type": "string", "maxLength": 64 },
            "arch": { "type": "string", "enum": ["x86_64", "arm64", "armv7", "ppc64le", "s390x", "other"] }
          }
        },
        "packages": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "version"],
            "properties": {
              "name": { "type": "string", "maxLength": 256 },
              "version": { "type": "string", "maxLength": 128 },
              "purl": { "type": "string", "maxLength": 512 },
              "license": { "type": "string", "maxLength": 64 }
            }
          }
        },
        "sbom": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "format": { "type": "string", "enum": ["spdx", "spdx-json", "cyclonedx", "cyclonedx-json"] },
            "uri": { "type": "string", "format": "uri" },
            "digest_sha256": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "controls": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "edr": { "type": "boolean" },
            "antivirus": { "type": "boolean" },
            "host_firewall": { "type": "boolean" },
            "fde": { "type": "boolean", "description": "Полное шифрование диска" },
            "selinux_apparmor": { "type": "boolean" },
            "auto_updates": { "type": "boolean" }
          }
        },
        "vuln_summary": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "total": { "type": "integer", "minimum": 0 },
            "by_severity": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "low": { "type": "integer", "minimum": 0 },
                "medium": { "type": "integer", "minimum": 0 },
                "high": { "type": "integer", "minimum": 0 },
                "critical": { "type": "integer", "minimum": 0 }
              }
            },
            "max_severity": { "type": "string", "enum": ["none", "low", "medium", "high", "critical"], "default": "none" },
            "last_scan": { "type": "string", "format": "date-time" }
          }
        },
        "patch_level": { "type": "string", "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$", "description": "Дата уровня патчей YYYY-MM-DD" },
        "compliance": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["framework", "state"],
            "properties": {
              "framework": { "type": "string", "enum": ["ISO27001", "SOC2", "PCI-DSS", "HIPAA", "GDPR", "NIST-800-53", "CIS"] },
              "profile": { "type": "string", "maxLength": 64 },
              "state": { "type": "string", "enum": ["pass", "fail", "partial", "not_applicable"] },
              "last_check": { "type": "string", "format": "date-time" },
              "report_url": { "type": "string", "format": "uri" }
            }
          }
        },
        "risk_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "readOnly": true,
          "description": "Сводный риск по внутренней модели 0..100."
        }
      }
    },
    "platform": {
      "type": "object",
      "description": "Платформенно-специфичные поля (условные по типу).",
      "additionalProperties": true
    },
    "relationships": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["runs_on", "depends_on", "connects_to", "managed_by", "belongs_to", "duplicates", "replaces"]
          },
          "asset_id": {
            "type": "string",
            "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
          },
          "external_ref": { "type": "string", "maxLength": 256 },
          "note": { "type": "string", "maxLength": 512 }
        },
        "oneOf": [
          { "required": ["asset_id"] },
          { "required": ["external_ref"] }
        ]
      }
    },
    "links": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "inventory_url": { "type": "string", "format": "uri" },
        "runbook_url": { "type": "string", "format": "uri" },
        "monitoring_url": { "type": "string", "format": "uri" }
      }
    },
    "tags": {
      "type": "object",
      "description": "Свободные метки key:value.",
      "additionalProperties": { "type": "string", "maxLength": 128 },
      "maxProperties": 128
    },
    "timestamps": {
      "type": "object",
      "additionalProperties": false,
      "required": ["created_at", "updated_at"],
      "properties": {
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "first_seen": { "type": "string", "format": "date-time" },
        "last_seen": { "type": "string", "format": "date-time" }
      }
    }
  },
  "patternProperties": {
    "^x-[A-Za-z0-9_.-]+$": {}
  },
  "allOf": [
    {
      "if": { "properties": { "type": { "const": "host" } } },
      "then": {
        "required": ["software", "network"],
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["virtualized"],
            "properties": {
              "virtualized": { "type": "boolean" },
              "hypervisor": { "type": "string", "maxLength": 64 },
              "cpu_cores": { "type": "integer", "minimum": 1, "maximum": 4096 },
              "ram_mb": { "type": "integer", "minimum": 128 },
              "disk_gb": { "type": "integer", "minimum": 1 }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "container" } } },
      "then": {
        "required": ["platform"],
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["runtime", "image", "image_digest"],
            "properties": {
              "runtime": { "type": "string", "enum": ["containerd", "docker", "crio", "other"] },
              "image": { "type": "string", "maxLength": 512 },
              "image_digest": { "type": "string", "pattern": "^sha256:[A-Fa-f0-9]{64}$" },
              "orchestrator": { "type": "string", "enum": ["kubernetes", "nomad", "swarm", "none"] },
              "kubernetes": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "cluster": { "type": "string", "maxLength": 128 },
                  "namespace": { "type": "string", "maxLength": 128 },
                  "pod": { "type": "string", "maxLength": 128 },
                  "node": { "type": "string", "maxLength": 128 },
                  "service_account": { "type": "string", "maxLength": 128 }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "serverless" } } },
      "then": {
        "required": ["platform"],
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["provider", "service", "runtime", "memory_mb"],
            "properties": {
              "provider": { "type": "string", "enum": ["aws", "gcp", "azure", "other"] },
              "service": { "type": "string", "enum": ["lambda", "cloudfunctions", "cloudrun", "azure-functions", "other"] },
              "runtime": { "type": "string", "maxLength": 64 },
              "entrypoint": { "type": "string", "maxLength": 256 },
              "memory_mb": { "type": "integer", "minimum": 64 },
              "timeout_sec": { "type": "integer", "minimum": 1 }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "database" } } },
      "then": {
        "required": ["platform"],
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["engine", "version"],
            "properties": {
              "engine": { "type": "string", "enum": ["postgres", "mysql", "mariadb", "mssql", "oracle", "mongodb", "redis", "elasticsearch", "other"] },
              "version": { "type": "string", "maxLength": 64 },
              "endpoint": {
                "type": "object",
                "additionalProperties": false,
                "required": ["host", "port"],
                "properties": {
                  "host": { "type": "string", "oneOf": [{ "format": "hostname" }, { "format": "ipv4" }, { "format": "ipv6" }] },
                  "port": { "type": "integer", "minimum": 1, "maximum": 65535 }
                }
              },
              "storage_encrypted": { "type": "boolean" },
              "multi_az": { "type": "boolean" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "application" } } },
      "then": {
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "service_name": { "type": "string", "maxLength": 128 },
              "version": { "type": "string", "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$" },
              "repo_url": { "type": "string", "format": "uri" },
              "build_digest": { "type": "string", "pattern": "^sha256:[A-Fa-f0-9]{64}$" }
            },
            "dependentRequired": {
              "build_digest": ["version"]
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "network_device" } } },
      "then": {
        "required": ["platform", "network"],
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["vendor", "model", "firmware_version"],
            "properties": {
              "vendor": { "type": "string", "maxLength": 64 },
              "model": { "type": "string", "maxLength": 64 },
              "firmware_version": { "type": "string", "maxLength": 64 },
              "mgmt_ip": { "type": "string", "oneOf": [{ "format": "ipv4" }, { "format": "ipv6" }] }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "type": { "const": "user_account" } } },
      "then": {
        "properties": {
          "platform": {
            "type": "object",
            "additionalProperties": false,
            "required": ["directory"],
            "properties": {
              "directory": { "type": "string", "enum": ["ad", "azuread", "okta", "ldap", "other"] },
              "username": { "type": "string", "maxLength": 128 },
              "email": { "type": "string", "format": "email" },
              "mfa": { "type": "boolean" },
              "role": { "type": "string", "maxLength": 64 }
            }
          }
        }
      }
    }
  ],
  "examples": [
    {
      "schema_version": "1.0.0",
      "asset_id": "7f6d8a0e-2d2b-4c4f-97e1-0d6d0b6b1b12",
      "type": "host",
      "name": "srv-app-01",
      "environment": "prod",
      "criticality": "high",
      "owner": { "group": "payments", "email": "payments-ops@aethernova.local" },
      "location": { "provider": "aws", "region": "eu-central-1", "country": "DE" },
      "network": {
        "hostnames": ["srv-app-01.example.local"],
        "ips": ["10.0.1.15"],
        "interfaces": [{ "name": "eth0", "mac": "AA:BB:CC:DD:EE:FF", "ipv4": "10.0.1.15" }]
      },
      "software": {
        "os": { "type": "linux", "name": "Ubuntu", "version": "22.04", "kernel": "5.15", "arch": "x86_64" },
        "sbom": { "format": "spdx-json", "uri": "https://sbom.example/srv-app-01.json", "digest_sha256": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" }
      },
      "security": {
        "controls": { "edr": true, "host_firewall": true, "fde": true, "auto_updates": true },
        "vuln_summary": { "total": 12, "by_severity": { "low": 5, "medium": 5, "high": 2, "critical": 0 }, "max_severity": "high" },
        "patch_level": "2025-08-15",
        "risk_score": 42.5
      },
      "timestamps": { "created_at": "2025-08-20T10:00:00Z", "updated_at": "2025-09-01T12:00:00Z", "first_seen": "2025-08-20T10:00:00Z", "last_seen": "2025-09-01T11:59:00Z" },
      "tags": { "app": "cybersecurity-core", "tier": "backend" },
      "relationships": [
        { "type": "depends_on", "external_ref": "rds:prod:payments" }
      ]
    }
  ]
}
