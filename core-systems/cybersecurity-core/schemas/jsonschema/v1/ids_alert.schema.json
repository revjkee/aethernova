{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.dev/schemas/cybersecurity-core/jsonschema/v1/ids_alert.schema.json",
  "title": "Aethernova Cybersecurity-Core: IDS Alert",
  "description": "Промышленная схема IDS-события для потоков безопасности (SIEM/SOAR/EDR/NDR/HIDS). Версия схемы v1.",
  "type": "object",
  "unevaluatedProperties": false,
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Версия схемы в формате SemVer.",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$",
      "default": "1.0.0"
    },
    "event": {
      "type": "object",
      "description": "Идентификация и время события.",
      "additionalProperties": false,
      "required": ["id", "occurred_at"],
      "properties": {
        "id": { "$ref": "#/$defs/uuid" },
        "correlation_id": { "$ref": "#/$defs/uuid" },
        "related_ids": {
          "type": "array",
          "items": { "$ref": "#/$defs/uuid" },
          "maxItems": 1000
        },
        "occurred_at": { "$ref": "#/$defs/timestamp" },
        "received_at": { "$ref": "#/$defs/timestamp" },
        "ingested_at": { "$ref": "#/$defs/timestamp" },
        "timezone": {
          "type": "string",
          "description": "IANA TZ (например, Europe/Stockholm).",
          "pattern": "^[A-Za-z]+(?:/[A-Za-z_+-]+)+$"
        }
      }
    },
    "source": {
      "type": "object",
      "description": "Источник детекции/сенсор/движок правил.",
      "additionalProperties": false,
      "required": ["sensor", "engine"],
      "properties": {
        "environment": {
          "type": "string",
          "enum": ["dev", "staging", "prod", "sandbox", "unknown"]
        },
        "tenant": { "type": "string", "maxLength": 256 },
        "sensor": {
          "type": "object",
          "additionalProperties": false,
          "required": ["id", "hostname"],
          "properties": {
            "id": { "$ref": "#/$defs/uuid" },
            "hostname": { "type": "string", "minLength": 1, "maxLength": 255 },
            "ipv4": {
              "type": "array",
              "items": { "format": "ipv4" },
              "maxItems": 64
            },
            "ipv6": {
              "type": "array",
              "items": { "format": "ipv6" },
              "maxItems": 64
            },
            "mac": {
              "type": "array",
              "items": { "$ref": "#/$defs/mac" },
              "maxItems": 64
            },
            "location": { "type": "string", "maxLength": 256 }
          }
        },
        "engine": {
          "type": "object",
          "additionalProperties": false,
          "required": ["vendor", "product", "version"],
          "properties": {
            "vendor": { "type": "string", "minLength": 1, "maxLength": 128 },
            "product": { "type": "string", "minLength": 1, "maxLength": 128 },
            "version": { "type": "string", "minLength": 1, "maxLength": 64 },
            "profile": { "type": "string", "maxLength": 128 },
            "rule_source": { "type": "string", "maxLength": 256 }
          }
        }
      }
    },
    "alert": {
      "type": "object",
      "description": "Описание срабатывания/правила.",
      "additionalProperties": false,
      "required": ["signature", "category"],
      "properties": {
        "signature": {
          "type": "object",
          "additionalProperties": false,
          "required": ["id", "name"],
          "properties": {
            "id": { "type": "string", "minLength": 1, "maxLength": 256 },
            "name": { "type": "string", "minLength": 1, "maxLength": 512 },
            "rev": { "type": "integer", "minimum": 0 },
            "gid": { "type": "integer", "minimum": 0 },
            "sid": { "type": "integer", "minimum": 0 },
            "references": {
              "type": "array",
              "items": { "type": "string", "maxLength": 512 },
              "maxItems": 64
            }
          }
        },
        "category": { "type": "string", "minLength": 1, "maxLength": 256 },
        "action": {
          "type": "string",
          "enum": ["alert", "block", "drop", "reset", "allow", "quarantine", "log-only"]
        },
        "message": { "type": "string", "maxLength": 2000 },
        "labels": { "$ref": "#/$defs/labels" }
      }
    },
    "severity": { "$ref": "#/$defs/severity" },
    "confidence": { "$ref": "#/$defs/confidence" },
    "classification": {
      "type": "object",
      "description": "Маппинг на таксономии и категории угроз.",
      "additionalProperties": false,
      "properties": {
        "kill_chain": {
          "type": "string",
          "enum": ["reconnaissance", "weaponization", "delivery", "exploitation", "installation", "c2", "actions-on-objective", "unknown"]
        },
        "mitre_attack": {
          "type": "array",
          "items": { "$ref": "#/$defs/mitreTechniqueId" },
          "maxItems": 64
        },
        "capec": {
          "type": "array",
          "items": { "type": "string", "pattern": "^CAPEC-\\d{1,5}$" },
          "maxItems": 64
        },
        "cwe": {
          "type": "array",
          "items": { "type": "string", "pattern": "^CWE-\\d{1,5}$" },
          "maxItems": 64
        },
        "ttp": { "type": "array", "items": { "type": "string", "maxLength": 256 }, "maxItems": 64 }
      }
    },
    "network": {
      "type": "object",
      "description": "Сетевой контекст события.",
      "additionalProperties": false,
      "required": ["protocol", "direction", "src", "dst"],
      "properties": {
        "direction": { "type": "string", "enum": ["inbound", "outbound", "lateral", "internal", "unknown"] },
        "protocol": {
          "type": "string",
          "enum": ["tcp", "udp", "icmp", "icmpv6", "gre", "ip", "arp", "http", "tls", "dns", "ssh", "smtp", "imap", "pop3", "ftp", "smb", "rdp", "dhcp", "ntp", "mqtt", "coap", "other"]
        },
        "src": { "$ref": "#/$defs/endpoint" },
        "dst": { "$ref": "#/$defs/endpoint" },
        "bytes": { "type": "object", "additionalProperties": false, "properties": {
          "src": { "type": "integer", "minimum": 0 },
          "dst": { "type": "integer", "minimum": 0 },
          "total": { "type": "integer", "minimum": 0 }
        }},
        "packets": { "type": "object", "additionalProperties": false, "properties": {
          "src": { "type": "integer", "minimum": 0 },
          "dst": { "type": "integer", "minimum": 0 },
          "total": { "type": "integer", "minimum": 0 }
        }},
        "tcp": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "flags": {
              "type": "array",
              "items": { "type": "string", "enum": ["SYN", "ACK", "FIN", "RST", "PSH", "URG", "ECE", "CWR"] },
              "maxItems": 8,
              "uniqueItems": true
            }
          }
        },
        "http": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "method": { "$ref": "#/$defs/httpMethod" },
            "host": { "type": "string", "maxLength": 255 },
            "url": { "type": "string", "maxLength": 2000 },
            "path": { "type": "string", "maxLength": 1024 },
            "user_agent": { "type": "string", "maxLength": 1024 },
            "status": { "type": "integer", "minimum": 100, "maximum": 599 },
            "request_headers": { "$ref": "#/$defs/httpHeaders" },
            "response_headers": { "$ref": "#/$defs/httpHeaders" }
          }
        },
        "tls": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "version": { "$ref": "#/$defs/tlsVersion" },
            "cipher": { "type": "string", "maxLength": 128 },
            "sni": { "type": "string", "maxLength": 255 },
            "ja3": { "type": "string", "pattern": "^[a-f0-9]{32}$" },
            "ja3s": { "type": "string", "pattern": "^[a-f0-9]{32}$" },
            "cert_fingerprint_sha1": { "type": "string", "pattern": "^[A-Fa-f0-9]{40}$" }
          }
        },
        "dns": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "query": { "type": "string", "maxLength": 253 },
            "type": { "type": "string", "maxLength": 16 },
            "answers": {
              "type": "array",
              "items": { "type": "string", "maxLength": 253 },
              "maxItems": 128
            },
            "ttl": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "file": {
      "type": "object",
      "description": "Файловый артефакт (для HIDS/EDR/AV).",
      "additionalProperties": false,
      "required": ["path", "hashes"],
      "properties": {
        "name": { "type": "string", "maxLength": 512 },
        "path": { "type": "string", "maxLength": 2048 },
        "size": { "type": "integer", "minimum": 0 },
        "mime_type": { "type": "string", "maxLength": 128 },
        "hashes": { "$ref": "#/$defs/hashes" },
        "pe": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "imphash": { "type": "string", "pattern": "^[a-fA-F0-9]{32}$" },
            "company": { "type": "string", "maxLength": 256 },
            "description": { "type": "string", "maxLength": 512 }
          }
        }
      }
    },
    "process": {
      "type": "object",
      "description": "Процессный контекст (хост/EDR).",
      "additionalProperties": false,
      "required": ["pid", "name"],
      "properties": {
        "pid": { "type": "integer", "minimum": 0 },
        "ppid": { "type": "integer", "minimum": 0 },
        "name": { "type": "string", "maxLength": 256 },
        "exe": { "type": "string", "maxLength": 2048 },
        "cmdline": { "type": "string", "maxLength": 4096 },
        "user": { "type": "string", "maxLength": 256 },
        "start_time": { "$ref": "#/$defs/timestamp" },
        "integrity_level": { "type": "string", "enum": ["low", "medium", "high", "system", "unknown"] }
      }
    },
    "host": {
      "type": "object",
      "description": "Сведения о хосте, на котором выявлен артефакт.",
      "additionalProperties": false,
      "properties": {
        "hostname": { "type": "string", "maxLength": 255 },
        "os": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "type": "string", "enum": ["windows", "linux", "macos", "bsd", "unix", "other"] },
            "name": { "type": "string", "maxLength": 128 },
            "version": { "type": "string", "maxLength": 128 },
            "kernel": { "type": "string", "maxLength": 128 },
            "arch": { "type": "string", "enum": ["x86", "x64", "arm64", "arm", "riscv", "other"] }
          }
        },
        "user": { "type": "string", "maxLength": 256 },
        "domain": { "type": "string", "maxLength": 256 }
      }
    },
    "container": {
      "type": "object",
      "description": "Контейнерный и/или Kubernetes контекст.",
      "additionalProperties": false,
      "properties": {
        "runtime": { "type": "string", "enum": ["docker", "containerd", "cri-o", "podman", "unknown"] },
        "id": { "type": "string", "maxLength": 128 },
        "image": { "type": "string", "maxLength": 256 },
        "image_hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
        "kubernetes": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cluster": { "type": "string", "maxLength": 128 },
            "namespace": { "type": "string", "maxLength": 128 },
            "pod": { "type": "string", "maxLength": 128 },
            "node": { "type": "string", "maxLength": 128 }
          }
        }
      }
    },
    "cloud": {
      "type": "object",
      "description": "Облачный контекст.",
      "additionalProperties": false,
      "properties": {
        "provider": { "type": "string", "enum": ["aws", "azure", "gcp", "oci", "other"] },
        "account_id": { "type": "string", "maxLength": 64 },
        "project_id": { "type": "string", "maxLength": 128 },
        "region": { "type": "string", "maxLength": 64 },
        "resource_id": { "type": "string", "maxLength": 256 },
        "tags": {
          "type": "object",
          "additionalProperties": { "type": "string", "maxLength": 256 }
        }
      }
    },
    "actor": {
      "type": "object",
      "description": "Пользователь/субъект действия, если известен.",
      "additionalProperties": false,
      "properties": {
        "user": { "type": "string", "maxLength": 256 },
        "uid": { "type": "string", "maxLength": 128 },
        "email": { "type": "string", "format": "email" },
        "roles": {
          "type": "array",
          "items": { "type": "string", "maxLength": 128 },
          "maxItems": 64
        },
        "auth_method": { "type": "string", "maxLength": 128 }
      }
    },
    "geo": {
      "type": "object",
      "description": "Геоконтекст (если применимо).",
      "additionalProperties": false,
      "properties": {
        "src_country": { "type": "string", "pattern": "^[A-Z]{2}$", "description": "ISO 3166-1 alpha-2" },
        "dst_country": { "type": "string", "pattern": "^[A-Z]{2}$", "description": "ISO 3166-1 alpha-2" }
      }
    },
    "enrichment": {
      "type": "object",
      "description": "Обогащение события.",
      "additionalProperties": false,
      "properties": {
        "threat_intel": {
          "type": "array",
          "maxItems": 128,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["provider", "indicator", "score", "confidence"],
            "properties": {
              "provider": { "type": "string", "maxLength": 128 },
              "feed": { "type": "string", "maxLength": 128 },
              "indicator": { "type": "string", "maxLength": 512 },
              "type": { "type": "string", "enum": ["ip", "domain", "url", "hash", "email", "filename", "filepath", "other"] },
              "score": { "type": "number", "minimum": 0, "maximum": 100 },
              "confidence": { "$ref": "#/$defs/confidence" },
              "labels": { "$ref": "#/$defs/labels" },
              "sightings": { "type": "integer", "minimum": 0 }
            }
          }
        },
        "observables": {
          "type": "array",
          "maxItems": 256,
          "items": { "type": "string", "maxLength": 2048 }
        }
      }
    },
    "triage": {
      "type": "object",
      "description": "Поля триажа и аналитического статуса.",
      "additionalProperties": false,
      "properties": {
        "status": { "type": "string", "enum": ["new", "in_progress", "true_positive", "false_positive", "benign", "suppressed", "resolved"] },
        "owner": { "type": "string", "maxLength": 128 },
        "severity_override": { "$ref": "#/$defs/severity" },
        "disposition": { "type": "string", "maxLength": 256 },
        "reason": { "type": "string", "maxLength": 2000 }
      }
    },
    "remediation": {
      "type": "object",
      "description": "Рекомендации и выполненные действия.",
      "additionalProperties": false,
      "properties": {
        "recommended": {
          "type": "array",
          "items": { "type": "string", "maxLength": 1024 },
          "maxItems": 64
        },
        "applied": { "type": "boolean" },
        "ticket_id": { "type": "string", "maxLength": 128 }
      }
    },
    "notes": { "type": "string", "maxLength": 4000 },
    "labels": { "$ref": "#/$defs/labels" }
  },
  "required": ["schema_version", "event", "source", "alert", "severity", "confidence"],
  "anyOf": [
    { "required": ["network"] },
    { "required": ["process"] },
    { "required": ["file"] },
    { "required": ["network", "dns"] }
  ],
  "$defs": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "RFC 3339 / ISO 8601 UTC или с таймзоной."
    },
    "uuid": {
      "type": "string",
      "description": "UUID v4 (допускаются иные версии, если строго UUID).",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "ip": {
      "description": "IPv4 или IPv6.",
      "anyOf": [
        { "type": "string", "format": "ipv4" },
        { "type": "string", "format": "ipv6" }
      ]
    },
    "port": {
      "type": "integer",
      "minimum": 1,
      "maximum": 65535
    },
    "mac": {
      "type": "string",
      "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
    },
    "severity": {
      "type": "string",
      "enum": ["info", "low", "medium", "high", "critical"]
    },
    "confidence": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100
    },
    "labels": {
      "type": "array",
      "items": { "type": "string", "maxLength": 64 },
      "maxItems": 64,
      "uniqueItems": true
    },
    "mitreTechniqueId": {
      "type": "string",
      "description": "Идентификатор техники MITRE ATT&CK (например, T1059 или T1059.003).",
      "pattern": "^T\\d{4}(?:\\.\\d{3})?$"
    },
    "endpoint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ip"],
      "properties": {
        "ip": { "$ref": "#/$defs/ip" },
        "port": { "$ref": "#/$defs/port" },
        "mac": { "$ref": "#/$defs/mac" },
        "hostname": { "type": "string", "maxLength": 255 }
      }
    },
    "hashes": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "md5": { "type": "string", "pattern": "^[A-Fa-f0-9]{32}$" },
        "sha1": { "type": "string", "pattern": "^[A-Fa-f0-9]{40}$" },
        "sha256": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
        "sha512": { "type": "string", "pattern": "^[A-Fa-f0-9]{128}$" }
      },
      "minProperties": 1
    },
    "httpMethod": {
      "type": "string",
      "enum": ["GET", "HEAD", "POST", "PUT", "DELETE", "CONNECT", "OPTIONS", "TRACE", "PATCH"]
    },
    "httpHeaders": {
      "type": "object",
      "maxProperties": 128,
      "patternProperties": {
        "^[A-Za-z0-9-]{1,64}$": { "type": "string", "maxLength": 1024 }
      },
      "additionalProperties": false
    },
    "tlsVersion": {
      "type": "string",
      "enum": ["TLS1.0", "TLS1.1", "TLS1.2", "TLS1.3", "SSL3.0", "unknown"]
    }
  },
  "examples": [
    {
      "schema_version": "1.0.0",
      "event": {
        "id": "3f0c3a5a-9a63-4d6b-9fa5-3b6b5f92d6a1",
        "occurred_at": "2025-09-03T08:12:34Z",
        "received_at": "2025-09-03T08:12:35Z",
        "ingested_at": "2025-09-03T08:12:36Z",
        "timezone": "Europe/Stockholm"
      },
      "source": {
        "environment": "prod",
        "sensor": {
          "id": "f0d2f4a6-0e9b-4b8a-8d4b-c1f2b3a4c5d6",
          "hostname": "ndrsensor-01",
          "ipv4": ["10.0.10.5"],
          "mac": ["00:1c:42:2b:60:5a"]
        },
        "engine": {
          "vendor": "Suricata",
          "product": "NIDS",
          "version": "7.0.2",
          "profile": "balanced",
          "rule_source": "oisf/community"
        }
      },
      "alert": {
        "signature": {
          "id": "1:2023456:5",
          "name": "ET EXPLOIT Possible RCE via HTTP",
          "rev": 5,
          "gid": 1,
          "sid": 2023456,
          "references": ["https://attack.mitre.org/techniques/T1190/"]
        },
        "category": "Exploit Attempt",
        "action": "alert",
        "message": "Suspicious HTTP request pattern",
        "labels": ["web", "rce", "http"]
      },
      "severity": "high",
      "confidence": 85,
      "classification": {
        "kill_chain": "exploitation",
        "mitre_attack": ["T1190"],
        "cwe": ["CWE-94"]
      },
      "network": {
        "direction": "inbound",
        "protocol": "http",
        "src": { "ip": "203.0.113.10", "port": 51234 },
        "dst": { "ip": "198.51.100.20", "port": 80 },
        "bytes": { "src": 650, "dst": 1430, "total": 2080 },
        "packets": { "src": 4, "dst": 6, "total": 10 },
        "http": {
          "method": "GET",
          "host": "app.example.com",
          "url": "http://app.example.com/index.php?cmd=%7B%7D",
          "path": "/index.php",
          "user_agent": "curl/8.0.1",
          "status": 200
        }
      },
      "host": {
        "hostname": "web-01",
        "os": { "type": "linux", "name": "Ubuntu", "version": "22.04", "kernel": "5.15", "arch": "x64" }
      },
      "triage": {
        "status": "in_progress",
        "owner": "soc_level2"
      },
      "remediation": {
        "recommended": [
          "Заблокировать исходный IP на периметре",
          "Проверить веб-сервер на наличие RCE-артефактов"
        ],
        "applied": false
      },
      "labels": ["ids", "production"]
    }
  ]
}
