{
  "$id": "https://aethernova.local/cybersecurity-core/schemas/jsonschema/v1/ti_indicator.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Threat Intelligence Indicator (TI Indicator) — v1",
  "description": "Промышленная JSON Schema для нормализации и валидации TI-индикаторов в Aethernova / cybersecurity-core.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "id",
    "spec_version",
    "type",
    "labels",
    "confidence",
    "tlp",
    "created",
    "modified"
  ],
  "oneOf": [
    { "required": ["pattern", "pattern_type"] },
    { "required": ["observables"] }
  ],
  "properties": {
    "id": {
      "description": "Глобальный идентификатор индикатора (UUID или ULID).",
      "oneOf": [
        { "$ref": "#/$defs/uuid" },
        { "$ref": "#/$defs/ulid" }
      ]
    },
    "spec_version": {
      "description": "Версия прикладной спецификации.",
      "type": "string",
      "const": "1.0"
    },
    "schema_version": {
      "description": "Версия схемы (для миграций валидаторов).",
      "type": "string",
      "const": "2020-12"
    },
    "type": {
      "description": "Тип сущности.",
      "type": "string",
      "const": "ti-indicator"
    },
    "title": {
      "description": "Короткое человекочитаемое название индикатора.",
      "type": "string",
      "minLength": 3,
      "maxLength": 256
    },
    "description": {
      "description": "Подробное описание индикатора.",
      "type": "string",
      "minLength": 1,
      "maxLength": 20000
    },
    "labels": {
      "description": "Метки классификации/таксономии (для маршрутизации и правил).",
      "type": "array",
      "minItems": 1,
      "maxItems": 256,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9][a-z0-9_.-]{0,63}$"
      }
    },
    "tags": {
      "description": "Свободные теги.",
      "type": "array",
      "minItems": 0,
      "maxItems": 256,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "minLength": 1,
        "maxLength": 128
      }
    },
    "indicator_types": {
      "description": "Высокоуровневые типы индикатора (для грубой категоризации).",
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "enum": [
          "ipv4",
          "ipv6",
          "domain",
          "url",
          "email",
          "hash",
          "file",
          "registry",
          "mutex",
          "c2",
          "yara",
          "sigma",
          "suricata",
          "snort",
          "certificate",
          "ja3",
          "ja3s",
          "jarm",
          "user-agent",
          "cve",
          "cpe",
          "asn",
          "generic-pattern"
        ]
      }
    },
    "pattern_type": {
      "description": "Тип детекционного паттерна.",
      "type": "string",
      "enum": [
        "stix2",
        "yara",
        "sigma",
        "snort",
        "suricata",
        "regex",
        "kql",
        "spl",
        "lucene",
        "generic"
      ]
    },
    "pattern": {
      "description": "Содержимое паттерна/правила в синтаксисе pattern_type.",
      "type": "string",
      "minLength": 1,
      "maxLength": 200000
    },
    "observables": {
      "description": "Нормализованные наблюдаемые сущности (альтернатива/дополнение pattern).",
      "type": "array",
      "minItems": 1,
      "maxItems": 10000,
      "items": { "$ref": "#/$defs/observable" }
    },
    "malware": {
      "description": "Связанные вредоносные объекты.",
      "type": "array",
      "maxItems": 256,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name"],
        "properties": {
          "name": { "type": "string", "minLength": 1, "maxLength": 256 },
          "family": { "type": "string", "minLength": 1, "maxLength": 256 },
          "category": {
            "type": "string",
            "enum": [
              "ransomware",
              "backdoor",
              "banker",
              "dropper",
              "loader",
              "spyware",
              "worm",
              "bot",
              "rootkit",
              "trojan",
              "adware",
              "other"
            ]
          }
        }
      }
    },
    "threat_actor": {
      "description": "Связанный актор угрозы (если известно).",
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 256 },
        "aliases": {
          "type": "array",
          "uniqueItems": true,
          "items": { "type": "string", "minLength": 1, "maxLength": 256 }
        }
      }
    },
    "campaign": {
      "description": "Связанная кампания (если применимо).",
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 256 },
        "first_seen": { "type": "string", "format": "date-time" },
        "last_seen": { "type": "string", "format": "date-time" }
      }
    },
    "kill_chain_phases": {
      "description": "Фазы kill chain (например, MITRE ATT&CK/Lockheed Martin).",
      "type": "array",
      "maxItems": 64,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["kill_chain_name", "phase_name"],
        "properties": {
          "kill_chain_name": { "type": "string", "minLength": 1, "maxLength": 256 },
          "phase_name": { "type": "string", "minLength": 1, "maxLength": 256 }
        }
      }
    },
    "confidence": {
      "description": "Оценка уверенности (0–100).",
      "type": "integer",
      "minimum": 0,
      "maximum": 100
    },
    "severity": {
      "description": "Серьезность для приоритизации.",
      "type": "string",
      "enum": ["informational", "low", "medium", "high", "critical"]
    },
    "priority": {
      "description": "Приоритет обработки (оркестрация).",
      "type": "string",
      "enum": ["low", "normal", "high", "urgent"]
    },
    "tlp": {
      "description": "Метка FIRST TLP.",
      "type": "string",
      "enum": ["TLP:CLEAR", "TLP:GREEN", "TLP:AMBER", "TLP:AMBER+STRICT", "TLP:RED"]
    },
    "valid_from": {
      "description": "Начало периода валидности индикатора.",
      "type": "string",
      "format": "date-time"
    },
    "valid_until": {
      "description": "Окончание периода валидности индикатора (если известно).",
      "type": "string",
      "format": "date-time"
    },
    "status": {
      "description": "Статус жизненного цикла.",
      "type": "string",
      "enum": ["new", "reviewed", "active", "deprecated", "revoked"]
    },
    "revoked": {
      "description": "Индикатор отозван.",
      "type": "boolean",
      "default": false
    },
    "created": {
      "description": "Время создания записи.",
      "type": "string",
      "format": "date-time"
    },
    "modified": {
      "description": "Время последнего изменения записи.",
      "type": "string",
      "format": "date-time"
    },
    "created_by": {
      "description": "Идентификатор субъекта, создавшего запись.",
      "oneOf": [
        { "$ref": "#/$defs/uuid" },
        { "type": "string", "format": "uri" }
      ]
    },
    "lang": {
      "description": "Язык описательных полей (BCP 47).",
      "type": "string",
      "pattern": "^[A-Za-z]{2,3}(-[A-Za-z0-9]{2,8})*$"
    },
    "source": {
      "description": "Метаданные источника TI.",
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 256 },
        "type": {
          "type": "string",
          "enum": ["osint", "partner", "internal", "commercial", "isac", "community"]
        },
        "tlp": { "$ref": "#/properties/tlp" },
        "reliability": {
          "description": "Надежность источника (Admiralty A–F).",
          "type": "string",
          "enum": ["A", "B", "C", "D", "E", "F"]
        },
        "credibility": {
          "description": "Достоверность информации (Admiralty 1–6).",
          "type": "string",
          "enum": ["1", "2", "3", "4", "5", "6"]
        },
        "ingested": { "type": "string", "format": "date-time" },
        "identity_ref": {
          "description": "Ссылка на сущность-источник.",
          "oneOf": [
            { "$ref": "#/$defs/uuid" },
            { "type": "string", "format": "uri" }
          ]
        }
      }
    },
    "external_references": {
      "description": "Внешние ссылки/идентификаторы.",
      "type": "array",
      "maxItems": 256,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["source_name"],
        "properties": {
          "source_name": { "type": "string", "minLength": 1, "maxLength": 256 },
          "url": { "type": "string", "format": "uri" },
          "external_id": { "type": "string", "minLength": 1, "maxLength": 256 },
          "hashes": { "$ref": "#/$defs/hashes" }
        }
      }
    },
    "attribution": {
      "description": "Обоснование атрибуции (кратко).",
      "type": "string",
      "minLength": 0,
      "maxLength": 5000
    },
    "x_extensions": {
      "description": "Пространство для вендор-расширений (namespace x-).",
      "type": "object",
      "additionalProperties": true
    },
    "confidence_notes": {
      "description": "Обоснование выставленной confidence.",
      "type": "string",
      "minLength": 0,
      "maxLength": "5000"
    },
    "detections": {
      "description": "Нормализованные правила/сигнатуры в разрезе движков (альтернатива pattern).",
      "type": "array",
      "maxItems": 1024,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["engine", "content"],
        "properties": {
          "engine": {
            "type": "string",
            "enum": ["yara", "sigma", "snort", "suricata", "regex", "kql", "spl", "lucene"]
          },
          "content": { "type": "string", "minLength": 1, "maxLength": 200000 },
          "reference": { "type": "string", "format": "uri" }
        }
      }
    }
  },
  "$defs": {
    "uuid": {
      "type": "string",
      "description": "UUID (версии не ограничены).",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
    },
    "ulid": {
      "type": "string",
      "description": "ULID Crockford Base32.",
      "pattern": "^[0-7][0-9A-HJKMNP-TV-Z]{25}$"
    },
    "hashes": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "md5": { "type": "string", "pattern": "^[A-Fa-f0-9]{32}$" },
        "sha1": { "type": "string", "pattern": "^[A-Fa-f0-9]{40}$" },
        "sha256": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
        "sha512": { "type": "string", "pattern": "^[A-Fa-f0-9]{128}$" },
        "ssdeep": {
          "type": "string",
          "pattern": "^\\d{1,5}:[A-Za-z0-9/+]{0,64}:[A-Za-z0-9/+]{0,64}$"
        }
      }
    },
    "observable": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "ipv4",
            "ipv6",
            "domain",
            "url",
            "email",
            "hash",
            "file-path",
            "file-name",
            "registry-key",
            "registry-value",
            "mutex",
            "c2",
            "cve",
            "cpe",
            "ja3",
            "ja3s",
            "jarm",
            "user-agent",
            "asn"
          ]
        },
        "value": { "type": "string", "minLength": 1, "maxLength": 8192 },
        "context": {
          "description": "Доп. контекст (например, порт/протокол/процесс).",
          "type": "object",
          "additionalProperties": true
        },
        "hashes": { "$ref": "#/$defs/hashes" }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "ipv4" } } },
          "then": { "properties": { "value": { "type": "string", "format": "ipv4" } } }
        },
        {
          "if": { "properties": { "type": { "const": "ipv6" } } },
          "then": { "properties": { "value": { "type": "string", "format": "ipv6" } } }
        },
        {
          "if": { "properties": { "type": { "const": "domain" } } },
          "then": {
            "properties": {
              "value": {
                "type": "string",
                "pattern": "^(?=.{1,253}$)(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\\.(?!-)[A-Za-z0-9-]{1,63}(?<!-))*\\.[A-Za-z]{2,63}$|^xn--[A-Za-z0-9-]{1,59}$"
              }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "url" } } },
          "then": { "properties": { "value": { "type": "string", "format": "uri" } } }
        },
        {
          "if": { "properties": { "type": { "const": "email" } } },
          "then": { "properties": { "value": { "type": "string", "format": "email" } } }
        },
        {
          "if": { "properties": { "type": { "const": "hash" } } },
          "then": {
            "properties": {
              "value": {
                "type": "string",
                "pattern": "^(?i)([A-F0-9]{32}|[A-F0-9]{40}|[A-F0-9]{64}|[A-F0-9]{128})$"
              }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "cve" } } },
          "then": {
            "properties": {
              "value": { "type": "string", "pattern": "^CVE-\\d{4}-\\d{4,7}$" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "cpe" } } },
          "then": {
            "properties": {
              "value": {
                "type": "string",
                "pattern": "^cpe:2\\.3:[aho\\*\\-]:[^:]*(:[^:]*){9}$"
              }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "asn" } } },
          "then": {
            "properties": {
              "value": { "type": "string", "pattern": "^(AS)?\\d{1,10}$" }
            }
          }
        }
      ]
    }
  },
  "$comment": "Примечание: проверка относительного порядка дат (valid_from < valid_until) должна выполняться на уровне бизнес-логики валидатора/пайплайна."
}
