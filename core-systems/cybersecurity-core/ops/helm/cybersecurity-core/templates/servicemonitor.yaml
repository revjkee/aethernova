{{- if and .Values.metrics.enabled .Values.metrics.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "cybersecurity-core.fullname" . }}
  labels:
    {{- include "cybersecurity-core.labels" . | nindent 4 }}
    {{- /* Часто Prometheus-чарт фильтрует по этой метке */ -}}
    release: {{ default "prometheus" .Values.metrics.serviceMonitor.release | quote }}
    {{- with .Values.metrics.serviceMonitor.additionalLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.metrics.serviceMonitor.annotations }}
  annotations: {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- with .Values.metrics.serviceMonitor.jobLabel }}
  jobLabel: {{ . | quote }}
  {{- end }}

  selector:
    {{- /* Приоритет: явный селектор из values -> matchExpressions -> дефолтные selectorLabels */ -}}
    {{- if .Values.metrics.serviceMonitor.selector }}
    {{- toYaml .Values.metrics.serviceMonitor.selector | nindent 4 }}
    {{- else }}
    matchLabels:
      {{- if .Values.metrics.serviceMonitor.matchLabels }}
      {{- toYaml .Values.metrics.serviceMonitor.matchLabels | nindent 6 }}
      {{- else }}
      {{- include "cybersecurity-core.selectorLabels" . | nindent 6 }}
      {{- end }}
    {{- if .Values.metrics.serviceMonitor.matchExpressions }}
    matchExpressions:
      {{- toYaml .Values.metrics.serviceMonitor.matchExpressions | nindent 6 }}
    {{- end }}
    {{- end }}

  namespaceSelector:
    {{- /* По умолчанию — текущий namespace релиза */ -}}
    {{- if .Values.metrics.serviceMonitor.namespaceSelector }}
    {{- toYaml .Values.metrics.serviceMonitor.namespaceSelector | nindent 4 }}
    {{- else }}
    matchNames:
      - {{ .Release.Namespace }}
    {{- end }}

  {{- with .Values.metrics.serviceMonitor.targetLabels }}
  targetLabels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.metrics.serviceMonitor.podTargetLabels }}
  podTargetLabels:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  endpoints:
    {{- /* Основной эндпоинт */ -}}
    - {{- /* порт по имени или targetPort */ -}}
      {{- if .Values.metrics.portName }}
      port: {{ .Values.metrics.portName | quote }}
      {{- else if .Values.metrics.targetPort }}
      targetPort: {{ .Values.metrics.targetPort }}
      {{- else }}
      port: "http"
      {{- end }}
      path: {{ default "/metrics" .Values.metrics.path | quote }}
      scheme: {{ default "http" .Values.metrics.scheme | quote }}
      interval: {{ default "30s" .Values.metrics.interval | quote }}
      {{- with .Values.metrics.scrapeTimeout }}
      scrapeTimeout: {{ . | quote }}
      {{- end }}
      {{- with .Values.metrics.sampleLimit }}
      sampleLimit: {{ . }}
      {{- end }}
      {{- with .Values.metrics.labelLimit }}
      labelLimit: {{ . }}
      {{- end }}
      {{- with .Values.metrics.labelNameLengthLimit }}
      labelNameLengthLimit: {{ . }}
      {{- end }}
      {{- with .Values.metrics.labelValueLengthLimit }}
      labelValueLengthLimit: {{ . }}
      {{- end }}
      honorLabels: {{ default false .Values.metrics.honorLabels }}
      honorTimestamps: {{ default true .Values.metrics.honorTimestamps }}
      {{- with .Values.metrics.followRedirects }}
      followRedirects: {{ . }}
      {{- end }}
      {{- with .Values.metrics.enableHttp2 }}
      enableHttp2: {{ . }}
      {{- end }}
      {{- with .Values.metrics.params }}
      params:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- /* Аутентификация (опционально) */ -}}
      {{- with .Values.metrics.serviceMonitor.bearerTokenSecret }}
      bearerTokenSecret:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.metrics.serviceMonitor.basicAuth }}
      basicAuth:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.metrics.serviceMonitor.authorization }}
      authorization:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.metrics.serviceMonitor.oauth2 }}
      oauth2:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- /* TLS (опционально) */ -}}
      {{- with .Values.metrics.serviceMonitor.tlsConfig }}
      tlsConfig:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.metrics.proxyUrl }}
      proxyUrl: {{ . | quote }}
      {{- end }}

      {{- /* Релабелинг целей и метрик */ -}}
      {{- with .Values.metrics.serviceMonitor.relabelings }}
      relabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.metrics.serviceMonitor.metricRelabelings }}
      metricRelabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}

    {{- /* Дополнительные эндпоинты (список) */ -}}
    {{- range .Values.metrics.serviceMonitor.additionalEndpoints }}
    - {{- if .portName }}
      port: {{ .portName | quote }}
      {{- else if .targetPort }}
      targetPort: {{ .targetPort }}
      {{- else }}
      port: "http"
      {{- end }}
      {{- with .path }}path: {{ . | quote }}{{- end }}
      {{- with .scheme }}scheme: {{ . | quote }}{{- end }}
      {{- with .interval }}interval: {{ . | quote }}{{- end }}
      {{- with .scrapeTimeout }}scrapeTimeout: {{ . | quote }}{{- end }}
      {{- with .sampleLimit }}sampleLimit: {{ . }}{{- end }}
      {{- with .labelLimit }}labelLimit: {{ . }}{{- end }}
      {{- with .labelNameLengthLimit }}labelNameLengthLimit: {{ . }}{{- end }}
      {{- with .labelValueLengthLimit }}labelValueLengthLimit: {{ . }}{{- end }}
      {{- with .honorLabels }}honorLabels: {{ . }}{{- end }}
      {{- with .honorTimestamps }}honorTimestamps: {{ . }}{{- end }}
      {{- with .followRedirects }}followRedirects: {{ . }}{{- end }}
      {{- with .enableHttp2 }}enableHttp2: {{ . }}{{- end }}
      {{- with .params }}
      params:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .bearerTokenSecret }}
      bearerTokenSecret:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .basicAuth }}
      basicAuth:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .authorization }}
      authorization:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .oauth2 }}
      oauth2:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .tlsConfig }}
      tlsConfig:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .proxyUrl }}proxyUrl: {{ . | quote }}{{- end }}
      {{- with .relabelings }}
      relabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .metricRelabelings }}
      metricRelabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- end }}
{{- end }}
