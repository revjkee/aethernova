<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Cybersecurity Core — Web Admin (Minimal)</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' sha256-wytRHb9eHrftajv94Z02IA78yZEyf5MMkM6pYIDEKho=; style-src 'self' sha256-uFTz+dX7i6EqhuREdLRrHcLl3pN/jJRSX3x7fMhp5aA=; img-src 'self' data:; connect-src 'self' http: https:; base-uri 'none'; form-action 'none'; frame-ancestors 'none'">
  <meta name="referrer" content="no-referrer">
  <style>:root {
  --bg: #0b0f14;
  --panel: #111827;
  --muted: #6b7280;
  --text: #e5e7eb;
  --accent: #3b82f6;
  --danger: #ef4444;
  --ok: #10b981;
  --warn: #f59e0b;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
  line-height: 1.35;
}

.container { max-width: 1150px; margin: 24px auto; padding: 0 16px; }

h1 { font-size: 20px; margin: 0 0 16px; }
h2 { font-size: 16px; margin: 20px 0 10px; color: var(--muted); font-weight: 600; }

.card {
  background: var(--panel);
  border: 1px solid #1f2937;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.row { display: flex; gap: 12px; flex-wrap: wrap; }

label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

input[type="text"], input[type="password"], input[type="number"], input[type="datetime-local"], textarea, select {
  width: 100%;
  background: #0f172a;
  color: var(--text);
  border: 1px solid #1f2937;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 14px;
}

textarea { min-height: 88px; resize: vertical; }

button {
  background: #1f2937;
  color: var(--text);
  border: 1px solid #374151;
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 14px;
  cursor: pointer;
}
button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
button.danger { background: var(--danger); border-color: var(--danger); }
button.ghost { background: transparent; border-color: #374151; }
button:disabled { opacity: 0.6; cursor: default; }

.kv { display: grid; grid-template-columns: 220px 1fr; gap: 8px 16px; align-items: center; }
.kv div.key { color: var(--muted); }
.code { font-family: var(--mono); font-size: 12px; background: #0a0f1a; padding: 12px; border-radius: 8px; overflow: auto; border: 1px solid #1f2937; }

.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #374151; }
.badge.ok { color: #064e3b; background: #d1fae5; border-color: #a7f3d0; }
.badge.err { color: #7f1d1d; background: #fee2e2; border-color: #fecaca; }
.badge.warn { color: #78350f; background: #fef3c7; border-color: #fde68a; }

hr { border: none; border-top: 1px solid #1f2937; margin: 12px 0; }

.table { width: 100%; border-collapse: collapse; }
.table th, .table td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #1f2937; font-size: 13px; }
.table th { color: var(--muted); font-weight: 600; }

.right { text-align: right; }
.mono { font-family: var(--mono); }
.small { font-size: 12px; color: var(--muted); }
.hidden { display: none !important; }</style>
</head>
<body>
  <div class="container">
    <h1>Cybersecurity Core — Web Admin (Minimal)</h1>

    <div class="card">
      <h2>Конфигурация соединения</h2>
      <div class="grid">
        <div>
          <label>Base URL</label>
          <input id="baseUrl" type="text" placeholder="https://api.example.com">
        </div>
        <div class="row" style="align-items:flex-end;">
          <div>
            <label>&nbsp;</label>
            <button id="saveCfg" class="primary">Сохранить</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <label class="small"><input id="sendContentType" type="checkbox" checked> Отправлять Content-Type</label>
          </div>
        </div>
        <div>
          <label>API Key</label>
          <input id="apiKey" type="password" placeholder="секретный ключ">
        </div>
        <div>
          <label>Заголовок API Key</label>
          <input id="apiKeyHeader" type="text" value="X-API-Key">
        </div>
        <div>
          <label>JWT (опционально)</label>
          <input id="jwt" type="text" placeholder="Bearer JWT">
        </div>
        <div>
          <label>Таймаут, мс</label>
          <input id="timeout" type="number" value="15000" min="1000">
        </div>
      </div>
      <p class="small">Секреты хранятся в localStorage этого браузера.</p>
    </div>

    <div class="card">
      <h2>Состояние сервера</h2>
      <div class="row" style="align-items:center;">
        <button id="btnHealth">healthz</button>
        <span id="healthStatus" class="badge hidden">…</span>
        <button id="btnReady">readyz</button>
        <span id="readyStatus" class="badge hidden">…</span>
        <button id="btnInfo">/v1/info</button>
        <button id="btnMetrics">/metrics</button>
      </div>
      <pre id="infoJson" class="code" style="margin-top:12px;"></pre>
    </div>

    <div class="card">
      <h2>Secrets — список</h2>
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>Префикс имени</label>
          <input id="sPrefix" type="text" placeholder="например, prod/">
        </div>
        <div>
          <label>Limit</label>
          <input id="sLimit" type="number" min="1" max="1000" value="50">
        </div>
        <div>
          <label>Offset</label>
          <input id="sOffset" type="number" min="0" value="0">
        </div>
        <div style="align-self:flex-end;">
          <button id="sReload">Обновить</button>
          <button id="sNext" class="ghost" disabled>Далее</button>
        </div>
      </div>
      <table class="table" style="margin-top:10px;">
        <thead>
          <tr>
            <th>name</th><th>ver</th><th>expires</th><th>bytes</th><th>checksum</th><th class="right">действия</th>
          </tr>
        </thead>
        <tbody id="secretsTableBody"></tbody>
      </table>
      <div class="row">
        <div>
          <label>Версия для чтения (необязательно)</label>
          <input id="sVersion" type="number" min="1" placeholder="например, 2">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Secrets — создание/обновление</h2>
      <div class="grid">
        <div>
          <label>Название (path)</label>
          <input id="cName" type="text" placeholder="env/app/secret">
        </div>
        <div>
          <label>Encoding</label>
          <select id="cEncoding">
            <option value="utf-8">utf-8</option>
            <option value="base64">base64</option>
          </select>
        </div>
        <div style="grid-column: 1 / span 2;">
          <label>Значение</label>
          <textarea id="cValue" placeholder="значение секрета"></textarea>
        </div>
        <div>
          <label>Labels (JSON)</label>
          <textarea id="cLabels" placeholder='{"team":"secops"}'></textarea>
        </div>
        <div>
          <label>Expires (UTC)</label>
          <input id="cExpires" type="datetime-local">
        </div>
        <div style="align-self:flex-end;">
          <button id="createSecret" class="primary">Создать</button>
        </div>
      </div>
      <div class="grid">
        <div>
          <h2>Meta</h2>
          <pre id="secretMeta" class="code"></pre>
        </div>
        <div>
          <h2>Value (decoded)</h2>
          <pre id="secretValue" class="code"></pre>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Логи</h2>
      <pre id="log" class="code" style="max-height:220px;"></pre>
    </div>
  </div>

  <script>(() => {
  "use strict";

  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const store = {
    get k() { return "webadmin"; },
    save(cfg) { localStorage.setItem(this.k, JSON.stringify(cfg)); },
    load() {
      try { return JSON.parse(localStorage.getItem(this.k)) || {}; } catch { return {}; }
    }
  };

  const state = {
    cfg: {
      baseUrl: "",
      apiKey: "",
      apiKeyHeader: "X-API-Key",
      jwt: "",
      timeoutMs: 15000,
    },
    offset: 0,
    limit: 50,
    secrets: []
  };

  function applyCfgToForm() {
    $("#baseUrl").value = state.cfg.baseUrl || "";
    $("#apiKey").value = state.cfg.apiKey || "";
    $("#apiKeyHeader").value = state.cfg.apiKeyHeader || "X-API-Key";
    $("#jwt").value = state.cfg.jwt || "";
    $("#timeout").value = state.cfg.timeoutMs || 15000;
  }

  function loadCfg() {
    Object.assign(state.cfg, store.load());
    applyCfgToForm();
  }

  function saveCfgFromForm() {
    state.cfg.baseUrl = $("#baseUrl").value.trim().replace(/\/$/, "");
    state.cfg.apiKey = $("#apiKey").value.trim();
    state.cfg.apiKeyHeader = $("#apiKeyHeader").value.trim() || "X-API-Key";
    state.cfg.jwt = $("#jwt").value.trim();
    state.cfg.timeoutMs = Math.max(1000, parseInt($("#timeout").value, 10) || 15000);
    store.save(state.cfg);
    log("Конфигурация сохранена");
  }

  function headers() {
    const h = { "Accept": "application/json" };
    if ($("#sendContentType").checked) h["Content-Type"] = "application/json";
    if (state.cfg.apiKey) h[state.cfg.apiKeyHeader] = state.cfg.apiKey;
    if (state.cfg.jwt) h["Authorization"] = "Bearer " + state.cfg.jwt;
    h["X-Request-ID"] = cryptoRandom();
    return h;
  }

  function cryptoRandom() {
    const arr = new Uint8Array(16);
    (window.crypto || window.msCrypto).getRandomValues(arr);
    return Array.from(arr).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  async function http(path, opts={}) {
    if (!state.cfg.baseUrl) throw new Error("Не задан Base URL");
    const url = state.cfg.baseUrl + path;
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), state.cfg.timeoutMs);
    const init = Object.assign({ headers: headers(), signal: ctrl.signal }, opts);
    const started = Date.now();
    try {
      const res = await fetch(url, init);
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }
      const ms = Date.now() - started;
      logHttp(res, ms, init, data);
      if (!res.ok) {
        const msg = typeof data === "object" && data && data.error ? data.error : res.statusText;
        const err = new Error(`HTTP ${res.status} ${msg}`);
        err.response = res; err.data = data;
        throw err;
      }
      return data;
    } catch (e) {
      if (e.name === "AbortError") throw new Error("Таймаут запроса");
      throw e;
    } finally {
      clearTimeout(t);
    }
  }

  function log(msg) {
    const ts = new Date().toISOString();
    const line = `[${ts}] ${msg}\n`;
    const el = $("#log");
    el.textContent += line;
    el.scrollTop = el.scrollHeight;
  }

  function logHttp(res, ms, reqInit, body) {
    const rid = res.headers.get("X-Request-ID") || "-";
    const entry = {
      status: res.status,
      url: res.url,
      ms,
      reqId: rid
    };
    log(`HTTP ${entry.status} ${entry.url} (${entry.ms} ms) req_id=${entry.reqId}`);
  }

  function setBadge(el, ok, textOk="OK", textErr="ERR") {
    el.classList.remove("ok", "err", "warn");
    if (ok) { el.classList.add("ok"); el.textContent = textOk; }
    else { el.classList.add("err"); el.textContent = textErr; }
  }

  // Health
  async function checkHealth() {
    try {
      const h = await http("/healthz");
      $("#healthStatus").classList.remove("hidden");
      setBadge($("#healthStatus"), h.status === "ok", "ok", "err");
    } catch (e) {
      $("#healthStatus").classList.remove("hidden");
      setBadge($("#healthStatus"), false, "ok", "err");
      log(e.message);
    }
  }
  async function checkReady() {
    try {
      const h = await http("/readyz");
      $("#readyStatus").classList.remove("hidden");
      setBadge($("#readyStatus"), h.status === "ready", "ready", "not-ready");
    } catch (e) {
      $("#readyStatus").classList.remove("hidden");
      setBadge($("#readyStatus"), false, "ready", "not-ready");
      log(e.message);
    }
  }
  async function getInfo() {
    try {
      const d = await http("/v1/info");
      $("#infoJson").textContent = JSON.stringify(d, null, 2);
    } catch (e) {
      $("#infoJson").textContent = e.message;
    }
  }

  // Secrets
  async function listSecrets() {
    const prefix = $("#sPrefix").value.trim() || undefined;
    const limit = parseInt($("#sLimit").value, 10) || 50;
    const offset = parseInt($("#sOffset").value, 10) || 0;
    const qs = new URLSearchParams();
    if (prefix) qs.set("prefix", prefix);
    qs.set("limit", String(limit));
    qs.set("offset", String(offset));
    const data = await http(`/v1/secrets?${qs.toString()}`);
    const tbody = $("#secretsTableBody");
    tbody.innerHTML = "";
    (data.items || []).forEach(item => {
      const tr = document.createElement("tr");
      const ex = item.expires_at ? new Date(item.expires_at).toISOString() : "";
      tr.innerHTML = `
        <td class="mono">${item.name}</td>
        <td>${item.version}</td>
        <td><span class="small">${ex}</span></td>
        <td class="small">${item.bytes}</td>
        <td class="small">${item.checksum.slice(0,8)}…</td>
        <td class="right">
          <button class="ghost" data-act="meta" data-name="${item.name}">meta</button>
          <button class="ghost" data-act="get" data-name="${item.name}">value</button>
          <button class="ghost" data-act="rotate" data-name="${item.name}">rotate</button>
          <button class="danger" data-act="del" data-name="${item.name}">delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    $("#sNext").disabled = !data.next_offset;
    $("#sNext").dataset.next = data.next_offset || "";
  }

  async function showSecretMeta(name) {
    try {
      const v = $("#sVersion").value ? Number($("#sVersion").value) : undefined;
      const qs = v ? `?version=${v}` : "";
      const d = await http(`/v1/secrets/${encodeURIComponent(name)}${qs}`);
      $("#secretMeta").textContent = JSON.stringify(d, null, 2);
    } catch (e) {
      $("#secretMeta").textContent = e.message;
    }
  }

  async function showSecretValue(name) {
    try {
      const v = $("#sVersion").value ? Number($("#sVersion").value) : undefined;
      const qs = v ? `?version=${v}` : "";
      const d = await http(`/v1/secrets/${encodeURIComponent(name)}/value${qs}`);
      $("#secretValue").textContent = d.value ? atob(d.value) : "";
    } catch (e) {
      $("#secretValue").textContent = e.message;
    }
  }

  async function createSecret() {
    const name = $("#cName").value.trim();
    const value = $("#cValue").value;
    const encoding = $("#cEncoding").value;
    const labelsRaw = $("#cLabels").value.trim();
    const expires = $("#cExpires").value.trim();
    if (!name || !value) return alert("name и value обязательны");

    let labels = {};
    if (labelsRaw) {
      try { labels = JSON.parse(labelsRaw); } catch { return alert("labels должен быть JSON"); }
    }
    const payload = {
      name,
      value: encoding === "base64" ? btoa(value) : value,
      encoding,
      labels,
      expires_at: expires ? new Date(expires).toISOString() : null
    };
    const res = await http("/v1/secrets", { method: "POST", body: JSON.stringify(payload) });
    $("#secretMeta").textContent = JSON.stringify(res, null, 2);
    await listSecrets();
  }

  async function rotateSecret(name, rewrap=false) {
    if (rewrap) {
      const res = await http(`/v1/secrets/${encodeURIComponent(name)}/rotate`, { method: "POST", body: JSON.stringify({ rewrap: true }) });
      $("#secretMeta").textContent = JSON.stringify(res, null, 2);
      return;
    }
    const newVal = prompt("Новое значение секрета (будет отправлено как utf-8). Оставьте пустым для отмены.");
    if (!newVal && newVal !== "") return;
    const payload = { new_value: newVal, encoding: "utf-8", rewrap: false };
    const res = await http(`/v1/secrets/${encodeURIComponent(name)}/rotate`, { method: "POST", body: JSON.stringify(payload) });
    $("#secretMeta").textContent = JSON.stringify(res, null, 2);
  }

  async function deleteSecret(name) {
    const purge = confirm("Полное удаление (purge)? ОК=purge, Отмена=soft delete.");
    const qs = purge ? "?purge=true" : "";
    await http(`/v1/secrets/${encodeURIComponent(name)}${qs}`, { method: "DELETE" });
    await listSecrets();
  }

  // Events
  function bindEvents() {
    $("#saveCfg").addEventListener("click", saveCfgFromForm);
    $("#btnHealth").addEventListener("click", checkHealth);
    $("#btnReady").addEventListener("click", checkReady);
    $("#btnInfo").addEventListener("click", getInfo);

    $("#sReload").addEventListener("click", listSecrets);
    $("#sNext").addEventListener("click", async () => {
      const next = $("#sNext").dataset.next;
      if (!next) return;
      $("#sOffset").value = String(next);
      await listSecrets();
    });
    $("#secretsTableBody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const act = btn.dataset.act;
      const name = btn.dataset.name;
      if (act === "meta") await showSecretMeta(name);
      if (act === "get") await showSecretValue(name);
      if (act === "rotate") {
        const mode = confirm("ОК=rewrap (перепаковать ключ), Отмена=rotate (новое значение)");
        await rotateSecret(name, mode);
      }
      if (act === "del") await deleteSecret(name);
    });

    $("#createSecret").addEventListener("click", createSecret);
    $("#btnMetrics").addEventListener("click", () => {
      const u = $("#baseUrl").value.trim().replace(/\/$/, "");
      if (!u) return alert("Не задан Base URL");
      window.open(u + "/metrics", "_blank");
    });
  }

  // Init
  function init() {
    loadCfg();
    bindEvents();
  }

  document.addEventListener("DOMContentLoaded", init);
})();</script>
</body>
</html>
