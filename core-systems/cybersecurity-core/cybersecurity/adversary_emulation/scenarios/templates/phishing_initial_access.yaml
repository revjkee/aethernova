# cybersecurity-core/cybersecurity/adversary_emulation/scenarios/templates/phishing_initial_access.yaml
# Status: production
# Purpose: Safe, industrial-grade template for emulating phishing-based initial access
# TLP: mark according to FIRST TLP 2.0 (TLP:CLEAR if intended for public sharing)
# References in 'references' are authoritative and allow independent verification.

schema_version: "1.1"

metadata:
  id: "phishing-initial-access-v1"
  name: "Phishing Initial Access (Attachment/Link) — ATT&CK-aligned"
  version: "1.0.0"
  tlp: "TLP:CLEAR"  # Use TLP:CLEAR per FIRST TLP 2.0 if sharing publicly
  owners:
    - "Aethernova Cybersecurity Core"
  description: >
    Emulate adversary initial access via phishing with safe artefacts and
    measurable telemetry. Supports two delivery variants: spearphishing
    attachment and spearphishing link. Uses harmless payloads (e.g., EICAR
    test string or benign macro-disabled docs) and read-only PowerShell.
  assumptions:
    - "Controlled test environment with explicit authorization."
    - "No real sensitive recipients; only test mailboxes."
    - "Endpoints have auditing enabled as per 'logging.requirements'."
  compliance:
    tlp_standard: "FIRST TLP 2.0"
  references:
    mitre_attack:
      - id: "T1566"
        name: "Phishing"
        url: "https://attack.mitre.org/techniques/T1566/"
      - id: "T1566.001"
        name: "Spearphishing Attachment"
        url: "https://attack.mitre.org/techniques/T1566/001/"
      - id: "T1204"
        name: "User Execution"
        url: "https://attack.mitre.org/techniques/T1204/"
      - id: "T1204.002"
        name: "Malicious File"
        url: "https://d3fend.mitre.org/offensive-technique/attack/T1204.002/"
      - id: "T1059.001"
        name: "Command and Scripting Interpreter: PowerShell"
        url: "https://attack.mitre.org/techniques/T1059/001/"
    tlp:
      - name: "FIRST TLP 2.0"
        url: "https://www.first.org/tlp/"
      - name: "CISA TLP 2.0 User Guide"
        url: "https://www.cisa.gov/sites/default/files/2023-02/tlp-2-0-user-guide_508c.pdf"
    logging:
      - name: "PowerShell Script Block Logging (Event ID 4104)"
        url: "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows"
      - name: "Command line process auditing / Event ID 4688"
        url: "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing"
    email_ops:
      - name: "Message trace in Exchange Online (new EAC)"
        url: "https://learn.microsoft.com/en-us/exchange/monitoring/trace-an-email-message/message-trace-modern-eac"
      - name: "Message trace in Defender portal"
        url: "https://learn.microsoft.com/en-us/defender-office-365/message-trace-defender-portal"
    office_hardening:
      - name: "Block macros from running in Office files from the Internet"
        url: "https://learn.microsoft.com/en-us/microsoft-365-apps/security/internet-macros-blocked"
      - name: "ASR rule: Block Office apps from creating child processes"
        url: "https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference"
    safe_payloads:
      - name: "EICAR Anti-Malware Test File"
        url: "https://www.eicar.org/download-anti-malware-testfile/"

scope:
  objective: >
    Validate detection and response for phishing-driven initial access,
    including delivery, user execution, and initial interpreter abuse, without
    using harmful code.
  out_of_scope:
    - "Real malware"
    - "Exfiltration or C2"
    - "Persistence beyond benign artefacts"
  constraints:
    - "Do not target external domains."
    - "Only preapproved test recipients used."

mitre_alignment:
  tactics:
    - "TA0001: Initial Access"
    - "TA0002: Execution"
  techniques:
    - "T1566: Phishing"
    - "T1566.001: Spearphishing Attachment"
    - "T1204: User Execution"
    - "T1204.002: Malicious File"
    - "T1059.001: PowerShell (optional, safe commands only)"

logging:
  requirements:
    windows:
      - event_id: 4688
        channel: "Security"
        description: "Process creation with command line; enable policy to include command line."
        reference: "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing"
      - event_id: 4104
        channel: "Microsoft-Windows-PowerShell/Operational"
        description: "Script Block Logging for PowerShell."
        reference: "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows"
    o365:
      message_trace: true
      references:
        - "https://learn.microsoft.com/en-us/exchange/monitoring/trace-an-email-message/message-trace-modern-eac"
        - "https://learn.microsoft.com/en-us/defender-office-365/message-trace-defender-portal"

preconditions:
  infra:
    smtp_host: "<set-your-smtp-host>"
    sender_address: "redteam+test@yourlab.local"
    test_recipients:
      - "blue1@yourlab.local"
      - "blue2@yourlab.local"
  endpoints:
    os: "Windows 10/11 test VMs"
    audit_policies:
      - "Audit Process Creation enabled; include command line"
      - "PowerShell Script Block Logging enabled"
  controls_context:
    office_hardening_expected:
      block_internet_macros: true
      asr_block_office_child_processes: true
    references:
      - "https://learn.microsoft.com/en-us/microsoft-365-apps/security/internet-macros-blocked"
      - "https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference"

parameters:
  campaign_id: "PHA-001"
  subject_template: "[ACME] Q3 benefits update"
  lure_type: "attachment|link"   # choose one for a run
  attachment:
    filename: "Benefits_Review.pdf.txt"  # harmless text disguised but not executable
    use_eicar_test_string: false         # set true only if you intend to validate AV response
  link:
    url: "https://intra.yourlab.local/phishing-sim/landing"  # benign landing page under your control
  ps_safe_commands:
    - "Get-ComputerInfo | Out-Null"
    - "Get-Process | Select-Object -First 1 | Out-Null"

delivery_variants:
  - id: "variant-attachment"
    title: "Spearphishing Attachment (benign)"
    attack_mapping:
      - "T1566.001"
      - "T1204.002"
    description: >
      Send an email with a benign attachment to simulate spearphishing with
      attachment. Optionally embed EICAR test string to validate AV pipelines.
    steps:
      - id: "deliver-mail"
        action: "Send email with benign attachment"
        evidence:
          o365_message_trace: true
        notes:
          - "This simulates delivery under T1566.001 Spearphishing Attachment."
        references:
          - "https://attack.mitre.org/techniques/T1566/001/"
          - "https://d3fend.mitre.org/offensive-technique/attack/T1204.002/"
      - id: "user-open"
        action: "User opens attachment (manual or scripted user simulation)"
        evidence:
          windows_events:
            - 4688
        notes:
          - "Represents User Execution (T1204/T1204.002)."
        references:
          - "https://attack.mitre.org/techniques/T1204/"
  - id: "variant-link"
    title: "Spearphishing Link (benign)"
    attack_mapping:
      - "T1566"
    description: >
      Send an email containing a benign link to a controlled landing page to
      simulate click-through behavior.
    steps:
      - id: "deliver-mail"
        action: "Send email with benign link"
        evidence:
          o365_message_trace: true
        references:
          - "https://attack.mitre.org/techniques/T1566/"
      - id: "user-click"
        action: "User clicks link; landing logs HTTP GET"
        evidence:
          web_server_logs: true

execution_optional:
  title: "Optional safe interpreter use (PowerShell)"
  when: "Only if policy allows benign PowerShell execution on test host."
  mapping:
    - "T1059.001"
  steps:
    - id: "ps-safe"
      action: "Execute read-only PowerShell commands"
      commands: "@parameters.ps_safe_commands"
      evidence:
        windows_events:
          - 4688
          - 4104
      references:
        - "https://attack.mitre.org/techniques/T1059/001/"
        - "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows"

artefacts_and_evidence:
  email:
    - "Message Trace record showing delivery status"
  filesystem:
    - "Downloaded benign attachment (if user saved it)"
  windows_events:
    - "4688 process creation for viewer/editor"
    - "4104 script block (if PowerShell optional step executed)"
  network:
    - "HTTP access logs for landing page (variant-link)"
  notes:
    - "T1566.001 page explicitly calls out monitoring new files from spearphishing attachments (DS0022)."
  references:
    - "https://attack.mitre.org/techniques/T1566/001/"

detection_guidance:
  analytics:
    - id: "win-proc-office-child"
      description: "Alert when Office apps spawn unusual child processes"
      dependency: "4688 with command line"
      mitigations_context: "ASR block Office creating child processes"
      references:
        - "https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference"
        - "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing"
    - id: "ps-scriptblock"
      description: "Alert on suspicious PowerShell script block content"
      dependency: "4104 Script Block Logging"
      references:
        - "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows"
  validation:
    - "Verify detection fired for simulated action or was prevented by ASR/macro policy."
    - "Correlate Message Trace with endpoint telemetry timestamps."

office_security_controls_expected:
  macros:
    policy: "Block macros from running in Office files from the Internet (MOTW)"
    reference: "https://learn.microsoft.com/en-us/microsoft-365-apps/security/internet-macros-blocked"
  asr:
    rule: "Block all Office applications from creating child processes"
    reference: "https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference"

safety:
  legal_and_ethics:
    - "Run only with written authorization."
    - "Use test recipients and isolated hosts."
  payload_policy:
    - "Use benign files; EICAR string only if AV validation is intended."
    - "No exploitation or persistence."
  tlp:
    marking: "TLP:CLEAR by default for this template"
    references:
      - "https://www.first.org/tlp/"

success_criteria:
  delivery:
    - "Message Trace shows Delivered or actioned by security filter."
  user_action:
    - "Click/open recorded or prevented per policy."
  telemetry:
    - "4688 present with relevant process name and command line."
    - "4104 present if PowerShell step executed."
  detection:
    - "At least one analytic fired or control prevented action."

cleanup:
  email:
    - "Purge test emails from mailboxes after validation."
  files:
    - "Delete downloaded benign attachments from test hosts."
  logs:
    - "Tag and archive test run identifiers in SIEM for future audits."

metrics:
  time_to_detect_seconds: null
  time_to_triad_seconds: null
  prevented_by_policy: true
  false_positive_rate: null
  notes: "Populate after each run."

runbook:
  mail_delivery_example:
    tool: "Any SMTP client or approved email API"
    safe_mode: true
    note: "Do not spoof external domains; align with SPF/DKIM/DMARC in test tenant."
    references:
      - "https://datatracker.ietf.org/doc/html/rfc7208"
      - "https://datatracker.ietf.org/doc/html/rfc6376"
      - "https://datatracker.ietf.org/doc/html/rfc7489"
  verification:
    - "Use Exchange Online Message Trace to confirm delivery path."
    - "Correlate with Windows event logs and web server access logs."

notes:
  environment_specific: "Не могу подтвердить это — параметры SMTP, домены и политики зависят от вашего стенда; заполните placeholders."
