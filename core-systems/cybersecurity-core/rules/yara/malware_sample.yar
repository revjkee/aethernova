/*
  File: malware_sample.yar
  Project: cybersecurity-core/rules/yara
  Purpose: Industrial-grade generic malware heuristics for PE/ELF/Mach-O
  SPDX-License-Identifier: Apache-2.0

  Notes:
    - No secrets. Families intentionally generalized to reduce brittleness.
    - Designed for triage: high-signal heuristics + packer/entropy indicators.
    - Tune thresholds in environment overlays if needed.
*/

import "pe"
import "elf"
import "macho"
import "dotnet"
import "math"
import "hash"

/* =========================
   PRIVATE BUILDING BLOCKS
   ========================= */

private rule AETHER_Is_PE_Executable {
  condition:
    uint16(0) == 0x5A4D and pe.is_pe
}

private rule AETHER_Is_ELF_Executable {
  condition:
    elf.type in (elf.ET_EXEC, elf.ET_DYN)
}

private rule AETHER_Is_MachO_Executable {
  condition:
    macho.number_of_commands > 0
}

private rule AETHER_PE_HighEntropyExecSection {
  condition:
    AETHER_Is_PE_Executable and
    for any i in (0 .. pe.number_of_sections - 1) :
      (
        pe.sections[i].characteristics & pe.SECTION_MEM_EXECUTE != 0 and
        math.entropy(pe.sections[i].raw_data_offset, pe.sections[i].raw_data_size) > 7.2
      )
}

private rule AETHER_PE_HasOverlay {
  condition:
    AETHER_Is_PE_Executable and pe.overlay.size > 0
}

private rule AETHER_Packer_UPX {
  strings:
    $s1 = "UPX!" ascii
    $s2 = "UPX0" ascii
    $s3 = "UPX1" ascii
  condition:
    AETHER_Is_PE_Executable and (any of them)
}

private rule AETHER_Packer_MPRESS {
  strings:
    $s1 = "MPRESS1" ascii
    $s2 = "MPRESS2" ascii
  condition:
    AETHER_Is_PE_Executable and (any of them)
}

private rule AETHER_Packer_Themida_VMProtect {
  strings:
    $t1 = "Themida" nocase ascii wide
    $t2 = "VMProtect" nocase ascii wide
  condition:
    AETHER_Is_PE_Executable and (any of ($t*))
}

private rule AETHER_Win_Injection_APIs {
  strings:
    $api1 = "OpenProcess" ascii wide
    $api2 = "VirtualAlloc" ascii wide
    $api3 = "VirtualAllocEx" ascii wide
    $api4 = "VirtualProtect" ascii wide
    $api5 = "WriteProcessMemory" ascii wide
    $api6 = "CreateRemoteThread" ascii wide
    $api7 = "NtQueueApcThread" ascii wide
    $api8 = "SetThreadContext" ascii wide
    $api9 = "ResumeThread" ascii wide
    $api10 = "MapViewOfFile" ascii wide
    $api11 = "CreateToolhelp32Snapshot" ascii wide
  condition:
    AETHER_Is_PE_Executable and 3 of ($api*)
}

private rule AETHER_Win_Networking_APIs {
  strings:
    $n1  = "WinHttpOpen" ascii wide
    $n2  = "WinHttpConnect" ascii wide
    $n3  = "InternetOpenA" ascii wide
    $n4  = "InternetConnectA" ascii wide
    $n5  = "HttpOpenRequestA" ascii wide
    $n6  = "HttpSendRequestA" ascii wide
    $n7  = "WSAStartup" ascii wide
    $ua1 = "User-Agent:" nocase ascii
    $h1  = "HTTP/1.1" ascii
  condition:
    AETHER_Is_PE_Executable and (2 of ($n*) or (1 of ($n*) and any of ($ua1,$h1)))
}

private rule AETHER_Win_Persistence_Artifacts {
  strings:
    $r1 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
    $r2 = "Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii wide
    $sv = "\\SYSTEM\\CurrentControlSet\\Services" ascii wide
    $st = "schtasks" ascii wide
    $wm = "WinMgmt" ascii wide
  condition:
    AETHER_Is_PE_Executable and 2 of ($*)
}

private rule AETHER_Ransomware_Strings {
  strings:
    $vss1 = "vssadmin Delete Shadows" nocase ascii wide
    $vss2 = "vssadmin resize shadowstorage" nocase ascii wide
    $wb1  = "wbadmin delete catalog" nocase ascii wide
    $wb2  = "bcdedit /set {default} recoveryenabled no" nocase ascii wide
    $enc1 = ".locked" ascii
    $enc2 = ".encrypt" ascii
  condition:
    AETHER_Is_PE_Executable and 1 of ($vss*) and (1 of ($wb*) or 1 of ($enc*))
}

private rule AETHER_Generic_Suspicious_Strings {
  strings:
    $c1 = "cmd.exe /c" nocase ascii wide
    $c2 = "powershell -" nocase ascii wide
    $c3 = "WScript.Shell" ascii wide
    $b1 = "/dev/tcp/" ascii
    $b2 = "bash -i >& /dev/tcp/" ascii
  condition:
    (AETHER_Is_PE_Executable or AETHER_Is_ELF_Executable or AETHER_Is_MachO_Executable) and 2 of ($*)
}

private rule AETHER_ELF_Suspicious_APIs {
  strings:
    $e1 = "ptrace" ascii
    $e2 = "LD_PRELOAD" ascii
    $e3 = "dlsym" ascii
    $e4 = "/proc/self/mem" ascii
    $e5 = "libcurl" ascii
  condition:
    AETHER_Is_ELF_Executable and 2 of ($*)
}

private rule AETHER_ELF_HighEntropyExec {
  condition:
    AETHER_Is_ELF_Executable and
    for any i in (0 .. elf.number_of_sections - 1) :
      (
        elf.sections[i].flags & elf.SHF_EXECINSTR != 0 and
        elf.sections[i].size > 0 and
        math.entropy(elf.sections[i].offset, elf.sections[i].size) > 7.2
      )
}

private rule AETHER_MachO_Suspicious {
  strings:
    $m1 = "__PAGEZERO" ascii
    $m2 = "LC_LOAD_DYLIB" ascii
    $m3 = "posix_spawn" ascii
    $m4 = "dlopen" ascii
  condition:
    AETHER_Is_MachO_Executable and 2 of ($m*)
}

/* =========================
   PUBLIC HEURISTICS
   ========================= */

rule AETHERNOVA_Generic_Malware_Windows : malware generic heuristic windows {
  meta:
    id = "AETH-GEN-WIN-0001"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "Generic Windows malware heuristic (injection/network/persistence/packer/entropy)"
    confidence = 80
    false_positives = "Admin tools with injection/network APIs; packed but benign utilities"
    date = "2025-09-02"
    license = "Apache-2.0"
  condition:
    AETHER_Is_PE_Executable and
    (
      3 of (AETHER_Win_Injection_APIs, AETHER_Win_Networking_APIs, AETHER_Win_Persistence_Artifacts, AETHER_Ransomware_Strings, AETHER_PE_HighEntropyExecSection)
      or
      ( (AETHER_Packer_UPX or AETHER_Packer_MPRESS or AETHER_Packer_Themida_VMProtect) and (AETHER_PE_HighEntropyExecSection or AETHER_Win_Injection_APIs) )
      or
      ( AETHER_PE_HasOverlay and (AETHER_Win_Injection_APIs or AETHER_Win_Networking_APIs) )
    )
}

rule AETHERNOVA_Ransomware_Heuristic_Windows : malware ransomware heuristic windows {
  meta:
    id = "AETH-RANSOM-WIN-0002"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "Windows ransomware-like behavior (shadow copy tampering + boot/config hardening)"
    confidence = 85
    false_positives = "Backup/DR scripts with similar commands"
    date = "2025-09-02"
    license = "Apache-2.0"
  condition:
    AETHER_Is_PE_Executable and
    AETHER_Ransomware_Strings and
    (AETHER_Win_Networking_APIs or AETHER_PE_HighEntropyExecSection)
}

rule AETHERNOVA_Generic_Malware_ELF : malware generic heuristic linux {
  meta:
    id = "AETH-GEN-ELF-0003"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "Generic Linux ELF malware heuristic (ptrace/LD_PRELOAD/proc mem + high entropy exec)"
    confidence = 78
    false_positives = "Profilers/debuggers using ptrace; performance agents"
    date = "2025-09-02"
    license = "Apache-2.0"
  condition:
    AETHER_Is_ELF_Executable and
    (
      (AETHER_ELF_Suspicious_APIs and AETHER_Generic_Suspicious_Strings)
      or
      (AETHER_ELF_HighEntropyExec and AETHER_ELF_Suspicious_APIs)
    )
}

rule AETHERNOVA_Generic_Malware_MachO : malware generic heuristic macos {
  meta:
    id = "AETH-GEN-MACHO-0004"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "Generic macOS Mach-O malware heuristic"
    confidence = 70
    false_positives = "Developer tools dynamically loading libs"
    date = "2025-09-02"
    license = "Apache-2.0"
  condition:
    AETHER_Is_MachO_Executable and
    AETHER_MachO_Suspicious and
    AETHER_Generic_Suspicious_Strings
}

/* =========================
   PACKER TAGGING (LOW SEV)
   ========================= */

rule AETHERNOVA_Packed_UPX : tag packer upx {
  meta:
    id = "AETH-PACK-UPX-1001"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "UPX packer indicator"
    severity = "low"
    date = "2025-09-02"
  condition:
    AETHER_Packer_UPX
}

rule AETHERNOVA_Packed_MPRESS : tag packer mpress {
  meta:
    id = "AETH-PACK-MPRESS-1002"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "MPRESS packer indicator"
    severity = "low"
    date = "2025-09-02"
  condition:
    AETHER_Packer_MPRESS
}

rule AETHERNOVA_Packed_Themida_VMProtect : tag packer themida vmprotect {
  meta:
    id = "AETH-PACK-TV-1003"
    version = "1.0"
    author = "Aethernova SecOps"
    description = "Themida/VMProtect packer indicator"
    severity = "low"
    date = "2025-09-02"
  condition:
    AETHER_Packer_Themida_VMProtect
}
