# Chronowatch Core — Business Calendar Template (Industrial Grade)
# ВНИМАНИЕ:
#  - Формат дат/времени: ISO-8601 (YYYY-MM-DD, HH:MM[:SS]).
#  - Часовые пояса: IANA, напр. "Europe/Stockholm".
#  - Все списки времени — локальные относительно timezone.
#  - Не редактируйте поля с пометкой "do not change", если не обновляете схему.

schema:
  name: chronowatch-business-calendar
  version: 1.2.0           # do not change без обновления валидатора
  generated_at: "2025-08-28T12:00:00Z"
  owner: platform-ops
  contact: "platform-ops@your-domain.tld"

defaults:
  timezone: "Europe/Stockholm"
  locale: "sv-SE"          # основная локаль отображения
  week_start: "MON"        # MON|SUN
  currency: "SEK"
  observance_policy: "nearest_weekday" # как сдвигать праздники, если они выпали на выходные
  halfday_threshold_minutes: 240       # порог, когда день считается укороченным
  # глобальные настройки интерпретации CRON (если используются CRON-окна)
  cron:
    timezone: "Europe/Stockholm"
    second_field: false     # CRON: использовать секунды (6 полей) — false по умолчанию

# Якоря для переиспользуемых паттернов
patterns:
  # Стандартная 5-дневная рабочая неделя 09:00–18:00 с обедом
  workweek_5x9: &workweek_5x9
    monday:    [{ start: "09:00", end: "18:00", break: [{ start: "13:00", end: "14:00" }] }]
    tuesday:   [{ start: "09:00", end: "18:00", break: [{ start: "13:00", end: "14:00" }] }]
    wednesday: [{ start: "09:00", end: "18:00", break: [{ start: "13:00", end: "14:00" }] }]
    thursday:  [{ start: "09:00", end: "18:00", break: [{ start: "13:00", end: "14:00" }] }]
    friday:    [{ start: "09:00", end: "17:00", break: [{ start: "13:00", end: "13:30" }] }]
    saturday:  []
    sunday:    []

  # Расширенный режим (дежурства): 24x7 с ночными окнами деградации
  nonstop_24x7_with_degradation: &nonstop_24x7_with_degradation
    monday:    [{ start: "00:00", end: "24:00" }]
    tuesday:   [{ start: "00:00", end: "24:00" }]
    wednesday: [{ start: "00:00", end: "24:00" }]
    thursday:  [{ start: "00:00", end: "24:00" }]
    friday:    [{ start: "00:00", end: "24:00" }]
    saturday:  [{ start: "00:00", end: "24:00" }]
    sunday:    [{ start: "00:00", end: "24:00" }]
    # деградация производительности (например, плановые ETL) — не является закрытием дней
    degradations:
      - name: "nightly-etl"
        days: ["MON","TUE","WED","THU","FRI"]
        start: "02:00"
        end: "03:30"
        impact: "throughput:-20%"

  # Биржевой день NASDAQ-style (пример) — локализуется через timezone рынка
  market_us_regular: &market_us_regular
    pre_open:  { start: "09:00", end: "09:30" }
    regular:   { start: "09:30", end: "16:00" }
    post_close:{ start: "16:00", end: "20:00" }

  # Окна SLA для инцидентов (пример)
  sla_p1_p2_windows: &sla_p1_p2_windows
    P1:
      target_response: "00:05:00"  # 5 минут
      target_resolution: "02:00:00"
      working_calendar: "ops_24x7" # ссылка на календарь ниже
    P2:
      target_response: "00:15:00"
      target_resolution: "04:00:00"
      working_calendar: "ops_24x7"

  # Окна обслуживания
  maintenance_windows_std: &maintenance_windows_std
    - name: "weekly-patch"
      rrule: "FREQ=WEEKLY;BYDAY=SUN;BYHOUR=02;BYMINUTE=00;BYSECOND=00;INTERVAL=1"
      duration: "02:00:00"
      policy: "partial_outage"  # partial_outage | full_outage | read_only
    - name: "monthly-security"
      rrule: "FREQ=MONTHLY;BYDAY=MO;BYSETPOS=1;BYHOUR=01;BYMINUTE=00;BYSECOND=00"
      duration: "01:30:00"
      policy: "full_outage"

# Праздники и исключения — базовые каталоги (переиспользуются календарями)
catalogs:
  holidays:
    se:  # Швеция (пример)
      timezone: "Europe/Stockholm"
      rules:
        # Фиксированные
        - name: "New Year"
          date: "2025-01-01"
          type: "public_holiday"
          observance: "nearest_weekday"  # перенести, если выпало на выходной
        - name: "Labour Day"
          date: "2025-05-01"
          type: "public_holiday"
          observance: "exact"

        # Плавающие (пример Пасха + производные)
        - name: "Good Friday"
          rule: "EASTER-2"               # 2 дня до Пасхи
          type: "public_holiday"
          observance: "exact"
        - name: "Easter Monday"
          rule: "EASTER+1"
          type: "public_holiday"
          observance: "exact"

        # Канун Рождества (half-day)
        - name: "Christmas Eve"
          date: "2025-12-24"
          type: "half_day"
          halfday_hours: [{ start: "09:00", end: "13:00" }]

    us:
      timezone: "America/New_York"
      rules:
        - name: "Independence Day"
          date: "2025-07-04"
          type: "public_holiday"
          observance: "nearest_weekday"
        - name: "Thanksgiving"
          rule: "FREQ=YEARLY;BYMONTH=11;BYDAY=TH;BYSETPOS=4"  # четвертый четверг ноября
          type: "public_holiday"
          observance: "exact"

  exceptions:
    # Локальные переносы/исключения (замены рабочих дней)
    se:
      - name: "Midsummer-Eve"
        date: "2025-06-20"
        type: "workday_removed"  # превращаем будний в выходной
      - name: "Q4 Release Freeze"
        period:
          start: "2025-12-18"
          end:   "2026-01-05"
        type: "change_freeze"     # запрет на релизы, но бизнес-часы сохраняются

markets:
  # Пример рынка США (для справки; не обязателен)
  nasdaq:
    timezone: "America/New_York"
    sessions:
      <<: *market_us_regular
    holidays_ref: "catalogs.holidays.us"
    early_close:
      - name: "Day Before Independence Day"
        rule: "FREQ=YEARLY;BYMONTH=7;BYMONTHDAY=3"
        close: "13:00"            # раннее закрытие
    notes: "Session times are local to market timezone."

# Верхнеуровневые календари (рабочие, дежурные, биржевые, поддержки)
calendars:
  # Бизнес-подразделение по умолчанию (Швеция)
  business_se_default:
    description: "Standard business calendar for SE region"
    timezone: "Europe/Stockholm"
    locale: "sv-SE"
    workweek: *workweek_5x9
    holidays_ref: "catalogs.holidays.se"
    exceptions_ref: "catalogs.exceptions.se"
    maintenance_windows: *maintenance_windows_std
    blackout_periods:
      - name: "Black Friday Campaign"
        period: { start: "2025-11-28", end: "2025-12-01" }
        policy: "no_changes"   # запрет изменений/релизов
    sla_windows: *sla_p1_p2_windows

  # Календарь круглосуточной эксплуатации (для SRE/OPS)
  ops_24x7:
    description: "Operations 24x7 calendar with nightly degradations"
    timezone: "Europe/Stockholm"
    workweek: *nonstop_24x7_with_degradation
    holidays_ref: null            # OPS 24x7 не закрывается на праздники
    exceptions_ref: null
    maintenance_windows:
      # для OPS допускаем иные окна
      - name: "daily-index-rotate"
        rrule: "FREQ=DAILY;BYHOUR=01;BYMINUTE=15;BYSECOND=00"
        duration: "00:10:00"
        policy: "partial_outage"
    blackout_periods: []
    sla_windows:
      P1:
        target_response: "00:03:00"
        target_resolution: "01:00:00"
        working_calendar: "ops_24x7"
      P2:
        target_response: "00:10:00"
        target_resolution: "03:00:00"
        working_calendar: "ops_24x7"

  # Биржевой календарь для аналитических расчетов, локализованный под рынок
  market_us_equities:
    description: "US market hours (reference only)"
    timezone: "America/New_York"
    market_ref: "markets.nasdaq"
    # Если нужно вводить локальные исключения:
    exceptions:
      - name: "Severe Weather Closure"
        date: "2025-02-10"
        type: "market_closed"

# Привязки сервисов/команд к календарям (routing)
bindings:
  services:
    - name: "chronowatch-core-api"
      calendar: "business_se_default"
      rollout_policy:
        allowed_windows:
          # CRON соответствует defaults.cron.timezone если не указан "tz"
          - name: "evening-rolling"
            cron: "0 19 * * MON-FRI"     # каждый будний в 19:00
            duration: "01:00:00"
          - name: "sunday-maintenance"
            cron: "0 2 * * SUN"
            duration: "02:00:00"
            tz: "Europe/Stockholm"
        change_freeze_respect: true
        require_two_person_review: true
        max_parallel_zones: 1
    - name: "chronowatch-batch-etl"
      calendar: "ops_24x7"
      rollout_policy:
        allowed_windows:
          - name: "nightly-run"
            cron: "0 1 * * *"
            duration: "03:00:00"
        degrade_overlap_ok: true

  teams:
    - name: "payments"
      primary_calendar: "business_se_default"
      oncall_calendar: "ops_24x7"
      escalation:
        p1: { notify_within: "00:02:00", channels: ["pagerduty","sms"] }
        p2: { notify_within: "00:10:00", channels: ["pagerduty","slack"] }

validation:
  # Правила валидации конфигурации на стороне Chronowatch Core
  timezone_must_be_valid: true
  dates_must_be_iso8601: true
  ensure_rrule_valid: true
  ensure_cron_valid: true
  ensure_no_overlap:
    # не пересекать blackout с maintenance (или явно разрешить)
    blackout_vs_maintenance: "error"   # error|warn|ignore
  require_owner_for_calendar: true
  deny_past_edit_days: 30              # запрет редактировать прошедшие периоды глубже X дней

metadata:
  audit:
    created_by: "init-template"
    last_modified_by: "init-template"
    reason: "Initial industrial template"
  tags:
    - "prod-ready"
    - "gdpr"
    - "i18n"
