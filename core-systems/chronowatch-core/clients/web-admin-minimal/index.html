<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Chronowatch Admin (Minimal)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <!-- Строгая, но практичная CSP для single-file SPA -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'none'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; img-src 'self' data:; connect-src 'self' https: http:; script-src 'self'; style-src 'self' 'unsafe-inline'; upgrade-insecure-requests">
  <meta name="color-scheme" content="light dark">
  <style>
    /* -------------------- Базовая тема и адаптив -------------------- */
    :root {
      --bg: #0b0f14;
      --panel: #11161c;
      --muted: #9aa4af;
      --text: #e8eef5;
      --primary: #4da3ff;
      --primary-700: #2d7bd1;
      --red: #ff5d5d;
      --green: #2ecc71;
      --yellow: #ffb020;
      --border: #1f2a36;
      --ok: #1db954;
      --warn: #ffc107;
    }
    :root.light {
      --bg: #f7f9fc;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --primary: #2563eb;
      --primary-700: #1d4ed8;
      --red: #dc2626;
      --green: #16a34a;
      --yellow: #d97706;
      --border: #e5e7eb;
      --ok: #16a34a;
      --warn: #d97706;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: var(--primary); text-decoration: none; }
    .app {
      display: grid;
      grid-template-rows: 56px 1fr;
      grid-template-columns: 240px 1fr;
      grid-template-areas: "topbar topbar" "sidebar main";
      height: 100dvh;
    }
    header.topbar {
      grid-area: topbar;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky; top: 0;
      z-index: 10;
    }
    header .brand {
      display: flex; align-items: center; gap: 12px;
      font-weight: 600;
    }
    header .brand svg { width: 22px; height: 22px; }
    header .actions { display: flex; gap: 8px; align-items: center; }
    aside.sidebar {
      grid-area: sidebar;
      border-right: 1px solid var(--border);
      background: var(--panel);
      padding: 12px;
      display: flex; flex-direction: column; gap: 8px;
    }
    aside .section-title { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin: 8px 4px; }
    .nav-btn {
      width: 100%;
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px;
      background: transparent; color: var(--text);
      border: 1px solid transparent; cursor: pointer;
    }
    .nav-btn[data-active="true"] { background: rgba(77,163,255,.12); border-color: var(--border); }
    main {
      grid-area: main; padding: 16px; min-width: 0;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px; padding: 16px;
    }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .filters { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .row { display: flex; align-items: center; gap: 8px; }
    .input, .select {
      appearance: none;
      background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 12px; height: 36px;
    }
    .input::placeholder { color: var(--muted); }
    .btn {
      height: 36px; padding: 0 12px; border-radius: 10px; border: 1px solid var(--border);
      background: rgba(77,163,255,.12); color: var(--primary); cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary-700); }
    .btn.warn { background: rgba(255,176,32,.14); color: var(--yellow); }
    .btn.danger { background: rgba(255,93,93,.12); color: var(--red); }
    .btn.ghost { background: transparent; color: var(--text); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    th { font-size: 12px; letter-spacing: .04em; text-transform: uppercase; color: var(--muted); }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
    .pill.ok { color: var(--ok); background: rgba(29,185,84,.12); }
    .pill.warn { color: var(--warn); background: rgba(217,119,6,.12); }
    .pill.muted { color: var(--muted); }
    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .k { color: var(--muted); }
    .pagination { display: flex; gap: 8px; align-items: center; justify-content: flex-end; margin-top: 10px; }
    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.three { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .section { display: grid; gap: 8px; }
    .label { font-size: 12px; color: var(--muted); }
    dialog.modal {
      border: 1px solid var(--border); border-radius: 16px; background: var(--panel); color: var(--text);
      padding: 0; width: min(880px, calc(100vw - 24px));
    }
    .modal header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal .content { padding: 16px; }
    .modal .footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
    .toast-wrap {
      position: fixed; right: 16px; bottom: 16px; display: grid; gap: 8px; z-index: 50;
    }
    .toast { background: var(--panel); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 12px 14px; border-radius: 10px; min-width: 280px; }
    .toast.err { border-left-color: var(--red); }
    .skeleton { display: inline-block; height: 10px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent); border-radius: 6px; animation: shimmer 1.25s infinite; }
    @keyframes shimmer { 0%{background-position:-200px 0}100%{background-position:200px 0} }
    @media (max-width: 920px) {
      .app { grid-template-columns: 1fr; grid-template-areas: "topbar" "main"; }
      aside.sidebar { display: none; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header class="topbar" role="banner">
    <div class="brand" aria-label="Chronowatch Admin">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" opacity=".4"></circle>
        <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path>
      </svg>
      <span>Chronowatch Admin</span>
      <span id="envBadge" class="pill muted" title="Текущее окружение">env: local</span>
    </div>
    <div class="actions" role="group" aria-label="Действия">
      <button id="btnConfig" class="btn ghost" aria-haspopup="dialog">Config</button>
      <button id="btnTheme" class="btn ghost" aria-pressed="false" title="Сменить тему">Тема</button>
      <button id="btnCreate" class="btn primary">Создать таймер</button>
    </div>
  </header>

  <aside class="sidebar" role="navigation" aria-label="Навигация">
    <div class="section-title">Разделы</div>
    <button class="nav-btn" data-route="timers" data-active="true">
      <span>Таймеры</span>
    </button>
  </aside>

  <main role="main">
    <section class="panel" aria-labelledby="timers-title">
      <div class="toolbar">
        <h2 id="timers-title" style="margin:0;font-size:16px;">Таймеры</h2>
        <div class="filters">
          <input id="fSearch" class="input" type="search" placeholder="Поиск по имени...">
          <select id="fState" class="select" title="Состояние">
            <option value="">state:* </option>
            <option>enabled</option>
            <option>paused</option>
            <option>disabled</option>
          </select>
          <select id="fKind" class="select" title="Тип">
            <option value="">kind:* </option>
            <option>cron</option>
            <option>interval</option>
            <option>oneoff</option>
          </select>
          <select id="fLimit" class="select" title="Записей на страницу">
            <option>10</option><option selected>25</option><option>50</option><option>100</option>
          </select>
          <button id="btnRefresh" class="btn">Обновить</button>
        </div>
      </div>

      <div class="table-wrap" style="overflow:auto;">
        <table aria-describedby="timers-title">
          <thead>
          <tr>
            <th>Имя</th>
            <th>Тип</th>
            <th>Состояние</th>
            <th>План</th>
            <th>Следующее</th>
            <th>Обновлен</th>
            <th style="width:260px;">Действия</th>
          </tr>
          </thead>
          <tbody id="tblTimers">
          <tr><td colspan="7" class="muted">Нет данных</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button id="btnPrev" class="btn" disabled>Назад</button>
        <span id="pageInfo" class="muted">0–0 из 0</span>
        <button id="btnNext" class="btn">Вперед</button>
      </div>
    </section>
  </main>
</div>

<!-- Диалог конфигурации -->
<dialog id="dlgConfig" class="modal" aria-label="Конфигурация">
  <header><strong>Конфигурация</strong><button data-close class="btn ghost">Закрыть</button></header>
  <div class="content grid two">
    <div class="section">
      <label class="label" for="cfgApi">API base URL</label>
      <input id="cfgApi" class="input" placeholder="https://api.example.com">
      <small class="muted">Без завершающего слеша. Пример: https://api.example.com</small>
    </div>
    <div class="section">
      <label class="label" for="cfgTenant">X-Tenant-Id (UUID)</label>
      <input id="cfgTenant" class="input" placeholder="00000000-0000-0000-0000-000000000000">
    </div>
    <div class="section">
      <label class="label" for="cfgActor">X-Actor</label>
      <input id="cfgActor" class="input" placeholder="web-admin">
    </div>
    <div class="section">
      <label class="label" for="cfgToken">Bearer Token</label>
      <input id="cfgToken" class="input" type="password" autocomplete="off" placeholder="JWT / OAuth2 token">
      <label style="display:flex;gap:8px;align-items:center;margin-top:6px;"><input type="checkbox" id="cfgRemember"> <span>Запомнить в этом браузере</span></label>
      <small class="muted">По умолчанию секрет хранится только в памяти вкладки.</small>
    </div>
    <div class="section">
      <label class="label">Среда</label>
      <select id="cfgEnv" class="select">
        <option value="local">local</option>
        <option value="staging">staging</option>
        <option value="prod">prod</option>
      </select>
    </div>
  </div>
  <div class="footer">
    <button data-close class="btn">Отмена</button>
    <button id="cfgSave" class="btn primary">Сохранить</button>
  </div>
</dialog>

<!-- Диалог создания/редактирования -->
<dialog id="dlgEdit" class="modal" aria-label="Таймер">
  <header><strong id="dlgEditTitle">Создать таймер</strong><button data-close class="btn ghost">Закрыть</button></header>
  <form id="formTimer" class="content grid two" method="dialog">
    <input type="hidden" id="tId">
    <div class="section">
      <label class="label" for="tName">Имя</label>
      <input id="tName" class="input" required maxlength="256" placeholder="report-nightly">
    </div>
    <div class="section">
      <label class="label" for="tOwner">Владелец</label>
      <input id="tOwner" class="input" maxlength="256" placeholder="team-id">
    </div>
    <div class="section">
      <label class="label" for="tState">Состояние</label>
      <select id="tState" class="select">
        <option>enabled</option><option>paused</option><option>disabled</option>
      </select>
    </div>
    <div class="section">
      <label class="label" for="tKind">Тип</label>
      <select id="tKind" class="select">
        <option>cron</option><option>interval</option><option>oneoff</option>
      </select>
    </div>
    <div class="section">
      <label class="label" for="tCron">Cron</label>
      <input id="tCron" class="input mono" placeholder="*/5 * * * *">
      <small class="muted">5 или 6 полей. Используйте IANA TZ ниже.</small>
    </div>
    <div class="section">
      <label class="label" for="tInterval">Интервал (мс)</label>
      <input id="tInterval" class="input" type="number" min="1000" step="1000" placeholder="60000">
    </div>
    <div class="section">
      <label class="label" for="tAt">Время oneoff (UTC)</label>
      <input id="tAt" class="input" type="datetime-local" step="1" placeholder="2025-08-28T12:00:00">
    </div>
    <div class="section">
      <label class="label" for="tTZ">Таймзона (IANA)</label>
      <input id="tTZ" class="input" value="UTC" placeholder="Europe/Stockholm">
    </div>
    <div class="section">
      <label class="label" for="tStart">Не раньше</label>
      <input id="tStart" class="input" type="datetime-local" step="1">
    </div>
    <div class="section">
      <label class="label" for="tEnd">Не позже</label>
      <input id="tEnd" class="input" type="datetime-local" step="1">
    </div>
    <div class="section">
      <label class="label" for="tJit">Jitter (мс)</label>
      <input id="tJit" class="input" type="number" min="0" step="100">
    </div>
    <div class="section">
      <label class="label" for="tDrift">Max drift (мс)</label>
      <input id="tDrift" class="input" type="number" min="0" step="100">
    </div>
    <div class="section">
      <label class="label" for="tBackfill">Backfill limit</label>
      <input id="tBackfill" class="input" type="number" min="0" step="1">
    </div>
    <div class="section">
      <label class="label" for="tConc">Параллелизм</label>
      <input id="tConc" class="input" type="number" min="1" max="1024" step="1" value="1">
    </div>
    <div class="section">
      <label class="label" for="tDedup">Dedup key</label>
      <input id="tDedup" class="input" maxlength="256">
    </div>
    <div class="section">
      <label class="label" for="tPayload">Payload (JSON)</label>
      <textarea id="tPayload" class="input mono" style="height:120px;" placeholder='{"k":"v"}'></textarea>
    </div>
    <div class="section">
      <label class="label" for="tLabels">Labels (JSON)</label>
      <textarea id="tLabels" class="input mono" style="height:120px;" placeholder='{"env":"staging"}'></textarea>
    </div>
  </form>
  <div class="footer">
    <button data-close class="btn">Отмена</button>
    <button id="btnSave" class="btn primary">Сохранить</button>
  </div>
</dialog>

<!-- Уведомления -->
<div class="toast-wrap" id="toasts" role="status" aria-live="polite"></div>

<script type="module">
  // ------------------------------ Утилиты ------------------------------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
  const uuidv4 = () => URL.createObjectURL(new Blob()).split('/').pop();

  const fmt = {
    dt(s){ if(!s) return ''; const d = new Date(s); return d.toISOString().replace('T',' ').replace('Z','Z'); },
    ago(s){ if(!s) return ''; const t = new Date(s).getTime(); const d=Date.now()-t; const m=Math.floor(d/60000); if(m<1) return 'только что'; if(m<60) return m+' мин назад'; const h=Math.floor(m/60); if(h<24) return h+' ч назад'; const days=Math.floor(h/24); return days+' дн назад'; },
    plan(row){
      if(row.kind==='cron') return row.cron_expr;
      if(row.kind==='interval') return `${row.interval_ms} ms`;
      if(row.kind==='oneoff') return fmt.dt(row.at_time);
      return '';
    }
  };

  // ------------------------------ Тема ------------------------------
  const themeBtn = $('#btnTheme');
  const setTheme = (mode) => {
    if(mode==='light'){ document.documentElement.classList.add('light'); themeBtn.setAttribute('aria-pressed','true'); }
    else { document.documentElement.classList.remove('light'); themeBtn.setAttribute('aria-pressed','false'); }
    localStorage.setItem('cw_theme', mode);
  };
  setTheme(localStorage.getItem('cw_theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'));
  themeBtn.addEventListener('click', ()=> setTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light'));

  // ------------------------------ Тосты ------------------------------
  const toasts = $('#toasts');
  const toast = (msg, kind='ok', timeout=4200) => {
    const el = document.createElement('div');
    el.className = 'toast' + (kind==='err' ? ' err' : '');
    el.textContent = msg;
    toasts.appendChild(el);
    setTimeout(()=>{ el.remove(); }, timeout);
  };

  // ------------------------------ Конфиг/хранилище ------------------------------
  const memory = { token:null };
  const cfg = {
    get api(){ return localStorage.getItem('cw_api') || $('#cfgApi').value || ''; },
    set api(v){ localStorage.setItem('cw_api', v || ''); },
    get tenant(){ return localStorage.getItem('cw_tenant') || $('#cfgTenant').value || ''; },
    set tenant(v){ localStorage.setItem('cw_tenant', v || ''); },
    get actor(){ return localStorage.getItem('cw_actor') || 'web-admin'; },
    set actor(v){ localStorage.setItem('cw_actor', v || 'web-admin'); },
    get env(){ return localStorage.getItem('cw_env') || 'local'; },
    set env(v){ localStorage.setItem('cw_env', v || 'local'); },
    get token(){
      const remembered = localStorage.getItem('cw_token');
      return remembered || memory.token || '';
    },
    set token(v){
      if($('#cfgRemember')?.checked) localStorage.setItem('cw_token', v || '');
      else { localStorage.removeItem('cw_token'); memory.token = v || ''; }
    },
    remember(enabled){ if(!enabled){ localStorage.removeItem('cw_token'); memory.token = $('#cfgToken').value; } }
  };

  // ------------------------------ Клиент API ------------------------------
  class ApiClient {
    constructor(base){ this.base = base.replace(/\/+$/,''); }
    async fetchJson(path, { method='GET', body=null, timeoutMs=20000, idem=true } = {}) {
      if(!this.base) throw new Error('API base URL не задан');
      const url = this.base + path;
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(new DOMException('Timeout','AbortError')), timeoutMs);
      const headers = {
        'Content-Type':'application/json',
        'X-Tenant-Id': cfg.tenant,
        'X-Actor': cfg.actor || 'web-admin',
      };
      if(cfg.token) headers['Authorization'] = 'Bearer ' + cfg.token;
      if(idem) headers['X-Idempotency-Key'] = uuidv4();
      try {
        const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null, signal: ctrl.signal, credentials: 'omit', mode: 'cors' });
        clearTimeout(t);
        if(!res.ok){
          const text = await res.text().catch(()=> '');
          let detail = text;
          try { const j = JSON.parse(text); detail = j.detail || j.message || text; } catch {}
          throw new Error(`HTTP ${res.status}: ${detail || res.statusText}`);
        }
        // 204 -> null
        if(res.status === 204) return null;
        const json = await res.json();
        return json;
      } finally { clearTimeout(t); }
    }
    listTimers({q='', state='', kind='', limit=25, offset=0, sort='created_at:desc'}){
      const p = new URLSearchParams();
      if(q) p.set('q', q);
      if(state) p.set('state', state);
      if(kind) p.set('kind', kind);
      p.set('limit', limit);
      p.set('offset', offset);
      p.set('sort', sort);
      return this.fetchJson(`/v1/timers?${p.toString()}`);
    }
    createTimer(data){ return this.fetchJson('/v1/timers', {method:'POST', body:data}); }
    getTimer(id){ return this.fetchJson(`/v1/timers/${id}`); }
    updateTimer(id,data){ return this.fetchJson(`/v1/timers/${id}`, {method:'PATCH', body:data}); }
    deleteTimer(id, hard=false){ return this.fetchJson(`/v1/timers/${id}?hard=${hard ? 'true':'false'}`, {method:'DELETE'}); }
    pause(id){ return this.fetchJson(`/v1/timers/${id}/pause`, {method:'POST'}); }
    resume(id){ return this.fetchJson(`/v1/timers/${id}/resume`, {method:'POST'}); }
    runNow(id){ return this.fetchJson(`/v1/timers/${id}/run-now`, {method:'POST'}); }
    preview(id, n=3){ return this.fetchJson(`/v1/timers/${id}/preview-next`, {method:'POST', body:{n}}); }
  }
  let api = new ApiClient(cfg.api);

  // ------------------------------ Состояние списка ------------------------------
  const state = { q:'', st:'', kind:'', limit:25, offset:0, total:0, items:[] };

  // ------------------------------ Рендер таблицы ------------------------------
  const tbody = $('#tblTimers');
  function renderRows(items){
    tbody.innerHTML = '';
    if(items.length === 0){
      const tr = document.createElement('tr'); const td = document.createElement('td');
      td.colSpan = 7; td.className = 'muted'; td.textContent = 'Нет данных';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const it of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight:600">${escapeHtml(it.name)}</div>
          <div class="muted mono" style="font-size:12px">${it.schedule_id}</div>
        </td>
        <td><span class="pill">${it.kind}</span></td>
        <td>${renderState(it.state)}</td>
        <td class="mono">${escapeHtml(fmt.plan(it))}</td>
        <td class="mono"><span class="k">—</span></td>
        <td><span title="${fmt.dt(it.updated_at)}">${fmt.ago(it.updated_at)}</span></td>
        <td>
          <div class="row">
            ${it.state==='paused'
              ? `<button class="btn" data-resume="${it.schedule_id}">Resume</button>`
              : `<button class="btn warn" data-pause="${it.schedule_id}">Pause</button>`}
            <button class="btn" data-run="${it.schedule_id}">Run</button>
            <button class="btn" data-edit="${it.schedule_id}">Edit</button>
            <button class="btn danger" data-del="${it.schedule_id}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
      // Загрузим предпросмотр асинхронно
      api.preview(it.schedule_id, 3).then(r=>{
        const dtCell = tr.children[4];
        dtCell.textContent = r.occurrences.length ? r.occurrences.map(fmt.dt).join('  |  ') : '—';
      }).catch(_=>{ /* игнорируем */ });
    }
  }
  function renderState(s){
    if(s==='enabled') return '<span class="pill ok">enabled</span>';
    if(s==='paused') return '<span class="pill warn">paused</span>';
    return '<span class="pill muted">'+s+'</span>';
  }
  function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  // ------------------------------ Загрузка списка ------------------------------
  async function loadList(){
    try{
      $('#btnRefresh').disabled = true;
      const res = await api.listTimers({ q:state.q, state:state.st, kind:state.kind, limit:state.limit, offset:state.offset });
      state.items = res.items || []; state.total = res.total || 0;
      renderRows(state.items);
      const from = state.total === 0 ? 0 : state.offset + 1;
      const to = Math.min(state.offset + state.limit, state.total);
      $('#pageInfo').textContent = `${from}–${to} из ${state.total}`;
      $('#btnPrev').disabled = state.offset <= 0;
      $('#btnNext').disabled = state.offset + state.limit >= state.total;
    } catch(e){
      console.error(e);
      toast(String(e.message || e), 'err');
    } finally {
      $('#btnRefresh').disabled = false;
    }
  }

  // ------------------------------ Обработчики таблицы ------------------------------
  tbody.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const id = btn.dataset.pause || btn.dataset.resume || btn.dataset.run || btn.dataset.edit || btn.dataset.del;
    if(!id) return;

    if(btn.dataset.pause){
      btn.disabled = true;
      try{ await api.pause(id); toast('Таймер приостановлен'); await loadList(); } catch(e){ toast(String(e.message||e),'err'); } finally{ btn.disabled=false; }
    }
    if(btn.dataset.resume){
      btn.disabled = true;
      try{ await api.resume(id); toast('Таймер возобновлен'); await loadList(); } catch(e){ toast(String(e.message||e),'err'); } finally{ btn.disabled=false; }
    }
    if(btn.dataset.run){
      btn.disabled = true;
      try{ await api.runNow(id); toast('Запуск поставлен в очередь'); } catch(e){ toast(String(e.message||e),'err'); } finally{ btn.disabled=false; }
    }
    if(btn.dataset.edit){
      try{
        const row = await api.getTimer(id);
        openEdit(row);
      } catch(e){ toast(String(e.message||e),'err'); }
    }
    if(btn.dataset.del){
      if(!confirm('Удалить таймер? Будет применено мягкое удаление (deleted_at).')) return;
      btn.disabled = true;
      try{ await api.deleteTimer(id, false); toast('Удалено'); await loadList(); } catch(e){ toast(String(e.message||e),'err'); } finally{ btn.disabled=false; }
    }
  });

  // ------------------------------ Фильтры/пагинация ------------------------------
  $('#btnRefresh').addEventListener('click', ()=> { state.offset = 0; loadList(); });
  $('#btnPrev').addEventListener('click', ()=> { state.offset = Math.max(0, state.offset - state.limit); loadList(); });
  $('#btnNext').addEventListener('click', ()=> { state.offset += state.limit; loadList(); });
  $('#fLimit').addEventListener('change', (e)=> { state.limit = parseInt(e.target.value,10)||25; state.offset = 0; loadList(); });
  $('#fState').addEventListener('change', (e)=> { state.st = e.target.value; state.offset = 0; loadList(); });
  $('#fKind').addEventListener('change', (e)=> { state.kind = e.target.value; state.offset = 0; loadList(); });

  let searchTimer=null;
  $('#fSearch').addEventListener('input', (e)=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=>{ state.q = e.target.value.trim(); state.offset = 0; loadList(); }, 300);
  });

  // ------------------------------ Конфигурация ------------------------------
  const dlgConfig = $('#dlgConfig');
  $('#btnConfig').addEventListener('click', ()=> {
    $('#cfgApi').value = cfg.api;
    $('#cfgTenant').value = cfg.tenant;
    $('#cfgActor').value = cfg.actor;
    $('#cfgToken').value = cfg.token;
    $('#cfgRemember').checked = !!localStorage.getItem('cw_token');
    $('#cfgEnv').value = cfg.env;
    dlgConfig.showModal();
  });
  dlgConfig.addEventListener('click', (e)=> { if(e.target.matches('[data-close]')) dlgConfig.close(); });
  $('#cfgSave').addEventListener('click', ()=>{
    cfg.api = $('#cfgApi').value.trim();
    cfg.tenant = $('#cfgTenant').value.trim();
    cfg.actor = $('#cfgActor').value.trim() || 'web-admin';
    cfg.remember($('#cfgRemember').checked);
    cfg.token = $('#cfgToken').value;
    cfg.env = $('#cfgEnv').value;
    api = new ApiClient(cfg.api);
    $('#envBadge').textContent = `env: ${cfg.env}`;
    toast('Конфигурация сохранена');
    dlgConfig.close();
    state.offset = 0; loadList();
  });

  // ------------------------------ Создание/редактирование ------------------------------
  const dlgEdit = $('#dlgEdit');
  const form = $('#formTimer');
  const btnSave = $('#btnSave');
  $('#btnCreate').addEventListener('click', ()=> openEdit());

  function openEdit(row=null){
    $('#dlgEditTitle').textContent = row ? 'Редактировать таймер' : 'Создать таймер';
    $('#tId').value = row?.schedule_id || '';
    $('#tName').value = row?.name || '';
    $('#tOwner').value = row?.owner || '';
    $('#tState').value = row?.state || 'enabled';
    $('#tKind').value = row?.kind || 'cron';
    $('#tCron').value = row?.cron_expr || '';
    $('#tInterval').value = row?.interval_ms ?? '';
    $('#tAt').value = row?.at_time ? toLocalInput(row.at_time) : '';
    $('#tTZ').value = row?.timezone || 'UTC';
    $('#tStart').value = row?.start_after ? toLocalInput(row.start_after) : '';
    $('#tEnd').value = row?.end_before ? toLocalInput(row.end_before) : '';
    $('#tJit').value = row?.jitter_ms ?? '';
    $('#tDrift').value = row?.max_drift_ms ?? '';
    $('#tBackfill').value = row?.backfill_limit ?? '';
    $('#tConc').value = row?.concurrency_limit ?? 1;
    $('#tDedup').value = row?.dedup_key || '';
    $('#tPayload').value = row?.payload ? JSON.stringify(row.payload, null, 2) : '';
    $('#tLabels').value = row?.labels ? JSON.stringify(row.labels, null, 2) : '';
    syncKindUi();
    dlgEdit.showModal();
  }
  dlgEdit.addEventListener('click', (e)=> { if(e.target.matches('[data-close]')) dlgEdit.close(); });
  $('#tKind').addEventListener('change', syncKindUi);
  function syncKindUi(){
    const k = $('#tKind').value;
    $('#tCron').disabled = k!=='cron';
    $('#tInterval').disabled = k!=='interval';
    $('#tAt').disabled = k!=='oneoff';
  }
  function toLocalInput(iso){ const d = new Date(iso); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
  function parseJsonSafe(s){ if(!s.trim()) return {}; try{ return JSON.parse(s); }catch(e){ throw new Error('Неверный JSON'); } }

  btnSave.addEventListener('click', async ()=>{
    try{
      btnSave.disabled = true;
      const id = $('#tId').value || null;
      const kind = $('#tKind').value;
      const payload = {
        name: $('#tName').value.trim(),
        description: null,
        owner: $('#tOwner').value.trim() || null,
        state: $('#tState').value,
        kind,
        cron_expr: kind==='cron' ? ($('#tCron').value.trim() || null) : null,
        interval_ms: kind==='interval' ? (Number($('#tInterval').value)||null) : null,
        at_time: kind==='oneoff' ? toIsoOrNull($('#tAt').value) : null,
        timezone: $('#tTZ').value.trim() || 'UTC',
        start_after: toIsoOrNull($('#tStart').value),
        end_before: toIsoOrNull($('#tEnd').value),
        jitter_ms: numOr($('#tJit').value, 0),
        max_drift_ms: numOr($('#tDrift').value, 0),
        backfill_limit: numOr($('#tBackfill').value, 0),
        concurrency_limit: numOr($('#tConc').value, 1),
        dedup_key: $('#tDedup').value.trim() || null,
        payload: parseJsonSafe($('#tPayload').value),
        labels: parseJsonSafe($('#tLabels').value),
      };
      let res;
      if(id) res = await api.updateTimer(id, payload);
      else res = await api.createTimer(payload);
      toast('Сохранено');
      dlgEdit.close();
      state.offset = 0;
      await loadList();
      // Плавный скролл к строке
      await sleep(50);
      const tr = Array.from(tbody.children).find(tr=>tr.querySelector('.mono')?.textContent.includes(res.schedule_id));
      tr?.scrollIntoView({behavior:'smooth', block:'center'});
    } catch(e){ toast(String(e.message||e), 'err'); }
    finally { btnSave.disabled = false; }
  });
  function toIsoOrNull(v){ if(!v) return null; const d = new Date(v); return isNaN(d.getTime()) ? null : d.toISOString(); }
  function numOr(v, def){ const n = Number(v); return Number.isFinite(n) ? n : def; }

  // ------------------------------ Инициализация ------------------------------
  function initFromStorage(){
    $('#envBadge').textContent = `env: ${cfg.env}`;
    if(!cfg.api || !cfg.tenant) {
      toast('Задайте API URL и Tenant в Config');
    } else {
      loadList();
    }
  }
  initFromStorage();

  // Защита от показа токена в UI
  $('#cfgToken').addEventListener('input', ()=> { /* no-op: never mirror token */ });

  // Навбар
  $$('.nav-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.nav-btn').forEach(b=>b.dataset.active = 'false');
      btn.dataset.active = 'true';
    });
  });

  // Клавиша Esc закрывает открытые диалоги
  document.addEventListener('keydown', (e)=> {
    if(e.key==='Escape'){
      [dlgConfig, dlgEdit].forEach(d=>{ if(d.open) d.close(); });
    }
  });
</script>
</body>
</html>
