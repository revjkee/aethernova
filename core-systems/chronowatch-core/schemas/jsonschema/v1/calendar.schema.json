{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:chronowatch:schemas:calendar:event:v1",
  "title": "ChronoWatch Calendar Event (v1)",
  "description": "Схема события календаря для ChronoWatch Core. Предусмотрены варианты создания (Create) и сохранённого объекта (Stored).",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/EventCreate" },
    { "$ref": "#/$defs/EventStored" }
  ],
  "unevaluatedProperties": false,
  "$defs": {
    "Tzid": {
      "type": "string",
      "description": "Идентификатор таймзоны IANA (например, Europe/Stockholm) или UTC.",
      "pattern": "^(UTC|[A-Za-z]+(?:[._-][A-Za-z0-9+_-]+)*(?:\\/[A-Za-z0-9+_.-]+)+)$"
    },
    "ColorHex": {
      "type": "string",
      "description": "Цвет метки события в HEX (#RRGGBB или #RGB).",
      "pattern": "^#(?:[0-9a-fA-F]{6}|[0-9a-fA-F]{3})$"
    },
    "EmailIdentity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["email"],
      "properties": {
        "email": { "type": "string", "format": "email", "maxLength": 320 },
        "displayName": { "type": "string", "maxLength": 256 },
        "externalId": { "type": "string", "maxLength": 128 }
      }
    },
    "Attendee": {
      "type": "object",
      "additionalProperties": false,
      "required": ["email"],
      "properties": {
        "email": { "type": "string", "format": "email", "maxLength": 320 },
        "displayName": { "type": "string", "maxLength": 256 },
        "optional": { "type": "boolean", "default": false },
        "organizer": { "type": "boolean", "default": false },
        "responseStatus": {
          "type": "string",
          "description": "Статус ответа участника.",
          "enum": ["needsAction", "declined", "tentative", "accepted"]
        }
      }
    },
    "ReminderOverride": {
      "type": "object",
      "additionalProperties": false,
      "required": ["method", "minutes"],
      "properties": {
        "method": {
          "type": "string",
          "enum": ["popup", "email", "webhook"]
        },
        "minutes": {
          "type": "integer",
          "minimum": 0,
          "maximum": 40320,
          "description": "Минуты до начала события (макс 28 суток)."
        }
      }
    },
    "Reminders": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "useDefault": { "type": "boolean", "default": true },
        "overrides": {
          "type": "array",
          "items": { "$ref": "#/$defs/ReminderOverride" },
          "uniqueItems": true,
          "minItems": 1
        }
      }
    },
    "Recurrence": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "rrule": {
          "type": "string",
          "description": "RRULE согласно RFC 5545 (в верхнем регистре). Пример: FREQ=WEEKLY;BYDAY=MO,WE,FR",
          "pattern": "^FREQ=(DAILY|WEEKLY|MONTHLY|YEARLY)(;[A-Z]+=[^;=]+)*$"
        },
        "rdate": {
          "type": "array",
          "description": "Явные дополнительные повторения.",
          "items": {
            "oneOf": [
              { "type": "string", "format": "date" },
              { "type": "string", "format": "date-time" }
            ]
          },
          "uniqueItems": true
        },
        "exdate": {
          "type": "array",
          "description": "Исключения из повторений.",
          "items": {
            "oneOf": [
              { "type": "string", "format": "date" },
              { "type": "string", "format": "date-time" }
            ]
          },
          "uniqueItems": true
        },
        "timezone": { "$ref": "#/$defs/Tzid" }
      }
    },
    "Conference": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["google_meet", "zoom", "webex", "custom"] },
        "uri": { "type": "string", "format": "uri" },
        "passcode": { "type": "string", "maxLength": 128 }
      }
    },
    "Attachment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["uri", "fileName"],
      "properties": {
        "id": { "type": "string", "maxLength": 128 },
        "uri": { "type": "string", "format": "uri" },
        "fileName": { "type": "string", "maxLength": 512 },
        "mimeType": { "type": "string", "maxLength": 256 },
        "sizeBytes": { "type": "integer", "minimum": 0 },
        "contentHash": { "type": "string", "maxLength": 128 }
      }
    },
    "ExtendedProperties": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "private": {
          "type": "object",
          "propertyNames": { "pattern": "^[A-Za-z0-9_.:-]{1,64}$" },
          "additionalProperties": { "type": ["string", "number", "boolean"] }
        },
        "shared": {
          "type": "object",
          "propertyNames": { "pattern": "^[A-Za-z0-9_.:-]{1,64}$" },
          "additionalProperties": { "type": ["string", "number", "boolean"] }
        }
      }
    },
    "EventDateOnly": {
      "type": "object",
      "additionalProperties": false,
      "required": ["date"],
      "properties": {
        "date": { "type": "string", "format": "date" },
        "timeZone": { "$ref": "#/$defs/Tzid" }
      }
    },
    "EventDateTime": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dateTime"],
      "properties": {
        "dateTime": { "type": "string", "format": "date-time" },
        "timeZone": { "$ref": "#/$defs/Tzid" }
      }
    },
    "EventBase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "calendarId": { "type": "string", "maxLength": 128 },
        "kind": { "type": "string", "const": "event" },
        "summary": { "type": "string", "maxLength": 512 },
        "description": { "type": "string", "maxLength": 65535 },
        "location": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string", "maxLength": 512 },
            "address": { "type": "string", "maxLength": 2048 },
            "geo": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "lat": { "type": "number", "minimum": -90, "maximum": 90 },
                "lon": { "type": "number", "minimum": -180, "maximum": 180 }
              }
            },
            "uri": { "type": "string", "format": "uri" }
          }
        },
        "color": { "$ref": "#/$defs/ColorHex" },
        "status": {
          "type": "string",
          "enum": ["confirmed", "tentative", "cancelled"],
          "default": "confirmed"
        },
        "visibility": {
          "type": "string",
          "enum": ["default", "public", "private"],
          "default": "default"
        },
        "transparency": {
          "type": "string",
          "enum": ["opaque", "transparent"],
          "default": "opaque"
        },
        "allDay": { "type": "boolean", "default": false },
        "start": {
          "description": "Начало события. Для allDay=true используется объект EventDateOnly, иначе EventDateTime.",
          "anyOf": [
            { "$ref": "#/$defs/EventDateOnly" },
            { "$ref": "#/$defs/EventDateTime" }
          ]
        },
        "end": {
          "description": "Окончание события. Для allDay=true используется объект EventDateOnly, иначе EventDateTime.",
          "anyOf": [
            { "$ref": "#/$defs/EventDateOnly" },
            { "$ref": "#/$defs/EventDateTime" }
          ]
        },
        "timeZone": { "$ref": "#/$defs/Tzid" },
        "organizer": { "$ref": "#/$defs/EmailIdentity" },
        "attendees": {
          "type": "array",
          "items": { "$ref": "#/$defs/Attendee" },
          "uniqueItems": true,
          "maxItems": 200
        },
        "reminders": { "$ref": "#/$defs/Reminders" },
        "recurrence": { "$ref": "#/$defs/Recurrence" },
        "conference": { "$ref": "#/$defs/Conference" },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/Attachment" },
          "maxItems": 50,
          "uniqueItems": true
        },
        "extendedProperties": { "$ref": "#/$defs/ExtendedProperties" },
        "source": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "title": { "type": "string", "maxLength": 256 },
            "uri": { "type": "string", "format": "uri" }
          }
        },
        "sequence": {
          "type": "integer",
          "minimum": 0,
          "description": "ICal SEQUENCE для контроля версий."
        },
        "etag": { "type": "string", "maxLength": 128 }
      },
      "required": ["summary", "start", "end"],
      "allOf": [
        {
          "if": { "properties": { "allDay": { "const": true } } },
          "then": {
            "properties": {
              "start": { "$ref": "#/$defs/EventDateOnly" },
              "end": { "$ref": "#/$defs/EventDateOnly" }
            }
          },
          "else": {
            "properties": {
              "start": { "$ref": "#/$defs/EventDateTime" },
              "end": { "$ref": "#/$defs/EventDateTime" }
            }
          }
        }
      ]
    },
    "EventCreate": {
      "title": "Event (Create)",
      "allOf": [
        { "$ref": "#/$defs/EventBase" },
        {
          "type": "object",
          "not": { "required": ["id", "createdAt", "updatedAt"] }
        }
      ]
    },
    "EventStored": {
      "title": "Event (Stored)",
      "allOf": [
        { "$ref": "#/$defs/EventBase" },
        {
          "type": "object",
          "required": ["id", "createdAt", "updatedAt", "sequence"],
          "properties": {
            "id": { "type": "string", "format": "uuid" },
            "createdAt": { "type": "string", "format": "date-time" },
            "updatedAt": { "type": "string", "format": "date-time" }
          }
        }
      ]
    }
  },
  "examples": [
    {
      "kind": "event",
      "summary": "Демо: планёрка команды",
      "description": "Еженедельная встреча по статусам.",
      "allDay": false,
      "start": { "dateTime": "2025-09-01T09:00:00Z", "timeZone": "UTC" },
      "end": { "dateTime": "2025-09-01T09:30:00Z", "timeZone": "UTC" },
      "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=MO" },
      "organizer": { "email": "lead@chronowatch.app", "displayName": "Tech Lead" },
      "attendees": [
        { "email": "dev1@chronowatch.app", "responseStatus": "accepted" },
        { "email": "dev2@chronowatch.app", "optional": true, "responseStatus": "tentative" }
      ],
      "reminders": {
        "useDefault": false,
        "overrides": [{ "method": "popup", "minutes": 10 }]
      },
      "visibility": "default",
      "transparency": "opaque"
    },
    {
      "kind": "event",
      "summary": "Демо: выходной (all-day)",
      "allDay": true,
      "start": { "date": "2025-12-31", "timeZone": "Europe/Stockholm" },
      "end": { "date": "2026-01-01", "timeZone": "Europe/Stockholm" },
      "color": "#FFAA00",
      "visibility": "public",
      "transparency": "transparent"
    }
  ]
}
