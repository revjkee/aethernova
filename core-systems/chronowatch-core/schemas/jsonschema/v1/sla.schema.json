{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://chronowatch.example.invalid/schemas/jsonschema/v1/sla.schema.json",
  "title": "ChronoWatch SLA Config (v1)",
  "description": "Стандартная схема описания SLA-политик для ChronoWatch. Определяет уровни (tiers), пороги и сервисные переопределения.",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,

  "$defs": {
    "semver": {
      "title": "SemVer",
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
    },
    "k8sName": {
      "title": "Kubernetes-like name",
      "type": "string",
      "minLength": 1,
      "maxLength": 253,
      "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
    },
    "percentage": {
      "title": "Percentage 0..100",
      "type": "number",
      "minimum": 0,
      "maximum": 100
    },
    "latencyMs": {
      "title": "Latency in milliseconds",
      "type": "number",
      "minimum": 0
    },
    "durationWindow": {
      "title": "Aggregation window",
      "description": "Продолжительность окна агрегации метрик. Пример: 5m, 1h, 24h, 7d.",
      "type": "string",
      "pattern": "^(?:\\d+)(?:ms|s|m|h|d|w)$"
    },
    "labels": {
      "title": "Labels",
      "type": "object",
      "propertyNames": { "pattern": "^[A-Za-z0-9_.-]{1,63}$" },
      "additionalProperties": {
        "type": "string",
        "maxLength": 256
      },
      "maxProperties": 128
    },
    "annotations": {
      "title": "Annotations",
      "type": "object",
      "propertyNames": { "pattern": "^[A-Za-z0-9_.-]{1,128}$" },
      "additionalProperties": {
        "type": "string",
        "maxLength": 4096
      },
      "maxProperties": 256
    },
    "thresholds": {
      "title": "SLA Thresholds",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "window": { "$ref": "#/$defs/durationWindow", "default": "5m" },
        "latency_ms_p95": { "$ref": "#/$defs/latencyMs" },
        "error_rate_pct": { "$ref": "#/$defs/percentage" },
        "availability_pct": { "$ref": "#/$defs/percentage" }
      },
      "required": [ "latency_ms_p95", "error_rate_pct", "availability_pct" ]
    },
    "escalationPolicy": {
      "title": "Escalation policy",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "consecutive_failure_steps": {
          "description": "Пороговые значения количества подряд идущих нарушений для повышения серьёзности.",
          "type": "array",
          "items": { "type": "integer", "minimum": 1 },
          "minItems": 1,
          "maxItems": 8,
          "uniqueItems": true
        },
        "page_on": {
          "description": "Список уровней серьёзности, при которых требуется пейджинг on-call.",
          "type": "array",
          "items": { "enum": [ "high", "critical" ] },
          "uniqueItems": true
        }
      },
      "required": [ "consecutive_failure_steps" ]
    },
    "tierSpec": {
      "title": "Tier specification",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "description": { "type": "string", "maxLength": 1024 },
        "thresholds": { "$ref": "#/$defs/thresholds" },
        "escalation": { "$ref": "#/$defs/escalationPolicy" }
      },
      "required": [ "thresholds" ]
    },
    "serviceOverride": {
      "title": "Service-level override",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "thresholds": { "$ref": "#/$defs/thresholds" },
        "labels": { "$ref": "#/$defs/labels" }
      }
    },
    "serviceSpec": {
      "title": "Service specification",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "$ref": "#/$defs/k8sName" },
        "tier": {
          "description": "Ссылка на ключ tier в spec.tiers. Если отсутствует — используется defaults.defaultTier.",
          "type": "string",
          "minLength": 1,
          "maxLength": 64
        },
        "overrides": { "$ref": "#/$defs/serviceOverride" },
        "labels": { "$ref": "#/$defs/labels" }
      },
      "required": [ "name" ]
    }
  },

  "properties": {
    "apiVersion": {
      "const": "chronowatch.sla/v1",
      "description": "Версия API схемы."
    },
    "kind": {
      "const": "SLAConfig",
      "description": "Тип объекта конфигурации."
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "$ref": "#/$defs/k8sName" },
        "labels": { "$ref": "#/$defs/labels" },
        "annotations": { "$ref": "#/$defs/annotations" }
      },
      "required": [ "name" ]
    },
    "spec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "schemaVersion": { "$ref": "#/$defs/semver", "default": "1.0.0" },
        "defaults": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "defaultTier": {
              "type": "string",
              "minLength": 1,
              "maxLength": 64,
              "description": "Имя tier по умолчанию для сервисов без явного tier."
            },
            "window": { "$ref": "#/$defs/durationWindow", "default": "5m" }
          },
          "required": [ "defaultTier" ]
        },
        "tiers": {
          "title": "Tier catalog",
          "type": "object",
          "minProperties": 1,
          "maxProperties": 32,
          "propertyNames": { "pattern": "^[a-z][a-z0-9_-]{1,31}$" },
          "additionalProperties": { "$ref": "#/$defs/tierSpec" }
        },
        "services": {
          "title": "Service list",
          "type": "array",
          "items": { "$ref": "#/$defs/serviceSpec" },
          "minItems": 1,
          "maxItems": 1000,
          "uniqueItems": true
        }
      },
      "required": [ "schemaVersion", "defaults", "tiers", "services" ]
    }
  },
  "required": [ "apiVersion", "kind", "metadata", "spec" ],

  "examples": [
    {
      "apiVersion": "chronowatch.sla/v1",
      "kind": "SLAConfig",
      "metadata": {
        "name": "chronowatch-core-sla",
        "labels": { "env": "dev", "app": "chronowatch-core" }
      },
      "spec": {
        "schemaVersion": "1.0.0",
        "defaults": { "defaultTier": "silver", "window": "5m" },
        "tiers": {
          "gold": {
            "description": "Критичные пути",
            "thresholds": {
              "window": "5m",
              "latency_ms_p95": 200,
              "error_rate_pct": 0.5,
              "availability_pct": 99.9
            },
            "escalation": {
              "consecutive_failure_steps": [2, 4, 6],
              "page_on": ["high", "critical"]
            }
          },
          "silver": {
            "thresholds": {
              "window": "5m",
              "latency_ms_p95": 400,
              "error_rate_pct": 1.0,
              "availability_pct": 99.5
            }
          }
        },
        "services": [
          {
            "name": "api-gateway",
            "tier": "gold"
          },
          {
            "name": "telemetry-collector",
            "tier": "silver",
            "overrides": {
              "thresholds": {
                "window": "1h",
                "latency_ms_p95": 600,
                "error_rate_pct": 1.2,
                "availability_pct": 99.6
              }
            }
          }
        ]
      }
    }
  ]
}
