{{- /*
chronowatch-core/ops/helm/chronowatch-core/templates/hpa.yaml
Промышленный HPA-шаблон с поддержкой autoscaling/v2|v2beta2|v2beta1.
Управление через .Values.autoscaling.
*/ -}}
{{- if .Values.autoscaling.enabled }}

{{- /* Определение версии API с фолбэком */ -}}
{{- $hpaApi := dict "version" "autoscaling/v2" -}}
{{- if .Capabilities.APIVersions.Has "autoscaling/v2" -}}
  {{- $_ := set $hpaApi "version" "autoscaling/v2" -}}
{{- else if .Capabilities.APIVersions.Has "autoscaling/v2beta2" -}}
  {{- $_ := set $hpaApi "version" "autoscaling/v2beta2" -}}
{{- else -}}
  {{- $_ := set $hpaApi "version" "autoscaling/v2beta1" -}}
{{- end }}

apiVersion: {{ $hpaApi.version }}
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "chronowatch-core.fullname" . }}
  labels:
    {{- include "chronowatch-core.labels" . | nindent 4 }}
  {{- with .Values.autoscaling.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ default (include "chronowatch-core.fullname" .) (dig "autoscaling" "targetRef" "name" .Values) }}
  minReplicas: {{ default 2 (dig "autoscaling" "minReplicas" .Values) }}
  maxReplicas: {{ default 10 (dig "autoscaling" "maxReplicas" .Values) }}

  {{- /* Метрики: если не заданы в values, дефолт — CPU 70% и Memory 80% */}}
  {{- if .Values.autoscaling.metrics }}
  metrics:
    {{- toYaml .Values.autoscaling.metrics | nindent 4 }}
  {{- else }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  {{- end }}

  {{- /* Поведение HPA (стабилизационные окна и политики). Применимо в v2/v2beta2. */}}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: {{ default 300 (dig "autoscaling" "behavior" "scaleDown" "stabilizationWindowSeconds" .Values | int) }}
      selectPolicy: {{ default "Max" (dig "autoscaling" "behavior" "scaleDown" "selectPolicy" .Values | default "Max") }}
      policies:
        {{- if (dig "autoscaling" "behavior" "scaleDown" "policies" .Values) }}
        {{- toYaml (dig "autoscaling" "behavior" "scaleDown" "policies" .Values) | nindent 8 }}
        {{- else }}
        - type: Percent
          value: 10
          periodSeconds: 60
        - type: Pods
          value: 4
          periodSeconds: 60
        {{- end }}
    scaleUp:
      stabilizationWindowSeconds: {{ default 0 (dig "autoscaling" "behavior" "scaleUp" "stabilizationWindowSeconds" .Values | int) }}
      selectPolicy: {{ default "Max" (dig "autoscaling" "behavior" "scaleUp" "selectPolicy" .Values | default "Max") }}
      policies:
        {{- if (dig "autoscaling" "behavior" "scaleUp" "policies" .Values) }}
        {{- toYaml (dig "autoscaling" "behavior" "scaleUp" "policies" .Values) | nindent 8 }}
        {{- else }}
        - type: Percent
          value: 100
          periodSeconds: 60
        - type: Pods
          value: 4
          periodSeconds: 60
        {{- end }}
{{- end }}
