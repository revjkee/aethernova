{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.omnimind-core.example.com/v1/policy.schema.json",
  "title": "OmniMind Core Policy Schema (v1)",
  "description": "Схема для описания политик и наборов политик OmniMind Core. Поддерживаются документы Policy и PolicySet.",
  "type": "object",
  "$comment": "Draft 2020-12. Строгая схема с переиспользуемыми определениями и примерами.",
  "oneOf": [
    { "$ref": "#/$defs/Policy" },
    { "$ref": "#/$defs/PolicySet" }
  ],
  "unevaluatedProperties": false,

  "$defs": {
    "id": {
      "type": "string",
      "description": "Стабильный идентификатор. Рекомендуется UUID v4 либо человеко-читаемый с ограничениями.",
      "pattern": "^[a-zA-Z0-9._:-]{3,100}$",
      "examples": ["policy-7f6c2bb1", "a1b2c3d4-e5f6-4711-8899-001122334455"]
    },
    "ruleId": {
      "type": "string",
      "description": "Идентификатор правила.",
      "pattern": "^[a-zA-Z0-9._:-]{3,100}$",
      "examples": ["rule-login-rate", "r-001"]
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200
    },
    "nonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "etag": {
      "type": "string",
      "description": "ETag для оптимистической блокировки.",
      "pattern": "^[A-Za-z0-9+/_=-]{8,200}$"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339/ISO-8601, UTC рекомендуется."
    },
    "labels": {
      "type": "object",
      "description": "Произвольные метки в стиле k/v.",
      "propertyNames": {
        "pattern": "^[a-z0-9]([a-z0-9._-]{0,61}[a-z0-9])?$"
      },
      "additionalProperties": {
        "type": "string",
        "maxLength": 256
      },
      "maxProperties": 100
    },
    "effect": {
      "type": "string",
      "enum": ["ALLOW", "DENY", "REVIEW"],
      "description": "Результат применения правила."
    },
    "priority": {
      "type": "integer",
      "minimum": 0,
      "maximum": 1000000,
      "description": "Чем меньше число — тем выше приоритет."
    },
    "conditions": {
      "type": "object",
      "description": "Условия в виде простых сравнений. Конкретная интерпретация — в исполнителе.",
      "additionalProperties": {
        "oneOf": [
          { "type": "string" },
          { "type": "number" },
          { "type": "boolean" },
          {
            "type": "array",
            "items": { "oneOf": [{ "type": "string" }, { "type": "number" }, { "type": "boolean" }] },
            "maxItems": 50
          }
        ]
      },
      "maxProperties": 100
    },
    "subject": {
      "type": "string",
      "description": "Субъект правила (пример: agent:{id}, role:admin, user:{uid}).",
      "minLength": 1,
      "maxLength": 200
    },
    "action": {
      "type": "string",
      "description": "Действие (пример: task.execute, memory.append).",
      "pattern": "^[a-z][a-z0-9._:-]{1,200}$"
    },
    "resource": {
      "type": "string",
      "description": "Цель/ресурс (пример: task:*, plan:{id}). Поддержка шаблонов определяется исполнителем.",
      "minLength": 1,
      "maxLength": 300
    },
    "Rule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "effect", "subject", "action", "resource"],
      "properties": {
        "id": { "$ref": "#/$defs/ruleId" },
        "description": { "type": "string", "maxLength": 2000 },
        "effect": { "$ref": "#/$defs/effect" },
        "subject": { "$ref": "#/$defs/subject" },
        "action": { "$ref": "#/$defs/action" },
        "resource": { "$ref": "#/$defs/resource" },
        "conditions": { "$ref": "#/$defs/conditions" },
        "priority": { "$ref": "#/$defs/priority" },
        "labels": { "$ref": "#/$defs/labels" },
        "deprecated": { "type": "boolean", "default": false }
      },
      "examples": [
        {
          "id": "rule-exec-task",
          "description": "Разрешить выполнение задач агентом X",
          "effect": "ALLOW",
          "subject": "agent:123e4567-e89b-12d3-a456-426614174000",
          "action": "task.execute",
          "resource": "task:*",
          "conditions": { "env": ["production"] },
          "priority": 100
        }
      ]
    },
    "Policy": {
      "type": "object",
      "title": "Policy",
      "description": "Одиночная политика.",
      "additionalProperties": false,
      "required": ["apiVersion", "kind", "id", "name", "rules"],
      "properties": {
        "apiVersion": {
          "type": "string",
          "const": "policies.omnimind/v1"
        },
        "kind": {
          "type": "string",
          "const": "Policy"
        },
        "id": { "$ref": "#/$defs/id" },
        "name": { "$ref": "#/$defs/name" },
        "description": { "type": "string", "maxLength": 4000 },
        "labels": { "$ref": "#/$defs/labels" },
        "rules": {
          "type": "array",
          "minItems": 1,
          "maxItems": 5000,
          "items": { "$ref": "#/$defs/Rule" }
        },
        "conflictResolution": {
          "type": "string",
          "enum": ["DENY_OVERRIDES", "ALLOW_OVERRIDES", "PRIORITY_THEN_STRICTEST"],
          "default": "PRIORITY_THEN_STRICTEST",
          "description": "Политика разрешения конфликтов: стратегия агрегирования решений правил."
        },
        "shadowMode": {
          "type": "boolean",
          "default": false,
          "description": "Если true — политика не блокирует, только логирует."
        },
        "etag": { "$ref": "#/$defs/etag" },
        "createdAt": { "$ref": "#/$defs/timestamp" },
        "updatedAt": { "$ref": "#/$defs/timestamp" }
      },
      "allOf": [
        {
          "$comment": "Уникальность rule.id внутри одной политики.",
          "properties": {
            "rules": {
              "uniqueItems": false
            }
          }
        }
      ],
      "examples": [
        {
          "apiVersion": "policies.omnimind/v1",
          "kind": "Policy",
          "id": "policy-auth-guard",
          "name": "Auth Guard",
          "description": "Ограничение действий аутентификации.",
          "labels": { "area": "security", "env": "production" },
          "rules": [
            {
              "id": "rule-auth-review",
              "effect": "REVIEW",
              "subject": "user:*",
              "action": "auth.login",
              "resource": "account:*",
              "conditions": { "ip.reputation": ["unknown", "bad"] },
              "priority": 10
            },
            {
              "id": "rule-auth-deny-banned",
              "effect": "DENY",
              "subject": "user:*",
              "action": "auth.login",
              "resource": "account:*",
              "conditions": { "user.status": ["banned"] },
              "priority": 0
            }
          ],
          "conflictResolution": "DENY_OVERRIDES",
          "shadowMode": false,
          "etag": "W/\"4d2sdf...\"",
          "createdAt": "2025-08-18T12:00:00Z",
          "updatedAt": "2025-08-18T12:34:56Z"
        }
      ]
    },
    "PolicySet": {
      "type": "object",
      "title": "PolicySet",
      "description": "Пакет политик с порядком применения.",
      "additionalProperties": false,
      "required": ["apiVersion", "kind", "id", "name", "policies"],
      "properties": {
        "apiVersion": {
          "type": "string",
          "const": "policies.omnimind/v1"
        },
        "kind": {
          "type": "string",
          "const": "PolicySet"
        },
        "id": { "$ref": "#/$defs/id" },
        "name": { "$ref": "#/$defs/name" },
        "description": { "type": "string", "maxLength": 4000 },
        "labels": { "$ref": "#/$defs/labels" },
        "order": {
          "type": "array",
          "description": "Необязательный порядок применения (список id политик). Если не задан, порядок списка policies.",
          "items": { "$ref": "#/$defs/id" },
          "uniqueItems": true,
          "maxItems": 10000
        },
        "policies": {
          "type": "array",
          "minItems": 1,
          "maxItems": 10000,
          "items": { "$ref": "#/$defs/Policy" }
        },
        "conflictResolution": {
          "type": "string",
          "enum": ["DENY_OVERRIDES", "ALLOW_OVERRIDES", "PRIORITY_THEN_STRICTEST"],
          "default": "PRIORITY_THEN_STRICTEST"
        },
        "shadowMode": {
          "type": "boolean",
          "default": false
        },
        "etag": { "$ref": "#/$defs/etag" },
        "createdAt": { "$ref": "#/$defs/timestamp" },
        "updatedAt": { "$ref": "#/$defs/timestamp" }
      },
      "examples": [
        {
          "apiVersion": "policies.omnimind/v1",
          "kind": "PolicySet",
          "id": "policyset-default",
          "name": "Default Policy Set",
          "policies": [
            {
              "apiVersion": "policies.omnimind/v1",
              "kind": "Policy",
              "id": "policy-core",
              "name": "Core Policy",
              "rules": [
                {
                  "id": "rule-allow-task-exec",
                  "effect": "ALLOW",
                  "subject": "agent:*",
                  "action": "task.execute",
                  "resource": "task:*",
                  "priority": 100
                }
              ]
            },
            {
              "apiVersion": "policies.omnimind/v1",
              "kind": "Policy",
              "id": "policy-guard",
              "name": "Guard Policy",
              "rules": [
                {
                  "id": "rule-deny-admin-delete",
                  "effect": "DENY",
                  "subject": "user:anonymous",
                  "action": "admin.delete",
                  "resource": "account:*",
                  "priority": 10
                }
              ]
            }
          ],
          "order": ["policy-guard", "policy-core"],
          "conflictResolution": "DENY_OVERRIDES",
          "shadowMode": false
        }
      ]
    }
  }
}
