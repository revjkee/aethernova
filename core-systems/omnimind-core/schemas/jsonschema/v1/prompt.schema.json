{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.omnimind.example.com/v1/prompt.schema.json",
  "title": "Omnimind Prompt Schema (v1)",
  "description": "Контракт для описания промптов и диалогов LLM в Omnimind. Поддерживает режимы chat/completion, вложения, инструменты и параметры модели.",
  "type": "object",
  "additionalProperties": false,
  "required": ["kind", "id", "version", "locale", "model", "parameters"],
  "properties": {
    "kind": {
      "description": "Тип промпта/запроса к модели.",
      "type": "string",
      "enum": ["chat", "completion"]
    },
    "id": {
      "description": "Уникальный идентификатор промпта.",
      "type": "string",
      "allOf": [{ "$ref": "#/$defs/uuid" }]
    },
    "version": {
      "description": "Версия артефакта. Семантическая версия.",
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
    },
    "locale": {
      "description": "Локаль BCP 47, например ru-RU.",
      "type": "string",
      "allOf": [{ "$ref": "#/$defs/locale" }]
    },
    "createdAt": {
      "description": "Момент создания промпта (UTC, RFC 3339).",
      "type": "string",
      "format": "date-time"
    },
    "updatedAt": {
      "description": "Момент обновления промпта (UTC, RFC 3339).",
      "type": "string",
      "format": "date-time"
    },
    "metadata": {
      "description": "Произвольные метки/атрибуты для трассировки и аудита.",
      "type": "object",
      "default": {},
      "propertyNames": { "pattern": "^[A-Za-z_][A-Za-z0-9_.:-]{0,63}$" },
      "additionalProperties": {
        "oneOf": [
          { "type": "string", "maxLength": 1024 },
          { "type": "number" },
          { "type": "integer" },
          { "type": "boolean" },
          { "type": "null" }
        ]
      }
    },
    "trace": {
      "description": "Трасс-контекст запроса.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "traceId": { "type": "string", "pattern": "^[0-9a-fA-F]{32}$" },
        "spanId":  { "type": "string", "pattern": "^[0-9a-fA-F]{16}$" },
        "sampled": { "type": "boolean" }
      }
    },
    "security": {
      "description": "Политики безопасности на уровне промпта.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "piiRedaction": { "type": "boolean", "default": true },
        "jailbreakGuard": { "type": "boolean", "default": true },
        "maxPromptChars": { "type": "integer", "minimum": 0, "maximum": 1048576 },
        "allowedTools": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_\\-]{0,63}$" },
          "uniqueItems": true
        }
      }
    },
    "model": {
      "description": "Параметры модели и провайдера.",
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "name"],
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["openai", "azureopenai", "anthropic", "gemini", "cohere", "local", "vllm", "ollama"]
        },
        "name": { "type": "string", "minLength": 1, "maxLength": 128 },
        "endpoint": { "type": "string", "format": "uri", "maxLength": 2048 },
        "deployment": { "type": "string", "maxLength": 128 },
        "embeddingModel": { "type": "string", "maxLength": 128 }
      }
    },
    "parameters": {
      "description": "Гиперпараметры генерации.",
      "type": "object",
      "additionalProperties": false,
      "required": ["maxTokens"],
      "properties": {
        "maxTokens": { "type": "integer", "minimum": 1, "maximum": 32768 },
        "temperature": { "type": "number", "minimum": 0, "maximum": 2, "default": 0.2 },
        "topP": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.95 },
        "topK": { "type": "integer", "minimum": 0, "maximum": 1000 },
        "presencePenalty": { "type": "number", "minimum": -2, "maximum": 2 },
        "frequencyPenalty": { "type": "number", "minimum": -2, "maximum": 2 },
        "seed": { "type": "integer", "minimum": 0 },
        "stop": {
          "description": "Стоп-последовательности.",
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 64 },
          "uniqueItems": true,
          "maxItems": 16
        },
        "responseFormat": {
          "description": "Формат ответа.",
          "type": "string",
          "enum": ["text", "json_object", "json_schema"]
        },
        "jsonSchema": {
          "description": "JSON Schema для детерминированного JSON-вывода (если responseFormat=json_schema).",
          "type": "object"
        },
        "stream": { "type": "boolean", "default": true },
        "toolChoice": {
          "description": "Стратегия выбора инструмента/функции.",
          "type": "string",
          "enum": ["auto", "none", "required"]
        }
      },
      "allOf": [
        {
          "if": { "properties": { "responseFormat": { "const": "json_schema" } }, "required": ["responseFormat"] },
          "then": { "required": ["jsonSchema"] }
        }
      ]
    },
    "tools": {
      "description": "Определения доступных инструментов/функций.",
      "type": "array",
      "items": { "$ref": "#/$defs/tool" },
      "uniqueItems": true,
      "maxItems": 64
    },
    "attachments": {
      "description": "Вложенные ресурсы (изображения/документы/аудио).",
      "type": "array",
      "items": { "$ref": "#/$defs/attachment" },
      "maxItems": 64
    },
    "instructions": {
      "description": "Системные/глобальные инструкции (для completion также используется как преамбула).",
      "type": "string",
      "minLength": 0,
      "maxLength": 262144
    },
    "inputs": {
      "description": "Шаблонные входные данные (KV), используемые для подстановки в инструкции/сообщения.",
      "type": "object",
      "default": {},
      "additionalProperties": { "type": ["string", "number", "integer", "boolean", "null"] }
    },
    "messages": {
      "description": "История сообщений (только для kind=chat).",
      "type": "array",
      "items": { "$ref": "#/$defs/message" },
      "minItems": 1,
      "maxItems": 200
    },
    "rateLimit": {
      "description": "Ограничения на уровне промпта.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tokensPerMinute": { "type": "integer", "minimum": 1 },
        "requestsPerMinute": { "type": "integer", "minimum": 1 },
        "burst": { "type": "integer", "minimum": 0 }
      }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "kind": { "const": "chat" } }, "required": ["kind"] },
      "then": {
        "required": ["messages"],
        "properties": {
          "instructions": { "type": ["string", "null"] }
        }
      }
    },
    {
      "if": { "properties": { "kind": { "const": "completion" } }, "required": ["kind"] },
      "then": {
        "required": ["instructions"],
        "properties": {
          "messages": { "maxItems": 0 }
        }
      }
    }
  ],

  "$defs": {
    "uuid": {
      "description": "UUID v4 в текстовом виде.",
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "locale": {
      "description": "BCP 47 тег локали.",
      "type": "string",
      "pattern": "^[A-Za-z]{2,3}(?:-[A-Za-z0-9]{2,8})*$"
    },
    "uri": {
      "description": "URI/URL ресурса.",
      "type": "string",
      "format": "uri",
      "maxLength": 2048
    },
    "contentType": {
      "description": "MIME-тип содержимого.",
      "type": "string",
      "pattern": "^[a-z0-9!#$&^_.+-]+/[a-z0-9!#$&^_.+-]+(;\\s*[a-z0-9!#$&^_.+-]+=[^;\\s]+)*$"
    },
    "attachment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "contentType"],
      "properties": {
        "id": { "type": "string", "allOf": [{ "$ref": "#/$defs/uuid" }] },
        "type": {
          "type": "string",
          "enum": ["image", "document", "audio", "video", "other"]
        },
        "contentType": { "$ref": "#/$defs/contentType" },
        "uri": { "$ref": "#/$defs/uri" },
        "bytesBase64": {
          "description": "Base64-данные, если ресурс инлайнится.",
          "type": "string",
          "contentEncoding": "base64"
        },
        "sizeBytes": { "type": "integer", "minimum": 0 },
        "checksum": {
          "type": "object",
          "additionalProperties": false,
          "required": ["algo", "hex"],
          "properties": {
            "algo": { "type": "string", "enum": ["sha256", "sha512", "blake2b256", "blake3"] },
            "hex":  { "type": "string", "pattern": "^[0-9a-fA-F]{64,128}$" }
          }
        },
        "metadata": {
          "type": "object",
          "default": {},
          "additionalProperties": { "type": ["string", "number", "integer", "boolean", "null"] }
        }
      },
      "oneOf": [
        { "required": ["uri"] },
        { "required": ["bytesBase64"] }
      ]
    },
    "tool": {
      "description": "Декларация инструмента (функции) с JSON Schema параметров.",
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "description", "parameters"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{1,63}$",
          "description": "Идентификатор функции."
        },
        "description": { "type": "string", "minLength": 1, "maxLength": 2048 },
        "parameters": {
          "description": "JSON Schema спецификация параметров функции.",
          "type": "object"
        },
        "strict": { "type": "boolean", "default": true }
      }
    },
    "message": {
      "description": "Сообщение в истории диалога.",
      "type": "object",
      "additionalProperties": false,
      "required": ["role"],
      "properties": {
        "role": { "type": "string", "enum": ["system", "user", "assistant", "tool"] },
        "content": {
          "description": "Содержимое сообщения (строка или массив контент-частей).",
          "oneOf": [
            { "type": "string", "maxLength": 262144 },
            {
              "type": "array",
              "items": { "$ref": "#/$defs/contentPart" },
              "minItems": 1,
              "maxItems": 256
            }
          ]
        },
        "name": {
          "description": "Имя инструмента при role=tool или подпись автора.",
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_\\-]{0,63}$"
        },
        "toolCallId": {
          "description": "Идентификатор вызова инструмента (связка assistant->tool).",
          "type": "string",
          "pattern": "^[A-Za-z0-9._:-]{1,128}$"
        },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/attachment" },
          "maxItems": 32
        },
        "metadata": {
          "type": "object",
          "default": {},
          "additionalProperties": { "type": ["string", "number", "integer", "boolean", "null"] }
        }
      },
      "allOf": [
        {
          "if": { "properties": { "role": { "const": "tool" } }, "required": ["role"] },
          "then": { "required": ["name"] }
        }
      ]
    },
    "contentPart": {
      "description": "Типизированная часть контента (текст, изображение, файл и т.д.).",
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        {
          "title": "text",
          "required": ["type", "text"],
          "properties": {
            "type": { "const": "text" },
            "text": { "type": "string", "maxLength": 262144 }
          }
        },
        {
          "title": "image",
          "required": ["type", "source"],
          "properties": {
            "type": { "const": "image" },
            "source": {
              "type": "object",
              "additionalProperties": false,
              "required": ["contentType"],
              "properties": {
                "contentType": { "$ref": "#/$defs/contentType" },
                "uri": { "$ref": "#/$defs/uri" },
                "bytesBase64": { "type": "string", "contentEncoding": "base64" }
              },
              "oneOf": [
                { "required": ["uri"] },
                { "required": ["bytesBase64"] }
              ]
            },
            "alt": { "type": "string", "maxLength": 2048 }
          }
        },
        {
          "title": "document",
          "required": ["type", "source"],
          "properties": {
            "type": { "const": "document" },
            "source": {
              "type": "object",
              "additionalProperties": false,
              "required": ["contentType"],
              "properties": {
                "contentType": { "$ref": "#/$defs/contentType" },
                "uri": { "$ref": "#/$defs/uri" },
                "bytesBase64": { "type": "string", "contentEncoding": "base64" }
              },
              "oneOf": [
                { "required": ["uri"] },
                { "required": ["bytesBase64"] }
              ]
            },
            "name": { "type": "string", "maxLength": 256 }
          }
        },
        {
          "title": "tool_result",
          "required": ["type", "toolCallId", "contentType", "data"],
          "properties": {
            "type": { "const": "tool_result" },
            "toolCallId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{1,128}$" },
            "contentType": { "$ref": "#/$defs/contentType" },
            "data": {
              "description": "Результат инструмента (строка JSON, Base64 или текст).",
              "type": "string",
              "maxLength": 524288
            }
          }
        }
      ]
    }
  },

  "examples": [
    {
      "kind": "chat",
      "id": "8b3c6b2a-56c6-4c0f-9b3b-9b8a1b1b9b8a",
      "version": "1.0.0",
      "locale": "ru-RU",
      "model": { "provider": "openai", "name": "gpt-4o-mini" },
      "parameters": { "maxTokens": 1024, "temperature": 0.2, "stream": true },
      "security": { "piiRedaction": true, "jailbreakGuard": true },
      "messages": [
        { "role": "system", "content": "Ты — строгий валидатор JSON." },
        { "role": "user", "content": [ { "type": "text", "text": "Проверяй входные данные на соответствие схеме." } ] }
      ]
    },
    {
      "kind": "completion",
      "id": "087f2f1b-1c0f-4a8a-9b1a-0e2c7d4a1a9f",
      "version": "1.0.0",
      "locale": "ru-RU",
      "model": { "provider": "azureopenai", "name": "gpt-4o-mini", "deployment": "gpt-4o-mini" },
      "parameters": { "maxTokens": 512, "responseFormat": "json_object" },
      "instructions": "Сгенерируй объект JSON с ключами title, bullets[]."
    }
  ]
}
