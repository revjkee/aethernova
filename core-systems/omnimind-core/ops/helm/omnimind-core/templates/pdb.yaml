# omnimind-core/ops/k8s/helm/templates/pdb.yaml
{{- /*
Industrial-grade PodDisruptionBudget for omnimind-core.
Highlights:
- policy/v1 (stable)
- Validation: forbid both minAvailable & maxUnavailable at once
- Customizable labels/annotations
- Safe defaults for selector to match Deployment/StatefulSet labels
- Optional unhealthyPodEvictionPolicy (K8s >=1.26)
*/ -}}

{{- if .Values.pdb.enabled }}

{{- if and (hasKey .Values.pdb "minAvailable") (hasKey .Values.pdb "maxUnavailable") }}
{{- if and .Values.pdb.minAvailable .Values.pdb.maxUnavailable }}
{{ fail "pdb: set either pdb.minAvailable or pdb.maxUnavailable, not both" }}
{{- end }}
{{- end }}

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ default (printf "%s-pdb" .Release.Name) .Values.pdb.name | trunc 63 | trimSuffix "-" }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
    app.kubernetes.io/instance: {{ .Release.Name | trunc 63 | trimSuffix "-" }}
    app.kubernetes.io/component: {{ default "api" .Values.component | trunc 63 | trimSuffix "-" }}
    app.kubernetes.io/part-of: {{ default "omnimind" .Values.partOf | trunc 63 | trimSuffix "-" }}
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    helm.sh/chart: {{ printf "%s-%s" .Chart.Name .Chart.Version | quote }}
    {{- with .Values.pdb.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with .Values.pdb.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- /* Render exactly one of minAvailable/maxUnavailable, if provided */}}
  {{- if .Values.pdb.minAvailable }}
  minAvailable: {{ .Values.pdb.minAvailable | toString | quote }}
  {{- else if .Values.pdb.maxUnavailable }}
  maxUnavailable: {{ .Values.pdb.maxUnavailable | toString | quote }}
  {{- else }}
  # Default if nothing specified: allow eviction down to one Pod remaining
  minAvailable: "1"
  {{- end }}

  {{- /* Optional unhealthyPodEvictionPolicy (K8s >=1.26): IfHealthyBudget | AlwaysAllow */}}
  {{- if .Values.pdb.unhealthyPodEvictionPolicy }}
  unhealthyPodEvictionPolicy: {{ .Values.pdb.unhealthyPodEvictionPolicy | quote }}
  {{- end }}

  selector:
    matchLabels:
      # These must match your Deployment/StatefulSet Pod template labels
      app.kubernetes.io/name: {{ default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
      app.kubernetes.io/instance: {{ .Release.Name | trunc 63 | trimSuffix "-" }}
      {{- with .Values.pdb.matchLabels }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

{{- end }}
