# ops/k8s/base/pdb.yaml
# PodDisruptionBudget baseline for omnimind-core (kustomize base).
# Notes:
# - Controls only voluntary disruptions (node drain, upgrades, etc.).
# - Ensure your Deployments/StatefulSets use matching labels below.
# - For single-replica workloads, PDB may block disruptions entirely.

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: omnimind-api-pdb
  labels:
    app.kubernetes.io/part-of: omnimind-core
    app.kubernetes.io/name: omnimind-api
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: kustomize
  annotations:
    omnimind.io/slo-availability: "99.9"
    omnimind.io/description: "Protect API during voluntary disruptions; requires >=2 replicas."
spec:
  # For API tier with HPA or >=2 replicas; keeps at least 75% available.
  maxUnavailable: "25%"
  # Evict unhealthy pods only if disruption budget is respected.
  unhealthyPodEvictionPolicy: IfHealthyBudget
  selector:
    matchLabels:
      app.kubernetes.io/part-of: omnimind-core
      app.kubernetes.io/name: omnimind-api
      app.kubernetes.io/component: api

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: omnimind-worker-pdb
  labels:
    app.kubernetes.io/part-of: omnimind-core
    app.kubernetes.io/name: omnimind-worker
    app.kubernetes.io/component: worker
    app.kubernetes.io/managed-by: kustomize
  annotations:
    omnimind.io/slo-availability: "99.5"
    omnimind.io/description: "Guarantee at least one worker to drain queues gracefully."
spec:
  # For queue/worker tier; at least one pod must stay to process jobs.
  minAvailable: 1
  unhealthyPodEvictionPolicy: IfHealthyBudget
  selector:
    matchLabels:
      app.kubernetes.io/part-of: omnimind-core
      app.kubernetes.io/name: omnimind-worker
      app.kubernetes.io/component: worker
