# ------------------------------------------------------------------------------
# OmniMind Core - Base Services (Kustomize base)
# Назначение:
#  - omnimind-core: основной сервис приложения (HTTP).
#  - omnimind-core-metrics: сервис для экспорта метрик Prometheus.
# Примечание: значения портов и набор аннотаций считаются базовыми и переопределяются
# в оверлеях (например, ops/k8s/overlays/prod/) при необходимости.
# ------------------------------------------------------------------------------

---
apiVersion: v1
kind: Service
metadata:
  name: omnimind-core
  labels:
    app.kubernetes.io/name: omnimind-core
    app.kubernetes.io/instance: omnimind-core
    app.kubernetes.io/component: core
    app.kubernetes.io/part-of: omnimind
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # При необходимости выставьте класс балансировщика или иные аннотации в оверлеях.
    # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # cloud.google.com/load-balancer-type: "Internal"
spec:
  type: ClusterIP
  # internalTrafficPolicy: Cluster  # включите при необходимости (>=1.22)
  selector:
    app.kubernetes.io/name: omnimind-core
    app.kubernetes.io/instance: omnimind-core
    app.kubernetes.io/component: core
  ports:
    - name: http
      port: 80          # Клиентский порт внутри кластера
      targetPort: 8080  # Имя/номер контейнерного порта подов (переопределите в оверлее)
      protocol: TCP
      appProtocol: http

---
apiVersion: v1
kind: Service
metadata:
  name: omnimind-core-metrics
  labels:
    app.kubernetes.io/name: omnimind-core
    app.kubernetes.io/instance: omnimind-core
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: omnimind
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Универсальные аннотации Prometheus (если не используется ServiceMonitor).
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: omnimind-core
    app.kubernetes.io/instance: omnimind-core
    app.kubernetes.io/component: core
  ports:
    - name: metrics
      port: 9090        # Порт сервиса
      targetPort: 9090  # Порт контейнера с /metrics (переопределите при необходимости)
      protocol: TCP
      appProtocol: http
