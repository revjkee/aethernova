# omnimind-core / ops / ansible / roles / omnimind-core / templates / config.yaml.j2
# GENERATED BY ANSIBLE — DO NOT EDIT MANUALLY
# Timestamp: {{ ansible_date_time.iso8601 if ansible_date_time is defined else '' }}
# Config-Hash: {{ omnimind_config_hash | default('') }}

# =========================
# APPLICATION
# =========================
app:
  name: {{ app_env.APP_NAME | default('omnimind-core') | quote }}
  env: {{ app_env.APP_ENV | default(env_name | default('staging')) | quote }}
  version: {{ app_version | default('0.0.0') | quote }}
  instance_id: {{ inventory_hostname | default('localhost') | quote }}
  region: {{ region | default('eu-central-1') | quote }}
  debug: {{ app_debug | default(false) | bool }}
  features:
    # включайте/отключайте фичи на уровне окружения
    {% set _ff = app_env.FEATURE_FLAGS | default('') %}
    flags: {{ _ff.split(',') if _ff else [] }}

# =========================
# SERVER / RUNTIME
# =========================
server:
  bind_host: {{ app_bind_host | default('0.0.0.0') | quote }}
  port: {{ app_port_http | default(8080) }}
  workers: {{ app_workers | default(2) }}
  backlog: {{ app_backlog | default(2048) }}
  timeouts:
    keep_alive: {{ app_keepalive_timeout | default(15) }}
    request: {{ app_request_timeout | default(30) }}
    graceful_shutdown: {{ app_graceful_timeout | default(25) }}
  http:
    max_request_body_mb: {{ app_max_request_body_mb | default(10) }}
    compression: {{ app_http_compression | default(true) | bool }}
    access_log: {{ app_access_log | default(false) | bool }}
  health:
    live_path: {{ app_health_live_path | default('/healthz/live') | quote }}
    ready_path: {{ app_health_ready_path | default('/healthz/ready') | quote }}
  # для uvicorn/gunicorn-обвязки, если используется
  uvicorn:
    loop: {{ uvicorn_loop | default('auto') | quote }}
    http: {{ uvicorn_http | default('auto') | quote }}
    proxy_headers: {{ uvicorn_proxy_headers | default(true) | bool }}
    forwarded_allow_ips: {{ uvicorn_forwarded_allow_ips | default('*') | quote }}

# =========================
# LOGGING
# =========================
logging:
  level: {{ app_env.LOG_LEVEL | default('INFO') | upper | quote }}
  json: {{ log_json | default(true) | bool }}
  format: {{ log_format | default('{"ts":"%(asctime)s","lvl":"%(levelname)s","msg":"%(message)s","mod":"%(name)s","pid":"%(process)d"}') | quote }}
  outputs:
    - type: stdout
    - type: file
      path: {{ app_log_dir | default('/var/log/omnimind') | quote }}/app.log
      rotation:
        max_size_mb: {{ log_rotate_max_size_mb | default(50) }}
        max_backups: {{ log_rotate_max_files | default(5) }}
        compress: {{ log_rotate_compress | default(true) | bool }}

# =========================
# SECURITY
# =========================
security:
  cors:
    enabled: {{ cors_enabled | default(true) | bool }}
    allow_origins: {{ cors_allow_origins | default(['https://*.example.com']) }}
    allow_methods: {{ cors_allow_methods | default(['GET','POST','PUT','PATCH','DELETE','OPTIONS']) }}
    allow_headers: {{ cors_allow_headers | default(['*']) }}
    allow_credentials: {{ cors_allow_credentials | default(false) | bool }}
    max_age: {{ cors_max_age | default(600) }}
  headers:
    x_frame_options: "DENY"
    x_content_type_options: "nosniff"
    referrer_policy: "no-referrer"
    content_security_policy: {{ csp | default("default-src 'none'; frame-ancestors 'none'; base-uri 'none'") | quote }}
    strict_transport_security: {{ hsts | default("max-age=31536000; includeSubDomains") | quote }}
  jwt:
    enabled: {{ jwt_enabled | default(true) | bool }}
    secret: {{ secrets.jwt_secret | default('') | quote }}
    issuer: {{ jwt_issuer | default('omnimind-core') | quote }}
    audience: {{ jwt_audience | default('omnimind-clients') | quote }}
    algorithm: {{ jwt_alg | default('HS256') | quote }}
    access_ttl_minutes: {{ jwt_access_ttl_minutes | default(30) }}
    refresh_ttl_minutes: {{ jwt_refresh_ttl_minutes | default(43200) }}  # 30 дней
  csrf:
    enabled: {{ csrf_enabled | default(false) | bool }}

tls:
  enabled: {{ tls_enabled | default(false) | bool }}
  cert_file: {{ tls_cert_path | default('/etc/omnimind/tls/tls.crt') | quote }}
  key_file: {{ tls_key_path  | default('/etc/omnimind/tls/tls.key')  | quote }}
  ca_bundle: {{ tls_bundle_path | default('/etc/omnimind/tls/ca.crt') | quote }}
  client_auth: {{ tls_client_auth | default('disabled') | quote }}   # disabled|optional|required

# =========================
# DATABASE
# =========================
{% set _db_user = secrets.db_user | default('') -%}
{% set _db_pass = secrets.db_password | default('') -%}
{% set _db_host = db_host | default('') -%}
{% set _db_port = db_port | default('5432') -%}
{% set _db_name = db_name | default('omnimind') -%}
database:
  enabled: {{ (_db_user and _db_pass and _db_host) | bool }}
  driver: {{ db_driver | default('postgresql+asyncpg') | quote }}
  # URL формируется только если заданы все ключевые параметры
  {% if _db_user and _db_pass and _db_host %}
  url: "{{ db_driver | default('postgresql+asyncpg') }}://{{ _db_user }}:{{ _db_pass }}@{{ _db_host }}:{{ _db_port }}/{{ _db_name }}?sslmode={{ DB_SSLMODE | default('require') }}"
  {% else %}
  url: ""
  {% endif %}
  pool:
    min_size: {{ db_pool_min | default(5) }}
    max_size: {{ db_pool_max | default(20) }}
    max_overflow: {{ db_pool_overflow | default(0) }}
    timeout_sec: {{ db_pool_timeout | default(5) }}
    recycle_sec: {{ db_pool_recycle | default(1800) }}
  statement:
    timeout_ms: {{ db_statement_timeout_ms | default(15000) }}
    log_slow_ms: {{ db_log_slow_ms | default(200) }}
  migrations:
    auto_run: {{ db_migrate_on_start | default(false) | bool }}
    path: {{ db_migrations_path | default('migrations') | quote }}

# =========================
# CACHE (Redis)
# =========================
{% set _cache_url = cache_url | default('') -%}
cache:
  enabled: {{ (_cache_url | length) > 0 }}
  url: {{ _cache_url | quote }}
  namespace: {{ cache_namespace | default('omnimind') | quote }}
  timeouts:
    connect_ms: {{ cache_connect_timeout_ms | default(1000) }}
    read_ms: {{ cache_read_timeout_ms | default(2000) }}
  pool:
    max_connections: {{ cache_max_conns | default(50) }}

# =========================
# BROKER (AMQP/Kafka/NATS)
# =========================
{% set _broker = broker_url | default('') -%}
broker:
  enabled: {{ (_broker | length) > 0 }}
  url: {{ _broker | quote }}
  kind: {{ broker_kind | default('amqp') | quote }}   # amqp|kafka|nats
  prefetch: {{ broker_prefetch | default(32) }}
  queues:
    default: {{ broker_queue_default | default('omnimind.default') | quote }}
    priority: {{ broker_queue_priority | default('omnimind.priority') | quote }}
  retry:
    max_attempts: {{ broker_retry_max | default(6) }}
    backoff_ms: {{ broker_retry_backoff_ms | default(500) }}

# =========================
# METRICS & TRACING
# =========================
metrics:
  enabled: {{ monitoring_enabled | default(true) | bool }}
  endpoint: "/metrics"
  port: {{ app_port_metrics | default(app_port_http | default(8080)) }}
  labels:
    job: {{ prometheus_scrape_labels.job | default('omnimind-core') | quote }}
    env: {{ prometheus_scrape_labels.env | default(env_name | default('staging')) | quote }}
    region: {{ prometheus_scrape_labels.region | default(region | default('eu-central-1')) | quote }}

tracing:
  enabled: {{ tracing_enabled | default(false) | bool }}
  exporter: {{ tracing_exporter | default('otlp') | quote }}   # otlp|jaeger|zipkin
  endpoint: {{ tracing_endpoint | default('http://otel-collector:4317') | quote }}
  headers: {{ tracing_headers | default({}) }}
  sampling:
    ratio: {{ tracing_sampling_ratio | default(0.1) }}

# =========================
# RATE LIMIT / ABUSE CONTROL
# =========================
ratelimit:
  enabled: {{ ratelimit_enabled | default(true) | bool }}
  backend: {{ ratelimit_backend | default('redis') | quote }}
  rules:
    - id: "rl-api-default"
      match: "/api/"
      window_sec: {{ rl_window_sec | default(60) }}
      limit: {{ rl_limit | default(1200) }}
      burst: {{ rl_burst | default(200) }}
      key: "ip"

# =========================
# PATHS / FS / RUNTIME
# =========================
paths:
  home: {{ app_home | default('/opt/omnimind/omnimind-core') | quote }}
  data: {{ app_data_dir | default('/var/lib/omnimind') | quote }}
  logs: {{ app_log_dir  | default('/var/log/omnimind') | quote }}
  tmp:  {{ app_tmp_dir  | default('/var/tmp/omnimind') | quote }}

# =========================
# FEATURE MODULES (ENABLE FLAGS)
# =========================
modules:
  api: {{ module_api_enabled | default(true) | bool }}
  jobs: {{ module_jobs_enabled | default(true) | bool }}
  webhooks: {{ module_webhooks_enabled | default(false) | bool }}
  admin: {{ module_admin_enabled | default(false) | bool }}

# =========================
# SAFE DEFAULTS & GUARDRAILS
# =========================
guardrails:
  # Ограничение параллелизма внутренних задач
  concurrency:
    global_limit: {{ concurrency_global_limit | default(64) }}
    per_endpoint:
      "/api/v1/heavy": {{ concurrency_heavy_limit | default(8) }}
  # Защита от дорогостоящих запросов
  query_limits:
    max_page_size: {{ max_page_size | default(1000) }}
    max_lookback_days: {{ max_lookback_days | default(365) }}

# =========================
# END OF FILE
# =========================
