# omnimind-core/ops/ansible/roles/omnimind-core/templates/env.j2
# СГЕНЕРИРОВАНО Ansible. Не редактировать вручную.
# Время рендера: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
# Узел: {{ inventory_hostname }} | Окружение: {{ omni_env | default('development') }}

############################
# 0) БАЗА ПРИЛОЖЕНИЯ
############################
APP_NAME={{ omni_app_name | default('omnimind-core') }}
APP_ENV={{ omni_env | default('development') }}
APP_VERSION={{ omni_version | default('0.1.0') }}
TZ={{ omni_tz | default('Europe/Stockholm') }}
LOCALE={{ omni_locale | default('ru_RU.UTF-8') }}

HOST={{ omni_http_host | default('0.0.0.0') }}
PORT={{ omni_http_port | default(8000) }}
WORKERS={{ omni_http_workers | default(4) }}
GRACEFUL_TIMEOUT_SEC={{ omni_http_graceful_timeout | default(30) }}

{# безопасная сериализация bool как true/false #}
{% set debug = (omni_debug | default(false)) %}
DEBUG={{ 'true' if debug else 'false' }}

ALLOWED_HOSTS={{ (omni_allowed_hosts | default(['localhost','127.0.0.1'])) | join(',') }}
CORS_ALLOW_ORIGINS={{ (omni_cors_allow_origins | default([])) | join(',') }}
CORS_ALLOW_CREDENTIALS={{ 'true' if (omni_cors_allow_credentials | default(false)) else 'false' }}
CORS_ALLOW_METHODS={{ (omni_cors_allow_methods | default(['GET','POST','PUT','DELETE','OPTIONS'])) | join(',') }}
CORS_ALLOW_HEADERS={{ (omni_cors_allow_headers | default(['Authorization','Content-Type','X-Request-Id'])) | join(',') }}

############################
# 1) ЛОГИ/МЕТРИКИ/ТРЕЙСИНГ/SENTRY
############################
LOG_LEVEL={{ omni_log_level | default('INFO') }}
LOG_FORMAT={{ omni_log_format | default('json') }}
STRUCTURED_LOGS={{ 'true' if (omni_structured_logs | default(true)) else 'false' }}
ACCESS_LOG={{ 'true' if (omni_access_log | default(true)) else 'false' }}
LOG_SAMPLING_RATE={{ omni_log_sampling_rate | default(1.0) }}
REQUEST_ID_HEADER={{ omni_request_id_header | default('X-Request-Id') }}

PROMETHEUS_ENABLED={{ 'true' if (omni_prom_enabled | default(true)) else 'false' }}
PROMETHEUS_ENDPOINT={{ omni_prom_endpoint | default('/metrics') }}

OTEL_ENABLED={{ 'true' if (omni_otel_enabled | default(false)) else 'false' }}
OTEL_TRACES_EXPORTER={{ omni_otel_traces_exporter | default('otlp') }}
OTEL_METRICS_EXPORTER={{ omni_otel_metrics_exporter | default('otlp') }}
OTEL_LOGS_EXPORTER={{ omni_otel_logs_exporter | default('none') }}
OTEL_EXPORTER_OTLP_ENDPOINT={{ omni_otel_endpoint | default('http://otel-collector:4317') }}
OTEL_SERVICE_NAME={{ omni_otel_service_name | default('omnimind-core') }}
OTEL_TRACES_SAMPLER={{ omni_otel_sampler | default('parentbased_traceidratio') }}
OTEL_TRACES_SAMPLER_ARG={{ omni_otel_sampler_arg | default(0.1) }}

SENTRY_ENABLED={{ 'true' if (omni_sentry_enabled | default(false)) else 'false' }}
SENTRY_DSN={{ omni_sentry_dsn | default('') }}
SENTRY_TRACES_SAMPLE_RATE={{ omni_sentry_traces_rate | default(0.05) }}
SENTRY_PROFILES_SAMPLE_RATE={{ omni_sentry_profiles_rate | default(0.0) }}
SENTRY_ENVIRONMENT={{ omni_env | default('development') }}

############################
# 2) БАЗА ДАННЫХ (PostgreSQL/asyncpg)
############################
# Можно передать готовый DATABASE_URL, либо собрать из частей:
{% set db_user = omni_db_user | default('omni_user') %}
{% set db_pass = omni_db_password | default('CHANGE_ME') %}
{% set db_host = omni_db_host | default('postgres') %}
{% set db_port = omni_db_port | default(5432) %}
{% set db_name = omni_db_name | default('omnimind') %}
{% set db_url_composed = 'postgresql+asyncpg://' ~ db_user ~ ':' ~ db_pass ~ '@' ~ db_host ~ ':' ~ db_port|string ~ '/' ~ db_name %}
DATABASE_URL={{ omni_database_url | default(db_url_composed) }}

DB_POOL_MIN_SIZE={{ omni_db_pool_min | default(5) }}
DB_POOL_MAX_SIZE={{ omni_db_pool_max | default(30) }}
DB_STATEMENTS_TIMEOUT_MS={{ omni_db_statement_timeout | default(15000) }}
DB_CONN_TIMEOUT_MS={{ omni_db_conn_timeout | default(5000) }}
DB_ECHO={{ 'true' if (omni_db_echo | default(false)) else 'false' }}
DB_MIGRATIONS_ON_START={{ 'true' if (omni_db_migrate_on_start | default(true)) else 'false' }}

############################
# 3) REDIS / RATE LIMIT / СЕССИИ
############################
REDIS_URL={{ omni_redis_url | default('redis://redis:6379/0') }}
REDIS_TLS={{ 'true' if (omni_redis_tls | default(false)) else 'false' }}
CACHE_DEFAULT_TTL_SEC={{ omni_cache_ttl | default(300) }}
CACHE_MAX_KEYS={{ omni_cache_max_keys | default(100000) }}

RATE_LIMIT_ENABLED={{ 'true' if (omni_rl_enabled | default(true)) else 'false' }}
RATE_LIMIT_DEFAULT={{ omni_rl_default | default('100r/m') }}
RATE_LIMIT_BURST={{ omni_rl_burst | default(50) }}
RATE_LIMIT_REDIS_PREFIX={{ omni_rl_prefix | default('ratelimit:omnimind') }}

SESSION_ENABLED={{ 'true' if (omni_session_enabled | default(false)) else 'false' }}
SESSION_REDIS_URL={{ omni_session_redis_url | default('redis://redis:6379/0') }}
SESSION_TTL_SEC={{ omni_session_ttl | default(3600) }}

############################
# 4) ОЧЕРЕДИ/ФОН (Celery)
############################
TASKS_ENABLED={{ 'true' if (omni_tasks_enabled | default(true)) else 'false' }}
TASKS_BACKEND={{ omni_tasks_backend | default('celery') }}
CELERY_BROKER_URL={{ omni_celery_broker_url | default('redis://redis:6379/1') }}
CELERY_RESULT_BACKEND={{ omni_celery_result_backend | default('redis://redis:6379/2') }}
CELERY_CONCURRENCY={{ omni_celery_concurrency | default(8) }}
CELERY_PREFETCH_MULT={{ omni_celery_prefetch | default(4) }}
CELERY_TASK_SOFT_TIME_LIMIT_SEC={{ omni_celery_soft_tl | default(60) }}
CELERY_TASK_HARD_TIME_LIMIT_SEC={{ omni_celery_hard_tl | default(90) }}
CELERY_TASK_ACKS_LATE={{ 'true' if (omni_celery_acks_late | default(true)) else 'false' }}
CELERY_WORKER_MAX_TASKS_PER_CHILD={{ omni_celery_max_tasks_per_child | default(1000) }}

############################
# 5) БЕЗОПАСНОСТЬ / JWT / RBAC
############################
JWT_ISSUER={{ omni_jwt_issuer | default('omnimind') }}
JWT_AUDIENCE={{ omni_jwt_audience | default('omnimind-clients') }}
JWT_ALG={{ omni_jwt_alg | default('RS256') }}
JWT_ACCESS_TTL_MIN={{ omni_jwt_access_ttl | default(30) }}
JWT_REFRESH_TTL_HR={{ omni_jwt_refresh_ttl | default(720) }}

# Предпочтительно монтировать ключи в /run/secrets/jwt/*
JWT_PRIVATE_KEY_PATH={{ omni_jwt_private_key_path | default('/run/secrets/jwt/private.pem') }}
JWT_PUBLIC_KEY_PATH={{ omni_jwt_public_key_path | default('/run/secrets/jwt/public.pem') }}
# Inline ПЕМы по умолчанию пустые (небезопасно для prod)
JWT_PRIVATE_KEY_PEM={{ omni_jwt_private_key_pem | default('') }}
JWT_PUBLIC_KEY_PEM={{ omni_jwt_public_key_pem | default('') }}

COOKIE_SECURE={{ 'true' if (omni_cookie_secure | default(true)) else 'false' }}
COOKIE_SAMESITE={{ omni_cookie_samesite | default('Lax') }}

RBAC_DEFAULT_ROLE={{ omni_rbac_default | default('user') }}
RBAC_ADMIN_ROLE={{ omni_rbac_admin | default('admin') }}
RBAC_BOOTSTRAP_ADMIN_EMAIL={{ omni_bootstrap_admin_email | default('admin@change.me') }}
RBAC_BOOTSTRAP_ADMIN_PASSWORD={{ omni_bootstrap_admin_password | default('CHANGE_ME_STRONG') }}

WEBHOOK_SECRET={{ omni_webhook_secret | default('CHANGE_ME') }}

############################
# 6) LLM / EMBEDDINGS / VECTOR STORE
############################
LLM_PROVIDER={{ omni_llm_provider | default('local') }}
LLM_MODEL_DEFAULT={{ omni_llm_model | default('llama-3-8b-instruct') }}
LLM_MAX_TOKENS={{ omni_llm_max_tokens | default(2048) }}
LLM_TEMPERATURE={{ omni_llm_temperature | default(0.2) }}
LLM_TOP_P={{ omni_llm_top_p | default(0.95) }}
LLM_TIMEOUT_SEC={{ omni_llm_timeout | default(60) }}
LLM_SSE_ENABLED={{ 'true' if (omni_llm_sse | default(true)) else 'false' }}
LLM_SEED={{ omni_llm_seed | default(42) }}

OPENAI_API_KEY={{ omni_openai_api_key | default('') }}
OPENAI_BASE_URL={{ omni_openai_base_url | default('https://api.openai.com/v1') }}
AZURE_OPENAI_ENDPOINT={{ omni_azure_openai_endpoint | default('') }}
AZURE_OPENAI_API_KEY={{ omni_azure_openai_api_key | default('') }}
AZURE_OPENAI_DEPLOYMENT={{ omni_azure_openai_deployment | default('') }}
ANTHROPIC_API_KEY={{ omni_anthropic_api_key | default('') }}
ANTHROPIC_BASE_URL={{ omni_anthropic_base_url | default('https://api.anthropic.com') }}
GEMINI_API_KEY={{ omni_gemini_api_key | default('') }}
GEMINI_BASE_URL={{ omni_gemini_base_url | default('https://generativelanguage.googleapis.com') }}
COHERE_API_KEY={{ omni_cohere_api_key | default('') }}

OLLAMA_ENABLED={{ 'true' if (omni_ollama_enabled | default(false)) else 'false' }}
OLLAMA_BASE_URL={{ omni_ollama_base_url | default('http://ollama:11434') }}
VLLM_ENABLED={{ 'true' if (omni_vllm_enabled | default(false)) else 'false' }}
VLLM_BASE_URL={{ omni_vllm_base_url | default('http://vllm:8000') }}

EMBED_PROVIDER={{ omni_embed_provider | default('openai') }}
EMBED_MODEL={{ omni_embed_model | default('text-embedding-3-small') }}
HF_TOKEN={{ omni_hf_token | default('') }}

VSTORE_PROVIDER={{ omni_vstore_provider | default('pgvector') }}
PGVECTOR_SEARCH_SCHEMA={{ omni_pgvector_schema | default('public') }}
PGVECTOR_INDEX_TABLE={{ omni_pgvector_table | default('embeddings') }}
QDRANT_URL={{ omni_qdrant_url | default('http://qdrant:6333') }}
QDRANT_API_KEY={{ omni_qdrant_key | default('') }}
MILVUS_URI={{ omni_milvus_uri | default('http://milvus:19530') }}
MILVUS_USER={{ omni_milvus_user | default('') }}
MILVUS_PASSWORD={{ omni_milvus_password | default('') }}

############################
# 7) S3 / MinIO
############################
S3_ENABLED={{ 'true' if (omni_s3_enabled | default(true)) else 'false' }}
S3_ENDPOINT={{ omni_s3_endpoint | default('http://minio:9000') }}
S3_REGION={{ omni_s3_region | default('us-east-1') }}
S3_ACCESS_KEY_ID={{ omni_s3_access_key | default('CHANGE_ME') }}
S3_SECRET_ACCESS_KEY={{ omni_s3_secret_key | default('CHANGE_ME') }}
S3_BUCKET={{ omni_s3_bucket | default('omnimind-data') }}
S3_FORCE_PATH_STYLE={{ 'true' if (omni_s3_force_path | default(true)) else 'false' }}

############################
# 8) ШИФРОВАНИЕ / KMS / SECRET-MANAGER
############################
SECRET_MANAGER={{ omni_secret_manager | default('env') }}
VAULT_ADDR={{ omni_vault_addr | default('http://vault:8200') }}
VAULT_TOKEN={{ omni_vault_token | default('') }}
VAULT_NAMESPACE={{ omni_vault_ns | default('') }}

KMS_PROVIDER={{ omni_kms_provider | default('none') }}
FERNET_KEY={{ omni_fernet_key | default('CHANGE_ME_32BYTES_BASE64') }}
DATA_ENCRYPTION_ENABLED={{ 'true' if (omni_data_encrypt | default(true)) else 'false' }}

############################
# 9) ПОЧТА/УВЕДОМЛЕНИЯ
############################
SMTP_ENABLED={{ 'true' if (omni_smtp_enabled | default(false)) else 'false' }}
SMTP_HOST={{ omni_smtp_host | default('smtp') }}
SMTP_PORT={{ omni_smtp_port | default(587) }}
SMTP_USER={{ omni_smtp_user | default('no-reply@change.me') }}
SMTP_PASSWORD={{ omni_smtp_password | default('CHANGE_ME') }}
SMTP_TLS={{ 'true' if (omni_smtp_tls | default(true)) else 'false' }}
EMAIL_FROM={{ omni_email_from | default('no-reply@change.me') }}

############################
# 10) ЗДОРОВЬЕ/ЛИМИТЫ/БЕКПРЕШР
############################
READINESS_LAG_SEC={{ omni_readiness_lag | default(5) }}
LIVENESS_PATH={{ omni_liveness_path | default('/healthz') }}
READINESS_PATH={{ omni_readiness_path | default('/readyz') }}
STARTUP_PATH={{ omni_startup_path | default('/startup') }}

MAX_REQUEST_BODY_MB={{ omni_max_body_mb | default(20) }}
CONNECTION_LIMIT={{ omni_conn_limit | default(1000) }}
BACKPRESSURE_ENABLED={{ 'true' if (omni_backpressure | default(true)) else 'false' }}
CIRCUIT_BREAKER_ENABLED={{ 'true' if (omni_cb_enabled | default(true)) else 'false' }}
CIRCUIT_BREAKER_FAILURE_RATE={{ omni_cb_failure_rate | default(0.2) }}
CIRCUIT_BREAKER_MIN_CALLS={{ omni_cb_min_calls | default(50) }}
CIRCUIT_BREAKER_OPEN_SEC={{ omni_cb_open_sec | default(20) }}

############################
# 11) ФИЧ-ФЛАГИ
############################
FEATURE_CHAT={{ 'true' if (omni_feature_chat | default(true)) else 'false' }}
FEATURE_TOOLS={{ 'true' if (omni_feature_tools | default(true)) else 'false' }}
FEATURE_FUNCTION_CALLS={{ 'true' if (omni_feature_fn_calls | default(true)) else 'false' }}
FEATURE_VISION={{ 'true' if (omni_feature_vision | default(false)) else 'false' }}
FEATURE_SPEECH={{ 'true' if (omni_feature_speech | default(false)) else 'false' }}
FEATURE_AGENTIC_WORKFLOWS={{ 'true' if (omni_feature_agentic | default(true)) else 'false' }}
FEATURE_AUDIT_LOGS={{ 'true' if (omni_feature_audit | default(true)) else 'false' }}

############################
# 12) АУДИТ/СООТВЕТСТВИЕ
############################
AUDIT_ENABLED={{ 'true' if (omni_audit_enabled | default(true)) else 'false' }}
AUDIT_SINK={{ omni_audit_sink | default('db') }}
AUDIT_RETENTION_DAYS={{ omni_audit_retention | default(90) }}
PII_REDACTION_ENABLED={{ 'true' if (omni_pii_redaction | default(true)) else 'false' }}
PII_REDACTION_MODE={{ omni_pii_mode | default('strict') }}
COMPLIANCE_GDPR={{ 'true' if (omni_gdpr | default(true)) else 'false' }}
COMPLIANCE_CCPA={{ 'true' if (omni_ccpa | default(false)) else 'false' }}

############################
# 13) ПРОКСИ/ЗАГОЛОВКИ БЕЗОПАСНОСТИ
############################
TRUSTED_PROXY={{ (omni_trusted_proxy | default(['10.0.0.0/8','172.16.0.0/12','192.168.0.0/16'])) | join(',') }}
SECURITY_HEADERS={{ 'true' if (omni_sec_headers | default(true)) else 'false' }}
HSTS_ENABLED={{ 'true' if (omni_hsts_enabled | default(true)) else 'false' }}
HSTS_MAX_AGE={{ omni_hsts_max_age | default(31536000) }}
CONTENT_SECURITY_POLICY={{ omni_csp | default("default-src 'self'") }}

############################
# 14) ВНУТРЕННИЕ ССЫЛКИ
############################
INTERNAL_GATEWAY_URL={{ omni_internal_gateway | default('http://gateway:8080') }}
OBSERVABILITY_URL={{ omni_observability_url | default('http://observability:3000') }}
SECURITY_CORE_URL={{ omni_security_core_url | default('http://platform-security-core:7000') }}

############################
# 15) ДИРЕКТОРИИ
############################
DATA_DIR={{ omni_data_dir | default('/var/lib/omnimind/data') }}
TMP_DIR={{ omni_tmp_dir | default('/tmp/omnimind') }}
MODELS_DIR={{ omni_models_dir | default('/var/lib/omnimind/models') }}
LOG_DIR={{ omni_log_dir | default('/var/log/omnimind') }}

############################
# 16) GPU/NUMA/BLAS
############################
CUDA_VISIBLE_DEVICES={{ omni_cuda_visible | default('0') }}
OMP_NUM_THREADS={{ omni_omp_threads | default(8) }}
MKL_NUM_THREADS={{ omni_mkl_threads | default(8) }}
INFERENCE_BATCH_SIZE={{ omni_infer_batch | default(1) }}
INFERENCE_MAX_CONCURRENCY={{ omni_infer_conc | default(2) }}

############################
# 17) E2E/SMOKE
############################
E2E_TEST_USER_EMAIL={{ omni_e2e_email | default('tester@change.me') }}
E2E_TEST_USER_PASSWORD={{ omni_e2e_password | default('CHANGE_ME') }}
SMOKE_TESTS_ENABLED={{ 'true' if (omni_smoke_enabled | default(false)) else 'false' }}

############################
# 18) ПРОИЗВОЛЬНЫЕ ПАРЫ ИЗ extra_env (если заданы)
############################
{% if extra_env is defined and extra_env %}
# Дополнительные пары из extra_env:
{%   for k, v in extra_env.items() %}
{{ k }}={{ v }}
{%   endfor %}
{% endif %}
