# Omnimind Core — Security Profile
# Назначение: единый профиль харднинга для ролей Ansible.
# Применение: добавьте в group_vars либо подмешайте через vars_files в плейбуке.

profile_version: "1.0"

enforcement:
  enable: true            # включить применение харднинга
  dry_run: false          # только валидация без изменений (если роль поддерживает)
  os_family_matrix:
    debian: true
    redhat: true

identity:
  managed_users:
    - name: "omnimind"
      uid: null
      gid: null
      groups: ["omnimind","systemd-journal"]
      shell: "/usr/sbin/nologin"
      create_home: false
  umask_default: "0027"

ssh:
  manage: true
  service_name: "sshd"
  port: 22
  listen_addresses: ["0.0.0.0"]
  allow_groups: ["omnimind","admin"]
  allow_users: []          # при необходимости ограничьте конкретными пользователями
  deny_users: []
  permit_root_login: "no"
  password_authentication: "no"
  pubkey_authentication: "yes"
  kbd_interactive_authentication: "no"
  challenge_response_authentication: "no"
  x11_forwarding: "no"
  permit_empty_passwords: "no"
  allow_tcp_forwarding: "no"
  gateway_ports: "no"
  use_dns: "no"
  login_grace_time: "20s"
  client_alive_interval: 30
  client_alive_count_max: 2
  max_auth_tries: 3
  max_sessions: 4
  ciphers:
    - "chacha20-poly1305@openssh.com"
    - "aes256-gcm@openssh.com"
    - "aes256-ctr"
  kex_algorithms:
    - "curve25519-sha256"
    - "curve25519-sha256@libssh.org"
    - "diffie-hellman-group16-sha512"
  macs:
    - "hmac-sha2-512-etm@openssh.com"
    - "hmac-sha2-256-etm@openssh.com"
  banner: ""              # путь к баннеру или пусто
  log_level: "VERBOSE"
  allow_agent_forwarding: "no"
  print_lastlog: "yes"

firewall:
  manage: true
  provider: "auto"         # auto | ufw | firewalld | nftables
  default_input_policy: "deny"
  default_output_policy: "allow"
  default_forward_policy: "deny"
  rules:
    inbound:
      - { proto: "tcp", port: 22, src: "0.0.0.0/0", comment: "SSH" }
      - { proto: "tcp", port: 8080, src: "0.0.0.0/0", comment: "App HTTP" }
    outbound:
      - { proto: "tcp", port: "53", dst: "0.0.0.0/0", comment: "DNS" }
      - { proto: "udp", port: "53", dst: "0.0.0.0/0", comment: "DNS" }

sysctl:
  manage: true
  params:
    kernel.randomize_va_space: 2
    kernel.kptr_restrict: 2
    kernel.dmesg_restrict: 1
    kernel.yama.ptrace_scope: 1
    fs.protected_hardlinks: 1
    fs.protected_symlinks: 1
    fs.suid_dumpable: 0
    net.ipv4.ip_forward: 0
    net.ipv4.conf.all.accept_redirects: 0
    net.ipv4.conf.default.accept_redirects: 0
    net.ipv4.conf.all.send_redirects: 0
    net.ipv4.conf.default.send_redirects: 0
    net.ipv4.conf.all.accept_source_route: 0
    net.ipv4.conf.default.accept_source_route: 0
    net.ipv4.conf.all.rp_filter: 1
    net.ipv4.conf.default.rp_filter: 1
    net.ipv4.tcp_syncookies: 1
    net.ipv4.tcp_rfc1337: 1
    net.ipv4.icmp_echo_ignore_broadcasts: 1
    net.ipv4.icmp_ignore_bogus_error_responses: 1
    net.ipv6.conf.all.accept_redirects: 0
    net.ipv6.conf.default.accept_redirects: 0
    net.ipv6.conf.all.disable_ipv6: 0
    net.ipv6.conf.default.disable_ipv6: 0
    net.core.bpf_jit_harden: 2
    vm.mmap_min_addr: 65536
    vm.overcommit_memory: 0
    vm.panic_on_oom: 0

kernel_modules:
  manage: true
  blacklist:
    - "cramfs"
    - "freevxfs"
    - "jffs2"
    - "hfs"
    - "hfsplus"
    - "squashfs"
    - "udf"
    - "dccp"
    - "sctp"
    - "rds"
    - "tipc"
    - "bluetooth"
    - "usb-storage"
  persist_path: "/etc/modprobe.d/omnimind-blacklist.conf"

selinux_apparmor:
  manage: true
  selinux:
    enable: true
    state: "enforcing"     # enforcing | permissive | disabled
    policy: "targeted"
  apparmor:
    enable: true
    enforce_profiles: []   # список профилей для enforce

packages:
  ensure_absent: true
  forbidden:
    - "telnet"
    - "rsh-client"
    - "rlogin"
    - "talk"
    - "tftp"
    - "vsftpd"
    - "xinetd"
    - "ftp"
    - "nfs-kernel-server"
  minimum_set:
    - "curl"
    - "vim"
    - "tar"
    - "gzip"
    - "unzip"
    - "chrony"             # или ntp на старых системах

time_sync:
  manage: true
  provider: "chrony"
  servers:
    - "time.cloudflare.com"
    - "time.google.com"

auditd:
  manage: true
  rules_profile: "strict"
  buffer_size: 8192
  max_log_file_mb: 50
  max_log_file_action: "keep_logs"
  space_left_pct: 25
  action_mail_acct: "root"
  admin_space_left_pct: 10
  admin_space_left_action: "halt"
  rate_limit: 0
  immutable_rules: true
  extra_rules: []          # дополнительные auditd-правила по среде

fail2ban:
  manage: true
  bantime: "1h"
  findtime: "10m"
  maxretry: 5
  destemail: "root@localhost"
  sender: "fail2ban@localhost"
  action: "action_mwl"
  jails:
    sshd:
      enabled: true
      port: "ssh"
      filter: "sshd"
      logpath:
        - "/var/log/auth.log"
        - "/var/log/secure"
      backend: "systemd"

pam:
  manage: true
  pwquality:
    minlen: 12
    dcredit: -1
    ucredit: -1
    lcredit: -1
    ocredit: -1
    retry: 3
  faillock:
    deny: 5
    unlock_time: 900
    even_deny_root: true
    audit: true
  pwhistory:
    remember: 12
    enforce_for_root: true

sudo:
  manage: true
  require_tty: true
  use_pty: true
  wheel_group: "admin"
  nopasswd: false
  whitelist_commands: []    # при необходимости ограничьте конкретными командами

filesystems:
  manage: true
  mounts:
    - mount: "/tmp"
      opts: ["nodev","nosuid","noexec"]
    - mount: "/var/tmp"
      opts: ["nodev","nosuid","noexec","bind"]
    - mount: "/home"
      opts: ["nodev"]
    - mount: "/dev/shm"
      opts: ["nodev","nosuid","noexec"]
  sticky_dirs:
    - "/tmp"
    - "/var/tmp"

logging:
  journald:
    manage: true
    persistent: true
    compress: true
    seal: true
    rate_limit_interval_sec: "30s"
    rate_limit_burst: 2000
    system_max_use: "2G"
    system_keep_free: "512M"
    system_max_file_size: "128M"
    runtime_max_use: "512M"
    runtime_keep_free: "256M"
    max_retention_sec: ""
    max_file_sec: "1day"
  logrotate:
    manage: true
    paths: ["/var/log/omnimind/*.log"]
    frequency: "daily"
    size: "256M"
    rotate: 14
    maxage: 30
    compress: true
    dateext: true
    dateformat: ".%Y-%m-%d"
    copytruncate: true
    create_mode: "0640"
    create_user: "omnimind"
    create_group: "omnimind"
    su_user: "root"
    su_group: "adm"
    sharedscripts: true
    postrotate_timeout: 10
    pid_file: ""
    systemd_unit: ""

integrity:
  aide:
    manage: false         # при необходимости включите и задайте политику AIDE
    database_path: "/var/lib/aide/aide.db"
    config_path: "/etc/aide/aide.conf"
    cron_enabled: true
    cron_time: "03:30"

secrets:
  transport: "ansible_vault"  # способ передачи секретов
  allow_plaintext: false

exceptions:
  # Список осознанных отклонений от профиля
  rules: []                   # пример: [{ id: "SSH-PORT-CHANGE", reason: "bastion design", expires: "2026-01-01" }]

telemetry:
  export_node_metrics: true   # включение node_exporter вне рамок этого профиля
