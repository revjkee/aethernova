# automation-core/mypy.ini
# Промышленная конфигурация mypy для строгой типизации.
# Источники:
# - mypy config: https://mypy.readthedocs.io/en/stable/config_file.html
# - pydantic mypy plugin: https://docs.pydantic.dev/latest/integrations/mypy/
# - sqlalchemy mypy plugin: https://docs.sqlalchemy.org/en/20/orm/extensions/mypy.html

[mypy]
python_version = 3.11
# Основной строгий профиль
strict = True
# Явные полезные флаги (дублируют часть strict, фиксируем для наглядности)
warn_unused_configs = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
warn_unreachable = True
no_implicit_optional = True
strict_equality = True
disallow_any_generics = True
disallow_subclassing_any = True
disallow_untyped_defs = True
disallow_incomplete_defs = True
check_untyped_defs = True
# Вывод
color_output = True
pretty = True
show_error_codes = True
error_summary = True
# Поиск пакетов/стабов
namespace_packages = True
explicit_package_bases = True
# Плагины (см. источники выше)
plugins = pydantic.mypy, sqlalchemy.ext.mypy.plugin
# Покрытие файлов
files = .
# Исключения из обхода (артефакты сборки, виртуальные окружения, фронтенд)
exclude = (?x)(
    ^\.venv/|
    ^venv/|
    ^env/|
    ^build/|
    ^dist/|
    ^node_modules/|
    ^.*/__pycache__/|
    ^docs/_build/
)$

# -----------------------------
# Третий-сторонние и инфраструктурные модули
# -----------------------------
# В продакшене лучше добавить types-* stubs; до того игнорируем типы из опциональных зависимостей.
[mypy-alembic.*]
ignore_missing_imports = True

[mypy-uvicorn.*]
ignore_missing_imports = True

[mypy-redis.*]
ignore_missing_imports = True

[mypy-aioredis.*]
ignore_missing_imports = True

[mypy-uvloop.*]
ignore_missing_imports = True

[mypy-requests.*]
ignore_missing_imports = True

[mypy-httpx.*]
ignore_missing_imports = True

[mypy-fastapi.*]
# FastAPI аннотирован, но часть расширений может не иметь стабильных типов.
ignore_missing_imports = True

[mypy-starlette.*]
ignore_missing_imports = True

[mypy-pytest.*]
ignore_missing_imports = True

[mypy-opentelemetry.*]
ignore_missing_imports = True

[mypy-loguru.*]
ignore_missing_imports = True

# -----------------------------
# Тесты: разумное ослабление строгости
# -----------------------------
[mypy-tests.*]
disallow_untyped_defs = False
disallow_incomplete_defs = False
check_untyped_defs = True
allow_redefinition = True

# Поддержка test-папок вне namespace (если структура иная — оставьте как есть)
[mypy-test.*]
disallow_untyped_defs = False
disallow_incomplete_defs = False
check_untyped_defs = True
allow_redefinition = True

# -----------------------------
# Скрипты и утилиты: допускаем частично нетипизированный код
# -----------------------------
[mypy-scripts.*]
disallow_untyped_defs = False
disallow_incomplete_defs = False
check_untyped_defs = True

# -----------------------------
# Примеры интеграций с Pydantic plugin (см. оф. документацию)
# -----------------------------
[pydantic-mypy]
# Инициализаторы моделей считаются типизированными по аннотациям полей
init_typed = True
# Предупреждать о нетипизированных полях моделей
warn_untyped_fields = True
# Предупреждать о неиспользуемых настройках плагина
warn_unused_configs = True

# -----------------------------
# Локальные стаб-пакеты (если используете custom stubs)
# -----------------------------
[mypy-stubs.*]
ignore_errors = False
disallow_untyped_defs = True
