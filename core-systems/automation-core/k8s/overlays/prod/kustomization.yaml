apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Базовые манифесты приложения
resources:
  - ../../base

# Пространство имён и суффикс имён ресурсов для прод-окружения
namespace: production
nameSuffix: -prod

# Единообразные метки и аннотации для трассируемости
commonLabels:
  app.kubernetes.io/part-of: automation-core
  app.kubernetes.io/environment: production
  environment: prod

commonAnnotations:
  owner: platform-team
  policy.aethernova/change-verified: "true"

# Жёсткий пининг контейнеров на digest для воспроизводимости релизов
# (замените имена/диджесты на фактические значения вашего реестра)
images:
  - name: ghcr.io/example/automation-core-api
    newName: ghcr.io/example/automation-core-api
    digest: sha256:1111111111111111111111111111111111111111111111111111111111111111
  - name: ghcr.io/example/automation-core-worker
    newName: ghcr.io/example/automation-core-worker
    digest: sha256:2222222222222222222222222222222222222222222222222222222222222222

# Inline-патчи прод-политик (без отдельных файлов)
patches:
  # 1) Установить количество реплик для всех Deployment в проде
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  # 2) Добавить pod-level seccomp по умолчанию (RuntimeDefault) для Deployment
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext
        value:
          seccompProfile:
            type: RuntimeDefault

  # 3) Аналогичный seccomp-патч для StatefulSet
  - target:
      group: apps
      version: v1
      kind: StatefulSet
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext
        value:
          seccompProfile:
            type: RuntimeDefault

  # 4) Аналогичный seccomp-патч для DaemonSet
  - target:
      group: apps
      version: v1
      kind: DaemonSet
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext
        value:
          seccompProfile:
            type: RuntimeDefault

  # 5) Топология развёртывания: распределять поды по нодам (hostname)
  #    Использует общие метки commonLabels (part-of/environment)
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/topologySpreadConstraints
        value:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: ScheduleAnyway
            labelSelector:
              matchLabels:
                app.kubernetes.io/part-of: automation-core
                app.kubernetes.io/environment: production

# Генераторы (если используются в base) оставляем с хэш-сууффиксом по умолчанию
# для корректных rollout (не отключаем disableNameSuffixHash).
# generatorOptions:
#   disableNameSuffixHash: false
