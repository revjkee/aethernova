# automation-core/k8s/base/secret.yaml
# ExternalSecret: промышленные секреты без хранения в git в открытом виде.
# Документация External Secrets (v1beta1, templating v2): https://external-secrets.io/
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: automation-core-secrets
  namespace: automation-core
  labels:
    app.kubernetes.io/name: automation-core
    app.kubernetes.io/part-of: automation-core
    app.kubernetes.io/component: api
  annotations:
    # Метки/аннотации на ExternalSecret будут скопированы в создаваемый Secret.
    # См. "labels and annotations are copied over to the secret" в API-примере.
    # Источник: external-secrets.io API example.
    external-secrets.io/documentation: "https://external-secrets.io/"
spec:
  # Периодическая ресинхронизация значений из внешнего хранилища
  refreshInterval: 15m

  # Ссылка на SecretStore/ClusterSecretStore, настроенный платформенно (Vault/ASM/GSM и т.д.)
  # Имя и kind должны соответствовать существующему объекту провайдера секретов.
  secretStoreRef:
    kind: ClusterSecretStore
    name: global-secrets

  # Итоговый Secret, который появится в кластере
  target:
    name: automation-core-env
    creationPolicy: Owner
    template:
      # Тип создаваемого Kubernetes Secret
      type: Opaque
      # Шаблонизатор v2 — актуальный механизм преобразования данных
      engineVersion: v2
      # Итоговые ключи и их значения. Ключи равны переменным окружения приложения.
      data:
        DATABASE_URL: "{{ .DATABASE_URL }}"
        REDIS_URL: "{{ .REDIS_URL }}"
        SENTRY_DSN: "{{ .SENTRY_DSN | default \"\" }}"
        JWT_SECRET: "{{ .JWT_SECRET }}"

  # Какие ключи и откуда забирать из внешнего хранилища:
  # Ниже пример, где все значения лежат в записи/пути "automation-core/prod"
  # с соответствующими полями. Поле optional допускает отсутствие (например, SENTRY_DSN).
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: automation-core/prod
        property: DATABASE_URL
    - secretKey: REDIS_URL
      remoteRef:
        key: automation-core/prod
        property: REDIS_URL
    - secretKey: SENTRY_DSN
      remoteRef:
        key: automation-core/prod
        property: SENTRY_DSN
      optional: true
    - secretKey: JWT_SECRET
      remoteRef:
        key: automation-core/prod
        property: JWT_SECRET
