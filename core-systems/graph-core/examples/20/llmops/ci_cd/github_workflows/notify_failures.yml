name: Notify on CI Failures

on:
  workflow_run:
    workflows: [build, test, deploy_staging, deploy_prod, retrain_pipeline]
    types:
      - completed

jobs:
  notify-failure:
    name: Failure Notifier
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Extract info
        run: |
          echo "FAILED_WORKFLOW=${{ github.event.workflow_run.name }}" >> $GITHUB_ENV
          echo "FAILED_BRANCH=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          echo "FAILED_COMMIT=${{ github.event.workflow_run.head_commit.id }}" >> $GITHUB_ENV
          echo "COMMIT_MSG=${{ github.event.workflow_run.head_commit.message }}" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_ENV
          echo "RUN_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV

      - name: Notify via Telegram
        if: env.TELEGRAM_ENABLED == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="ðŸš¨ CI Failure in ${{ env.FAILED_WORKFLOW }}  
Repo: ${{ env.REPO_NAME }}  
Branch: ${{ env.FAILED_BRANCH }}  
Commit: ${{ env.FAILED_COMMIT }}  
Message: ${{ env.COMMIT_MSG }}  
Details: ${{ env.RUN_URL }}"

      - name: Notify via Slack
        if: env.SLACK_ENABLED == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "*CI Failure in `${{ env.FAILED_WORKFLOW }}`*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸ”´ Workflow `${{ env.FAILED_WORKFLOW }}` failed.\n*Repo:* ${{ env.REPO_NAME }}\n*Branch:* `${{ env.FAILED_BRANCH }}`\n*Commit:* `${{ env.FAILED_COMMIT }}`\n*Message:* ${{ env.COMMIT_MSG }}\n*Details:* <${{ env.RUN_URL }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify via Email
        if: env.EMAIL_ENABLED == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "CI Failure in ${{ env.FAILED_WORKFLOW }}"
          body: |
            CI Workflow failed in repository ${{ env.REPO_NAME }}.

            Workflow: ${{ env.FAILED_WORKFLOW }}
            Branch: ${{ env.FAILED_BRANCH }}
            Commit: ${{ env.FAILED_COMMIT }}
            Message: ${{ env.COMMIT_MSG }}
            Details: ${{ env.RUN_URL }}

          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: GitHub CI Notifier <${{ secrets.EMAIL_USERNAME }}>
