# -*- mode: ruby -*-
# vi: set ft=ruby :

VAGRANTFILE_API_VERSION = "2"

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  # Базовый образ — Ubuntu 22.04 LTS
  config.vm.box = "ubuntu/jammy64"

  # Имя виртуальной машины
  config.vm.hostname = "teslaai-orchestrator"

  # Настройка сети: проброс портов для доступа к сервисам
  config.vm.network "forwarded_port", guest: 8080, host: 8080, auto_correct: true
  config.vm.network "private_network", type: "dhcp"

  # Настройка провайдера VirtualBox
  config.vm.provider "virtualbox" do |vb|
    vb.name = "teslaai-orchestrator-vm"
    vb.memory = 4096
    vb.cpus = 2
  end

  # Автоматический запуск скриптов настройки (примитивный provisioning)
  config.vm.provision "shell", inline: <<-SHELL
    # Обновление системы
    apt-get update && apt-get upgrade -y

    # Установка необходимых пакетов
    apt-get install -y python3 python3-pip docker.io

    # Добавление пользователя vagrant в группу docker
    usermod -aG docker vagrant

    # Запуск и включение Docker
    systemctl enable docker
    systemctl start docker
  SHELL

  # Синхронизация локальной папки с папкой на гостевой машине
  config.vm.synced_folder ".", "/home/vagrant/orchestrator", type: "virtualbox"

  # Отключение DNS резолвинга в VirtualBox (если требуется)
  # config.vm.provider "virtualbox" do |vb|
  #   vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
  # end

  # Параметры SSH (стандартные)
  config.ssh.insert_key = true
end
