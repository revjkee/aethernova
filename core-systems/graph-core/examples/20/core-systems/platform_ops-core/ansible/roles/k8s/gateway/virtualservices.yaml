apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: teslaai-api-virtualservice
  namespace: gateway
  labels:
    app.kubernetes.io/name: teslaai-api
    app.kubernetes.io/component: virtualservice
    app.kubernetes.io/part-of: teslaai
    version: v20x-industrial
    zero-trust: enforced
spec:
  hosts:
    - "api.teslaai.io"
  gateways:
    - teslaai-gateway
  http:
    - name: "api-core-v1"
      match:
        - uri:
            prefix: /api/v1/
      route:
        - destination:
            host: backend-service.backend.svc.cluster.local
            subset: v1
            port:
              number: 80
          weight: 100
      timeout: 10s
      retries:
        attempts: 3
        perTryTimeout: 3s
        retryOn: gateway-error,connect-failure,refused-stream
      fault:
        delay:
          fixedDelay: 1s
          percentage:
            value: 5
      headers:
        request:
          add:
            x-teslaai-route: core-v1

---

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: teslaai-webui-virtualservice
  namespace: gateway
spec:
  hosts:
    - "webui.teslaai.io"
  gateways:
    - teslaai-gateway
  http:
    - name: "web-ui"
      match:
        - uri:
            prefix: /
      route:
        - destination:
            host: webui-service.webui.svc.cluster.local
            port:
              number: 80
          weight: 100
      corsPolicy:
        allowOrigins:
          - exact: "https://web.teslaai.io"
        allowMethods: ["GET", "POST", "OPTIONS"]
        allowCredentials: true
        maxAge: "24h"

---

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: teslaai-agents-virtualservice
  namespace: gateway
spec:
  hosts:
    - "agents.teslaai.io"
  gateways:
    - teslaai-gateway
  http:
    - name: "agent-dispatch"
      match:
        - headers:
            x-agent-type:
              exact: planner
      route:
        - destination:
            host: planner-agent.agents.svc.cluster.local
            port:
              number: 80
      - match:
        - headers:
            x-agent-type:
              exact: rl
        route:
          - destination:
              host: rl-agent.agents.svc.cluster.local
              port:
                number: 80
      timeout: 6s
      retries:
        attempts: 2
        perTryTimeout: 2s
