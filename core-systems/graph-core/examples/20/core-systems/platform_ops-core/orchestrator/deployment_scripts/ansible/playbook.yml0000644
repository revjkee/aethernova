---
- name: Основной плейбук для деплоя инфраструктуры
  hosts: all
  become: yes
  vars:
    timezone: "UTC"
    max_open_files: 65536
    users:
      - name: deployer
        groups: sudo
        ssh_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
  pre_tasks:
    - name: Обновление apt-кэша (для Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Установка базовых пакетов (curl, git, python3)
      package:
        name:
          - curl
          - git
          - python3
          - python3-pip
        state: present

    - name: Настройка timezone
      timezone:
        name: "{{ timezone }}"

    - name: Установка лимитов max open files
      copy:
        dest: /etc/security/limits.d/99-custom.conf
        content: |
          *               soft    nofile          {{ max_open_files }}
          *               hard    nofile          {{ max_open_files }}

  tasks:
    - name: Создание пользователя деплоя
      user:
        name: "{{ item.name }}"
        groups: "{{ item.groups }}"
        append: yes
        state: present
        shell: /bin/bash
      loop: "{{ users }}"

    - name: Установка ssh ключа для пользователя деплоя
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.ssh_key }}"
      loop: "{{ users }}"

    - name: Установка Python зависимостей
      pip:
        name:
          - boto3
          - ansible
        state: present

  handlers:
    - name: Перезагрузка ssh сервиса
      service:
        name: ssh
        state: restarted

    - name: Перезагрузка системы
      reboot:

