# /orchestrator/deployment_scripts/ansible/roles/webserver/tests/database/test.yml

---
- name: Run integration tests for database configuration
  hosts: test-db
  gather_facts: false
  vars_files:
    - vars/main.yml

  pre_tasks:
    - name: Ensure required packages are installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      loop:
        - postgresql
        - python3-psycopg2
      become: true

  tasks:
    - name: Apply database configuration template
      ansible.builtin.template:
        src: templates/db_config.j2
        dest: /etc/postgresql/{{ db_version }}/main/postgresql.conf
      become: true
      notify: Restart test database service

    - name: Initialize test database if not present
      ansible.builtin.command: psql -f /etc/ansible/files/init_db.sql
      args:
        creates: /var/lib/postgresql/data/initialized.flag
      become: true

  handlers:
    - name: Restart test database service
      ansible.builtin.systemd:
        name: "{{ test_db_service_name | default('postgresql') }}"
        state: restarted
      become: true
