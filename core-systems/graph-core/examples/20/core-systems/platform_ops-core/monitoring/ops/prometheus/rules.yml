groups:
  - name: system-alerts
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Инстанс {{ $labels.instance }} недоступен"
          description: "Инстанс {{ $labels.instance }} на {{ $labels.job }} не отвечает более 5 минут."

      - alert: HighCPUUsage
        expr: 100 * (1 - avg by(instance)(irate(node_cpu_seconds_total{mode="idle"}[5m]))) > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Высокая загрузка CPU на {{ $labels.instance }}"
          description: "Средняя загрузка CPU превышает 85% более 10 минут."

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Высокое использование памяти на {{ $labels.instance }}"
          description: "Использование памяти превышает 90% более 10 минут."

      - alert: DiskRunningOut
        expr: (node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_free_bytes{mountpoint="/"}) / node_filesystem_size_bytes{mountpoint="/"} > 0.85
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "Мало свободного места на диске на {{ $labels.instance }}"
          description: "Свободное место на корневом разделе меньше 15% более 15 минут."

      - alert: PrometheusTargetDown
        expr: up{job="prometheus"} == 0
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "Prometheus таргет {{ $labels.instance }} недоступен"
          description: "Prometheus не получает данные с таргета {{ $labels.instance }} более 3 минут."

      - alert: KubernetesPodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Под Kubernetes {{ $labels.pod }} перезапускается"
          description: "Контейнер в поде {{ $labels.pod }} перезапускается более одного раза за 5 минут."

      - alert: NetworkHighLatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокая задержка сети (99-й перцентиль > 1с)"
          description: "99-й перцентиль задержки HTTP запросов превышает 1 секунду."

