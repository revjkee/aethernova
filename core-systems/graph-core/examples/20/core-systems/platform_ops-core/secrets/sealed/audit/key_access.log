#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

# === TeslaAI Key Rotator v1.0 ===
# Автоматическая безопасная ротация ключей (Vault Transit, AWS KMS, GPG, GCP KMS)

log() {
  echo "[$(date '+%Y-%m-%dT%H:%M:%S%z')] $1" | tee -a "/devops/secrets/encryption_keys/audit/key_rotation.log"
}

error_exit() {
  log "ERROR: $1"
  exit 1
}

backup_dir="/devops/secrets/encryption_keys/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$backup_dir"

log "Инициализация резервного копирования..."
cp -r /devops/secrets/encryption_keys/gpg "$backup_dir/" || error_exit "Не удалось создать резервную копию GPG ключей"
cp -r /devops/secrets/encryption_keys/vault/kv "$backup_dir/" || error_exit "Не удалось создать резервную копию Vault KV"
cp -r /devops/secrets/encryption_keys/vault/kms "$backup_dir/" || error_exit "Не удалось создать резервную копию KMS"
log "Резервное копирование завершено"

# === GPG ROTATION ===
log "Ротация GPG ключей..."
gpg --batch --yes --delete-secret-keys "TeslaAI Master Key" || true
gpg --batch --generate-key /devops/secrets/encryption_keys/rotator/gpg_key_config || error_exit "GPG ключ не сгенерирован"
log "GPG ключ ротации завершена"

# === VAULT TRANSIT ROTATION ===
log "Ротация ключа Vault Transit..."
vault write -f transit/keys/master/rotate || error_exit "Ошибка ротации Vault Transit"
log "Vault Transit ключ успешно обновлён"

# === AWS KMS ROTATION ===
log "Ротация AWS KMS ключей..."
aws kms enable-key-rotation --key-id "$(cat /devops/secrets/encryption_keys/vault/kms/aws/kms_key_id.txt)" || error_exit "AWS ротация не выполнена"
log "Ротация AWS KMS завершена"

# === GCP KMS ROTATION ===
log "Ротация GCP KMS ключей..."
gcp_key_id="$(cat /devops/secrets/encryption_keys/vault/kms/gcp/kms_key_id.txt)"
gcloud kms keys set-rotation-schedule "$gcp_key_id" --rotation-period="90d" || error_exit "Ошибка GCP KMS ротации"
log "Ротация GCP KMS завершена"

# === POST-VALIDATION ===
log "Валидация новых ключей..."
gpg --list-keys | grep "TeslaAI" || error_exit "GPG ключ не найден"
vault read transit/keys/master | grep latest_version || error_exit "Vault ключ не валиден"
log "Валидация успешно завершена"

log "Ротация завершена успешно. Все ключи обновлены."
exit 0
