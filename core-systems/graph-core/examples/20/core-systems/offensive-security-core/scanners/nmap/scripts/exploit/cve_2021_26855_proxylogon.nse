-- cve_2021_26855_proxylogon.nse
--
-- Проверка уязвимости ProxyLogon в Microsoft Exchange (CVE-2021-26855)
--
-- Требования:
--   nmap 7.80+
--
-- Автор: TeslaAI Expert
-- Лицензия: Same as Nmap

local nmap = require "nmap"
local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"
local json = require "json"

description = [[
Проверяет уязвимость ProxyLogon (CVE-2021-26855) в Microsoft Exchange Server, позволяющую выполнить удалённое выполнение кода.
]]

author = "TeslaAI Expert"

license = "Same as Nmap--See https://nmap.org/book/man-legal.html"

categories = {"exploit", "vuln"}

portrule = shortport.http

local function check_proxylogon(host, port)
  local target_url = string.format("https://%s:%d/owa/auth/x.js", host.targetname or host.ip, port.number)

  local response = http.get(host, port, "/owa/auth/x.js", { ssl = true })
  if not response then
    return nil, "Нет ответа от сервера"
  end

  if response.status == 200 and response.body and response.body:find("function") then
    return true, "Обнаружен подозрительный ответ, возможна уязвимость ProxyLogon"
  end

  return false, "Уязвимость не обнаружена"
end

action = function(host, port)
  local status, result = check_proxylogon(host, port)
  if not status then
    return "Проверка не удалась: " .. (result or "неизвестная ошибка")
  end
  return result
end
