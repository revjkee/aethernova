apiVersion: teslaai.org/v1
kind: RetentionPolicy
metadata:
  name: global-retention-policy
  namespace: observability
  labels:
    environment: production
    owner: teslaai-genesis
    policy-tier: core

spec:
  retentionClasses:
    - name: critical-metrics
      match:
        category: metrics
        severity: critical
      ttl: 90d
      storageTier: hot
      compress: true
      archiveAfter: 60d

    - name: core-traces
      match:
        category: traces
        source:
          - ai-core
          - agent-manager
      ttl: 30d
      compress: true
      storageTier: warm
      redactSensitive: true

    - name: fallback-logs
      match:
        category: logs
        tag: fallback
      ttl: 14d
      compress: true
      storageTier: cold
      archiveAfter: 7d
      deduplicate: true

    - name: infra-backups
      match:
        category: backups
        component:
          - postgres
          - redis
          - rabbitmq
      ttl: 180d
      replication: 2
      encryption: true
      geoRedundant: true
      archiveAfter: 30d

    - name: incident-snapshots
      match:
        category: snapshots
        tag: incident
      ttl: 365d
      quarantinePeriod: 15d
      auditRequired: true
      priorityDelete: false
      storageTier: cold
      encrypt: true

    - name: low-value-metrics
      match:
        category: metrics
        severity: low
      ttl: 3d
      dropAfter: true

  default:
    ttl: 30d
    compress: true
    dropAfter: false
    archiveAfter: 15d
    storageTier: warm

  lifecycleControllers:
    - name: retention-cleaner
      schedule: "0 */6 * * *"  # каждые 6 часов
      strategy: label-match
      mode: safe-delete
      logLevel: info
      gracePeriod: 120s
      metrics:
        enabled: true
        pushGateway: http://prometheus-push:9091

  audit:
    enabled: true
    logFormat: json
    destination: s3://teslaai-audit/retention-log/
    rotationPolicy:
      maxSizeMB: 100
      maxAgeDays: 7

  notifications:
    onPurge:
      webhook: https://alert.teslaai.org/notify/retention-purge
    onFailure:
      email: security@teslaai.org
