{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.neurocity.ai/physical/v1/plc_mapping.schema.json",
  "title": "NeuroCity Physical Integration Core — PLC Mapping Schema (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "metadata", "defaults", "endpoints", "signals"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Версия схемы в формате SemVer",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0"]
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["site_id", "area", "owner", "generated_at"],
      "properties": {
        "site_id": { "type": "string", "minLength": 1 },
        "area": { "type": "string", "minLength": 1 },
        "cell": { "type": "string" },
        "owner": {
          "type": "object",
          "additionalProperties": false,
          "required": ["org", "team", "contact"],
          "properties": {
            "org": { "type": "string", "minLength": 1 },
            "team": { "type": "string", "minLength": 1 },
            "contact": { "type": "string", "minLength": 3 }
          }
        },
        "generated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO‑8601 момент генерации файла"
        },
        "description": { "type": "string" }
      }
    },
    "defaults": {
      "type": "object",
      "additionalProperties": false,
      "required": ["poll_rate_ms", "timeout_ms", "byte_order", "quality_policy"],
      "properties": {
        "poll_rate_ms": { "type": "integer", "minimum": 10, "maximum": 60000, "default": 200 },
        "timeout_ms": { "type": "integer", "minimum": 50, "maximum": 60000, "default": 2000 },
        "deadband": { "type": "number", "minimum": 0 },
        "byte_order": { "type": "string", "enum": ["big_endian", "little_endian"] },
        "word_order": { "type": "string", "enum": ["normal", "abcd", "badc", "cdab", "dcba"], "default": "normal" },
        "qos": { "type": "string", "enum": ["at_most_once", "at_least_once", "exactly_once"], "default": "at_least_once" },
        "retry_policy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "max_retries": { "type": "integer", "minimum": 0, "maximum": 10, "default": 3 },
            "backoff_ms": { "type": "integer", "minimum": 0, "maximum": 60000, "default": 500 }
          }
        },
        "quality_policy": {
          "type": "string",
          "enum": ["fail_on_bad", "hold_last", "substitute_default"],
          "default": "hold_last"
        }
      }
    },
    "endpoints": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": { "$ref": "#/$defs/endpoint" },
      "description": "Каталог подключений к PLC/контроллерам/OPC‑UA серверам"
    },
    "signals": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": { "$ref": "#/$defs/signal" },
      "description": "Реестр сигналов c протокол‑специфичной адресацией"
    },
    "tests": {
      "type": "array",
      "items": { "$ref": "#/$defs/test_vector" },
      "description": "Набор тест‑векторов и проверок маппинга"
    }
  },
  "$defs": {
    "endpoint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["endpoint_id", "vendor", "model", "protocol", "connection"],
      "properties": {
        "endpoint_id": { "type": "string", "pattern": "^[a-z0-9_\\-\\.]{3,64}$" },
        "vendor": {
          "type": "string",
          "enum": ["Siemens", "Rockwell", "Beckhoff", "Schneider", "Mitsubishi", "Omron", "ABB", "Wago", "Codesys", "Generic"]
        },
        "model": { "type": "string", "minLength": 1 },
        "firmware": { "type": "string" },
        "protocol": {
          "type": "string",
          "enum": ["S7", "EtherNetIP", "ModbusTCP", "OPCUA", "ADS", "Profinet", "DNP3", "BACnetIP", "Custom"]
        },
        "safety_class": {
          "type": "string",
          "enum": ["standard", "safety_plc", "mixed"],
          "default": "standard"
        },
        "connection": {
          "type": "object",
          "description": "Параметры соединения, зависят от protocol",
          "oneOf": [
            { "$ref": "#/$defs/conn_s7" },
            { "$ref": "#/$defs/conn_enip" },
            { "$ref": "#/$defs/conn_modbus" },
            { "$ref": "#/$defs/conn_opcua" },
            { "$ref": "#/$defs/conn_ads" },
            { "$ref": "#/$defs/conn_generic_tcp" }
          ]
        }
      }
    },
    "conn_s7": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "const": "S7" },
        "ip": { "type": "string", "format": "ipv4" },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535, "default": 102 },
        "rack": { "type": "integer", "minimum": 0, "maximum": 7, "default": 0 },
        "slot": { "type": "integer", "minimum": 0, "maximum": 31, "default": 1 },
        "timeout_ms": { "type": "integer", "minimum": 50, "maximum": 60000 }
      },
      "required": ["protocol", "ip"]
    },
    "conn_enip": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "const": "EtherNetIP" },
        "ip": { "type": "string", "format": "ipv4" },
        "slot": { "type": "integer", "minimum": 0, "maximum": 17, "default": 0 },
        "path": { "type": "string", "description": "Напр. '1,0' для backplane" },
        "timeout_ms": { "type": "integer", "minimum": 50, "maximum": 60000 }
      },
      "required": ["protocol", "ip"]
    },
    "conn_modbus": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "const": "ModbusTCP" },
        "ip": { "type": "string", "format": "ipv4" },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535, "default": 502 },
        "unit_id": { "type": "integer", "minimum": 0, "maximum": 255, "default": 1 },
        "timeout_ms": { "type": "integer", "minimum": 50, "maximum": 60000 }
      },
      "required": ["protocol", "ip"]
    },
    "conn_opcua": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "const": "OPCUA" },
        "endpoint_url": { "type": "string", "minLength": 8 },
        "security_mode": { "type": "string", "enum": ["None", "Sign", "SignAndEncrypt"], "default": "SignAndEncrypt" },
        "security_policy": {
          "type": "string",
          "enum": ["None", "Basic256Sha256", "Aes128_Sha256_RsaOaep", "Aes256_Sha256_RsaPss"],
          "default": "Basic256Sha256"
        },
        "username": { "type": "string" },
        "password": { "type": "string" },
        "application_uri": { "type": "string" }
      },
      "required": ["protocol", "endpoint_url"]
    },
    "conn_ads": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "const": "ADS" },
        "ams_net_id": { "type": "string", "pattern": "^[0-9]{1,3}(\\.[0-9]{1,3}){5}$" },
        "ams_port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "ip": { "type": "string", "format": "ipv4" }
      },
      "required": ["protocol", "ams_net_id", "ams_port"]
    },
    "conn_generic_tcp": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protocol": { "enum": ["Profinet", "DNP3", "BACnetIP", "Custom"] },
        "ip": { "type": "string", "format": "ipv4" },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 }
      },
      "required": ["protocol", "ip", "port"]
    },

    "signal": {
      "type": "object",
      "additionalProperties": false,
      "required": ["signal_id", "name", "endpoint_ref", "class", "datatype", "address", "access"],
      "properties": {
        "signal_id": { "type": "string", "pattern": "^[a-z0-9_\\-\\.]{3,64}$" },
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "endpoint_ref": {
          "type": "string",
          "description": "Ссылка на endpoints[].endpoint_id"
        },
        "class": {
          "type": "string",
          "enum": ["telemetry", "command", "parameter", "safety", "diagnostic"]
        },
        "datatype": {
          "type": "string",
          "enum": [
            "BOOL","SINT","USINT","INT","UINT","DINT","UDINT","LINT","ULINT",
            "REAL","LREAL","BYTE","WORD","DWORD","LWORD","STRING","WSTRING"
          ]
        },
        "units": { "type": "string" },
        "scale": {
          "type": "object",
          "additionalProperties": false,
          "description": "Масштабирование сырого значения в инженерные единицы",
          "oneOf": [
            {
              "title": "Линейное",
              "properties": {
                "type": { "const": "linear" },
                "slope": { "type": "number" },
                "offset": { "type": "number" },
                "clamp_min": { "type": "number" },
                "clamp_max": { "type": "number" }
              },
              "required": ["type","slope","offset"]
            },
            {
              "title": "Табличное (piecewise)",
              "properties": {
                "type": { "const": "table" },
                "points": {
                  "type": "array",
                  "minItems": 2,
                  "items": {
                    "type": "object",
                    "required": ["raw","eng"],
                    "additionalProperties": false,
                    "properties": {
                      "raw": { "type": "number" },
                      "eng": { "type": "number" }
                    }
                  }
                }
              },
              "required": ["type","points"]
            }
          ]
        },
        "address": {
          "description": "Протокол‑специфичная адресация",
          "oneOf": [
            { "$ref": "#/$defs/addr_s7" },
            { "$ref": "#/$defs/addr_enip" },
            { "$ref": "#/$defs/addr_modbus" },
            { "$ref": "#/$defs/addr_opcua" },
            { "$ref": "#/$defs/addr_ads" }
          ]
        },
        "bit_index": {
          "type": "integer",
          "minimum": 0,
          "maximum": 63,
          "description": "Если BOOL — бит в слове/двойном слове"
        },
        "array": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "count": { "type": "integer", "minimum": 1, "maximum": 4096 },
            "stride_bytes": { "type": "integer", "minimum": 0, "maximum": 4096 }
          }
        },
        "poll_rate_ms": { "type": "integer", "minimum": 10, "maximum": 60000 },
        "deadband": { "type": "number", "minimum": 0 },
        "access": { "type": "string", "enum": ["RO", "WO", "RW"] },
        "write_rules": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allowed_roles": {
              "type": "array",
              "items": { "type": "string", "enum": ["operator","maintainer","integrator","safety_officer","ot_security"] }
            },
            "require_permit": { "type": "boolean", "default": false },
            "dual_authorization": { "type": "boolean", "default": false },
            "rate_limit_per_min": { "type": "integer", "minimum": 0, "maximum": 120 },
            "confirmation_tag": { "type": "string", "description": "ID связанного подтверждающего сигнала" }
          }
        },
        "limits": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "lo_lo": { "type": "number" },
            "lo": { "type": "number" },
            "hi": { "type": "number" },
            "hi_hi": { "type": "number" },
            "deadband": { "type": "number", "minimum": 0 },
            "alarm_delay_ms": { "type": "integer", "minimum": 0, "maximum": 600000, "default": 0 },
            "latching": { "type": "boolean", "default": false },
            "severity": { "type": "integer", "minimum": 1, "maximum": 5, "default": 3 },
            "notify_roles": {
              "type": "array",
              "items": { "type": "string", "enum": ["operator","shift_manager","safety_officer","maintenance"] }
            }
          }
        },
        "safety": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "sil": { "type": "integer", "minimum": 1, "maximum": 4 },
            "demand_rate_per_year": { "type": "number", "minimum": 0 },
            "proof_test_interval_days": { "type": "integer", "minimum": 1, "maximum": 3650 },
            "bypass_permitted": { "type": "boolean", "default": false },
            "interlock_group": { "type": "string" },
            "stop_category": { "type": "integer", "enum": [0,1,2] }
          }
        },
        "history": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "store": { "type": "boolean", "default": true },
            "sample_interval_ms": { "type": "integer", "minimum": 10, "maximum": 60000 },
            "retention_days": { "type": "integer", "minimum": 1, "maximum": 3650 }
          }
        },
        "dependencies": {
          "type": "array",
          "items": { "type": "string", "description": "signal_id зависимостей" }
        },
        "enable_when": {
          "type": "string",
          "description": "Выражение на основе других сигналов (безопасное подмножество)",
          "pattern": "^[A-Za-z0-9_\\-\\.()!&|=<>+/*\\s]+$"
        }
      }
    },

    "addr_s7": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kind": { "const": "s7" },
        "area": { "type": "string", "enum": ["DB","I","Q","M","T","C"] },
        "db_number": { "type": "integer", "minimum": 0, "maximum": 65535 },
        "offset_bytes": { "type": "integer", "minimum": 0, "maximum": 1048576 },
        "string_length": { "type": "integer", "minimum": 0, "maximum": 254 }
      },
      "required": ["kind","area","offset_bytes"]
    },

    "addr_enip": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kind": { "const": "enip" },
        "tag": { "type": "string", "minLength": 1, "description": "Controller tag path" },
        "element_index": { "type": "integer", "minimum": 0 },
        "string_length": { "type": "integer", "minimum": 0, "maximum": 512 }
      },
      "required": ["kind","tag"]
    },

    "addr_modbus": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kind": { "const": "modbus" },
        "table": { "type": "string", "enum": ["coil","discrete_input","holding_register","input_register"] },
        "address": { "type": "integer", "minimum": 0, "maximum": 131071 },
        "quantity": { "type": "integer", "minimum": 1, "maximum": 125, "default": 1 }
      },
      "required": ["kind","table","address"]
    },

    "addr_opcua": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kind": { "const": "opcua" },
        "node_id": { "type": "string", "minLength": 1 },
        "browse_path": { "type": "string" }
      },
      "required": ["kind","node_id"]
    },

    "addr_ads": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "kind": { "const": "ads" },
        "symbol": { "type": "string", "minLength": 1 },
        "index_group": { "type": "integer", "minimum": 0 },
        "index_offset": { "type": "integer", "minimum": 0 }
      },
      "required": ["kind","symbol"]
    },

    "test_vector": {
      "type": "object",
      "additionalProperties": false,
      "required": ["signal_id","raw","expected_eng"],
      "properties": {
        "signal_id": { "type": "string" },
        "raw": { "type": ["number","boolean","string"] },
        "expected_eng": { "type": ["number","boolean","string"] },
        "tolerance": { "type": "number", "minimum": 0 }
      }
    }
  },
  "examples": [
    {
      "schema_version": "1.0.0",
      "metadata": {
        "site_id": "plant-alpha",
        "area": "assembly",
        "cell": "robot-cell-A",
        "owner": { "org": "NeuroCity", "team": "Physical-Integration-Core", "contact": "ot@neurocity.local" },
        "generated_at": "2025-08-22T08:00:00Z",
        "description": "Пример маппинга для S7 и Modbus"
      },
      "defaults": {
        "poll_rate_ms": 100,
        "timeout_ms": 2000,
        "byte_order": "big_endian",
        "word_order": "abcd",
        "qos": "at_least_once",
        "retry_policy": { "max_retries": 3, "backoff_ms": 500 },
        "quality_policy": "hold_last"
      },
      "endpoints": [
        {
          "endpoint_id": "s7-main",
          "vendor": "Siemens",
          "model": "S7-1500F",
          "firmware": "V2.9",
          "protocol": "S7",
          "safety_class": "safety_plc",
          "connection": { "protocol": "S7", "ip": "10.10.0.10", "port": 102, "rack": 0, "slot": 1, "timeout_ms": 1500 }
        },
        {
          "endpoint_id": "mb-gas",
          "vendor": "Generic",
          "model": "GasPanel",
          "protocol": "ModbusTCP",
          "connection": { "protocol": "ModbusTCP", "ip": "10.10.0.40", "port": 502, "unit_id": 1 }
        }
      ],
      "signals": [
        {
          "signal_id": "cellA.estop_ok",
          "name": "E-Stop Chain Healthy",
          "endpoint_ref": "s7-main",
          "class": "safety",
          "datatype": "BOOL",
          "address": { "kind": "s7", "area": "I", "offset_bytes": 0 },
          "access": "RO",
          "safety": { "sil": 2, "stop_category": 0, "proof_test_interval_days": 365 }
        },
        {
          "signal_id": "cellA.conv.speed_cmd",
          "name": "Conveyor Speed Command",
          "endpoint_ref": "s7-main",
          "class": "command",
          "datatype": "REAL",
          "units": "m_per_s",
          "scale": { "type": "linear", "slope": 0.01, "offset": 0, "clamp_min": 0, "clamp_max": 1.5 },
          "address": { "kind": "s7", "area": "DB", "db_number": 10, "offset_bytes": 24 },
          "access": "WO",
          "write_rules": { "allowed_roles": ["operator","integrator"], "rate_limit_per_min": 20 }
        },
        {
          "signal_id": "gas.lel.percent",
          "name": "LEL",
          "endpoint_ref": "mb-gas",
          "class": "telemetry",
          "datatype": "REAL",
          "units": "percent",
          "scale": { "type": "linear", "slope": 0.1, "offset": 0 },
          "limits": { "hi": 10, "hi_hi": 20, "severity": 5, "alarm_delay_ms": 500 },
          "history": { "store": true, "sample_interval_ms": 1000, "retention_days": 365 },
          "address": { "kind": "modbus", "table": "input_register", "address": 30001, "quantity": 2 },
          "access": "RO"
        }
      ],
      "tests": [
        { "signal_id": "gas.lel.percent", "raw": 50, "expected_eng": 5, "tolerance": 0.01 }
      ]
    }
  ]
}
