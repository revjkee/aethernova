{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.neurocity.dev/physical-integration-core/v1/video_pipeline.schema.json",
  "title": "Video Pipeline Configuration (v1)",
  "description": "Промышленная схема конфигурации видео‑пайплайна для ingestion, аналитики, приватности и доставки.",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "pipeline", "sources", "sinks"],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Версия схемы конфигурации."
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": { "$ref": "#/$defs/uuid" },
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "tenantId": { "type": "string" },
        "labels": { "type": "object", "additionalProperties": { "type": "string" } }
      }
    },
    "sla": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "targetFps": { "type": "number", "minimum": 0 },
        "maxEndToEndLatencyMs": { "type": "integer", "minimum": 0 },
        "maxStartupTimeSec": { "type": "number", "minimum": 0 },
        "availabilityTarget": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "observability": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "otel": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "endpoint": { "$ref": "#/$defs/uri" },
            "serviceName": { "type": "string" },
            "samplingRatio": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.1 }
          }
        },
        "metricsPrefix": { "type": "string", "default": "pic_video_" }
      }
    },
    "resources": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "gpu": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "vendor": { "type": "string", "enum": ["nvidia", "amd", "intel"] },
            "deviceIds": {
              "type": "array",
              "items": { "type": "integer", "minimum": 0 },
              "minItems": 0
            },
            "memoryLimitMiB": { "type": "integer", "minimum": 256 }
          }
        },
        "cpu": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "threads": { "type": "integer", "minimum": 1 },
            "pinning": { "type": "boolean", "default": false }
          }
        },
        "batching": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "size": { "type": "integer", "minimum": 1, "default": 4 },
            "timeoutMs": { "type": "integer", "minimum": 1, "default": 20 }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tls": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "verifyPeer": { "type": "boolean", "default": true },
            "caFile": { "type": "string" },
            "certFile": { "type": "string" },
            "keyFile": { "type": "string" }
          }
        },
        "auth": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "type": "string", "enum": ["none", "basic", "bearer", "oauth2", "jwt"] },
            "username": { "type": "string" },
            "password": { "type": "string" },
            "token": { "type": "string" },
            "issuer": { "$ref": "#/$defs/uri" },
            "audience": { "type": "string" },
            "jwksUrl": { "$ref": "#/$defs/uri" }
          },
          "allOf": [
            {
              "if": { "properties": { "type": { "const": "basic" } }, "required": ["type"] },
              "then": { "required": ["username", "password"] }
            },
            {
              "if": { "properties": { "type": { "const": "bearer" } }, "required": ["type"] },
              "then": { "required": ["token"] }
            },
            {
              "if": { "properties": { "type": { "enum": ["oauth2", "jwt"] } }, "required": ["type"] },
              "then": { "required": ["issuer", "audience", "jwksUrl"] }
            }
          ]
        },
        "privacy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "faceBlur": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean", "default": false },
                "method": { "type": "string", "enum": ["gaussian", "pixelate"], "default": "gaussian" },
                "kernel": { "type": "integer", "minimum": 3, "default": 21 }
              },
              "additionalProperties": false
            },
            "zones": {
              "type": "array",
              "description": "Статические зоны приватности (ROI) для маскирования.",
              "items": { "$ref": "#/$defs/polygon" }
            },
            "watermark": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": false },
                "text": { "type": "string" },
                "opacity": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.2 },
                "position": { "type": "string", "enum": ["tl", "tr", "bl", "br", "center"], "default": "br" }
              }
            }
          }
        }
      }
    },
    "profiles": {
      "type": "object",
      "description": "Набор пресетов кодирования/транскодирования.",
      "additionalProperties": { "$ref": "#/$defs/encodeProfile" }
    },
    "sources": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/source" }
    },
    "pipeline": {
      "type": "object",
      "additionalProperties": false,
      "required": ["graph"],
      "properties": {
        "graph": {
          "type": "array",
          "minItems": 1,
          "description": "Список этапов обработки (DAG).",
          "items": { "$ref": "#/$defs/stage" }
        }
      }
    },
    "sinks": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/sink" }
    },
    "retention": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "recordingsDays": { "type": "integer", "minimum": 0, "default": 7 },
        "snapshotsDays": { "type": "integer", "minimum": 0, "default": 3 },
        "analyticsTtlDays": { "type": "integer", "minimum": 0, "default": 30 }
      }
    },
    "retryPolicy": {
      "$ref": "#/$defs/retryPolicy"
    }
  },
  "$defs": {
    "uuid": {
      "type": "string",
      "format": "uuid"
    },
    "uri": {
      "type": "string",
      "format": "uri"
    },
    "size": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "width": { "type": "integer", "minimum": 16 },
        "height": { "type": "integer", "minimum": 16 }
      },
      "required": ["width", "height"]
    },
    "fps": {
      "type": "number",
      "minimum": 0.1,
      "maximum": 240
    },
    "polygon": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string" },
        "points": {
          "type": "array",
          "minItems": 3,
          "items": {
            "type": "array",
            "prefixItems": [{ "type": "number" }, { "type": "number" }],
            "minItems": 2,
            "maxItems": 2
          }
        }
      },
      "required": ["points"]
    },
    "retryPolicy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "strategy": { "type": "string", "enum": ["none", "fixed", "exponential"], "default": "exponential" },
        "initialMs": { "type": "integer", "minimum": 10, "default": 500 },
        "maxMs": { "type": "integer", "minimum": 10, "default": 10000 },
        "maxAttempts": { "type": "integer", "minimum": 0, "default": 0, "description": "0 = бесконечно" }
      }
    },
    "encodeProfile": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "codec": { "type": "string", "enum": ["h264", "h265", "vp9", "av1", "mjpeg", "raw"] },
        "container": { "type": "string", "enum": ["mp4", "mkv", "flv", "ts", "webm", "rtsp", "rtmp", "raw"] },
        "preset": { "type": "string", "enum": ["ultrafast", "superfast", "veryfast", "faster", "fast", "medium", "slow", "slower", "veryslow"], "default": "fast" },
        "profile": { "type": "string", "enum": ["baseline", "main", "high", "professional", "auto"], "default": "auto" },
        "bitrateKbps": { "type": "integer", "minimum": 64 },
        "maxBitrateKbps": { "type": "integer", "minimum": 64 },
        "crf": { "type": "integer", "minimum": 0, "maximum": 63 },
        "gop": { "type": "integer", "minimum": 0, "description": "0=auto" },
        "bFrames": { "type": "integer", "minimum": 0, "maximum": 16, "default": 3 },
        "pixFmt": { "type": "string", "enum": ["yuv420p", "yuv422p", "yuv444p", "nv12", "p010"] },
        "colorSpace": { "type": "string", "enum": ["bt601", "bt709", "bt2020"] },
        "hdr": { "type": "string", "enum": ["none", "hlg", "pq"], "default": "none" },
        "size": { "$ref": "#/$defs/size" },
        "fps": { "$ref": "#/$defs/fps" },
        "audio": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "codec": { "type": "string", "enum": ["aac", "opus", "pcm_s16le"] },
            "bitrateKbps": { "type": "integer", "minimum": 16 },
            "channels": { "type": "integer", "minimum": 1, "maximum": 8 },
            "sampleRate": { "type": "integer", "minimum": 8000, "maximum": 192000 }
          }
        }
      },
      "required": ["codec"]
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "input"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,64}$" },
        "labels": { "type": "object", "additionalProperties": { "type": "string" } },
        "type": { "type": "string", "enum": ["rtsp", "file", "v4l2", "webrtc_pull", "rtmp_pull"] },
        "input": {
          "oneOf": [
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "url": { "$ref": "#/$defs/uri" },
                "transport": { "type": "string", "enum": ["tcp", "udp", "udp_multicast"], "default": "tcp" },
                "timeoutMs": { "type": "integer", "minimum": 100, "default": 5000 },
                "rtspMode": { "type": "string", "enum": ["camera", "server"], "default": "camera" }
              },
              "required": ["url"]
            },
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "path": { "type": "string" },
                "loop": { "type": "boolean", "default": false }
              },
              "required": ["path"]
            }
          ]
        },
        "decode": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "hwAccel": { "type": "string", "enum": ["none", "vaapi", "cuda", "qsv"], "default": "none" },
            "threads": { "type": "integer", "minimum": 1 },
            "dropLateFrames": { "type": "boolean", "default": true }
          }
        },
        "preprocess": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "resize": { "$ref": "#/$defs/size" },
            "fps": { "$ref": "#/$defs/fps" },
            "crop": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "x": { "type": "integer", "minimum": 0 },
                "y": { "type": "integer", "minimum": 0 },
                "width": { "type": "integer", "minimum": 1 },
                "height": { "type": "integer", "minimum": 1 }
              },
              "required": ["x", "y", "width", "height"]
            }
          }
        }
      }
    },
    "stage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,64}$" },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "type": {
          "type": "string",
          "enum": [
            "transcode",
            "privacy",
            "detector",
            "tracker",
            "reid",
            "segmenter",
            "classifier",
            "ocr",
            "events",
            "mux"
          ]
        },
        "params": {
          "type": "object",
          "description": "Параметры конкретного типа этапа.",
          "additionalProperties": true,
          "properties": {
            "profile": { "type": "string" },
            "threshold": { "type": "number", "minimum": 0, "maximum": 1 },
            "labels": {
              "type": "array",
              "items": { "type": "string" }
            },
            "model": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "format": { "type": "string", "enum": ["onnx", "trt", "openvino", "torchscript"] },
                "path": { "type": "string" },
                "inputSize": { "$ref": "#/$defs/size" },
                "mean": {
                  "type": "array",
                  "items": { "type": "number" },
                  "minItems": 3,
                  "maxItems": 3
                },
                "std": {
                  "type": "array",
                  "items": { "type": "number" },
                  "minItems": 3,
                  "maxItems": 3
                },
                "nms": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "iou": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.5 },
                    "confidence": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.25 },
                    "maxDetections": { "type": "integer", "minimum": 1, "default": 300 }
                  }
                }
              }
            },
            "privacy": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "faceBlur": { "type": "boolean" },
                "zones": { "type": "array", "items": { "$ref": "#/$defs/polygon" } }
              }
            },
            "tracker": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "type": { "type": "string", "enum": ["byte", "deepocsort", "kcf", "sort"], "default": "byte" },
                "maxAge": { "type": "integer", "minimum": 1, "default": 30 },
                "minHits": { "type": "integer", "minimum": 0, "default": 3 },
                "associationIou": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.3 }
              }
            }
          }
        }
      }
    },
    "sink": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,64}$" },
        "type": {
          "type": "string",
          "enum": ["rtmp_push", "webrtc", "hls", "s3", "file", "kafka", "webhook", "rtsp_relay", "mqtt"]
        },
        "profile": { "type": "string", "description": "encodeProfile имя" },
        "target": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "url": { "$ref": "#/$defs/uri" },
            "path": { "type": "string" },
            "bucket": { "type": "string" },
            "topic": { "type": "string" },
            "headers": { "type": "object", "additionalProperties": { "type": "string" } },
            "partitionKey": { "type": "string" }
          }
        },
        "segmentation": {
          "type": "object",
          "description": "Для HLS/DASH — параметры сегментации.",
          "additionalProperties": false,
          "properties": {
            "segmentDurationSec": { "type": "number", "minimum": 1, "default": 2 },
            "playlistWindow": { "type": "integer", "minimum": 2, "default": 6 },
            "deleteOldSegments": { "type": "boolean", "default": true }
          }
        },
        "recording": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "chunkMinutes": { "type": "integer", "minimum": 1, "default": 15 },
            "prefix": { "type": "string" }
          }
        },
        "metadata": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    }
  },
  "examples": [
    {
      "version": "1.0.0",
      "metadata": { "id": "3a2b6b7e-2b1f-4d97-94c6-8a6b38b3730f", "name": "gate-1" },
      "sla": { "targetFps": 25, "maxEndToEndLatencyMs": 300, "availabilityTarget": 0.99 },
      "observability": { "otel": { "enabled": true, "endpoint": "http://otel-collector:4317", "serviceName": "pic-video", "samplingRatio": 0.1 } },
      "resources": { "gpu": { "enabled": true, "vendor": "nvidia", "deviceIds": [0], "memoryLimitMiB": 6144 }, "batching": { "enabled": true, "size": 4, "timeoutMs": 20 } },
      "security": { "tls": { "enabled": false }, "auth": { "type": "none" }, "privacy": { "faceBlur": { "enabled": true, "method": "gaussian", "kernel": 31 } } },
      "profiles": {
        "live_lowlat": { "codec": "h264", "container": "flv", "preset": "fast", "bitrateKbps": 2000, "gop": 50, "size": { "width": 1280, "height": 720 }, "fps": 25 },
        "archive": { "codec": "h265", "container": "mp4", "preset": "slow", "crf": 28, "size": { "width": 1920, "height": 1080 }, "fps": 25, "audio": { "enabled": false } }
      },
      "sources": [
        { "id": "cam01", "type": "rtsp", "input": { "url": "rtsp://cam01/stream1", "transport": "tcp" }, "decode": { "hwAccel": "cuda" } }
      ],
      "pipeline": {
        "graph": [
          { "id": "det", "type": "detector", "params": { "model": { "format": "onnx", "path": "/models/yolo.onnx", "inputSize": { "width": 640, "height": 640 }, "nms": { "iou": 0.5, "confidence": 0.4 } }, "labels": ["person", "car"] } },
          { "id": "trk", "type": "tracker", "dependsOn": ["det"], "params": { "tracker": { "type": "byte", "maxAge": 30, "minHits": 3 } } },
          { "id": "priv", "type": "privacy", "dependsOn": ["trk"], "params": { "privacy": { "faceBlur": true } } },
          { "id": "mux", "type": "mux", "dependsOn": ["priv"] }
        ]
      },
      "sinks": [
        { "id": "live", "type": "rtmp_push", "profile": "live_lowlat", "target": { "url": "rtmp://rtmp-gw/live/cam01" } },
        { "id": "rec", "type": "s3", "profile": "archive", "target": { "bucket": "pic-archive", "path": "gate-1/cam01" }, "recording": { "enabled": true, "chunkMinutes": 15, "prefix": "chunks/" } },
        { "id": "meta", "type": "kafka", "target": { "topic": "pic.video.events", "partitionKey": "cam01" } }
      ],
      "retention": { "recordingsDays": 14, "snapshotsDays": 3, "analyticsTtlDays": 30 },
      "retryPolicy": { "strategy": "exponential", "initialMs": 500, "maxMs": 10000, "maxAttempts": 0 }
    }
  ]
}
