{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.neurocity.example/physical-integration-core/jsonschema/v1/unit.schema.json",
  "title": "Physical Integration Core — Unit (v1)",
  "description": "Строгая модель киберфизической единицы (устройства) для physical-integration-core.",
  "type": "object",
  "additionalProperties": false,
  "required": ["apiVersion", "kind", "schemaVersion", "metadata", "identity"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "const": "physical.v1"
    },
    "kind": {
      "type": "string",
      "const": "Unit"
    },
    "schemaVersion": {
      "type": "string",
      "description": "Версия JSON-схемы для этого ресурса",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z.-]+)?(?:\\+[0-9A-Za-z.-]+)?$",
      "default": "1.0.0"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "createdAt"],
      "properties": {
        "id": { "type": "string", "format": "uuid" },
        "name": { "type": "string", "minLength": 1, "maxLength": 128 },
        "labels": {
          "type": "object",
          "description": "K/V метки для селекторов",
          "propertyNames": { "pattern": "^[a-z0-9]([-a-z0-9_.]{0,61}[a-z0-9])?$" },
          "additionalProperties": { "type": "string", "maxLength": 256 },
          "default": {}
        },
        "annotations": {
          "type": "object",
          "description": "Непроиндексированные аннотации",
          "propertyNames": { "pattern": "^[a-z0-9]([-a-z0-9_.]{0,61}[a-z0-9])?$" },
          "additionalProperties": { "type": "string", "maxLength": 1024 },
          "default": {}
        },
        "owner": { "type": "string", "maxLength": 128 },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      }
    },
    "identity": {
      "type": "object",
      "additionalProperties": false,
      "required": ["vendor", "product", "hwRevision", "serialNumber"],
      "properties": {
        "vendor": { "type": "string", "minLength": 1, "maxLength": 64 },
        "product": { "type": "string", "minLength": 1, "maxLength": 64 },
        "hwRevision": { "type": "string", "minLength": 1, "maxLength": 32 },
        "serialNumber": { "type": "string", "minLength": 3, "maxLength": 64 },
        "region": { "type": "string", "maxLength": 16 },
        "channel": { "type": "string", "enum": ["stable", "beta", "rc", "dev"], "default": "stable" }
      }
    },
    "firmware": {
      "type": "object",
      "additionalProperties": false,
      "required": ["currentVersion"],
      "properties": {
        "currentVersion": { "$ref": "#/$defs/semver" },
        "bootloaderVersion": { "$ref": "#/$defs/semver" },
        "approvedVersions": {
          "type": "array",
          "items": { "$ref": "#/$defs/semver" },
          "uniqueItems": true,
          "default": []
        },
        "image": {
          "type": "object",
          "additionalProperties": false,
          "required": ["sizeBytes", "hash"],
          "properties": {
            "uri": { "type": "string", "format": "uri" },
            "ociReference": { "type": "string", "pattern": "^[\\w./:-]+(@sha256:[a-f0-9]{64})?$" },
            "sizeBytes": { "type": "integer", "minimum": 0 },
            "compression": { "type": "string", "enum": ["none", "gzip", "zstd"], "default": "none" },
            "format": { "type": "string", "enum": ["raw", "tar", "zip", "dfu", "mcu_boot", "uefi_capsule"], "default": "raw" },
            "encryption": { "type": "string", "enum": ["none", "aes-256-gcm", "age"], "default": "none" },
            "encryptionKeyId": { "type": "string", "maxLength": 256 },
            "hash": { "$ref": "#/$defs/hash" },
            "signature": { "$ref": "#/$defs/signature" },
            "mirrors": {
              "type": "array",
              "items": { "type": "string", "format": "uri" },
              "uniqueItems": true,
              "default": []
            }
          },
          "allOf": [
            { "oneOf": [ { "required": ["uri"] }, { "required": ["ociReference"] } ] }
          ]
        }
      }
    },
    "network": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "interfaces": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "mac"],
            "properties": {
              "name": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,32}$" },
              "mac": { "$ref": "#/$defs/mac" },
              "ipv4": { "type": "string", "format": "ipv4" },
              "ipv6": { "type": "string", "format": "ipv6" },
              "dhcp": { "type": "boolean", "default": true }
            }
          },
          "uniqueItems": true
        },
        "mqtt": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "brokerUri": { "type": "string", "format": "uri" },
            "clientId": { "type": "string", "minLength": 1, "maxLength": 128 },
            "qos": { "type": "integer", "enum": [0, 1, 2], "default": 1 },
            "keepaliveSec": { "type": "integer", "minimum": 0, "maximum": 3600, "default": 30 },
            "cleanSession": { "type": "boolean", "default": false },
            "tls": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": true },
                "insecureSkipVerify": { "type": "boolean", "default": false },
                "caSecretRef": { "$ref": "#/$defs/secretRef" }
              }
            },
            "topics": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "telemetryPub": { "type": "string", "minLength": 1 },
                "commandsSub": { "type": "string", "minLength": 1 }
              }
            }
          }
        },
        "kafka": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "brokers": {
              "type": "array",
              "items": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]+:[0-9]{2,5}$" },
              "minItems": 1,
              "uniqueItems": true
            },
            "clientId": { "type": "string", "minLength": 1, "maxLength": 128 },
            "security": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "sasl": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "mechanism": { "type": "string", "enum": ["SCRAM-SHA-256", "SCRAM-SHA-512", "PLAIN"] },
                    "username": { "type": "string" },
                    "passwordFrom": { "$ref": "#/$defs/secretKeyRef" }
                  }
                },
                "tls": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "enabled": { "type": "boolean", "default": false }
                  }
                }
              }
            },
            "topics": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "telemetry": { "type": "string", "minLength": 1 },
                "events": { "type": "string", "minLength": 1 },
                "dlq": { "type": "string", "minLength": 1 }
              }
            }
          }
        },
        "opcua": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "endpoint": { "type": "string", "format": "uri" },
            "securityPolicy": { "type": "string", "enum": ["None", "Basic256Sha256"] },
            "securityMode": { "type": "string", "enum": ["None", "Sign", "SignAndEncrypt"], "default": "SignAndEncrypt" },
            "nodes": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "uniqueItems": true
            },
            "requestTimeoutMs": { "type": "integer", "minimum": 100, "maximum": 60000, "default": 5000 },
            "sessionTimeoutMs": { "type": "integer", "minimum": 1000, "maximum": 3600000, "default": 30000 }
          }
        },
        "modbus": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "tcp": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": false },
                "host": { "type": "string", "format": "hostname" },
                "port": { "type": "integer", "minimum": 1, "maximum": 65535, "default": 502 },
                "unitId": { "type": "integer", "minimum": 0, "maximum": 247, "default": 1 }
              }
            },
            "rtu": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": false },
                "device": { "type": "string", "minLength": 1 },
                "baudRate": { "type": "integer", "enum": [9600, 19200, 38400, 57600, 115200], "default": 115200 },
                "parity": { "type": "string", "enum": ["N", "E", "O"], "default": "N" },
                "dataBits": { "type": "integer", "enum": [7, 8], "default": 8 },
                "stopBits": { "type": "integer", "enum": [1, 2], "default": 1 },
                "unitId": { "type": "integer", "minimum": 0, "maximum": 247, "default": 1 }
              }
            }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "secureBootEnabled": { "type": "boolean", "default": true },
        "tpmPresent": { "type": "boolean", "default": false },
        "attestationKeyId": { "type": "string", "maxLength": 256 },
        "allowUnsignedFirmware": { "type": "boolean", "default": false }
      }
    },
    "power": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["mains", "battery", "poe"], "default": "mains" },
        "batteryCapacityWh": { "type": "number", "minimum": 0 },
        "voltageRange": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "minV": { "type": "number", "minimum": 0 },
            "maxV": { "type": "number", "minimum": 0 }
          }
        },
        "powerBudgetW": { "type": "number", "minimum": 0 }
      }
    },
    "location": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "site": { "type": "string", "maxLength": 128 },
        "building": { "type": "string", "maxLength": 64 },
        "floor": { "type": "string", "maxLength": 32 },
        "room": { "type": "string", "maxLength": 64 },
        "geo": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "lat": { "type": "number", "minimum": -90, "maximum": 90 },
            "lon": { "type": "number", "minimum": -180, "maximum": 180 }
          }
        }
      }
    },
    "telemetry": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "samplingMs": { "type": "integer", "minimum": 10, "maximum": 3600000, "default": 200 },
        "prometheus": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "port": { "type": "integer", "minimum": 1, "maximum": 65535, "default": 8080 },
            "path": { "type": "string", "default": "/metrics" }
          }
        },
        "includeTraceIds": { "type": "boolean", "default": true }
      }
    },
    "capabilities": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "sensors": {
          "type": "array",
          "items": { "$ref": "#/$defs/sensor" },
          "uniqueItems": true,
          "default": []
        },
        "actuators": {
          "type": "array",
          "items": { "$ref": "#/$defs/actuator" },
          "uniqueItems": true,
          "default": []
        }
      }
    },
    "thresholds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cpuUtilizationPercent": { "$ref": "#/$defs/percent" },
        "memUtilizationPercent": { "$ref": "#/$defs/percent" },
        "temperatureC": { "$ref": "#/$defs/rangeNumber" }
      }
    },
    "otaPolicy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "constraints": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "minBatteryPercent": { "$ref": "#/$defs/percent" },
            "requireMainsPower": { "type": "boolean", "default": false },
            "minFreeStorageBytes": { "type": "integer", "minimum": 0 },
            "minSignalStrength": { "type": "integer", "minimum": -150, "maximum": 150 }
          }
        },
        "retry": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "maxAttempts": { "type": "integer", "minimum": 0, "default": 5 },
            "initialBackoff": { "$ref": "#/$defs/isoDuration" },
            "maxBackoff": { "$ref": "#/$defs/isoDuration" },
            "multiplier": { "type": "number", "minimum": 1.0, "maximum": 10.0, "default": 2.0 }
          }
        },
        "maintenanceWindow": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "timezone": { "$ref": "#/$defs/timezone" },
            "cron": { "$ref": "#/$defs/cron" }
          }
        }
      }
    },
    "sla": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "availabilityTarget": { "type": "number", "minimum": 90, "maximum": 100, "default": 99.9 },
        "latencyP95Ms": { "type": "integer", "minimum": 1, "maximum": 60000, "default": 500 }
      }
    },
    "runtime": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "resources": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cpu": { "$ref": "#/$defs/resourceQuantity" },
            "memory": { "$ref": "#/$defs/resourceQuantity" }
          }
        },
        "nodeSelector": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "default": {}
        },
        "tolerations": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "key": { "type": "string" },
              "operator": { "type": "string", "enum": ["Equal", "Exists"], "default": "Equal" },
              "value": { "type": "string" },
              "effect": { "type": "string", "enum": ["NoSchedule", "PreferNoSchedule", "NoExecute"] }
            }
          },
          "default": []
        }
      }
    },
    "lifecycle": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "state": { "type": "string", "enum": ["active", "maintenance", "decommissioned"], "default": "active" },
        "warrantyExpiration": { "type": "string", "format": "date-time" }
      }
    },
    "ext": {
      "type": "object",
      "description": "Зона расширения для проектных нужд",
      "additionalProperties": true,
      "default": {}
    }
  },

  "allOf": [
    {
      "if": { "properties": { "network": { "properties": { "mqtt": { "properties": { "enabled": { "const": true } } } } } }, "required": ["network"] },
      "then": { "properties": { "network": { "properties": { "mqtt": { "required": ["brokerUri", "clientId"] } } } } }
    },
    {
      "if": { "properties": { "network": { "properties": { "kafka": { "properties": { "enabled": { "const": true } } } } } }, "required": ["network"] },
      "then": { "properties": { "network": { "properties": { "kafka": { "required": ["brokers", "clientId"] } } } } }
    },
    {
      "if": { "properties": { "network": { "properties": { "opcua": { "properties": { "enabled": { "const": true } } } } } }, "required": ["network"] },
      "then": { "properties": { "network": { "properties": { "opcua": { "required": ["endpoint"] } } } } }
    },
    {
      "if": { "properties": { "firmware": { "properties": { "image": { "properties": { "encryption": { "not": { "const": "none" } } } } } } } },
      "then": { "properties": { "firmware": { "properties": { "image": { "required": ["encryptionKeyId"] } } } } }
    }
  ],

  "$defs": {
    "semver": {
      "type": "string",
      "description": "Semantic Versioning 2.0.0",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-([0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*))?(?:\\+([0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*))?$"
    },
    "mac": {
      "type": "string",
      "pattern": "^([0-9A-Fa-f]{2}([:-])){5}([0-9A-Fa-f]{2})$"
    },
    "percent": {
      "type": "number",
      "minimum": 0,
      "maximum": 100
    },
    "rangeNumber": {
      "type": "object",
      "additionalProperties": false,
      "required": ["min", "max"],
      "properties": {
        "min": { "type": "number" },
        "max": { "type": "number" }
      }
    },
    "isoDuration": {
      "type": "string",
      "description": "ISO-8601 duration",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$"
    },
    "timezone": {
      "type": "string",
      "description": "IANA timezone",
      "pattern": "^[A-Za-z_]+\\/[A-Za-z_]+(?:\\/[A-Za-z_]+)?$"
    },
    "cron": {
      "type": "string",
      "description": "CRON выражение (5-7 полей)",
      "pattern": "^\\s*([^\\s]+\\s+){4,6}[^\\s]+\\s*$"
    },
    "resourceQuantity": {
      "type": "string",
      "description": "Количество ресурса (k8s-подобный формат)",
      "pattern": "^(\\+|-)?((([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))([eE](\\+|-)?[0-9]+)?)((m|Ki|Mi|Gi|Ti|Pi|Ei))?$"
    },
    "secretRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "key"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "key": { "type": "string", "minLength": 1 }
      }
    },
    "secretKeyRef": { "$ref": "#/$defs/secretRef" },
    "hash": {
      "type": "object",
      "additionalProperties": false,
      "required": ["algorithm", "hex"],
      "properties": {
        "algorithm": { "type": "string", "enum": ["sha256", "sha512", "blake3"] },
        "hex": { "type": "string", "pattern": "^[a-f0-9]{32,128}$" }
      },
      "allOf": [
        {
          "if": { "properties": { "algorithm": { "const": "sha256" } } },
          "then": { "properties": { "hex": { "pattern": "^[a-f0-9]{64}$" } } }
        },
        {
          "if": { "properties": { "algorithm": { "const": "sha512" } } },
          "then": { "properties": { "hex": { "pattern": "^[a-f0-9]{128}$" } } }
        }
      ]
    },
    "signature": {
      "type": "object",
      "additionalProperties": false,
      "required": ["algorithm", "signature", "keyId"],
      "properties": {
        "algorithm": { "type": "string", "enum": ["ed25519", "ecdsa_p256_sha256", "rsa_pss_2048_sha256"] },
        "signature": { "type": "string", "contentEncoding": "base64" },
        "keyId": { "type": "string", "maxLength": 256 },
        "issuer": { "type": "string", "maxLength": 256 }
      }
    },
    "sensor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "unit"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,32}$" },
        "type": {
          "type": "string",
          "enum": ["temperature", "humidity", "pressure", "vibration", "accelerometer", "power", "custom"]
        },
        "unit": { "type": "string", "maxLength": 16 },
        "range": { "$ref": "#/$defs/rangeNumber" },
        "calibration": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "offset": { "type": "number", "default": 0 },
            "scale": { "type": "number", "default": 1 },
            "timestamp": { "type": "string", "format": "date-time" }
          }
        }
      }
    },
    "actuator": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_.-]{1,32}$" },
        "type": { "type": "string", "enum": ["relay", "motor", "pwm", "valve", "custom"] },
        "constraints": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "min": { "type": "number" },
            "max": { "type": "number" }
          }
        }
      }
    }
  },

  "examples": [
    {
      "apiVersion": "physical.v1",
      "kind": "Unit",
      "schemaVersion": "1.0.0",
      "metadata": {
        "id": "c4f9f8db-0a42-4dfe-9c84-2a2b6a5a1e7a",
        "name": "pic-gateway-stg-001",
        "labels": { "site": "plant-a", "workload": "physical" },
        "createdAt": "2025-08-22T07:00:00Z"
      },
      "identity": {
        "vendor": "NeuroCity",
        "product": "PIC-Gateway",
        "hwRevision": "revC",
        "serialNumber": "NGW-STG-0001",
        "region": "EU",
        "channel": "stable"
      },
      "firmware": {
        "currentVersion": "1.7.3",
        "image": {
          "uri": "https://fw.neurocity.example/pic-gw/1.7.3/firmware.bin",
          "sizeBytes": 73400320,
          "hash": { "algorithm": "sha256", "hex": "6f5c0f...6a" }
        }
      },
      "network": {
        "interfaces": [
          { "name": "eth0", "mac": "AA:BB:CC:DD:EE:FF", "ipv4": "10.0.10.21", "dhcp": false }
        ],
        "mqtt": {
          "enabled": true,
          "brokerUri": "mqtts://mqtt-broker:8883",
          "clientId": "pic-stg-001",
          "qos": 1,
          "tls": { "enabled": true, "insecureSkipVerify": false, "caSecretRef": { "name": "pic-ca", "key": "ca.crt" } },
          "topics": { "telemetryPub": "pic/telemetry", "commandsSub": "pic/commands" }
        },
        "kafka": {
          "enabled": true,
          "brokers": ["kafka-1.kafka.svc.cluster.local:9092", "kafka-2.kafka.svc.cluster.local:9092"],
          "clientId": "pic-staging",
          "security": {
            "sasl": { "mechanism": "SCRAM-SHA-256", "username": "pic-stg", "passwordFrom": { "name": "pic-secrets", "key": "KAFKA_SASL_PASSWORD" } }
          },
          "topics": { "telemetry": "pic.telemetry.staging", "events": "pic.events.staging", "dlq": "pic.dlq.staging" }
        },
        "opcua": {
          "enabled": true,
          "endpoint": "opc.tcp://opcua-gw.physical.svc.cluster.local:4840",
          "securityPolicy": "Basic256Sha256",
          "securityMode": "SignAndEncrypt",
          "nodes": ["ns=2;s=Machine/Status", "ns=2;s=Machine/Temperature"]
        }
      },
      "security": { "secureBootEnabled": true },
      "power": { "type": "mains", "powerBudgetW": 15 },
      "location": { "site": "plant-a", "building": "A1", "floor": "2", "room": "210" },
      "telemetry": { "samplingMs": 200, "prometheus": { "enabled": true, "port": 8080 } },
      "capabilities": {
        "sensors": [
          { "id": "temp1", "type": "temperature", "unit": "C", "range": { "min": -40, "max": 125 } }
        ],
        "actuators": [
          { "id": "relay1", "type": "relay", "constraints": { "min": 0, "max": 1 } }
        ]
      },
      "thresholds": {
        "cpuUtilizationPercent": 85,
        "memUtilizationPercent": 85,
        "temperatureC": { "min": -20, "max": 80 }
      },
      "otaPolicy": {
        "constraints": { "minBatteryPercent": 20, "requireMainsPower": false, "minFreeStorageBytes": 104857600 },
        "retry": { "maxAttempts": 5, "initialBackoff": "PT1S", "maxBackoff": "PT30S", "multiplier": 2.0 },
        "maintenanceWindow": { "timezone": "Europe/Stockholm", "cron": "0 2 * * *" }
      },
      "sla": { "availabilityTarget": 99.9, "latencyP95Ms": 500 },
      "runtime": { "resources": { "cpu": "200m", "memory": "256Mi" } },
      "lifecycle": { "state": "active" }
    }
  ]
}
