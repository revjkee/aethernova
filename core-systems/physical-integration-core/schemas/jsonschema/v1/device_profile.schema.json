{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.aethernova.io/physical-integration-core/v1/device_profile.schema.json",
  "title": "Device Profile (physical-integration-core v1)",
  "type": "object",
  "$comment": "Промышленная схема профиля устройства. Использовать для CI-валидации и рантайм-проверок.",
  "required": ["apiVersion", "kind", "metadata", "identity", "hardware", "telemetry", "sensors"],
  "properties": {
    "apiVersion": {
      "const": "pic.aethernova.io/v1"
    },
    "kind": {
      "const": "DeviceProfile"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "version", "environment", "createdAt"],
      "properties": {
        "name": { "type": "string", "minLength": 3, "maxLength": 128 },
        "version": { "$ref": "#/$defs/semver" },
        "revision": { "type": "integer", "minimum": 1 },
        "environment": { "type": "string", "enum": ["dev", "test", "staging", "prod"] },
        "createdAt": { "$ref": "#/$defs/iso8601" },
        "owner": { "type": "string", "minLength": 1 },
        "labels": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 256 } },
        "annotations": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 2000 } },
        "description": { "type": "string", "maxLength": 2000 }
      },
      "unevaluatedProperties": false
    },
    "identity": {
      "type": "object",
      "required": ["tenantId", "siteId", "model", "modelFamily"],
      "properties": {
        "tenantId": { "$ref": "#/$defs/idSegment" },
        "siteId": { "$ref": "#/$defs/idSegment" },
        "deviceId": { "$ref": "#/$defs/uuid" },
        "modelFamily": { "type": "string", "minLength": 2, "maxLength": 64 },
        "model": { "type": "string", "minLength": 2, "maxLength": 64 },
        "labels": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 256 } }
      },
      "unevaluatedProperties": false
    },
    "hardware": {
      "type": "object",
      "required": ["hwRevision", "fwVersion", "capabilities"],
      "properties": {
        "hwRevision": { "$ref": "#/$defs/semver" },
        "fwVersion": { "$ref": "#/$defs/semver" },
        "agentVersion": { "$ref": "#/$defs/semver" },
        "serialNumber": { "type": "string", "pattern": "^[A-Z0-9\\-]{6,64}$" },
        "capabilities": {
          "type": "array",
          "items": { "type": "string", "minLength": 2, "maxLength": 64 },
          "minItems": 1,
          "uniqueItems": true
        },
        "connectivity": {
          "type": "object",
          "properties": {
            "protocols": {
              "type": "array",
              "items": { "type": "string", "enum": ["ethernet", "wifi", "lte", "5g", "ble", "can", "custom"] },
              "uniqueItems": true
            },
            "mtu": { "type": "integer", "minimum": 576, "maximum": 9216 }
          },
          "unevaluatedProperties": false
        },
        "power": {
          "type": "object",
          "properties": {
            "supplyV": { "type": "number", "minimum": 3.0, "maximum": 60.0 },
            "maxConsumptionW": { "type": "number", "minimum": 0.1, "maximum": 1000.0 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "security": {
      "type": "object",
      "properties": {
        "signing": {
          "type": "object",
          "required": ["enabled", "algo"],
          "properties": {
            "enabled": { "type": "boolean" },
            "algo": { "type": "string", "enum": ["ed25519", "rsa-pss-sha256"] },
            "keyRef": { "type": "string", "maxLength": 256 }
          },
          "unevaluatedProperties": false
        },
        "integrity": {
          "type": "object",
          "properties": {
            "checksum": {
              "type": "object",
              "required": ["algo", "value"],
              "properties": {
                "algo": { "type": "string", "enum": ["sha256", "sha512"] },
                "value": { "type": "string", "pattern": "^[a-f0-9]{64,128}$" }
              },
              "unevaluatedProperties": false
            },
            "requireSigned": { "type": "boolean", "default": true },
            "rejectIfMismatch": { "type": "boolean", "default": true }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "calibration": {
      "type": "object",
      "required": ["revision", "validFrom"],
      "properties": {
        "revision": { "type": "string", "pattern": "^[a-zA-Z0-9_\\-\\.]{1,64}$" },
        "validFrom": { "$ref": "#/$defs/iso8601" },
        "validTo": { "$ref": "#/$defs/iso8601" },
        "artifactsUri": { "$ref": "#/$defs/uri" },
        "hash": { "type": "string", "pattern": "^sha256:[a-f0-9]{64}$" }
      },
      "allOf": [
        {
          "if": { "required": ["validTo"] },
          "then": {
            "properties": {
              "validTo": { "$ref": "#/$defs/iso8601" }
            }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "telemetry": {
      "type": "object",
      "required": ["ingest", "limits"],
      "properties": {
        "ingest": {
          "type": "object",
          "required": ["protocol", "endpoint"],
          "properties": {
            "protocol": { "type": "string", "enum": ["grpc", "mqtt", "http"] },
            "endpoint": { "$ref": "#/$defs/uri" },
            "compression": { "type": "string", "enum": ["none", "gzip", "zstd"], "default": "gzip" },
            "defaultHz": { "type": "integer", "minimum": 1, "maximum": 10000 },
            "timeSync": { "type": "string", "enum": ["ntp", "ptp", "local"], "default": "ptp" },
            "maxClockDriftMs": { "type": "integer", "minimum": 0, "maximum": 600000 }
          },
          "unevaluatedProperties": false
        },
        "limits": {
          "type": "object",
          "required": ["maxBatchBytes", "maxItemsPerBatch"],
          "properties": {
            "maxBatchBytes": { "type": "integer", "minimum": 1024, "maximum": 10485760 },
            "maxItemsPerBatch": { "type": "integer", "minimum": 1, "maximum": 10000 },
            "retryBackoffMs": { "type": "integer", "minimum": 10, "maximum": 600000 },
            "maxInFlightBatches": { "type": "integer", "minimum": 1, "maximum": 128 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "qa": {
      "type": "object",
      "properties": {
        "thresholds": {
          "type": "object",
          "properties": {
            "temperatureRmseMax": { "type": "number", "minimum": 0, "maximum": 5 },
            "pressureMapeMaxPercent": { "type": "number", "minimum": 0, "maximum": 10 },
            "imuBiasGMax": { "type": "number", "minimum": 0, "maximum": 0.01 },
            "lidarRmseMaxMeters": { "type": "number", "minimum": 0, "maximum": 1 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "rollout": {
      "type": "object",
      "required": ["strategy", "steps"],
      "properties": {
        "strategy": { "type": "string", "enum": ["all-at-once", "canary", "progressive"] },
        "steps": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["name", "trafficPercent", "bakeTime"],
            "properties": {
              "name": { "type": "string", "minLength": 1, "maxLength": 64 },
              "trafficPercent": { "type": "integer", "minimum": 1, "maximum": 100 },
              "bakeTime": { "$ref": "#/$defs/iso8601-duration" },
              "abortOn": {
                "type": "array",
                "items": { "type": "string", "minLength": 1, "maxLength": 256 },
                "uniqueItems": true
              }
            },
            "unevaluatedProperties": false
          }
        },
        "rollback": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "toRevision": { "type": "string", "minLength": 1, "maxLength": 64 }
          },
          "unevaluatedProperties": false
        }
      },
      "unevaluatedProperties": false
    },
    "compatibility": {
      "type": "object",
      "properties": {
        "minAgentVersion": { "$ref": "#/$defs/semver" },
        "minFirmware": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/semver" }
        }
      },
      "unevaluatedProperties": false
    },
    "sensors": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/sensor" }
    }
  },
  "unevaluatedProperties": false,

  "$defs": {
    "uuid": {
      "type": "string",
      "format": "uuid"
    },
    "uri": {
      "type": "string",
      "format": "uri"
    },
    "iso8601": {
      "type": "string",
      "format": "date-time"
    },
    "iso8601-duration": {
      "type": "string",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+(\\.\\d+)?S)?)?$"
    },
    "semver": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z\\.-]+)?(?:\\+[0-9A-Za-z\\.-]+)?$"
    },
    "idSegment": {
      "type": "string",
      "pattern": "^[a-z0-9]([a-z0-9\\-]{0,61}[a-z0-9])?$",
      "minLength": 1,
      "maxLength": 63
    },
    "ucum": {
      "type": "string",
      "minLength": 1,
      "maxLength": 16
    },
    "vector3": {
      "type": "array",
      "items": { "type": "number" },
      "minItems": 3,
      "maxItems": 3
    },
    "matrix3x3": {
      "type": "array",
      "items": { "type": "number" },
      "minItems": 9,
      "maxItems": 9
    },
    "sensorCommon": {
      "type": "object",
      "required": ["kind", "model", "enabled"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["temperature", "pressure", "accel", "gyro", "magnet", "lidar", "imu", "power", "network", "custom"]
        },
        "model": { "type": "string", "minLength": 2, "maxLength": 64 },
        "enabled": { "type": "boolean", "default": true },
        "labels": { "type": "object", "additionalProperties": { "type": "string", "maxLength": 256 } }
      },
      "unevaluatedProperties": true
    },
    "sensor": {
      "allOf": [
        { "$ref": "#/$defs/sensorCommon" },
        {
          "if": { "properties": { "kind": { "const": "temperature" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeC", "frequencyHz"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "Cel" },
              "rangeC": {
                "type": "array",
                "items": { "type": "number" },
                "minItems": 2,
                "maxItems": 2
              },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 1000 },
              "bias": { "type": "number", "minimum": -10, "maximum": 10 },
              "scale": { "type": "number", "minimum": 0.9, "maximum": 1.1 }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "pressure" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeKPa", "frequencyHz"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "kPa" },
              "rangeKPa": {
                "type": "array",
                "items": { "type": "number" },
                "minItems": 2,
                "maxItems": 2
              },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 1000 },
              "poly": {
                "type": "object",
                "properties": {
                  "order": { "type": "integer", "minimum": 1, "maximum": 5 },
                  "coefficients": {
                    "type": "array",
                    "items": { "type": "number" },
                    "minItems": 2,
                    "maxItems": 6
                  }
                },
                "unevaluatedProperties": false
              }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "accel" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeMS2", "frequencyHz"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "m/s2" },
              "rangeMS2": { "$ref": "#/$defs/vector3" },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 10000 },
              "bias": { "$ref": "#/$defs/vector3" },
              "crossAxis": { "$ref": "#/$defs/matrix3x3" }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "gyro" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeDegS", "frequencyHz"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "deg/s" },
              "rangeDegS": { "$ref": "#/$defs/vector3" },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 10000 },
              "bias": { "$ref": "#/$defs/vector3" }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "magnet" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeUT", "frequencyHz"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "uT" },
              "rangeUT": { "$ref": "#/$defs/vector3" },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 2000 }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "lidar" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unit", "rangeM", "frequencyHz", "beams"],
            "properties": {
              "unit": { "$ref": "#/$defs/ucum", "const": "m" },
              "rangeM": {
                "type": "array",
                "items": { "type": "number", "minimum": 0.0, "maximum": 10000.0 },
                "minItems": 2,
                "maxItems": 2
              },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 1000 },
              "beams": { "type": "integer", "minimum": 1, "maximum": 4096 },
              "angleStartRad": { "type": "number", "minimum": -6.2832, "maximum": 6.2832 },
              "angleStepRad": { "type": "number", "exclusiveMinimum": 0.0, "maximum": 0.1745 }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "imu" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["accel", "gyro", "fusion"],
            "properties": {
              "accel": {
                "type": "object",
                "required": ["unit", "rangeMS2", "frequencyHz"],
                "properties": {
                  "unit": { "$ref": "#/$defs/ucum", "const": "m/s2" },
                  "rangeMS2": { "$ref": "#/$defs/vector3" },
                  "frequencyHz": { "type": "integer", "minimum": 50, "maximum": 20000 },
                  "bias": { "$ref": "#/$defs/vector3" },
                  "crossAxis": { "$ref": "#/$defs/matrix3x3" }
                },
                "unevaluatedProperties": false
              },
              "gyro": {
                "type": "object",
                "required": ["unit", "rangeDegS", "frequencyHz"],
                "properties": {
                  "unit": { "$ref": "#/$defs/ucum", "const": "deg/s" },
                  "rangeDegS": { "$ref": "#/$defs/vector3" },
                  "frequencyHz": { "type": "integer", "minimum": 50, "maximum": 20000 },
                  "bias": { "$ref": "#/$defs/vector3" }
                },
                "unevaluatedProperties": false
              },
              "fusion": {
                "type": "object",
                "required": ["algo", "outputRateHz"],
                "properties": {
                  "algo": { "type": "string", "enum": ["madgwick", "mahony", "ekf", "ukf"] },
                  "beta": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
                  "outputRateHz": { "type": "integer", "minimum": 10, "maximum": 1000 }
                },
                "unevaluatedProperties": false
              }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "power" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["unitV", "unitA", "frequencyHz"],
            "properties": {
              "unitV": { "$ref": "#/$defs/ucum", "const": "V" },
              "unitA": { "$ref": "#/$defs/ucum", "const": "A" },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 4000 }
            },
            "unevaluatedProperties": false
          }
        },
        {
          "if": { "properties": { "kind": { "const": "network" } }, "required": ["kind"] },
          "then": {
            "type": "object",
            "required": ["metrics", "frequencyHz"],
            "properties": {
              "metrics": {
                "type": "array",
                "minItems": 1,
                "items": { "type": "string", "enum": ["rtt_ms", "loss_ratio", "throughput_mbps"] },
                "uniqueItems": true
              },
              "frequencyHz": { "type": "integer", "minimum": 1, "maximum": 1000 }
            },
            "unevaluatedProperties": false
          }
        }
      ]
    }
  },

  "examples": [
    {
      "apiVersion": "pic.aethernova.io/v1",
      "kind": "DeviceProfile",
      "metadata": {
        "name": "pic-imux-700-prod",
        "version": "1.4.0",
        "revision": 12,
        "environment": "prod",
        "createdAt": "2025-08-22T08:00:00Z",
        "owner": "platform-security-core"
      },
      "identity": {
        "tenantId": "aethernova",
        "siteId": "lab-a",
        "deviceId": "b8c6c6f2-0a6b-4d8e-9e54-7f9c1f4d9b3a",
        "modelFamily": "IMUX",
        "model": "IMU-9X-700"
      },
      "hardware": {
        "hwRevision": "3.2.0",
        "fwVersion": "1.5.3",
        "agentVersion": "2.4.0",
        "capabilities": ["imu", "lidar"],
        "connectivity": { "protocols": ["ethernet"], "mtu": 1500 },
        "power": { "supplyV": 12.0, "maxConsumptionW": 15.0 }
      },
      "security": {
        "signing": { "enabled": true, "algo": "ed25519", "keyRef": "k8s://secret/pic-sign-key" },
        "integrity": { "checksum": { "algo": "sha256", "value": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" } }
      },
      "calibration": {
        "revision": "calib-2025-08",
        "validFrom": "2025-08-22T08:00:00Z",
        "artifactsUri": "s3://pic-calib/prod/artifacts/",
        "hash": "sha256:bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
      },
      "telemetry": {
        "ingest": {
          "protocol": "grpc",
          "endpoint": "https://ingest.pic.prod.aethernova.io",
          "compression": "gzip",
          "defaultHz": 200,
          "timeSync": "ptp",
          "maxClockDriftMs": 50
        },
        "limits": { "maxBatchBytes": 1048576, "maxItemsPerBatch": 1000, "retryBackoffMs": 500, "maxInFlightBatches": 8 }
      },
      "qa": {
        "thresholds": {
          "temperatureRmseMax": 0.2,
          "pressureMapeMaxPercent": 0.6,
          "imuBiasGMax": 0.0015,
          "lidarRmseMaxMeters": 0.01
        }
      },
      "rollout": {
        "strategy": "canary",
        "steps": [
          { "name": "canary-5", "trafficPercent": 5, "bakeTime": "PT1H", "abortOn": ["qa.temperatureRmse > 0.25"] },
          { "name": "canary-25", "trafficPercent": 25, "bakeTime": "PT2H" },
          { "name": "global", "trafficPercent": 100, "bakeTime": "PT6H" }
        ],
        "rollback": { "enabled": true, "toRevision": "previous-stable" }
      },
      "compatibility": {
        "minAgentVersion": "2.4.0",
        "minFirmware": { "IMU-9X-700": "1.5.3" }
      },
      "sensors": [
        {
          "kind": "imu",
          "model": "IMU-9X-700",
          "enabled": true,
          "accel": {
            "unit": "m/s2",
            "rangeMS2": [156.9, 156.9, 156.9],
            "frequencyHz": 1000,
            "bias": [0.012, -0.009, 0.006],
            "crossAxis": [1,0.0041,-0.0036,-0.0043,1,0.0028,0.0032,-0.0025,1]
          },
          "gyro": {
            "unit": "deg/s",
            "rangeDegS": [2000, 2000, 2000],
            "frequencyHz": 1000,
            "bias": [0.021, -0.014, 0.009]
          },
          "fusion": { "algo": "madgwick", "beta": 0.08, "outputRateHz": 200 }
        },
        {
          "kind": "lidar",
          "model": "LDR-32",
          "enabled": true,
          "unit": "m",
          "rangeM": [0.2, 100.0],
          "frequencyHz": 10,
          "beams": 32,
          "angleStartRad": -1.5708,
          "angleStepRad": 0.00349
        },
        {
          "kind": "temperature",
          "model": "PT100-A1",
          "enabled": true,
          "unit": "Cel",
          "rangeC": [-20, 110],
          "frequencyHz": 5,
          "bias": -0.035,
          "scale": 1.0009
        }
      ]
    }
  ]
}
