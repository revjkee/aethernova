{{- if .Values.pdb.enabled }}
{{- $root := . -}}
{{- $name := default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- $fullname := default (printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-") .Values.fullnameOverride -}}

{{- /* Базовые промышленные метки */ -}}
{{- $baseLabels := dict
      "app.kubernetes.io/name" $name
      "app.kubernetes.io/instance" .Release.Name
      "app.kubernetes.io/part-of" "physical-integration-core"
      "app.kubernetes.io/component" "physical-integration-core"
      "app.kubernetes.io/version" .Chart.AppVersion
      "helm.sh/chart" (printf "%s-%s" .Chart.Name (.Chart.Version | replace "+" "_"))
      "app.kubernetes.io/managed-by" .Release.Service
-}}

{{- $targets := .Values.pdb.targets -}}

{{- if $targets }}
{{- range $i, $t := $targets }}
{{- $enabled := (hasKey $t "enabled") | ternary $t.enabled true -}}
{{- if $enabled }}
{{- $tname := default (printf "%s-%s" $fullname (default (printf "pdb-%d" $i) $t.nameSuffix)) $t.nameOverride -}}
{{- $matchLabels := default (dict "app.kubernetes.io/name" $name "app.kubernetes.io/instance" $root.Release.Name) $t.matchLabels -}}

{{- if and (not $t.minAvailable) (not $t.maxUnavailable) }}
{{- fail (printf "pdb.targets[%d]: either minAvailable or maxUnavailable must be set" $i) -}}
{{- end }}

---
apiVersion: {{- if $root.Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" }} policy/v1 {{- else }} policy/v1beta1 {{- end }}
kind: PodDisruptionBudget
metadata:
  name: {{ $tname | trunc 63 | trimSuffix "-" }}
  {{- if $root.Values.pdb.namespace }}
  namespace: {{ $root.Values.pdb.namespace }}
  {{- end }}
  labels:
    {{- range $k, $v := $baseLabels }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
    {{- with $t.labels }}
    {{- range $k, $v := . }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
    {{- end }}
  {{- with (merge (dict) $root.Values.pdb.annotations $t.annotations) }}
  annotations:
    {{- range $k, $v := . }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
  {{- end }}
spec:
  {{- if $t.minAvailable }}
  minAvailable: {{ toString $t.minAvailable | quote }}
  {{- end }}
  {{- if $t.maxUnavailable }}
  maxUnavailable: {{ toString $t.maxUnavailable | quote }}
  {{- end }}
  selector:
    matchLabels:
      {{- range $k, $v := $matchLabels }}
      {{ $k }}: {{ $v | quote }}
      {{- end }}
    {{- with $t.matchExpressions }}
    matchExpressions:
      {{- range . }}
      - key: {{ .key }}
        operator: {{ .operator }}
        {{- if .values }}
        values:
          {{- range .values }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}
{{- end }}

{{- else }}
{{- /* Одиночный PDB по умолчанию */ -}}
{{- $matchLabels := merge (dict) (dict "app.kubernetes.io/name" $name "app.kubernetes.io/instance" .Release.Name) (.Values.pdb.matchLabels | default (dict)) -}}
{{- $min := .Values.pdb.minAvailable | default 1 -}}

---
apiVersion: {{- if .Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" }} policy/v1 {{- else }} policy/v1beta1 {{- end }}
kind: PodDisruptionBudget
metadata:
  name: {{ printf "%s-pdb" $fullname | trunc 63 | trimSuffix "-" }}
  {{- if .Values.pdb.namespace }}
  namespace: {{ .Values.pdb.namespace }}
  {{- end }}
  labels:
    {{- range $k, $v := $baseLabels }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
    {{- with .Values.pdb.labels }}
    {{- range $k, $v := . }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
    {{- end }}
  {{- with .Values.pdb.annotations }}
  annotations:
    {{- range $k, $v := . }}
    {{ $k }}: {{ $v | quote }}
    {{- end }}
  {{- end }}
spec:
  {{- if .Values.pdb.maxUnavailable }}
  maxUnavailable: {{ toString .Values.pdb.maxUnavailable | quote }}
  {{- else }}
  minAvailable: {{ toString $min | quote }}
  {{- end }}
  selector:
    matchLabels:
      {{- range $k, $v := $matchLabels }}
      {{ $k }}: {{ $v | quote }}
      {{- end }}
    {{- with .Values.pdb.matchExpressions }}
    matchExpressions:
      {{- range . }}
      - key: {{ .key }}
        operator: {{ .operator }}
        {{- if .values }}
        values:
          {{- range .values }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}
{{- end }}
