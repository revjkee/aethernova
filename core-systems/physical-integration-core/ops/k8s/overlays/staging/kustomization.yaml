apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Базовые манифесты
resources:
  - ../../base

# Пространство имён и префикс для всех объектов окружения
namespace: physical-integration-staging
namePrefix: stg-

# Промышленные метки: безопасно добавляются к объектам и PodTemplate,
# НЕ изменяют селекторы (includeSelectors: false).
labels:
  - pairs:
      app.kubernetes.io/env: staging
      app.kubernetes.io/managed-by: kustomize
      app.kubernetes.io/part-of: physical-integration-core
      release.neurocity.dev/track: canary
      monitoring.neurocity.dev/profile: staging
      observability.neurocity.dev/scrape: "true"
    includeSelectors: false
    includeTemplates: true

# Сквозные аннотации для аудита и стратегии выката
commonAnnotations:
  deploy.neurocity.dev/strategy: "rolling"
  audit.neurocity.dev/change-id: "CHANGE_ME"
  audit.neurocity.dev/owner: "platform-ops"
  audit.neurocity.dev/reviewed: "true"

# Опции генераторов: включаем служебные метки/аннотации на сгенерённых ресурсах
generatorOptions:
  disableNameSuffixHash: false
  annotations:
    audit.neurocity.dev/generated: "true"
  labels:
    app.kubernetes.io/env: staging
    app.kubernetes.io/part-of: physical-integration-core

# Конфигурация окружения (может быть подмонтирована в поды)
configMapGenerator:
  - name: physical-integration-staging
    behavior: merge
    literals:
      - ENV=staging
      - LOG_LEVEL=info
      - METRICS_SAMPLING=normal

# Точечные правки: ускоряем ServiceMonitor в стейджинге и маркируем профиль
patches:
  - target:
      kind: ServiceMonitor
      labelSelector: "app.kubernetes.io/part-of=physical-integration-core"
    patch: |
      - op: add
        path: /metadata/labels/monitoring.neurocity.dev~1profile
        value: staging
      - op: replace
        path: /spec/endpoints/0/interval
        value: 15s
      - op: replace
        path: /spec/endpoints/0/scrapeTimeout
        value: 10s
      - op: replace
        path: /spec/endpoints/1/interval
        value: 15s
      - op: replace
        path: /spec/endpoints/1/scrapeTimeout
        value: 10s
