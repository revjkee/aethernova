#!/bin/bash
# Скрипт для автоматизированного сканирования уязвимостей в Kubernetes кластере
# Использует Trivy и kube-bench для проверки безопасности контейнеров и конфигураций k8s

set -euo pipefail

# Проверка установки необходимых инструментов
command -v trivy >/dev/null 2>&1 || { echo >&2 "Trivy не установлен. Установите его: https://github.com/aquasecurity/trivy"; exit 1; }
command -v kube-bench >/dev/null 2>&1 || { echo >&2 "kube-bench не установлен. Установите его: https://github.com/aquasecurity/kube-bench"; exit 1; }

# Папка для отчетов
REPORT_DIR="./security_reports"
mkdir -p "${REPORT_DIR}"

# Сканирование образов контейнеров с помощью Trivy
echo "Запуск сканирования контейнерных образов Trivy..."
trivy image --severity HIGH,CRITICAL --no-progress --exit-code 1 -q -f json -o "${REPORT_DIR}/trivy_container_report.json" alpine:latest || echo "Обнаружены уязвимости в образе alpine:latest"

# Скрипт для проверки всех запущенных подов и их образов (пример)
# Здесь можно добавить динамическое получение списка образов из кластера, но для простоты - пример с alpine

# Сканирование Kubernetes конфигурации с помощью kube-bench
echo "Запуск проверки безопасности кластера kube-bench..."
kube-bench --json > "${REPORT_DIR}/kube_bench_report.json"

# Вывод результатов
echo "Отчеты сохранены в папке ${REPORT_DIR}:"
echo " - Trivy контейнерный отчет: trivy_container_report.json"
echo " - kube-bench отчет по безопасности кластера: kube_bench_report.json"

# Итоговое сообщение с кодом выхода
echo "Сканирование уязвимостей завершено."
