.deploy_template:
  image: alpine:latest
  stage: deploy
  before_script:
    - apk add --no-cache openssh curl bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  script:
    - echo "===> Deploying to $DEPLOY_ENV on $DEPLOY_HOST"
    - ssh "$DEPLOY_USER@$DEPLOY_HOST" "bash -s" < ./devops/ci-cd/scripts/deploy.sh "$DEPLOY_ENV"
    - echo "===> Verifying deployment with healthcheck..."
    - >
      if ! curl -f "$HEALTHCHECK_URL"; then
        echo "Healthcheck failed! Initiating rollback."
        ssh "$DEPLOY_USER@$DEPLOY_HOST" "bash -s" < ./devops/ci-cd/scripts/rollback.sh "$DEPLOY_ENV"
        exit 1
      fi
  environment:
    name: $DEPLOY_ENV
    url: $DEPLOY_URL
  only:
    - main
    - tags
  when: manual
  allow_failure: false
  artifacts:
    when: always
    paths:
      - logs/deploy.log
