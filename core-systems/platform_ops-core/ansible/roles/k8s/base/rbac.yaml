apiVersion: v1
kind: List
metadata:
  name: teslaai-rbac-full
  annotations:
    audit.teslaai.io/validated-by: "meta-architectus-evolver-guardian"
    risk-level: "low"
    version: "v20x-industrial"
items:

  # 1. Неймспейсы и роли
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: teslaai-core-ops
      labels:
        purpose: "system-control"
        zero-trust: "enforced"
    rules:
      - apiGroups: [""]
        resources: ["pods", "services", "endpoints", "persistentvolumeclaims"]
        verbs: ["get", "list", "watch", "create", "delete", "patch", "update"]

      - apiGroups: ["apps"]
        resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
        verbs: ["*"]

      - apiGroups: ["networking.k8s.io"]
        resources: ["networkpolicies", "ingresses"]
        verbs: ["*"]

      - apiGroups: ["rbac.authorization.k8s.io"]
        resources: ["roles", "rolebindings"]
        verbs: ["get", "list", "watch"]

  # 2. Role для ArgoCD auto-sync
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: argocd-sync-role
      namespace: teslaai-system
    rules:
      - apiGroups: ["apps", ""]
        resources: ["deployments", "services", "configmaps", "secrets"]
        verbs: ["get", "list", "patch", "update", "create", "delete"]

  # 3. Привязка core-ops к группам админов
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: bind-core-ops-admins
    subjects:
      - kind: Group
        name: platform-admins
        apiGroup: rbac.authorization.k8s.io
    roleRef:
      kind: ClusterRole
      name: teslaai-core-ops
      apiGroup: rbac.authorization.k8s.io

  # 4. Привязка Argo к своей роли
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: bind-argocd-role
      namespace: teslaai-system
    subjects:
      - kind: ServiceAccount
        name: argocd-sa
        namespace: teslaai-system
    roleRef:
      kind: Role
      name: argocd-sync-role
      apiGroup: rbac.authorization.k8s.io

  # 5. Прослушка событий для аудита AI-агентов
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: ai-audit-subscriber
    rules:
      - apiGroups: ["events.k8s.io"]
        resources: ["events"]
        verbs: ["get", "list", "watch"]

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: bind-ai-audit
    subjects:
      - kind: ServiceAccount
        name: ai-agent-audit
        namespace: teslaai-agents
    roleRef:
      kind: ClusterRole
      name: ai-audit-subscriber
      apiGroup: rbac.authorization.k8s.io

  # 6. AI-aware роли с label-based ABAC
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: rl-agent-role
      namespace: ai-train
      labels:
        ai-role: "reinforcement-learner"
    rules:
      - apiGroups: [""]
        resources: ["pods", "configmaps"]
        verbs: ["get", "list", "watch", "create", "delete"]
      - apiGroups: ["batch"]
        resources: ["jobs"]
        verbs: ["create", "delete", "get", "watch", "list"]

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: bind-rl-agent
      namespace: ai-train
    subjects:
      - kind: ServiceAccount
        name: rl-agent-sa
        namespace: ai-train
    roleRef:
      kind: Role
      name: rl-agent-role
      apiGroup: rbac.authorization.k8s.io
