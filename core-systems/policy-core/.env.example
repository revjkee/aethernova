# ============================================================
# policy-core /.env.example — ПРОМЫШЛЕННЫЙ ШАБЛОН
# ВНИМАНИЕ: не храните реальные секреты в git. Используйте vault/KMS.
# Формат: KEY=VALUE, значения без кавычек, если не требуется пробел.
# ============================================================

# ---------- БАЗА СЕРВИСА ----------
APP_NAME=policy-core
APP_ENV=production            # production | staging | development | test
APP_VERSION=0.1.0
TZ=UTC
LANG=ru_RU.UTF-8
HTTP_HOST=0.0.0.0
HTTP_PORT=8080
EXTERNAL_URL=https://policy.example.com
REQUEST_ID_HEADER=X-Request-ID
GRACEFUL_TIMEOUT_SEC=30
MAX_REQUEST_BODY_MB=16

# ---------- БЕЗОПАСНОСТЬ / ZERO-TRUST ----------
ZERO_TRUST_MODE=true
REQUIRE_MTLS=true
TLS_CERT_FILE=/secrets/tls/tls.crt        # путь в контейнере/FS
TLS_KEY_FILE=/secrets/tls/tls.key
TLS_CLIENT_CA_FILE=/secrets/tls/ca.crt
CORS_ALLOWED_ORIGINS=https://app.example.com,https://admin.example.com
CORS_ALLOWED_HEADERS=Authorization,Content-Type,X-Request-ID
CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_ALLOW_CREDENTIALS=false
STRICT_TRANSPORT_SECURITY=true

# ---------- АУТЕНТИФИКАЦИЯ / ТОКЕНЫ ----------
AUTH_MODE=oidc                           # oidc | jwt | none
OIDC_ISSUER_URL=https://idp.example.com/
OIDC_CLIENT_ID=change-me
OIDC_CLIENT_SECRET=replace-with-secret
OIDC_AUDIENCE=policy-core
OIDC_SCOPES=openid,profile,email,roles
JWT_ISSUER=https://idp.example.com/
JWT_AUDIENCE=policy-core
JWT_ALG=RS256
JWT_KID=current
JWT_CLOCK_SKEW_SEC=30
JWT_PUBLIC_KEY_FILE=/secrets/jwt/pub.pem
JWT_PRIVATE_KEY_FILE=/secrets/jwt/priv.pem
JWT_ROTATE_INTERVAL_HOURS=24

# ---------- RBAC/ABAC / ДВИЖОК ПОЛИТИК ----------
POLICY_ENGINE=opa                  # opa | casbin
POLICY_DEFAULT_ACTION=deny         # deny-by-default
POLICY_EVAL_TIMEOUT_MS=50
POLICY_RULES_DIR=/app/policies     # для файлового бэкенда
POLICY_HOT_RELOAD=true

# OPA (remote или embedded bundle)
OPA_MODE=remote                    # remote | embedded
OPA_URL=http://opa:8181
OPA_DECISION_PATH=/v1/data/policy/allow
OPA_AUTH_TOKEN_FILE=/secrets/opa/token   # пусто, если не требуется
OPA_BUNDLE_URL=https://bundles.example.com/policy/bundle.tar.gz
OPA_BUNDLE_POLL_SECONDS=30

# Casbin
CASBIN_MODEL_FILE=/app/casbin/model.conf
CASBIN_POLICY_FILE=/app/casbin/policy.csv
CASBIN_ADAPTER=postgres             # postgres | file
CASBIN_SYNC_INTERVAL_SEC=15

# ---------- ХРАНИЛИЩЕ ПОЛИТИК ----------
POLICY_STORE_BACKEND=filesystem     # filesystem | postgres | s3
# PostgreSQL (универсальное хранилище)
POSTGRES_DSN=postgresql://user:pass@postgres:5432/policy?sslmode=require
POSTGRES_MAX_CONNS=20
POSTGRES_MIN_CONNS=2
POSTGRES_CONN_TIMEOUT_SEC=5
DB_MIGRATE_ON_START=true

# S3-совместимое хранилище (опционально)
S3_ENDPOINT_URL=https://s3.example.com
S3_REGION=us-east-1
S3_BUCKET=policy-bundles
AWS_ACCESS_KEY_ID=change-me
AWS_SECRET_ACCESS_KEY=replace-with-secret
S3_FORCE_PATH_STYLE=true

# ---------- КЭШ / БРОКЕР СООБЩЕНИЙ ----------
REDIS_URL=redis://redis:6379/0
REDIS_TLS=false
CACHE_TTL_DEFAULT_SEC=60

BROKER_TYPE=rabbitmq                # rabbitmq | kafka | none
# RabbitMQ
RABBITMQ_URL=amqps://user:pass@rabbitmq:5671/vhost
RABBITMQ_PREFETCH=200
RABBITMQ_DLQ_SUFFIX=.dlq
# Kafka
KAFKA_BROKERS=kafka-1:9092,kafka-2:9092
KAFKA_SASL_ENABLED=false
KAFKA_TLS_ENABLED=false
KAFKA_CLIENT_ID=policy-core

# ---------- ЛИМИТИРОВАНИЕ / ЗАЩИТА ----------
RATE_LIMIT_GLOBAL_QPS=200
RATE_LIMIT_BURST=400
WAF_MODE=detect                     # off | detect | block
MAX_RULESET_SIZE_KB=512

# ---------- DLP / PII / ДАННЫЕ ----------
DLP_MODE=redact                     # off | log | redact | block
PII_REDACTION_ENABLED=true
PII_ENTITIES=email,phone,ip,iban,ssn
DATA_RETENTION_DAYS=30
GDPR_REGION=eu

# ---------- KMS / HSM / VAULT ----------
KMS_PROVIDER=vault                  # aws | gcp | azure | vault | local
VAULT_ADDR=https://vault.example.com
VAULT_NAMESPACE=
VAULT_TOKEN_FILE=/secrets/vault/token
KMS_KEY_ID_JWT=kv/keys/jwt
KMS_KEY_ID_AT_REST=kv/keys/at-rest
CONFIG_REQUIRE_SIGNATURE=true
CONFIG_SIGNATURE_PUBLIC_KEY_FILE=/secrets/config/pubkey.pem

# ---------- НАБЛЮДАЕМОСТЬ / ЛОГИ ----------
LOG_LEVEL=info                      # debug | info | warn | error
LOG_FORMAT=json                     # json | text
ENABLE_METRICS=true
PROMETHEUS_PORT=9090
OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
OTEL_RESOURCE_ATTRIBUTES=service.name=policy-core,service.version=0.1.0,env=production
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.05
SENTRY_DSN=
SENTRY_ENV=production
SENTRY_TRACES_SAMPLE_RATE=0.05

# ---------- ИНТЕГРАЦИИ AI-ПОЛИТИК (GUARDRAILS) ----------
GUARDRAILS_ENABLED=true
PROMPT_GUARD_MODE=strict            # off | relaxed | strict
BLOCKLISTED_KEYWORDS_FILE=/app/policies/blocklist.txt
ALLOWLISTED_DOMAINS=example.com,partner.example.org
MAX_OUTPUT_TOKENS=2048

# ---------- ФИЧЕФЛАГИ ----------
FEATURE_RBAC=true
FEATURE_ABAC=true
FEATURE_OPA_BUNDLE=true
FEATURE_AUDIT_LOG=true
FEATURE_POLICY_VERSIONING=true

# ---------- АУДИТ / ЖУРНАЛЫ ----------
AUDIT_LOG_ENABLED=true
AUDIT_LOG_TARGET=stdout            # stdout | file | http
AUDIT_LOG_FILE=/var/log/policy-core/audit.log
AUDIT_LOG_HTTP_ENDPOINT=
AUDIT_LOG_REDACT_PII=true

# ---------- ОПЕРАЦИОННЫЕ ПАРАМЕТРЫ ----------
WORKERS=4
UVICORN_LOOP=uvloop
UVICORN_HTTP=h11
HEALTHCHECK_PATH=/healthz
READINESS_PATH=/readyz
STARTUP_PROBE_GRACE_SEC=10

# ---------- ТЕСТОВЫЕ/ДЕВ РЕЖИМЫ ----------
DEV_FAKE_PROVIDERS=false
ALLOW_HTTP_IN_DEV=false
DISABLE_AUTH_IN_TEST=false
