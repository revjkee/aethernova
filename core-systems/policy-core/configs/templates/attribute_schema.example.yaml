# policy-core :: Attribute Schema Template
# Назначение:
# - Единый контракт атрибутов, доступных механизмам политик ABAC.
# - Управление типами, обязательностью, валидацией, нормализацией и источниками.
# - Контроль приватности и наблюдаемости для Zero-Trust.

version: 1
metadata:
  id: "default-attribute-schema"
  description: "Эталонная схема атрибутов для policy-core"
  owners:
    - team: "platform-security"
      contact: "security@example.com"
  revision:
    created_at: "1970-01-01T00:00:00Z"
    updated_at: "1970-01-01T00:00:00Z"

conventions:
  # Неймспейсы для избежания конфликтов
  namespaces:
    subject: "subject."
    resource: "resource."
    env: "env."
    device: "device."
    net: "net."
    custom: "x."
  # Разрешенные базовые типы
  types:
    - string
    - integer
    - number
    - boolean
    - datetime     # RFC 3339
    - string_set   # уникальный набор строк
    - cidr         # IPv4 или IPv6 CIDR
    - country_code # ISO 3166-1 alpha-2
    - json         # произвольный JSON объект
  # Политика default значения при отсутствии атрибута
  defaults:
    missing_attribute_behavior: "absent"   # absent|empty|deny
    empty_string_as_absent: true
  # Общее правило приватности для неописанных атрибутов
  unknown_attribute_privacy: "deny"

# Описание доверенных источников атрибутов
sources:
  # Примеры источников с уровнями доверия
  - id: "idp"
    description: "Провайдер идентификации"
    trust_level: 90
  - id: "mtd"
    description: "Mobile Threat Defense"
    trust_level: 80
  - id: "sase"
    description: "Secure Access Service Edge"
    trust_level: 85
  - id: "client"
    description: "Клиентское приложение"
    trust_level: 40
  - id: "server"
    description: "Серверные вычисляемые атрибуты"
    trust_level: 95

# Реестр атрибутов
attributes:

  # SUBJECT
  - key: "subject.id"
    type: string
    required: true
    unique: true
    pii: true
    sensitivity: high
    sources: ["idp", "server"]
    normalize:
      trim: true
      lower: false
    validate:
      min_length: 1
      max_length: 128
      regex: "^[A-Za-z0-9._:-]+$"
    index: true
    example: "u-12345"
    description: "Стойкий идентификатор субъекта"

  - key: "subject.roles"
    type: string_set
    required: false
    pii: false
    sensitivity: medium
    sources: ["idp", "server"]
    normalize:
      lower: true
      dedup: true
      sort: true
    validate:
      each_regex: "^[a-z0-9:_-]{1,64}$"
      max_items: 64
    index: true
    example: ["user", "analyst"]
    description: "Роли субъекта"

  - key: "subject.attrs.dept"
    type: string
    required: false
    pii: false
    sensitivity: low
    sources: ["idp"]
    normalize:
      upper: true
      trim: true
    validate:
      enum: ["SALES","FIN","HR","ENG","OPS"]
    index: true
    example: "SALES"
    description: "Подразделение"

  - key: "subject.mfa"
    type: boolean
    required: false
    pii: false
    sensitivity: low
    sources: ["idp", "server"]
    default: false
    index: true
    example: true
    description: "Признак прохождения MFA в текущей сессии"

  # RESOURCE
  - key: "resource.type"
    type: string
    required: true
    pii: false
    sensitivity: low
    sources: ["client", "server"]
    normalize:
      lower: true
    validate:
      regex: "^[a-z0-9:_-]{1,64}$"
    index: true
    example: "profile"
    description: "Логический тип ресурса"

  - key: "resource.id"
    type: string
    required: false
    pii: false
    sensitivity: low
    sources: ["client", "server"]
    normalize:
      trim: true
    validate:
      max_length: 256
    index: true
    example: "u-12345"
    description: "Идентификатор ресурса"

  - key: "resource.owner_id"
    type: string
    required: false
    pii: true
    sensitivity: high
    sources: ["server"]
    normalize:
      trim: true
    validate:
      regex: "^[A-Za-z0-9._:-]+$"
    index: true
    example: "u-12345"
    description: "Владелец ресурса"

  # ENVIRONMENT
  - key: "env.time"
    type: datetime
    required: true
    sources: ["server"]
    index: false
    example: "2025-08-28T09:30:00+02:00"
    description: "Текущее время запроса в TZ env.tz"

  - key: "env.tz"
    type: string
    required: true
    sources: ["server"]
    validate:
      tz_database: true
    default: "Europe/Stockholm"
    index: false
    example: "Europe/Stockholm"
    description: "Часовой пояс для временных предикатов"

  - key: "env.client_ip"
    type: string
    required: false
    sources: ["sase", "client"]
    normalize:
      trim: true
    validate:
      ip: true
    sensitivity: medium
    index: true
    example: "203.0.113.10"
    description: "IP клиента, предпочтительно от доверенного прокси"

  - key: "env.country"
    type: country_code
    required: false
    sources: ["sase", "server"]
    validate:
      iso_3166_1_alpha2: true
    default: "SE"
    index: true
    example: "SE"
    description: "Код страны выхода клиента"

  # DEVICE
  - key: "device.id"
    type: string
    required: false
    sources: ["mtd", "client"]
    validate:
      max_length: 128
    index: true
    example: "dev-abc123"
    description: "Идентификатор устройства"

  - key: "device.risk_score"
    type: number
    required: false
    sources: ["mtd"]
    validate:
      min: 0
      max: 100
    default: 50
    index: true
    example: 12.5
    description: "Оценка риска устройства"

  - key: "device.is_managed"
    type: boolean
    required: false
    sources: ["mtd", "server"]
    default: false
    index: true
    example: true
    description: "Признак управляемого устройства"

  # NETWORK
  - key: "net.client_cidr"
    type: cidr
    required: false
    sources: ["sase", "server"]
    index: true
    example: "10.0.0.0/8"
    description: "CIDR сети клиента"

  # ПРОИЗВОДНЫЕ АТРИБУТЫ
  - key: "subject.is_employee"
    type: boolean
    computed: true
    sources: ["server"]
    compute:
      expr: "contains(subject.roles, 'employee')"
    default: false
    index: true
    example: true
    description: "Производный признак сотрудника"

  - key: "device.risk_ok"
    type: boolean
    computed: true
    sources: ["server"]
    compute:
      expr: "device.risk_score <= 30"
    index: true
    example: true
    description: "Низкий риск устройства"

# Кросс-полевые ограничения
constraints:
  - id: "owner-consistency"
    description: "Если ресурс типа profile, то owner_id должен совпадать с resource.id"
    when:
      all:
        - eq: ["resource.type", "profile"]
        - present: ["resource.id", "resource.owner_id"]
    assert:
      eq: ["resource.owner_id", "resource.id"]
    on_fail: "deny"

  - id: "mfa-for-sensitive-actions"
    description: "Требование MFA для чувствительных действий"
    when:
      any:
        - in: ["action", ["write","delete","approve"]]
    assert:
      eq: ["subject.mfa", true]
    on_fail: "deny"

  - id: "managed-device-for-admins"
    description: "Админы должны использовать управляемые устройства"
    when:
      any:
        - in: ["subject.roles", ["admin","systems_admin"]]
    assert:
      eq: ["device.is_managed", true]
    on_fail: "deny"

# Политики приватности и маскирования
privacy:
  redact_in_logs:
    - "subject.id"
    - "subject.attrs.*token*"
    - "subject.attrs.ssn"
  exposure:
    decision_response:
      allowlist:
        - "decision"
        - "policy_id"
        - "trace_id"
        - "obligations"
      shadow:
        - "subject.id"
        - "resource.owner_id"

# Карта преобразования из внешних источников
mapping:
  http_headers:
    # Значения берутся из доверенного прокси
    "x-user-id": "subject.id"
    "x-user-roles": "subject.roles"            # CSV будет преобразован в string_set
    "x-client-ip": "env.client_ip"
    "x-country": "env.country"
  jwt_claims:
    "sub": "subject.id"
    "roles": "subject.roles"
    "acr_mfa": "subject.mfa"
    "dept": "subject.attrs.dept"

# Управление жизненным циклом
lifecycle:
  deprecations:
    - key: "subject.attrs.department"
      replace_with: "subject.attrs.dept"
      sunset_at: "2026-01-01T00:00:00Z"
      action: "warn"
  freeze:
    # Атрибуты, запрещенные к изменению в ходе одной оценки
    keys: ["subject.id","resource.id","env.time"]

# Проверки на этапе загрузки схемы
load_checks:
  require_known_types: true
  forbid_unknown_keys: true
  min_trust_level:
    # Минимально допустимый уровень доверия источника для каждого атрибута
    "subject.id": 80
    "subject.roles": 60
    "env.client_ip": 60
    "device.risk_score": 70
    "resource.owner_id": 90

# Примеры запросов для валидации в CI
examples:
  - name: "read-own-profile-ok"
    input:
      subject:
        id: "u-123"
        roles: ["user"]
        mfa: true
      resource:
        type: "profile"
        id: "u-123"
        owner_id: "u-123"
      action: "read"
      env:
        time: "2025-08-28T09:30:00+02:00"
        tz: "Europe/Stockholm"
    expect:
      validate_only: "pass"

  - name: "admin-from-unmanaged-device-deny"
    input:
      subject:
        id: "u-777"
        roles: ["admin"]
        mfa: true
      resource:
        type: "profile"
        id: "u-555"
        owner_id: "u-555"
      action: "delete"
      device:
        id: "dev-x"
        is_managed: false
      env:
        time: "2025-08-28T10:00:00+02:00"
        tz: "Europe/Stockholm"
    expect:
      validate_only: "fail"
