# policy-core/ops/k8s/base/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: policy-core
  labels:
    app.kubernetes.io/name: policy-core
    app.kubernetes.io/part-of: policy-core
    app.kubernetes.io/component: ingress
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Класс контроллера
    kubernetes.io/ingress.class: nginx

    # TLS и принудительный редирект на HTTPS
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # HSTS (строгий HTTPS)
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000" # 1 год
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/hsts-preload: "true"

    # Размеры тела и буферы (подбирайте в оверлеях)
    nginx.ingress.kubernetes.io/proxy-body-size: "8m"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"

    # Тайм-ауты
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"

    # Доверять заголовкам прокси (X-Forwarded-For и т.д.)
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"

    # Лимиты запросов и соединений (защита от простых DDoS/брютфорса)
    nginx.ingress.kubernetes.io/limit-connections: "50"
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "2"

    # CORS по умолчанию выключен. Включайте и настраивайте в оверлеях при необходимости.
    nginx.ingress.kubernetes.io/enable-cors: "false"

    # Жесткие TLS-алгоритмы на стороне сервера (зависит от версии контроллера)
    nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers: "true"
    nginx.ingress.kubernetes.io/ssl-ciphers: "HIGH:!aNULL:!MD5:!RC4"

    # Опционально: встроенный WAF (если собран контроллер с ModSecurity)
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecRequestBodyAccess On
      SecResponseBodyAccess Off

    # Безопасные заголовки. Требует allow-snippet-annotations=true в конфиге контроллера.
    # Если snippets отключены в кластере, аннотация будет проигнорирована.
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "DENY" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "no-referrer" always;
      add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
      add_header Cross-Origin-Opener-Policy "same-origin" always;
      add_header Cross-Origin-Resource-Policy "same-origin" always;
      add_header Cross-Origin-Embedder-Policy "require-corp" always;
      add_header Content-Security-Policy "default-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self';" always;
      add_header X-Permitted-Cross-Domain-Policies "none" always;
      add_header X-Download-Options "noopen" always;
      proxy_hide_header X-Powered-By;

spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - policy-core.example.com
      secretName: policy-core-tls
  rules:
    - host: policy-core.example.com
      http:
        paths:
          # Маршрут для API
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: policy-core-api
                port:
                  number: 8080
          # Маршрут для WEB (SPA/SSR)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: policy-core-web
                port:
                  number: 80
