{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/policy-core/schemas/jsonschema/v1/rule.schema.json",
  "title": "Policy Rule v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "id", "effect", "resources", "actions"],
  "properties": {
    "version": { "type": "integer", "minimum": 1 },
    "id": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9._:-]+$"
    },
    "description": { "type": "string", "maxLength": 1024 },
    "priority": { "type": "integer", "minimum": 0, "default": 0 },
    "effect": { "enum": ["allow", "deny"] },
    "subjects": { "$ref": "#/$defs/subjects" },
    "resources": { "$ref": "#/$defs/resources" },
    "actions": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": { "$ref": "#/$defs/actionName" }
    },
    "conditions": { "$ref": "#/$defs/conditionNode" },
    "obligations": {
      "type": "array",
      "items": { "$ref": "#/$defs/obligation" }
    },
    "created_at": { "type": "string", "format": "date-time" },
    "metadata": { "type": "object", "additionalProperties": true }
  },
  "$defs": {
    "actionName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z0-9:_-]+$"
    },
    "subjects": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ids": {
          "type": "array",
          "uniqueItems": true,
          "items": { "$ref": "#/$defs/idRefOrPattern" }
        },
        "roles": {
          "type": "array",
          "uniqueItems": true,
          "items": { "$ref": "#/$defs/roleName" }
        },
        "attrs": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      }
    },
    "idRefOrPattern": {
      "type": "string",
      "minLength": 1,
      "maxLength": 256
    },
    "roleName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z0-9:_-]+$"
    },
    "resources": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-z0-9:_-]+$"
        },
        "ids": {
          "type": "array",
          "uniqueItems": true,
          "items": { "type": "string", "minLength": 1, "maxLength": 256 }
        },
        "attrs": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      }
    },
    "obligation": {
      "oneOf": [
        { "type": "string", "minLength": 1, "maxLength": 128 },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "type": "string", "minLength": 1 },
            "params": { "type": "object", "additionalProperties": true }
          }
        }
      ]
    },
    "attrRef": {
      "type": "string",
      "pattern": "^(subject|resource|env|device|net)\\.[A-Za-z0-9._:-]+$|^action$"
    },
    "valueLiteral": { "type": ["string", "number", "boolean", "null"] },
    "valueOrRef": {
      "anyOf": [
        { "$ref": "#/$defs/valueLiteral" },
        { "$ref": "#/$defs/attrRef" }
      ]
    },
    "stringOrRef": {
      "anyOf": [
        { "type": "string" },
        { "$ref": "#/$defs/attrRef" }
      ]
    },
    "countryCode": { "type": "string", "pattern": "^[A-Z]{2}$" },
    "cidr": {
      "type": "string",
      "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$|^([A-Fa-f0-9:]+)(/[0-9]{1,3})?$"
    },
    "ip": {
      "type": "string",
      "oneOf": [{ "format": "ipv4" }, { "format": "ipv6" }]
    },
    "predicate": {
      "type": "object",
      "minProperties": 1,
      "maxProperties": 1,
      "additionalProperties": false,
      "oneOf": [
        { "required": ["eq"], "properties": { "eq": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        { "required": ["ne"], "properties": { "ne": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        { "required": ["gt"], "properties": { "gt": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        { "required": ["ge"], "properties": { "ge": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        { "required": ["lt"], "properties": { "lt": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        { "required": ["le"], "properties": { "le": { "type": "array", "minItems": 2, "maxItems": 2, "items": { "$ref": "#/$defs/valueOrRef" } } } },
        {
          "required": ["in"],
          "properties": {
            "in": {
              "type": "array",
              "minItems": 2,
              "items": [
                { "$ref": "#/$defs/valueOrRef" },
                { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/valueOrRef" } }
              ]
            }
          }
        },
        {
          "required": ["not_in"],
          "properties": {
            "not_in": {
              "type": "array",
              "minItems": 2,
              "items": [
                { "$ref": "#/$defs/valueOrRef" },
                { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/valueOrRef" } }
              ]
            }
          }
        },
        {
          "required": ["regex_match"],
          "properties": {
            "regex_match": {
              "type": "array",
              "minItems": 2,
              "maxItems": 2,
              "items": [{ "$ref": "#/$defs/stringOrRef" }, { "type": "string" }]
            }
          }
        },
        { "required": ["present"], "properties": { "present": { "type": "array", "minItems": 1, "items": [{ "$ref": "#/$defs/attrRef" }] } } },
        { "required": ["any_present"], "properties": { "any_present": { "type": "array", "minItems": 1, "items": [{ "$ref": "#/$defs/attrRef" }] } } },
        { "required": ["none_present"], "properties": { "none_present": { "type": "array", "minItems": 1, "items": [{ "$ref": "#/$defs/attrRef" }] } } },
        {
          "required": ["time_between"],
          "properties": {
            "time_between": {
              "type": "array",
              "minItems": 3,
              "maxItems": 3,
              "items": [{ "type": "string" }, { "type": "string" }, { "type": "string" }]
            }
          }
        },
        {
          "required": ["ip_in_cidr"],
          "properties": {
            "ip_in_cidr": {
              "type": "array",
              "minItems": 2,
              "maxItems": 2,
              "items": [{ "$ref": "#/$defs/stringOrRef" }, { "$ref": "#/$defs/stringOrRef" }]
            }
          }
        },
        {
          "required": ["geo_in"],
          "properties": {
            "geo_in": {
              "type": "array",
              "minItems": 2,
              "maxItems": 2,
              "items": [
                { "$ref": "#/$defs/stringOrRef" },
                { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/countryCode" } }
              ]
            }
          }
        },
        { "required": ["mfa_required"], "properties": { "mfa_required": { "type": "array", "maxItems": 0 } } },
        {
          "required": ["device_risk_below"],
          "properties": {
            "device_risk_below": {
              "type": "array",
              "minItems": 1,
              "maxItems": 1,
              "items": [{ "$ref": "#/$defs/valueOrRef" }]
            }
          }
        }
      ]
    },
    "conditionNode": {
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        { "$ref": "#/$defs/predicate" },
        {
          "required": ["all"],
          "properties": {
            "all": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/conditionNode" }
            }
          }
        },
        {
          "required": ["any"],
          "properties": {
            "any": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/conditionNode" }
            }
          }
        },
        {
          "required": ["none"],
          "properties": {
            "none": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/conditionNode" }
            }
          }
        },
        { "required": ["not"], "properties": { "not": { "$ref": "#/$defs/conditionNode" } } }
      ]
    }
  },
  "examples": [
    {
      "version": 1,
      "id": "allow_read_own_profile",
      "description": "Пользователь читает только свой профиль",
      "priority": 100,
      "effect": "allow",
      "subjects": { "roles": ["user"] },
      "resources": { "type": "profile", "ids": ["{subject.id}"] },
      "actions": ["read"],
      "conditions": {
        "all": [
          { "eq": ["resource.owner_id", "subject.id"] },
          { "time_between": ["09:00", "21:00", "Europe/Stockholm"] }
        ]
      },
      "obligations": [
        "audit",
        { "type": "redact_fields", "params": { "fields": ["ssn"] } }
        ]
    }
  ]
}
