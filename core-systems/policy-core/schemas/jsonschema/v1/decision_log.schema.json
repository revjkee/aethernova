{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:aethernova:policy-core:schemas:json:decision-log:v1",
  "title": "Policy Core Decision Log (v1)",
  "description": "Единый формат события журналирования решений Policy Core.",
  "type": "object",
  "unevaluatedProperties": false,
  "required": [
    "schema_version",
    "event_type",
    "event_id",
    "occurred_at",
    "environment",
    "tenant",
    "actor",
    "resource",
    "action",
    "decision",
    "metrics"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Версия схемы события.",
      "pattern": "^1\\.0\\.[0-9]+$"
    },
    "event_type": {
      "type": "string",
      "const": "policy.decision.v1",
      "description": "Тип события (контрактное имя)."
    },
    "event_id": {
      "type": "string",
      "description": "UUIDv4 идентификатор события.",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "occurred_at": {
      "type": "string",
      "format": "date-time",
      "description": "Момент формирования решения в UTC (RFC3339)."
    },
    "environment": {
      "$ref": "#/$defs/Environment"
    },
    "tenant": {
      "$ref": "#/$defs/Tenant"
    },
    "actor": {
      "$ref": "#/$defs/Actor"
    },
    "resource": {
      "$ref": "#/$defs/ResourceRef"
    },
    "action": {
      "type": "string",
      "description": "Действие, запрошенное субъектом.",
      "enum": ["read", "create", "update", "delete", "admin", "validate", "test", "explain"]
    },
    "channel": {
      "type": "string",
      "description": "Канал запроса.",
      "enum": ["http", "grpc", "cli", "task"]
    },
    "http_request": {
      "$ref": "#/$defs/HttpRequest"
    },
    "http_response": {
      "$ref": "#/$defs/HttpResponse"
    },
    "grpc_request": {
      "$ref": "#/$defs/GrpcRequest"
    },
    "grpc_response": {
      "$ref": "#/$defs/GrpcResponse"
    },
    "cli_context": {
      "$ref": "#/$defs/CliContext"
    },
    "task_context": {
      "$ref": "#/$defs/TaskContext"
    },
    "context": {
      "type": "object",
      "description": "Дополнительный контекст принятия решения.",
      "additionalProperties": {
        "type": ["string", "number", "boolean", "null"]
      }
    },
    "decision": {
      "$ref": "#/$defs/Decision"
    },
    "issues": {
      "type": "array",
      "description": "Замечания валидатора/линтера, актуальные для решения.",
      "maxItems": 1000,
      "items": { "$ref": "#/$defs/ValidationIssue" }
    },
    "metrics": {
      "$ref": "#/$defs/Metrics"
    },
    "tracing": {
      "$ref": "#/$defs/Tracing"
    },
    "risk": {
      "$ref": "#/$defs/Risk"
    },
    "digests": {
      "type": "object",
      "description": "Контрольные суммы полезных нагрузок.",
      "additionalProperties": false,
      "properties": {
        "request_body": { "$ref": "#/$defs/Digest" },
        "response_body": { "$ref": "#/$defs/Digest" },
        "compiled_artifact": { "$ref": "#/$defs/Digest" }
      }
    },
    "labels": {
      "type": "object",
      "description": "Произвольные метки события.",
      "propertyNames": { "pattern": "^[a-zA-Z0-9_.-]{1,64}$" },
      "additionalProperties": { "type": "string", "maxLength": 256 }
    }
  },
  "dependentSchemas": {
    "channel": {
      "oneOf": [
        {
          "properties": { "channel": { "const": "http" } },
          "required": ["http_request", "http_response"]
        },
        {
          "properties": { "channel": { "const": "grpc" } },
          "required": ["grpc_request", "grpc_response"]
        },
        {
          "properties": { "channel": { "const": "cli" } },
          "required": ["cli_context"]
        },
        {
          "properties": { "channel": { "const": "task" } },
          "required": ["task_context"]
        }
      ]
    }
  },
  "$defs": {
    "Environment": {
      "type": "string",
      "enum": ["dev", "staging", "prod"]
    },
    "DataClass": {
      "type": "string",
      "enum": ["public", "internal", "confidential", "secret"]
    },
    "Digest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["algo", "hex"],
      "properties": {
        "algo": { "type": "string", "enum": ["sha256", "sha512"] },
        "hex": { "type": "string", "pattern": "^[0-9a-f]{64}|[0-9a-f]{128}$" },
        "bytes": { "type": "string", "contentEncoding": "base64" }
      }
    },
    "Tenant": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9:_-]{1,128}$", "description": "Идентификатор аренды (иерархия через ':')." },
        "ancestry": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9:_-]{1,128}$" },
          "description": "Список предков от корня к родителю."
        }
      }
    },
    "Actor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sub"],
      "properties": {
        "sub": { "type": "string", "maxLength": 256, "description": "Субъект (user/service id)." },
        "roles": {
          "type": "array",
          "items": { "type": "string", "enum": ["bot", "reader", "editor", "admin", "owner"] },
          "maxItems": 32
        },
        "role_bindings": {
          "type": "array",
          "maxItems": 256,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["role", "tenant"],
            "properties": {
              "role": { "type": "string", "enum": ["bot", "reader", "editor", "admin", "owner"] },
              "tenant": { "type": "string", "pattern": "^[a-zA-Z0-9:_-]{1,128}$" }
            }
          }
        },
        "scopes": {
          "type": "array",
          "maxItems": 256,
          "items": { "type": "string", "maxLength": 128 }
        },
        "mfa": { "type": "boolean" },
        "authn": { "type": "string", "enum": ["jwt", "mtls", "api-key", "anonymous"] },
        "ip": { "type": "string", "oneOf": [ { "format": "ipv4" }, { "format": "ipv6" } ] },
        "user_agent": { "type": "string", "maxLength": 512 }
      }
    },
    "ResourceRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "id", "tenant_id"],
      "properties": {
        "kind": { "type": "string", "maxLength": 64 },
        "id": { "type": "string", "maxLength": 256 },
        "tenant_id": { "type": "string", "pattern": "^[a-zA-Z0-9:_-]{1,128}$" },
        "data_class": { "$ref": "#/$defs/DataClass" },
        "owner_id": { "type": "string", "maxLength": 256 }
      }
    },
    "HttpHeaders": {
      "type": "object",
      "propertyNames": { "pattern": "^[A-Za-z0-9-]{1,64}$" },
      "additionalProperties": { "type": "string", "maxLength": 8192 }
    },
    "HttpRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["method", "path"],
      "properties": {
        "method": { "type": "string", "enum": ["GET","POST","PUT","PATCH","DELETE","OPTIONS","HEAD"] },
        "path": { "type": "string", "maxLength": 4096 },
        "query": {
          "type": "object",
          "propertyNames": { "pattern": "^[A-Za-z0-9_.-]{1,64}$" },
          "additionalProperties": { "type": ["string","number","boolean","null"] }
        },
        "headers": { "$ref": "#/$defs/HttpHeaders" },
        "headers_redacted": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Za-z0-9-]{1,64}$" },
          "description": "Список заголовков, вырезанных из хранения (PII/секреты)."
        },
        "content_type": { "type": "string", "maxLength": 256 },
        "body_bytes": { "type": "integer", "minimum": 0, "maximum": 10485760 }
      }
    },
    "HttpResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status"],
      "properties": {
        "status": { "type": "integer", "minimum": 100, "maximum": 599 },
        "headers": { "$ref": "#/$defs/HttpHeaders" },
        "content_type": { "type": "string", "maxLength": 256 },
        "body_bytes": { "type": "integer", "minimum": 0, "maximum": 10485760 }
      }
    },
    "GrpcRequest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["service", "method"],
      "properties": {
        "service": { "type": "string", "maxLength": 256 },
        "method": { "type": "string", "maxLength": 256 },
        "authority": { "type": "string", "maxLength": 256 },
        "metadata": {
          "type": "object",
          "propertyNames": { "pattern": "^[A-Za-z0-9-]{1,64}$" },
          "additionalProperties": { "type": "string", "maxLength": 8192 }
        },
        "metadata_redacted": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Za-z0-9-]{1,64}$" }
        },
        "message_bytes": { "type": "integer", "minimum": 0, "maximum": 10485760 }
      }
    },
    "GrpcResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status_code"],
      "properties": {
        "status_code": { "type": "integer", "minimum": 0, "maximum": 16 },
        "message_bytes": { "type": "integer", "minimum": 0, "maximum": 10485760 }
      }
    },
    "CliContext": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "argv": { "type": "array", "items": { "type": "string", "maxLength": 256 }, "maxItems": 128 },
        "cwd": { "type": "string", "maxLength": 1024 }
      }
    },
    "TaskContext": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "worker": { "type": "string", "maxLength": 128 },
        "job_id": { "type": "string", "maxLength": 128 }
      }
    },
    "Decision": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allow"],
      "properties": {
        "allow": { "type": "boolean", "description": "Итоговое решение." },
        "status": { "type": "string", "enum": ["passed", "partially_passed", "failed"] },
        "reasons": { "type": "array", "items": { "type": "string", "maxLength": 512 }, "maxItems": 128 },
        "obligations": {
          "type": "array",
          "maxItems": 128,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
              "type": { "type": "string", "maxLength": 64 },
              "params": { "type": "object", "additionalProperties": { "type": ["string","number","boolean","null"] } }
            }
          }
        },
        "mask": { "type": "array", "items": { "type": "string", "maxLength": 128 }, "maxItems": 256 }
      }
    },
    "ValidationSeverity": {
      "type": "string",
      "enum": ["info", "warning", "error", "critical"]
    },
    "ValidationIssue": {
      "type": "object",
      "additionalProperties": false,
      "required": ["severity", "message"],
      "properties": {
        "id": { "type": "string", "maxLength": 64 },
        "severity": { "$ref": "#/$defs/ValidationSeverity" },
        "message": { "type": "string", "maxLength": 1024 },
        "rule": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "code": { "type": "string", "maxLength": 32 },
            "title": { "type": "string", "maxLength": 256 },
            "url": { "type": "string", "format": "uri" }
          }
        },
        "location": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "pointer": { "type": "string", "maxLength": 2048 },
            "line": { "type": "integer", "minimum": 0 },
            "column": { "type": "integer", "minimum": 0 },
            "source": { "type": "string", "maxLength": 1024 }
          }
        },
        "suggestion": { "type": "string", "maxLength": 1024 },
        "related_paths": { "type": "array", "items": { "type": "string", "maxLength": 2048 }, "maxItems": 64 },
        "metadata": { "type": "object", "additionalProperties": { "type": ["string","number","boolean","null"] } }
      }
    },
    "Metrics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["elapsed_ms"],
      "properties": {
        "elapsed_ms": { "type": "integer", "minimum": 0 },
        "cpu_ms": { "type": "integer", "minimum": 0 },
        "memory_bytes": { "type": "integer", "minimum": 0 },
        "rules_evaluated": { "type": "integer", "minimum": 0 },
        "ratelimit_applied": { "type": "boolean" }
      }
    },
    "Tracing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "trace_id": { "type": "string", "pattern": "^[0-9a-f]{32}$" },
        "span_id": { "type": "string", "pattern": "^[0-9a-f]{16}$" },
        "parent_span_id": { "type": "string", "pattern": "^[0-9a-f]{16}$" },
        "vendor": { "type": "string", "maxLength": 64 }
      }
    },
    "Risk": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "score": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "classification": { "type": "string", "enum": ["negligible","low","medium","high","critical"] },
        "notes": { "type": "string", "maxLength": 512 }
      }
    }
  },
  "examples": [
    {
      "schema_version": "1.0.0",
      "event_type": "policy.decision.v1",
      "event_id": "123e4567-e89b-12d3-a456-426614174000",
      "occurred_at": "2025-08-28T08:00:00Z",
      "environment": "prod",
      "tenant": { "id": "org:unit" },
      "actor": { "sub": "u42", "roles": ["admin"], "scopes": ["policy.admin"], "mfa": true },
      "resource": { "kind": "policy", "id": "pol-1", "tenant_id": "org:unit", "data_class": "confidential" },
      "action": "update",
      "channel": "http",
      "http_request": { "method": "POST", "path": "/api/v1/policy/pol-1", "headers_redacted": ["authorization"] },
      "http_response": { "status": 200 },
      "decision": { "allow": true, "status": "passed", "reasons": [], "obligations": [], "mask": [] },
      "issues": [],
      "metrics": { "elapsed_ms": 23, "cpu_ms": 4, "memory_bytes": 65536 },
      "tracing": { "trace_id": "0af7651916cd43dd8448eb211c80319c", "span_id": "b7ad6b7169203331" }
    }
  ]
}
