<!-- policy-core/clients/web-admin-minimal/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Policy Core — Web Admin (Minimal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- В продакшене CSP лучше задавать HTTP-заголовком. Здесь — безопасный дефолт для одиночного файла. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self'; base-uri 'none'; form-action 'none'; frame-ancestors 'none'">
  <meta name="color-scheme" content="light dark" />
  <meta name="referrer" content="no-referrer" />
  <style>
    :root {
      --bg: #0b0c0f;
      --bg-elev: #121419;
      --muted: #a1a7b3;
      --text: #e6eaf2;
      --accent: #4da3ff;
      --ok: #29c870;
      --warn: #f2b84b;
      --err: #f05d5e;
      --border: #232732;
      --chip: #1b2030;
      --focus: #86b7fe;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fa; --bg-elev:#ffffff; --muted:#4a5160; --text:#0f1222;
        --accent:#0b65d8; --ok:#15803d; --warn:#b45309; --err:#b91c1c; --border:#e5e7eb; --chip:#eef2ff; --focus:#2563eb;
      }
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: var(--bg-elev); border-bottom: 1px solid var(--border);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 12px 16px }
    .row { display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items: center }
    .brand { font-weight: 700; letter-spacing: .2px }
    .muted { color: var(--muted) }
    .controls { display: grid; grid-template-columns: 1.4fr 1fr 1fr 1fr 0.8fr auto; gap: 8px; margin-top: 10px }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px }
    input[type="text"], input[type="password"], select {
      width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px;
      background: transparent; color: var(--text); outline: none;
    }
    input::placeholder { color: var(--muted) }
    input:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus) 25%, transparent) }
    button {
      appearance: none; border: 1px solid var(--border); background: var(--bg-elev); color: var(--text);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }
    button.primary { border-color: color-mix(in oklab, var(--accent) 35%, var(--border)); background: color-mix(in oklab, var(--accent) 15%, var(--bg-elev)) }
    button.ok { border-color: color-mix(in oklab, var(--ok) 35%, var(--border)); background: color-mix(in oklab, var(--ok) 15%, var(--bg-elev)) }
    button.warn { border-color: color-mix(in oklab, var(--warn) 35%, var(--border)); background: color-mix(in oklab, var(--warn) 15%, var(--bg-elev)) }
    button:disabled { opacity: .6; cursor: not-allowed }
    main { max-width: 1200px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: minmax(300px, 1fr) minmax(380px, 1.1fr) }
    .card {
      background: var(--bg-elev); border: 1px solid var(--border); border-radius: 14px; overflow: clip;
    }
    .card > header, .card > footer { padding: 10px 12px; border-bottom: 1px solid var(--border) }
    .card > footer { border-top: 1px solid var(--border); border-bottom: 0 }
    .table-wrap { max-height: calc(100vh - 280px); overflow: auto }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); font-variant-numeric: tabular-nums }
    tr:hover { background: color-mix(in oklab, var(--accent) 8%, transparent) }
    tr.active { background: color-mix(in oklab, var(--accent) 15%, transparent) }
    .chips { display: flex; flex-wrap: wrap; gap: 6px }
    .chip { background: var(--chip); border: 1px solid var(--border); color: var(--text); padding: 2px 8px; border-radius: 999px; font-size: 12px }
    .status { font-weight: 600 }
    .status.ok { color: var(--ok) }
    .status.err { color: var(--err) }
    .status.warn { color: var(--warn) }
    .json {
      white-space: pre; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px; padding: 12px; overflow: auto; max-height: calc(100vh - 280px);
    }
    .json .k { color: #9cdcfe }
    .json .s { color: #ce9178 }
    .json .n { color: #b5cea8 }
    .json .b { color: #4fc1ff }
    .json .d { color: #dcdcaa }
    .toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border) }
    .spacer { flex: 1 }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--bg) }
    .pagination { display: flex; align-items: center; gap: 6px; padding: 8px 12px }
    .sr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0 }
    footer.page { max-width: 1200px; margin: 0 auto; padding: 8px 16px; color: var(--muted) }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row" role="group" aria-label="Заголовок и состояние">
        <div class="brand">Policy Core — Web Admin <span class="muted">(minimal)</span></div>
        <div id="netStatus" class="status warn" aria-live="polite">offline</div>
        <div id="apiPing" class="badge">—</div>
        <button id="themeBtn" title="Переключить тему" aria-label="Переключить тему">Тема</button>
      </div>
      <div class="controls" role="group" aria-label="Подключение и фильтры">
        <div>
          <label for="baseUrl">API Base URL</label>
          <input id="baseUrl" type="text" placeholder="https://policy-core.local/api" autocomplete="off" />
        </div>
        <div>
          <label for="tenant">Tenant</label>
          <input id="tenant" type="text" placeholder="acme" autocomplete="off" />
        </div>
        <div>
          <label for="kind">Kind</label>
          <input id="kind" type="text" placeholder="rbac|abac|rego|cel" autocomplete="off" />
        </div>
        <div>
          <label for="tags">Tags</label>
          <input id="tags" type="text" placeholder="prod,critical" autocomplete="off" />
        </div>
        <div>
          <label for="search">Поиск</label>
          <input id="search" type="text" placeholder="policy_id или etag" autocomplete="off" />
        </div>
        <div style="display:flex; gap:8px; align-items:end">
          <button id="connectBtn" class="primary">Подключить</button>
          <button id="refreshBtn">Обновить</button>
        </div>
      </div>
      <div class="controls" role="group" aria-label="Аутентификация">
        <div style="grid-column: 1 / span 3">
          <label for="token">Bearer Token (хранится в sessionStorage)</label>
          <input id="token" type="password" placeholder="eyJhbGciOi..." autocomplete="off" />
        </div>
        <div>
          <label for="timeout">Таймаут, сек</label>
          <input id="timeout" type="text" value="8" autocomplete="off" />
        </div>
        <div>
          <label for="pageSize">На странице</label>
          <select id="pageSize">
            <option>10</option><option selected>25</option><option>50</option><option>100</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; align-items:end">
          <button id="savePrefsBtn" class="ok">Сохранить</button>
          <button id="clearPrefsBtn" class="warn">Сброс</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-labelledby="listTitle">
      <header class="toolbar">
        <div id="listTitle" class="brand">Политики</div>
        <div class="spacer"></div>
        <div id="countBadge" class="badge">0</div>
      </header>
      <div class="table-wrap" role="region" aria-label="Таблица политик">
        <table id="tbl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Версия</th>
              <th>Kind</th>
              <th>Tenant</th>
              <th>Etag</th>
              <th>Updated</th>
              <th>Tags</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <footer class="pagination">
        <button id="prevBtn">Назад</button>
        <div id="pageInfo" class="badge">1 / 1</div>
        <button id="nextBtn">Вперед</button>
        <div class="spacer"></div>
        <div class="muted" id="hint">Подсказка: двойной клик по строке — детали</div>
      </footer>
    </section>

    <section class="card" aria-labelledby="detailTitle">
      <header class="toolbar">
        <div id="detailTitle" class="brand">Детали</div>
        <div class="spacer"></div>
        <button id="copyJsonBtn">Копировать JSON</button>
      </header>
      <pre id="json" class="json" tabindex="0" aria-live="polite">{}</pre>
    </section>
  </main>

  <footer class="page">
    Внимание: эндпоинты заданы как шаблоны и могут отличаться от вашего сервера. I cannot verify this.
  </footer>

  <script type="module">
    // ===== Настройки API (адаптируйте под свой backend). I cannot verify this. =====
    const API_ROUTES = {
      // список политик (ожидается массив PolicyMetadata)
      list: (base, { tenant, tags, kinds, q, page, pageSize }) => {
        const url = new URL(String(base).replace(/\/$/, "") + "/policies");
        if (tenant) url.searchParams.set("tenant_id", tenant);
        if (tags) url.searchParams.set("tags", tags);
        if (kinds) url.searchParams.set("kinds", kinds);
        if (q) url.searchParams.set("q", q);
        // если бэкенд не поддерживает server-side пагинацию — она будет client-side
        if (page != null) url.searchParams.set("page", String(page));
        if (pageSize != null) url.searchParams.set("page_size", String(pageSize));
        return url.toString();
      },
      // детали политики (ожидается объект Policy { metadata, spec, compiled? })
      get: (base, id) => String(base).replace(/\/$/, "") + "/policies/" + encodeURIComponent(id),
      // ping (опционально)
      ping: (base) => String(base).replace(/\/$/, "") + "/health"
    };

    // ===== Утилиты =====
    const $ = (sel, root = document) => root.querySelector(sel);

    const state = {
      prefs: {
        baseUrl: "",
        tenant: "",
        kind: "",
        tags: "",
        pageSize: 25,
        timeout: 8,
        theme: (localStorage.getItem("theme") || "auto"),
      },
      page: 1,
      rows: [],
      filtered: [],
      selectedId: null,
    };

    function savePrefs() {
      const data = {
        baseUrl: $("#baseUrl").value.trim(),
        tenant: $("#tenant").value.trim(),
        kind: $("#kind").value.trim(),
        tags: $("#tags").value.trim(),
        pageSize: parseInt($("#pageSize").value, 10) || 25,
        timeout: parseFloat($("#timeout").value) || 8,
        theme: state.prefs.theme,
      };
      localStorage.setItem("pc.admin.prefs", JSON.stringify(data));
      sessionStorage.setItem("pc.admin.token", $("#token").value);
      state.prefs = data;
      renderNetStatus("ok", "prefs saved");
    }

    function loadPrefs() {
      try {
        const raw = localStorage.getItem("pc.admin.prefs");
        if (raw) {
          const d = JSON.parse(raw);
          Object.assign(state.prefs, d);
        }
      } catch {}
      $("#baseUrl").value = state.prefs.baseUrl;
      $("#tenant").value = state.prefs.tenant;
      $("#kind").value = state.prefs.kind;
      $("#tags").value = state.prefs.tags;
      $("#pageSize").value = String(state.prefs.pageSize);
      $("#timeout").value = String(state.prefs.timeout);
      $("#token").value = sessionStorage.getItem("pc.admin.token") || "";
      applyTheme(state.prefs.theme);
    }

    function clearPrefs() {
      localStorage.removeItem("pc.admin.prefs");
      sessionStorage.removeItem("pc.admin.token");
      renderNetStatus("warn", "prefs cleared");
      loadPrefs();
    }

    function applyTheme(mode) {
      // mode: auto | light | dark
      state.prefs.theme = mode || "auto";
      localStorage.setItem("theme", state.prefs.theme);
      document.documentElement.dataset.theme = state.prefs.theme;
    }

    function renderNetStatus(level, text) {
      const el = $("#netStatus");
      el.textContent = text || "";
      el.className = "status " + (level === "ok" ? "ok" : level === "err" ? "err" : "warn");
    }

    function highlightJSON(obj) {
      const json = JSON.stringify(obj, null, 2);
      // простая подсветка без innerHTML инъекций: заменяем спецсимволы
      const esc = (s) => s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
      const html = esc(json)
        .replace(/(&quot;([^\\"]|\\.)*?&quot;)(\s*:)?/g, (m, p1, p2, p3) => p3 ? `<span class="k">${p1}</span><span class="d">:</span>` : `<span class="s">${p1}</span>`)
        .replace(/\b(true|false|null)\b/g, '<span class="b">$1</span>')
        .replace(/\b(-?\d+(?:\.\d+)?)\b/g, '<span class="n">$1</span>');
      return html;
    }

    async function fetchJson(url, { method = "GET", body, token, timeout = 8 } = {}) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), Math.max(1, timeout) * 1000);
      const headers = { "Accept": "application/json" };
      if (token) headers["Authorization"] = "Bearer " + token;
      if (body != null) headers["Content-Type"] = "application/json";
      try {
        const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined, signal: controller.signal, credentials: "omit", cache: "no-store" });
        const text = await res.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }
        if (!res.ok) {
          const msg = (json && (json.error || json.message)) || res.statusText || "HTTP error";
          throw new Error(msg + " (" + res.status + ")");
        }
        return json;
      } finally {
        clearTimeout(timer);
      }
    }

    function normalizeMeta(x) {
      // ожидаем PolicyMetadata; поля могут отличаться — аккуратно нормализуем
      return {
        policy_id: String(x.policy_id ?? x.id ?? ""),
        version: String(x.version ?? ""),
        kind: String(x.kind ?? ""),
        tenant_id: x.tenant_id ?? null,
        etag: String(x.etag ?? ""),
        updated_at: String(x.updated_at ?? x.updatedAt ?? ""),
        tags: Array.isArray(x.tags) ? x.tags : (x.tags ? String(x.tags).split(/[,\s]+/).filter(Boolean) : []),
      };
    }

    function applyClientFilters(rows) {
      const q = $("#search").value.trim().toLowerCase();
      const kind = $("#kind").value.trim().toLowerCase();
      const tenant = $("#tenant").value.trim().toLowerCase();
      const tags = ($("#tags").value.trim() || "").toLowerCase().split(/[,\s]+/).filter(Boolean);
      return rows.filter(r => {
        const id = r.policy_id.toLowerCase();
        const etag = r.etag.toLowerCase();
        const okQ = !q || id.includes(q) || etag.includes(q);
        const okKind = !kind || (r.kind || "").toLowerCase() === kind;
        const okTenant = !tenant || (r.tenant_id || "").toLowerCase() === tenant;
        const okTags = !tags.length || tags.every(t => (r.tags || []).map(x => String(x).toLowerCase()).includes(t));
        return okQ && okKind && okTenant && okTags;
      });
    }

    function renderTable() {
      const pageSize = state.prefs.pageSize;
      const total = state.filtered.length;
      const maxPage = Math.max(1, Math.ceil(total / pageSize));
      if (state.page > maxPage) state.page = maxPage;
      const from = (state.page - 1) * pageSize;
      const to = Math.min(from + pageSize, total);
      $("#countBadge").textContent = String(total);
      $("#pageInfo").textContent = `${state.page} / ${maxPage}`;

      const tbody = $("#tbody");
      tbody.textContent = "";
      for (let i = from; i < to; i++) {
        const r = state.filtered[i];
        const tr = document.createElement("tr");
        if (r.policy_id === state.selectedId) tr.classList.add("active");
        const td = (...cells) => cells.map(c => { const el = document.createElement("td"); el.textContent = c ?? ""; return el; });
        const tagChip = (tags) => {
          const div = document.createElement("div"); div.className = "chips";
          (tags || []).slice(0, 5).forEach(t => { const s = document.createElement("span"); s.className = "chip"; s.textContent = String(t); div.appendChild(s); });
          return div;
        };
        const [id, ver, kind, ten, etag, upd] = td(r.policy_id, r.version, r.kind, r.tenant_id || "", r.etag, r.updated_at);
        const tags = document.createElement("td"); tags.appendChild(tagChip(r.tags));
        [id, ver, kind, ten, etag, upd, tags].forEach(el => tr.appendChild(el));
        tr.addEventListener("click", () => selectRow(r.policy_id));
        tr.addEventListener("dblclick", () => selectRow(r.policy_id, true));
        tbody.appendChild(tr);
      }
      $("#prevBtn").disabled = state.page <= 1;
      $("#nextBtn").disabled = state.page >= Math.max(1, Math.ceil(total / pageSize));
    }

    async function selectRow(id, fetchDetail = false) {
      state.selectedId = id;
      renderTable();
      if (!fetchDetail) return;
      const base = $("#baseUrl").value.trim();
      const token = $("#token").value;
      try {
        const url = API_ROUTES.get(base, id);
        const data = await fetchJson(url, { token, timeout: state.prefs.timeout });
        const pre = $("#json");
        // безопасный вывод: подсветка через заранее экранированные токены
        pre.innerHTML = highlightJSON(data);
      } catch (e) {
        $("#json").textContent = JSON.stringify({ error: String(e && e.message || e) }, null, 2);
      }
    }

    async function loadList() {
      const base = $("#baseUrl").value.trim();
      const token = $("#token").value;
      const params = {
        tenant: $("#tenant").value.trim(),
        tags: $("#tags").value.trim(),
        kinds: $("#kind").value.trim(),
        q: $("#search").value.trim(),
        page: 1,
        pageSize: state.prefs.pageSize
      };
      const url = API_ROUTES.list(base, params);
      const t0 = performance.now();
      try {
        const arr = await fetchJson(url, { token, timeout: state.prefs.timeout });
        const rows = Array.isArray(arr) ? arr.map(normalizeMeta) : [];
        state.rows = rows;
        state.filtered = applyClientFilters(rows);
        state.page = 1;
        renderTable();
        $("#apiPing").textContent = `${Math.round(performance.now() - t0)} ms`;
        renderNetStatus("ok", "online");
      } catch (e) {
        renderNetStatus("err", "error");
        $("#apiPing").textContent = "—";
        state.rows = []; state.filtered = []; renderTable();
        $("#json").textContent = JSON.stringify({ error: String(e && e.message || e), url }, null, 2);
      }
    }

    // ===== Инициализация и события =====
    $("#connectBtn").addEventListener("click", loadList);
    $("#refreshBtn").addEventListener("click", loadList);
    $("#savePrefsBtn").addEventListener("click", savePrefs);
    $("#clearPrefsBtn").addEventListener("click", clearPrefs);
    $("#search").addEventListener("input", () => { state.filtered = applyClientFilters(state.rows); state.page = 1; renderTable(); });
    $("#kind").addEventListener("change", () => { state.filtered = applyClientFilters(state.rows); state.page = 1; renderTable(); });
    $("#tenant").addEventListener("change", () => { state.filtered = applyClientFilters(state.rows); state.page = 1; renderTable(); });
    $("#tags").addEventListener("change", () => { state.filtered = applyClientFilters(state.rows); state.page = 1; renderTable(); });
    $("#pageSize").addEventListener("change", () => { state.prefs.pageSize = parseInt($("#pageSize").value, 10) || 25; state.page = 1; renderTable(); });
    $("#prevBtn").addEventListener("click", () => { if (state.page > 1) { state.page--; renderTable(); }});
    $("#nextBtn").addEventListener("click", () => { state.page++; renderTable(); });
    $("#copyJsonBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText($("#json").innerText);
      } catch {}
    });
    $("#themeBtn").addEventListener("click", () => {
      const next = state.prefs.theme === "auto" ? "dark" : state.prefs.theme === "dark" ? "light" : "auto";
      applyTheme(next);
    });

    window.addEventListener("online", () => renderNetStatus("ok", "online"));
    window.addEventListener("offline", () => renderNetStatus("warn", "offline"));

    loadPrefs();
    // авто-коннект при наличии baseUrl
    if (state.prefs.baseUrl) loadList();
  </script>
</body>
</html>
