{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/zero-trust-core/schemas/jsonschema/v1/session_policy.schema.json",
  "title": "Zero Trust Session Policy (v1)",
  "type": "object",
  "additionalProperties": false,
  "unevaluatedProperties": false,
  "description": "Строгая схема политики Zero Trust для сессий. Используется контрольной плоскостью при принятии решений допуска/продления/ревалюации.",
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Версия схемы (semver).",
      "pattern": "^[0-9]+\\.[0-9]+(\\.[0-9]+)?$",
      "default": "1.0.0"
    },
    "policy_id": {
      "type": "string",
      "description": "Уникальный идентификатор политики (UUID).",
      "format": "uuid"
    },
    "name": {
      "type": "string",
      "minLength": 3,
      "maxLength": 128
    },
    "tenant_id": {
      "type": "string",
      "description": "Идентификатор арендатора.",
      "minLength": 1,
      "maxLength": 128
    },
    "status": {
      "type": "string",
      "description": "Состояние применения политики.",
      "enum": ["active", "disabled", "shadow"],
      "default": "active"
    },
    "precedence": {
      "type": "integer",
      "description": "Приоритет оценки (меньше — раньше).",
      "minimum": 0,
      "maximum": 100000,
      "default": 1000
    },
    "owners": {
      "type": "array",
      "description": "Команды/контакты-владельцы.",
      "items": { "type": "string", "minLength": 1 },
      "minItems": 1
    },
    "tags": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "uniqueItems": true,
      "default": []
    },

    "targets": {
      "type": "object",
      "description": "Таргетинг политики на аудитории.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "principals_include": { "$ref": "#/$defs/stringSet" },
        "principals_exclude": { "$ref": "#/$defs/stringSet" },
        "groups_include": { "$ref": "#/$defs/stringSet" },
        "groups_exclude": { "$ref": "#/$defs/stringSet" },
        "tenants_include": { "$ref": "#/$defs/stringSet" },
        "applications": { "$ref": "#/$defs/stringSet" },
        "environments": {
          "type": "array",
          "items": { "type": "string", "enum": ["prod", "staging", "dev", "test"] },
          "uniqueItems": true
        },
        "client_types": {
          "type": "array",
          "items": { "type": "string", "enum": ["browser", "mobile", "desktop", "service"] },
          "uniqueItems": true
        },
        "device_platforms": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["IOS", "ANDROID", "MACOS", "WINDOWS", "LINUX", "CHROME_OS"]
          },
          "uniqueItems": true
        },
        "labels_match": {
          "type": "object",
          "description": "Ключ=значение для сопоставления меток субъекта/устройства/сессии.",
          "propertyNames": { "type": "string", "minLength": 1, "maxLength": 64 },
          "additionalProperties": { "type": "string", "maxLength": 256 }
        }
      }
    },

    "conditions": {
      "type": "object",
      "description": "Условия допуска и требуемых действий.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "risk": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow_threshold": {
              "type": "number", "minimum": 0, "maximum": 1, "default": 0.35,
              "description": "Максимальный риск-сер для допуска без step-up."
            },
            "step_up_threshold": {
              "type": "number", "minimum": 0, "maximum": 1, "default": 0.6,
              "description": "Порог, начиная с которого требуется step-up MFA."
            },
            "deny_threshold": {
              "type": "number", "minimum": 0, "maximum": 1, "default": 0.85,
              "description": "Порог, начиная с которого отказ без попытки ремедиации."
            }
          },
          "allOf": [
            { "if": { "properties": { "step_up_threshold": { "type": "number" }, "allow_threshold": { "type": "number" } }, "required": ["step_up_threshold","allow_threshold"] },
              "then": { "properties": { "step_up_threshold": { "exclusiveMinimum": { "$data": "1/allow_threshold" } } } } },
            { "if": { "properties": { "deny_threshold": { "type": "number" }, "step_up_threshold": { "type": "number" } }, "required": ["deny_threshold","step_up_threshold"] },
              "then": { "properties": { "deny_threshold": { "exclusiveMinimum": { "$data": "1/step_up_threshold" } } } } }
          ]
        },
        "device": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "require_compliant": { "type": "boolean", "default": true },
            "require_managed": { "type": "boolean", "default": false },
            "min_os": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "ios": { "$ref": "#/$defs/versionString" },
                "android": { "$ref": "#/$defs/versionString" },
                "macos": { "$ref": "#/$defs/versionString" },
                "windows": { "$ref": "#/$defs/versionString" }
              }
            },
            "disallow_jailbreak": { "type": "boolean", "default": true },
            "require_secure_boot": { "type": "boolean", "default": true },
            "require_disk_encryption": { "type": "boolean", "default": true },
            "required_attestation": {
              "type": "array",
              "items": { "type": "string", "enum": ["APPLE_DEVICE_CHECK", "APPLE_ATTESTATION", "PLAY_INTEGRITY", "TPM_RA", "WINDOWS_HELLO"] },
              "uniqueItems": true
            }
          }
        },
        "network": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allow_corporate_network_only": { "type": "boolean", "default": false },
            "ip_allowlist": { "type": "array", "items": { "$ref": "#/$defs/cidr" }, "uniqueItems": true },
            "ip_denylist": { "type": "array", "items": { "$ref": "#/$defs/cidr" }, "uniqueItems": true },
            "countries_allow": { "type": "array", "items": { "$ref": "#/$defs/country" }, "uniqueItems": true },
            "countries_deny": { "type": "array", "items": { "$ref": "#/$defs/country" }, "uniqueItems": true },
            "asn_deny": { "type": "array", "items": { "type": "string", "pattern": "^[0-9]{1,10}$" }, "uniqueItems": true }
          }
        },
        "time_windows": {
          "$ref": "#/$defs/timeWindows"
        }
      }
    },

    "session": {
      "type": "object",
      "description": "Параметры жизни сессии.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "ttl_seconds": { "$ref": "#/$defs/positiveInt", "default": 28800, "description": "Макс. длительность (absolute) при отсутствии explicit absolute_lifetime." },
        "idle_timeout_seconds": { "$ref": "#/$defs/positiveInt", "default": 900 },
        "absolute_lifetime_seconds": { "$ref": "#/$defs/positiveInt", "default": 86400 },
        "reauth_interval_seconds": { "$ref": "#/$defs/nonNegativeInt", "default": 0, "description": "0 — не требовать периодический re-auth." },
        "reeval_period_seconds": { "$ref": "#/$defs/positiveInt", "default": 300, "description": "Периодическая переоценка Zero Trust контекста." },
        "allow_refresh": { "type": "boolean", "default": true },
        "refresh_max_lifetime_seconds": { "$ref": "#/$defs/positiveInt", "default": 2592000 }
      },
      "allOf": [
        {
          "if": { "properties": { "allow_refresh": { "const": true } } },
          "then": { "required": ["refresh_max_lifetime_seconds"] }
        }
      ]
    },

    "authn": {
      "type": "object",
      "description": "Правила аутентификации и step-up.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "mfa_policy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "mode": { "type": "string", "enum": ["none", "required", "step_up"], "default": "step_up" },
            "factors": {
              "type": "array",
              "items": { "type": "string", "enum": ["webauthn", "totp", "push", "sms", "email", "u2f"] },
              "uniqueItems": true,
              "minItems": 1
            },
            "remember_device_days": { "type": "integer", "minimum": 0, "maximum": 30, "default": 0 },
            "grace_seconds": { "$ref": "#/$defs/nonNegativeInt", "default": 0 },
            "step_up_actions": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "description": "Действия, для которых требуется step-up (например, \"transfer:wire\", \"secrets:read\").",
              "uniqueItems": true
            }
          },
          "allOf": [
            {
              "if": { "properties": { "mode": { "enum": ["required", "step_up"] } } },
              "then": { "required": ["factors"] }
            }
          ]
        }
      }
    },

    "transport": {
      "type": "object",
      "description": "Транспортные требования и привязка токена.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "mtls_required": { "type": "boolean", "default": true },
        "accepted_client_ca_refs": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true,
          "description": "Ссылки/идентификаторы доверенных CA для клиентских сертификатов."
        },
        "token_binding": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "type": "string", "enum": ["none", "mtls", "dpop"], "default": "mtls" },
            "required": { "type": "boolean", "default": true },
            "dpop_constraints": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "algorithms": { "type": "array", "items": { "type": "string", "enum": ["ES256", "ES384", "EdDSA"] }, "uniqueItems": true, "minItems": 1 },
                "clock_skew_seconds": { "$ref": "#/$defs/nonNegativeInt", "default": 60 },
                "nonce_required": { "type": "boolean", "default": false }
              }
            }
          }
        }
      },
      "allOf": [
        {
          "if": { "properties": { "mtls_required": { "const": true } } },
          "then": { "required": ["accepted_client_ca_refs"] }
        },
        {
          "if": { "properties": { "token_binding": { "properties": { "type": { "const": "dpop" } }, "required": ["type"] } } },
          "then": { "properties": { "token_binding": { "required": ["dpop_constraints"] } } }
        }
      ]
    },

    "jwt_constraints": {
      "type": "object",
      "description": "Требования к JWT/потокам OAuth/OIDC.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "issuers": { "$ref": "#/$defs/stringSet" },
        "audiences": { "$ref": "#/$defs/stringSet" },
        "require_pkce": { "type": "boolean", "default": true },
        "require_jti_replay_protection": { "type": "boolean", "default": true },
        "max_token_age_seconds": { "$ref": "#/$defs/positiveInt", "default": 3600 },
        "clock_skew_seconds": { "$ref": "#/$defs/nonNegativeInt", "default": 60 },
        "allowed_algs": {
          "type": "array",
          "items": { "type": "string", "enum": ["RS256", "PS256", "ES256", "ES384", "EdDSA"] },
          "uniqueItems": true,
          "minItems": 1
        }
      },
      "required": ["issuers", "audiences", "allowed_algs"]
    },

    "authorization": {
      "type": "object",
      "description": "Правила авторизации для сессии.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "default_effect": { "type": "string", "enum": ["deny", "allow"], "default": "deny" },
        "resource_pattern_syntax": { "type": "string", "enum": ["glob", "regex"], "default": "glob" },
        "allow": {
          "type": "array",
          "items": { "$ref": "#/$defs/actionRule" },
          "uniqueItems": true,
          "default": []
        },
        "deny": {
          "type": "array",
          "items": { "$ref": "#/$defs/actionRule" },
          "uniqueItems": true,
          "default": []
        }
      }
    },

    "enforcement": {
      "type": "object",
      "description": "Пороговые значения для детекций/защит (только триггеры, не алгоритмы).",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "anomaly_zscore_trigger": { "type": "number", "minimum": 0, "default": 6.0 },
        "rate_spike_zscore_trigger": { "type": "number", "minimum": 0, "default": 5.0 }
      }
    },

    "audit": {
      "type": "object",
      "description": "Настройки аудита и маскирования.",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "decision_logging_enabled": { "type": "boolean", "default": true },
        "pii_masking": { "type": "string", "enum": ["off", "basic", "strict"], "default": "strict" },
        "redact_fields": {
          "type": "array",
          "items": { "type": "string", "pattern": "^(/[^/]+)+$" },
          "uniqueItems": true,
          "description": "JSON Pointer полей, подлежащих редактированию."
        }
      }
    },

    "lifecycle": {
      "type": "object",
      "additionalProperties": false,
      "unevaluatedProperties": false,
      "properties": {
        "created_at": { "$ref": "#/$defs/timestamp" },
        "updated_at": { "$ref": "#/$defs/timestamp" },
        "expires_at": { "$ref": "#/$defs/timestamp" }
      }
    }
  },

  "required": ["schema_version", "policy_id", "name", "tenant_id", "status", "jwt_constraints", "session", "authn", "transport", "authorization"],

  "dependentSchemas": {
    "authn": {
      "properties": {
        "authn": {
          "properties": {
            "mfa_policy": {
              "if": { "properties": { "mode": { "const": "none" } } },
              "else": { "required": ["factors"] }
            }
          }
        }
      }
    },
    "transport": {
      "properties": {
        "transport": {
          "if": { "properties": { "token_binding": { "properties": { "type": { "const": "dpop" } }, "required": ["type"] } } },
          "then": { "required": ["token_binding"] }
        }
      }
    }
  },

  "$defs": {
    "stringSet": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 256 },
      "uniqueItems": true
    },
    "versionString": {
      "type": "string",
      "pattern": "^[0-9]+(\\.[0-9]+){0,2}$"
    },
    "positiveInt": {
      "type": "integer",
      "minimum": 1
    },
    "nonNegativeInt": {
      "type": "integer",
      "minimum": 0
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "cidr": {
      "type": "string",
      "pattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3}|([0-9a-fA-F:]+))\\/(\\d|[1-5]\\d|6[0-4])$",
      "description": "IPv4/IPv6 CIDR"
    },
    "country": {
      "type": "string",
      "pattern": "^[A-Z]{2}$",
      "description": "ISO-3166-1 alpha-2"
    },
    "timeWindows": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "timezone": { "type": "string", "minLength": 1, "default": "UTC" },
        "cron": { "type": "string", "minLength": 1 },
        "windows": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "from": { "$ref": "#/$defs/timestamp" },
              "to": { "$ref": "#/$defs/timestamp" }
            },
            "required": ["from", "to"]
          }
        }
      }
    },
    "actionRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "action": { "type": "string", "pattern": "^[a-z][a-z0-9_:\\-]{2,64}$" },
        "resource": { "type": "string", "minLength": 1, "maxLength": 512, "description": "Шаблон ресурса. Семантика определяется resource_pattern_syntax." },
        "conditions": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "require_step_up": { "type": "boolean", "default": false },
            "min_trust_level": { "type": "string", "enum": ["LOW", "MEDIUM", "HIGH"], "default": "LOW" },
            "max_risk": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        }
      },
      "required": ["action", "resource"]
    }
  },

  "examples": [
    {
      "schema_version": "1.0.0",
      "policy_id": "1a2b3c4d-1111-2222-3333-444455556666",
      "name": "prod-default-zero-trust",
      "tenant_id": "acme",
      "status": "active",
      "precedence": 100,
      "owners": ["platform-security"],
      "tags": ["zero-trust", "session"],
      "targets": {
        "environments": ["prod"],
        "client_types": ["browser", "mobile"],
        "device_platforms": ["IOS", "ANDROID", "MACOS", "WINDOWS"]
      },
      "conditions": {
        "risk": { "allow_threshold": 0.35, "step_up_threshold": 0.6, "deny_threshold": 0.85 },
        "device": { "require_compliant": true, "disallow_jailbreak": true, "require_secure_boot": true, "require_disk_encryption": true },
        "network": { "allow_corporate_network_only": false, "countries_deny": ["RU", "KP"] },
        "time_windows": { "timezone": "UTC" }
      },
      "session": {
        "ttl_seconds": 28800,
        "idle_timeout_seconds": 900,
        "absolute_lifetime_seconds": 86400,
        "reauth_interval_seconds": 0,
        "reeval_period_seconds": 300,
        "allow_refresh": true,
        "refresh_max_lifetime_seconds": 2592000
      },
      "authn": {
        "mfa_policy": {
          "mode": "step_up",
          "factors": ["webauthn", "totp"],
          "remember_device_days": 0,
          "step_up_actions": ["secrets:read", "payments:transfer"]
        }
      },
      "transport": {
        "mtls_required": true,
        "accepted_client_ca_refs": ["secrets://pki/clients/prod"],
        "token_binding": {
          "type": "mtls",
          "required": true
        }
      },
      "jwt_constraints": {
        "issuers": ["https://idp.corp/"],
        "audiences": ["zero-trust-core"],
        "require_pkce": true,
        "require_jti_replay_protection": true,
        "max_token_age_seconds": 3600,
        "clock_skew_seconds": 60,
        "allowed_algs": ["ES256", "EdDSA"]
      },
      "authorization": {
        "default_effect": "deny",
        "resource_pattern_syntax": "glob",
        "allow": [
          { "action": "read", "resource": "doc:*" },
          { "action": "write", "resource": "doc:workspace/*", "conditions": { "require_step_up": true, "min_trust_level": "MEDIUM" } }
        ],
        "deny": [
          { "action": "delete", "resource": "doc:safe/*" }
        ]
      },
      "enforcement": {
        "anomaly_zscore_trigger": 6.0,
        "rate_spike_zscore_trigger": 5.0
      },
      "audit": {
        "decision_logging_enabled": true,
        "pii_masking": "strict",
        "redact_fields": ["/authn/credentials/password", "/jwt/access_token"]
      },
      "lifecycle": {
        "created_at": "2025-08-01T12:00:00Z",
        "updated_at": "2025-08-20T10:00:00Z"
      }
    }
  ]
}
