{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aethernova.dev/schemas/jsonschema/v1/risk_model.schema.json",
  "title": "Zero-Trust RiskAssessment",
  "type": "object",
  "additionalProperties": false,
  "required": ["apiVersion", "kind", "metadata", "subject", "risk", "decision", "audit"],
  "properties": {
    "apiVersion": { "const": "zero-trust.aethernova/v1" },
    "kind": { "const": "RiskAssessment" },
    "schema_version": { "type": "string", "pattern": "^1\\.0(\\.\\d+)?$" },

    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "tenant", "environment", "revision"],
      "properties": {
        "id": { "$ref": "#/$defs/ulid" },
        "tenant": { "$ref": "#/$defs/nonEmpty" },
        "environment": { "enum": ["dev", "stage", "prod"] },
        "revision": { "type": "integer", "minimum": 1 },
        "labels": { "$ref": "#/$defs/labels" },
        "annotations": { "$ref": "#/$defs/labels" }
      }
    },

    "subject": {
      "type": "object",
      "additionalProperties": false,
      "required": ["iss", "sub", "aud"],
      "properties": {
        "iss": { "type": "string", "format": "uri" },
        "aud": { "type": "string", "minLength": 1, "maxLength": 256 },
        "sub": { "$ref": "#/$defs/nonEmpty" },
        "client_id": { "type": "string", "minLength": 1, "maxLength": 256 },
        "amr": { "type": "array", "items": { "type": "string", "minLength": 1 }, "uniqueItems": true, "maxItems": 16 },
        "mfa_age_seconds": { "type": "number", "minimum": 0 },
        "session": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "sid": { "$ref": "#/$defs/nonEmpty" },
            "jti": { "$ref": "#/$defs/nonEmpty" }
          }
        }
      }
    },

    "device": {
      "type": "object",
      "additionalProperties": false,
      "required": ["device_id"],
      "properties": {
        "device_id": { "$ref": "#/$defs/nonEmpty" },
        "posture_id": { "$ref": "#/$defs/ulid" },
        "compliant": { "type": "boolean" },
        "trust_level": { "enum": ["UNTRUSTED", "LOW", "MEDIUM", "HIGH"] },
        "cnf": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "x5t#S256": { "$ref": "#/$defs/base64url" },
            "spiffe_ids": {
              "type": "array",
              "items": { "type": "string", "pattern": "^spiffe://[a-zA-Z0-9.-]+/.+" },
              "uniqueItems": true,
              "maxItems": 8
            }
          }
        }
      }
    },

    "risk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["score", "level", "aggregator"],
      "properties": {
        "score": { "$ref": "#/$defs/score01" },
        "level": { "$ref": "#/$defs/riskLevel" },
        "aggregator": { "enum": ["weighted_sum", "max", "median", "bayesian", "custom"] },
        "thresholds": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "low": { "$ref": "#/$defs/score01" },
            "medium": { "$ref": "#/$defs/score01" },
            "high": { "$ref": "#/$defs/score01" }
          }
        },
        "signals": {
          "type": "array",
          "minItems": 1,
          "maxItems": 128,
          "items": { "$ref": "#/$defs/riskSignal" }
        }
      }
    },

    "decision": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allow", "reasons", "obligations", "effective_level"],
      "properties": {
        "allow": { "type": "boolean" },
        "effective_level": { "$ref": "#/$defs/riskLevel" },
        "reasons": {
          "type": "array",
          "items": { "$ref": "#/$defs/decisionReason" },
          "uniqueItems": true,
          "maxItems": 16
        },
        "obligations": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "require_step_up_mfa": { "type": "boolean" },
            "require_mtls": { "type": "boolean" },
            "require_device_remediation": { "type": "boolean" }
          }
        },
        "actions": {
          "type": "array",
          "items": { "enum": ["allow", "block", "challenge"] },
          "uniqueItems": true,
          "maxItems": 3
        }
      }
    },

    "evidence": {
      "type": "array",
      "minItems": 0,
      "maxItems": 64,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type", "id"],
        "properties": {
          "type": { "enum": ["posture", "attestation", "anomaly", "custom"] },
          "id": { "$ref": "#/$defs/nonEmpty" },
          "ref": { "type": "string", "format": "uri" },
          "hash": { "$ref": "#/$defs/base64url" },
          "attributes": { "$ref": "#/$defs/kvAttributes" }
        }
      }
    },

    "ttl": { "$ref": "#/$defs/duration" },

    "signature": {
      "type": "object",
      "additionalProperties": false,
      "required": ["alg", "signature"],
      "properties": {
        "alg": { "enum": ["none", "Ed25519", "ECDSA_P256_SHA256", "RSASSA_PSS_SHA256"] },
        "key_id": { "type": "string", "minLength": 1, "maxLength": 128 },
        "public_key": { "$ref": "#/$defs/base64url" },
        "signature": { "$ref": "#/$defs/base64url" },
        "input_digest": {
          "type": "object",
          "additionalProperties": false,
          "required": ["alg", "value"],
          "properties": {
            "alg": { "enum": ["SHA-256", "SHA-384", "SHA-512"] },
            "value": { "$ref": "#/$defs/base64url" }
          }
        }
      }
    },

    "audit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["evaluated_at", "generator"],
      "properties": {
        "evaluated_at": { "$ref": "#/$defs/isoDatetime" },
        "expires_at": { "$ref": "#/$defs/isoDatetime" },
        "generator": { "type": "string", "minLength": 1, "maxLength": 128 },
        "trace_id": { "type": "string", "pattern": "^[a-f0-9]{16,64}$" },
        "labels": { "$ref": "#/$defs/labels" }
      }
    }
  },

  "$defs": {
    "nonEmpty": { "type": "string", "minLength": 1, "maxLength": 512 },
    "ulid": { "type": "string", "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$" },
    "isoDatetime": { "type": "string", "format": "date-time" },
    "duration": {
      "type": "string",
      "format": "duration",
      "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+D)?(T(\\d+H)?(\\d+M)?(\\d+S)?)?$"
    },
    "base64url": { "type": "string", "pattern": "^[A-Za-z0-9_-]+={0,2}$", "minLength": 8 },
    "score01": { "type": "number", "minimum": 0, "maximum": 1, "multipleOf": 0.0001 },
    "riskLevel": { "type": "string", "enum": ["low", "medium", "high"] },

    "labels": {
      "type": "object",
      "propertyNames": { "pattern": "^[a-z0-9]([-a-z0-9_.]{0,61}[a-z0-9])?$" },
      "additionalProperties": {
        "type": "string",
        "maxLength": 256
      },
      "maxProperties": 64
    },

    "kvAttributes": {
      "type": "object",
      "additionalProperties": {
        "oneOf": [
          { "type": "string", "maxLength": 2048 },
          { "type": "number" },
          { "type": "integer" },
          { "type": "boolean" },
          { "type": "null" }
        ]
      },
      "maxProperties": 128
    },

    "provider": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 64 },
        "version": { "type": "string", "minLength": 1, "maxLength": 32 },
        "tenant": { "type": "string", "minLength": 1, "maxLength": 128 },
        "region": { "type": "string", "minLength": 2, "maxLength": 32 }
      }
    },

    "riskSignal": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "category", "score", "observed_at"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Za-z0-9:_\\-.]{1,64}$" },
        "name": { "type": "string", "minLength": 1, "maxLength": 128 },
        "category": { "enum": ["behavior", "device", "network", "geo", "anomaly", "user"] },
        "score": { "$ref": "#/$defs/score01" },
        "weight": { "type": "number", "minimum": 0, "maximum": 10 },
        "provider": { "$ref": "#/$defs/provider" },
        "observed_at": { "$ref": "#/$defs/isoDatetime" },
        "expires_at": { "$ref": "#/$defs/isoDatetime" },
        "attributes": { "$ref": "#/$defs/kvAttributes" },
        "related_refs": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 256 },
          "uniqueItems": true,
          "maxItems": 16
        }
      }
    },

    "decisionReason": {
      "type": "string",
      "enum": [
        "step_up_required",
        "mtls_required",
        "device_noncompliant",
        "high_risk",
        "rbac_denied",
        "jwt_policy_failed"
      ]
    }
  }
}
