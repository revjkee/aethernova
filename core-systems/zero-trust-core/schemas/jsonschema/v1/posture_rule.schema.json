{
  "$id": "https://aethernova.dev/zero-trust-core/schemas/jsonschema/v1/posture_rule.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Zero Trust Device Posture Rule",
  "description": "Контракт описания правила постуры устройства для систем Zero Trust. Правило определяет эффект при выполнении или невыполнении набора условий по устройству/сессии/сети.",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "name", "revision", "enabled", "effect", "where"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "description": "Версия схемы правил.",
      "const": "1.0"
    },
    "id": {
      "type": "string",
      "description": "Стабильный идентификатор правила (UUID v4 или ULID).",
      "oneOf": [
        { "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$" },
        { "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$" }
      ]
    },
    "name": {
      "type": "string",
      "minLength": 3,
      "maxLength": 200,
      "description": "Человекочитаемое имя правила."
    },
    "description": {
      "type": "string",
      "maxLength": 2000
    },
    "tags": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 64 },
      "uniqueItems": true
    },
    "owner": { "type": "string", "maxLength": 200 },
    "revision": {
      "type": "integer",
      "minimum": 1,
      "description": "Ревизия правила (инкремент при изменениях)."
    },
    "enabled": { "type": "boolean", "default": true },
    "severity": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "default": "medium"
    },
    "effect": {
      "type": "string",
      "description": "Действие при совпадении условия.",
      "enum": ["allow", "deny", "warn", "quarantine"]
    },
    "expiresAt": { "type": "string", "format": "date-time" },
    "createdAt": { "type": "string", "format": "date-time" },
    "updatedAt": { "type": "string", "format": "date-time" },

    "scope": {
      "type": "object",
      "description": "Ограничение области применения правила.",
      "additionalProperties": false,
      "properties": {
        "tenants": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "subjectKinds": {
          "type": "array",
          "items": { "type": "string", "enum": ["human", "service", "workload", "device", "robot"] },
          "uniqueItems": true
        },
        "groups": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "labels": { "type": "array", "items": { "type": "string" }, "uniqueItems": true }
      }
    },

    "where": {
      "$ref": "#/$defs/logicNode",
      "description": "Дерево условий: all/any/none и листья‑условия."
    },

    "remediation": {
      "type": "object",
      "description": "Инструкции по исправлению для пользователя/агента.",
      "additionalProperties": false,
      "properties": {
        "message": { "type": "string", "maxLength": 1000 },
        "url": { "type": "string", "format": "uri" },
        "steps": { "type": "array", "items": { "type": "string", "maxLength": 500 }, "maxItems": 20 }
      }
    },

    "audit": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "log": { "type": "boolean", "default": true },
        "reasonRequired": { "type": "boolean", "default": false }
      }
    }
  },

  "$defs": {
    "logicNode": {
      "description": "Узел логического дерева: композиция или лист‑условие.",
      "oneOf": [
        { "$ref": "#/$defs/booleanNode" },
        { "$ref": "#/$defs/conditionNode" }
      ]
    },

    "booleanNode": {
      "type": "object",
      "additionalProperties": false,
      "oneOf": [
        {
          "required": ["all"],
          "properties": {
            "all": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/logicNode" }
            }
          }
        },
        {
          "required": ["any"],
          "properties": {
            "any": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/logicNode" }
            }
          }
        },
        {
          "required": ["none"],
          "properties": {
            "none": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/logicNode" }
            }
          }
        }
      ]
    },

    "conditionNode": {
      "description": "Лист‑условие. Ровно одно из доступных условий.",
      "oneOf": [
        { "$ref": "#/$defs/cond_os" },
        { "$ref": "#/$defs/cond_device" },
        { "$ref": "#/$defs/cond_edr" },
        { "$ref": "#/$defs/cond_mdm" },
        { "$ref": "#/$defs/cond_attestation" },
        { "$ref": "#/$defs/cond_diskEncryption" },
        { "$ref": "#/$defs/cond_secureBoot" },
        { "$ref": "#/$defs/cond_firewall" },
        { "$ref": "#/$defs/cond_pathExists" },
        { "$ref": "#/$defs/cond_fileHash" },
        { "$ref": "#/$defs/cond_process" },
        { "$ref": "#/$defs/cond_registryKey" },
        { "$ref": "#/$defs/cond_plistKey" },
        { "$ref": "#/$defs/cond_certPresent" },
        { "$ref": "#/$defs/cond_network" },
        { "$ref": "#/$defs/cond_geo" },
        { "$ref": "#/$defs/cond_ipReputation" },
        { "$ref": "#/$defs/cond_screenLock" },
        { "$ref": "#/$defs/cond_userIsAdmin" },
        { "$ref": "#/$defs/cond_serialIn" }
      ]
    },

    "versionComparator": {
      "type": "object",
      "additionalProperties": false,
      "required": ["op", "value"],
      "properties": {
        "op": { "type": "string", "enum": ["=", ">", ">=", "<", "<="] },
        "value": { "type": "string", "minLength": 1, "maxLength": 100 }
      }
    },

    "versionRange": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "min": { "type": "string" },
        "max": { "type": "string" },
        "includeMin": { "type": "boolean", "default": true },
        "includeMax": { "type": "boolean", "default": true }
      },
      "anyOf": [
        { "required": ["min"] },
        { "required": ["max"] }
      ]
    },

    "osConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["platform"],
      "properties": {
        "platform": {
          "type": "string",
          "enum": ["windows", "macos", "linux", "ios", "android", "chromeos", "unknown"]
        },
        "version": {
          "description": "Сравнение или диапазон версии ОС.",
          "oneOf": [
            { "$ref": "#/$defs/versionComparator" },
            { "$ref": "#/$defs/versionRange" }
          ]
        },
        "build": { "type": "string" }
      }
    },

    "deviceConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "compliant": { "type": "boolean" },
        "managed": { "type": "boolean" },
        "posture": {
          "type": "string",
          "enum": ["healthy", "out_of_date", "unverified", "compromised"]
        }
      }
    },

    "edrConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "present": { "type": "boolean" },
        "vendor": { "type": "string", "maxLength": 100 },
        "version": {
          "oneOf": [
            { "$ref": "#/$defs/versionComparator" },
            { "$ref": "#/$defs/versionRange" }
          ]
        }
      }
    },

    "mdmConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "present": { "type": "boolean" },
        "vendor": { "type": "string", "maxLength": 100 },
        "compliant": { "type": "boolean" }
      }
    },

    "attestationConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["tpm", "android-key", "apple", "webauthn"] },
        "required": { "type": "boolean", "default": true },
        "aaguidAllow": { "type": "array", "items": { "type": "string", "maxLength": 64 }, "uniqueItems": true }
      }
    },

    "diskEncryptionConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "algorithm": {
          "type": "string",
          "enum": ["bitlocker", "filevault", "luks", "apfs", "dm-crypt", "unknown"]
        }
      }
    },

    "secureBootConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": { "enabled": { "type": "boolean" } }
    },

    "firewallConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled"],
      "properties": { "enabled": { "type": "boolean" } }
    },

    "pathExistsConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["path", "exists"],
      "properties": {
        "path": { "type": "string", "minLength": 1 },
        "exists": { "type": "boolean" }
      }
    },

    "fileHashConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["path", "algo", "hash"],
      "properties": {
        "path": { "type": "string", "minLength": 1 },
        "algo": { "type": "string", "enum": ["sha256", "sha1", "md5"] },
        "hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{32,64}$" }
      }
    },

    "processConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "running"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 200 },
        "running": { "type": "boolean" },
        "hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{32,64}$" },
        "signerDN": { "type": "string", "maxLength": 500 }
      }
    },

    "registryKeyConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "path": { "type": "string", "minLength": 5 },
        "valueName": { "type": "string" },
        "exists": { "type": "boolean" },
        "equals": { "type": ["string", "number", "boolean"] }
      },
      "description": "Windows Registry условие."
    },

    "plistKeyConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "domain": { "type": "string" },
        "key": { "type": "string" },
        "exists": { "type": "boolean" },
        "equals": { "type": ["string", "number", "boolean"] }
      },
      "description": "macOS Plist условие."
    },

    "certPresentConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "store": { "type": "string", "enum": ["system", "user", "custom"] },
        "subjectCN": { "type": "string" },
        "issuerCN": { "type": "string" },
        "sha256": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" }
      }
    },

    "networkConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "privateNetwork": { "type": "boolean" },
        "cidrIn": {
          "type": "array",
          "items": { "type": "string", "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$" },
          "uniqueItems": true
        }
      }
    },

    "geoConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "countryIn": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Z]{2}$" },
          "uniqueItems": true
        },
        "countryNotIn": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Z]{2}$" },
          "uniqueItems": true
        }
      }
    },

    "ipReputationConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["op", "score"],
      "properties": {
        "provider": { "type": "string" },
        "op": { "type": "string", "enum": [">", ">=", "<", "<="] },
        "score": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },

    "screenLockConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "maxTimeoutSeconds": { "type": "integer", "minimum": 10, "maximum": 86400 },
        "enabled": { "type": "boolean" }
      }
    },

    "userIsAdminConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value"],
      "properties": { "value": { "type": "boolean" } }
    },

    "serialInConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["values"],
      "properties": {
        "values": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 128 },
          "uniqueItems": true
        }
      }
    },

    "cond_os": {
      "type": "object",
      "required": ["os"],
      "additionalProperties": false,
      "properties": { "os": { "$ref": "#/$defs/osConstraint" } }
    },
    "cond_device": {
      "type": "object",
      "required": ["device"],
      "additionalProperties": false,
      "properties": { "device": { "$ref": "#/$defs/deviceConstraint" } }
    },
    "cond_edr": {
      "type": "object",
      "required": ["edr"],
      "additionalProperties": false,
      "properties": { "edr": { "$ref": "#/$defs/edrConstraint" } }
    },
    "cond_mdm": {
      "type": "object",
      "required": ["mdm"],
      "additionalProperties": false,
      "properties": { "mdm": { "$ref": "#/$defs/mdmConstraint" } }
    },
    "cond_attestation": {
      "type": "object",
      "required": ["attestation"],
      "additionalProperties": false,
      "properties": { "attestation": { "$ref": "#/$defs/attestationConstraint" } }
    },
    "cond_diskEncryption": {
      "type": "object",
      "required": ["diskEncryption"],
      "additionalProperties": false,
      "properties": { "diskEncryption": { "$ref": "#/$defs/diskEncryptionConstraint" } }
    },
    "cond_secureBoot": {
      "type": "object",
      "required": ["secureBoot"],
      "additionalProperties": false,
      "properties": { "secureBoot": { "$ref": "#/$defs/secureBootConstraint" } }
    },
    "cond_firewall": {
      "type": "object",
      "required": ["firewall"],
      "additionalProperties": false,
      "properties": { "firewall": { "$ref": "#/$defs/firewallConstraint" } }
    },
    "cond_pathExists": {
      "type": "object",
      "required": ["pathExists"],
      "additionalProperties": false,
      "properties": { "pathExists": { "$ref": "#/$defs/pathExistsConstraint" } }
    },
    "cond_fileHash": {
      "type": "object",
      "required": ["fileHash"],
      "additionalProperties": false,
      "properties": { "fileHash": { "$ref": "#/$defs/fileHashConstraint" } }
    },
    "cond_process": {
      "type": "object",
      "required": ["process"],
      "additionalProperties": false,
      "properties": { "process": { "$ref": "#/$defs/processConstraint" } }
    },
    "cond_registryKey": {
      "type": "object",
      "required": ["registryKey"],
      "additionalProperties": false,
      "properties": { "registryKey": { "$ref": "#/$defs/registryKeyConstraint" } }
    },
    "cond_plistKey": {
      "type": "object",
      "required": ["plistKey"],
      "additionalProperties": false,
      "properties": { "plistKey": { "$ref": "#/$defs/plistKeyConstraint" } }
    },
    "cond_certPresent": {
      "type": "object",
      "required": ["certPresent"],
      "additionalProperties": false,
      "properties": { "certPresent": { "$ref": "#/$defs/certPresentConstraint" } }
    },
    "cond_network": {
      "type": "object",
      "required": ["network"],
      "additionalProperties": false,
      "properties": { "network": { "$ref": "#/$defs/networkConstraint" } }
    },
    "cond_geo": {
      "type": "object",
      "required": ["geo"],
      "additionalProperties": false,
      "properties": { "geo": { "$ref": "#/$defs/geoConstraint" } }
    },
    "cond_ipReputation": {
      "type": "object",
      "required": ["ipReputation"],
      "additionalProperties": false,
      "properties": { "ipReputation": { "$ref": "#/$defs/ipReputationConstraint" } }
    },
    "cond_screenLock": {
      "type": "object",
      "required": ["screenLock"],
      "additionalProperties": false,
      "properties": { "screenLock": { "$ref": "#/$defs/screenLockConstraint" } }
    },
    "cond_userIsAdmin": {
      "type": "object",
      "required": ["userIsAdmin"],
      "additionalProperties": false,
      "properties": { "userIsAdmin": { "$ref": "#/$defs/userIsAdminConstraint" } }
    },
    "cond_serialIn": {
      "type": "object",
      "required": ["serialIn"],
      "additionalProperties": false,
      "properties": { "serialIn": { "$ref": "#/$defs/serialInConstraint" } }
    }
  },

  "examples": [
    {
      "id": "2c3f9a88-2d3c-4d6b-8e0f-9b1b7d2a1111",
      "schemaVersion": "1.0",
      "name": "macOS: требовать FileVault и EDR",
      "description": "На macOS требуем включённый FileVault и установленный EDR CrowdStrike.",
      "revision": 3,
      "enabled": true,
      "severity": "high",
      "effect": "deny",
      "scope": {
        "subjectKinds": ["human"],
        "labels": ["env:stage"]
      },
      "where": {
        "all": [
          { "os": { "platform": "macos", "version": { "op": ">=", "value": "11.0" } } },
          { "diskEncryption": { "enabled": true, "algorithm": "filevault" } },
          { "edr": { "present": true, "vendor": "CrowdStrike" } }
        ]
      },
      "remediation": {
        "message": "Включите FileVault и установите корпоративный EDR.",
        "url": "https://kb.example.com/security/macos-filevault-edr"
      }
    },
    {
      "id": "a1bc1c00-3b2e-4f5d-8b5b-f0aa0aa23333",
      "schemaVersion": "1.0",
      "name": "Windows: блок при отключённом Secure Boot или BitLocker",
      "revision": 1,
      "enabled": true,
      "severity": "critical",
      "effect": "quarantine",
      "where": {
        "all": [
          { "os": { "platform": "windows" } },
          {
            "any": [
              { "secureBoot": { "enabled": false } },
              { "diskEncryption": { "enabled": false } }
            ]
          }
        ]
      }
    }
  ]
}
