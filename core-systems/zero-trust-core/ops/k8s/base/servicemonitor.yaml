apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: zero-trust-core-api
  namespace: zero-trust-core
  labels:
    app.kubernetes.io/part-of: zero-trust-core
    app.kubernetes.io/component: api
    monitoring: enabled
spec:
  jobLabel: app.kubernetes.io/name
  namespaceSelector:
    matchNames:
      - zero-trust-core
  selector:
    matchLabels:
      app.kubernetes.io/name: zero-trust-core-api
      app.kubernetes.io/component: api
  targetLabels:
    - app.kubernetes.io/part-of
    - app.kubernetes.io/component
    - app.kubernetes.io/version
  endpoints:
    - port: http-metrics           # имя порта в Service (должно существовать)
      path: /metrics
      scheme: http
      interval: 15s
      scrapeTimeout: 5s
      honorLabels: true
      honorTimestamps: true
      relabelings:
        # Нормализуем job и добавляем node
        - action: replace
          targetLabel: job
          replacement: zero-trust-core-api
        - action: replace
          sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
      metricRelabelings:
        # Снижаем шум от внутренних метрик клиента Prometheus
        - action: drop
          sourceLabels: [__name__]
          regex: promhttp_.*
    # Пример HTTPS с mTLS (включите, если сервис экспортирует метрики по HTTPS)
    # - port: https-metrics
    #   path: /metrics
    #   scheme: https
    #   interval: 15s
    #   scrapeTimeout: 5s
    #   tlsConfig:
    #     insecureSkipVerify: false
    #     serverName: api.zero-trust-core.svc
    #     ca:
    #       secret:
    #         name: platform-ca
    #         key: ca.crt
    #     cert:
    #       secret:
    #         name: prometheus-client-cert
    #         key: tls.crt
    #     keySecret:
    #       name: prometheus-client-cert
    #       key: tls.key

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: zero-trust-core-scheduler
  namespace: zero-trust-core
  labels:
    app.kubernetes.io/part-of: zero-trust-core
    app.kubernetes.io/component: scheduler
    monitoring: enabled
spec:
  jobLabel: app.kubernetes.io/name
  namespaceSelector:
    matchNames:
      - zero-trust-core
  selector:
    matchLabels:
      app.kubernetes.io/name: zero-trust-core-scheduler
      app.kubernetes.io/component: scheduler
  targetLabels:
    - app.kubernetes.io/part-of
    - app.kubernetes.io/component
    - app.kubernetes.io/version
  endpoints:
    - port: metrics                 # имя порта в Service (должно существовать)
      path: /metrics
      scheme: http
      interval: 30s                 # для фоновых воркеров можно реже
      scrapeTimeout: 5s
      honorLabels: true
      honorTimestamps: true
      relabelings:
        - action: replace
          targetLabel: job
          replacement: zero-trust-core-scheduler
        - action: replace
          sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
      metricRelabelings:
        # Отбрасываем внутренние метрики экспорта, чтобы снизить кардинальность
        - action: drop
          sourceLabels: [__name__]
          regex: promhttp_.*
