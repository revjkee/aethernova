# =============================================================================
# zero-trust-core :: Kubernetes Services (base)
# - Внутренний трафик (ClusterIP)
# - Отдельный сервис для метрик (Prometheus/ServiceMonitor)
# - Без фиксированного namespace (назначается верхним слоем Kustomize/Helm)
# =============================================================================

---
apiVersion: v1
kind: Service
metadata:
  name: zero-trust-core
  labels:
    app.kubernetes.io/name: zero-trust-core
    app.kubernetes.io/instance: zero-trust-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: zero-trust-core
    app.kubernetes.io/managed-by: kustomize
  annotations:
    # Подсказки балансировщику в пределах зон (поддержка зависит от кластера)
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  publishNotReadyAddresses: false
  selector:
    app.kubernetes.io/name: zero-trust-core
    app.kubernetes.io/component: api
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
      appProtocol: http
    # Раскомментируйте, если приложение экспонирует TLS/HTTPS
    # - name: https
    #   port: 8443
    #   targetPort: 8443
    #   protocol: TCP
    #   appProtocol: https
    # Раскомментируйте, если используется gRPC (h2c)
    # - name: grpc
    #   port: 9095
    #   targetPort: 9095
    #   protocol: TCP
    #   appProtocol: grpc

---
apiVersion: v1
kind: Service
metadata:
  name: zero-trust-core-metrics
  labels:
    app.kubernetes.io/name: zero-trust-core
    app.kubernetes.io/instance: zero-trust-core
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: zero-trust-core
    app.kubernetes.io/managed-by: kustomize
    monitoring: "true"
  annotations:
    # Аннотации для классического prometheus.io‑scrape (если не используете ServiceMonitor)
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  selector:
    app.kubernetes.io/name: zero-trust-core
    app.kubernetes.io/component: api
  ports:
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
      appProtocol: http

# -----------------------------------------------------------------------------
# Опционально: headless‑сервис для прямого pod‑DNS (например, StatefulSet)
# Раскомментируйте, если нужен stateful‑дискавери.
# -----------------------------------------------------------------------------
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: zero-trust-core-headless
#   labels:
#     app.kubernetes.io/name: zero-trust-core
#     app.kubernetes.io/instance: zero-trust-core
#     app.kubernetes.io/component: api
#     app.kubernetes.io/part-of: zero-trust-core
#     app.kubernetes.io/managed-by: kustomize
# spec:
#   clusterIP: None
#   publishNotReadyAddresses: false
#   selector:
#     app.kubernetes.io/name: zero-trust-core
#     app.kubernetes.io/component: api
#   ports:
#     - name: http
#       port: 8080
#       targetPort: 8080
#       protocol: TCP
#       appProtocol: http
