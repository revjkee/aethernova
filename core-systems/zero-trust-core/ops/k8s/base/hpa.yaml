apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: zero-trust-core
  labels:
    app.kubernetes.io/name: zero-trust-core
    app.kubernetes.io/part-of: zero-trust-core
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/environment: base
  annotations:
    # Окно стабильности смягчает дрожание метрик (см. spec.behavior ниже)
    kubernetes.io/description: "HPA base для zero-trust-core (CPU/Mem + прод-ведение)"
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: zero-trust-core
  minReplicas: 2            # для базы держим высокую доступность
  maxReplicas: 20
  # Основные сигналы: CPU/Memory. Цели в процентах от requests.
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70     # таргет CPU ~70% от requests
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80     # таргет Mem ~80% от requests

    # Примеры ДОПОЛНИТЕЛЬНЫХ метрик (раскомментируйте, если установлен Prometheus Adapter):
    # - type: Pods
    #   pods:
    #     metric:
    #       name: http_requests_per_second   # пример метрики на Pod
    #     target:
    #       type: AverageValue
    #       averageValue: "50"               # на Pod
    # - type: Object
    #   object:
    #     describedObject:
    #       apiVersion: apps/v1
    #       kind: Deployment
    #       name: zero-trust-core
    #     metric:
    #       name: queue_depth                # пример объектной метрики (очередь)
    #     target:
    #       type: Value
    #       value: "1000"

  # Управление поведением скейлинга: быстро вверх, аккуратно вниз
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0           # реагировать быстро
      policies:
        # Разрешаем до 100% прироста за 30с, но не менее +4 Pod за 30с
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 4
          periodSeconds: 30
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300         # сгладить спады нагрузки (5 минут)
      policies:
        # Не более 10%/мин или −1 Pod/мин (берется минимально «жесткая» политика)
        - type: Percent
          value: 10
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 60
      selectPolicy: Min
