{{- /*
Production-grade PodDisruptionBudget template for zero-trust-core.

Features:
- Conditional apiVersion selection (policy/v1 if available, fallback to policy/v1beta1)
- Either .Values.pdb.minAvailable OR .Values.pdb.maxUnavailable must be set (enforced)
- Flexible selector: .Values.pdb.selectorMatchLabels overrides defaults
- Standard labels and annotations, includes release and chart context
- Values are documented in the example values.yaml below
*/ -}}

{{- if .Values.pdb.enabled | default true -}}
{{- $hasPolicyV1 := .Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" -}}
apiVersion: {{ if $hasPolicyV1 }}policy/v1{{ else }}policy/v1beta1{{ end }}
kind: PodDisruptionBudget
metadata:
  name: {{ include "zero-trust-core.fullname" . | trunc 63 | trimSuffix "-" }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: "{{ .Release.Service }}"
    {{- with .Values.pdb.additionalLabels }}
    {{ toYaml . | indent 4 }}
    {{- end }}
  annotations:
    meta.helm.sh/release-name: "{{ .Release.Name }}"
    meta.helm.sh/release-namespace: "{{ .Release.Namespace }}"
    {{- with .Values.pdb.annotations }}
    {{ toYaml . | indent 4 }}
    {{- end }}

{{/* Validate that at least one of minAvailable/maxUnavailable is provided */}}
{{- $min := .Values.pdb.minAvailable | default nil -}}
{{- $max := .Values.pdb.maxUnavailable | default nil -}}
{{- if and (not $min) (not $max) -}}
{{- fail "pdb: configuration invalid: either .Values.pdb.minAvailable or .Values.pdb.maxUnavailable must be set" -}}
{{- end }}

spec:
  {{- /* Selector: allow explicit map via values or fall back to common labels */}}
  selector:
    matchLabels:
{{- if .Values.pdb.selectorMatchLabels }}
{{ toYaml .Values.pdb.selectorMatchLabels | indent 6 }}
{{- else }}
      app.kubernetes.io/name: {{ .Chart.Name }}
      app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

  {{- /* Only one of these should be present: minAvailable OR maxUnavailable.
        Accept both percentage "50%" or integer values. Use toYaml to preserve types. */}}
{{- if $min }}
  minAvailable: {{ $min | quoteIfNeeded }}
{{- else if $max }}
  maxUnavailable: {{ $max | quoteIfNeeded }}
{{- end }}
{{- end }}
