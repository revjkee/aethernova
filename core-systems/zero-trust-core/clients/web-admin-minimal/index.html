<!-- path: zero-trust-core/clients/web-admin-minimal/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Zero‑Trust Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Backend base URL (можно оставить /api за reverse-proxy) -->
  <meta name="ztrust-api-base" content="/api">

  <!-- Строгая политика безопасности. В продакшне сервер ДОЛЖЕН подставлять рандомный nonce -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'none';
    base-uri 'none';
    form-action 'self';
    frame-ancestors 'none';
    object-src 'none';
    script-src 'self' 'nonce-__NONCE__';
    style-src  'self' 'nonce-__NONCE__';
    img-src    'self' data: blob:;
    font-src   'self';
    connect-src 'self';
    upgrade-insecure-requests;
  ">

  <!-- Доп. заголовки безопасности (для справки; лучше отдать сервером) -->
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <meta name="color-scheme" content="light dark">

  <style nonce="__NONCE__">
    :root{
      --bg: #0b0d10;
      --fg: #e5e7eb;
      --muted:#9ca3af;
      --card:#111418;
      --accent:#7dd3fc;
      --ok:#34d399;
      --warn:#f59e0b;
      --err:#f87171;
      --border:#1f242b;
      --input:#0e1116;
      --link:#93c5fd;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7fafc; --fg:#0b0d10; --muted:#4b5563; --card:#ffffff;
        --accent:#0369a1; --ok:#059669; --warn:#b45309; --err:#b91c1c;
        --border:#e5e7eb; --input:#ffffff; --link:#1d4ed8;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      background:var(--bg); color:var(--fg);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--card); border-bottom:1px solid var(--border);
      padding:12px 16px; display:flex; align-items:center; gap:12px;
    }
    .brand{font-weight:700; letter-spacing:.2px}
    .tag{font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; color:var(--muted)}
    .container{max-width:1100px; margin:18px auto; padding:0 16px;}
    nav{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 14px}
    nav button{
      background:transparent; color:var(--fg); border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; cursor:pointer;
    }
    nav button[aria-current="page"]{border-color:var(--accent)}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:960px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      padding:14px; box-shadow:0 1px 0 rgba(0,0,0,.05);
    }
    h2{margin:0 0 10px; font-size:16px}
    label{display:block; margin:10px 0 6px; color:var(--muted)}
    input,textarea,select{
      width:100%; background:var(--input); border:1px solid var(--border); color:var(--fg);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    textarea{min-height:150px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:13px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .btn{
      background:var(--accent); color:#001018; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.secondary{background:transparent; color:var(--fg); border:1px solid var(--border)}
    .btn.warn{background:var(--warn); color:#1a1200}
    .btn.ok{background:var(--ok); color:#00140a}
    .status{font-size:12px; color:var(--muted)}
    code, pre{background:var(--input); border:1px solid var(--border); border-radius:10px; padding:10px; overflow:auto}
    .pill{font-size:12px; border:1px solid var(--border); border-radius:9999px; padding:3px 8px; color:var(--muted)}
    .log{height:260px; overflow:auto; background:var(--input); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:ui-monospace,monospace; font-size:12px; white-space:pre-wrap}
    .kvs{display:grid; grid-template-columns:auto 1fr; gap:6px 12px}
    .kvs dt{color:var(--muted)}
    .kvs dd{margin:0}
    a{color:var(--link); text-decoration:none}
    a:focus,button:focus,input:focus,textarea:focus{outline:2px solid var(--accent); outline-offset:2px}
  </style>
</head>
<body>
<header role="banner">
  <div class="brand" aria-label="Zero-Trust Admin">Zero‑Trust Admin</div>
  <span class="tag" id="tenantTag" title="Текущий тенант">no-tenant</span>
  <span class="tag" id="authTag" title="Статус аутентификации">guest</span>
  <div style="margin-left:auto" class="row" role="group" aria-label="Навигация">
    <nav>
      <button id="tab-auth" aria-current="page">Аутентификация</button>
      <button id="tab-policy">Оценка политики</button>
      <button id="tab-audit">Аудит</button>
      <button id="tab-health">Состояние</button>
    </nav>
  </div>
</header>

<main class="container" id="app" role="main" aria-live="polite">
  <!-- AUTH -->
  <section id="view-auth" class="grid" aria-label="Аутентификация">
    <div class="card">
      <h2>Вход: пароль + TOTP</h2>
      <div class="row">
        <div>
          <label for="tenant">Tenant ID</label>
          <input id="tenant" placeholder="tenant-001">
        </div>
        <div>
          <label for="username">Имя пользователя</label>
          <input id="username" autocomplete="username">
        </div>
      </div>
      <label for="password">Пароль</label>
      <input id="password" type="password" autocomplete="current-password">
      <label for="totp">TOTP (если включено)</label>
      <input id="totp" inputmode="numeric" pattern="[0-9]*" placeholder="123456" autocomplete="one-time-code">
      <div class="actions">
        <button class="btn" id="btnLogin">Войти</button>
        <button class="btn secondary" id="btnLogout" aria-disabled="true">Выйти</button>
      </div>
      <div class="status" id="authStatus">Не аутентифицирован</div>
    </div>

    <div class="card">
      <h2>Вход: Passkey (WebAuthn)</h2>
      <label for="webauthn-username">Имя пользователя</label>
      <input id="webauthn-username" autocomplete="username webauthn">
      <div class="actions">
        <button class="btn ok" id="btnPasskeyLogin">Войти по Passkey</button>
        <button class="btn secondary" id="btnPasskeyRegister">Зарегистрировать Passkey</button>
      </div>
      <div class="status">Требуется HTTPS и поддержка WebAuthn в браузере.</div>
    </div>
  </section>

  <!-- POLICY -->
  <section id="view-policy" class="grid" hidden aria-label="Оценка политики">
    <div class="card">
      <h2>Запрос на оценку</h2>
      <div class="row">
        <div>
          <label for="policy-correlation">Correlation ID</label>
          <input id="policy-correlation" placeholder="req-123">
        </div>
        <div>
          <label for="env-ip">IP</label>
          <input id="env-ip" placeholder="203.0.113.10">
        </div>
      </div>
      <label>JSON (Subject, Action, Resource, Environment.attributes)</label>
      <textarea id="policy-json" spellcheck="false" aria-label="JSON запроса">
{
  "subject": {"id": "u-42", "attributes": {"role": "admin"}},
  "action":  {"name": "read", "attributes": {}},
  "resource":{"id": "r-1", "type": "document", "attributes": {"classification": "internal"}},
  "environment":{"attributes": {"channel": "web"}}
}
      </textarea>
      <div class="actions">
        <button class="btn" id="btnEvaluate">Оценить</button>
        <span class="pill" id="policyEffect">effect: —</span>
      </div>
    </div>
    <div class="card">
      <h2>Результат</h2>
      <pre id="policyResult" aria-live="polite" role="status">—</pre>
    </div>
  </section>

  <!-- AUDIT -->
  <section id="view-audit" class="grid" hidden aria-label="Аудит">
    <div class="card">
      <h2>Поток аудита</h2>
      <div class="row">
        <div>
          <label for="audit-filter">Фильтр (строка)</label>
          <input id="audit-filter" placeholder="policy-event OR error">
        </div>
      </div>
      <div class="actions">
        <button class="btn ok" id="btnAuditStart">Подключить</button>
        <button class="btn warn" id="btnAuditStop" aria-disabled="true">Отключить</button>
        <button class="btn secondary" id="btnAuditClear">Очистить</button>
      </div>
      <div class="status">SSE: GET /audit/stream</div>
    </div>
    <div class="card">
      <h2>Логи</h2>
      <div class="log" id="auditLog" role="log" aria-live="polite" aria-atomic="false"></div>
    </div>
  </section>

  <!-- HEALTH -->
  <section id="view-health" class="grid" hidden aria-label="Состояние системы">
    <div class="card">
      <h2>Health</h2>
      <div class="actions">
        <button class="btn" id="btnHealth">Обновить</button>
      </div>
      <dl class="kvs" id="healthKvs">
        <dt>backend</dt><dd>—</dd>
        <dt>policy_version</dt><dd>—</dd>
        <dt>cache_ttl_sec</dt><dd>—</dd>
        <dt>rate_limit_per_sec</dt><dd>—</dd>
        <dt>cb.failure_threshold</dt><dd>—</dd>
        <dt>cb.reset_timeout_sec</dt><dd>—</dd>
        <dt>cb.half_open_max_calls</dt><dd>—</dd>
      </dl>
    </div>
    <div class="card">
      <h2>Справка по API</h2>
      <ul>
        <li>POST /auth/login {username,password,totp?,tenant_id?} → {token}</li>
        <li>POST /auth/logout</li>
        <li>POST /policy/evaluate → {effect, obligations, policy_version, reason}</li>
        <li>GET  /audit/stream (SSE) — рекомендуем cookie‑базовую авторизацию</li>
        <li>GET  /health → сводка адаптера/бэкенда</li>
        <li>POST /webauthn/register/options → PublicKeyCredentialCreationOptions</li>
        <li>POST /webauthn/register/verify</li>
        <li>POST /webauthn/login/options → PublicKeyCredentialRequestOptions</li>
        <li>POST /webauthn/login/verify → {token}</li>
      </ul>
      <div class="status">Маршруты должны быть реализованы бекендом Zero‑Trust Core.</div>
    </div>
  </section>
</main>

<script type="module" nonce="__NONCE__">
/**
 * Zero‑Trust Admin minimal SPA
 * Без внешних зависимостей. Токен хранится только в памяти.
 */
const $ = (sel) => document.querySelector(sel);
const apiBase = document.querySelector('meta[name="ztrust-api-base"]')?.content || '/api';
let authToken = null; // Только в памяти
let currentTenant = 'no-tenant';
let auditEs = null;

const headers = () => {
  const h = {'Content-Type':'application/json'};
  if (authToken) h['Authorization'] = 'Bearer ' + authToken;
  if (currentTenant) h['X-Tenant-ID'] = currentTenant;
  return h;
};

async function api(path, opts={}) {
  const url = apiBase.replace(/\/$/, '') + path;
  const init = {
    method: opts.method || 'GET',
    headers: {...headers(), ...(opts.headers||{})},
    credentials: 'include', // для CSRF-cookie если используется
    body: opts.body ? JSON.stringify(opts.body) : undefined,
    signal: opts.signal
  };
  const res = await fetch(url, init);
  let data = null;
  const ct = res.headers.get('content-type')||'';
  if (ct.includes('application/json')) {
    data = await res.json().catch(()=>null);
  } else {
    data = await res.text().catch(()=>null);
  }
  if (!res.ok) {
    const msg = (data && data.error) || (typeof data==='string' ? data : res.statusText);
    throw new Error(msg || `HTTP ${res.status}`);
  }
  return data;
}

// Навигация
const views = {
  'tab-auth':   '#view-auth',
  'tab-policy': '#view-policy',
  'tab-audit':  '#view-audit',
  'tab-health': '#view-health',
};
for (const id of Object.keys(views)) {
  $('#'+id).addEventListener('click', () => showView(id));
}
function showView(id) {
  for (const [btnId, viewSel] of Object.entries(views)) {
    $(viewSel).hidden = (btnId !== id);
    $('#'+btnId).setAttribute('aria-current', btnId===id ? 'page' : 'false');
  }
}
showView('tab-auth');

// AUTH
$('#btnLogin').addEventListener('click', async () => {
  const username = $('#username').value.trim();
  const password = $('#password').value;
  const totp = $('#totp').value.trim();
  currentTenant = $('#tenant').value.trim() || 'no-tenant';
  setTenant(currentTenant);
  try {
    const data = await api('/auth/login', {method:'POST', body: {username, password, totp: totp || undefined, tenant_id: currentTenant}});
    authToken = data?.token || null;
    updateAuthUi(true, 'Вход выполнен');
  } catch (e) {
    updateAuthUi(false, 'Ошибка входа: ' + (e.message||e));
  }
});
$('#btnLogout').addEventListener('click', async () => {
  try { await api('/auth/logout', {method:'POST'}); } catch {}
  authToken = null;
  updateAuthUi(false, 'Вы вышли из системы');
});
function updateAuthUi(isAuth, msg) {
  $('#authStatus').textContent = msg;
  $('#authTag').textContent = isAuth ? 'auth' : 'guest';
  $('#btnLogout').setAttribute('aria-disabled', isAuth ? 'false':'true');
}

// Passkey (WebAuthn)
$('#btnPasskeyRegister').addEventListener('click', async () => {
  const username = $('#webauthn-username').value.trim();
  if (!username) return alert('Введите имя пользователя');
  currentTenant = $('#tenant').value.trim() || 'no-tenant';
  setTenant(currentTenant);
  try {
    const options = await api('/webauthn/register/options', {method:'POST', body:{username, tenant_id: currentTenant}});
    const pubKey = reviveBinary(options);
    const cred = await navigator.credentials.create({publicKey: pubKey});
    const payload = credToJSON(cred);
    await api('/webauthn/register/verify', {method:'POST', body: {username, tenant_id: currentTenant, credential: payload}});
    alert('Passkey зарегистрирован');
  } catch (e) {
    alert('Ошибка регистрации Passkey: ' + (e.message||e));
  }
});
$('#btnPasskeyLogin').addEventListener('click', async () => {
  const username = $('#webauthn-username').value.trim();
  if (!username) return alert('Введите имя пользователя');
  currentTenant = $('#tenant').value.trim() || 'no-tenant';
  setTenant(currentTenant);
  try {
    const options = await api('/webauthn/login/options', {method:'POST', body:{username, tenant_id: currentTenant}});
    const pubKey = reviveBinary(options);
    const assertion = await navigator.credentials.get({publicKey: pubKey});
    const payload = credToJSON(assertion);
    const data = await api('/webauthn/login/verify', {method:'POST', body:{username, tenant_id: currentTenant, credential: payload}});
    authToken = data?.token || null;
    updateAuthUi(true, 'Вход по Passkey выполнен');
  } catch (e) {
    updateAuthUi(false, 'Ошибка Passkey: ' + (e.message||e));
  }
});

// POLICY
$('#btnEvaluate').addEventListener('click', async () => {
  const correlation_id = $('#policy-correlation').value.trim() || undefined;
  const ip = $('#env-ip').value.trim() || undefined;
  let body;
  try {
    const parsed = JSON.parse($('#policy-json').value);
    body = {
      subject: parsed.subject,
      action: parsed.action,
      resource: parsed.resource,
      environment: {ip: ip || undefined, attributes: (parsed.environment && parsed.environment.attributes) || {}},
      correlation_id,
      tenant_id: currentTenant
    };
  } catch {
    return setPolicyResult({error:'Невалидный JSON'});
  }
  try {
    const res = await api('/policy/evaluate', {method:'POST', body});
    setPolicyResult(res);
  } catch (e) {
    setPolicyResult({error: e.message || String(e)});
  }
});
function setPolicyResult(res) {
  $('#policyResult').textContent = JSON.stringify(res, null, 2);
  const eff = res?.effect || '—';
  $('#policyEffect').textContent = 'effect: ' + eff;
}

// AUDIT (SSE)
$('#btnAuditStart').addEventListener('click', () => startAudit());
$('#btnAuditStop').addEventListener('click', () => stopAudit());
$('#btnAuditClear').addEventListener('click', () => { $('#auditLog').textContent = ''; });

function startAudit() {
  if (auditEs) return;
  if (!window.EventSource) {
    logAudit('SSE не поддерживается браузером');
    return;
  }
  const filter = encodeURIComponent($('#audit-filter').value.trim() || '');
  // Вариант с cookie‑авторизацией предпочтительнее; здесь fallback c токеном в query, если сервер это разрешает.
  const tokenParam = authToken ? ('&token=' + encodeURIComponent(authToken)) : '';
  const url = apiBase.replace(/\/$/, '') + '/audit/stream?filter=' + filter + tokenParam;
  auditEs = new EventSource(url, {withCredentials:true});
  auditEs.onopen = () => {
    $('#btnAuditStop').setAttribute('aria-disabled','false');
    logAudit('[open] подключено');
  };
  auditEs.onerror = (e) => {
    logAudit('[error] ' + (e?.message || 'SSE error'));
  };
  auditEs.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      logAudit(JSON.stringify(data));
    } catch {
      logAudit(ev.data);
    }
  };
}
function stopAudit() {
  if (auditEs) {
    auditEs.close();
    auditEs = null;
    $('#btnAuditStop').setAttribute('aria-disabled','true');
    logAudit('[close] отключено');
  }
}
function logAudit(line) {
  const el = $('#auditLog');
  const ts = new Date().toISOString();
  el.textContent += `[${ts}] ${line}\n`;
  el.scrollTop = el.scrollHeight;
}

// HEALTH
$('#btnHealth').addEventListener('click', async () => {
  try {
    const h = await api('/health');
    fillHealth(h);
  } catch (e) {
    fillHealth({error: e.message || String(e)});
  }
});
function fillHealth(h) {
  const kv = $('#healthKvs');
  const map = new Map(Object.entries({
    backend: h.backend,
    policy_version: h.policy_version,
    cache_ttl_sec: h.cache_ttl_sec,
    rate_limit_per_sec: h.rate_limit_per_sec,
    'cb.failure_threshold': h?.circuit_breaker?.failure_threshold,
    'cb.reset_timeout_sec': h?.circuit_breaker?.reset_timeout_sec,
    'cb.half_open_max_calls': h?.circuit_breaker?.half_open_max_calls,
    error: h.error
  }));
  // Обновление значений
  const dts = kv.querySelectorAll('dt');
  const seen = new Set();
  dts.forEach(dt => {
    const key = dt.textContent;
    seen.add(key);
    const dd = dt.nextElementSibling;
    dd.textContent = map.get(key) ?? '—';
  });
  // Доп. ключи
  for (const [k,v] of map.entries()) {
    if (seen.has(k) || v === undefined) continue;
    const dt = document.createElement('dt'); dt.textContent = k;
    const dd = document.createElement('dd'); dd.textContent = String(v);
    kv.appendChild(dt); kv.appendChild(dd);
  }
}

// Вспомогательные: WebAuthn binary revive и сериализация
function reviveBinary(obj){
  // Преобразуем Base64URL строки обратно в ArrayBuffer
  const b64uToBuf = (b64u) => Uint8Array.from(atob(b64u.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0)).buffer;
  const walk = (o) => {
    if (!o || typeof o !== 'object') return o;
    for (const k of Object.keys(o)) {
      if (k.endsWith('Challenge') || k.endsWith('challenge') || k.endsWith('userId') || k==='allowCredentials' || k==='excludeCredentials' || k==='id') {
        if (k==='allowCredentials' || k==='excludeCredentials') {
          o[k] = o[k].map(it => ({...it, id: b64uToBuf(it.id)}));
        } else {
          o[k] = b64uToBuf(o[k]);
        }
      } else if (typeof o[k] === 'object') {
        o[k] = walk(o[k]);
      }
    }
    return o;
  };
  return walk(structuredClone(obj));
}
function credToJSON(cred){
  const bufToB64u = (buf) => {
    const b = Array.from(new Uint8Array(buf)).map(b=>String.fromCharCode(b)).join('');
    return btoa(b).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  };
  const clientDataJSON = cred.response.clientDataJSON ? bufToB64u(cred.response.clientDataJSON) : null;
  const authenticatorData = cred.response.authenticatorData ? bufToB64u(cred.response.authenticatorData) : null;
  const signature = cred.response.signature ? bufToB64u(cred.response.signature) : null;
  const userHandle = cred.response.userHandle ? bufToB64u(cred.response.userHandle) : null;
  const attestationObject = cred.response.attestationObject ? bufToB64u(cred.response.attestationObject) : null;
  return {
    id: cred.id,
    type: cred.type,
    rawId: bufToB64u(cred.rawId),
    response: { clientDataJSON, authenticatorData, signature, userHandle, attestationObject }
  };
}

// Вспомогательные: визуальные статусы
function setTenant(t){ currentTenant = t || 'no-tenant'; $('#tenantTag').textContent = currentTenant; }
</script>
</body>
</html>
