# file: zero-trust-core/configs/logging.yaml
# Профиль промышленного логирования для Zero Trust Core
# Поддержка: JSON/структурированные логи, ротация, OpenTelemetry, интеграция с SIEM

version: 1

disable_existing_loggers: false

formatters:
  json:
    format: >
      {"time":"%(asctime)s","level":"%(levelname)s","logger":"%(name)s",
       "module":"%(module)s","function":"%(funcName)s","line":%(lineno)d,
       "trace_id":"%(otelTraceID)s","span_id":"%(otelSpanID)s",
       "user":"%(user)s","event":"%(message)s"}
    datefmt: "%Y-%m-%dT%H:%M:%S%z"

  console:
    format: "[%(asctime)s] [%(levelname)s] [%(name)s] %(message)s"
    datefmt: "%H:%M:%S"

filters:
  # Вставка кастомных полей (user, trace_id) для Zero Trust-а
  context_injector:
    (): security_core.logging.filters.ContextInjector
    defaults:
      user: "anonymous"
      trace_id: "none"
      span_id: "none"

handlers:
  console:
    class: logging.StreamHandler
    level: DEBUG
    formatter: console
    filters: [context_injector]
    stream: ext://sys.stdout

  file_info:
    class: logging.handlers.RotatingFileHandler
    level: INFO
    formatter: json
    filters: [context_injector]
    filename: logs/zero_trust_core_info.log
    maxBytes: 104857600   # 100MB
    backupCount: 10
    encoding: utf-8

  file_error:
    class: logging.handlers.RotatingFileHandler
    level: ERROR
    formatter: json
    filters: [context_injector]
    filename: logs/zero_trust_core_error.log
    maxBytes: 52428800    # 50MB
    backupCount: 20
    encoding: utf-8

  siem_export:
    class: logging.handlers.SysLogHandler
    level: WARNING
    formatter: json
    filters: [context_injector]
    address: ["127.0.0.1", 514]  # UDP/TCP syslog (может перенаправляться в SIEM/ELK)

  opentelemetry:
    class: opentelemetry.sdk._logs.LoggingHandler
    level: INFO
    formatter: json
    filters: [context_injector]

loggers:
  zero_trust:
    level: DEBUG
    handlers: [console, file_info, file_error, siem_export, opentelemetry]
    propagate: no

  security_core:
    level: INFO
    handlers: [console, file_info, siem_export]
    propagate: no

  audit:
    level: INFO
    handlers: [file_info, file_error, siem_export]
    propagate: no

root:
  level: WARNING
  handlers: [console]
