# observability/alerting/alert_rules.yaml

groups:
  - name: system-core.rules
    interval: 15s
    rules:
      - alert: NodeDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          team: infra
        annotations:
          summary: "Node {{ $labels.instance }} is down"
          description: "Prometheus target {{ $labels.job }} on {{ $labels.instance }} is unreachable for more than 1 minute."

      - alert: HighCPUUsage
        expr: 100 * (1 - avg by(instance)(rate(node_cpu_seconds_total{mode="idle"}[2m]))) > 90
        for: 2m
        labels:
          severity: warning
          component: os
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is over 90% for more than 2 minutes."

      - alert: HighMemoryUsage
        expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes < 0.1
        for: 2m
        labels:
          severity: warning
          component: memory
        annotations:
          summary: "Low available memory on {{ $labels.instance }}"
          description: "Less than 10% memory available."

  - name: zero-trust.security.rules
    interval: 30s
    rules:
      - alert: MultipleAccessViolations
        expr: increase(zero_trust_access_denied_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          policy: zero-trust
          scope: rbac
        annotations:
          summary: "Multiple access violations detected"
          description: "More than 10 access denials occurred in the last 5 minutes."

      - alert: SuspiciousTokenUsage
        expr: increase(zero_trust_token_anomaly_total[5m]) > 3
        for: 1m
        labels:
          severity: high
          ai_detected: true
          threat_level: TTP
        annotations:
          summary: "Anomalous session token usage"
          description: "Unusual pattern of token usage identified by AI-behavioral engine."

  - name: ai-agent.rules
    interval: 30s
    rules:
      - alert: AgentCrashLoop
        expr: increase(agent_restart_total[10m]) > 5
        for: 1m
        labels:
          severity: high
          subsystem: ai-agent
        annotations:
          summary: "Agent restart loop detected"
          description: "More than 5 restarts detected for AI-agent in 10 minutes window."

      - alert: PolicyDriftDetected
        expr: policy_drift_detected == 1
        for: 30s
        labels:
          severity: warning
          system: policy-engine
        annotations:
          summary: "Policy drift detected in enforcement layer"
          description: "Live policy deviation from the expected baseline."

  - name: observability.rules
    interval: 1m
    rules:
      - alert: AlertManagerDown
        expr: up{job="alertmanager"} == 0
        for: 1m
        labels:
          severity: critical
          team: devops
        annotations:
          summary: "Alertmanager instance down"
          description: "Alertmanager is unreachable or not responding."

      - alert: NoNewAlertsFiring
        expr: increase(alertmanager_alerts_firing_total[15m]) == 0
        for: 15m
        labels:
          severity: info
          team: devops
        annotations:
          summary: "No alerts fired in last 15 minutes"
          description: "Could indicate misconfiguration or silence period."

  - name: anomaly-detection.rules
    interval: 15s
    rules:
      - alert: AIAuditAnomalySpike
        expr: increase(ai_audit_anomalies_total[5m]) > 20
        for: 2m
        labels:
          severity: critical
          source: ai-auditor
          vector: behavior
        annotations:
          summary: "Spike in AI-detected audit anomalies"
          description: "More than 20 behavioral anomalies detected in the last 5 minutes."
