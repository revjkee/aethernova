# observability/alerting/alerting_rules.yaml

groups:
  - name: core-system.rules
    interval: 15s
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          component: infra
        annotations:
          summary: "Инстанс недоступен: {{ $labels.instance }}"
          description: "Сервис или узел не отвечает более 1 минуты."

      - alert: DiskFullIn4h
        expr: (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes) < 0.15
        for: 2m
        labels:
          severity: warning
          component: disk
        annotations:
          summary: "Диск почти заполнен на {{ $labels.instance }}"
          description: "Свободное место < 15% на диске {{ $labels.mountpoint }}."

      - alert: HighSystemLoad
        expr: node_load1 / count(count(node_cpu_seconds_total{mode="system"}) by (cpu)) > 1.5
        for: 3m
        labels:
          severity: warning
          component: cpu
        annotations:
          summary: "Высокая загрузка CPU на {{ $labels.instance }}"
          description: "1-минутная нагрузка превышает кол-во ядер."

  - name: platform-services.rules
    interval: 30s
    rules:
      - alert: APIServiceDown
        expr: up{job="platform-api"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "API платформа недоступна"
          description: "API-интерфейс платформы не отвечает более 1 минуты."

      - alert: SlowResponseRate
        expr: rate(http_request_duration_seconds_bucket{le="1"}[5m]) < 0.8
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Медленные ответы API"
          description: "Менее 80% HTTP-запросов укладываются в 1 секунду."

      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: high
          component: http
        annotations:
          summary: "Высокий уровень ошибок 5xx"
          description: "Более 5% всех HTTP-запросов завершаются ошибками сервера."

  - name: kubernetes.rules
    interval: 30s
    rules:
      - alert: KubePodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[5m]) > 0.2
        for: 1m
        labels:
          severity: high
          team: devops
        annotations:
          summary: "Контейнеры в CrashLoopBackOff"
          description: "Под (или контейнер) перезапускается слишком часто."

      - alert: NodeNotReady
        expr: kube_node_status_condition{condition="Ready", status="false"} == 1
        for: 2m
        labels:
          severity: critical
          team: devops
        annotations:
          summary: "K8s-нода не готова"
          description: "Одна из K8s-нод помечена как NotReady."

  - name: zero-trust.rules
    interval: 30s
    rules:
      - alert: ExcessiveAccessDenials
        expr: increase(zero_trust_access_denied_total[5m]) > 15
        for: 1m
        labels:
          severity: high
          type: rbac
        annotations:
          summary: "Много отказов в доступе (RBAC)"
          description: "Слишком много отказов в доступе по политике RBAC за последние 5 минут."

      - alert: TokenReplayDetected
        expr: increase(zero_trust_token_reuse_detected[10m]) > 2
        for: 1m
        labels:
          severity: critical
          scope: identity
        annotations:
          summary: "Обнаружено повторное использование токена"
          description: "AI или система подписей обнаружили потенциальную атаку повторного использования."

  - name: user-behavior.rules
    interval: 1m
    rules:
      - alert: AbnormalLoginPattern
        expr: increase(uba_login_anomaly_total[10m]) > 3
        for: 1m
        labels:
          severity: high
          class: behavior
        annotations:
          summary: "Аномальное поведение входа"
          description: "В системе зафиксировано несколько подозрительных входов."

      - alert: PrivilegeEscalationAttempt
        expr: increase(zero_trust_privilege_escalation_events[10m]) > 0
        for: 30s
        labels:
          severity: critical
          zone: escalation
        annotations:
          summary: "Попытка повышения привилегий"
          description: "Обнаружена попытка нарушить границу привилегий через RBAC/политику."

