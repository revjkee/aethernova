{{- /*
ServiceMonitor for security-core
- Создается только если включено .Values.monitoring.enabled и доступна CRD.
- Селектор по меткам сервисов (по умолчанию — security-core-metrics).
- Поддержка HTTP/HTTPS, mTLS, bearerTokenSecret, relabel/metricRelabel.
- Настройки через .Values.monitoring.*
*/ -}}
{{- if and .Values.monitoring.enabled (.Capabilities.APIVersions.Has "monitoring.coreos.com/v1") }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "security-core.fullname" . }}-metrics
  namespace: {{ default .Release.Namespace .Values.monitoring.namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ include "security-core.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/part-of: core-systems
    app.kubernetes.io/component: metrics
    helm.sh/chart: {{ include "security-core.chart" . }}
    {{- with .Values.global.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with .Values.monitoring.extraLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with .Values.monitoring.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  jobLabel: {{ default "app.kubernetes.io/name" .Values.monitoring.jobLabel | quote }}
  selector:
    matchLabels:
      {{- /* По умолчанию совпадает с сервисом security-core-metrics */}}
      {{- if .Values.monitoring.selector.matchLabels }}
      {{- toYaml .Values.monitoring.selector.matchLabels | nindent 6 }}
      {{- else }}
      app.kubernetes.io/name: {{ include "security-core.name" . }}
      app.kubernetes.io/component: api
      monitoring: "true"
      {{- end }}
  {{- if .Values.monitoring.selector.matchExpressions }}
  namespaceSelector:
    {{- /* Если задан matchNames — используем его, иначе наследуем namespace релиза */}}
    {{- if .Values.monitoring.namespaceSelector.matchNames }}
    matchNames:
      {{- toYaml .Values.monitoring.namespaceSelector.matchNames | nindent 6 }}
    {{- else }}
    matchNames:
      - {{ default .Release.Namespace .Values.monitoring.namespace | quote }}
    {{- end }}
  {{- else if .Values.monitoring.namespaceSelector }}
  namespaceSelector:
    {{- toYaml .Values.monitoring.namespaceSelector | nindent 4 }}
  {{- else }}
  namespaceSelector:
    matchNames:
      - {{ default .Release.Namespace .Values.monitoring.namespace | quote }}
  {{- end }}
  endpoints:
    - port: {{ default "metrics" .Values.monitoring.portName | quote }}
      {{- if .Values.monitoring.targetPort }}
      targetPort: {{ .Values.monitoring.targetPort }}
      {{- end }}
      scheme: {{ default "http" .Values.monitoring.scheme | quote }}
      path: {{ default "/metrics" .Values.monitoring.path | quote }}
      interval: {{ default "30s" .Values.monitoring.interval | quote }}
      scrapeTimeout: {{ default "10s" .Values.monitoring.scrapeTimeout | quote }}
      honorLabels: {{ default true .Values.monitoring.honorLabels }}
      honorTimestamps: {{ default true .Values.monitoring.honorTimestamps }}
      sampleLimit: {{ default 0 .Values.monitoring.sampleLimit }}
      labelLimit: {{ default 0 .Values.monitoring.labelLimit }}
      labelNameLengthLimit: {{ default 0 .Values.monitoring.labelNameLengthLimit }}
      labelValueLengthLimit: {{ default 0 .Values.monitoring.labelValueLengthLimit }}
      {{- if .Values.monitoring.proxyURL }}
      proxyUrl: {{ .Values.monitoring.proxyURL | quote }}
      {{- end }}

      {{- /* TLS / mTLS */}}
      {{- if .Values.monitoring.tls.enabled }}
      tlsConfig:
        insecureSkipVerify: {{ default false .Values.monitoring.tls.insecureSkipVerify }}
        {{- with .Values.monitoring.tls.minVersion }}
        minVersion: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.maxVersion }}
        maxVersion: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.serverName }}
        serverName: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.caFile }}
        caFile: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.ca }}
        ca:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .Values.monitoring.tls.certFile }}
        certFile: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.keyFile }}
        keyFile: {{ . | quote }}
        {{- end }}
        {{- with .Values.monitoring.tls.cert }}
        cert:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .Values.monitoring.tls.key }}
        keySecret:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}

      {{- /* Bearer / Authorization */}}
      {{- with .Values.monitoring.bearerTokenFile }}
      bearerTokenFile: {{ . | quote }}
      {{- end }}
      {{- with .Values.monitoring.bearerTokenSecret }}
      bearerTokenSecret:
        name: {{ .name | quote }}
        key: {{ .key | quote }}
        {{- if .optional }}
        optional: true
        {{- end }}
      {{- end }}
      {{- with .Values.monitoring.authorization }}
      authorization:
        type: {{ default "Bearer" .type | quote }}
        credentials:
          {{- toYaml .credentials | nindent 10 }}
      {{- end }}

      {{- /* Relabeling rules */}}
      {{- with .Values.monitoring.relabelings }}
      relabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.monitoring.metricRelabelings }}
      metricRelabelings:
        {{- toYaml . | nindent 8 }}
      {{- end }}

  {{- /* Дополнительные endpoints (например, для sidecar'ов) */}}
  {{- with .Values.monitoring.additionalEndpoints }}
  endpoints:
    {{- range . }}
    - port: {{ default "metrics" .portName | quote }}
      {{- if .targetPort }}
      targetPort: {{ .targetPort }}
      {{- end }}
      scheme: {{ default "http" .scheme | quote }}
      path: {{ default "/metrics" .path | quote }}
      interval: {{ default "30s" .interval | quote }}
      scrapeTimeout: {{ default "10s" .scrapeTimeout | quote }}
      honorLabels: {{ default true .honorLabels }}
      honorTimestamps: {{ default true .honorTimestamps }}
      {{- if .tls }}
      tlsConfig:
        {{- toYaml .tls | nindent 8 }}
      {{- end }}
      {{- if .bearerTokenSecret }}
      bearerTokenSecret:
        {{- toYaml .bearerTokenSecret | nindent 8 }}
      {{- end }}
      {{- if .relabelings }}
      relabelings:
        {{- toYaml .relabelings | nindent 8 }}
      {{- end }}
      {{- if .metricRelabelings }}
      metricRelabelings:
        {{- toYaml .metricRelabelings | nindent 8 }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{- /* Проброс targetLabels в серию */}}
  {{- with .Values.monitoring.targetLabels }}
  targetLabels:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- /* Endpoints из podMonitorSelectorLabel? Оставлено под дальнейшее расширение */}}
{{- else }}
{{- /* ServiceMonitor CRD недоступна или monitoring.enabled=false — манифест не создается */ -}}
{{- end }}
