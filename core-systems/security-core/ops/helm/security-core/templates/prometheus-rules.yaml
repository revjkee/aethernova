{{- if .Values.monitoring.prometheusRules.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "security-core.fullname" . }}-rules
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "security-core.labels" . | nindent 4 }}
    app.kubernetes.io/component: security-core
    app.kubernetes.io/part-of: core-systems
    prometheus: {{ default "k8s" .Values.monitoring.prometheusRules.prometheusInstance | quote }}
    role: alert-rules
  annotations:
    kubernetes.io/description: "Prometheus recording/alerting rules for security-core (prod-grade)"
spec:
  groups:
    # =========================
    # Recording rules (аггрегаты)
    # =========================
    - name: security-core.recording
      rules:
        # CPU usage / requests (ratio 0..1) по Поду-пулу приложения
        - record: security_core:cpu_usage_requests:ratio
          expr: |
            sum(
              rate(container_cpu_usage_seconds_total{
                namespace="{{ .Release.Namespace }}",
                pod=~"{{ include "security-core.fullname" . }}.*",
                container!="",image!=""}[5m])
            )
            /
            sum(
              kube_pod_container_resource_requests{
                namespace="{{ .Release.Namespace }}",
               
