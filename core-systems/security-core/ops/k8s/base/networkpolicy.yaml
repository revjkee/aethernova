# -----------------------------------------------------------------------------
# Aethernova / security-core — Kubernetes NetworkPolicy (base)
# Профиль: Zero‑Trust Baseline
# Назначение: 1) Полный запрет Ingress/Egress для всех Pod'ов в namespace.
#             2) Разрешение только DNS‑egress к CoreDNS (kube-system), TCP/UDP:53.
# Любые иные разрешения (ingress от ingress‑контроллера, egress в интернет,
# сервис‑кластера, API‑сервер, репозитории и т.п.) должны настраиваться
# отдельными overlay‑политиками и НЕ входят в base.
# -----------------------------------------------------------------------------

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: security-core-default-deny-all
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/part-of: security-core
    app.kubernetes.io/component: baseline
    security.aethernova.io/profile: baseline
  annotations:
    description: "Полный запрет входящего и исходящего трафика для всех Pod'ов в namespace."
spec:
  podSelector: {}  # применимо ко всем Pod'ам в текущем namespace
  policyTypes:
    - Ingress
    - Egress
  # Отсутствие правил Ingress/Egress при указанных policyTypes эквивалентно deny-all.

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: security-core-allow-dns-egress
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/part-of: security-core
    app.kubernetes.io/component: baseline
    security.aethernova.io/profile: baseline
  annotations:
    description: "Точечное разрешение egress к CoreDNS (TCP/UDP 53) в namespace kube-system."
spec:
  podSelector: {}  # разрешение для всех Pod'ов текущего namespace
  policyTypes:
    - Egress
  egress:
    # Вариант 1: максимально точное правило — namespace kube-system И Pod'ы CoreDNS.
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchExpressions:
              - key: k8s-app
                operator: In
                values:
                  - kube-dns
                  - coredns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Вариант 2: резервное (на случай иных меток CoreDNS у дистрибутивов).
    # Оставляет namespace-границу kube-system, но не полагается на конкретные Pod‑метки.
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# -----------------------------------------------------------------------------
# Примечания (важно прочитать перед применением):
# 1) Liveness/Readiness‑пробы: при default‑deny Ingress пробы от kubelet могут
#    блокироваться в некоторых CNI. Рекомендуется создавать per‑app политики
#    с явным разрешением нужных портов/источников.
# 2) Данный base намеренно НЕ открывает HTTP/HTTPS наружу, доступ к API‑серверу,
#    сервисам кластера и иные egress/ingress. Это добавляется оверлеями под
#    конкретные приложения/пространства имён.
# 3) Политики namespace‑scoped. Применяйте в каждом namespace, где требуется
#    Zero‑Trust baseline.
# -----------------------------------------------------------------------------
