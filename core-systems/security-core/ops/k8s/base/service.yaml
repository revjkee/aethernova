# =============================================================================
# security-core :: Kubernetes Services (base)
# - ClusterIP только для внутреннего трафика
# - Отдельный сервис для метрик (Prometheus/ServiceMonitor)
# - Без фиксированного namespace (назначается на слое Kustomize/Helm)
# =============================================================================

---
apiVersion: v1
kind: Service
metadata:
  name: security-core
  labels:
    app.kubernetes.io/name: security-core
    app.kubernetes.io/instance: security-core
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: core-systems
    app.kubernetes.io/managed-by: kustomize
    # Версию намеренно не фиксируем здесь, чтобы не триггерить лишние rollout'ы
  annotations:
    # Подсказки для балансировки в пределах зоны (в линейках 1.24+)
    service.kubernetes.io/topology-aware-hints: "auto"
spec:
  type: ClusterIP
  # Предпочтительно dual-stack, если кластер поддерживает
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  publishNotReadyAddresses: false
  selector:
    app.kubernetes.io/name: security-core
    app.kubernetes.io/component: api
  ports:
    - name: http
      port: 8080           # Внутренний порт сервиса
      targetPort: 8080     # Контейнерный порт приложения
      protocol: TCP
      appProtocol: http
  # Если у приложения есть HTTPS или gRPC — добавьте порты ниже:
  #  - name: https
  #    port: 8443
  #    targetPort: 8443
  #    protocol: TCP
  #    appProtocol: https
  #  - name: grpc
  #    port: 9095
  #    targetPort: 9095
  #    protocol: TCP
  #    appProtocol: grpc

---
apiVersion: v1
kind: Service
metadata:
  name: security-core-metrics
  labels:
    app.kubernetes.io/name: security-core
    app.kubernetes.io/instance: security-core
    app.kubernetes.io/component: metrics
    app.kubernetes.io/part-of: core-systems
    app.kubernetes.io/managed-by: kustomize
    monitoring: "true"
  annotations:
    # Аннотации для классического prometheus.io‑scrape
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
    - IPv4
    - IPv6
  internalTrafficPolicy: Cluster
  sessionAffinity: None
  selector:
    app.kubernetes.io/name: security-core
    app.kubernetes.io/component: api
  ports:
    - name: metrics
      port: 9090          # Внутренний порт сервиса метрик
      targetPort: 9090    # Контейнерный порт экспорта метрик
      protocol: TCP
      appProtocol: http
