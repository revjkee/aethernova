<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Security Admin Minimal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

  <!-- Content Security Policy.
       Для реального продакшена предпочтительно ставить заголовок CSP с nonce/sha256.
       Здесь используется строгая политика с ограничениями для self и connect-src. -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'none';
          base-uri 'none';
          form-action 'none';
          frame-ancestors 'none';
          img-src 'self' data:;
          style-src 'self';
          connect-src 'self' http: https:;
          script-src 'self';
          upgrade-insecure-requests;
        ">

  <meta name="referrer" content="no-referrer">
  <meta name="color-scheme" content="light dark">

  <style>
    :root {
      --bg: #0b0f14;
      --panel: #101720;
      --muted: #8892a6;
      --text: #e6edf3;
      --accent: #52a8ff;
      --good: #18b26b;
      --warn: #e0a800;
      --bad: #e55353;
      --border: #213042;
      --focus: #86b7fe;
      --code: #0c131b;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f6f8fa; --panel:#ffffff; --muted:#536171; --text:#0b1220; --accent:#0b6bfd;
        --good:#0a8f55; --warn:#b58900; --bad:#c1121f; --border:#e0e7ef; --focus:#86b7fe; --code:#f2f6fb;
      }
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text);
    }
    header {
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(82,168,255,.08), transparent 60%), var(--panel);
      position: sticky; top: 0; z-index: 10;
    }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 16px }
    h1 { font-size: 20px; margin: 0 0 4px 0 }
    .subtitle { color: var(--muted); font-size: 12px }
    .grid { display: grid; grid-template-columns: 280px 1fr; gap: 16px; align-items: start }
    .card {
      background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .card h2 { font-size: 16px; margin: 4px 0 8px }
    label { display: block; margin: 8px 0 4px; color: var(--muted) }
    input[type="text"], input[type="password"], input[type="url"], textarea, select {
      width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text);
      outline: none;
    }
    textarea { min-height: 92px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    input:focus, textarea:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(134,183,254,.25) }
    .row { display: flex; gap: 8px; align-items: center }
    .btn {
      display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: var(--panel);
      color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; text-decoration: none; user-select: none;
    }
    .btn:hover { border-color: var(--accent) }
    .btn.primary { background: linear-gradient(180deg, rgba(82,168,255,.18), rgba(82,168,255,.06)); border-color: rgba(82,168,255,.45) }
    .btn.good { border-color: rgba(24,178,107,.5); background: linear-gradient(180deg, rgba(24,178,107,.16), rgba(24,178,107,.05)) }
    .btn.warn { border-color: rgba(224,168,0,.5); background: linear-gradient(180deg, rgba(224,168,0,.16), rgba(224,168,0,.05)) }
    .btn.bad { border-color: rgba(229,83,83,.5); background: linear-gradient(180deg, rgba(229,83,83,.16), rgba(229,83,83,.05)) }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap }
    .tab { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; background: var(--panel) }
    .tab[aria-selected="true"] { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(82,168,255,.15) inset }
    .muted { color: var(--muted) }
    pre {
      background: var(--code); border: 1px solid var(--border); border-radius: 10px; padding: 10px; overflow: auto;
      max-height: 360px; white-space: pre-wrap; word-break: break-word;
    }
    .kvs { display: grid; grid-template-columns: 160px 1fr; gap: 8px; }
    .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px }
    .ok { background: var(--good) } .warnc { background: var(--warn) } .badc { background: var(--bad) }
    .small { font-size: 12px }
    .spacer { height: 8px }
    .hidden { display: none !important }
    footer { color: var(--muted); font-size: 12px; padding: 12px 0 }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Security Admin Minimal</h1>
    <div class="subtitle">Локальный административный интерфейс для операций над security‑core</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Settings -->
    <section class="card" aria-labelledby="settings-title">
      <h2 id="settings-title">Настройки клиента</h2>
      <label for="apiBase">API Base URL</label>
      <input id="apiBase" type="url" placeholder="http://localhost:8080" autocomplete="off" spellcheck="false">

      <label for="authKind">Авторизация</label>
      <select id="authKind" aria-label="auth kind">
        <option value="none">Без заголовка Authorization</option>
        <option value="bearer">Bearer токен</option>
        <option value="apikey">API Key (заголовок X-API-Key)</option>
        <option value="basic">Basic (user:pass)</option>
      </select>

      <label for="authToken">Значение (токен или user:pass)</label>
      <input id="authToken" type="text" placeholder="введите токен или user:pass">

      <label for="extraHeaders">Доп. заголовки (JSON-объект)</label>
      <textarea id="extraHeaders" placeholder='{"X-Request-Id":"..."}'></textarea>

      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="saveCfg">Сохранить</button>
        <button class="btn" id="clearCfg">Сброс</button>
        <span class="muted small" id="cfgState" role="status" aria-live="polite"></span>
      </div>

      <div class="spacer"></div>
      <div class="kvs small">
        <div>Последний запрос:</div><div id="lastReqInfo" class="muted">—</div>
        <div>curl:</div><div><pre id="curlOut">—</pre></div>
      </div>
    </section>

    <!-- Work area -->
    <section class="card">
      <div class="tabs" role="tablist" aria-label="Разделы">
        <button class="tab" role="tab" aria-selected="true" data-tab="overview">Overview</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="authz">AuthZ Check</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="inhibitor">Self‑Inhibitor</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="policy">Policy Info</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="audit">Audit Stats</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="jwks">JWKS</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="raw">Raw Request</button>
      </div>

      <!-- Overview -->
      <div class="spacer"></div>
      <section id="panel-overview" role="tabpanel">
        <div class="row">
          <button class="btn primary" id="btnHealth">Проверить Health</button>
          <button class="btn" id="btnConfig">Получить конфиг (sanitized)</button>
          <button class="btn warn" id="btnReload">Горячая перезагрузка настроек</button>
        </div>
        <div class="spacer"></div>
        <div class="kvs">
          <div>Health:</div><div id="healthDot"><span class="status-dot badc"></span><span class="muted small">нет данных</span></div>
          <div>Hash конфигурации:</div><div id="cfgHash" class="muted">—</div>
          <div>OPA URL:</div><div id="opaUrl" class="muted">—</div>
          <div>Policy path:</div><div id="policyPath" class="muted">—</div>
        </div>
        <div class="spacer"></div>
        <pre id="overviewOut">—</pre>
      </section>

      <!-- AuthZ -->
      <section id="panel-authz" class="hidden" role="tabpanel">
        <h2>Проверка авторизации (RBAC/ABAC)</h2>
        <div class="row">
          <div style="flex:1">
            <label>subject</label>
            <input id="authzSubject" type="text" placeholder="user:42">
          </div>
          <div style="flex:1">
            <label>roles (через запятую)</label>
            <input id="authzRoles" type="text" placeholder="developer,viewer">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>tenant</label>
            <input id="authzTenant" type="text" placeholder="t1">
          </div>
          <div style="flex:1">
            <label>env</label>
            <input id="authzEnv" type="text" placeholder="prod">
          </div>
          <div style="flex:1">
            <label>ip</label>
            <input id="authzIp" type="text" placeholder="203.0.113.5">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>resource_id</label>
            <input id="authzResource" type="text" placeholder="service:billing">
          </div>
          <div style="flex:1">
            <label>action</label>
            <input id="authzAction" type="text" placeholder="read">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="btnAuthzCheck">Проверить</button>
          <label class="small row"><input id="authzExplain" type="checkbox"> explain</label>
          <span class="muted small">Путь API:</span>
          <input id="authzPath" type="text" value="/v1/authz/check" style="max-width:220px">
        </div>
        <div class="spacer"></div>
        <pre id="authzOut">—</pre>
      </section>

      <!-- Inhibitor -->
      <section id="panel-inhibitor" class="hidden" role="tabpanel">
        <h2>Self‑Inhibitor</h2>
        <div class="row">
          <button class="btn" id="btnInhStatus">Статус</button>
          <button class="btn warn" id="btnInhArm">ARM</button>
          <button class="btn bad" id="btnInhTrigger">TRIGGER</button>
          <button class="btn good" id="btnInhDisarm">DISARM</button>
          <span class="muted small">Пути:</span>
          <input id="inhStatusPath" type="text" value="/v1/inhibitor/status" style="max-width:170px">
          <input id="inhCmdPath" type="text" value="/v1/inhibitor/cmd" style="max-width:170px">
        </div>
        <div class="row">
          <div style="flex:1">
            <label>admin_secret (опционально; добавится как заголовок X-Admin-Secret)</label>
            <input id="inhSecret" type="password" placeholder="секрет">
          </div>
          <div style="flex:1">
            <label>nonce (опционально)</label>
            <input id="inhNonce" type="text" placeholder="">
          </div>
        </div>
        <div class="spacer"></div>
        <pre id="inhOut">—</pre>
      </section>

      <!-- Policy -->
      <section id="panel-policy" class="hidden" role="tabpanel">
        <h2>Policy Info</h2>
        <div class="row">
          <button class="btn" id="btnPolicyInfo">Получить информацию</button>
          <span class="muted small">Путь API:</span>
          <input id="policyInfoPath" type="text" value="/v1/policy/info" style="max-width:220px">
        </div>
        <div class="spacer"></div>
        <pre id="policyOut">—</pre>
      </section>

      <!-- Audit -->
      <section id="panel-audit" class="hidden" role="tabpanel">
        <h2>Audit Exporter Stats</h2>
        <div class="row">
          <button class="btn" id="btnAuditStats">Получить статистику</button>
          <span class="muted small">Путь API:</span>
          <input id="auditStatsPath" type="text" value="/v1/audit/stats" style="max-width:220px">
        </div>
        <div class="spacer"></div>
        <pre id="auditOut">—</pre>
      </section>

      <!-- JWKS -->
      <section id="panel-jwks" class="hidden" role="tabpanel">
        <h2>JWKS</h2>
        <div class="row">
          <button class="btn" id="btnJWKS">Загрузить JWKS</button>
          <span class="muted small">Путь:</span>
          <input id="jwksPath" type="text" value="/.well-known/jwks.json" style="max-width:260px">
        </div>
        <div class="spacer"></div>
        <pre id="jwksOut">—</pre>
      </section>

      <!-- RAW -->
      <section id="panel-raw" class="hidden" role="tabpanel">
        <h2>Raw Request</h2>
        <div class="row">
          <select id="rawMethod">
            <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option>
          </select>
          <input id="rawPath" type="text" placeholder="/v1/health" value="/v1/health" style="flex:1">
          <button class="btn primary" id="btnRawSend">Отправить</button>
        </div>
        <label for="rawBody">Тело запроса (JSON)</label>
        <textarea id="rawBody" placeholder='{"example":true}'></textarea>
        <div class="spacer"></div>
        <pre id="rawOut">—</pre>
      </section>
    </section>
  </div>

  <footer>
    Сделано для security‑core. Логи запросов/ответов не отправляются наружу.
  </footer>
</main>

<script>
(() => {
  "use strict";

  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const state = {
    cfg: {
      apiBase: "http://localhost:8080",
      authKind: "none",
      authToken: "",
      extraHeaders: {}
    },
    last: { method:"", url:"", status: "", curl:"" }
  };

  const saveCfg = () => {
    try {
      const cfg = {
        apiBase: $("apiBase").value.trim(),
        authKind: $("authKind").value,
        authToken: $("authToken").value,
        extraHeaders: safeParseJSON($("extraHeaders").value.trim() || "{}")
      };
      localStorage.setItem("security_admin_cfg", JSON.stringify(cfg));
      state.cfg = cfg;
      setStatus("cfgState", "Сохранено");
      updateCurl();
    } catch (e) {
      setStatus("cfgState", "Ошибка сохранения");
    }
  };

  const loadCfg = () => {
    try {
      const raw = localStorage.getItem("security_admin_cfg");
      if (raw) state.cfg = { ...state.cfg, ...JSON.parse(raw) };
    } catch {}
    $("apiBase").value = state.cfg.apiBase;
    $("authKind").value = state.cfg.authKind;
    $("authToken").value = state.cfg.authToken;
    $("extraHeaders").value = JSON.stringify(state.cfg.extraHeaders || {}, null, 2);
    updateCurl();
  };

  const clearCfg = () => {
    localStorage.removeItem("security_admin_cfg");
    loadCfg();
    setStatus("cfgState", "Сброшено");
  };

  const setStatus = (id, msg) => {
    const el = $(id);
    el.textContent = msg;
    setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 2000);
  };

  const safeParseJSON = (s) => {
    try { return JSON.parse(s); } catch { return {}; }
  };

  const pretty = (obj) => {
    try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
  };

  const esc = (s) => {
    return String(s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
  };

  const buildURL = (path) => {
    const base = state.cfg.apiBase.replace(/\/+$/,"");
    const p = path.startsWith("/") ? path : "/"+path;
    return base + p;
  };

  function buildHeaders() {
    const h = Object.assign({ "Accept":"application/json" }, state.cfg.extraHeaders || {});
    if (state.cfg.authKind === "bearer" && state.cfg.authToken) h["Authorization"] = "Bearer " + state.cfg.authToken;
    else if (state.cfg.authKind === "apikey" && state.cfg.authToken) h["X-API-Key"] = state.cfg.authToken;
    else if (state.cfg.authKind === "basic" && state.cfg.authToken) h["Authorization"] = "Basic " + btoa(state.cfg.authToken);
    return h;
  }

  async function request(method, path, bodyObj) {
    const url = buildURL(path);
    const ctrl = new AbortController();
    const to = setTimeout(()=>ctrl.abort(), 15000);
    const headers = buildHeaders();
    let body = undefined;
    if (bodyObj !== undefined) {
      headers["Content-Type"] = "application/json";
      body = JSON.stringify(bodyObj);
    }
    const started = Date.now();
    try {
      const res = await fetch(url, { method, headers, body, signal: ctrl.signal, cache: "no-store", credentials: "omit" });
      const ct = res.headers.get("content-type") || "";
      let data;
      if (ct.includes("json")) {
        data = await res.json();
      } else {
        data = await res.text();
      }
      state.last = {
        method, url, status: res.status + " " + res.statusText,
        curl: buildCurl(method, url, headers, body)
      };
      $("lastReqInfo").textContent = `${method} ${url} — ${state.last.status} (${Date.now()-started}ms)`;
      updateCurl();
      if (!res.ok) {
        throw { status: res.status, data };
      }
      return data;
    } finally {
      clearTimeout(to);
    }
  }

  function buildCurl(method, url, headers, body) {
    const hParts = Object.entries(headers).map(([k,v]) => `-H ${shellQuote(k + ": " + v)}`).join(" ");
    const dPart = body ? `--data ${shellQuote(body)}` : "";
    return `curl -sS -X ${method} ${hParts} ${dPart} ${shellQuote(url)}`;
  }

  function shellQuote(s) {
    if (s === undefined || s === null) return "''";
    s = String(s);
    if (!/[\s"'\\$]/.test(s)) return `'${s.replace(/'/g,"'\\''")}'`; // keep single quotes wrapping
    return `'${s.replace(/'/g,"'\\''")}'`;
  }

  function setJson(el, data) {
    el.textContent = pretty(data);
  }

  function setStatusDot(id, kind, text) {
    const el = $(id);
    const dotClass = kind === "ok" ? "ok" : kind === "warn" ? "warnc" : "badc";
    el.innerHTML = `<span class="status-dot ${dotClass}"></span><span class="small">${esc(text || "")}</span>`;
  }

  function updateCurl() {
    $("curlOut").textContent = state.last.curl || "—";
  }

  // ---------- Tabs ----------
  function initTabs() {
    const tabs = qsa(".tab");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.setAttribute("aria-selected", "false"));
      t.setAttribute("aria-selected", "true");
      const key = t.dataset.tab;
      qsa('[role="tabpanel"]').forEach(p => p.classList.add("hidden"));
      $("panel-"+key).classList.remove("hidden");
    }));
  }

  // ---------- Overview handlers ----------
  $("btnHealth").addEventListener("click", async () => {
    try {
      const data = await request("GET", "/v1/health");
      setJson($("overviewOut"), data);
      setStatusDot("healthDot", "ok", "OK");
    } catch (e) {
      setJson($("overviewOut"), e.data || e);
      setStatusDot("healthDot", "bad", "Ошибка");
    }
  });

  $("btnConfig").addEventListener("click", async () => {
    try {
      const data = await request("GET", "/v1/settings"); // ожидается sanitized конфиг
      setJson($("overviewOut"), data);
      $("cfgHash").textContent = data?._hash || data?.hash || "—";
      $("opaUrl").textContent = data?.opa?.url || "—";
      $("policyPath").textContent = data?.policy?.path || "—";
    } catch (e) {
      setJson($("overviewOut"), e.data || e);
    }
  });

  $("btnReload").addEventListener("click", async () => {
    if (!confirm("Выполнить горячую перезагрузку настроек?")) return;
    try {
      const data = await request("POST", "/v1/reload");
      setJson($("overviewOut"), data);
    } catch (e) {
      setJson($("overviewOut"), e.data || e);
    }
  });

  // ---------- AuthZ ----------
  $("btnAuthzCheck").addEventListener("click", async () => {
    const subj = $("authzSubject").value.trim();
    const roles = $("authzRoles").value.split(",").map(s=>s.trim()).filter(Boolean);
    const body = {
      subject: subj || undefined,
      roles,
      tenant: $("authzTenant").value.trim() || undefined,
      env: $("authzEnv").value.trim() || undefined,
      ip: $("authzIp").value.trim() || undefined,
      resource_id: $("authzResource").value.trim(),
      action: $("authzAction").value.trim(),
      explain: $("authzExplain").checked
    };
    const path = $("authzPath").value.trim() || "/v1/authz/check";
    try {
      const data = await request("POST", path, body);
      setJson($("authzOut"), data);
    } catch (e) {
      setJson($("authzOut"), e.data || e);
    }
  });

  // ---------- Inhibitor ----------
  $("btnInhStatus").addEventListener("click", async () => {
    try {
      const data = await request("GET", $("inhStatusPath").value.trim());
      setJson($("inhOut"), data);
    } catch (e) {
      setJson($("inhOut"), e.data || e);
    }
  });

  async function inhibitorCmd(cmd) {
    const path = $("inhCmdPath").value.trim();
    const headersBak = { ...state.cfg.extraHeaders };
    const secret = $("inhSecret").value;
    const nonce = $("inhNonce").value;
    if (secret) state.cfg.extraHeaders["X-Admin-Secret"] = secret;
    if (nonce) state.cfg.extraHeaders["X-Nonce"] = nonce;
    try {
      const data = await request("POST", path, { cmd });
      setJson($("inhOut"), data);
    } catch (e) {
      setJson($("inhOut"), e.data || e);
    } finally {
      state.cfg.extraHeaders = headersBak; // restore
      $("extraHeaders").value = JSON.stringify(state.cfg.extraHeaders, null, 2);
    }
  }

  $("btnInhArm").addEventListener("click", () => inhibitorCmd("ARM"));
  $("btnInhTrigger").addEventListener("click", () => inhibitorCmd("TRIGGER"));
  $("btnInhDisarm").addEventListener("click", () => inhibitorCmd("DISARM"));

  // ---------- Policy ----------
  $("btnPolicyInfo").addEventListener("click", async () => {
    try {
      const data = await request("GET", $("policyInfoPath").value.trim());
      setJson($("policyOut"), data);
    } catch (e) {
      setJson($("policyOut"), e.data || e);
    }
  });

  // ---------- Audit ----------
  $("btnAuditStats").addEventListener("click", async () => {
    try {
      const data = await request("GET", $("auditStatsPath").value.trim());
      setJson($("auditOut"), data);
    } catch (e) {
      setJson($("auditOut"), e.data || e);
    }
  });

  // ---------- JWKS ----------
  $("btnJWKS").addEventListener("click", async () => {
    try {
      const data = await request("GET", $("jwksPath").value.trim());
      setJson($("jwksOut"), data);
    } catch (e) {
      setJson($("jwksOut"), e.data || e);
    }
  });

  // ---------- RAW ----------
  $("btnRawSend").addEventListener("click", async () => {
    const method = $("rawMethod").value;
    const path = $("rawPath").value.trim();
    let body = $("rawBody").value.trim();
    let obj = undefined;
    if (body) {
      try { obj = JSON.parse(body); } catch (e) { alert("Некорректный JSON тела запроса"); return; }
    }
    try {
      const data = await request(method, path, obj);
      setJson($("rawOut"), data);
    } catch (e) {
      setJson($("rawOut"), e.data || e);
    }
  });

  // ---------- Settings UI ----------
  $("saveCfg").addEventListener("click", saveCfg);
  $("clearCfg").addEventListener("click", clearCfg);

  // ---------- Init ----------
  initTabs();
  loadCfg();
})();
</script>
</body>
</html>
