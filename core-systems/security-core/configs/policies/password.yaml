version: "1.0"
meta:
  owner: "platform-security"
  system: "core-systems/security-core"
  description: "Политика паролей и параметры проверки/хранения"
  lastReviewedAt: "2025-08-19"
  compliance:
    fips140_required: true
    iso27001_controls: ["A.8.2.3", "A.9.2.4", "A.9.4.3"]
    gdpr_regions: ["eu-north-1", "eu-central-1"]
  changeControl:
    require_approval: true
    approvers_groups: ["secops-leads", "iam-owners"]
    m_of_n: "2-of-3"

defaults:
  environment: "prod"
  enforcement_mode: "enforce" # shadow | canary | enforce
  fips_mode: true
  hash_storage:
    # В FIPS: PBKDF2-SHA256; вне FIPS: Argon2id
    fips:
      kdf: "PBKDF2-SHA256"
      params:
        iterations: 210000
        salt_len: 16
        tag_len: 32
    non_fips:
      kdf: "Argon2id"
      params:
        memory_mib: 192
        iterations: 3
        parallelism: 2
        salt_len: 16
        tag_len: 32
    pepper:
      enabled: true
      source: "kms://alias/security-core/pepper"
      rotation_days: 90
  breach_check:
    enabled: true
    method: "hibp-k-anonymity" # без передачи полного хеша
    min_prefix: 5
    timeout_ms: 1200
    allow_offline_cache_days: 2
    deny_on_service_unavailable: true
  zxcvbn:
    enabled: true
    min_score: 3 # от 0 до 4
    user_fields_considered: ["username", "email", "displayName", "tenant"]
  entropy_bits:
    min_effective_bits: 45 # оценка после нормализации
  character_sets:
    require_sets:
      upper: 1
      lower: 1
      digits: 1
      symbols: 1
    allowed_symbol_classes: "!@#$%^&*()-_=+[]{};:,./?~"
  length:
    min: 12
    max: 128
  forbidden:
    # Запрещенные подстроки и шаблоны
    substrings:
      - "{{username}}"
      - "{{email_localpart}}"
      - "{{tenant}}"
      - "password"
      - "qwerty"
      - "admin"
    patterns:
      repeated_chars: { max_repeat: 3 }         # не более 3 одинаковых подряд
      keyboard_sequences: { enabled: true }     # qwerty, 12345 и т.д.
      date_patterns: { enabled: true }          # YYYYMMDD, DDMMYYYY
      palindromes: { enabled: true, min_len: 6 }
  rotation:
    enabled: true
    max_age_days: 365
    min_age_hours: 24
    history_remember: 10
    notify_before_days: 14
    stagger_percent: 20
  lockout:
    threshold_failures: 10
    window_minutes: 15
    lock_minutes: 15
    progressive_backoff:
      enabled: true
      base_seconds: 2
      max_seconds: 64
    captcha_after_failures: 5
    notify_user_after_lock: true
  mfa:
    required_for_admins: true
    required_for_sensitive_paths: true
    disallow_sms_for_admins: true
    allowed_methods: ["webauthn", "totp", "push"]
    step_up_triggers:
      - geo_anomaly
      - ip_reputation
      - device_new
      - time_of_day_anomaly
  passwordless:
    webauthn_preferred: true
    allow_passwordless_for_admins: true
    allow_passwordless_for_users: true
  messaging:
    # Сообщения пользователю при нарушении правил (локализуются на уровне приложения)
    too_short: "Пароль слишком короткий"
    too_weak: "Пароль недостаточно сложный"
    breached: "Этот пароль обнаружен в утечках"
    forbidden_substring: "Пароль содержит запрещенные подстроки"
    zxcvbn_low: "Пароль легко угадывается"
    entropy_low: "Энтропия пароля недостаточна"
    reuse_detected: "Нельзя использовать последние пароли"
    rotation_due: "Срок действия пароля истек"
  audit:
    enabled: true
    sink: "stdout-jsonl"
    redact_passwords: true
    fields:
      - ts
      - user
      - event
      - policy_profile
      - result
      - reason
      - client_ip
      - request_id
  recovery:
    # Восстановление и сброс
    token_ttl_minutes: 15
    channel: ["email", "webauthn-passkey-recovery"]
    rate_limit_per_hour: 3
    require_recent_mfa_for_admins_minutes: 60
    security_questions_allowed: false

profiles:
  # Профили строгих правил для разных типов учеток
  user_standard:
    inherits: default
    length: { min: 12, max: 128 }
    zxcvbn: { min_score: 3 }
    entropy_bits: { min_effective_bits: 45 }
    rotation: { max_age_days: 365, history_remember: 10 }
    lockout: { threshold_failures: 10, lock_minutes: 15 }
  admin_high:
    inherits: default
    length: { min: 16, max: 128 }
    zxcvbn: { min_score: 4 }
    entropy_bits: { min_effective_bits: 55 }
    character_sets:
      require_sets: { upper: 1, lower: 1, digits: 1, symbols: 1 }
    rotation: { max_age_days: 180, history_remember: 20 }
    lockout: { threshold_failures: 6, lock_minutes: 30 }
    mfa:
      required_for_admins: true
      allowed_methods: ["webauthn", "totp", "push"]
  service_account:
    # Для нефедеративных сервисных учеток, если пароли неизбежны
    length: { min: 32, max: 128 }
    zxcvbn: { enabled: false }
    entropy_bits: { min_effective_bits: 80 }
    character_sets:
      require_sets: { upper: 1, lower: 1, digits: 1, symbols: 1 }
    rotation: { max_age_days: 180, history_remember: 24 }
    lockout:
      threshold_failures: 20
      lock_minutes: 10
    constraints:
      interactive_login_forbidden: true
      storage: "vault://kv/security-core/service-accounts"
  break_glass:
    # Аварийные учетки по процедуре 2-of-3
    length: { min: 20, max: 128 }
    entropy_bits: { min_effective_bits: 75 }
    zxcvbn: { min_score: 4 }
    rotation: { max_age_days: 90, history_remember: 24 }
    mfa:
      required_for_admins: false
    governance:
      checkout_max_minutes: 60
      dual_control: "2-of-3"
      sealed_storage: "hsm://sealed/escrow"

validators:
  order:
    - length
    - forbidden
    - character_sets
    - entropy_bits
    - zxcvbn
    - breach_check
    - history
  thresholds:
    # Общие предельные параметры валидатора
    max_runtime_ms: 800
    max_remote_calls: 1
  normalization:
    unicode_nfkc: true
    trim_spaces: true
    collapse_spaces: true
  history:
    backend: "kms://alias/security-core/password-history"
    hash_scheme: "per-policy-kdf" # совпадает с hash_storage

storage:
  # Политика хранения хэшей паролей
  kdf_policy: "defaults.hash_storage"
  salt_encoding: "base64"
  pepper_handling:
    get_via_kms_each_start: true
    cache_ttl_minutes: 60
    zeroize_on_shutdown: true
  migration:
    # Позволяет фоновой миграции хэшей в актуальный KDF
    enabled: true
    batch_size: 500
    rate_limit_qps: 50

operations:
  # Операционные политики применения
  pre_auth_checks:
    ip_reputation: true
    geo_check: true
    device_fingerprint: true
  post_auth_actions:
    write_login_audit: true
    rotate_weak_password_on_login: true
    notify_on_breach_match: true
  siem:
    export_format: "ECS-1.12"
    min_severity_to_export: "warning"

scope:
  # Привязка профилей к группам/ролям/путям
  bindings:
    - match:
        roles: ["admin", "platform-security"]
      profile: "admin_high"
    - match:
        roles: ["service-account"]
      profile: "service_account"
    - match:
        roles: ["break-glass"]
      profile: "break_glass"
    - match:
        any_user: true
      profile: "user_standard"

overrides:
  dev:
    enforcement_mode: "shadow"
    fips_mode: false
    zxcvbn: { min_score: 2 }
    breach_check: { enabled: true, deny_on_service_unavailable: false }
    rotation: { max_age_days: 99999 }
    audit: { sink: "stdout-jsonl", enabled: true }
  staging:
    enforcement_mode: "canary"
    fips_mode: true
    rotation: { max_age_days: 365 }
    audit: { enabled: true }
  prod:
    enforcement_mode: "enforce"
    fips_mode: true
    rotation: { max_age_days: 365 }

exceptions:
  # Управляемые исключения по заявке с ограниченным сроком
  allowlist_users: []
  allowlist_until_hours: 0
  reason_required: true

telemetry:
  metrics:
    namespace: "security-core.password-policy"
    counters:
      - "validation.success"
      - "validation.failure"
      - "breach.checked"
      - "breach.blocked"
      - "lockouts.total"
    histograms:
      - "validation.duration_ms"
      - "password.entropy_bits"
