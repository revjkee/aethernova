apiVersion: security.neurocity.io/v1alpha3
kind: FeatureConfig
metadata:
  service: security-core
  owner: platform-security
  contact: secops@neurocity.example
  environmentFrom: ${APP_ENV:production}          # production|staging|dev — берётся из окружения рантайма
  revision: "0.1.0"
  lastModified: "2025-08-19T00:00:00Z"
  annotations:
    gitops.change-cause: "bootstrap features"
    compliance.profile: "default-hardened"
    # Подпись и проверка целостности могут выполняться во внешнем пайплайне (Cosign/Sigstore)

# -----------------------------
# ЯКОРЯ ДЕФОЛТОВ (переиспользуем)
# -----------------------------
defaults: &defaults
  auth:
    mfa:
      enforced: true
      methods:
        totp: true
        webauthn_passkeys: true
        sms: false
      step_up:
        enabled: true
        risk_threshold: 70                 # 0..100 (подозрительность UEBA)
    session:
      absolute_ttl: 12h
      idle_timeout: 30m
      same_site: Strict
      cookie_secure: true
      rotate_on_auth_events: true
    oauth_oidc:
      pkce_required: true
      refresh_token_rotation: true
      allowed_flows: ["authorization_code"]
      enforce_nonce: true
    risk_based_auth:
      enabled: true
      new_device_challenge: true
      geo_anomaly_challenge: true

  crypto:
    fips_mode: false                      # включайте только если образ и OpenSSL собраны в FIPS
    jwk:
      alg: EdDSA                           # Ed25519 для JWT/др. токенов (при поддержке клиентов)
      rotation:
        enabled: true
        interval: 24h
        overlap_window: 2h
    envelope_encryption:
      enabled: true
      kms_key_arn: ${KMS_KEY_ARN:}
    pii_tokenization:
      enabled: true
      scheme: "format-preserving"
      audit_reidentification: "break-glass" # доступ только по emergency‑процедуре

  api:
    rate_limit:
      enabled: true
      global:
        limit: 2000
        window: 60s
        burst: 400
      per_identity:
        limit: 300
        window: 60s
        burst: 80
      penalty_backoff: 5m
    quotas:
      enabled: true
      plan_overrides_allowed: false
    input_validation:
      mode: "strict"
      reject_unknown_fields: true
      max_payload_bytes: 1048576
    graphql_protection:
      enabled: false
      max_depth: 6
      max_complexity: 300
    http_security_headers:
      hsts:
        enabled: true
        max_age: 31536000
        include_subdomains: true
        preload: true
      csp:
        enabled: true
        preset: "strict-dynamic"
      x_content_type_options: nosniff
      referrer_policy: no-referrer

  network:
    tls_min_version: "1.3"
    mtls_internal:
      enabled: true
      client_ca_bundle_ref: "platform-ca"
    ip_allowlist:
      enabled: false
      cidrs: []
    cors:
      enabled: true
      allowed_origins: ["https://app.example.com"]
      allowed_headers: ["authorization","content-type","x-request-id"]
      allowed_methods: ["GET","POST","PUT","DELETE","OPTIONS"]

  privacy:
    logs_pii_redaction: "strict"
    telemetry_sampling:
      traces: 0.10
      logs: 1.0
      metrics: 1.0
    data_retention:
      audit_logs_days: 365
      auth_events_days: 180
      temp_artifacts_days: 7
    differential_privacy:
      enabled: false

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://otel-collector:4317}
    metrics:
      enabled: true
      runtime: prometheus
    audit_log:
      mode: append-only
      transport: "kafka"                  # или "file","http"
      topic: "audit.security-core.v1"

  runtime:
    seccomp_profile: "RuntimeDefault"
    read_only_root_fs: true
    drop_capabilities: ["ALL"]
    allow_privileged: false

  anti_abuse:
    captcha_on_signup: true
    bot_score_threshold: 0.65
    anomaly_detection:
      enabled: true
      ueba_features: ["ip_reputation","device_drift","velocity","time_anomaly"]
      alert_threshold: "high"

  web:
    csrf_protection: true
    cookie_prefix: "__Host-"
    csp_nonce_response_header: "Content-Security-Policy-Nonce"

  experiments:
    enabled: false
    # список экспериментальных флагов задаётся ниже в features

# -----------------------------
# ФИЧИ (включение/таргетинг)
# -----------------------------
features:
  # Каждая фича: declarative flags + rollout + guard/deps
  - key: "auth.passkeys_as_default"
    description: "Использовать passkeys как предпочтительный второй фактор"
    state:
      enabled: true
    rollout:
      strategy: "percentage"
      percentage:
        production: 25
        staging: 100
        dev: 100
      targets:
        - match:
            attribute: "org_id"
            in: ["neo-admin","secops"]
          weight: 100
    dependsOn: ["auth.mfa"]
    conflictsWith: []
    guard:
      require:
        - path: "auth.mfa.methods.webauthn_passkeys"
          equals: true

  - key: "api.strict_input_validation_v2"
    description: "Новая строгая схема валидации входа"
    state:
      enabled: true
    rollout:
      strategy: "header"
      header:
        name: "X-Enable-StrictValidation"
        values: ["1","true"]
      fallbackPercentage:
        production: 10
        staging: 100
        dev: 100
    dependsOn: []
    conflictsWith: []

  - key: "privacy.pii_tokenization_fpe"
    description: "FPE‑токенизация PII"
    state:
      enabled: true
    rollout:
      strategy: "percentage"
      percentage:
        production: 100
        staging: 100
        dev: 100
    dependsOn:
      - "crypto.envelope_encryption"
    guard:
      require:
        - path: "crypto.envelope_encryption.enabled"
          equals: true
        - path: "crypto.envelope_encryption.kms_key_arn"
          notEmpty: true

  - key: "observability.audit_to_kafka"
    description: "Отправка аудита в Kafka"
    state:
      enabled: true
    rollout:
      strategy: "all"
    guard:
      require:
        - path: "observability.audit_log.transport"
          equals: "kafka"
        - path: "observability.audit_log.topic"
          notEmpty: true

  - key: "network.mtls_strict"
    description: "Обязательный mTLS для всех внутренних вызовов"
    state:
      enabled: true
    rollout:
      strategy: "percentage"
      percentage:
        production: 100
        staging: 100
        dev: 100
    guard:
      require:
        - path: "network.mtls_internal.enabled"
          equals: true
        - path: "network.mtls_internal.client_ca_bundle_ref"
          notEmpty: true

  - key: "runtime.readonly_fs_enforce"
    description: "Принудительное read‑only root FS"
    state:
      enabled: true
    rollout:
      strategy: "all"
    guard:
      require:
        - path: "runtime.read_only_root_fs"
          equals: true

  - key: "experiments.diff_privacy_beta"
    description: "Бета‑режим дифференциальной приватности на не‑PII метриках"
    state:
      enabled: false
    rollout:
      strategy: "percentage"
      percentage:
        production: 0
        staging: 10
        dev: 50
    guard:
      forbid:
        - path: "privacy.differential_privacy.enabled"
          equals: false

# -----------------------------
# ГВАРДЫ/ИНВАРИАНТЫ КОНФИГА
# (валидация рантаймом/плейбуком)
# -----------------------------
guards:
  - id: "tls-min-version"
    description: "TLS не ниже 1.2 (по умолчанию 1.3)"
    assert:
      - path: "network.tls_min_version"
        in: ["1.2","1.3"]

  - id: "quota-rate-limit-compat"
    description: "Квоты включены только при включённом rate‑limit"
    when:
      - path: "api.quotas.enabled"
        equals: true
    assert:
      - path: "api.rate_limit.enabled"
        equals: true

  - id: "fips-compat"
    description: "FIPS требует совместимого рантайма"
    when:
      - path: "crypto.fips_mode"
        equals: true
    assert:
      - path: "runtime.seccomp_profile"
        in: ["RuntimeDefault","DockerDefault"]

  - id: "readonly-fs-compatible"
    description: "При read‑only FS должны быть перенесены пути записи"
    when:
      - path: "runtime.read_only_root_fs"
        equals: true
    assert:
      - path: "web.csrf_protection"
        equals: true

# -----------------------------
# КОНФИГ ПО УМОЛЧАНИЮ
# -----------------------------
config:
  <<: *defaults

# -----------------------------
# ОКРУЖЕНЧЕСКИЕ ОВЕРРАЙДЫ
# -----------------------------
environments:
  production:
    observability:
      tracing:
        enabled: true
        # sampling по умолчанию подтягивается из defaults (0.10)
    api:
      rate_limit:
        global:
          limit: 3000
          window: 60s
          burst: 600
        per_identity:
          limit: 500
          window: 60s
          burst: 120
    privacy:
      telemetry_sampling:
        traces: 0.05
        logs: 1.0
        metrics: 1.0

  staging:
    configAnchors: "inherit-defaults"
    api:
      rate_limit:
        global:
          limit: 1000
          window: 60s
          burst: 200
    experiments:
      enabled: true

  dev:
    auth:
      mfa:
        enforced: false          # локальная разработка
    network:
      cors:
        allowed_origins: ["*"]
    api:
      rate_limit:
        enabled: false
    observability:
      tracing:
        enabled: true
    experiments:
      enabled: true

# -----------------------------
# АУДИТ‑СЛЕД (для чтения рантаймом)
# -----------------------------
auditTrail:
  enabled: true
  record:
    source: "features.yaml"
    include:
      - metadata.revision
      - features[*].key
      - features[*].state.enabled
      - environments

# -----------------------------
# ПРИМЕЧАНИЯ
# -----------------------------
notes:
  - "Все значения могут быть переопределены переменными окружения, если это поддерживает ваш конфиг‑лоадер (не включено в данный файл)."
  - "Для безопасного включения фич используйте rollout стратегии и ограничения guards."
  - "Избегайте включения fips_mode без соответствующей сборки и сертификатов."
  - "Rate‑limit/quotas требуют согласованности с API‑шлюзом."
