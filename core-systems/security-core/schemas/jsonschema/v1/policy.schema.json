{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.aethernova.ai/security/v1/policy.schema.json",
  "title": "Aethernova Security Policy",
  "type": "object",
  "additionalProperties": false,
  "$comment": "Индустриальная схема политики авторизации. Совместима с control-plane и статической проверкой в CI.",
  "required": ["name", "tenant_id", "priority", "rules", "version"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Полное имя ресурса политики.",
      "pattern": "^tenants\\/([A-Za-z0-9_.-]{1,128})\\/policies\\/([A-Za-z0-9_.-]{1,128})$"
    },
    "uid": {
      "type": "string",
      "format": "uuid",
      "description": "Иммутабельный серверный идентификатор."
    },
    "tenant_id": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9_.-]+$",
      "description": "ID арендатора. Должен соответствовать части в name (проверяется на сервере)."
    },
    "display_name": {
      "type": "string",
      "maxLength": 256
    },
    "description": {
      "type": "string",
      "maxLength": 4096
    },
    "priority": {
      "type": "integer",
      "minimum": 0,
      "maximum": 9007199254740991,
      "description": "Порядок оценки: больше — раньше."
    },
    "target": {
      "$ref": "#/$defs/target"
    },
    "rules": {
      "type": "array",
      "minItems": 1,
      "maxItems": 10000,
      "uniqueItems": false,
      "items": { "$ref": "#/$defs/rule" },
      "$comment": "rule.id должен быть уникален внутри policy (обеспечивается сервером/линтером)."
    },
    "applies_to_actions": {
      "type": "array",
      "items": { "$ref": "#/$defs/actionName" },
      "uniqueItems": true,
      "maxItems": 1024,
      "description": "Опциональное ограничение списка действий для всей политики."
    },
    "labels": {
      "$ref": "#/$defs/labels"
    },
    "version": {
      "$ref": "#/$defs/policyVersion"
    },
    "etag": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_\\-:\\/\\.]{1,256}$",
      "description": "Оптимистичная блокировка."
    },
    "signature": {
      "$ref": "#/$defs/signingInfo"
    },
    "create_time": {
      "type": "string",
      "format": "date-time",
      "readOnly": true
    },
    "update_time": {
      "type": "string",
      "format": "date-time",
      "readOnly": true
    },
    "disabled": {
      "type": "boolean",
      "default": false
    }
  },
  "$defs": {
    "actionName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z][a-z0-9_.:-]{0,63}$",
      "description": "Имя действия: read, write, transfer, approve и т.п."
    },
    "labels": {
      "type": "object",
      "additionalProperties": { "type": "string", "maxLength": 128 },
      "propertyNames": {
        "type": "string",
        "pattern": "^[a-z0-9]([a-z0-9._-]{0,61}[a-z0-9])?$"
      },
      "maxProperties": 256,
      "description": "Легковесные теги."
    },
    "attributeValue": {
      "description": "Атрибут как JSON-скаляр/массив/объект. Используется в селекторах и обязательствах.",
      "oneOf": [
        { "type": "string", "maxLength": 8192 },
        { "type": "integer" },
        { "type": "number" },
        { "type": "boolean" },
        { "type": "string", "format": "date-time" },
        { "type": "string", "contentEncoding": "base64" },
        { "type": "array", "items": { "type": "string" }, "maxItems": 4096 },
        { "type": "array", "items": { "type": "integer" }, "maxItems": 4096 },
        { "type": "array", "items": { "type": "number" }, "maxItems": 4096 },
        { "type": "array", "items": { "type": "boolean" }, "maxItems": 4096 },
        { "type": "object" }
      ]
    },
    "celExpression": {
      "type": "string",
      "minLength": 1,
      "maxLength": 2048,
      "contentMediaType": "application/cel",
      "description": "CEL-выражение, выполняемое над связками subject/resource/action/session/env."
    },
    "id128": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9_.:-]+$"
    },
    "resourceType": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z][a-z0-9_.-]{0,63}$",
      "description": "Тип ресурса: document, dataset, wallet и т.п."
    },
    "stringArray": {
      "type": "array",
      "items": { "type": "string", "maxLength": 256 },
      "maxItems": 10000,
      "uniqueItems": true
    },
    "kvAttributes": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/attributeValue" },
      "maxProperties": 2048
    },
    "obligation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key"],
      "properties": {
        "key": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_.:-]{1,64}$"
        },
        "value": { "$ref": "#/$defs/attributeValue" }
      },
      "description": "Инструкция для PEP при PERMIT, напр. mask_fields/ttl_seconds."
    },
    "subjectSelector": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "principals": { "$ref": "#/$defs/stringArray" },
        "roles": { "$ref": "#/$defs/stringArray" },
        "groups": { "$ref": "#/$defs/stringArray" },
        "attributes_eq": { "$ref": "#/$defs/kvAttributes" },
        "match": { "$ref": "#/$defs/celExpression" }
      }
    },
    "resourceSelector": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "$ref": "#/$defs/resourceType" },
        "ids": { "$ref": "#/$defs/stringArray" },
        "labels": { "$ref": "#/$defs/labels" },
        "attributes_eq": { "$ref": "#/$defs/kvAttributes" },
        "match": { "$ref": "#/$defs/celExpression" }
      }
    },
    "rule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "effect"],
      "properties": {
        "id": { "$ref": "#/$defs/id128" },
        "effect": {
          "description": "ALLOW/DENY. Для совместимости допускаются строка или код.",
          "oneOf": [
            { "type": "string", "enum": ["ALLOW", "DENY"] },
            { "type": "integer", "enum": [1, 2] }
          ]
        },
        "condition": { "$ref": "#/$defs/celExpression" },
        "subjects": { "$ref": "#/$defs/subjectSelector" },
        "resources": { "$ref": "#/$defs/resourceSelector" },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/actionName" },
          "minItems": 1,
          "uniqueItems": true,
          "maxItems": 4096
        },
        "obligations": {
          "type": "array",
          "items": { "$ref": "#/$defs/obligation" },
          "maxItems": 256
        },
        "description": { "type": "string", "maxLength": 1024 },
        "priority": { "type": "integer", "minimum": 0, "maximum": 9007199254740991 }
      }
    },
    "target": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "subjects": { "$ref": "#/$defs/subjectSelector" },
        "resources": { "$ref": "#/$defs/resourceSelector" },
        "actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/actionName" },
          "uniqueItems": true,
          "maxItems": 1024
        }
      }
    },
    "semver": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-.]+)?(?:\\+[0-9A-Za-z-.]+)?$"
    },
    "policyVersion": {
      "type": "object",
      "additionalProperties": false,
      "required": ["revision", "version", "published", "create_time"],
      "properties": {
        "revision": { "type": "integer", "minimum": 1 },
        "version": { "$ref": "#/$defs/semver" },
        "published": { "type": "boolean" },
        "author": { "type": "string", "maxLength": 256 },
        "change_notes": { "type": "string", "maxLength": 4096 },
        "create_time": { "type": "string", "format": "date-time" }
      }
    },
    "signingInfo": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key_id", "algorithm", "signature"],
      "properties": {
        "key_id": { "type": "string", "maxLength": 256 },
        "algorithm": { "type": "string", "enum": ["ed25519", "ecdsa_p256_sha256"] },
        "signature": { "type": "string", "contentEncoding": "base64" },
        "signed_payload": { "type": "string", "contentEncoding": "base64" }
      }
    },
    "policyBundle": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tenant_id", "etag", "policies", "create_time"],
      "properties": {
        "tenant_id": { "type": "string", "minLength": 1, "maxLength": 128, "pattern": "^[A-Za-z0-9_.-]+$" },
        "etag": { "type": "string", "pattern": "^[A-Za-z0-9_\\-:\\/\\.]{1,256}$" },
        "policies": {
          "type": "array",
          "minItems": 1,
          "maxItems": 20000,
          "items": { "$ref": "#" }
        },
        "create_time": { "type": "string", "format": "date-time" }
      },
      "$comment": "Опциональная сущность для транспортировки снапшота в PDP."
    }
  },
  "examples": [
    {
      "name": "tenants/acme/policies/data-read",
      "tenant_id": "acme",
      "display_name": "Data Read Policy",
      "priority": 1000,
      "labels": { "env": "prod" },
      "version": { "revision": 7, "version": "1.2.3", "published": true, "create_time": "2025-08-20T09:00:00Z" },
      "rules": [
        {
          "id": "r1",
          "effect": "ALLOW",
          "actions": ["read"],
          "subjects": { "roles": ["analyst"] },
          "resources": {
            "type": "dataset",
            "labels": { "classification": "public" }
          },
          "priority": 10
        },
        {
          "id": "r2",
          "effect": "DENY",
          "actions": ["read", "write"],
          "resources": {
            "type": "dataset",
            "attributes_eq": { "classification": "restricted" }
          },
          "condition": "session.risk_score > 70",
          "priority": 100
        }
      ]
    }
  ]
}
