{
  "$id": "https://aethernova.security/schemas/jsonschema/v1/jwk.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "JSON Web Key (JWK)",
  "description": "Промышленная схема JWK по RFC 7517 (JWK), RFC 7518 (JWA), RFC 8037 (OKP).",
  "type": "object",
  "additionalProperties": true,

  "properties": {
    "kty": {
      "type": "string",
      "description": "Тип ключа",
      "enum": ["RSA", "EC", "OKP", "oct"]
    },
    "kid": {
      "type": "string",
      "description": "Идентификатор ключа",
      "minLength": 1,
      "maxLength": 255
    },
    "use": {
      "type": "string",
      "description": "Предпочтительное использование ключа",
      "enum": ["sig", "enc"]
    },
    "key_ops": {
      "type": "array",
      "description": "Разрешённые операции над ключом (RFC 7517)",
      "items": { "$ref": "#/$defs/keyOpsAny" },
      "uniqueItems": true,
      "minItems": 1
    },
    "alg": {
      "type": "string",
      "description": "Предпочтительный алгоритм (RFC 7518)",
      "enum": [
        "HS256","HS384","HS512",
        "RS256","RS384","RS512",
        "PS256","PS384","PS512",
        "ES256","ES384","ES512",
        "RSA1_5","RSA-OAEP","RSA-OAEP-256",
        "A128KW","A192KW","A256KW",
        "A128GCMKW","A192GCMKW","A256GCMKW",
        "ECDH-ES","ECDH-ES+A128KW","ECDH-ES+A192KW","ECDH-ES+A256KW",
        "PBES2-HS256+A128KW","PBES2-HS384+A192KW","PBES2-HS512+A256KW",
        "dir"
      ]
    },

    "x5u": {
      "type": "string",
      "format": "uri",
      "description": "URI на X.509 сертификат"
    },
    "x5c": {
      "type": "array",
      "description": "Цепочка сертификатов X.509 (base64 DER, не base64url)",
      "items": { "$ref": "#/$defs/base64" },
      "minItems": 1
    },
    "x5t": {
      "$ref": "#/$defs/base64url",
      "description": "SHA-1 thumbprint сертификата (base64url без padding)"
    },
    "x5t#S256": {
      "$ref": "#/$defs/base64url",
      "description": "SHA-256 thumbprint сертификата (base64url без padding)"
    },

    "n": { "$ref": "#/$defs/base64url", "description": "RSA modulus" },
    "e": { "$ref": "#/$defs/base64url", "description": "RSA public exponent" },
    "d": { "$ref": "#/$defs/base64url", "description": "Приватный параметр (RSA/EC/OKP/oct зависит от kty)" },

    "p":   { "$ref": "#/$defs/base64url", "description": "RSA first prime factor" },
    "q":   { "$ref": "#/$defs/base64url", "description": "RSA second prime factor" },
    "dp":  { "$ref": "#/$defs/base64url", "description": "RSA d mod (p-1)" },
    "dq":  { "$ref": "#/$defs/base64url", "description": "RSA d mod (q-1)" },
    "qi":  { "$ref": "#/$defs/base64url", "description": "RSA CRT coefficient" },
    "oth": {
      "type": "array",
      "description": "RSA другие простые множители (Optional; RFC 7517)",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "r": { "$ref": "#/$defs/base64url", "description": "Prime factor" },
          "d": { "$ref": "#/$defs/base64url", "description": "d mod (r-1)" },
          "t": { "$ref": "#/$defs/base64url", "description": "CRT coefficient" }
        },
        "required": ["r","d","t"]
      },
      "minItems": 1
    },

    "crv": {
      "type": "string",
      "description": "Кривая EC/OKP",
      "enum": ["P-256","P-384","P-521","Ed25519","Ed448","X25519","X448"]
    },
    "x": { "$ref": "#/$defs/base64url", "description": "EC/OKP координата/публичный вектор" },
    "y": { "$ref": "#/$defs/base64url", "description": "EC координата Y (для EC, не для OKP)" },

    "k": { "$ref": "#/$defs/base64url", "description": "Секрет для oct (симметричный ключ)" }
  },

  "required": ["kty"],

  "allOf": [
    {
      "if": { "properties": { "kty": { "const": "RSA" } }, "required": ["kty"] },
      "then": {
        "required": ["n","e"],
        "not": { "required": ["crv","x","y","k"] }
      }
    },
    {
      "if": { "properties": { "kty": { "const": "EC" } }, "required": ["kty"] },
      "then": {
        "required": ["crv","x","y"],
        "properties": {
          "crv": { "enum": ["P-256","P-384","P-521"] }
        },
        "not": { "required": ["n","e","k"] }
      }
    },
    {
      "if": { "properties": { "kty": { "const": "OKP" } }, "required": ["kty"] },
      "then": {
        "required": ["crv","x"],
        "properties": {
          "crv": { "enum": ["Ed25519","Ed448","X25519","X448"] },
          "y": { "not": {} }  /* у OKP нет 'y' */
        },
        "not": { "required": ["n","e","y","k"] }
      }
    },
    {
      "if": { "properties": { "kty": { "const": "oct" } }, "required": ["kty"] },
      "then": {
        "required": ["k"],
        "not": { "required": ["n","e","crv","x","y"] }
      }
    },

    {
      "if": { "properties": { "use": { "const": "sig" } }, "required": ["use"] },
      "then": {
        "properties": { "key_ops": { "items": { "$ref": "#/$defs/keyOpsSig" } } }
      }
    },
    {
      "if": { "properties": { "use": { "const": "enc" } }, "required": ["use"] },
      "then": {
        "properties": { "key_ops": { "items": { "$ref": "#/$defs/keyOpsEnc" } } }
      }
    }
  ],

  "$defs": {
    "base64url": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+$",
      "description": "Base64url без padding ('-' и '_' вместо '+' и '/')"
    },
    "base64": {
      "type": "string",
      "pattern": "^[A-Za-z0-9+/=\\r\\n]+$",
      "description": "Стандартный Base64 (для x5c)"
    },

    "keyOpsAny": {
      "type": "string",
      "enum": [
        "sign","verify",
        "encrypt","decrypt",
        "wrapKey","unwrapKey",
        "deriveKey","deriveBits"
      ]
    },
    "keyOpsSig": {
      "type": "string",
      "enum": ["sign","verify"]
    },
    "keyOpsEnc": {
      "type": "string",
      "enum": ["encrypt","decrypt","wrapKey","unwrapKey","deriveKey","deriveBits"]
    }
  },

  "examples": [
    {
      "kty": "RSA",
      "kid": "rsa-2024-01",
      "use": "sig",
      "key_ops": ["verify"],
      "alg": "RS256",
      "n": "sXchm2pQ7o5Wc0t9m4vH2Cfr1iZr3t4JQ0yXo2s0jX0",
      "e": "AQAB",
      "x5t#S256": "Yf9mW9F1bqV9mM7r1Tt9t5f4u1bQG3e8c9S1Zxg3KxU"
    },
    {
      "kty": "EC",
      "kid": "p256-enc",
      "use": "enc",
      "key_ops": ["deriveKey"],
      "alg": "ECDH-ES",
      "crv": "P-256",
      "x": "f83OJ3D2xF4mS9xZ5r1o_Jw3W8s5b3k8m2F3v4A5f6Q",
      "y": "x_FEzRu9Q3V0E3D7sP8x5O7v9y2w0b3n4m5k6l7t8u9"
    },
    {
      "kty": "OKP",
      "kid": "ed25519-sig",
      "use": "sig",
      "key_ops": ["verify"],
      "alg": "EdDSA",
      "crv": "Ed25519",
      "x": "11qYAYafhGM4Ge4mY5bK3cVb7sS3c0B1wP9PpA7PzvQ"
    },
    {
      "kty": "oct",
      "kid": "aes-kw",
      "use": "enc",
      "key_ops": ["wrapKey","unwrapKey"],
      "alg": "A256KW",
      "k": "GawgguFyGrWKav7AX4VKUg"
    }
  ]
}
