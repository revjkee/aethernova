{
  "$id": "https://schemas.mythos-core.local/jsonschema/v1/dialogue.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Mythos Dialogue Envelope (v1)",
  "description": "Строгая схема диалогов ИИ для промышленного использования: сообщения, инструменты, метрики, безопасность, вложения, связи.",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "conversation", "messages"],
  "properties": {
    "version": {
      "description": "Версия контракта схемы данных.",
      "type": "string",
      "const": "1.0.0"
    },
    "conversation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "created_at"],
      "properties": {
        "id": { "$ref": "#/$defs/Ulid" },
        "parent_id": { "$ref": "#/$defs/Ulid" },
        "title": { "type": "string", "minLength": 1, "maxLength": 256 },
        "locale": { "$ref": "#/$defs/BCP47" },
        "tags": {
          "type": "array",
          "items": { "$ref": "#/$defs/Tag" },
          "minItems": 0,
          "maxItems": 64,
          "uniqueItems": true
        },
        "created_at": { "$ref": "#/$defs/ISODateTime" },
        "updated_at": { "$ref": "#/$defs/ISODateTime" },
        "safety_policy_ref": { "type": "string", "format": "uri", "maxLength": 2048 }
      }
    },
    "messages": {
      "description": "Хронологически упорядоченные сообщения.",
      "type": "array",
      "minItems": 1,
      "maxItems": 10000,
      "items": { "$ref": "#/$defs/Message" }
    },
    "metrics": {
      "description": "Агрегированные метрики по диалогу.",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "token_usage": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "prompt_tokens": { "$ref": "#/$defs/UInt32" },
            "completion_tokens": { "$ref": "#/$defs/UInt32" },
            "total_tokens": { "$ref": "#/$defs/UInt32" }
          },
          "required": ["prompt_tokens", "completion_tokens", "total_tokens"]
        },
        "cost": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "currency": { "type": "string", "enum": ["USD", "EUR", "SEK"] },
            "amount": { "type": "number", "minimum": 0 }
          }
        },
        "latency_ms_p50": { "$ref": "#/$defs/UInt32" },
        "latency_ms_p95": { "$ref": "#/$defs/UInt32" }
      }
    }
  },
  "$defs": {
    "Ulid": {
      "type": "string",
      "description": "ULID (26 символов Crockford Base32).",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
    },
    "UUID": {
      "type": "string",
      "format": "uuid"
    },
    "ISODateTime": {
      "type": "string",
      "format": "date-time",
      "description": "RFC 3339 с UTC предпочтительно."
    },
    "BCP47": {
      "type": "string",
      "description": "Языковой тег BCP-47, например en, en-US, ru-RU.",
      "pattern": "^[A-Za-z]{2,3}(-[A-Za-z0-9]{2,8})*$",
      "maxLength": 35
    },
    "Tag": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z0-9][a-z0-9._-]{0,63}$"
    },
    "UInt32": { "type": "integer", "minimum": 0, "maximum": 4294967295 },
    "SafeText": {
      "type": "string",
      "minLength": 0,
      "maxLength": 16384
    },
    "Url": { "type": "string", "format": "uri", "maxLength": 2048 },
    "Sha256": {
      "type": "string",
      "pattern": "^[A-Fa-f0-9]{64}$"
    },
    "MessageRole": {
      "type": "string",
      "enum": ["system", "user", "assistant", "tool", "function"]
    },
    "Attachment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "kind", "url"],
      "properties": {
        "id": { "$ref": "#/$defs/Ulid" },
        "kind": { "type": "string", "enum": ["image", "audio", "video", "document", "binary"] },
        "url": { "$ref": "#/$defs/Url" },
        "content_type": { "type": "string", "minLength": 3, "maxLength": 128 },
        "size_bytes": { "type": "integer", "minimum": 0, "maximum": 10737418240 },
        "sha256": { "$ref": "#/$defs/Sha256" },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "maxProperties": 64
        }
      }
    },
    "Citations": {
      "type": "array",
      "minItems": 0,
      "maxItems": 128,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["url"],
        "properties": {
          "url": { "$ref": "#/$defs/Url" },
          "title": { "type": "string", "minLength": 1, "maxLength": 256 },
          "accessed_at": { "$ref": "#/$defs/ISODateTime" }
        }
      }
    },
    "ToolCall": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "arguments"],
      "properties": {
        "id": { "$ref": "#/$defs/Ulid" },
        "name": { "type": "string", "minLength": 1, "maxLength": 128 },
        "arguments": {
          "type": "object",
          "description": "JSON-аргументы вызова инструмента.",
          "additionalProperties": true
        }
      }
    },
    "ToolResult": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tool_call_id", "ok"],
      "properties": {
        "tool_call_id": { "$ref": "#/$defs/Ulid" },
        "ok": { "type": "boolean" },
        "content": {
          "description": "Результат работы инструмента (любой валидный JSON).",
          "type": ["object", "array", "string", "number", "boolean", "null"]
        },
        "error": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "code": { "type": "string", "minLength": 1, "maxLength": 64 },
            "message": { "type": "string", "minLength": 1, "maxLength": 1024 }
          }
        }
      },
      "allOf": [
        {
          "if": { "properties": { "ok": { "const": true } }, "required": ["ok"] },
          "then": { "required": ["content"], "not": { "required": ["error"] } }
        },
        {
          "if": { "properties": { "ok": { "const": false } }, "required": ["ok"] },
          "then": { "required": ["error"], "not": { "required": ["content"] } }
        }
      ]
    },
    "Moderation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "flagged": { "type": "boolean", "default": false },
        "categories": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "hate", "self-harm", "violence", "sexual", "politics",
              "pii", "malware", "financial", "medical", "extremism"
            ]
          },
          "minItems": 0,
          "maxItems": 16,
          "uniqueItems": true
        },
        "score": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "MessageContent": {
      "oneOf": [
        {
          "title": "Текстовый контент",
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "text"],
          "properties": {
            "type": { "const": "text" },
            "text": { "$ref": "#/$defs/SafeText" },
            "citations": { "$ref": "#/$defs/Citations" }
          }
        },
        {
          "title": "Вызов инструмента",
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "tool_call"],
          "properties": {
            "type": { "const": "tool_call" },
            "tool_call": { "$ref": "#/$defs/ToolCall" }
          }
        },
        {
          "title": "Ответ инструмента",
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "tool_result"],
          "properties": {
            "type": { "const": "tool_result" },
            "tool_result": { "$ref": "#/$defs/ToolResult" }
          }
        }
      ]
    },
    "Message": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "role", "created_at", "content"],
      "properties": {
        "id": { "$ref": "#/$defs/Ulid" },
        "thread_id": { "$ref": "#/$defs/Ulid" },
        "parent_id": { "$ref": "#/$defs/Ulid" },
        "role": { "$ref": "#/$defs/MessageRole" },
        "locale": { "$ref": "#/$defs/BCP47" },
        "created_at": { "$ref": "#/$defs/ISODateTime" },
        "model": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string", "minLength": 1, "maxLength": 128 },
            "provider": { "type": "string", "minLength": 1, "maxLength": 64 },
            "temperature": { "type": "number", "minimum": 0, "maximum": 2 },
            "top_p": { "type": "number", "minimum": 0, "maximum": 1 },
            "max_tokens": { "$ref": "#/$defs/UInt32" }
          }
        },
        "content": { "$ref": "#/$defs/MessageContent" },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/Attachment" },
          "minItems": 0,
          "maxItems": 32,
          "uniqueItems": true
        },
        "metrics": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "token_usage": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "input": { "$ref": "#/$defs/UInt32" },
                "output": { "$ref": "#/$defs/UInt32" },
                "total": { "$ref": "#/$defs/UInt32" }
              }
            },
            "latency_ms": { "$ref": "#/$defs/UInt32" }
          }
        },
        "moderation": { "$ref": "#/$defs/Moderation" },
        "labels": { "$ref": "#/$defs/Labels" }
      },
      "allOf": [
        {
          "if": { "properties": { "role": { "const": "assistant" } }, "required": ["role"] },
          "then": {
            "properties": {
              "model": { "required": ["name"] }
            }
          }
        },
        {
          "if": { "properties": { "role": { "const": "tool" } }, "required": ["role"] },
          "then": {
            "properties": {
              "content": {
                "properties": { "type": { "const": "tool_result" } }
              }
            }
          }
        },
        {
          "if": { "properties": { "role": { "const": "assistant" } }, "required": ["role"] },
          "then": {
            "properties": {
              "content": {
                "not": {
                  "properties": { "type": { "const": "tool_result" } },
                  "required": ["type"]
                }
              }
            }
          }
        }
      ]
    }
  },
  "examples": [
    {
      "version": "1.0.0",
      "conversation": {
        "id": "01HZX2Y7FQJ0J1F4VQ2W0X6Y7Z",
        "title": "Product Q&A",
        "locale": "en-US",
        "tags": ["support", "qa"],
        "created_at": "2025-08-27T10:00:00Z"
      },
      "messages": [
        {
          "id": "01HZX2Y8G2R6YB2Q5KQ5A00ABC",
          "role": "user",
          "created_at": "2025-08-27T10:00:05Z",
          "locale": "en-US",
          "content": { "type": "text", "text": "What is the return policy?" }
        },
        {
          "id": "01HZX2Y97PZ1Q4VQ2W0X6Y7ZA1",
          "role": "assistant",
          "created_at": "2025-08-27T10:00:06Z",
          "model": { "name": "mythos-gpt-neo", "temperature": 0.2, "top_p": 0.95 },
          "content": {
            "type": "text",
            "text": "Our return policy is 30 days.",
            "citations": [
              { "url": "https://example.com/returns", "title": "Returns Policy", "accessed_at": "2025-08-27T10:00:06Z" }
            ]
          }
        },
        {
          "id": "01HZX2Y9CZR6YB2Q5KQ5A00ABD",
          "role": "assistant",
          "created_at": "2025-08-27T10:00:07Z",
          "model": { "name": "mythos-gpt-neo" },
          "content": {
            "type": "tool_call",
            "tool_call": {
              "id": "01HZX2YA1TR4ZC7KV8S9QWXYMN",
              "name": "check_order_status",
              "arguments": { "order_id": "A12345" }
            }
          }
        },
        {
          "id": "01HZX2YBC1R6YB2Q5KQ5A00ABE",
          "role": "tool",
          "created_at": "2025-08-27T10:00:07Z",
          "content": {
            "type": "tool_result",
            "tool_result": {
              "tool_call_id": "01HZX2YA1TR4ZC7KV8S9QWXYMN",
              "ok": true,
              "content": { "status": "SHIPPED", "eta": "2025-08-31" }
            }
          }
        }
      ],
      "metrics": {
        "token_usage": { "prompt_tokens": 24, "completion_tokens": 18, "total_tokens": 42 },
        "cost": { "currency": "USD", "amount": 0.0034 },
        "latency_ms_p50": 120,
        "latency_ms_p95": 320
      }
    }
  ]
}
