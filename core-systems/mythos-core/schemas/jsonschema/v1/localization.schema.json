{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://spec.aethernova.dev/mythos-core/jsonschema/v1/localization.schema.json",
  "title": "Mythos Core Localization Bundle (v1)",
  "description": "Промышленный формат бандла локализаций с поддержкой ICU MessageFormat, плейсхолдеров и фолбеков.",
  "type": "object",
  "required": ["version", "project", "namespace", "defaultLocale", "locales", "messages"],
  "additionalProperties": false,

  "properties": {
    "version": {
      "type": "string",
      "description": "Семантическая версия бандла",
      "pattern": "^v\\d+\\.\\d+\\.\\d+$",
      "examples": ["v1.0.0"]
    },
    "project": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64
    },
    "namespace": {
      "type": "string",
      "description": "Логический модуль/пространство ключей",
      "pattern": "^[a-z0-9_.-]{1,64}$"
    },
    "defaultLocale": {
      "$ref": "#/$defs/LocaleID",
      "description": "Базовая локаль (должна входить в locales)"
    },
    "locales": {
      "type": "array",
      "description": "Список локалей, присутствующих в бандле",
      "items": { "$ref": "#/$defs/LocaleID" },
      "minItems": 1,
      "uniqueItems": true
    },
    "fallback": {
      "type": "object",
      "description": "Фолбек-цепочки локалей: { targetLocale: sourceLocale | [sourceLocale...] }",
      "propertyNames": { "$ref": "#/$defs/LocaleID" },
      "additionalProperties": { "$ref": "#/$defs/LocaleIDOrArray" }
    },
    "direction": {
      "type": "object",
      "description": "Направление письма на локаль (ltr/rtl/auto)",
      "propertyNames": { "$ref": "#/$defs/LocaleID" },
      "additionalProperties": { "enum": ["ltr", "rtl", "auto"] }
    },
    "metadata": {
      "type": "object",
      "description": "Произвольные метаданные бандла",
      "additionalProperties": true
    },
    "messages": {
      "$ref": "#/$defs/Messages"
    }
  },

  "$comment": "Примечание: строгая проверка 'defaultLocale ∈ locales' обычно выполняется линтером/CI.",

  "$defs": {
    "LocaleID": {
      "type": "string",
      "description": "Код локали в формате BCP-47 (упрощенный паттерн)",
      "pattern": "^(?:[A-Za-z]{2,3}(?:-[A-Za-z]{4})?(?:-[A-Za-z]{2}|-[0-9]{3})?(?:-(?:[A-Za-z0-9]{5,8}|[0-9][A-Za-z0-9]{3}))*)(?:-x-[A-Za-z0-9-]+)?$",
      "examples": ["en", "en-GB", "ru", "ru-RU", "zh-Hans-CN"]
    },

    "LocaleIDOrArray": {
      "oneOf": [
        { "$ref": "#/$defs/LocaleID" },
        {
          "type": "array",
          "items": { "$ref": "#/$defs/LocaleID" },
          "minItems": 1,
          "uniqueItems": true
        }
      ]
    },

    "Messages": {
      "type": "object",
      "description": "Словарь сообщений: { key: MessageEntry }",
      "minProperties": 1,
      "additionalProperties": false,
      "patternProperties": {
        "^[a-z0-9_.-]{1,128}$": { "$ref": "#/$defs/MessageEntry" }
      }
    },

    "MessageEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["translations"],
      "properties": {
        "key": {
          "type": "string",
          "description": "Дублирование ключа для удобства; должно совпадать с именем свойства в messages",
          "pattern": "^[a-z0-9_.-]{1,128}$"
        },
        "context": {
          "type": "string",
          "description": "Короткий контекст/смысл (для переводчиков)",
          "maxLength": 256
        },
        "description": {
          "type": "string",
          "description": "Расширенное описание/инструкция для переводчиков"
        },
        "placeholders": {
          "type": "object",
          "description": "Справочник плейсхолдеров, используемых в value/ICU",
          "additionalProperties": false,
          "patternProperties": {
            "^[a-z][a-z0-9_]{0,31}$": { "$ref": "#/$defs/Placeholder" }
          }
        },
        "screenshots": {
          "type": "array",
          "description": "Скриншоты/ссылки на контекст",
          "items": { "type": "string", "format": "uri" },
          "maxItems": 8,
          "uniqueItems": true
        },
        "source": {
          "type": "array",
          "description": "Места использования ключа в исходном коде",
          "items": { "$ref": "#/$defs/SourceRef" },
          "maxItems": 100
        },
        "flags": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "reviewed": { "type": "boolean" },
            "fuzzy": { "type": "boolean" },
            "deprecated": { "type": "boolean" },
            "needs_work": { "type": "boolean" }
          }
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 исходного значения/контекста",
          "pattern": "^[a-f0-9]{64}$"
        },
        "translations": { "$ref": "#/$defs/Translations" }
      }
    },

    "Placeholder": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "string", "number", "integer",
            "date", "time", "datetime",
            "plural", "select", "gender"
          ]
        },
        "format": {
          "type": "string",
          "description": "Пожелания по форматированию",
          "enum": [
            "plain", "number", "percent", "currency",
            "date", "time", "datetime", "duration"
          ]
        },
        "required": { "type": "boolean", "default": false },
        "description": { "type": "string", "maxLength": 256 },
        "examples": {
          "type": "array",
          "items": {
            "oneOf": [
              { "type": "string" },
              { "type": "number" },
              { "type": "integer" }
            ]
          },
          "maxItems": 5
        },
        "options": {
          "type": "object",
          "description": "Опции для select/plural (например, one/other)",
          "additionalProperties": { "type": "string" }
        }
      }
    },

    "SourceRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["file"],
      "properties": {
        "file": { "type": "string", "maxLength": 512 },
        "line": { "type": "integer", "minimum": 1 },
        "column": { "type": "integer", "minimum": 1 }
      }
    },

    "Translations": {
      "type": "object",
      "description": "Переводы по локалям",
      "propertyNames": { "$ref": "#/$defs/LocaleID" },
      "additionalProperties": { "$ref": "#/$defs/Translation" },
      "minProperties": 1
    },

    "Translation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value"],
      "properties": {
        "value": {
          "type": "string",
          "description": "Переведенная строка (ICU/Plain/Markdown по message_format)",
          "minLength": 0,
          "maxLength": 4000,
          "pattern": "^(?:(?!</?(?:script|style)\\b).)*$"
        },
        "message_format": {
          "type": "string",
          "description": "Формат строки",
          "enum": ["icu", "plain", "markdown"],
          "default": "icu"
        },
        "status": {
          "type": "string",
          "enum": ["draft", "review", "approved", "rejected", "obsolete"],
          "default": "draft"
        },
        "reviewer": { "type": "string", "maxLength": 128 },
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "notes": { "type": "string", "maxLength": 500 },
        "rtl_overrides": {
          "type": "boolean",
          "description": "Явное переопределение направления для RTL",
          "default": false
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 значения перевода",
          "pattern": "^[a-f0-9]{64}$"
        }
      }
    }
  },

  "examples": [
    {
      "version": "v1.0.0",
      "project": "mythos-core",
      "namespace": "ui.auth",
      "defaultLocale": "en",
      "locales": ["en", "ru-RU", "ar"],
      "fallback": { "ru-RU": "ru", "ar": ["ar", "en"] },
      "direction": { "ar": "rtl" },
      "metadata": { "build": "2025-08-27T00:00:00Z" },
      "messages": {
        "login.title": {
          "context": "Заголовок экрана логина",
          "placeholders": {},
          "translations": {
            "en": { "value": "Sign in", "message_format": "plain", "status": "approved" },
            "ru-RU": { "value": "Войти", "message_format": "plain", "status": "approved" }
          }
        },
        "inbox.unread_count": {
          "context": "Счётчик непрочитанных",
          "placeholders": {
            "count": { "type": "number", "format": "number", "required": true, "description": "Количество писем" }
          },
          "translations": {
            "en": {
              "value": "{count, plural, one {# unread message} other {# unread messages}}",
              "message_format": "icu",
              "status": "approved"
            },
            "ru-RU": {
              "value": "{count, plural, one {# непрочитанное сообщение} few {# непрочитанных сообщения} many {# непрочитанных сообщений} other {# непрочитанных сообщений}}",
              "message_format": "icu",
              "status": "review"
            }
          },
          "source": [{ "file": "web/src/components/Inbox.tsx", "line": 42 }]
        }
      }
    }
  ]
}
