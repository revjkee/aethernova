{
  "$id": "https://schemas.mythos.example.com/jsonschema/v1/timeline.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Mythos Timeline (v1)",
  "description": "Каноническая схема ленты событий (timeline) для Mythos Core. Все даты — UTC ISO 8601 (format: date-time). UUID — v4. Храните бинарные вложения вне JSON (URI), inline — только для малых полезных нагрузок.",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "id", "title", "createdAt", "updatedAt", "events"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "title": "Версия схемы",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(?:-[0-9A-Za-z.-]+)?(?:\\+[0-9A-Za-z.-]+)?$",
      "const": "1.0.0"
    },
    "id": { "$ref": "#/$defs/uuidV4" },
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200
    },
    "description": {
      "type": "string",
      "maxLength": 2000
    },
    "labels": {
      "type": "object",
      "description": "Ключ-значение для фильтрации/поиска.",
      "propertyNames": { "$ref": "#/$defs/labelKey" },
      "additionalProperties": {
        "type": "string",
        "maxLength": 128
      }
    },
    "participants": {
      "type": "array",
      "items": { "$ref": "#/$defs/actor" },
      "uniqueItems": true,
      "maxItems": 2000
    },
    "createdAt": { "$ref": "#/$defs/timestamp" },
    "updatedAt": { "$ref": "#/$defs/timestamp" },
    "attributes": {
      "type": "object",
      "description": "Нестабильные/вторичные атрибуты. Старайтесь держать небольшой объём.",
      "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
    },
    "events": {
      "type": "array",
      "description": "Список событий по времени. Сортировку и монотоничность обеспечивайте на стороне сервера.",
      "minItems": 0,
      "maxItems": 100000,
      "items": { "$ref": "#/$defs/event" }
    },
    "page": {
      "type": "object",
      "description": "Опциональный блок пагинации при частичной выдаче.",
      "additionalProperties": false,
      "properties": {
        "cursor": { "type": "string", "maxLength": 512 },
        "nextCursor": { "type": "string", "maxLength": 512 },
        "hasMore": { "type": "boolean" },
        "pageSize": { "type": "integer", "minimum": 1, "maximum": 1000 }
      }
    }
  },

  "$defs": {
    "uuidV4": {
      "title": "UUID v4",
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "timestamp": {
      "title": "ISO 8601 timestamp (UTC)",
      "type": "string",
      "format": "date-time",
      "$comment": "Проверяйте монотоничность createdAt <= updatedAt и упорядочение событий на уровне бизнес-логики."
    },
    "labelKey": {
      "type": "string",
      "pattern": "^[a-z0-9_.:-]{1,64}$"
    },
    "mime": {
      "type": "string",
      "pattern": "^[a-z0-9][a-z0-9!#$&^_.+-]{0,126}/[a-z0-9][a-z0-9!#$&^_.+-]{0,126}$"
    },
    "sha256Hex": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    },
    "url": {
      "type": "string",
      "format": "uri",
      "maxLength": 2048
    },
    "traceId": {
      "type": "string",
      "pattern": "^[0-9a-f]{32}$"
    },
    "spanId": {
      "type": "string",
      "pattern": "^[0-9a-f]{16}$"
    },

    "actor": {
      "title": "Участник",
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "displayName"],
      "properties": {
        "id": { "$ref": "#/$defs/uuidV4" },
        "displayName": { "type": "string", "minLength": 1, "maxLength": 200 },
        "role": { "type": "string", "maxLength": 64, "pattern": "^[a-z0-9_.:-]+$" },
        "attributes": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      }
    },

    "attachment": {
      "title": "Вложение",
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "filename", "mimeType", "sizeBytes"],
      "properties": {
        "id": { "$ref": "#/$defs/uuidV4" },
        "filename": { "type": "string", "minLength": 1, "maxLength": 255 },
        "mimeType": { "$ref": "#/$defs/mime" },
        "sizeBytes": { "type": "integer", "minimum": 0 },
        "sha256Hex": { "$ref": "#/$defs/sha256Hex" },
        "uri": { "$ref": "#/$defs/url" },
        "content": {
          "type": "string",
          "contentEncoding": "base64",
          "contentMediaType": "application/octet-stream",
          "maxLength": 10485760,
          "$comment": "Inline-контент до ~10MiB; лучше использовать внешние URI."
        },
        "metadata": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      },
      "oneOf": [
        { "required": ["uri"] },
        { "required": ["content", "sha256Hex"] }
      ]
    },

    "tokenUsage": {
      "title": "Учёт токенов",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "promptTokens": { "type": "integer", "minimum": 0 },
        "completionTokens": { "type": "integer", "minimum": 0 },
        "totalTokens": { "type": "integer", "minimum": 0 }
      }
    },

    "safetyLabel": {
      "title": "Метка безопасности",
      "type": "object",
      "additionalProperties": false,
      "required": ["policy", "severity"],
      "properties": {
        "policy": { "type": "string", "minLength": 1, "maxLength": 100 },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "tags": {
          "type": "array",
          "items": { "type": "string", "maxLength": 64 },
          "uniqueItems": true,
          "maxItems": 64
        },
        "reason": { "type": "string", "maxLength": 500 },
        "details": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      }
    },

    "event": {
      "title": "Событие",
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "occurredAt"],
      "properties": {
        "id": { "$ref": "#/$defs/uuidV4" },
        "type": {
          "type": "string",
          "enum": [
            "message_posted",
            "status_changed",
            "label_added",
            "label_removed",
            "attachment_uploaded",
            "attachment_removed",
            "tool_called",
            "tool_result",
            "system_note"
          ]
        },
        "occurredAt": { "$ref": "#/$defs/timestamp" },
        "actorId": { "$ref": "#/$defs/uuidV4" },
        "actor": { "$ref": "#/$defs/actor" },
        "parentEventId": { "$ref": "#/$defs/uuidV4" },
        "traceId": { "$ref": "#/$defs/traceId" },
        "spanId": { "$ref": "#/$defs/spanId" },

        "content": {
          "description": "Тело события, зависит от типа.",
          "oneOf": [
            { "$ref": "#/$defs/eventContentText" },
            { "$ref": "#/$defs/eventContentData" },
            { "$ref": "#/$defs/eventContentLink" }
          ]
        },

        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/attachment" },
          "uniqueItems": true,
          "maxItems": 64
        },

        "status": {
          "type": "string",
          "enum": ["planned", "in_progress", "done", "archived", "blocked"]
        },

        "labels": {
          "type": "object",
          "propertyNames": { "$ref": "#/$defs/labelKey" },
          "additionalProperties": { "type": "string", "maxLength": 128 }
        },

        "safety": {
          "type": "array",
          "items": { "$ref": "#/$defs/safetyLabel" },
          "uniqueItems": true,
          "maxItems": 32
        },

        "usage": { "$ref": "#/$defs/tokenUsage" },

        "tags": {
          "type": "array",
          "items": { "type": "string", "maxLength": 64 },
          "uniqueItems": true,
          "maxItems": 64
        },

        "attributes": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean", "null"] }
        }
      },

      "allOf": [
        {
          "if": { "properties": { "type": { "const": "status_changed" } }, "required": ["type"] },
          "then": { "required": ["status"] }
        },
        {
          "if": { "properties": { "type": { "const": "message_posted" } }, "required": ["type"] },
          "then": { "required": ["content"] }
        },
        {
          "if": { "properties": { "type": { "const": "tool_called" } }, "required": ["type"] },
          "then": {
            "properties": {
              "content": { "$ref": "#/$defs/eventContentData" }
            },
            "required": ["content"]
          }
        },
        {
          "if": { "properties": { "type": { "const": "tool_result" } }, "required": ["type"] },
          "then": {
            "properties": {
              "content": { "$ref": "#/$defs/eventContentData" }
            },
            "required": ["content"]
          }
        }
      ]
    },

    "eventContentText": {
      "title": "Текстовое содержимое",
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "text"],
      "properties": {
        "kind": { "const": "text" },
        "text": { "type": "string", "minLength": 1, "maxLength": 8000 },
        "lang": {
          "type": "string",
          "description": "BCP-47 (например, en, ru, en-US)",
          "pattern": "^[a-zA-Z]{2,3}(?:-[a-zA-Z0-9]{2,8})*$"
        }
      }
    },

    "eventContentData": {
      "title": "Структурированные данные",
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "data"],
      "properties": {
        "kind": { "const": "data" },
        "data": {
          "type": "object",
          "description": "JSON-объект произвольной структуры. Ограничивайте объём на уровне API."
        }
      }
    },

    "eventContentLink": {
      "title": "Ссылка",
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "url"],
      "properties": {
        "kind": { "const": "link" },
        "url": { "$ref": "#/$defs/url" },
        "title": { "type": "string", "maxLength": 200 }
      }
    }
  },

  "examples": [
    {
      "schemaVersion": "1.0.0",
      "id": "4a1d1f8e-8e35-4e19-8c1a-6f1f6b1e7a11",
      "title": "Dialogue #42",
      "description": "Пример таймлайна с двумя событиями.",
      "labels": { "project": "alpha", "env": "staging" },
      "participants": [
        { "id": "a1a1a1a1-a1a1-4a1a-a1a1-a1a1a1a1a1a1", "displayName": "User A", "role": "owner" },
        { "id": "b2b2b2b2-b2b2-4b2b-b2b2-b2b2b2b2b2b2", "displayName": "Assistant", "role": "assistant" }
      ],
      "createdAt": "2025-08-27T10:00:00Z",
      "updatedAt": "2025-08-27T10:05:00Z",
      "events": [
        {
          "id": "11111111-2222-4aaa-8bbb-cccccccccccc",
          "type": "message_posted",
          "occurredAt": "2025-08-27T10:01:00Z",
          "actorId": "a1a1a1a1-a1a1-4a1a-a1a1-a1a1a1a1a1a1",
          "content": { "kind": "text", "text": "Привет, мир!", "lang": "ru" },
          "tags": ["greeting"]
        },
        {
          "id": "22222222-3333-4bbb-8ccc-dddddddddddd",
          "type": "status_changed",
          "occurredAt": "2025-08-27T10:04:30Z",
          "actor": { "id": "b2b2b2b2-b2b2-4b2b-b2b2-b2b2b2b2b2b2", "displayName": "Assistant" },
          "status": "in_progress",
          "safety": [
            { "policy": "content_moderation", "severity": "low", "tags": ["pii:false"] }
          ]
        }
      ]
    }
  ]
}
