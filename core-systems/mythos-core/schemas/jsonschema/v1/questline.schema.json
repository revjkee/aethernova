{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.aethernova.dev/mythos-core/jsonschema/v1/questline.schema.json",
  "title": "Mythos Core Questline Schema (v1)",
  "type": "object",
  "description": "Формат описания сюжетной линии (questline) с ветвлениями для Mythos Core.",
  "additionalProperties": false,
  "patternProperties": {
    "^x-": {}
  },
  "required": ["schemaVersion", "kind", "id", "namespace", "name", "version", "display", "quests", "edges", "startQuestIds"],
  "properties": {
    "schemaVersion": {
      "type": "integer",
      "const": 1,
      "description": "Версия схемы файла. Для несовместимых изменений увеличивается."
    },
    "kind": {
      "type": "string",
      "const": "questline",
      "description": "Тип сущности."
    },
    "id": {
      "description": "Глобальный идентификатор (UUID/ULID).",
      "oneOf": [
        { "type": "string", "format": "uuid" },
        { "type": "string", "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$" }
      ]
    },
    "tenantId": {
      "description": "Опциональный идентификатор арендатора.",
      "oneOf": [
        { "type": "string", "format": "uuid" },
        { "type": "string", "maxLength": 128 }
      ]
    },
    "namespace": {
      "type": "string",
      "description": "Логическое пространство имён.",
      "minLength": 1,
      "maxLength": 100,
      "pattern": "^[a-z0-9]([a-z0-9._-]{0,98}[a-z0-9])?$"
    },
    "name": {
      "type": "string",
      "description": "Кодовое имя (slug) сюжетной линии в пределах namespace.",
      "minLength": 1,
      "maxLength": 100,
      "pattern": "^[a-z0-9]([a-z0-9._-]{0,98}[a-z0-9])?$"
    },
    "display": {
      "type": "object",
      "description": "Отображаемые строки с локализацией.",
      "additionalProperties": false,
      "required": ["title", "summary"],
      "properties": {
        "title": { "$ref": "#/$defs/localeString" },
        "summary": { "$ref": "#/$defs/localeString" },
        "description": { "$ref": "#/$defs/localeString" },
        "icon": { "type": "string", "format": "uri", "description": "URI иконки." },
        "banner": { "type": "string", "format": "uri", "description": "URI баннера." }
      }
    },
    "labels": {
      "type": "object",
      "description": "Короткие метки для поиска/политик.",
      "propertyNames": { "pattern": "^[a-z0-9_.-]{1,63}$" },
      "additionalProperties": { "type": "string", "maxLength": 256 }
    },
    "tags": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 64 },
      "uniqueItems": true,
      "maxItems": 128
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Монотонная версия контента."
    },
    "etag": {
      "type": "string",
      "description": "ETag для контроля конкурентных изменений.",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9._~+\\/-=]{1,128}$"
    },
    "lifecycle": {
      "type": "string",
      "description": "Жизненный цикл.",
      "enum": ["DRAFT", "ACTIVE", "DEPRECATED", "ARCHIVED"]
    },
    "owner": {
      "type": "string",
      "description": "Владелец/ответственный (UID/email/subject).",
      "maxLength": 320
    },
    "createdAt": { "type": "string", "format": "date-time" },
    "updatedAt": { "type": "string", "format": "date-time" },
    "externalRefs": {
      "type": "object",
      "description": "Внешние ссылки и ключи.",
      "propertyNames": { "pattern": "^[a-z0-9_.-]{1,63}$" },
      "additionalProperties": { "type": "string", "maxLength": 2048 }
    },

    "telemetry": {
      "type": "object",
      "description": "Ключи для телеметрии/аналитики.",
      "additionalProperties": false,
      "properties": {
        "eventKeys": {
          "type": "array",
          "items": { "type": "string", "maxLength": 128 },
          "uniqueItems": true,
          "maxItems": 64
        }
      }
    },

    "startQuestIds": {
      "type": "array",
      "description": "Начальные квесты (минимум один).",
      "minItems": 1,
      "items": { "$ref": "#/$defs/idRef" },
      "uniqueItems": true
    },
    "endQuestIds": {
      "type": "array",
      "description": "Опционально: финальные квесты (терминальные узлы).",
      "items": { "$ref": "#/$defs/idRef" },
      "uniqueItems": true
    },

    "quests": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/quest" },
      "uniqueItems": true
    },

    "edges": {
      "type": "array",
      "description": "Граф переходов между квестами.",
      "items": { "$ref": "#/$defs/edge" },
      "maxItems": 10000
    }
  },

  "$defs": {
    "languageTag": {
      "type": "string",
      "description": "IETF BCP 47 language tag.",
      "pattern": "^[A-Za-z]{2,3}(-[A-Za-z0-9]{2,8})*$"
    },
    "localeString": {
      "type": "object",
      "description": "Строка по умолчанию + локализации.",
      "additionalProperties": false,
      "required": ["default"],
      "properties": {
        "default": { "type": "string", "minLength": 1, "maxLength": 2000 },
        "locales": {
          "type": "object",
          "description": "Переводы по тегам языка.",
          "propertyNames": { "$ref": "#/$defs/languageTag" },
          "additionalProperties": { "type": "string", "minLength": 1, "maxLength": 2000 }
        }
      }
    },
    "idRef": {
      "description": "Ссылочный идентификатор квеста.",
      "oneOf": [
        { "type": "string", "format": "uuid" },
        { "type": "string", "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{0,62}$" }
      ]
    },
    "reward": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["ITEM", "CURRENCY", "XP", "BADGE", "CUSTOM"]
        },
        "amount": { "type": "number", "exclusiveMinimum": 0 },
        "itemId": { "type": "string", "maxLength": 128 },
        "currency": { "type": "string", "maxLength": 32 },
        "badgeCode": { "type": "string", "maxLength": 64 },
        "data": { "type": "object", "additionalProperties": true }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "ITEM" } } },
          "then": { "required": ["itemId", "amount"] }
        },
        {
          "if": { "properties": { "type": { "const": "CURRENCY" } } },
          "then": { "required": ["currency", "amount"] }
        },
        {
          "if": { "properties": { "type": { "const": "XP" } } },
          "then": { "required": ["amount"] }
        },
        {
          "if": { "properties": { "type": { "const": "BADGE" } } },
          "then": { "required": ["badgeCode"] }
        }
      ]
    },
    "condition": {
      "type": "object",
      "description": "Условие допуска/выполнения/фейла.",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "LEVEL_AT_LEAST",
            "OWNS_ITEM",
            "COMPLETED_QUEST",
            "TIME_WINDOW",
            "CHOICE_TAKEN",
            "CUSTOM"
          ]
        },
        "negate": { "type": "boolean", "default": false },
        "data": { "type": "object", "additionalProperties": true }
      },
      "oneOf": [
        {
          "title": "LEVEL_AT_LEAST",
          "properties": { "type": { "const": "LEVEL_AT_LEAST" }, "level": { "type": "integer", "minimum": 1 } },
          "required": ["type", "level"]
        },
        {
          "title": "OWNS_ITEM",
          "properties": {
            "type": { "const": "OWNS_ITEM" },
            "itemId": { "type": "string", "minLength": 1 },
            "amount": { "type": "number", "exclusiveMinimum": 0 }
          },
          "required": ["type", "itemId"]
        },
        {
          "title": "COMPLETED_QUEST",
          "properties": { "type": { "const": "COMPLETED_QUEST" }, "questId": { "$ref": "#/$defs/idRef" } },
          "required": ["type", "questId"]
        },
        {
          "title": "TIME_WINDOW",
          "properties": {
            "type": { "const": "TIME_WINDOW" },
            "from": { "type": "string", "format": "date-time" },
            "to": { "type": "string", "format": "date-time" }
          },
          "required": ["type", "from", "to"]
        },
        {
          "title": "CHOICE_TAKEN",
          "properties": {
            "type": { "const": "CHOICE_TAKEN" },
            "edgeId": { "type": "string", "maxLength": 128 }
          },
          "required": ["type", "edgeId"]
        },
        {
          "title": "CUSTOM",
          "properties": {
            "type": { "const": "CUSTOM" },
            "expr": { "type": "string", "minLength": 1, "maxLength": 2000 },
            "engine": { "type": "string", "enum": ["CEL", "JS", "WASM", "SQL"], "default": "CEL" }
          },
          "required": ["type", "expr"]
        }
      ]
    },
    "objective": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "title"],
      "properties": {
        "id": { "$ref": "#/$defs/idRef" },
        "type": {
          "type": "string",
          "enum": ["COLLECT", "KILL", "TRAVEL", "INTERACT", "REACH_SCORE", "CUSTOM"]
        },
        "title": { "$ref": "#/$defs/localeString" },
        "optional": { "type": "boolean", "default": false },
        "track": { "type": "boolean", "default": true },
        "count": { "type": "number", "minimum": 1, "default": 1 },
        "targetId": { "type": "string", "maxLength": 128 },
        "targetUri": { "type": "string", "format": "uri" },
        "timeLimit": { "type": "string", "format": "duration" },
        "area": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "worldId": { "type": "string", "maxLength": 64 },
            "position": {
              "type": "object",
              "additionalProperties": false,
              "required": ["x", "y", "z"],
              "properties": {
                "x": { "type": "number" },
                "y": { "type": "number" },
                "z": { "type": "number" }
              }
            },
            "radius": { "type": "number", "exclusiveMinimum": 0 }
          }
        },
        "expr": { "type": "string", "description": "Опциональное выражение проверки для CUSTOM." },
        "data": { "type": "object", "additionalProperties": true }
      }
    },
    "quest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "key", "display", "objectives"],
      "properties": {
        "id": { "$ref": "#/$defs/idRef" },
        "key": {
          "type": "string",
          "description": "Уникальный ключ квеста в пределах линии.",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[A-Za-z0-9]([A-Za-z0-9._-]{0,62})$"
        },
        "display": {
          "type": "object",
          "additionalProperties": false,
          "required": ["title"],
          "properties": {
            "title": { "$ref": "#/$defs/localeString" },
            "summary": { "$ref": "#/$defs/localeString" },
            "description": { "$ref": "#/$defs/localeString" },
            "icon": { "type": "string", "format": "uri" }
          }
        },
        "level": { "type": "integer", "minimum": 1 },
        "prerequisites": {
          "type": "array",
          "items": { "$ref": "#/$defs/condition" },
          "uniqueItems": false,
          "maxItems": 64
        },
        "failConditions": {
          "type": "array",
          "items": { "$ref": "#/$defs/condition" },
          "maxItems": 32
        },
        "objectives": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/objective" }
        },
        "rewards": {
          "type": "array",
          "items": { "$ref": "#/$defs/reward" },
          "maxItems": 64
        },
        "repeatable": { "type": "boolean", "default": false },
        "cooldown": { "type": "string", "format": "duration", "description": "Минимальный интервал перед повторным выполнением для repeatable." },
        "timeLimit": { "type": "string", "format": "duration" },
        "data": { "type": "object", "additionalProperties": true }
      }
    },
    "edge": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "from", "to", "type"],
      "properties": {
        "id": { "type": "string", "maxLength": 128 },
        "from": { "$ref": "#/$defs/idRef" },
        "to": { "$ref": "#/$defs/idRef" },
        "type": {
          "type": "string",
          "enum": ["SEQUENTIAL", "CHOICE", "RANDOM", "PARALLEL_GATE", "CONDITIONAL"]
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "description": "Вес для RANDOM; игнорируется в иных типах."
        },
        "condition": { "$ref": "#/$defs/condition" },
        "gate": {
          "type": "object",
          "description": "Параллельные ворота: ALL/ANY для завершения веток.",
          "additionalProperties": false,
          "properties": {
            "mode": { "type": "string", "enum": ["ALL", "ANY"], "default": "ALL" },
            "timeout": { "type": "string", "format": "duration" }
          }
        },
        "data": { "type": "object", "additionalProperties": true }
      }
    }
  },

  "$comment": "Кросс-ссылочная целостность (edges.from/to должны существовать среди quests.id) проверяется на уровне сервисной валидации.",
  "examples": [
    {
      "schemaVersion": 1,
      "kind": "questline",
      "id": "2b9a0f7c-7c0d-4e93-9b8c-1a6d3a0ef001",
      "namespace": "main",
      "name": "intro_line",
      "version": 3,
      "etag": "W/\"v3-abc123\"",
      "lifecycle": "ACTIVE",
      "display": {
        "title": { "default": "Вступительная линия", "locales": { "en-US": "Intro Questline" } },
        "summary": { "default": "Базовые механики." }
      },
      "startQuestIds": ["q-start"],
      "quests": [
        {
          "id": "q-start",
          "key": "start",
          "display": { "title": { "default": "Первый шаг" } },
          "objectives": [
            { "id": "obj-1", "type": "INTERACT", "title": { "default": "Поговорите с наставником" } }
          ],
          "rewards": [{ "type": "XP", "amount": 100 }]
        },
        {
          "id": "q-fight",
          "key": "fight",
          "display": { "title": { "default": "Проверка силы" } },
          "prerequisites": [{ "type": "COMPLETED_QUEST", "questId": "q-start" }],
          "objectives": [
            { "id": "obj-2", "type": "KILL", "count": 5, "title": { "default": "Победите 5 големов" }, "targetId": "golem" }
          ],
          "rewards": [{ "type": "ITEM", "itemId": "potion_small", "amount": 2 }]
        }
      ],
      "edges": [
        { "id": "e1", "from": "q-start", "to": "q-fight", "type": "SEQUENTIAL" }
      ]
    }
  ]
}
