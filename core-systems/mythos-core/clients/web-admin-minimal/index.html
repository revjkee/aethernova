<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8">
  <title>Mythos Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <meta name="robots" content="noindex,nofollow">
  <meta name="referrer" content="same-origin">
  <!-- CSP для single-file. Для продакшена лучше дублировать политикой на сервере -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';
                 img-src 'self' data:; font-src 'self' data:; connect-src 'self';
                 frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
  <style>
    :root {
      --bg: #0b0c10;
      --bg-elev: #111218;
      --fg: #e6e7eb;
      --muted: #9aa3af;
      --brand: #4f46e5;
      --brand-600: #4338ca;
      --accent: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --border: #2a2f3a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --radius-sm: 10px;
      --pad: 14px;
      --pad-lg: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light) {
      :root[data-theme="auto"] {
        --bg: #f6f7fb; --bg-elev: #fff; --fg: #16181d; --muted:#5b616e;
        --border:#e6e8ef; --shadow: 0 10px 30px rgba(10,10,10,.06);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: var(--font); background: var(--bg); color: var(--fg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    a { color: var(--brand); text-decoration: none; }
    a:focus, button:focus, input:focus, select:focus, textarea:focus { outline: 2px solid var(--brand); outline-offset: 2px; }
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas: "sidebar header" "sidebar main";
      min-height: 100%;
    }
    header {
      grid-area: header; display:flex; align-items:center; justify-content:space-between;
      padding: var(--pad) var(--pad-lg); background: var(--bg-elev); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
    }
    .sidebar {
      grid-area: sidebar; background: var(--bg-elev); border-right: 1px solid var(--border);
      padding: var(--pad-lg) var(--pad);
      position: sticky; top: 0; height: 100dvh; overflow: auto;
    }
    main { grid-area: main; padding: var(--pad-lg); }
    .brand { display:flex; align-items:center; gap: 10px; font-weight: 700; }
    .brand svg { width: 26px; height: 26px; }
    .nav { list-style:none; padding:0; margin: 18px 0 0 0; display:flex; flex-direction:column; gap:6px; }
    .nav a { display:flex; align-items:center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-sm); color: var(--fg); }
    .nav a[aria-current="page"], .nav a:hover { background: var(--border); }
    .pill { background: var(--border); border-radius: 999px; padding: 6px 10px; font-size: 12px; color: var(--muted); }
    .btn {
      display:inline-flex; align-items:center; gap:10px; padding: 10px 14px; border: 1px solid var(--border);
      border-radius: var(--radius-sm); background: var(--bg-elev); color: var(--fg); cursor: pointer;
      transition: transform .02s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--brand); border-color: var(--brand-600); color: #fff; }
    .btn.ghost { background: transparent; }
    .btn.danger { background: var(--danger); border-color: #b91c1c; color: #fff; }
    .grid { display:grid; gap: 16px; }
    .card {
      background: var(--bg-elev); border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card > .card-hd { padding: var(--pad-lg); border-bottom: 1px solid var(--border); font-weight: 600; }
    .card > .card-bd { padding: var(--pad-lg); }
    .toolbar { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .input, .select {
      background: var(--bg); border:1px solid var(--border); color: var(--fg);
      padding: 10px 12px; border-radius: var(--radius-sm);
    }
    .muted { color: var(--muted); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    th { text-align:left; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .03em; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: var(--border); padding: 2px 6px; border-radius: 6px; }
    .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot-ok { background: var(--accent); } .dot-warn { background: var(--warn);} .dot-bad { background: var(--danger);}
    .toast { position: fixed; right: 18px; bottom: 18px; display:flex; flex-direction:column; gap:10px; z-index: 1000; }
    .toast > div { background: var(--bg-elev); border:1px solid var(--border); padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow); }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index: 900; }
    .modal { width: min(640px, 92vw); background: var(--bg-elev); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .modal .card-hd { display:flex; align-items:center; justify-content:space-between; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    .login {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: var(--bg);
    }
    .login .box { width: min(420px, 92vw); }
    .sep { height:1px; background: var(--border); margin: 8px 0; }
    @media (max-width: 980px) { .app { grid-template-columns: 1fr; grid-template-areas: "header" "main"; } .sidebar{ position: static; height:auto; display:none;} }
    noscript .app { display:none; }
    noscript .nojs { display:block; padding: 24px; }
  </style>
</head>
<body>
<noscript>
  <div class="nojs">
    Для работы интерфейса требуется JavaScript.
  </div>
</noscript>

<div id="app" class="app" data-testid="app-root" aria-busy="true" aria-live="polite">
  <aside class="sidebar" id="sidebar" aria-label="Навигация">
    <div class="brand" aria-label="Бренд">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V6l8-4z"/></svg>
      <span>Mythos Admin</span>
    </div>
    <div style="margin-top:14px;">
      <span class="pill" id="env-pill" title="Текущее окружение">env: local</span>
    </div>
    <ul class="nav" role="navigation">
      <li><a href="#/dashboard" data-link="dashboard" aria-current="page"><span>Панель</span></a></li>
      <li><a href="#/users" data-link="users"><span>Пользователи</span></a></li>
    </ul>
    <div class="sep"></div>
    <div class="toolbar" style="margin-top:10px;">
      <button class="btn" id="theme-toggle" type="button" aria-pressed="false" title="Переключить тему">
        <span id="theme-label">Тема</span>
      </button>
      <button class="btn ghost" id="logout-btn" type="button" title="Выйти">Выйти</button>
    </div>
  </aside>

  <header>
    <div>
      <span class="muted">Админ-панель</span>
    </div>
    <div class="toolbar">
      <span class="muted" id="status-indicator">
        <span class="status-dot dot-warn" aria-hidden="true"></span>
        API: неизвестно
      </span>
    </div>
  </header>

  <main id="main" tabindex="-1">
    <!-- Вьюхи будут подставляться сюда -->
  </main>
</div>

<!-- Модальные окна и тосты -->
<div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal card" role="document">
    <div class="card-hd">
      <div id="modal-title">Заголовок</div>
      <button class="btn ghost" id="modal-close" type="button" aria-label="Закрыть">✕</button>
    </div>
    <div class="card-bd" id="modal-body"></div>
  </div>
</div>
<div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

<!-- Экран логина -->
<div class="login" id="login-screen" aria-hidden="true">
  <div class="card box">
    <div class="card-hd">Вход</div>
    <div class="card-bd">
      <form id="login-form" autocomplete="on">
        <div class="grid" style="grid-template-columns: 1fr; gap: 12px;">
          <label>
            <div class="muted">Email</div>
            <input class="input" type="email" name="email" required inputmode="email" autocomplete="username" placeholder="admin@example.com">
          </label>
          <label>
            <div class="muted">Пароль</div>
            <input class="input" type="password" name="password" required minlength="8" autocomplete="current-password" placeholder="Введите пароль">
          </label>
          <button class="btn primary" type="submit">Войти</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Конфигурация приложения, может быть перезаписана сервером -->
<script type="application/json" id="app-config">
{
  "env": "local",
  "apiBase": "/api",
  "usersPageSize": 10,
  "telemetry": { "console": true }
}
</script>

<script type="module">
/*
  Mythos Admin - минимальный, промышленный single-file клиент
  Архитектура:
  - Router (hash) и ViewRenderer
  - API-клиент с ретраями/бекоффом, обработчиком 401 и JSON-схемой ошибок
  - Store для сессии/настроек (localStorage + memory)
  - Виджеты: Toast, Modal
  - Вьюхи: Dashboard, Users
  - I18n (RU/EN скелет)
  - SW-регистрация (офлайн кэш index)
*/

/* ====================== УТИЛИТЫ ====================== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const escapeHtml = (s) => String(s)
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#39;");

function h(tag, attrs={}, children=[]) {
  const el = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs || {})) {
    if (v == null) continue;
    if (k === "class") el.className = v;
    else if (k === "dataset") Object.assign(el.dataset, v);
    else if (k.startsWith("aria-") || k === "role") el.setAttribute(k, String(v));
    else if (k === "html") el.innerHTML = String(v); // используйте осторожно, только с доверенными шаблонами
    else el.setAttribute(k, String(v));
  }
  for (const ch of [].concat(children)) {
    if (ch == null) continue;
    if (typeof ch === "string") el.appendChild(document.createTextNode(ch));
    else el.appendChild(ch);
  }
  return el;
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function backoff(attempt, base=250, cap=4000){ return Math.min(cap, base * Math.pow(2, Math.max(0, attempt-1))) * (0.5 + Math.random()); }

/* ====================== I18N ====================== */
const i18n = {
  lang: "ru",
  dict: {
    ru: {
      dashboard: "Панель",
      users: "Пользователи",
      loading: "Загрузка…",
      api_unknown: "неизвестно",
      api_ok: "доступен",
      api_fail: "недоступен",
      search: "Поиск",
      per_page: "на странице",
      total: "всего",
      signout_ok: "Вы вышли из системы",
      login_fail: "Ошибка входа",
      user_removed: "Пользователь удалён",
      confirm: "Подтвердите действие"
    },
    en: {
      dashboard: "Dashboard",
      users: "Users",
      loading: "Loading…",
      api_unknown: "unknown",
      api_ok: "online",
      api_fail: "offline",
      search: "Search",
      per_page: "per page",
      total: "total",
      signout_ok: "Signed out",
      login_fail: "Login failed",
      user_removed: "User removed",
      confirm: "Please confirm"
    }
  },
  t(key){ return (this.dict[this.lang] && this.dict[this.lang][key]) || key; }
};

/* ====================== STORE ====================== */
const Store = (() => {
  const k = {
    theme: "mythos.theme",
    token: "mythos.token",
    cfg:   "mythos.cfg"
  };
  const cfgNode = $("#app-config");
  let cfg = {};
  try { cfg = JSON.parse(cfgNode.textContent || "{}"); } catch { cfg = {}; }
  localStorage.setItem(k.cfg, JSON.stringify(cfg));
  const themeC = document.documentElement;
  return {
    cfg(){ return JSON.parse(localStorage.getItem(k.cfg) || "{}"); },
    setTheme(mode){ localStorage.setItem(k.theme, mode); themeC.dataset.theme = mode; },
    theme(){ return localStorage.getItem(k.theme) || "auto"; },
    token(v){ if (v === undefined) return localStorage.getItem(k.token); if (v===null) localStorage.removeItem(k.token); else localStorage.setItem(k.token, v); }
  };
})();

/* ====================== TOAST & MODAL ====================== */
const Toast = (() => {
  const root = $("#toast");
  function show(msg, kind="info", ttl=3000) {
    const box = h("div", { class: `toast-${kind}` }, [String(msg)]);
    root.appendChild(box);
    setTimeout(()=>box.remove(), ttl);
  }
  return { show };
})();
const Modal = (() => {
  const backdrop = $("#modal-backdrop");
  const title = $("#modal-title");
  const body = $("#modal-body");
  const btnClose = $("#modal-close");
  btnClose.addEventListener("click", close);
  backdrop.addEventListener("click", (e)=> { if (e.target === backdrop) close(); });
  function open({title: t, content}) {
    title.textContent = t || "";
    body.innerHTML = "";
    body.append(content instanceof HTMLElement ? "" : "");
    if (content instanceof HTMLElement) body.appendChild(content);
    else body.innerHTML = String(content);
    backdrop.style.display = "flex";
    backdrop.setAttribute("aria-hidden", "false");
    $("#modal-close").focus();
  }
  function close() {
    backdrop.style.display = "none";
    backdrop.setAttribute("aria-hidden", "true");
  }
  return { open, close };
})();

/* ====================== API-КЛИЕНТ ====================== */
const Api = (() => {
  const base = Store.cfg().apiBase || "/api";
  const statusEl = $("#status-indicator");

  async function raw(path, {method="GET", body, headers, retries=3, idempotent=true}={}) {
    const url = path.startsWith("http") ? path : base + path;
    const token = Store.token();
    const h = { "Accept":"application/json", "Content-Type":"application/json", ...(headers||{}) };
    if (token) h["Authorization"] = "Bearer " + token;
    for (let attempt=1; attempt<=Math.max(0,retries)+1; attempt++) {
      try {
        const res = await fetch(url, { method, headers: h, body, credentials:"same-origin" });
        if (res.status === 401) {
          Store.token(null);
          Router.go("#/login");
          throw new Error("unauthorized");
        }
        if (!res.ok) {
          const problem = await safeJson(res);
          const err = new Error(problem?.message || `HTTP ${res.status}`);
          err.status = res.status; err.details = problem;
          throw err;
        }
        const data = await safeJson(res);
        setStatus(true);
        return data;
      } catch (e) {
        if (e.message === "unauthorized") throw e;
        setStatus(false);
        const retriable = idempotent && (e.status === 429 || (e.status >= 500 || e.status === undefined));
        if (attempt <= retries && retriable) await sleep(backoff(attempt));
        else throw e;
      }
    }
  }
  async function safeJson(res){ try { return await res.json(); } catch { return null; } }

  function setStatus(ok) {
    if (!statusEl) return;
    if (ok === true) { statusEl.innerHTML = `<span class="status-dot dot-ok"></span>API: ${escapeHtml(i18n.t("api_ok"))}`; }
    else if (ok === false) { statusEl.innerHTML = `<span class="status-dot dot-bad"></span>API: ${escapeHtml(i18n.t("api_fail"))}`; }
    else { statusEl.innerHTML = `<span class="status-dot dot-warn"></span>API: ${escapeHtml(i18n.t("api_unknown"))}`; }
  }

  // Бизнес-методы
  const auth = {
    async login(email, password){
      const data = await raw("/auth/login", {method:"POST", body: JSON.stringify({email, password}), retries: 0, idempotent:false});
      if (!data?.token) throw new Error("bad_token");
      Store.token(data.token);
      return data;
    },
    async logout(){ try { await raw("/auth/logout", {method:"POST", retries:0, idempotent:false}); } catch {} Store.token(null); }
  };
  const users = {
    async list({q="", page=1, limit=Store.cfg().usersPageSize||10}={}){
      const sp = new URLSearchParams({ q, page:String(page), limit:String(limit) });
      return await raw(`/users?${sp.toString()}`, {method:"GET"});
    },
    async remove(id){ return await raw(`/users/${encodeURIComponent(id)}`, {method:"DELETE", retries:0, idempotent:false}); }
  };

  // Публичный API
  return { auth, users, setStatus };
})();

/* ====================== РОУТЕР ====================== */
const Router = (() => {
  const routes = {};
  function on(path, render){ routes[path] = render; }
  async function go(hash){ location.hash = hash; }
  async function handle(){
    const hash = location.hash || "#/dashboard";
    const path = hash.replace(/\?.*$/,"");
    const render = routes[path] || routes["#/404"];
    // защита маршрутов
    if (path !== "#/login" && !Store.token()) {
      showLogin(true);
      return;
    } else {
      showLogin(false);
    }
    await render();
    // подсветка активной ссылки
    $$(".nav a").forEach(a => a.setAttribute("aria-current", a.getAttribute("href")===path ? "page" : "false"));
    // фокус в main
    $("#main").focus();
  }
  window.addEventListener("hashchange", handle);
  return { on, go, handle };
})();

/* ====================== ВЬЮХИ ====================== */
const Views = (() => {
  const main = $("#main");

  function skeleton(title){
    return h("div", {class:"grid", style:"grid-template-columns: 1fr;"},
      [
        h("div", {class:"card"},
          [
            h("div", {class:"card-hd"}, [title]),
            h("div", {class:"card-bd"}, [h("div",{class:"muted"}, [i18n.t("loading")])])
          ])
      ]);
  }

  async function dashboard(){
    main.innerHTML = "";
    const wrap = skeleton("Панель");
    main.appendChild(wrap);

    // Пример карточек статуса
    wrap.innerHTML = "";
    wrap.appendChild(
      h("div",{class:"grid",style:"grid-template-columns: repeat(auto-fit, minmax(240px,1fr));"},
        [
          cardStat("Сессия", Store.token() ? "активна" : "нет", "dot-" + (Store.token() ? "ok":"bad")),
          cardStat("Окружение", Store.cfg().env || "unknown", "dot-warn"),
          cardStat("Пользователи", "—", "dot-warn", {id:"stat-users"})
        ])
    );

    // Попробуем получить число пользователей
    try {
      const list = await Api.users.list({page:1, limit:1});
      const el = $("#stat-users");
      if (el) el.querySelector("strong").textContent = String(list?.total ?? "—");
      Api.setStatus(true);
    } catch {
      Api.setStatus(false);
    }
  }

  function cardStat(label, value, dotClass, attrs={}){
    return h("div", {class:"card"},
      [
        h("div",{class:"card-hd"}, [label]),
        h("div",{class:"card-bd", ...attrs}, [
          h("div",{},[
            h("span",{class:`status-dot ${dotClass}`, "aria-hidden":"true"}),
            h("strong",{},[String(value)])
          ])
        ])
      ]);
  }

  async function users(){
    main.innerHTML = "";
    const box = h("div",{class:"grid"});
    main.appendChild(h("div",{class:"card"},[
      h("div",{class:"card-hd"},["Пользователи"]),
      h("div",{class:"card-bd"},[
        toolbar(),
        h("div",{id:"users-table-wrap"})
      ])
    ]));
    const state = { q:"", page:1, limit: Store.cfg().usersPageSize || 10 };

    async function load(){
      const wrap = $("#users-table-wrap");
      wrap.innerHTML = `<div class="muted">${escapeHtml(i18n.t("loading"))}</div>`;
      try{
        const data = await Api.users.list(state);
        wrap.innerHTML = "";
        wrap.appendChild(table(data));
      }catch(e){
        wrap.innerHTML = `<div class="muted">Ошибка загрузки</div>`;
      }
    }

    function toolbar(){
      const search = h("input",{class:"input", placeholder:i18n.t("search"), "aria-label":i18n.t("search")});
      const per = h("select",{class:"select", title:i18n.t("per_page")}, [10,25,50].map(n=>h("option",{value:String(n)},[String(n)])));
      per.value = String(state.limit);
      search.addEventListener("input", debounce(()=>{state.q=search.value; state.page=1; load();}, 300));
      per.addEventListener("change", ()=>{state.limit=Number(per.value); state.page=1; load();});
      return h("div",{class:"toolbar", style:"margin-bottom:10px;"},[
        search, per
      ]);
    }

    function table(data){
      const total = data?.total ?? 0;
      const rows = data?.items ?? [];
      const wrap = h("div");
      const table = h("table",{},[
        h("thead",{},[h("tr",{},[
          h("th",{},["ID"]), h("th",{},["Email"]), h("th",{},["Имя"]), h("th",{},["Роль"]), h("th",{},[""])
        ])]),
        h("tbody",{}, rows.map(u => h("tr",{"data-id":u.id},[
          h("td",{},[u.id]),
          h("td",{},[escapeHtml(u.email||"")]),
          h("td",{},[escapeHtml(u.name||"")]),
          h("td",{},[escapeHtml(u.role||"user")]),
          h("td",{},[
            h("button",{class:"btn danger", type:"button"},["Удалить"])
          ])
        ])))
      ]);
      wrap.appendChild(table);
      // Пагинация
      const pages = Math.max(1, Math.ceil(total / state.limit));
      const pager = h("div",{class:"toolbar",style:"justify-content: space-between; margin-top:10px;"},[
        h("div",{class:"muted"},[`${i18n.t("total")}: ${String(total)}`]),
        h("div",{},[
          h("button",{class:"btn",type:"button",disabled: state.page<=1},["←"]).addEventListener?.("click",()=>{state.page--; load();}),
          h("span",{class:"muted",style:"margin:0 8px;"},[`стр. ${String(state.page)} / ${String(pages)}`]),
          h("button",{class:"btn",type:"button",disabled: state.page>=pages},["→"]).addEventListener?.("click",()=>{state.page++; load();})
        ])
      ]);
      // обработчики удаления
      table.addEventListener("click", async (e)=>{
        const btn = e.target.closest("button.btn.danger");
        if (!btn) return;
        const tr = e.target.closest("tr");
        const id = tr?.getAttribute("data-id");
        if (!id) return;
        if (!confirm(i18n.t("confirm"))) return;
        try { await Api.users.remove(id); Toast.show(i18n.t("user_removed")); load(); }
        catch (err) { Toast.show("Ошибка удаления", "error", 4000); }
      });
      wrap.appendChild(pager);
      return wrap;
    }

    await load();
  }

  return { dashboard, users };
})();

/* ====================== ЛОГИН ====================== */
function showLogin(show){
  const screen = $("#login-screen");
  const app = $("#app");
  if (show) {
    screen.style.display = "flex";
    screen.setAttribute("aria-hidden", "false");
    app.setAttribute("aria-busy","true");
  } else {
    screen.style.display = "none";
    screen.setAttribute("aria-hidden", "true");
    app.removeAttribute("aria-busy");
  }
}
$("#login-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const email = String(fd.get("email")||"");
  const password = String(fd.get("password")||"");
  try {
    await Api.auth.login(email, password);
    Toast.show("OK");
    Router.go("#/dashboard");
  } catch {
    Toast.show(i18n.t("login_fail"), "error", 4000);
  }
});

/* ====================== ТЕМА/ЛОКАЛЬ ====================== */
(function initTheme(){
  const current = Store.theme();
  document.documentElement.dataset.theme = current;
  $("#theme-label").textContent = "Тема: " + current;
})();
$("#theme-toggle").addEventListener("click", ()=>{
  const next = (Store.theme()==="auto") ? "dark" : (Store.theme()==="dark" ? "light":"auto");
  Store.setTheme(next);
  $("#theme-label").textContent = "Тема: " + next;
});

/* ====================== ДЕБОУНС ====================== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ====================== РЕГИСТРАЦИЯ РОУТОВ ====================== */
Router.on("#/dashboard", Views.dashboard);
Router.on("#/users", Views.users);
Router.on("#/login", async ()=> showLogin(true));
Router.on("#/404", async ()=> { $("#main").textContent = "Страница не найдена"; });

/* ====================== ИНИЦИАЛИЗАЦИЯ ====================== */
(function init(){
  $("#env-pill").textContent = "env: " + (Store.cfg().env || "local");
  Api.setStatus(null);
  // защищаем приватные маршруты
  if (!Store.token()) Router.go("#/login");
  Router.handle();
})();

/* ====================== SERVICE WORKER (BLOB) ====================== */
if ("serviceWorker" in navigator) {
  const swCode = `
    const CACHE = "mythos-admin-v1";
    self.addEventListener("install", (e)=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(["./"]))); self.skipWaiting(); });
    self.addEventListener("activate", (e)=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener("fetch", (e)=>{
      const req = e.request;
      if (req.method !== "GET") return;
      e.respondWith((async()=>{
        try {
          const net = await fetch(req);
          const cache = await caches.open(CACHE);
          cache.put(req, net.clone());
          return net;
        } catch {
          const cached = await caches.match(req, {ignoreSearch:true});
          if (cached) return cached;
          return caches.match("./");
        }
      })());
    });
  `;
  const blob = new Blob([swCode], {type: "text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
}

/* ====================== ВЫХОД ====================== */
$("#logout-btn").addEventListener("click", async ()=>{
  try { await Api.auth.logout(); } finally { Toast.show(i18n.t("signout_ok")); Router.go("#/login"); }
});
</script>
</body>
</html>
