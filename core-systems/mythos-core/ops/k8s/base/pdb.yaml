# mythos-core/ops/k8s/base/pdb.yaml
# ПОЛИТИКА: policy/v1 — актуальная API для PDB.
# НАЗНАЧЕНИЕ: защитить SLA при voluntary disruptions (drain/upgrade/scale).
# ПРИМЕЧАНИЕ: на кластерах 1.26+ можно включить unhealthyPodEvictionPolicy.

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mythos-core-api-pdb
  labels:
    app.kubernetes.io/name: mythos-core
    app.kubernetes.io/part-of: mythos-core
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: kustomize
spec:
  # STATeless слой: разрешаем максимум одного одновременного выселения.
  # При репликах 2+ обеспечивает бесшовные обновления.
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mythos-core
      app.kubernetes.io/component: api
  # Для k8s 1.26+: разрешить эвакуацию "нездоровых" Pod’ов даже при закрытом бюджете.
  #unhealthyPodEvictionPolicy: AlwaysAllow

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mythos-core-worker-pdb
  labels:
    app.kubernetes.io/name: mythos-core
    app.kubernetes.io/part-of: mythos-core
    app.kubernetes.io/component: worker
    app.kubernetes.io/managed-by: kustomize
spec:
  # BACKGROUND/queue workers: фиксируем 1 единицу как безопасный минимум
  # для постепенных rolling-update и масштабирования.
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mythos-core
      app.kubernetes.io/component: worker
  # Для k8s 1.26+:
  #unhealthyPodEvictionPolicy: AlwaysAllow

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mythos-core-stateful-pdb
  labels:
    app.kubernetes.io/name: mythos-core
    app.kubernetes.io/part-of: mythos-core
    app.kubernetes.io/component: stateful
    app.kubernetes.io/managed-by: kustomize
spec:
  # STATEFUL слой (БД/кэш/шардинг): требуем не менее 50% экземпляров.
  # Это позволит выселить не более 1 Pod из пары реплик и сохранить кворум.
  minAvailable: "50%"
  selector:
    matchLabels:
      app.kubernetes.io/name: mythos-core
      app.kubernetes.io/component: stateful
  # Для k8s 1.26+:
  #unhealthyPodEvictionPolicy: IfHealthyBudget  # значение по умолчанию
