{{- /*
Ingress template (networking.k8s.io/v1)
Industrial-grade, controller-agnostic with secure defaults and rich configurability.
*/ -}}
{{- if .Values.ingress.enabled }}
{{- $fullName := include "mythos-core.fullname" . -}}
{{- $svcName  := include "mythos-core.serviceName" . | default (printf "%s" $fullName) -}}
{{- $svcPort  := .Values.service.port | default 8080 -}}

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    app.kubernetes.io/name: {{ include "mythos-core.name" . }}
    helm.sh/chart: {{ include "mythos-core.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: api
  {{- with .Values.ingress.labels }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
  annotations:
    # Controller selection
    {{- if .Values.ingress.className | default "" | eq "" }}
    kubernetes.io/ingress.class: nginx
    {{- end }}

    # Secure and production-friendly defaults for NGINX Ingress
    {{- if or (eq (.Values.ingress.className | default "nginx") "nginx") (has "nginx" .Values.ingress.controllers) }}
    nginx.ingress.kubernetes.io/ssl-redirect: "{{ .Values.ingress.sslRedirect | default true }}"
    nginx.ingress.kubernetes.io/proxy-body-size: "{{ .Values.ingress.proxyBodySize | default "10m" }}"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "{{ .Values.ingress.proxyReadTimeout | default 60 }}"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "{{ .Values.ingress.proxySendTimeout | default 60 }}"
    nginx.ingress.kubernetes.io/proxy-buffering: "{{ .Values.ingress.proxyBuffering | default "on" }}"
    nginx.ingress.kubernetes.io/server-snippet: |
      {{- /* Security headers. Can be disabled/overridden via values.ingress.securityHeaders.enabled */ -}}
      {{- if (hasKey .Values.ingress "securityHeaders") | and .Values.ingress.securityHeaders.enabled | default true }}
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "DENY" always;
      add_header Referrer-Policy "no-referrer" always;
      add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
      {{- end }}
    {{- if .Values.ingress.hsts.enabled | default true }}
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "{{ .Values.ingress.hsts.maxAge | default 31536000 }}"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "{{ .Values.ingress.hsts.includeSubdomains | default true }}"
    nginx.ingress.kubernetes.io/hsts-preload: "{{ .Values.ingress.hsts.preload | default true }}"
    {{- end }}
    {{- if .Values.ingress.whitelistSourceRange }}
    nginx.ingress.kubernetes.io/whitelist-source-range: "{{ join "," .Values.ingress.whitelistSourceRange }}"
    {{- end }}
    {{- if .Values.ingress.rateLimit.enabled }}
    nginx.ingress.kubernetes.io/limit-rps: "{{ .Values.ingress.rateLimit.rps | default 20 }}"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "{{ .Values.ingress.rateLimit.burstMultiplier | default 5 }}"
    {{- end }}
    {{- if .Values.ingress.rewriteTarget }}
    nginx.ingress.kubernetes.io/rewrite-target: "{{ .Values.ingress.rewriteTarget }}"
    {{- end }}
    {{- if .Values.ingress.useRegex }}
    nginx.ingress.kubernetes.io/use-regex: "true"
    {{- end }}
    {{- if .Values.ingress.backendProtocol }}
    nginx.ingress.kubernetes.io/backend-protocol: "{{ .Values.ingress.backendProtocol }}"
    {{- end }}
    {{- if .Values.ingress.configurationSnippet }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
{{ tpl .Values.ingress.configurationSnippet . | indent 6 }}
    {{- end }}
    {{- if .Values.ingress.canary.enabled }}
    nginx.ingress.kubernetes.io/canary: "true"
    {{- if .Values.ingress.canary.byHeader }}
    nginx.ingress.kubernetes.io/canary-by-header: "{{ .Values.ingress.canary.byHeader }}"
    nginx.ingress.kubernetes.io/canary-by-header-value: "{{ .Values.ingress.canary.headerValue | default "always" }}"
    {{- end }}
    {{- if .Values.ingress.canary.weight }}
    nginx.ingress.kubernetes.io/canary-weight: "{{ .Values.ingress.canary.weight }}"
    {{- end }}
    {{- end }}
    {{- end }}

    # AWS ALB (optional)
    {{- if or (eq .Values.ingress.className "alb") (has "alb" .Values.ingress.controllers) }}
    alb.ingress.kubernetes.io/scheme: "{{ .Values.ingress.alb.scheme | default "internet-facing" }}"
    alb.ingress.kubernetes.io/target-type: "{{ .Values.ingress.alb.targetType | default "ip" }}"
    alb.ingress.kubernetes.io/backend-protocol: "{{ .Values.ingress.backendProtocol | default "HTTP" }}"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    {{- if .Values.ingress.alb.certificateArn }}
    alb.ingress.kubernetes.io/certificate-arn: "{{ .Values.ingress.alb.certificateArn }}"
    {{- end }}
    {{- if .Values.ingress.alb.sslPolicy }}
    alb.ingress.kubernetes.io/ssl-policy: "{{ .Values.ingress.alb.sslPolicy }}"
    {{- end }}
    {{- end }}

    # Traefik (optional)
    {{- if or (eq .Values.ingress.className "traefik") (has "traefik" .Values.ingress.controllers) }}
    traefik.ingress.kubernetes.io/router.entrypoints: "{{ .Values.ingress.traefik.entrypoints | default "websecure" }}"
    traefik.ingress.kubernetes.io/router.tls: "{{ .Values.ingress.tls.enabled | default true }}"
    {{- end }}

    # ExternalDNS hostname management (optional)
    {{- if .Values.ingress.externalDNS }}
    external-dns.alpha.kubernetes.io/hostname: "{{ .Values.ingress.externalDNS }}"
    {{- end }}

    # Merge user annotations last to allow overrides
    {{- with .Values.ingress.annotations }}
{{ toYaml . | indent 4 }}
    {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className | quote }}
  {{- end }}

  {{- if .Values.ingress.defaultBackend }}
  defaultBackend:
    service:
      name: {{ .Values.ingress.defaultBackend.name }}
      port:
        number: {{ .Values.ingress.defaultBackend.port }}
  {{- end }}

  {{- if .Values.ingress.tls.enabled }}
  tls:
    {{- range .Values.ingress.tls.items }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}

  rules:
    {{- range $h := .Values.ingress.hosts }}
    - host: {{ $h.host | quote }}
      http:
        paths:
          {{- /* per-host paths */ -}}
          {{- range $p := $h.paths }}
          - path: {{ $p.path | default "/" | quote }}
            pathType: {{ $p.pathType | default "Prefix" | quote }}
            backend:
              service:
                name: {{ $p.serviceName | default $svcName | quote }}
                port:
                  {{- if $p.servicePort }}
                  {{- if kindIs "string" $p.servicePort }}
                  name: {{ $p.servicePort }}
                  {{- else }}
                  number: {{ $p.servicePort }}
                  {{- end }}
                  {{- else }}
                  number: {{ $svcPort }}
                  {{- end }}
          {{- end }}

          {{- /* global extraPaths for all hosts */ -}}
          {{- range $ep := $.Values.ingress.extraPaths }}
          - path: {{ $ep.path | default "/" | quote }}
            pathType: {{ $ep.pathType | default "Prefix" | quote }}
            backend:
              service:
                name: {{ $ep.serviceName | default $svcName | quote }}
                port:
                  {{- if $ep.servicePort }}
                  {{- if kindIs "string" $ep.servicePort }}
                  name: {{ $ep.servicePort }}
                  {{- else }}
                  number: {{ $ep.servicePort }}
                  {{- end }}
                  {{- else }}
                  number: {{ $svcPort }}
                  {{- end }}
          {{- end }}
    {{- end }}

  {{- /* Optional raw rules appended verbatim (advanced scenarios) */ -}}
  {{- if .Values.ingress.extraRules }}
  {{ tpl (toYaml .Values.ingress.extraRules) . | nindent 2 }}
  {{- end }}
{{- end }}
