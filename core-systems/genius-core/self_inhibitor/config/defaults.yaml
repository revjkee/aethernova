# core-systems/genius_core/security/self_inhibitor/config/defaults.yaml
# Конфигурация Self-Inhibitor по умолчанию.
# Любой ключ можно переопределить переменными окружения вида ${ENV:default}.

version: 1

inhibitor:
  enabled: ${SELF_INHIBITOR_ENABLED:true}

  # Пороговые значения суммарного риска для принятия решений.
  thresholds:
    sanitize: ${SELF_INHIBITOR_SANITIZE_THRESHOLD:3.0}   # >= sanitize -> ALLOW + SANITIZE секретов и PII
    block:    ${SELF_INHIBITOR_BLOCK_THRESHOLD:8.0}      # >= block -> BLOCK
    escalate: ${SELF_INHIBITOR_ESCALATE_THRESHOLD:12.0}  # >= escalate и есть SECRET/PII -> ESCALATE

  # Веса по типам находок. Чем выше, тем больший вклад в итоговую оценку.
  weights:
    SECRET: ${SELF_INHIBITOR_WEIGHT_SECRET:6.0}
    PII: ${SELF_INHIBITOR_WEIGHT_PII:4.0}
    COMMAND_INJECTION: ${SELF_INHIBITOR_WEIGHT_CMDI:5.0}
    PROMPT_INJECTION: ${SELF_INHIBITOR_WEIGHT_PROMPT:3.0}
    DANGEROUS_URL: ${SELF_INHIBITOR_WEIGHT_URL:2.0}
    OTHER: ${SELF_INHIBITOR_WEIGHT_OTHER:1.0}

  # Редактирование чувствительных данных при SANITIZE.
  redaction:
    token_default: ${SELF_INHIBITOR_REDACTION_TOKEN:[REDACTED]}
    token_by_type:
      SECRET: ${SELF_INHIBITOR_REDACTION_TOKEN_SECRET:[REDACTED:SECRET]}
      PII: ${SELF_INHIBITOR_REDACTION_TOKEN_PII:[REDACTED:PII]}

  # Политика URL. Список доверенных доменов и их поддоменов.
  url_policy:
    allowed_domains:
      - ${SELF_INHIBITOR_URL_ALLOW_1:example.com}
      - ${SELF_INHIBITOR_URL_ALLOW_2:localhost}
      - ${SELF_INHIBITOR_URL_ALLOW_3:127.0.0.1}

  # Лимиты и предохранители для защиты от всплесков.
  limits:
    # Sliding window rate limit per actor.
    rate_limit_window_sec: ${SELF_INHIBITOR_RL_WINDOW_SEC:60}
    rate_limit_max_events: ${SELF_INHIBITOR_RL_MAX_EVENTS:120}
    # Cooldown после BLOCK или ESCALATE.
    cooldown_after_block_sec: ${SELF_INHIBITOR_COOLDOWN_SEC:10}
    # Circuit breaker открывается после N последовательных блоков.
    circuit_breaker_threshold: ${SELF_INHIBITOR_CB_THRESHOLD:5}
    circuit_breaker_open_sec: ${SELF_INHIBITOR_CB_OPEN_SEC:30}
    # Технические лимиты сканирования.
    max_text_len_for_scan: ${SELF_INHIBITOR_MAX_TEXT_LEN:200000}
    max_findings_per_type: ${SELF_INHIBITOR_MAX_FINDINGS_PER_TYPE:100}

  # Переключатели правил обнаружения.
  detection:
    enable_secret_rules: ${SELF_INHIBITOR_DET_SECRET:true}
    enable_pii_rules: ${SELF_INHIBITOR_DET_PII:true}
    enable_command_injection_rules: ${SELF_INHIBITOR_DET_CMDI:true}
    enable_prompt_injection_rules: ${SELF_INHIBITOR_DET_PROMPT:true}

  # Аудит принятия решений.
  audit:
    enabled: ${SELF_INHIBITOR_AUDIT_ENABLED:true}
    logger_name: ${SELF_INHIBITOR_AUDIT_LOGGER:self_inhibitor}
    max_excerpt_len: ${SELF_INHIBITOR_AUDIT_EXCERPT:64}

anomaly:
  # Встроенный детектор аномалий текста.
  enabled: ${SELF_INHIBITOR_ANOMALY_ENABLED:true}

  options:
    # Размер скользящего окна образцов на актера и признак.
    window_size: ${ANOMALY_WINDOW_SIZE:200}
    # Веса признаков. Конечный скор складывается из положительных отклонений z*weight.
    weights:
      len: ${ANOMALY_W_LEN:1.0}
      entropy: ${ANOMALY_W_ENTROPY:1.5}
      digit_ratio: ${ANOMALY_W_DIGIT:0.8}
      upper_ratio: ${ANOMALY_W_UPPER:0.6}
      punct_ratio: ${ANOMALY_W_PUNCT:0.8}
      whitespace_ratio: ${ANOMALY_W_WS:0.4}
      non_printable: ${ANOMALY_W_NONPRINT:1.2}
      invisible: ${ANOMALY_W_INVISIBLE:2.0}
      repeat_run: ${ANOMALY_W_REPEAT:1.0}
      url_count: ${ANOMALY_W_URL:1.2}
      base64_ratio: ${ANOMALY_W_B64:1.2}
      script_mix: ${ANOMALY_W_SCRIPT:1.5}
      suspicious_phrases: ${ANOMALY_W_PHRASES:1.8}
      pipe_to_shell: ${ANOMALY_W_PIPE:2.5}

    # Нормировка и пороги.
    max_score: ${ANOMALY_MAX_SCORE:100.0}
    z_cap: ${ANOMALY_Z_CAP:8.0}
    min_samples_for_baseline: ${ANOMALY_MIN_BASELINE:20}

    # Жесткие пороги, независимые от baseline.
    hard_thresholds:
      invisible: ${ANOMALY_HARD_INVISIBLE:1.0}
      non_printable: ${ANOMALY_HARD_NONPRINT:1.0}
      pipe_to_shell: ${ANOMALY_HARD_PIPE:1.0}
      base64_ratio: ${ANOMALY_HARD_B64:0.35}
      repeat_run: ${ANOMALY_HARD_REPEAT:0.25}
      script_mix: ${ANOMALY_HARD_SCRIPT:0.35}

    # Параметры извлечения признаков.
    shannon_base: ${ANOMALY_SHANNON_BASE:2.0}
    min_text_len_for_entropy: ${ANOMALY_MIN_LEN_ENTROPY:16}
    max_text_len_for_scan: ${ANOMALY_MAX_TEXT_LEN:200000}

    # Нормировочные коэффициенты.
    norm_factors:
      len: ${ANOMALY_NORM_LEN:1.0}
      entropy: ${ANOMALY_NORM_ENTROPY:1.0}
      repeat_run: ${ANOMALY_NORM_REPEAT:1.0}
      base64_ratio: ${ANOMALY_NORM_B64:1.0}
      script_mix: ${ANOMALY_NORM_SCRIPT:1.0}

    # Политика обучения базовых линий.
    update_on_allow: ${ANOMALY_UPDATE_ON_ALLOW:true}
    update_on_any: ${ANOMALY_UPDATE_ON_ANY:false}

quarantine:
  # Параметры карантина артефактов.
  enabled: ${SELF_INHIBITOR_QUARANTINE_ENABLED:true}

  root_dir: ${QUARANTINE_ROOT:./_quarantine}
  audit_logger_name: ${QUARANTINE_AUDIT_LOGGER:quarantine}

  policy:
    default_ttl_sec: ${QUARANTINE_TTL_SEC:259200}         # 3 суток
    max_store_bytes: ${QUARANTINE_MAX_STORE_BYTES:10737418240}  # 10 GiB
    max_item_bytes: ${QUARANTINE_MAX_ITEM_BYTES:33554432}       # 32 MiB
    compress: ${QUARANTINE_COMPRESS:true}
    compress_threshold: ${QUARANTINE_COMPRESS_THRESHOLD:4096}
    text_media_type: ${QUARANTINE_TEXT_MIME:text/plain; charset=utf-8}
    binary_media_type: ${QUARANTINE_BIN_MIME:application/octet-stream}

  # При каких действиях Self-Inhibitor автоматически отправлять в карантин.
  quarantine_on_actions:
    - ${QUARANTINE_ON_1:BLOCK}
    - ${QUARANTINE_ON_2:ESCALATE}

runtime:
  # Общие настройки для интеграции и телеметрии.
  telemetry:
    logger_level: ${SELF_INHIBITOR_LOG_LEVEL:INFO}
    json_logs: ${SELF_INHIBITOR_LOG_JSON:true}

  # Поведение по умолчанию при интеграции с приложением.
  defaults:
    actor_fallback: ${SELF_INHIBITOR_ACTOR_FALLBACK:anonymous}
    reason_prefix: ${SELF_INHIBITOR_REASON_PREFIX:inhibitor}
    # Минимальный уровень severty для карантина при ручном вызове.
    min_quarantine_severity: ${SELF_INHIBITOR_MIN_QUAR_SEVERITY:7}

# Профили окружений для быстрых переключений.
profiles:
  development:
    inhibitor:
      audit:
        enabled: true
    anomaly:
      enabled: true
  staging:
    inhibitor:
      audit:
        enabled: true
  production:
    inhibitor:
      audit:
        enabled: true
    anomaly:
      enabled: true
    quarantine:
      enabled: true
