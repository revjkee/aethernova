# path: core-systems/genius_core/security/self_inhibitor/rules/sensitive_patterns.yaml
version: 1
schema: "genius.self_inhibitor.rules.v1"

metadata:
  owner: "genius_core.security.self_inhibitor"
  description: "Правила обнаружения чувствительных данных/секретов и безопасной редакции"
  updated_at: "2025-08-18"

defaults:
  flags: [case_insensitive, multiline]
  scope: ["body", "variables", "headers", "querystring"]
  actions:
    on_match: ["redact", "mark_violation"]
  redaction:
    replacement: "[REDACTED]"
  # Глобальные лимиты сканируемых значений (доп. страховка)
  limits:
    max_value_bytes: 2097152
    max_nested_depth: 16

allowlist:
  # Ключи/поля, которые не считаем чувствительными (часто встречаются и не несут секретов)
  keys_regex:
    - "^(trace|span|request|session|correlation)_id$"
    - "^nonce$"
    - "^timestamp$"
  # Пути, где детекция не нужна (например, метрики/health)
  paths:
    - "/health"
    - "/healthz"
    - "/ready"
    - "/metrics"

rules:

  - group: "Secrets: Private Keys & Tokens"
    items:

      - id: PEM_PRIVATE_KEY
        name: "PEM Private Key (RSA/DSA/EC)"
        pattern: "-----BEGIN(?: RSA| DSA| EC)? PRIVATE KEY-----[\\s\\S]+?-----END(?: RSA| DSA| EC)? PRIVATE KEY-----"
        severity: critical
        confidence: high
        tags: [secret, pem, key]
        redaction:
          replacement: "[REDACTED_PEM]"
        examples:
          match: ["-----BEGIN PRIVATE KEY-----MIIB...-----END PRIVATE KEY-----"]
          nomatch: ["-----BEGIN CERTIFICATE-----...-----END CERTIFICATE-----"]

      - id: OPENSSH_PRIVATE_KEY
        name: "OpenSSH Private Key"
        pattern: "-----BEGIN OPENSSH PRIVATE KEY-----[\\s\\S]+?-----END OPENSSH PRIVATE KEY-----"
        severity: critical
        confidence: high
        tags: [secret, ssh, key]
        redaction:
          replacement: "[REDACTED_SSH_KEY]"

      - id: JWT_BEARER
        name: "JWT Bearer Token"
        pattern: "\\beyJ[A-Za-z0-9_\\-]{10,}\\.[A-Za-z0-9_\\-]{10,}\\.[A-Za-z0-9_\\-]{10,}\\b"
        severity: high
        confidence: medium
        tags: [token, jwt, oauth]
        examples:
          match: ["Authorization: Bearer eyJhbGciOi..."]
        boundaries: word

      - id: AUTH_BASIC_HEADER
        name: "HTTP Basic Authorization"
        pattern: "(?i)authorization\\s*:\\s*basic\\s+[A-Za-z0-9+/=]{8,}"
        severity: high
        confidence: medium
        tags: [auth, basic, header]

      - id: AWS_ACCESS_KEY_ID
        name: "AWS Access Key ID"
        pattern: "\\b(?:AKIA|ASIA)[0-9A-Z]{16}\\b"
        severity: high
        confidence: medium
        tags: [secret, aws]
        boundaries: word

      - id: AWS_SECRET_ACCESS_KEY
        name: "AWS Secret Access Key"
        pattern: "\\b[0-9A-Za-z/+]{40}\\b"
        context:
          key_regex: "(?i)aws_?secret(_access)?_key|secret[_-]?key"
        severity: critical
        confidence: high
        tags: [secret, aws]

      - id: GCP_API_KEY
        name: "Google API Key"
        pattern: "\\bAIza[0-9A-Za-z\\-_]{35}\\b"
        severity: high
        confidence: high
        tags: [secret, gcp]

      - id: GITHUB_TOKEN
        name: "GitHub Token"
        pattern: "\\b(?:ghp|gho|ghu|ghs|ghr|ghpat)_[0-9A-Za-z]{20,255}\\b"
        severity: high
        confidence: medium
        tags: [secret, github]

      - id: STRIPE_KEY
        name: "Stripe Key (sk_/pk_/rk_)"
        pattern: "\\b(?:sk|pk|rk)_(?:live|test)_[0-9A-Za-z]{16,}\\b"
        severity: high
        confidence: medium
        tags: [secret, stripe]

      - id: SLACK_TOKEN
        name: "Slack Token"
        pattern: "\\bxox[aboprs]-[0-9A-Za-z\\-]{10,48}\\b"
        severity: high
        confidence: medium
        tags: [secret, slack]

      - id: TWILIO_SID_OR_AUTH
        name: "Twilio SID/Auth Token"
        pattern: "\\bAC[0-9a-fA-F]{32}\\b|(?i)\\btwilio[_-]?auth[_-]?token\\b[:=]\\s*[0-9a-f]{32}\\b"
        severity: high
        confidence: medium
        tags: [secret, twilio]

      - id: SENDGRID_API_KEY
        name: "SendGrid API Key"
        pattern: "\\bSG\\.[A-Za-z0-9_-]{16,24}\\.[A-Za-z0-9_-]{16,64}\\b"
        severity: high
        confidence: high
        tags: [secret, sendgrid]

      - id: AZURE_STORAGE_CONNSTR
        name: "Azure Storage Connection String"
        pattern: "(?i)DefaultEndpointsProtocol=https;AccountName=[A-Za-z0-9\\-]+;AccountKey=[A-Za-z0-9+/=]{40,};EndpointSuffix=core\\.windows\\.net"
        severity: high
        confidence: high
        tags: [secret, azure]

  - group: "Credentials in URLs / DSN"
    items:

      - id: DATABASE_DSN
        name: "Database DSN/URL with credentials"
        pattern: "(?i)\\b(postgres(?:ql)?|mysql|mariadb|mongodb(?:\\+srv)?|redis|rediss|amqp|mssql)://(?:(?:[^\\s:@/]{1,256})(?::[^\\s@/]{0,256})?@)?[^\\s@/]{1,256}[:/][^\\s]{1,}\\b"
        severity: high
        confidence: medium
        tags: [secret, dsn, url]

      - id: URL_WITH_PASSWORD
        name: "Generic URL with embedded password"
        pattern: "(?i)\\b[a-z][a-z0-9+.-]{1,}://[^/\\s:@]+:(?:[^/\\s@]{3,})@[^/\\s]+"
        severity: high
        confidence: medium
        tags: [secret, url]

  - group: "PII (Personally Identifiable Information)"
    items:

      - id: EMAIL_ADDRESS
        name: "Email"
        pattern: "(?i)\\b[a-z0-9._%+\\-]+@[a-z0-9.\\-]+\\.[a-z]{2,24}\\b"
        severity: medium
        confidence: high
        tags: [pii, email]

      - id: PHONE_E164
        name: "Phone (E.164)"
        pattern: "\\b\\+[1-9]\\d{7,14}\\b"
        severity: medium
        confidence: medium
        tags: [pii, phone]

      - id: CREDIT_CARD
        name: "Payment Card (major brands)"
        pattern: "\\b(?:4\\d{12}(?:\\d{3})?|5[1-5]\\d{14}|3[47]\\d{13}|3(?:0[0-5]|[68]\\d)\\d{11}|6(?:011|5\\d{2})\\d{12}|(?:2131|1800)\\d{11}|35\\d{14})\\b"
        severity: critical
        confidence: medium
        post_validation: luhn
        tags: [pii, payment]

      - id: IBAN
        name: "IBAN"
        pattern: "\\b[A-Z]{2}\\d{2}[A-Z0-9]{11,30}\\b"
        severity: medium
        confidence: low
        tags: [pii, finance]

  - group: "Environment / Config / K8s"
    items:

      - id: PASSWORD_LIKE_FIELD
        name: "Password-like key=value"
        pattern: "(?i)\\b(pass(?:word)?|pwd|secret|token)\\b\\s*[:=]\\s*[\"']?[^\"']{6,}[\"']?"
        severity: high
        confidence: low
        tags: [secret, env]

      - id: DOTENV_LINE
        name: ".env style line with value"
        pattern: "^(?i)([A-Z0-9_]{3,64})=(?![ \\t]*#).{6,}$"
        severity: medium
        confidence: low
        scope: ["body"]
        tags: [env, config]

      - id: K8S_SECRET_KIND
        name: "Kubernetes Secret manifest"
        pattern: "(?m)^\\s*kind:\\s*Secret\\s*$"
        severity: medium
        confidence: high
        tags: [k8s, secret]

  - group: "Network Indicators"
    items:

      - id: INTERNAL_IPV4
        name: "Private IPv4"
        pattern: "\\b(?:(?:10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})|(?:192\\.168\\.\\d{1,3}\\.\\d{1,3})|(?:172\\.(?:1[6-9]|2\\d|3[0-1])\\.\\d{1,3}\\.\\d{1,3}))\\b"
        severity: low
        confidence: high
        tags: [network, internal]

# Примечание по реализации:
# - поля post_validation (например, luhn) применяются движком, если поддерживаются.
# - поле context.key_regex позволяет усиливать уверенность для общих шаблонов.
# - defaults.actions.on_match включает "redact" — движок должен заменять совпадение replacement'ом.
# - boundaries: word (если указано) просит движок проверять границы слова.
# - examples блоки служат для ваших unit-тестов правил.
